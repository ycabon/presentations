// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("dojo/io-query ../../support/layerSourceUtils ../../../core/Accessor ../../../core/Promise ../../../core/lang ../../../core/urlUtils ../../../core/Error ../../../request ../../../tasks/QueryTask".split(" "),function(g,h,k,l,e,f,m,d,n){return k.createSubclass([l],{getDefaults:function(a){var b=this.inherited(arguments),c=a.layer;c&&(b=e.mixin(b,{url:c.url,layerId:c.layerId,gdbVersion:c.gdbVersion,dynamicDataSource:c.dynamicDataSource}));return b},initialize:function(){this.addResolvingPromise(this._fetchService())},
properties:{dynamicDataSource:{},layer:{},layerId:{},gdbVersion:{dependsOn:["layer.gdbVersion"],get:function(){return this.layer.gdbVersion}},parsedUrl:{dependsOn:["url","layerId"],get:function(){var a=this.url?f.urlToObject(this.url):null;if(null!=a)if(null!=this.layerId)a.path=f.join(a.path,this.layerId.toString());else if(null!=this.dynamicDataSource){var b={source:h.sourceToJSON(this.dynamicDataSource)};a.query={layer:JSON.stringify(b)}}return a}},queryTask:{dependsOn:["parsedUrl","gdbVersion"],
get:function(){var a=this.parsedUrl.path+"?"+g.objectToQuery(this.parsedUrl.query);return new n({url:null!=this.dynamicDataSource?a:this.parsedUrl.path,gdbVersion:this.gdbVersion})}},url:{}},applyEdits:function(a){var b=a.addFeatures.map(this._serializeFeature.bind(this)),c=a.updateFeatures.map(this._serializeFeature.bind(this));a=this._getFeatureIds(a.deleteFeatures);b={f:"json",adds:b.length?JSON.stringify(b):null,updates:c.length?JSON.stringify(c):null,deletes:a.length?a.join(","):null};return d(this.parsedUrl.path+
"/applyEdits",{query:b,method:"post",responseType:"json",callbackParamName:"callback"}).then(this._createEditsResult.bind(this))},queryFeatures:function(a){return this.queryTask.execute(a)},queryFeaturesJSON:function(a){return this.queryTask.executeJSON(a)},queryObjectIds:function(a){return this.queryTask.executeForIds(a)},queryFeatureCount:function(a){return this.queryTask.executeForCount(a)},queryExtent:function(a){return this.queryTask.executeForExtent(a)},_updateUrl:function(a){a&&(this.url=this.url.replace(/^http:/i,
"https:"))},_fetchService:function(){return null==this.layerId&&null==this.dynamicDataSource?d(this.url,{query:{f:"json"},responseType:"json",callbackParamName:"callback"}).then(function(a){this._updateUrl(a.ssl);(a=a.data)&&a.layers&&a.layers[0]&&(this.layerId=a.layers[0].id);return this._fetchServiceLayer()}.bind(this)):this._fetchServiceLayer()},_fetchServiceLayer:function(){return d(this.parsedUrl.path,{query:e.mixin({f:"json"},this.parsedUrl.query),responseType:"json",callbackParamName:"callback"}).then(function(a){this._updateUrl(a.ssl);
this.layerDefinition=a.data}.bind(this))},_serializeFeature:function(a){var b=a.geometry;a=a.attributes;return{geometry:b&&b.toJSON(),attributes:a}},_getFeatureIds:function(a){var b=this.layer.objectIdField,c=a[0],d=!(!c||null==c.objectId),e=!(!c||!c.attributes);return a.map(function(a){var c=null;d?c=a.objectId:e&&(c=a.attributes&&a.attributes[b]);return c},this)},_createEditsResult:function(a){var b={};a=a.data;b.addFeatureResults=a.addResults?a.addResults.map(this._createFeatureEditResult.bind(this)):
[];b.updateFeatureResults=a.updateResults?a.updateResults.map(this._createFeatureEditResult.bind(this)):[];b.deleteFeatureResults=a.deleteResults?a.deleteResults.map(this._createFeatureEditResult.bind(this)):[];return b},_createFeatureEditResult:function(a){var b=a.success?null:a.error||{};return{objectId:a.objectId,globalId:a.globalId,error:b?new m("feature-layer-source:edit-failure",b.description,{code:b.code}):null}}})});