// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/promiseUtils ./CIMSymbolHelper ./GlyphMosaic ./GlyphSource ./SDFHelper ./SpriteMosaic ./Utils ../../../3d/support/imageUtils".split(" "),function(r,t,g,h,l,m,k,n,f,p){function q(e){if(e.type){switch(f.normalizeSymbolType(e.type)){case "simple-marker":return"simple-marker"+e.style;case "simple-line":return"simple-line"+e.style}if(f.isPictureSymbol(e))return e.url?e.url:e.imageData+(""+e.width+e.height)}return JSON.stringify(e)}return function(){function e(){this._spriteMosaic=
new n(1024,1024,250);this._glyphSource=new m("https://basemaps.arcgis.com/v1/arcgis/rest/services/World_Basemap/VectorTileServer/resources/fonts/{fontstack}/{range}.pbf");this._glyphMosaic=new l(1024,1024,this._glyphSource)}Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.dispose=function(){this._spriteMosaic.dispose();
this._glyphMosaic.dispose();this._rasterizationCanvas=null};e.prototype.rasterizeItem=function(a,b){void 0===b&&(b=null);return a?!a.type||"text"!==a.type&&"esriTS"!==a.type?this._rasterizeSpriteSymbol(a).then(function(a){return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,b).then(function(a){return{glyphMosaicItems:a}}):g.resolve(null)};e.prototype.bindSpritePage=function(a,b,d,c){c||(c=9729);this._spriteMosaic.bind(a,c,b,d)};e.prototype.bindGlyphsPage=function(a,b,d){this._glyphMosaic.bind(a,
9729,b,d)};e.prototype._rasterizeTextSymbol=function(a,b){return this._glyphMosaic.getGlyphItems(a,b)};e.prototype._rasterizeSpriteSymbol=function(a){var b=this;if(a&&(f.isFillSymbol(a)||f.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style))return g.resolve(null);var d=q(a);if(this._spriteMosaic.has(d))return g.resolve(this._spriteMosaic.getSpriteItem(d));if(a.url||a.imageData)return p.requestImage(a.imageData?"data:"+a.contentType+
";base64,"+a.imageData:a.url).then(function(c){c=b._rasterizeResource(c);return b._addItemToMosaic(d,c.size,c.anchor,c.image,!f.isMarkerSymbol(a),c.sdf)});var c=this._rasterizeResource(a);return g.resolve(this._addItemToMosaic(d,c.size,c.anchor,c.image,!f.isMarkerSymbol(a),c.sdf))};e.prototype._rasterizeResource=function(a){if(a instanceof HTMLImageElement){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas"));this._rasterizationCanvas.width=a.width;this._rasterizationCanvas.height=
a.height;var b=this._rasterizationCanvas.getContext("2d");b.drawImage(a,0,0,a.width,a.height);for(var b=b.getImageData(0,0,a.width,a.height),b=new Uint8Array(b.data),d=void 0,c=0;c<b.length;c+=4)d=b[c+3]/255,b[c]*=d,b[c+1]*=d,b[c+2]*=d;return{size:[a.width,a.height],anchor:[0,0],image:new Uint32Array(b.buffer),sdf:!1}}return this._rasterizeJSON(a)};e.prototype._addItemToMosaic=function(a,b,d,c,e,f){return this._spriteMosaic.addSpriteItem(a,b,d,c,e,f)};e.prototype._rasterizeJSON=function(a){this._rasterizationCanvas||
(this._rasterizationCanvas=document.createElement("canvas"));if("simple-fill"===a.type||"esriSFS"===a.type){var b=h.SymbolHelper.rasterizeSimpleFill(this._rasterizationCanvas,a.style);a=b[0];var d=b[1],b=b[2];return{size:[d,b],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!1}}if("simple-line"===a.type||"esriSLS"===a.type)return b=h.SymbolHelper.rasterizeSimpleLine(this._rasterizationCanvas,a.style),a=b[0],d=b[1],b=b[2],{size:[d,b],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};"simple-marker"===
a.type||"esriSMS"===a.type?(a=h.CIMSymbolHelper.fromSimpleMarker(a),d=!0):d=k.SDFHelper.checkSDF(a);if(d)return d=(new k.SDFHelper).buildSDF(a),a=d[0],{size:[d[1],d[2]],anchor:[0,0],image:new Uint32Array(a.buffer),sdf:!0};var c=h.CIMSymbolHelper.rasterize(this._rasterizationCanvas,a);a=c[0];d=c[1];b=c[2];return{size:[d,b],anchor:[c[3],c[4]],image:new Uint32Array(a.buffer),sdf:!1}};return e}()});