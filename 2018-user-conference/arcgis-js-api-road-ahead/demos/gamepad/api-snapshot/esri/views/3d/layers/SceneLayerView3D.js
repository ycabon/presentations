// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/generatorHelper dojo/has dojo/_base/lang dojo/errors/CancelError ../../../Graphic ../../../core/arrayUtils ../../../core/arrayUtils ../../../core/Collection ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../core/requireUtils ../../../core/scheduling ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../geometry/support/aaBoundingBox ../../../geometry/support/scaleUtils ../../../layers/IntegratedMeshLayer ../../../symbols/FillSymbol3DLayer ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ../../../tasks/support/Query ./LayerView3D ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SQueryEngine ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/edgeUtils ./support/layerViewUpdatingProperties ../lib/glMatrix ../support/orientedBoundingBox ../support/projectionUtils ../webgl-engine/Stage ../webgl-engine/lib/Geometry ../webgl-engine/lib/Layer ../webgl-engine/lib/Object3D ../webgl-engine/lib/PreinterleavedGeometryData ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/TextureBackedBuffer/BufferManager ../webgl-engine/materials/DefaultMaterial module".split(" "),
function(W,M,X,x,Y,Z,aa,ba,ca,B,da,ea,fa,ga,ha,C,ia,ja,y,ka,u,z,la,N,ma,O,P,na,oa,pa,Q,qa,ra,sa,ta,v,ua,J,va,wa,H,xa,I,ya,za,Aa,Ba,K,L,l,Ca,R,Da){function Ea(m,c,a,b,d){var e=!1,h;c.encoding===v.DDS_ENCODING_STRING?h=L.DDS_ENCODING:e=!(l.isPowerOfTwo(m.width)&&l.isPowerOfTwo(m.height));a=((m=c.usedByEngineMats.some(function(a){return a.getParams().atlasRegions})||c.atlas)?b:a)&&!e;return{mipmap:a,wrapClamp:m||!c.wrap,disableAnisotropy:m&&a&&d,encoding:h,noUnpackFlip:!0}}function S(m){return m.data instanceof
ArrayBuffer}function Fa(m,c){for(var a=1024,b=0;b<m.length;b++)var d=m[b],a=a+(d.interleavedVertexData.byteLength+(d.indices?d.indices.byteLength:0));for(m=0;m<c.length;m++)b=c[m],b.data instanceof ArrayBuffer&&(a+=b.data.byteLength);return a}var q=ya.ModelContentType,w=ha.getLogger("esri.views.3d.layers.SceneLayerView3D"),T=[1,1,1,1],Ga=[.8,.8,.8],Ha=[.5,.5,.5];M=function(m){function c(){var a=null!==m&&m.apply(this,arguments)||this;a._queryEngine=null;a._highlights=new qa(a);a._elevationProvider=
null;a._worker=new pa;a._workerThread=null;a._controllerCreated=!1;a._idbCache=new ua.IDBCache("esri-scenelayer-cache","geometries",8);a._cancelCount=0;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.alwaysLoadEverythingModeEnabled=!1;a._cacheKeySuffix=null;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;return a}X(c,m);Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererNeedsTextures",{get:function(){return v.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=la.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=P.getMetersPerUnit(a.unit);return(a.offset||0)*d/b}return 0},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this._useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_useCompressedTextures",{get:function(){var a=this.layer.version,a=!aa("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.has("s3tc")&&a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",
{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps&&this.view._stage.has("standardDerivatives")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",
{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;ka.open(ia.getAbsMid("./SceneLayerWorker",W,Da),{client:this}).then(function(b){a.destroyed?b.close():a._workerThread=b});v.checkSceneLayerValid(this.layer);v.checkSceneLayerCompatibleWithView(this.layer,this.view);this._initGraphicsController();this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._isIntegratedMesh()||
(this._edgeView=this._stage.view.getEdgeView());this._texId2Meta=new Map;this._nodeId2Meta=new Map;this._addThisLayerToStage();this._elevationProvider=new ra({layerView:this,stageLayer:this._stageLayer});this.handles.add([y.init(this.view,"clippingArea",function(){return a._clippingAreaChanged()}),y.init(this.layer,"renderer",function(b){return a._rendererChange(b)}),y.init(this.layer,"objectIdFilter",function(){return a._filterChange()}),y.init(this.layer,"elevationInfo",function(){return a._elevationInfoChanged()}),
y.init(this.layer,"rangeInfos",function(b){return a._rangeInfosChanged(b)}),y.init(this,"_controller.parsedDefinitionExpression",function(){return a._filterChange()}),y.watch(this,"fullOpacity",function(b){return a._opacityChange(b)}),y.watch(this,["elevationOffset","rendererNeedsTextures"],function(){return a._reloadAll()}),y.watch(this,"uncompressedTextureDownsamplingEnabled",function(){return a._reloadAll()}),y.init(this,"suspended",function(b){return a.setVisibility(!b)})],"sceneLayerHandles");
this._idbCache.init();this._cacheKeySuffix=v.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._componentColorManager=this._hasSymbolColors()?new Ca.BufferManager(this._stage.view.renderingContext):null};c.prototype.destroy=function(){this.handles.remove("sceneLayerHandles");this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeThisLayerFromStage();this._stage=null;this._idbCache&&(this._idbCache.destroy(),this._idbCache=null);null!=
this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=this._texId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};c.prototype.isUpdating=function(){return this._controllerCreated?
!(!this._controller||!this._controller.updating):!0};c.prototype.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a;9.5367431640625E-7>this.gpuMemoryEstimate&&(this.texMemoryEstimate=this.gpuMemoryEstimate=0)};c.prototype.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/
1048576;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};c.prototype.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1048576;this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a;9.5367431640625E-7>this.gpuMemoryEstimate&&(this.texMemoryEstimate=this.gpuMemoryEstimate=0)};c.prototype._isNodeLoaded=function(a){return this._nodeId2Meta.has(a.id)};c.prototype._initGraphicsController=function(){var a=this;this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addNodeData:function(b,
d){return a._addNodeData(b,d)},isNodeLoaded:function(b){return a._isNodeLoaded(b)},getMemoryUsage:function(){return a.view.resourceController.usedMemory},removeNodeData:function(b){return a._removeNodeData(b)},getLoadedNodeIDs:function(){return a._getLoadedNodeIDs()}},layerViewOptionalFunctions:{setPolygonOffset:function(b,d){return a._setPolygonOffset(b,d?!0:!1)},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(b){return a._getLoadedAttributes(b)},getAttributeData:function(b){return a._getAttributeData(b)},
setAttributeData:function(b,d,e){return a._setAttributeData(b,d,e)},additionalCancelNodeLoadingHandler:function(){return a._cancel()},loadCachedNodeData:function(b,d){return a._loadCachedNodeData(b,d)},addCachedNodeData:function(b,d,e){return a._addCachedNodeData(b,d,e)}}}).then(function(b){a._controller=b;b.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.notifyChange("updating")})};c.prototype.getUsedMemory=function(){return this.gpuMemoryEstimate};
c.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};c.prototype.getCachedMemory=function(){return 0};c.prototype.removeCachedData=function(){this.suspended&&this._removeAllNodeDataFromStage()};c.prototype.setVisibility=function(a){var b=this;this._nodeId2Meta.forEach(function(d){d=d.engineObject;d.setHidden(d.geometryRecords[0],!a);b._edgeView&&b._edgeView.updateObjectVisibility(d,a)});if(a){var d=this._isIntegratedMesh()?"im":"scene";this.view.elevationProvider.register(d,
this._elevationProvider);this.visibleGeometryChanged()}else this.visibleGeometryChanged(),this.view.elevationProvider.unregister(this._elevationProvider)};c.prototype.getStats=function(){var a={index:0,nodes:this._nodeId2Meta.size.toString(),textures:this._texId2Meta.size,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};this._controller&&(a.index=Object.keys(this._controller.nodeIndex).length,
0<this._controller.getNumUnloadedNodes()&&(a.nodes+=" + "+this._controller.getNumUnloadedNodes()));return a};c.prototype._addThisLayerToStage=function(){for(var a=this._stage,b=new Uint8Array(256),d=0;d<b.length;d++)b[d]=255;this._whiteTexture=new L(b,"white",{width:8,height:8});a.add(q.TEXTURE,this._whiteTexture);b=this.layer.id;this._stageLayer=b=new Aa(b,{},b);a.add(q.LAYER,b);this._stage.addToViewContent([b.id])};c.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var a=
this._stage;a.remove(q.TEXTURE,this._whiteTexture.id);this._removeAllNodeDataFromStage();l.assert(0===this._nodeId2Meta.size);l.assert(0===this._texId2Meta.size);a.remove(q.LAYER,this._stageLayer.id);this._stageLayer=void 0;this.gpuMemoryEstimate=0}};c.prototype._getLoadedAttributes=function(a){if(a=this._nodeId2Meta.get(a.id))return a.loadedAttributes};c.prototype._getAttributeData=function(a){if(a=this._nodeId2Meta.get(a.id))return a.attributeData};c.prototype._setAttributeData=function(a,b,d){var e=
this._nodeId2Meta.get(a.id);e&&(e.loadedAttributes=b,e.attributeData=d,this._setObjectSymbology(e),this._addOrUpdateEdgeRendering(e),this._applyFilters(a),this.visibleGeometryChanged(e.engineObject))};c.prototype._getLoadedNodeIDs=function(){return ea.keysOfMap(this._nodeId2Meta)};c.prototype._calcEngineMaterialTransparencyParams=function(a,b,d){var e=this.fullOpacity,h=1-l.clamp(l.fallbackIfUndefined(b.transparency,0),0,1);a=1>h||1>e||a&&ga.endsWith(a.channels,"a")||!0===b.useVertexColorAlpha||d;
return{opacity:h,layerOpacity:e,transparent:a}};c.prototype._calcEngineMaterialDoubleSidedParams=function(a){return null!=a.doubleSided?a.doubleSided:!0};c.prototype._calcEngineMaterialCullFaceParams=function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?a.doubleSided?"none":"back":"none"};c.prototype._getMaterialParameters=function(a,b,d,e){var h;null!=a&&(h=(h=this._texId2Meta.get(b))&&h.engineTex?h.engineTex.id:this._whiteTexture.id);b=d.params;var c=l.fallbackIfUndefined(b.diffuse,Ga);"standard"!==
d.type&&w.warn("Unknown material type '"+d.type+"', must be 'standard'");d=this._isIntegratedMesh();e={ambient:c,diffuse:c,specular:l.fallbackIfUndefined(b.specular,Ha),atlasRegions:b.vertexRegions,textureId:h,vertexColors:this._hasVertexColors(),componentIndices:this._hasSymbolColors(),componentColorBuffer:this._hasSymbolColors()&&e?e.textureBuffer:null,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(b),cullFace:this._calcEngineMaterialCullFaceParams(b),writeStencil:d,receiveSSAO:!d,
groundNormalShading:d,compressedNormals:!d};d||(a=this._calcEngineMaterialTransparencyParams(a,b),ba.mixin(e,a));return e};c.prototype._createEngineMaterial=function(a,b,d,e,h,c,f){var g=null!=b?this._getI3STexEncoding(b):null;f=this._getMaterialParameters(b,d,e,f);f=new R(f,h);f.metadata={i3sMatId:h,i3sTexId:d,i3sTex:b,i3sMatParams:e.params};if(null!=b){(e=this._texId2Meta.get(d))?e.usedByEngineMats.push(f):(e={id:d,usedByEngineMats:[f],images:b.images,encoding:g,atlas:!0===b.atlas,wrap:"none"!==
b.wrap[0]||"none"!==b.wrap[1]},this._texId2Meta.set(d,e));a:{for(b=0;b<c.length;b++)if(g=c[b],g.i3sTexId===d){d=g.data;break a}d=null}null!=d&&null==e.engineTex&&(c=Ea(d,e,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy),e.engineTex=new L(d,e.id,c),this._stage.add(q.TEXTURE,e.engineTex),a.memory+=this.memEstimateTextureAdded(e.engineTex));if(null!=e.engineTex)for(a=e.engineTex.id,d=0,c=e.usedByEngineMats;d<c.length;d++)c[d].setParameterValues({textureId:a})}return f};c.prototype._getI3STexEncoding=
function(a){var b=v.getAppropriateTextureEncoding(a.encoding,this._useCompressedTextures);return-1<b?a.encoding[b]:a.encoding};c.prototype._getVertexBufferLayout=function(a,b){var d=a.params.materialID,e=b.materialDefinitions[d];l.assert(void 0!==e,"geometry wants unknown material "+d);a=a.params.textureID||"none";var c;"none"!==a&&(null!=b.textureDefinitions&&null!=b.textureDefinitions[a]||w.warn("textureDefinitions missing in shared resource"),c=b.textureDefinitions[a]);b=this._getMaterialParameters(c,
a,e);return R.getVertexBufferLayout(b)};c.prototype._createEngineMat=function(a,b,d,e,c){var h=b.params.materialID,f=d.materialDefinitions[h];l.assert(void 0!==f,"geometry wants unknown material "+h);b=b.params.textureID||"none";var k;"none"!==b&&(null!=d.textureDefinitions&&null!=d.textureDefinitions[b]||w.warn("textureDefinitions missing in shared resource"),k=d.textureDefinitions[b]);return this._createEngineMaterial(a,k,b,f,h,e,c)};c.prototype._getObjectIdField=function(){return this.layer.objectIdField||
"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=J.attributeLookup(a.attributes,this._getObjectIdField()),d=null;this._nodeId2Meta.forEach(function(a,c){var e=null==d?a.featureIds.indexOf(b):-1;-1!==e&&(d={node:a.node,nodeId:c,index:e})});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.id);if(!a)return[];for(var d=[],e=this._getObjectIdField(),c=0;c<b.length;c++){var g=J.attributeLookup(b[c].attributes,e),g=a.featureIds.indexOf(g);-1!==g&&d.push(g)}return d};
c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(null!=a){var b=this._nodeId2Meta.get(a.nodeId).engineObject;a=this._boundingBoxCornerPoints(a.index,b,new Float64Array(24));if(I.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=z.empty(),z.expandWithBuffer(b,a,0,8),C.resolve({boundingBox:b,screenSpaceObjects:[]})}return C.reject()};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return v.whenGraphicAttributes(this.layer,
[a],this._getObjectIdField(),b,function(){var b=d._findGraphicNodeAndIndex(a);return{node:b.node,indices:[b.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};c.prototype.getGraphicsFromStageObject=function(a,b){if(this.layer instanceof N)return C.reject();var d=this._getMetadata(a);a=a.getComponentFromTriangleNr(0,b);return null!=a&&null!=d.featureIds&&a<d.featureIds.length?(d=this._createGraphic(a,d),C.resolve(d)):C.reject()};c.prototype._getMetadata=function(a){a=
a.getMetadata();return this._nodeId2Meta.get(a.i3sNode)};c.prototype._getCacheKey=function(a){return a.baseUrl+this._cacheKeySuffix};c.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};c.prototype._cancel=function(){this._cancelCount=this._cancelCount+1|0};c.prototype._handleCancelled=function(a){if(0<(this._cancelCount-a|0))throw new ca;};c.prototype._loadCachedNodeData=function(a,b){var d=this,e=this._cancelCount;return this._cachingEnabled()?
this._idbCache.get(this._getCacheKey(a)).then(function(c){if(null==c)return null;d._handleCancelled(e);if(c.nodeVersion!==a.version)return d._idbCache.remove(d._getCacheKey(a)),null;a.obb||(a.obb=xa.clone(c.nodeObb));var h=function(a){if(null==a.data)return!0;var b=d._getI3STexEncoding(c.sharedResource.textureDefinitions[a.i3sTexId]);return a.encoding!==b};return d.rendererNeedsTextures&&c.textureData.some(h)?b(c.allGeometryData,c.sharedResource).then(function(b){c.textureData=b;b.every(S)&&d._idbCache.put(d._getCacheKey(a),
c).catch(function(b){return w.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+b)});d._handleCancelled(e);return c}):c}):C.resolve(null)};c.prototype._addNodeData=function(a,b){var d=this;return this._transformBundle(a,b).then(function(e){a.obb=a.obb||e.obb;e={allGeometryData:b.allGeometryData,transformedGeometries:e.transformedGeometries,textureData:b.textureData,sharedResource:b.sharedResource,nodeVersion:a.version,nodeObb:a.obb,byteSize:Fa(e.transformedGeometries,b.textureData)};
if(d._cachingEnabled()){var c=e.textureData.map(function(a){return S(a)?a:{i3sTexId:a.i3sTexId,encoding:a.encoding,data:null}});d._idbCache.put(d._getCacheKey(a),{allGeometryData:e.allGeometryData,transformedGeometries:e.transformedGeometries,textureData:c,sharedResource:e.sharedResource,nodeVersion:e.nodeVersion,nodeObb:e.nodeObb,byteSize:e.byteSize}).catch(function(b){return w.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)})}return d._addCachedNodeData(a,e,b.attributeDataInfo)})};
c.prototype._transformBundle=function(a,b){for(var d=[],e=[b.geometryBuffer],c=0,g=b.allGeometryData;c<g.length;c++)for(var f=0,k=g[c].geometries;f<k.length;f++)d.push(this._getVertexBufferLayout(k[f],b.sharedResource));a={geometryBuffer:b.geometryBuffer,geometryData:b.allGeometryData,layouts:d,center:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,hasColors:this._hasColors,needNormals:!this._isIntegratedMesh()&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||
"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",a,e):C.resolve(this._worker.transform(a))};c.prototype._addCachedNodeData=function(a,b,d){var e=this;if(this._nodeId2Meta.has(a.id))return this._addOrUpdateEdgeRendering(this._nodeId2Meta.get(a.id)),this._applyFilters(a),C.resolve();if(!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(a))return C.resolve();
var c=b.allGeometryData,g=b.transformedGeometries,f=b.textureData;b=b.sharedResource;if(0===c.length)return C.resolve();1!==c.length&&console.warn("Node with",c.length,"geometries is unsupported");if(!this.rendererNeedsTextures)for(var k=0;k<f.length;k++)f[k].data=null;var A={};A[q.OBJECT]={};A[q.GEOMETRY]={};A[q.MATERIAL]={};var k=0,m=!1;a.memory=0;var F=c[0],c=F.componentOffsets,t=F.geometries,F=F.featureIds,n=null,p=null;if(this._hasSymbolColors())for(var n=this._componentColorManager.getBuffer(F.length),
p=new Uint16Array(F.length),r=0;r<F.length;r++)p[r]=n.aquireIndex();for(var r=a.id+"|"+F[0],v=[],u=[],x=[],l,w=0;w<t.length;w++){var D=t[w],y=this._createEngineMat(a,D,b,f,n);l=g[k++];var m=m||l.hasColors,z=sa.extractPositionData(l.interleavedVertexData,l.layout,l.indices),z=new K(new Float32Array(l.interleavedVertexData),l.layout,z,c||K.DefaultOffsets,l.indices||K.DefaultIndices);this._hasSymbolColors()&&this._setComponentIndices(z,p);l=l.corMatrices;var E=H.mat4d.create(l.localTrafo);null!=D.transformation&&
H.mat4d.multiply(E,D.transformation,E);D=v.length;D=new za(z,r+(0<D?"_"+D:""));v.push(D);u.push(E);x.push([y]);a.memory+=this.memEstimateGeometryAdded(D.getData());A[q.MATERIAL][y.id]=y;A[q.GEOMETRY][D.id]=D}var B=new Ba({idHint:a.id,name:r,geometries:v,materials:x,transformations:u,castShadow:!0,metadata:{i3sNode:a.id,layerUid:this.layer.uid}}),g=H.mat4d.create();H.mat4d.identity(g);H.mat4d.multiply(g,l.globalTrafo,g);B.setObjectTransformation(g);A[q.OBJECT][B.id]=B;var G={node:a,engineObject:B,
featureIds:F,attributeData:d?d.attributeData:null,loadedAttributes:d?d.loadedAttributes:null,componentColorBuffer:n,componentIndices:p};return C.create(function(b){e._addOrUpdateEdgeRendering(G).then(function(){e._nodeId2Meta.set(a.id,G);e._setObjectSymbology(G);e._applyFilters(a);e._highlights.objectCreated(B);e.visibleGeometryChanged(B);var d=e._stageLayer,c=e._stage;c.beginMod();var f=A[q.OBJECT],h;for(h in f)f.hasOwnProperty(h)&&d.addObject(f[h]);for(var g in A)if(A.hasOwnProperty(g)){var d=A[g],
k;for(k in d)d.hasOwnProperty(k)&&null==c.get(g,k)&&c.add(g,d[k])}c.endMod();!e._hasTextures&&null!=a.textureData&&0<a.textureData.length&&(e._hasTextures=!0);e._hasColors||(e._hasColors=m);e._hasData=!0;e.notifyChange("hasTexturesOrVertexColors");b()})})};c.prototype._clippingAreaChanged=function(){var a=this,b=z.create();I.extentToBoundingBox(this.view.clippingArea,b,this.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)});
this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){var a=this;this._updateFilters();this._nodeId2Meta.forEach(function(b){return a._applyFilters(b.node)})};c.prototype._updateFilters=function(){var a=this,b=[];if(this.layer.objectIdFilter){var d=new Float64Array(this.layer.objectIdFilter.ids),e="include"===this.layer.objectIdFilter.method;d.sort();b.push(function(b,c){return a._objectIdFilter(d,e,c)})}if(this._controller&&this._controller.parsedDefinitionExpression&&
this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var c=this._controller.parsedDefinitionExpression,g=this._controller.definitionExpressionFields;b.push(function(b,d){return a._sqlFilter(b,c,g,d)})}this._clippingArea&&b.push(function(b,d){return a._boundingboxFilter(b,a._clippingArea,d)});this._filters=b};c.prototype._sqlFilter=function(a,b,d,e){var c={},g=new B(null,null,c);g.layer=this.layer;g.sourceLayer=this.layer;var f=this.layer.objectIdField,k=0,A=0,l=this._nodeId2Meta.get(a.id);
a=l.featureIds;for(var m=l.attributeData,l=d.every(function(a){return null!=m[a]||a===f}),t=0;t<a.length&&k<e.length;t++)if(e[k]===a[t]){var n=!0;if(l){c[f]=a[t];for(var n=0,p=d;n<p.length;n++){var r=p[n];r!==f&&(c[r]=v.getCachedAttributeValue(m[r],t))}n=this._evaluateClause(b,g)}n&&(e[A]=e[k],A++);k++}e.length=A};c.prototype._evaluateClause=function(a,b){try{return a.testFeature(b)}catch(d){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&w.error("Error while evaluating definitionExpression: "+
d),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&w.error("Further errors are ignored"),!1}};c.prototype._objectIdFilter=function(a,b,d){for(var e=0,c=0;e<d.length;)0<=da.binaryIndexOf(a,d[e])===b&&(d[c]=d[e],c++),e++;d.length=c};c.prototype._boundingboxFilter=function(a,b,d){var c=[0,0,0,0];I.mbsToMbs(a.mbs,this._controller.crsIndex,c,this.view.renderSpatialReference);c=null!=b?v.intersectBoundingBoxWithMbs(b,c):2;if(2!==c)if(0===c)d.length=
0;else{var h=c=0,g=this._nodeId2Meta.get(a.id);a=g.featureIds;var f=g.engineObject.getObjectTransformation(),k=g.engineObject.getGeometryRecords()[0].getShaderTransformation();H.mat4d.multiply(f,k);if(0===f[1]&&0===f[2]&&0===f[3]&&0===f[4]&&0===f[6]&&0===f[7]&&0===f[8]&&0===f[9]&&0===f[11]&&1===f[15]){k=U;k[0]=(b[0]-f[12])/f[0];k[1]=(b[1]-f[13])/f[5];k[2]=(b[2]-f[14])/f[10];k[3]=(b[3]-f[12])/f[0];k[4]=(b[4]-f[13])/f[5];k[5]=(b[5]-f[14])/f[10];b=g.engineObject.getGeometryRecords()[0].geometry;g=b.getComponentCount();
for(f=0;f<g&&c<d.length;f++)if(d[c]===a[f]){var l=b.getComponentAABB(f,Ia);z.intersects(k,l)&&(d[h]=d[c],h++);c++}d.length=h}}};c.prototype._addOrUpdateEdgeRendering=function(a){return Y(this,void 0,void 0,function(){var b,d,c,h,g,f;return Z(this,function(e){switch(e.label){case 0:if(!this._edgeView)return[2];b=a.engineObject;d=this._edgeView.hasObject(b);c=this._extractObjectEdgeMaterials(a);h=c.hasEdges;g=c.perFeatureEdgeMaterials;f=!b.isHidden(b.geometryRecords[0]);if(!d)return[3,1];this._edgeView.updateAllComponentMaterials(b,
g);this._edgeView.updateObjectVisibility(b,f);return[3,3];case 1:return f&&h?[4,this._edgeView.addObject(b,g)]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2]}})})};c.prototype._applyFilters=function(a){var b=this._nodeId2Meta.get(a.id);b&&this._applyFiltersToObjects(a,b)};c.prototype.unhideEdgesForAllFeatures=function(a){a=a.engineObject;this._edgeView&&this._edgeView.hasObject(a)&&this._edgeView.updateAllComponentOpacities(a,this.fullOpacity)};c.prototype._applyFiltersToObjects=function(a,b){var d=
b.engineObject;d.unhideAllComponents();if(0===this._filters.length)this.unhideEdgesForAllFeatures(b);else{for(var c=b.featureIds,h=c.slice(),g=0,f=this._filters;g<f.length;g++)(0,f[g])(a,h);if(h.length===c.length)this.unhideEdgesForAllFeatures(b);else{a=0;g=d.getGeometryRecords()[0];b=Array(b.featureIds.length);for(var f=this.fullOpacity,k=0;k<c.length;k++){var l=c[k];a>=h.length||h[a]!==l?(d.setComponentVisibility(g,k,!1),b[k]=0):(a++,b[k]=f)}this._edgeView&&this._edgeView.hasObject(d)&&this._edgeView.updateAllComponentOpacities(d,
b)}}};c.prototype._removeAllNodeDataFromStage=function(){var a=this;this._nodeId2Meta.forEach(function(b,d){return a._removeNodeStageData(d)})};c.prototype._removeNodeData=function(a){var b=this;a.forEach(function(a){return b._removeNodeStageData(a.id)})};c.prototype._removeNodeStageData=function(a){var b=this._nodeId2Meta.get(a);if(b){var d=this._stage,c=this._stageLayer,h=b.engineObject;this._highlights.objectDeleted(h);this._edgeView&&this._edgeView.removeObject(h);this.visibleGeometryChanged(h);
c.removeObject(h);for(var c=0,g=h.getGeometryRecords();c<g.length;c++){var f=g[c];this.memEstimateGeometryRemoved(f.geometry.getData());d.remove(q.GEOMETRY,f.geometry.id);for(var k=0,f=f.materials;k<f.length;k++)this._removeMaterial(f[k],d)}if(b.componentIndices){for(c=0;c<b.componentIndices.length;c++)b.componentColorBuffer.releaseIndex(b.componentIndices[c]);this._componentColorManager.garbageCollect()}d.remove(q.OBJECT,h.id);this._nodeId2Meta.delete(a)}};c.prototype._removeMaterial=function(a,
b){b.remove(q.MATERIAL,a.id);var d=a.metadata.i3sTexId||"none";if("none"!==d){var c=this._texId2Meta.get(d),h=c.usedByEngineMats;a=h.indexOf(a);-1<a?(h[a]=h[h.length-1],h.pop()):w.error("Missing reference from material to texture");0===h.length&&((h=c.engineTex)&&h!==this._whiteTexture&&(this.memEstimateTextureRemoved(h),b.remove(q.TEXTURE,c.engineTex.id)),this._texId2Meta.delete(d))}};c.prototype._setPolygonOffset=function(a,b){var d=this._nodeId2Meta.get(a.id);if(d)for(a=0,d=d.engineObject.getGeometryRecords();a<
d.length;a++)for(var c=0,h=d[a].materials;c<h.length;c++)h[c].setParameterValues({polygonOffset:b})};c.prototype._rendererChange=function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&w.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.");if(a){var b=0;for(a=a.getSymbols();b<a.length;b++){var d=a[b];"mesh-3d"!==d.type&&w.error("Symbols of type '"+d.type+"' are not supported for 3D Object Scene Services.")}}this.view.resourceController.setMemoryDirty()};
c.prototype._getRenderingInfo=function(a,b){var d=this._currentRenderer,c=d&&d.getSymbol(a);if(!(c instanceof O&&this._hasSymbolColors()))return null;var h,g;if(d&&d.visualVariables)for(a=d.getVisualVariableValues(a),d=0;d<a.length;d++){var f=a[d],k=f.variable.type;"color"===k?h=f.value:"opacity"===k&&(g=f.value)}b.symbol=c;b.color=h?[h.r/255,h.g/255,h.b/255]:null;b.opacity=null!=g?g:h&&null!=h.a?h.a:null;return b};c.prototype._getSymbolFillMaterial=function(a,b){var d=0;for(a=a.symbolLayers.items;d<
a.length;d++){var c=a[d];if("fill"===c.type){d=c.material;a=null!=d?d.color:null;null!=a?(G[0]=a.r/255,G[1]=a.g/255,G[2]=a.b/255,G[3]=a.a,b.color=G):b.color=null;b.colorMixMode=null!=d?d.colorMixMode:null;return}}b.color=null;b.colorMixMode=null};c.prototype._hasSymbolColors=function(){if(this._isIntegratedMesh()||!this.layer.store.defaultGeometrySchema)return!1;var a=this.layer.store.defaultGeometrySchema.featureAttributes;return!!(a&&a.faceRange&&a.id)};c.prototype._isIntegratedMesh=function(){return this.layer instanceof
N};c.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)};c.prototype._extractObjectEdgeMaterials=function(a){for(var b=[],c=a.featureIds?a.featureIds.length:1,e=this.layer.objectIdField,h=new B(null,null,{}),g=h.attributes,f=this._currentRenderer&&this._currentRenderer.requiredFields,k,l=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0}),m=this.fullOpacity,
u=!1,t=0;t<c;t++){k=l;null!=e&&null!=a.featureIds&&(g[e]=a.featureIds[t]);if(null!=f&&null!=a.attributeData)for(var n=0,p=Object.keys(a.attributeData);n<p.length;n++){var r=p[n];g[r]=v.getCachedAttributeValue(a.attributeData[r],t)}r=this._getRenderingInfo(h,V);n=a.engineObject;n=n.getComponentVisibility(n.getGeometryRecords()[0],t)?m:0;if(r&&r.symbol instanceof O)for(p=0,r=r.symbol.symbolLayers.items;p<r.length;p++){var q=r[p];if(q instanceof ma&&(q=va.createMaterial(this._edgeView,q,n))){u=!0;k=
q;break}}b.push(k)}return{hasEdges:u,perFeatureEdgeMaterials:b}};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors()){for(var b=a.featureIds?a.featureIds.length:1,c=new B(null,null,{}),e=c.attributes,h=this.layer.objectIdField,g=this._currentRenderer&&this._currentRenderer.requiredFields,f=!1,k=new Uint8Array(4),l={color:null,colorMixMode:null},m=[0,0,0,0],q=null,t=0;t<b;t++){null!=h&&null!=a.featureIds&&(e[h]=a.featureIds[t]);if(null!=g&&null!=a.attributeData)for(var n=0,p=Object.keys(a.attributeData);n<
p.length;n++){var r=p[n];e[r]=v.getCachedAttributeValue(a.attributeData[r],t)}(p=this._getRenderingInfo(c,V))?(p.symbol!==q&&(q=p.symbol,this._getSymbolFillMaterial(p.symbol,l)),n=p.color,p=p.opacity,n=null==n||null==p?Q.overrideColor(n,p,l.color,l.color&&l.color[3],T,m):Q.overrideColor(n,p,null,null,T,m),1>n[3]&&(f=!0),v.encodeSymbolColor(n,l.colorMixMode,k)):v.encodeSymbolColor(null,null,k);a.componentColorBuffer.textureBuffer.setData(a.componentIndices[t],0,k[0],k[1],k[2],k[3])}this._updateObjectOpacity(a.engineObject,
f)}};c.prototype._setComponentIndices=function(a,b){for(var c=a.getAttribute(l.VertexAttrConstants.COMPONENTINDEX),e=c.data,h=c.offsetIdx,c=c.strideIdx,g=a.getIndices(l.VertexAttrConstants.COMPONENTINDEX),f=0;f<b.length;f++)for(var k=a.componentOffsets[f+1],m=a.componentOffsets[f];m<k;m++)e[h+g[m]*c]=b[f]};c.prototype._elevationInfoChanged=function(){var a=this.layer.elevationInfo&&this.layer.elevationInfo.unit;a&&!P.supportsUnit(a)&&w.warn("elevationInfo.unit","'"+a+"' is not a valid unit")};c.prototype._rangeInfosChanged=
function(a){null!=a&&0<a.length&&w.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};c.prototype._reloadAll=function(){this._removeAllNodeDataFromStage();null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._nodeId2Meta.forEach(function(a){b._updateObjectOpacity(a.engineObject);b._addOrUpdateEdgeRendering(a)})};c.prototype._updateObjectOpacity=function(a,b){var c=
0;for(a=a.getGeometryRecords();c<a.length;c++)for(var e=0,h=a[c].materials;e<h.length;e++){var g=h[e],f=g.metadata;void 0!==b&&(f.symbolIsTransparent=b);var k=g.getParams(),f=this._calcEngineMaterialTransparencyParams(f.i3sTex,f.i3sMatParams,f.symbolIsTransparent);k.transparent===f.transparent&&k.layerOpacity===f.layerOpacity||g.setParameterValues(f)}};c.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};c.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};
c.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};c.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};c.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};c.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new ta(this.layer,{forAll:function(c,e){a._forAllFeatures(function(d,e,
f){b.id=d;b.index=e;b.meta=f;a._boundingBoxCornerPoints(e,f.engineObject,b.bbCorners);c(b)},e)},createGraphic:function(b){return a._createGraphic(b.index,b.meta)},requestFields:function(b,c,h){return v.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),h,function(){var d=a._getGraphicIndices(b,c);return{node:b,indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return a._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};c.prototype._createExtentBuilder=
function(){var a=this.view.renderSpatialReference,b=this.view.spatialReference,c=z.empty(),e=new Float64Array(24);return{add:function(d){I.bufferToBuffer(d.bbCorners,a,0,e,b,0,8)&&z.expandWithBuffer(c,e,0,8)},getExtent:function(){return z.toExtent(c,b)}}};c.prototype._forAllFeatures=function(a,b,c){var d=this;this._nodeId2Meta.forEach(function(e,g){d._forAllFeaturesOfNode(e,a,c);b&&b(e.node)})};c.prototype._forAllFeaturesOfNode=function(a,b,c){for(var d=a.featureIds,h=a.engineObject.getGeometryRecords()[0],
g=0;g<d.length;g++)(c||a.engineObject.getComponentVisibility(h,g))&&b(d[g],g,a,h)};c.prototype._createGraphic=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);if(null!=b.attributeData)for(var e=0,h=Object.keys(b.attributeData);e<h.length;e++){var g=h[e];c[g]=v.getCachedAttributeValue(b.attributeData[g],a)}a=new B(null,null,c);a.layer=this.layer;a.sourceLayer=this.layer;return a};c.prototype._boundingBoxCornerPoints=function(a,b,c){a=b.geometries[0].getComponentAABB(a,
U);for(var d=0;8>d;++d)E[0]=d&1?a[0]:a[3],E[1]=d&2?a[1]:a[4],E[2]=d&4?a[2]:a[5],H.mat4d.multiplyVec3(b.objectTransformation,E),c[3*d]=E[0],c[3*d+1]=E[1],c[3*d+2]=E[2];return c};c.prototype.highlight=function(a,b){var c=this,e=this._highlights;if(a instanceof na){b=e.acquireSet(b);var h=b.set,g=b.handle;this.queryObjectIds(a).then(function(a){return e.setFeatureIds(h,a)});return g}if("number"===typeof a||a instanceof B)return this.highlight([a],b);a instanceof fa&&(a=a.toArray());if(Array.isArray(a)&&
0<a.length){if(a[0]instanceof B)return a=a.map(function(a){return J.attributeLookup(a.attributes,c._getObjectIdField())}),g=e.acquireSet(b),b=g.set,g=g.handle,e.setFeatureIds(b,a),g;if("number"===typeof a[0])return g=e.acquireSet(b),b=g.set,g=g.handle,e.setFeatureIds(b,a),g}return{remove:function(){}}};c.prototype.visibleGeometryChanged=function(a){var b=this;a?this._elevationProvider.objectChanged(a):this._elevationProvider.layerChanged();null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=
ja.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null}))};x([u.property()],c.prototype,"layer",void 0);x([u.property()],c.prototype,"_controller",void 0);x([u.property({dependsOn:["_controller.updating"]})],c.prototype,"updating",void 0);x([u.property(wa.updatingPercentage)],c.prototype,"updatingPercentage",void 0);x([u.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0);x([u.property({readOnly:!0})],
c.prototype,"hasTexturesOrVertexColors",null);x([u.property({readOnly:!0,dependsOn:["layer.renderer"]})],c.prototype,"rendererNeedsTextures",null);x([u.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);x([u.property()],c.prototype,"alwaysLoadEverythingModeEnabled",void 0);x([u.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","_useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",
null);x([u.property({dependsOn:["layer.version"]})],c.prototype,"_useCompressedTextures",null);return c=x([u.subclass("esri.views.3d.layers.SceneLayerView3D")],c)}(u.declared(oa));var E=H.vec3d.create(),U=z.create(),Ia=z.create(),G=[0,0,0,0],V={symbol:null};return M});