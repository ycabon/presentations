// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../Color ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./ElevationAligners ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/ColorMaterial".split(" "),
function(y,R,E,F,G,z,H,r,I,J,K,L,l,x,M,t,A,u,B,N,O,C,P,Q){var v=P.VertexAttrConstants;y=A.vec3d;var q=A.mat4d;x=function(w){function m(){var a=null!==w&&w.apply(this,arguments)||this;a._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};return a}E(m,w);m.prototype._prepareResources=function(){this._prepareFillResources();this._prepareOutlineResources();this.resolve()};m.prototype._prepareFillResources=function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),
b={color:b,transparent:1>b[3]||this._isPropertyDriven("opacity"),polygonOffset:!1,vertexColors:!0};this._material=new Q(b,a+"_colormat");this._context.stage.add(u.ModelContentType.MATERIAL,this._material)};m.prototype._prepareOutlineResources=function(){var a=this.symbol.outline;if(this._hasOutline=!!(a&&a.size&&0<a.size&&a.color))a={idHint:this._getStageIdHint()+"_outline",color:this._getOutlineColor(),width:G.pt2px(a.size)},this._outlineMaterial=1.5<=a.width?t.createRibbonMaterial(a):t.createNativeMaterial(a),
this._context.stage.add(u.ModelContentType.MATERIAL,this._outlineMaterial)};m.prototype.destroy=function(){w.prototype.destroy.call(this);this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id),this._material=null);this._outlineMaterial&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._outlineMaterial.id),this._outlineMaterial=null)};m.prototype.createGraphics3DGraphic=function(a){var b=a.graphic,g=b.geometry.type;if("polyline"!==
g&&"polygon"!==g&&"extent"!==g)return this._logWarning("unsupported geometry type for fill symbol: "+g),null;if(!this._validateGeometry(b.geometry))return null;g="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var h=this.getGraphicElevationContext(b);return"on-the-ground"===h.mode?this._createAsOverlay(b,a,h,g):this._createAs3DShape(b,a,h,g,b.uid)};m.prototype.layerPropertyChanged=function(a,b,g){if("opacity"===a)return b=this._material.getColor(),g=this._getMaterialOpacity(),
this._material.setColor([b[0],b[1],b[2],g]),this._material.setTransparent(1>g),this._outlineMaterial&&(b=this._outlineMaterial.getColor(),this._outlineMaterial.setColor([b[0],b[1],b[2],this._getOutlineOpacity()])),!0;if("elevationInfo"===a){a=this._elevationContext.mode;this._updateElevationContext();var h=this._elevationContext.mode;if(null==a||null==h)return!1;if("on-the-ground"===a&&"on-the-ground"===h)return!0;if(a!==h&&("on-the-ground"===a||"on-the-ground"===h))return!1;a=l.needsElevationUpdates2D(h);
for(var k in b){var c=b[k];(h=g(c))&&"object3d"===h.type&&(c=c.graphic,h.needsElevationUpdates=a,h.elevationContext.set(this.getGraphicElevationContext(c)))}return!0}return!1};m.prototype.setDrawOrder=function(a,b,g){this.updateSymbolLayerOrder(a,b);this._material&&(this._material.renderPriority=a+b/2,g.add(this._material.id));this._outlineMaterial&&(this._outlineMaterial.renderPriority=a,g.add(this._outlineMaterial.id))};m.prototype._createAs3DShape=function(a,b,g,h,k){var c=this._getPolyGeometry(a);
a=c.rings;var e=this._getOutlineGeometry(c,a),c=l.getGeometryVertexData3D(e,I.hasZ(c),c.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,g);d.idHint=h;d.color=b;d.data=c;var f;this._hasOutline&&(f=new c.vertexData.constructor(c.vertexData));d.outNum=0;d.outGeometries=[];d.outTransforms=[];d.outMaterials=[];this._createAs3DShapeFill(d);d.data.vertexData=f;this._createAs3DShapeOutline(d);this._logGeometryCreationWarnings(d.data,a,
"rings","FillSymbol3DLayer");if(0===d.outNum)return null;b=new O({geometries:d.outGeometries,materials:d.outMaterials,transformations:d.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicId:k},idHint:h});b=new L(this,b,d.outGeometries,null,null,J.perVertexElevationAligner,g);b.alignedTerrainElevation=c.terrainElevation;b.needsElevationUpdates=l.needsElevationUpdates2D(g.mode);return b};m.prototype._createAs3DShapeFill=function(a){for(var b=a.data.geometryData.polygons,g=
a.data.eleVertexData,h=a.data.vertexData,k=function(f){var e=b[f];f=e.count;var k=e.index;if(c._context.clippingExtent&&(l.computeBoundingBox(g,k,f,n),l.boundingBoxClipped(n,c._context.clippingExtent)))return"continue";var d=new Float64Array(g.buffer,3*k*g.BYTES_PER_ELEMENT,3*f),m=new Float64Array(h.buffer,3*k*h.BYTES_PER_ELEMENT,3*f),e=e.holeIndices.map(function(a){return a-k}),e=z(d,e,3);if(0===e.length)return"continue";l.chooseOrigin(h,k,f,p);l.subtractCoordinates(h,k,f,p);f=c._createFillGeometry(e,
0,m,d,a.color);f=new B(f,a.idHint);f.singleUse=!0;d=q.identity();q.translate(d,p,d);a.outGeometries.push(f);a.outMaterials.push([c._material]);a.outTransforms.push(d);a.outNum++},c=this,e=0;e<b.length;++e)k(e)};m.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.data.geometryData.outlines,g=a.data.eleVertexData,h=a.data.vertexData,k=0;k<b.length;++k){var c=b[k],e=c.index,f=c.count;if(this._context.clippingExtent&&(l.computeBoundingBox(g,e,f,n),l.boundingBoxClipped(n,this._context.clippingExtent)))continue;
l.chooseOrigin(h,e,f,p);l.subtractCoordinates(h,e,f,p);c=new Float64Array(g.buffer,3*e*g.BYTES_PER_ELEMENT,3*f);e=new Float64Array(h.buffer,3*e*h.BYTES_PER_ELEMENT,3*f);e=t.createPolylineGeometry(e,c,a.isRings,D,0);e=new B(e,a.idHint+"outline"+k);e.singleUse=!0;c=q.identity();q.translate(c,p,c);a.outGeometries.push(e);a.outMaterials.push([this._outlineMaterial]);a.outTransforms.push(c);a.outNum++}};m.prototype._createAsOverlay=function(a,b,g,h){g=this._getPolyGeometry(a);a=g.rings;var k=this._getOutlineGeometry(g,
a);this._material.renderPriority=this._symbolLayerOrder+this._symbolLayerOrderDelta/2;this._hasOutline&&(this._outlineMaterial.renderPriority=this._symbolLayerOrder);g=l.getGeometryVertexDataDraped(k,g.spatialReference,this._context.overlaySR);d.idHint=h;d.color=b;d.data=g;var c;this._hasOutline&&(c=new g.vertexData.constructor(g.vertexData));d.outNum=0;d.outGeometries=[];d.outBoundingBox=r.empty();this._createAsOverlayFill(d);d.data.vertexData=c;this._createAsOverlayOutline(d);this._logGeometryCreationWarnings(d.data,
a,"rings","FillSymbol3DLayer");return 0<d.outNum?new K(this,d.outGeometries,d.outBoundingBox):null};m.prototype._createAsOverlayFill=function(a){for(var b=a.data.vertexData,g=a.data.geometryData.polygons,h=function(e){var f=g[e];e=f.count;var c=f.index,h=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*e),f=f.holeIndices.map(function(a){return a-c}),h=z(h,f,3);if(0===h.length)return"continue";l.computeBoundingBox(b,c,e,n);if(l.boundingBoxClipped(n,k._context.clippingExtent))return"continue";r.expand(a.outBoundingBox,
n);l.chooseOrigin(b,c,e,p);l.subtractCoordinates(b,c,e,p);l.setZ(b,c,e,k._getDrapedZ());e=q.identity();q.translate(e,p,e);h=k._createFillGeometry(h,c,b,null,a.color);f=new C(h);f.material=k._material;var d=n;f.center=[.5*(d[0]+d[3]),.5*(d[1]+d[4]),0];f.bsRadius=.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]));f.transformation=e;f.name=a.idHint;f.uniqueName=a.idHint+"#"+h.id;a.outGeometries.push(f);a.outNum++},k=this,c=0;c<g.length;++c)h(c)};m.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=
a.data.vertexData,d=a.data.geometryData.outlines,h=0;h<d.length;++h){var k=d[h],c=k.index,k=k.count;l.computeBoundingBox(b,c,k,n);if(!l.boundingBoxClipped(n,this._context.clippingExtent)){r.expand(a.outBoundingBox,n);l.chooseOrigin(b,c,k,p);l.subtractCoordinates(b,c,k,p);l.setZ(b,c,k,this._getDrapedZ());k=new Float64Array(b.buffer,3*c*b.BYTES_PER_ELEMENT,3*k);c=q.identity();q.translate(c,p,c);var k=t.createPolylineGeometry(k,null,!0,D,0),e=new C(k);e.material=this._outlineMaterial;var f=n;e.center=
[.5*(f[0]+f[3]),.5*(f[1]+f[4]),0];e.bsRadius=.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]));e.transformation=c;e.name=a.idHint+"outline";e.uniqueName=a.idHint+"outline#"+k.id;a.outGeometries.push(e);a.outNum++}}};m.prototype._getOutlineGeometry=function(a,b){return b};m.prototype._getOutlineOpacity=function(){return this._getLayerOpacity()*this.symbol.outline.color.a};m.prototype._getOutlineColor=function(){var a=this.symbol.outline.color,b=this._getOutlineOpacity();return M.mixinColorAndOpacity(F.toUnitRGB(a),
b)};m.prototype._getPolyGeometry=function(a){a=a.geometry;return"extent"===a.type?H.fromExtent(a):a};m.prototype._createFillGeometry=function(a,b,d,h,k){for(var c=a.length,e=new Uint32Array(c),f=new Uint32Array(c),g=0;g<c;g++)e[g]=a[g]+b,f[g]=0;a={};b={};a[v.POSITION]=e;a[v.COLOR]=f;b[v.POSITION]={size:3,data:d};b[v.COLOR]={size:4,data:k};h&&(b.mapPos={size:3,data:h},a.mapPos=e);return new N(b,a)};return m}(x);var n=r.create(),p=y.create(),D=new Float32Array([255,255,255,255]),d={idHint:null,color:null,
data:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};return x});