// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../request ./AsyncQuotaRoundRobinQueue ./PromiseLightweight ../webgl-engine/lib/Performance ../webgl-engine/lib/Util".split(" "),function(p,q,h,k,l,g,m){function n(a,d){if(a.status===c.CANCELLED)return!1;a.status=c.DOWNLOADING;var b,e;switch(a.docType){case "binary":e="array-buffer";b=0;break;case "image":e="image";break;default:e="json"}a.startTime=g.now();a.downloadObj=h(a.url,{responseType:e,timeout:b,allowImageDataAccess:"image"===a.docType});a.downloadObj.then(function(b){a.duration=
g.now()-a.startTime;a.size="binary"===a.docType?b.data.byteLength:0;a.result=b.data;d(a)},function(b){a.downloadObj.isCanceled()||d(a,b)});return!0}var c;(function(a){a[a.QUEUED=1]="QUEUED";a[a.DOWNLOADING=2]="DOWNLOADING";a[a.CANCELLED=4]="CANCELLED"})(c||(c={}));return function(){function a(a){this.tasks=new Map;this.loadQueue=new k(n,this._doneLoadingCallback,this,a)}a.prototype.destroy=function(){var a=this;this.tasks.forEach(function(b,d){d.isRejected()||d.reject(b.url,null);a._cancelTask(d)});
this.loadQueue.clear();this.tasks=this.loadQueue=null};a.prototype.request=function(a,b,e){var d=this,f=new l.Promise(function(){d.cancel(f)});a={url:a,docType:b,clientType:e,result:null,status:c.QUEUED,clientPromise:f,downloadObj:null,_cancelledInQueue:!1,startTime:0,duration:0,size:0};this.tasks.set(f,a);this.loadQueue.push(a);return f};a.prototype.cancel=function(a){this._cancelTask(a)};a.prototype.hasPendingDownloads=function(){return 0<this.tasks.size};a.prototype._cancelTask=function(a){var b=
this.tasks.get(a);b&&(b.status===c.DOWNLOADING&&(this.loadQueue.workerCancelled(b),b.status=c.CANCELLED,b.downloadObj.cancel(),b.downloadObj=null),b.status=c.CANCELLED,b.clientPromise=void 0,this.tasks.delete(a))};a.prototype._doneLoadingCallback=function(a,b){m.assert(a.status===c.DOWNLOADING);this.tasks.delete(a.clientPromise);b?a.clientPromise.isRejected()||a.clientPromise.reject(a.url,b):a.clientPromise.done(a.url,a.result)};return a}()});