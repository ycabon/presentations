// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../geometry/support/aaBoundingBox ../lib/glMatrix ../support/ArrayPool ../support/earthUtils ../support/mathUtils ./TerrainConst".split(" "),function(ea,M,U,V,da,O,P,N){function Q(d,b,h){for(var f=0;f<h.length;f++){var r=h[f];if(r){var g=r.safeWidth,e=r.width,p=r.pixelData,y=P.clamp(r.dy*(r.y1-b),0,g),r=P.clamp(r.dx*(d-r.x0),0,g),g=Math.floor(y),a=Math.floor(r),t=g*e+a,v=t+e,A=p[t],e=p[v],t=p[t+1],p=p[v+1];if(A+e+t+p<.5*N.ELEVATION_NODATA_VALUE)return y-=g,r-=a,d=A+(t-
A)*r,d+(e+(p-e)*r-d)*y}}return null}function W(d,b,h,f){var r=0<(h&2),g=b+(f?1024:0)+(r?2048:0),e=X[g];if(!e){var e=b-1,p=b-1,y=b*b,a=2*e+2*p,t=e*p*6,v=6*a,A=6*(2*e+p-1);f&&(t*=2,v*=2,A*=2);for(var a=65536<y+a?new Uint32Array(t+v):new Uint16Array(t+v),E=0,k=0,l=t,m,D,n,u,G=0,w=0;w<=p;w++){r&&(G=0===w?A:w===p?-A:0);for(var l=l+G,c=0;c<=e;c++)n=R(c,w,e,p),-1<n&&(u=0===w&&c!==e?1:c===e&&w!==p?e+1:w===p&&0!==c?-1:0===c&&0!==w?-(e+1):0,0!==u&&(m=E,D=y+n,n=y+(0===c&&1===w?0:n+1),u=E+u,f?(a[l+0]=m,a[l+1]=
D,a[l+2]=D,a[l+3]=n,a[l+4]=n,a[l+5]=m,a[l+6]=n,a[l+7]=u,a[l+8]=u,a[l+9]=m,a[l+10]=m,a[l+11]=n,l+=12):(a[l+0]=m,a[l+1]=D,a[l+2]=n,a[l+3]=n,a[l+4]=u,a[l+5]=m,l+=6))),++E,c<e&&w<p&&(m=w*(e+1)+c,D=m+1,n=D+(e+1),u=n-1,f?(a[k+0]=m,a[k+1]=D,a[k+2]=D,a[k+3]=n,a[k+4]=n,a[k+5]=m,a[k+6]=n,a[k+7]=u,a[k+8]=u,a[k+9]=m,a[k+10]=m,a[k+11]=n,k+=12):(a[k+0]=m,a[k+1]=D,a[k+2]=n,a[k+3]=n,a[k+4]=u,a[k+5]=m,k+=6));l-=G}e={values:a,numSurfaceIndices:t,numSkirtIndices:v};X[g]=e}d.indices=e.values;d.numSurfaceIndices=e.numSurfaceIndices;
d.numSkirtIndices=e.numSkirtIndices;d.numWithoutSkirtIndices=d.numSurfaceIndices+(h?6*(b-1)*(f?2:1):0)}function S(d,b,h,f){d<f[0]&&(f[0]=d);d>f[3]&&(f[3]=d);b<f[1]&&(f[1]=b);b>f[4]&&(f[4]=b);h<f[2]&&(f[2]=h);h>f[5]&&(f[5]=h)}function Y(d,b){var h=b>d?1:0;return 2+4*h+(1-2*h)*(d+b)}function R(d,b,h,f){return 0===b?d:d===h?h+b:b===f?h+f+(h-d):0===d&&0<b?2*h+f+(f-b):-1}Object.defineProperty(M,"__esModule",{value:!0});var T=new da.ArrayPool(Float32Array);M.releaseGeometry=function(d){T.put(d.vertexAttributes);
d.vertexAttributes=null;d.indices=null};M.elevationSampler=Q;M.createSphericalGlobeTile=function(d,b,h,f,r,g,e,p,y){var a=h[0],t=h[1],v=h[2];h=h[3];var A=.1*O.earthRadius*(h-t),E=d-1,k=d-1,l=d*d,m=T.get(5*(l+(2*E+2*k))),D=y.boundingBox;U.empty(D);var n=b[2]-b[0],u=b[3]-b[1],G=v-a,v=g[0],w=g[1];g=g[2];for(var c=0;c<=E;c++){var I=c/E,B=a+I*G;Z[c]=Math.sin(B);aa[c]=Math.cos(B);ba[c]=I;ca[c]=b[0]+I*n}a=f&&!!(e&1);n=f&&!!(e&2);for(B=G=0;B<=k;B++){var J=B/k,c=P.lerp(t,h,J),H=Math.cos(c),L=Math.sin(c),K=
void 0;f?(K=O.earthRadius/2*Math.log((1+L)/(1-L)),J=(K-b[1])/u):K=180*c/Math.PI;for(c=0;c<=E;c++){var I=ba[c],q=Z[c],F=aa[c],z=O.earthRadius;r&&(z+=Q(ca[c],K,r)||0);F=F*H*z-v;q=q*H*z-w;z=L*z-g;S(F,q,z,D);var x=5*G;m[x+0]=F;m[x+1]=q;m[x+2]=z;m[x+3]=I;m[x+4]=J;x=R(c,B,E,k);if(-1<x){var x=5*(l+x),C=a&&0===B?-1:n&&B===k?1:0,F=0===C?F:-v,q=0===C?q:-w,z=0===C?z:O.earthRadius*C-g;m[x+0]=F;m[x+1]=q;m[x+2]=z;m[x+3]=0===C?Y(I,J):I;m[x+4]=0===C?A:J;0!==C&&S(F,q,z,D)}++G}}y.numVertsPerRow=d;y.vertexAttributes=
m;y.skirtLength=A;V.vec4d.set4(0,0,1,1,y.uvOffsetAndScale);W(y,d,f?e:0,p)};M.createPlanarGlobeTile=function(d,b,h,f,r,g,e){var p=b[0],y=b[1],a=b[2]-p,t=b[3]-y,v=g?Math.max(0,(g[0]-b[0])/a):0,A=g?Math.max(0,(g[1]-b[1])/t):0,E=g?Math.min(1,(g[2]-b[0])/a):1;b=g?Math.min(1,(g[3]-b[1])/t):1;var k=E>v?1/(E-v):1,l=b>A?1/(b-A):1,m=-v*k,D=-A*l,n=.1*a,u=d-1,G=d-1,w=d*d,c=T.get(5*(w+(2*u+2*G))),I=e.boundingBox;U.empty(I);for(var B=0,J=0;J<=G;J++){var H=J/G,L=D+H*l,H=y+H*t;g&&(H<g[1]?(H=g[1],L=0):H>g[3]&&(H=
g[3],L=1));for(var K=0;K<=u;K++){var q=K/u,F=m+q*k,q=p+q*a;g&&(q<g[0]?(q=g[0],F=0):q>g[2]&&(q=g[2],F=1));var z=h?Q(q,H,h)||0:0,q=q-f[0],x=H-f[1],z=z-f[2];S(q,x,z,I);c[5*B]=q;c[5*B+1]=x;c[5*B+2]=z;c[5*B+3]=F;c[5*B+4]=L;var C=R(K,J,u,u);-1<C&&(C=5*(w+C),c[C]=q,c[C+1]=x,c[C+2]=z,c[C+3]=Y(F,L),c[C+4]=n);++B}}e.numVertsPerRow=d;e.vertexAttributes=c;e.skirtLength=n;V.vec4d.set4(v,A,E-v,b-A,e.uvOffsetAndScale);W(e,d,0,r)};var X=[],Z=Array(N.MAX_TILE_TESSELATION+1),aa=Array(N.MAX_TILE_TESSELATION+1),ba=Array(N.MAX_TILE_TESSELATION+
1),ca=Array(N.MAX_TILE_TESSELATION+1)});