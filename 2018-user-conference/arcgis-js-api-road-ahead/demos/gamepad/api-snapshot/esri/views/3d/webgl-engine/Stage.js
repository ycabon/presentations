// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ./lib/gl-matrix ./lib/ModelContentType ./lib/Selector ./lib/Util ./lighting/Lightsources ./parts/Model ./parts/View".split(" "),function(r,t,k,u,p,h,v,q,w){r=k.vec2d;t=k.vec2;var n=k.vec3d;k=function(){function b(a,d,c){this._intersectTolerance=p.DEFAULT_TOLERANCE;this._viewContent=[];this._externalIntersectionHandlers=[];this.container=d;this.viewingMode=a;this.model=new q;this.view=new w(d,this,this.model.getDirtySet(),c);this._validateHUDSelector=new p(this.viewingMode);
this._validateHUDSelector.enableHUDSelection=!1;this.view.setLighting({lights:[new v.MainLight(n.createFrom(.7,.7,.7)),new v.AmbientLight(n.createFrom(.3,.3,.3))],groundLightingFactor:.5,globalFactor:.5})}b.prototype.setNeedsRender=function(){this.view.setNeedsRender()};b.prototype.dispose=function(){this.view.dispose();this.model=this.view=null};b.prototype.beginMod=function(){b.DebugSettings.fineGrainedContentValidation&&this.model.validateContent()};b.prototype.endMod=function(a){void 0===a&&(a=
!1);b.DebugSettings.fineGrainedContentValidation&&!a&&this.model.validateContent()};b.prototype.add=function(a,d){this.model.add(a,d);"function"===typeof d.addParentStage&&d.addParentStage(this)};b.prototype.remove=function(a,d){a=this.model.remove(a,d);"function"===typeof a.removeParentStage&&a.removeParentStage(this);return a};b.prototype.notifyDirty=function(a,d,c,b){this.model.notifyDirty(a,d,c,b)};b.prototype.processDirty=function(){var a=this.model.getDirtySet(),d=a.getDirtyMaterials();if(a.hasDirtyGeometryRecords()||
d){b.DebugSettings.endFrameContentValidation&&this.model.validateContent();b.DebugSettings.logDirtySet&&console.log("Dirty set: "+this.model.getDirtySet().formatDebugInfo(!1));var c=a.commitLayers(this._viewContent);(0<c[0].length+c[1].length+c[2].length||d)&&this.view.modify(c[0],c[1],c[2],d);b.DebugSettings.logDirtySet&&(console.log("RGs add: "+c[0].map(function(a){return a.uniqueName})),console.log("RGs remove: "+c[1].map(function(a){return a.uniqueName})));a.commit();a.clearDirtyMaterials();this.view.setNeedsRender()}};
b.prototype.processDirtyLayer=function(a){var d=this.model.getDirtySet(),b=d.getDirtyMaterials();a=d.commitLayers([a]);(0<a[0].length+a[1].length+a[2].length||b)&&this.view.modify(a[0],a[1],a[2],b);d.clearDirtyMaterials();this.view.setNeedsRender()};b.prototype.get=function(a,d){return this.model.get(a,d)};b.prototype.getAll=function(a){return this.model.getAll(a)};b.prototype.addTextureListener=function(a){this.view.addTextureListener(a)};b.prototype.removeTextureListener=function(a){this.view.removeTextureListener(a)};
b.prototype.getContainer=function(){return this.container};b.prototype.getCamera=function(){return this.view.getCamera()};b.prototype.setCamera=function(a){this.view.setCamera(a)};b.prototype.getViewParams=function(a){return this.view.getViewParams(a)};b.prototype.setViewParams=function(a){this.view.setViewParams(a)};b.prototype.getLayers=function(){return this.model.getAll(u.LAYER)};b.prototype.setLighting=function(a){this.view.setLighting(a)};b.prototype.getCanvas=function(){return this.view.getCanvas()};
b.prototype.setRenderParams=function(a){this.view.setRenderParams(a)};b.prototype.getRenderParams=function(){return this.view.getRenderParams()};b.prototype.has=function(a){return this.view.has(a)};b.prototype.getViewContent=function(){return this._viewContent.slice(0)};b.prototype.setViewContent=function(a){var d=h.array2object(this._viewContent),b=h.array2object(a),e=h.subtractObjects(b,d),d=h.subtractObjects(d,b);this.processDirty();b=this.model.getDirtySet();e=b.getResidentRenderGeometriesFilteredByLayers(h.object2array(e));
d=b.getResidentRenderGeometriesFilteredByLayers(h.object2array(d));this.view.modify(e,d,[]);this._viewContent=a.slice(0)};b.prototype.addToViewContent=function(a){for(var b=[],c=0;c<a.length;c++)-1===this._viewContent.indexOf(a[c])&&b.push(a[c]);0<a.length&&(this.processDirty(),a=this.model.getDirtySet().getResidentRenderGeometriesFilteredByLayers(b),this.view.modify(a,[],[]),this._viewContent.push.apply(this._viewContent,b))};b.prototype.removeFromViewContent=function(a){this.processDirty();for(var b=
this.model.getDirtySet(),c=this._viewContent,e=[],f=0;f<a.length;f++){var l=c.indexOf(a[f]);-1<l&&(c[l]=c[c.length-1],c.pop(),e.push(a[f]))}a=b.getResidentRenderGeometriesFilteredByLayers(e);this.view.modify([],a,[])};b.prototype.getViewFrustumObjects=function(){return this.view.getFrustumObjects()};b.prototype.getLocalOrigin=function(a,b,c){return this.model.getOrigin(a,b,c)};b.prototype.getFrameTask=function(){return this.view.getFrameTask()};b.prototype.requestScreenCapture=function(a,b){this.view.requestScreenCapture(a,
b)};b.prototype.getAllTexturesLoaded=function(){return this.view.getAllTexturesLoaded()};b.prototype.getTextureLoaded=function(a){return this.view.getTextureLoaded(a)};b.prototype.addExternalRenderer=function(a,b){"function"===typeof b.intersect&&this._externalIntersectionHandlers.push(b);return this.view.addExternalRenderer(a,b)};b.prototype.removeExternalRenderer=function(a){var b=this._externalIntersectionHandlers.indexOf(a);-1<b&&this._externalIntersectionHandlers.splice(b,1);return this.view.removeExternalRenderer(a)};
b.prototype.getContentDebugStrings=function(a){return this.model.formatDebugInfo(a)};b.prototype.getRenderStats=function(){return this.view.getCombinedStats()};b.prototype.getRenderStatString=function(a){var b=this.getRenderStats(),c="";if(a){var c=c+"\x3ctable\x3e",e;for(e in b)c+="\x3ctr\x3e\x3ctd\x3e"+e+'\x3c/td\x3e\x3ctd style\x3d"text-align: right"\x3e'+Math.round(b[e])+"\x3c/td\x3e\x3c/tr\x3e";c+="\x3c/table\x3e"}else for(e in b)c+=e+": "+b[e]+"\n";return c};b.prototype.pick=function(a,b,c,
e){var d=n.create(),l=n.create();this.view.getPickRay(a,d,l);return this.pickRay(d,l,a,a,b,c,e)};b.prototype.pickRayWithBeginPoint=function(a,b,c,e,f){this.view.pickRayWithBeginPoint(a,b,c,e,f)};b.prototype.pickRay=function(a,b,c,e,f,l,m){e=this.view.getCamera();c||(c=x,e.projectPoint(b,c));var d;if(f){d=Array(f.length);for(var g=0;g<d.length;g++)d[g]=this.model.get(q.ContentType.LAYER,f[g])}else{d=[];f=this.getViewContent();for(var h=this.model.getAll(q.ContentType.LAYER),g=0;g<f.length;g++){var k=
h[f[g]];k&&k.isPickable&&d.push(k)}}m?m.init(d,a,b,c,e,this._intersectTolerance,l):m=new p(this.viewingMode,d,a,b,c,e,this._intersectTolerance,l);for(g=0;g<this._externalIntersectionHandlers.length;g++)this._externalIntersectionHandlers[g].intersect(m,a,b,c);if(m.getHudResults().length){g=m.getHudResults();g.sort(function(a,b){return b.dist-a.dist});b=g[g.length-1];f=y;e.projectPoint(b.center,f);f[0]=Math.round(f[0]);f[1]=Math.round(f[1]);h=z;this.view.getPickRay(f,a,h);c=n.dist(b.center,a)/n.dist(a,
h)*.99;this._validateHUDSelector.init(d,a,h,f,e,this._intersectTolerance,l);for(g=0;g<this._externalIntersectionHandlers.length;g++)this._externalIntersectionHandlers[g].intersect(this._validateHUDSelector,a,h,f);a=this._validateHUDSelector.getMinResult();(null==a.dist||c<=a.dist)&&m.getMinResult().copyFrom(b)}return m};b.prototype.getIntersectTolerance=function(){return this._intersectTolerance};b.prototype.setIntersectTolerance=function(a){void 0===a&&(a=1E-5);this._intersectTolerance=a};b.prototype.getDrapedTextureRenderer=
function(){return this.view.getDrapedTextureRenderer()};b.DebugSettings={fineGrainedContentValidation:!1,endFrameContentValidation:!1,logDirtySet:!1};b.ModelContentType=u;return b}();var x=r.create(),y=t.create(),z=n.create();return k});