// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/date/locale ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../geometry/support/scaleUtils ./geometryUtils".split(" "),function(S,v,H,x,I,J,l,K,z){function B(a,b){var c=a.filter,f=a.searchExtent;b=b&&b.extent;a=a.withinViewEnabled&&b?b:void 0;return c&&c.geometry||f||a}function C(a){return a?a.load().then(l.resolve).catch(l.reject):l.resolve()}function D(a){return a&&!!a.get("capabilities.query.supportsPagination")}function E(a){var b=
"";a&&(a=a.fields)&&a.some(function(a){if("string"===a.type)return b=a.name,!0});return b}function A(a,b){return a&&b?b.every(function(b){return!!a.getField(b)}):!1}function L(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1}function M(a,b,c){var f=null;(a=a.codedValues)&&a.some(function(a){var g=a.name,g=c?g:g.toLowerCase();if((c?b:b.toLowerCase())===g)return f=a.code.toString(),!0});return f}function t(a,b){return(b=b&&b.where)?"("+a+") AND ("+b+")":a}function F(a,b,c,f,r){var g=
"";if(a){var d=N.test(b.url)&&L(a)?"N":"";c&&c.forEach(function(c){var e=b.getField(c);c=((c=b.getFieldDomain(c))&&"coded-value"===c.type?M(c,a,r):null)||a||null;if(null!==c){var h=e.type,e=e.name;"string"===h||"date"===h?r?e=t(e+" \x3d "+d+"'"+c+"'",f):(c=c.toUpperCase(),e=t("UPPER("+e+") LIKE "+d+"'%"+c+"%'",f)):"oid"===h||"small-integer"===h||"integer"===h||"single"===h||"double"===h?(c=parseFloat(c),e=isNaN(c)?null:t(e+" \x3d "+c,f)):e=t(e+" \x3d "+c,f);e&&(g+=g?" OR ("+e+")":"("+e+")")}})}return g}
function O(a,b){var c=null;(a=a.codedValues)&&a.length&&a.some(function(a){if(a.code===b)return c=a.name,!0});return c}function G(a,b,c,f){var r=a.layer,g=a.attributes;f=r.getFieldDomain(c);return b?I.substitute(g,b):c&&a.hasOwnProperty("attributes")&&g.hasOwnProperty(c)?(a=g[c],c=r.getField(c),f&&"coded-value"===f.type?O(f,a):c&&"date"===c.type?H.format(new Date(a)):a):""}function P(a,b,c,f){return a.features.map(function(a){var g=a.attributes[a.layer.objectIdField];return{text:G(a,b.suggestionTemplate,
f,b),key:g,sourceIndex:c}})}function Q(a,b,c,f,l,g,d){return a.features.map(function(a){var e=a.clone(),h=a.layer,h=(h=h&&h.objectIdField)&&a.attributes[h];a=G(a,c.searchTemplate,l,c);var k=z.createExtentFromGeometry(e.geometry,b,g);return{extent:d?z.scaleExtent(k.clone(),b,d):k,feature:e,key:h,name:a,sourceIndex:f}})}Object.defineProperty(v,"__esModule",{value:!0});var N=/https?:\/\/services.*\.arcgis\.com/i,R=/(?:\{([^}]+)\})/g,y=J.getLogger("esri.widgets.Search.support.featureLayerUtils");v.getResults=
function(a){var b=a.exactMatch,c=void 0===b?!1:b,f=a.location,r=a.maxResults,g=a.spatialReference,d=a.source,t=a.sourceIndex,e=a.suggestResult,h=a.view,k=d.featureLayer,n=d.filter,m=d.zoomScale,q=h&&h.scale,w=B(d,h);return C(k).then(function(){var a=d.displayField||d.featureLayer.displayField||E(d.featureLayer);if(!k.getField(a))return y.error("invalid-field: displayField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","displayField is invalid."));var b=d.outFields||[a];if(!(b&&
1===b.length&&"*"===b[0]||A(k,b)))return y.error("invalid-field: outField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));var p=k.createQuery(),u=d.searchQueryParams;u&&p.set(u);g&&(p.outSpatialReference=g,u=K.getMetersPerUnitForSR(g))&&(p.maxAllowableOffset=u);p.returnGeometry=!0;b&&(p.outFields=b);if(f)p.geometry=f;else if(e.key)p.objectIds=[parseInt(e.key,10)];else{b=d.searchFields||[a];if(!A(k,b))return y.error("invalid-field: search field is invalid."),
l.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));D(k)&&(p.num=r);w&&(p.geometry=w);u=e.text.trim();if(!u)return l.resolve();var v=d.prefix,z=d.suffix,u=(""+(void 0===v?"":v)+u+(void 0===z?"":z)).replace(/\'/g,"''"),b=F(u,k,b,n,c);if(!b)return l.resolve();p.where=b}return k.queryFeatures(p).then(function(b){return Q(b,h,d,t,a,q,m)})})};v.getSuggestions=function(a){var b=a.source,c=a.spatialReference,f=a.suggestTerm,r=a.maxSuggestions,g=a.sourceIndex,d=b.featureLayer,
v=b.filter,e=B(b,a.view);return C(d).then(function(){if(!D(d))return l.resolve();var a=b.displayField||b.featureLayer.displayField||E(b.featureLayer),k=b.searchFields||[a],n=[];b.suggestionTemplate?b.suggestionTemplate.replace(R,function(a,b){n.push(b);return a}):n.push(a);-1===n.indexOf(d.objectIdField)&&n.push(d.objectIdField);var m=!!d.getField(a),q=n&&1===n.length&&"*"===n[0]||A(d,n),w=A(d,k);if(!m)return y.error("invalid-field: displayField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field",
"displayField is invalid."));if(!q)return y.error("invalid-field: outField is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","outField is invalid."));if(!w)return y.error("invalid-field: search field is invalid."),l.reject(new x("searchfeaturelayerutils:invalid-field","search field is invalid."));m=d.createQuery();(q=b.suggestQueryParams)&&m.set(q);m.outSpatialReference=c;m.returnGeometry=!1;m.num=r;m.outFields=n;e&&(m.geometry=e);q=f.trim();if(!q)return l.resolve();var w=b.prefix,
t=b.suffix,q=(""+(void 0===w?"":w)+q+(void 0===t?"":t)).replace(/\'/g,"''"),k=F(q,d,k,v,!1);if(!k)return l.resolve();m.where=k;return d.queryFeatures(m).then(function(c){return P(c,b,g,a)})})}});