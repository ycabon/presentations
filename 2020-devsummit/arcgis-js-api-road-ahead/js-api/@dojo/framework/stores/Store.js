//>>built
(function(b){"object"===typeof module&&"object"===typeof module.exports?(b=b(require,exports),void 0!==b&&(module.exports=b)):"function"===typeof define&&define.amd&&define("require exports tslib ../core/Evented ./state/Patch ./state/Pointer ../shim/Map".split(" "),b)})(function(b,g){function l(b){return"string"===typeof b}Object.defineProperty(g,"__esModule",{value:!0});var h=b("tslib"),m=b("../core/Evented"),n=b("./state/Patch"),k=b("./state/Pointer"),p=b("../shim/Map");b=function(b){function f(){var c=
null!==b&&b.apply(this,arguments)||this;c._state={};c._changePaths=new p.default;c._callbackId=0;c.get=function(c){return c.value};c.apply=function(d,a){void 0===a&&(a=!1);d=(new n.Patch(d)).apply(c._state);c._state=d.object;a&&c.invalidate();return d.undoOperations};c.at=function(d,a){var b=c.get(d);return{path:d.path+"/"+a,state:d.state,value:b&&b[a]}};c.onChange=function(d,a){var b=c._callbackId;Array.isArray(d)||(d=[d]);d.forEach(function(d){return c._addOnChange(d,a,b)});c._callbackId+=1;return{remove:function(){d.forEach(function(a){if(a=
c._changePaths.get(a.path))a.callbacks=a.callbacks.filter(function(a){return a.callbackId!==b})})}}};c._addOnChange=function(d,a,b){var e=c._changePaths.get(d.path);e||(e={callbacks:[],previousValue:c.get(d)});e.callbacks.push({callbackId:b,callback:a});c._changePaths.set(d.path,e)};c.path=function(b){for(var a=[],d=1;d<arguments.length;d++)a[d-1]=arguments[d];a="string"===typeof b?h.__spread([b],a):h.__spread((new k.Pointer(b.path)).segments,a);a=a.filter(l);a=new k.Pointer(1<a.length?a:a[0]||"");
return{path:a.path,state:c._state,value:a.get(c._state)}};return c}h.__extends(f,b);f.prototype._runOnChanges=function(){var b=this,d=[];this._changePaths.forEach(function(a,c){var f=a.previousValue;a=a.callbacks;var e=(new k.Pointer(c)).get(b._state);f!==e&&(b._changePaths.set(c,{callbacks:a,previousValue:e}),a.forEach(function(a){var b=a.callback;a=a.callbackId;-1===d.indexOf(a)&&(d.push(a),b())}))})};f.prototype.invalidate=function(){this._runOnChanges();this.emit({type:"invalidate"})};return f}(m.Evented);
g.Store=b;g.default=b});