// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../Graphic ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/Field ../../../tasks/support/Query".split(" "),function(z,A,t,u,v,m,n,w,l,x,y,q,p){return function(r){function d(a){var b=r.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";b._removeGeometry=!1;b._overrideFields=
null;b._forceIsTable=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;!0===a.isTable&&(b._forceIsTable=!0);void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}t(d,r);d.prototype._maxQueryRate=function(){return n.defaultMaxRecords};d.prototype.end=function(){return this._layer};d.prototype.optimisePagingFeatureQueries=function(){};d.prototype.load=
function(){var a=this;null===this._loadPromise&&(this._loadPromise=l.create(function(b,e){!0===a._layer.loaded?(a._initialiseFeatureSet(),b(a)):(a._layer.when().then(function(){try{a._initialiseFeatureSet(),b(a)}catch(c){e(c)}},e),a._layer.load())}));return this._loadPromise};d.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&
(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){for(var a=[],b=0,e=this.fields;b<e.length;b++){var c=e[b];if("oid"===c.type)a.push(c);else for(var g=0,d=this._layer.outFields;g<d.length;g++){var f=d[g];if(f.toLowerCase()===c.name.toLowerCase()){a.push(c);break}}}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];e=0;for(g=this.fields;e<g.length;e++)if(c=g[e],"oid"===c.type)a.push(c),
b.push(c.name);else for(var d=0,h=this._overrideFields;d<h.length;d++)if(f=h[d],f.toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this.objectIdField=this._layer.objectIdField;this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this._databaseType=n.FeatureServiceDatabaseType.Standardised;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};d.prototype.isTable=function(){return this._forceIsTable||this._layer.isTable||
"table"===this._layer.type||!this._layer.geometryType};d.prototype._isInFeatureSet=function(){return n.IdState.InFeatureSet};d.prototype._candidateIdTransform=function(a){return a};d.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(a){return b._wset=a}):l.resolve(this._wset)};d.prototype._changeFeature=function(a){for(var b={},e=0,c=this.fields;e<c.length;e++){var d=c[e];b[d.name]=a.attributes[d.name]}return new u({geometry:!0===
this._removeGeometry?null:a.geometry,attributes:b})};d.prototype._getFilteredSet=function(a,b,e,c,d){var g=this,f="",h=!1;null!==c&&(f=c.constructClause(),h=!0);if(this.isTable()&&b&&null!==a&&""!==a)return a=new m([],[],!0,null),l.resolve(a);c=new p;c.where=null===e?null===b?"1\x3d1":"":w.toWhereClause(e,n.FeatureServiceDatabaseType.Standardised);c.spatialRelationship=this._makeRelationshipEnum(a);c.outSpatialReference=this.spatialReference;c.orderByFields=""!==f?f.split(","):null;c.geometry=null===
b?null:b;c.returnGeometry=!0;c.relationParameter=this._makeRelationshipParam(a);return this._layer.queryFeatures(c).then(function(a){if(null===a)return new m([],[],h,null);g._checkCancelled(d);var b=[];a.features.forEach(function(a){var c=a.attributes[g._layer.objectIdField];b.push(c);g._featureCache[c]=g._changeFeature(a)});return new m([],b,h,null)})};d.prototype._makeRelationshipEnum=function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";
case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};d.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};d.prototype._queryAllFeatures=function(){var a=
this;if(this._wset)return l.resolve(this._wset);var b=new p;b.where="1\x3d1";return this._ensureLoaded().then(function(){if(a._layer.source&&a._layer.source.items){var d=[];a._layer.source.items.forEach(function(b){var c=b.attributes[a._layer.objectIdField];d.push(c);a._featureCache[c]=a._changeFeature(b)});a._wset=new m([],d,!1,null);return a._wset}return a._layer.queryFeatures(b).then(function(b){var c=[];b.features.forEach(function(b){var d=b.attributes[a._layer.objectIdField];c.push(d);a._featureCache[d]=
a._changeFeature(b)});a._wset=new m([],c,!1,null);return a._wset})})};d.prototype._getFeatures=function(a,b,d){var c=[];-1!==b&&void 0===this._featureCache[b]&&c.push(b);for(var e=a._lastFetchedIndex;e<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[e]]&&(a._known[e]!==b&&c.push(a._known[e]),c.length>d));e++);return 0===c.length?l.resolve("success"):l.reject(Error("Unaccounted for Features. Not in Feature Collection"))};d.prototype._refineSetBlock=function(a){return l.resolve(a)};
d.prototype._stat=function(){return l.resolve({calculated:!1})};d.prototype._canDoAggregates=function(){return l.resolve(!1)};d.prototype.relationshipMetaData=function(){return[]};d._cloneAttr=function(a){var b={},d;for(d in a)b[d]=a[d];return b};d.prototype.nativeCapabilities=function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}};d.create=function(a,b){var e=a.layerDefinition.objectIdField,
c=a.layerDefinition.geometryType;void 0===c&&(c=a.featureSet.geometryType||"");var g=a.featureSet.features,l=b.toJSON();if(""===e||void 0===e){for(var f=!1,h=0,m=a.layerDefinition.fields;h<m.length;h++){var k=m[h];if("oid"===k.type||"esriFieldTypeOID"===k.type){e=k.name;f=!0;break}}if(!1===f){e="FID";f=!0;for(h=0;f;){for(var m=!0,n=0,p=a.layerDefinition.fields;n<p.length;n++)if(k=p[n],k.name===e){m=!1;break}!0===m?f=!1:(h++,e="FID"+h.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",
name:e,alias:e});k=[];for(f=0;f<g.length;f++)k.push({geometry:a.featureSet.features[f].geometry,attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):{}}),k[f].attributes[e]=f;g=k}}f=[];h=0;for(a=a.layerDefinition.fields;h<a.length;h++)k=a[h],k instanceof q?f.push(k):f.push(q.fromJSON(k));switch(c){case "esriGeometryPoint":c="point";break;case "esriGeometryPolyline":c="polyline";break;case "esriGeometryPolygon":c="polygon";break;case "esriGeometryExtent":c=
"extent";break;case "esriGeometryMultipoint":c="multipoint"}a=0;for(h=g;a<h.length;a++)k=h[a],k.geometry&&!1===k.geometry instanceof x&&(k.geometry.type=c,void 0===k.geometry.spatialReference&&(k.geometry.spatialReference=l));g={outFields:["*"],source:g,fields:f,objectIdField:e,spatialReference:b};g.geometryType=c?c:"point";g=new y(g);return new d({layer:g,spatialReference:b,isTable:null===c||""===c})};d.prototype.queryAttachments=function(){return l.resolve([])};d.prototype.getFeatureByObjectId=
function(a){var b=new p;b.where=this.objectIdField+"\x3d"+a.toString();return this._layer.queryFeatures(b).then(function(a){return 1===a.features.length?a.features[0]:null})};return d}(v)});