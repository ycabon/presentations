// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../tsSupport/extendsHelper ../../arrayUtils ../../PooledArray ../quickselect/quickselect".split(" "),function(A,u,B,C,m,J){function p(a,b){r(a,0,a.children.length,b,a)}function r(a,b,c,d,e){e||(e=new v(null));e.minX=Infinity;e.minY=Infinity;e.maxX=-Infinity;e.maxY=-Infinity;for(var h=void 0;b<c;b++)h=a.children[b],t(e,a.leaf?d(h):h);return e}function t(a,b){a.minX=Math.min(a.minX,b.minX);a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,
b.maxY)}function G(a,b){return a.minX-b.minX}function H(a,b){return a.minY-b.minY}function D(a){return(a.maxX-a.minX)*(a.maxY-a.minY)}function w(a){return a.maxX-a.minX+(a.maxY-a.minY)}function E(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY}function x(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY}function I(a,b,c,d,e){for(var h=[b,c];h.length;)if(c=h.pop(),b=h.pop(),!(c-b<=d)){var f=b+Math.ceil((c-b)/d/2)*d;J(a,f,b,c,e);h.push(b,f,f,c)}}Object.defineProperty(u,
"__esModule",{value:!0});A=function(){function a(b,c){void 0===b&&(b=9);this.compareMinX=G;this.compareMinY=H;this.toBBox=function(b){return b};this._maxEntries=Math.max(4,b||9);this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries));c&&("function"===typeof c?this.toBBox=c:this._initFormat(c));this.clear()}a.prototype.destroy=function(){this.clear();n.prune();y.prune();g.prune();z.prune()};a.prototype.all=function(b){this._all(this.data,b)};a.prototype.search=function(b,c){var d=this.data,a=this.toBBox;
if(x(b,d))for(n.clear();d;){for(var h=0,f=d.children.length;h<f;h++){var k=d.children[h],l=d.leaf?a(k):k;x(b,l)&&(d.leaf?c(k):E(b,l)?this._all(k,c):n.push(k))}d=n.pop()}};a.prototype.collides=function(b){var c=this.data,d=this.toBBox;if(!x(b,c))return!1;for(n.clear();c;){for(var a=0,h=c.children.length;a<h;a++){var f=c.children[a],k=c.leaf?d(f):f;if(x(b,k)){if(c.leaf||E(b,k))return!0;n.push(f)}}c=n.pop()}return!1};a.prototype.load=function(b,c){void 0===c&&(c=b.length);if(!c)return this;if(c<this._minEntries){for(var a=
0;a<c;a++)this.insert(b[a]);return this}b=this._build(b.slice(0,c),0,c-1,0);this.data.children.length?this.data.height===b.height?this._splitRoot(this.data,b):(this.data.height<b.height&&(a=this.data,this.data=b,b=a),this._insert(b,this.data.height-b.height-1,!0)):this.data=b;return this};a.prototype.insert=function(b){b&&this._insert(b,this.data.height-1);return this};a.prototype.clear=function(){this.data=new v([]);return this};a.prototype.remove=function(b){if(!b)return this;var c=this.data,a,
e,h,f,k=this.toBBox(b);g.clear();for(z.clear();c||g.length;){c||(c=g.pop(),a=g.data[g.length-1],e=z.pop(),h=!0);if(c.leaf&&(f=C.indexOf(c.children,b,c.children.length,c.indexHint),-1!==f)){c.children.splice(f,1);g.push(c);this._condense(g);break}h||c.leaf||!E(c,k)?a?(e++,c=a.children[e],h=!1):c=null:(g.push(c),z.push(e),e=0,a=c,c=c.children[0])}return this};a.prototype.toJSON=function(){return this.data};a.prototype.fromJSON=function(b){this.data=b;return this};a.prototype._all=function(b,c){for(y.clear();b;){if(!0===
b.leaf){var a=0;for(b=b.children;a<b.length;a++)c(b[a])}else y.pushArray(b.children);b=y.pop()}};a.prototype._build=function(b,c,a,e){var d=a-c+1,f=this._maxEntries;if(d<=f)return b=new v(b.slice(c,a+1)),p(b,this.toBBox),b;e||(e=Math.ceil(Math.log(d)/Math.log(f)),f=Math.ceil(d/Math.pow(f,e-1)));var k=new F([]);k.height=e;d=Math.ceil(d/f);f=d*Math.ceil(Math.sqrt(f));for(I(b,c,a,f,this.compareMinX);c<=a;c+=f){var l=Math.min(c+f-1,a);I(b,c,l,d,this.compareMinY);for(var q=c;q<=l;q+=d)k.children.push(this._build(b,
q,Math.min(q+d-1,l),e-1))}p(k,this.toBBox);return k};a.prototype._chooseSubtree=function(b,c,a,e){for(;;){e.push(c);if(!0===c.leaf||e.length-1===a)break;for(var d=Infinity,f=Infinity,k=void 0,l=0,q=c.children.length;l<q;l++){var g=c.children[l],m=D(g),n=(Math.max(g.maxX,b.maxX)-Math.min(g.minX,b.minX))*(Math.max(g.maxY,b.maxY)-Math.min(g.minY,b.minY))-m;n<f?(f=n,d=m<d?m:d,k=g):n===f&&m<d&&(d=m,k=g)}c=k||c.children[0]}return c};a.prototype._insert=function(b,c,a){var d=this.toBBox;a=a?b:d(b);g.clear();
d=this._chooseSubtree(a,this.data,c,g);d.children.push(b);for(t(d,a);0<=c;)if(g.data[c].children.length>this._maxEntries)this._split(g,c),c--;else break;this._adjustParentBBoxes(a,g,c)};a.prototype._split=function(b,c){var a=b.data[c],e=a.children.length,h=this._minEntries;this._chooseSplitAxis(a,h,e);e=this._chooseSplitIndex(a,h,e);e=a.children.splice(e,a.children.length-e);e=a.leaf?new v(e):new F(e);e.height=a.height;p(a,this.toBBox);p(e,this.toBBox);c?b.data[c-1].children.push(e):this._splitRoot(a,
e)};a.prototype._splitRoot=function(b,a){this.data=new F([b,a]);this.data.height=b.height+1;p(this.data,this.toBBox)};a.prototype._chooseSplitIndex=function(b,a,d){var c,h,f;c=h=Infinity;for(var k=a;k<=d-a;k++){var l=r(b,0,k,this.toBBox),g=r(b,k,d,this.toBBox),m;m=Math.max(0,Math.min(l.maxX,g.maxX)-Math.max(l.minX,g.minX))*Math.max(0,Math.min(l.maxY,g.maxY)-Math.max(l.minY,g.minY));l=D(l)+D(g);m<c?(c=m,f=k,h=l<h?l:h):m===c&&l<h&&(h=l,f=k)}return f};a.prototype._chooseSplitAxis=function(b,a,d){var c=
b.leaf?this.compareMinX:G,h=b.leaf?this.compareMinY:H,f=this._allDistMargin(b,a,d,c);a=this._allDistMargin(b,a,d,h);f<a&&b.children.sort(c)};a.prototype._allDistMargin=function(b,a,d,e){b.children.sort(e);e=this.toBBox;for(var c=r(b,0,a,e),f=r(b,d-a,d,e),k=w(c)+w(f),l=a;l<d-a;l++){var g=b.children[l];t(c,b.leaf?e(g):g);k+=w(c)}for(l=d-a-1;l>=a;l--)g=b.children[l],t(f,b.leaf?e(g):g),k+=w(f);return k};a.prototype._adjustParentBBoxes=function(b,a,d){for(;0<=d;d--)t(a.data[d],b)};a.prototype._condense=
function(b){for(var a=b.length-1;0<=a;a--){var d=b.data[a];if(0===d.children.length)if(0<a){var e=b.data[a-1],g=e.children;g.splice(C.indexOf(g,d,g.length,e.indexHint),1)}else this.clear();else p(d,this.toBBox)}};a.prototype._initFormat=function(a){var b=["return a"," - b",";"];this.compareMinX=new Function("a","b",b.join(a[0]));this.compareMinY=new Function("a","b",b.join(a[1]));this.toBBox=new Function("a","return {minX: a"+a[0]+", minY: a"+a[1]+", maxX: a"+a[2]+", maxY: a"+a[3]+"};")};return a}();
u.PooledRBush=A;var n=new m,y=new m,g=new m,z=new m({deallocator:null});m=function(){return function(){this.minY=this.minX=Infinity;this.maxY=this.maxX=-Infinity}}();u.BBox=m;m=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;b.height=1;b.indexHint=new C.PositionHint;return b}B(b,a);return b}(m);var v=function(a){function b(b){var c=a.call(this)||this;c.children=b;c.leaf=!0;return c}B(b,a);return b}(m),F=function(a){function b(b){var c=a.call(this)||this;c.children=b;c.leaf=
!1;return c}B(b,a);return b}(m);u.default=A});