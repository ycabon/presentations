// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../tsSupport/assignHelper ../tsSupport/generatorHelper ../tsSupport/awaiterHelper dojo/_base/kernel ../../config ../has ../Logger ../promiseUtils ./loaderConfig ./utils ./WorkerFallback".split(" "),function(C,q,k,r,t,w,d,b,x,y,u,l,e){function v(a){return t(this,void 0,void 0,function(){return r(this,function(g){return[2,y.create(function(g){function m(h){if(h=l.receiveMessage(h))switch(h.type){case z:h=a;var e=d.workers.loaderUrl||u.DEFAULT_LOADER_URL,f;null!=d["default"]?
(f=k({},d),delete f["default"],f=JSON.parse(JSON.stringify(f))):f=JSON.parse(JSON.stringify(d));var c=d.workers.loaderConfig,c=u.default({baseUrl:c.baseUrl,locale:w.locale,has:k({"config-deferredInstrumentation":0,"csp-restrictions":b("csp-restrictions"),"dojo-test-sniff":0,"esri-native-promise":b("esri-native-promise"),"esri-secure-context":b("esri-secure-context"),"esri-workers-arraybuffer-transfer":b("esri-workers-arraybuffer-transfer"),"events-keypress-typed":0,"host-webworker":1,"esri-webgl-texture-float":b("esri-webgl-texture-float"),
"esri-shared-array-buffer":b("esri-shared-array-buffer"),"esri-atomics":b("esri-atomics"),"esri-2d-debug":0,"esri-webgl-max-texture-size":b("esri-webgl-max-texture-size")},c.has),map:k({},c.map),paths:k({},c.paths),packages:c.packages||[]});h.postMessage({type:A,configure:{esriConfig:f,loaderUrl:e,loaderConfig:c}});break;case B:a.removeEventListener("message",m),a.removeEventListener("error",n),g(a)}}function n(b){b.preventDefault();a.removeEventListener("message",m);a.removeEventListener("error",
n);p.warn("Failed to create Worker. Fallback to execute module in main thread",b);a=new e;a.addEventListener("message",m);a.addEventListener("error",n)}a.addEventListener("message",m);a.addEventListener("error",n)})]})})}Object.defineProperty(q,"__esModule",{value:!0});var p=x.getLogger("esri.core.workers");b.add("esri-workers-arraybuffer-transfer",!b("safari")||12<=b("safari"));var B=l.MessageType.CONFIGURED,A=l.MessageType.CONFIGURE,z=l.MessageType.HANDSHAKE,g;try{g=URL.createObjectURL(new Blob(['var globalId\x3d0,outgoing\x3dnew Map,configured\x3d!1,HANDSHAKE\x3d0,CONFIGURE\x3d1,CONFIGURED\x3d2,OPEN\x3d3,OPENED\x3d4,RESPONSE\x3d5,INVOKE\x3d6,ABORT\x3d7;function createAbortError(){var error\x3dnew Error("AbortError");return error.dojoType\x3d"cancel",error}function receiveMessage(event){return event\x26\x26event.data?"string"\x3d\x3dtypeof event.data?JSON.parse(event.data):event.data:null}function invokeStaticMessage(methodName,data,options){var signal\x3doptions\x26\x26options.signal,Deferred\x3drequire("dojo/Deferred"),jobId\x3dglobalId++,abort\x3dfunction(){var outJob\x3doutgoing.get(jobId);outJob\x26\x26(outgoing.delete(jobId),self.postMessage({type:ABORT,jobId:jobId}),outJob.reject(createAbortError()))},deferred\x3dnew Deferred(abort);if(signal){if(signal.aborted)return deferred.reject(createAbortError());signal.addEventListener("abort",(function(){abort(),deferred.reject(createAbortError())}))}return outgoing.set(jobId,deferred),self.postMessage({type:INVOKE,jobId:jobId,methodName:methodName,abortable:!0,data:data}),deferred.promise}function messageHandler(event){var message\x3dreceiveMessage(event);if(message){var jobId\x3dmessage.jobId;switch(message.type){case CONFIGURE:var configuration\x3dmessage.configure;if(configured)return;self.dojoConfig\x3dconfiguration.loaderConfig,self.importScripts(configuration.loaderUrl),"function"\x3d\x3dtypeof require.config\x26\x26require.config(configuration.loaderConfig),require(["esri/config"],(function(esriConfig){for(var name in configuration.esriConfig)Object.prototype.hasOwnProperty.call(configuration.esriConfig,name)\x26\x26(esriConfig[name]\x3dconfiguration.esriConfig[name]);self.postMessage({type:CONFIGURED})})),configured\x3d!0;break;case OPEN:var modulePath\x3dmessage.modulePath;require(["esri/core/workers/RemoteClient"],(function(RemoteClient){RemoteClient.loadWorker(modulePath).then((function(Module){return Module||new Promise((function(resolve){require([modulePath],resolve)}))})).then((function(Module){var port\x3dRemoteClient.connect(Module);self.postMessage({type:OPENED,jobId:jobId,data:port},[port])}))}));break;case RESPONSE:if(outgoing.has(jobId)){var deferred\x3doutgoing.get(jobId);outgoing.delete(jobId),message.error?deferred.reject(JSON.parse(message.error)):deferred.resolve(message.data)}}}}self.addEventListener("message",messageHandler),self.postMessage({type:HANDSHAKE});'],
{type:"text/javascript"}))}catch(a){}q.createWorker=function(){return t(this,void 0,void 0,function(){var a;return r(this,function(d){if(!b("esri-workers"))return[2,v(new e)];if(g)try{a=new Worker(g)}catch(D){p.warn("Failed to create Worker. Fallback to execute module in main thread",event),a=new e}else p.warn("Failed to create Worker. Fallback to execute module in main thread",event),a=new e;return[2,v(a)]})})}});