// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],function(D,E,G,H,I){Object.defineProperty(E,"__esModule",{value:!0});D=function(){function g(d){this._pool=new G.default(8024);this._nodes=0;this._root=new F(0,0,0);this._fields=d}g.prototype._acquire=function(d,c,e){var f=this._pool.dequeue();this._nodes++;return H.isSome(f)?f.realloc(d,c,e):new F(d,c,e)};g.prototype._release=function(d){this._nodes--;this._pool.enqueue(d)};Object.defineProperty(g.prototype,"count",
{get:function(){return this._root.count},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"size",{get:function(){return this._nodes},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"poolSize",{get:function(){return this._pool.size},enumerable:!0,configurable:!0});Object.defineProperty(g.prototype,"depth",{get:function(){var d=0;this._forEachNode(function(c){return d=Math.max(d,c.depth)});return d},enumerable:!0,configurable:!0});g.prototype.dropLevels=function(d){var c=
this;this._forEachNode(function(e){if(e.depth>=d)for(var f=0;f<e.children.length;f++){var n=e.children[f];e.children[f]=null;n&&c._release(n)}})};g.prototype.insert=function(d,c,e){void 0===e&&(e=0);for(var f=this._root,n=0,a=0,b=0;null!==f;){f.depth>=e&&(f.count+=1,f.xTotal+=d.geometry.coords[0],f.yTotal+=d.geometry.coords[1],f.xGeohashTotal+=d.geohashX,f.yGeohashTotal+=d.geohashY,this._updateStatistics(d,f,1));if(n>=c)break;var h=Math.ceil((n+1)/2),m=Math.floor((n+1)/2),l=1-n%2,k=30-(3*h+2*m),h=
30-(2*h+3*m),k=(d.geohashX&7*l+3*(1-l)<<k)>>k,h=(d.geohashY&3*l+7*(1-l)<<h)>>h,m=k+h*(8*l+4*(1-l)),g=2*l+3*(1-l),a=a<<3*l+2*(1-l)|k,b=b<<g|h;null==f.children[m]&&(f.children[m]=this._acquire(a,b,n+1));n+=1;f=f.children[m]}};g.prototype.remove=function(d,c){for(var e=this._root,f=0;null!==e;){--e.count;e.xTotal-=d.geometry.coords[0];e.yTotal-=d.geometry.coords[1];e.xGeohashTotal-=d.geohashX;e.yGeohashTotal-=d.geohashY;this._updateStatistics(d,e,-1);if(f>=c)break;var n=Math.ceil((f+1)/2),a=Math.floor((f+
1)/2),b=1-f%2,h=30-(3*n+2*a),n=30-(2*n+3*a),b=((d.geohashX&7*b+3*(1-b)<<h)>>h)+((d.geohashY&3*b+7*(1-b)<<n)>>n)*(8*b+4*(1-b)),h=e.children[b];1===h.count&&(this._release(h),e.children[b]=null);f+=1;e=h}};g.prototype.find=function(d,c,e){return this._root.find(d,c,e,0,0,0)};g.prototype.findSingleOccupancyNode=function(d,c,e,f,n){for(var a=this._root;null!==a;){var b=a.depth,h=a.xNode,m=a.yNode,l=1-b%2,k=a.xGeohashTotal/a.count,g=a.yGeohashTotal/a.count;if(1===a.count&&d<k&&k<=e&&c<g&&g<=f)return a;
if(b>=n)a=a.next;else{for(var k=Math.ceil((b+1)/2),b=Math.floor((b+1)/2),t=30-(3*k+2*b),k=30-(2*k+3*b),p=~((1<<t)-1),g=~((1<<k)-1),h=h<<3*l+2*(1-l),m=m<<2*l+3*(1-l),b=Math.max(h,(d&p)>>t),t=Math.min(h+8*l+4*(1-l),(e&p)>>t),p=Math.min(m+4*l+8*(1-l),(f&g)>>k),q=null,v=null,k=Math.max(m,(c&g)>>k);k<=p;k++)for(g=b;g<=t;g++){var u=a.children[g-h+(k-m)*(8*l+4*(1-l))];u&&(q||(q=u,q.next=a.next),v&&(v.next=u),v=u,u.next=a.next)}a=q||a.next}}return null};g.prototype.getRegionStatistics=function(d,c,e,f,n){for(var a=
this._root,b=0,h=0,g=0,l={};null!==a;){var k=a.depth,x=a.xNode,t=a.yNode;if(k>=n){var p=a.xGeohashTotal/a.count,q=a.yGeohashTotal/a.count;d<p&&p<=e&&c<q&&q<=f&&(b+=a.count,h+=a.xTotal,g+=a.yTotal,this._aggregateStatistics(l,a.statistics));a=a.next}else{for(var v=Math.ceil((k+1)/2),u=Math.floor((k+1)/2),k=1-k%2,w=30-(3*v+2*u),p=30-(2*v+3*u),y=~((1<<w)-1),q=~((1<<p)-1),x=x<<3*k+2*(1-k),t=t<<2*k+3*(1-k),v=Math.max(x,(d&y)>>w),u=Math.max(t,(c&q)>>p),w=Math.min(x+8*k+4*(1-k),(e&y)>>w),y=Math.min(t+4*k+
8*(1-k),(f&q)>>p),B=null,C=null,z=u;z<=y;z++)for(var A=v;A<=w;A++){var r=a.children[A-x+(z-t)*(8*k+4*(1-k))];r&&(z!==u&&z!==y&&A!==v&&A!==w?(p=r.xGeohashTotal/r.count,q=r.yGeohashTotal/r.count,d<p&&p<=e&&c<q&&q<=f&&(b+=r.count,h+=r.xTotal,g+=r.yTotal,this._aggregateStatistics(l,r.statistics))):(B||(B=r,B.next=a.next),C&&(C.next=r),C=r,r.next=a.next))}a=B||a.next}}d=this._normalizeStatistics(l,b);return{count:b,attributes:d,xTotal:h,yTotal:g}};g.prototype._forEachNode=function(d){for(var c=this._root;null!==
c;){var e=this._linkChildren(c)||c.next;d(c);c=e}};g.prototype._linkChildren=function(d){for(var c=null,e=null,f=0;f<=d.children.length;f++){var g=d.children[f];g&&(c||(c=g,c.next=d.next),e&&(e.next=g),e=g,g.next=d.next)}return c};g.prototype._updateStatistics=function(d,c,e){for(var f=0,g=this._fields;f<g.length;f++){var a=g[f],b=a.name,h=d.attributes[a.outStatistic.onStatisticField];switch(a.outStatistic.statisticType){case "norm":c.statistics[b]||(c.statistics[b]={});var a=d.attributes[a.outStatistic.onStatisticNormalizationField],
m=c.statistics[b].onStatisticField||0,l=c.statistics[b].onStatisticNormalizationField||0;null==h||isNaN(h)||null==a||0===a||isNaN(a)||(c.statistics[b].onStatisticField=m+e*h,c.statistics[b].onStatisticNormalizationField=l+e*a);break;case "avg":c.statistics[b]||(c.statistics[b]={value:0,nanCount:0});m=c.statistics[b].value;a=c.statistics[b].nanCount;null==h||isNaN(h)?c.statistics[b].nanCount=a+e:c.statistics[b].value=m+e*h;break;case "avg_angle":c.statistics[b]||(c.statistics[b]={x:0,y:0,nanCount:0});
var m=c.statistics[b].x,l=c.statistics[b].y,a=c.statistics[b].nanCount,k=Math.PI/180;null==h||isNaN(h)?c.statistics[b].nanCount=a+e:(c.statistics[b].x=m+e*Math.cos(h*k),c.statistics[b].y=l+e*Math.sin(h*k));break;case "mode":c.statistics[b]||(c.statistics[b]={}),m=c.statistics[b][h]||0,c.statistics[b][h]=m+e}}};g.prototype._aggregateStatistics=function(d,c){for(var e=0,f=this._fields;e<f.length;e++){var g=f[e],a=g.name;switch(g.outStatistic.statisticType){case "avg":case "avg_angle":case "mode":case "norm":d[a]||
(d[a]={});for(var b in c[a])d[a][b]=(d[a][b]||0)+c[a][b]}}};g.prototype._normalizeStatistics=function(d,c){for(var e={},f=0,g=this._fields;f<g.length;f++){var a=g[f],b=a.name;switch(a.outStatistic.statisticType){case "norm":a=d[b];if(c&&null==a.onStatisticNormalizationField)break;if(c&&a.onStatisticNormalizationField){e[b]=a.onStatisticField/a.onStatisticNormalizationField;break}e[b]=0;break;case "avg":if(!c)break;var h=d[b],a=h.nanCount;if(!(c-a))break;e[b]=h.value/(c-a);break;case "avg_angle":if(!c)break;
var a=d[b],h=a.x,m=a.y,a=a.nanCount;if(!(c-a))break;e[b]=180/Math.PI*Math.atan2(m/(c-a),h/(c-a));break;case "mode":var a=d[b],h=0,m=null,l;for(l in a){var k=a[l];k>h&&(h=k,m=l)}e[b]="null"===m?null:m}}return e};return g}();E.GeohashTree=D;var F=function(){function g(d,c,e){this.yTotal=this.xTotal=this.count=0;this.statistics={};this.next=null;this.yGeohashTotal=this.xGeohashTotal=this.yNode=this.xNode=this.depth=0;this.children=Array(32);for(var f=0;f<this.children.length;f++)this.children[f]=null;
this.xNode=d;this.yNode=c;this.depth=e}g.prototype.realloc=function(d,c,e){for(var f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=d;this.yNode=c;this.depth=e;this.next=null;this.count=this.yTotal=this.xTotal=this.yGeohashTotal=this.xGeohashTotal=0;this.statistics={};return this};g.prototype.getLngLatBounds=function(){var d=this.depth,c=Math.ceil(d/2),d=Math.floor(d/2);return I.decodeGeohashXY({geohashX:this.xNode<<30-(3*c+2*d),geohashY:this.yNode<<30-(2*c+3*d)},this.depth)};g.prototype.find=
function(d,c,e,f,g,a){if(f>=e)return this;var b=1-f%2,h=3*b+2*(1-b),m=2*b+3*(1-b),l=30-g-h,k=30-a-m,b=this.children[((d&7*b+3*(1-b)<<l)>>l)+((c&3*b+7*(1-b)<<k)>>k)*(8*b+4*(1-b))];return null==b?null:b.find(d,c,e,f+1,g+h,a+m)};return g}()});