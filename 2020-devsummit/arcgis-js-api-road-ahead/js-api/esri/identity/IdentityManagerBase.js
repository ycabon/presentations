// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../config ../kernel ../request ../core/cookie ../core/Error ../core/Evented ../core/global ../core/lang ../core/object ../core/promiseUtils ../core/string ../core/urlUtils ../core/urlUtils ../core/accessorSupport/decorators ./IdentityForm ./IdentityModal ./OAuthCredential ./OAuthInfo ./ServerInfo".split(" "),function(I,E,J,K,t,F,m,z,L,p,M,U,A,C,v,N,u,y,r,V,O,P,Q,G){Object.defineProperty(E,
"__esModule",{value:!0});var D={},R=function(m){var c=(new y.Url(m.owningSystemUrl)).host;m=(new y.Url(m.server)).host;var a=/.+\.arcgis\.com$/i;return a.test(c)&&a.test(m)},H=function(m,c){return!!(R(m)&&c&&c.some(function(a){return a.test(m.server)}))};I=function(m){function c(){var a=m.call(this)||this;a._portalConfig=U.esriGeowConfig;a.serverInfos=[];a.oAuthInfos=[];a.credentials=[];a._soReqs=[];a._xoReqs=[];a._portals=[];a.defaultOAuthInfo=null;a.defaultTokenValidity=60;a.dialog=null;a.formConstructor=
V;a.tokenValidity=null;a.signInPage=null;a.useSignInPage=!0;a.normalizeWebTierAuth=!1;a._busy=null;a._rejectOnPersistedPageShow=!1;a._oAuthHash=null;a._gwTokenUrl="/sharing/rest/generateToken";a._agsRest="/rest/services";a._agsPortal=/\/sharing(\/|$)/i;a._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i;a._adminSvcs=/\/rest\/admin\/services(\/|$)/i;a._agolSuffix=".arcgis.com";a._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},
{regex:/^https?:\/\/(?:dev|\w+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|\w+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|\w+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/\w+\.maps\.arcgis\.com/i,
customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}];a._legacyFed=[];a._regexSDirUrl=/http.+\/rest\/services\/?/gi;a._regexServerType=/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer|GeoenrichmentServer|VectorTileServer|SceneServer)).*/gi;a._gwUser=/http.+\/users\/([^\/]+)\/?.*/i;a._gwItem=/http.+\/items\/([^\/]+)\/?.*/i;a._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i;a._rePortalTokenSvc=
/\/sharing(\/rest)?\/generatetoken/i;a._createDefaultOAuthInfo=!0;a._hasTestedIfAppIsOnPortal=!1;a._getOAuthHash();window.addEventListener("pageshow",function(b){a._pageShowHandler(b)});return a}K(c,m);c.prototype.registerServers=function(a){var b=this,d=this.serverInfos;d?(a=a.filter(function(a){return!b.findServerInfo(a.server)}),this.serverInfos=d.concat(a)):this.serverInfos=a;a.forEach(function(a){a.owningSystemUrl&&b._portals.push(a.owningSystemUrl);a.hasPortal&&b._portals.push(a.server)})};
c.prototype.registerOAuthInfos=function(a){var b=this,d=this.oAuthInfos;d?(a=a.filter(function(a){return!b.findOAuthInfo(a.portalUrl)}),this.oAuthInfos=d.concat(a)):this.oAuthInfos=a};c.prototype.registerToken=function(a){a=J({},a);var b=this._sanitizeUrl(a.server),d=this._isServerRsrc(b),e=this.findServerInfo(b),f=!0,g;e||(e=new G,e.server=this._getServerInstanceRoot(b),d?e.hasServer=!0:(e.tokenServiceUrl=this._getTokenSvcUrl(b),e.hasPortal=!0),this.registerServers([e]));(g=this._findCredential(b))?
(delete a.server,A.mixin(g,a),f=!1):(g=new w({userId:a.userId,server:e.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:d?"server":"portal"}),g.resources=[b],this.credentials.push(g));g.emitTokenChange(!1);f||g.refreshServerTokens()};c.prototype.toJSON=function(){return A.fixJson({serverInfos:this.serverInfos.map(function(a){return a.toJSON()}),oAuthInfos:this.oAuthInfos.map(function(a){return a.toJSON()}),credentials:this.credentials.map(function(a){return a.toJSON()})})};c.prototype.initialize=
function(a){var b=this;if(a){"string"===typeof a&&(a=JSON.parse(a));var d=a.serverInfos,e=a.oAuthInfos;a=a.credentials;if(d){var f=[];d.forEach(function(a){a.server&&a.tokenServiceUrl&&f.push(a.declaredClass?a:new G(a))});f.length&&this.registerServers(f)}if(e){var g=[];e.forEach(function(a){a.appId&&g.push(a.declaredClass?a:new Q(a))});g.length&&this.registerOAuthInfos(g)}a&&a.forEach(function(a){a.server&&a.token&&a.expires&&a.expires>Date.now()&&(a=a.declaredClass?a:new w(a),a.emitTokenChange(),
b.credentials.push(a))})}};c.prototype.findServerInfo=function(a){var b;a=this._sanitizeUrl(a);for(var d=0,e=this.serverInfos;d<e.length;d++){var f=e[d];if(this._hasSameServerInstance(f.server,a)){b=f;break}}return b};c.prototype.findOAuthInfo=function(a){var b;a=this._sanitizeUrl(a);for(var d=0,e=this.oAuthInfos;d<e.length;d++){var f=e[d];if(this._hasSameServerInstance(f.portalUrl,a)){b=f;break}}return b};c.prototype.findCredential=function(a,b){var d,e;a=this._sanitizeUrl(a);e=this._isServerRsrc(a)?
"server":"portal";if(b)for(var f=0,g=this.credentials;f<g.length;f++){var c=g[f];if(this._hasSameServerInstance(c.server,a)&&b===c.userId&&c.scope===e){d=c;break}}else for(b=0,f=this.credentials;b<f.length;b++)if(c=f[b],this._hasSameServerInstance(c.server,a)&&-1!==this._getIdenticalSvcIdx(a,c)&&c.scope===e){d=c;break}return d};c.prototype.getCredential=function(a,b){var d,e,f=!0;b&&(d=!!b.token,e=b.error,f=!1!==b.prompt);b=J({},b);a=this._sanitizeUrl(a);var g=v.createAbortController(),c=v.createResolver(function(){g.abort()});
if(b.signal)v.onAbort(b.signal,function(){g.abort()});v.onAbort(g,function(){c.reject(new p("identity-manager:user-aborted","ABORTED"))});if(v.isAborted(g))return c.promise;b.signal=g.signal;var l=this._isAdminResource(a),n=d&&this._doPortalSignIn(a)?this._getEsriAuthCookie():null;if((d=d?this.findCredential(a):null)&&e&&e.details&&498===e.details.httpStatus)d.destroy(),n&&n.token===b.token&&(L.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain}),N.endsWith(window.location.hostname,
".arcgis.com")&&L.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:"arcgis.com"}));else if(n||d)return a=new p("identity-manager:not-authorized","You are currently signed in as: '"+(n&&n.email||d&&d.userId)+"'. You do not have access to this resource: "+a,{error:e}),c.reject(a),c.promise;if(e=this._findCredential(a,b))return c.resolve(e),c.promise;e=this.findServerInfo(a);if(e)!e.hasServer&&this._isServerRsrc(a)&&(e._restInfoPms=this._getTokenSvcUrl(a),e.hasServer=!0);else{n=this._getTokenSvcUrl(a);
if(!n)return a=new p("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),c.reject(a),c.promise;e=new G;e.server=this._getServerInstanceRoot(a);"string"===typeof n?(e.tokenServiceUrl=n,e.hasPortal=!0):(e._restInfoPms=n,e.hasServer=!0);this.registerServers([e])}f&&e.hasPortal&&void 0===e._selfReq&&!this._findOAuthInfo(a)&&(e._selfReq={owningTenant:b&&b.owningTenant,selfDfd:this._getPortalSelf(e.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),
a)});return this._enqueue(a,e,b,c,l)};c.prototype.getResourceName=function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""};c.prototype.generateToken=function(a,b,d){var e=this._rePortalTokenSvc.test(a.tokenServiceUrl),f=new y.Url(window.location.href.toLowerCase()),c=this._getEsriAuthCookie(),
h=a.shortLivedTokenValidity,l,n,k,q,x,S,T,B;b&&(B=this.tokenValidity||h||this.defaultTokenValidity,B>h&&0<h&&(B=h));d&&(n=d.isAdmin,k=d.serverUrl,q=d.token,S=d.signal,T=d.ssl,a.customParameters=d.customParameters);n?h=a.adminTokenServiceUrl:(h=a.tokenServiceUrl,x=new y.Url(h.toLowerCase()),c&&(l=(l=c.auth_tier)&&l.toLowerCase()),("web"===l||a.webTierAuth)&&d&&d.serverUrl&&!T&&"http"===f.scheme&&(u.hasSameOrigin(f.uri,h,!0)||"https"===x.scheme&&f.host===x.host&&"7080"===f.port&&"7443"===x.port)&&(h=
h.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));d=A.mixin({query:A.mixin({request:"getToken",username:b&&b.username,password:b&&b.password,serverUrl:k,token:q,expiration:B,referer:n||e?window.location.host:null,client:n?"referer":null,f:"json"},a.customParameters),method:"post",authMode:"anonymous",useProxy:this._useProxy(a,d),signal:S},d&&d.ioArgs);e||(d.withCredentials=!1);return z(h,d).then(function(d){d=d.data;if(!d||!d.token)return new p("identity-manager:authentication-failed","Unable to generate token");
var e=a.server;D[e]||(D[e]={});b&&(D[e][b.username]=b.password);d.validity=B;return d})};c.prototype.isBusy=function(){return!!this._busy};c.prototype.checkSignInStatus=function(a){return this.checkAppAccess(a,"").then(function(a){return a.credential})};c.prototype.checkAppAccess=function(a,b,d){var e=this,f=!1;return this.getCredential(a,{prompt:!1}).then(function(c){var g,l={f:"json"};if("portal"===c.scope)if(b&&(e._doPortalSignIn(a,!0)||d&&d.force))g=c.server+"/sharing/rest/oauth2/validateAppAccess",
l.client_id=b;else if(c.token)g=c.server+"/sharing/rest";else return{credential:c};else if(c.token)g=c.server+"/rest/services";else return{credential:c};c.token&&(l.token=c.token);return z(g,{query:l,authMode:"anonymous"}).then(function(a){if(!1===a.data.valid)throw new p("identity-manager:not-authorized","You are currently signed in as: '"+c.userId+"'.");f=!!a.data.viewOnlyUserTypeApp;return{credential:c}}).catch(function(a){if("identity-manager:not-authorized"===a.name)throw a;a=a.details&&a.details.httpStatus;
if(498===a)throw c.destroy(),new p("identity-manager:not-authenticated","User is not signed in.");if(400===a)throw new p("identity-manager:invalid-request");return{credential:c}})}).then(function(a){return{credential:a.credential,viewOnly:f}})};c.prototype.setOAuthResponseHash=function(a){var b=this._oAuthDfd;this._oAuthDfd=null;if(b&&a)if(clearInterval(this._oAuthIntervalId),"#"===a.charAt(0)&&(a=a.substring(1)),a=u.queryToObject(a),a.error){var d="access_denied"===a.error;a=new p(d?"identity-manager:user-aborted":
"identity-manager:authentication-failed",d?"ABORTED":"OAuth: "+a.error+" - "+a.error_description);b.reject(a)}else{var d=b.oinfo_._oAuthCred,e=new w({userId:a.username,server:b.sinfo_.server,token:a.access_token,expires:Date.now()+1E3*Number(a.expires_in),ssl:"true"===a.ssl,_oAuthCred:d});d.storage=a.persist?window.localStorage:window.sessionStorage;d.token=e.token;d.expires=e.expires;d.userId=e.userId;d.ssl=e.ssl;d.save();b.resolve(e)}};c.prototype.setRedirectionHandler=function(a){this._redirectFunc=
a};c.prototype.setOAuthRedirectionHandler=function(a){this._oAuthRedirectFunc=a};c.prototype.setProtocolErrorHandler=function(a){this._protocolFunc=a};c.prototype.signIn=function(a,b,d){var e=this;void 0===d&&(d={});var f=v.createResolver(),c=function(){n&&n.remove();k&&k.remove();l&&l.destroy();e.dialog&&e.dialog.destroy();e.dialog=null},h=function(){c();e._oAuthDfd=null;f.reject(new p("identity-manager:user-aborted","ABORTED"))};if(d.signal)v.onAbort(d.signal,function(){h()});var l=new this.formConstructor;
l.resource=this.getResourceName(a);l.server=b.server;this.dialog=new O;this.dialog.content=l;this.dialog.open=!0;this.emit("dialog-create");var n=l.on("cancel",h),k=l.on("submit",function(a){e.generateToken(b,a,{isAdmin:d.isAdmin,signal:d.signal}).then(function(e){c();e=new w({userId:a.username,server:b.server,token:e.token,expires:null!=e.expires?Number(e.expires):null,ssl:!!e.ssl,isAdmin:d.isAdmin,validity:e.validity});f.resolve(e)}).catch(function(a){l.error=a;l.signingIn=!1})});return f.promise};
c.prototype.oAuthSignIn=function(a,b,d,e){var f=this,c=this._oAuthDfd=v.createResolver();if(e&&e.signal)v.onAbort(e.signal,function(){var a=f._oAuthDfd&&f._oAuthDfd.oAuthWin_;a&&!a.closed?a.close():f.dialog&&l()});c.resUrl_=a;c.sinfo_=b;c.oinfo_=d;e=!e||!1!==e.oAuthPopupConfirmation;if(!d.popup||!e)return this._doOAuthSignIn(a,b,d),c.promise;var h=new this.formConstructor;h.oAuthPrompt=!0;h.server=b.server;this.dialog=new O;this.dialog.content=h;this.dialog.open=!0;this.emit("dialog-create");var l=
function(){q();f._oAuthDfd=null;c.reject(new p("identity-manager:user-aborted","ABORTED"))},n=h.on("cancel",l),k=h.on("submit",function(){q();f._doOAuthSignIn(a,b,d)}),q=function(){n.remove();k.remove();h.destroy();f.dialog.destroy();f.dialog=null};return c.promise};c.prototype.destroyCredentials=function(){this.credentials&&this.credentials.slice().forEach(function(a){a.destroy()});this.emit("credentials-destroy")};c.prototype._getOAuthHash=function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&
(a=a.substring(1));var a=u.queryToObject(a),b=!1;a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username")?(a.state=JSON.parse(a.state),this._oAuthHash=a,b=!0):a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),"access_denied"===a.error&&(b=!0));b&&(window.location.hash="object"===typeof a.state&&a.state.hash||"")}};c.prototype._pageShowHandler=function(a){a.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow&&(a=new p("identity-manager:user-aborted",
"ABORTED"),this._errbackFunc(a))};c.prototype._findCredential=function(a,b){var d=this,e=-1,c,g,h,l=b&&b.token;b=b&&b.resource;var n=this._isServerRsrc(a)?"server":"portal",k=this.credentials.filter(function(b){return d._hasSameServerInstance(b.server,a)&&b.scope===n});a=b||a;if(k.length)if(1===k.length)if(b=k[0],g=(c=(h=this.findServerInfo(b.server))&&h.owningSystemUrl)&&this.findCredential(c,b.userId),e=this._getIdenticalSvcIdx(a,b),l)-1!==e&&(b.resources.splice(e,1),this._removeResource(a,g));
else return-1===e&&b.resources.push(a),this._addResource(a,g),b;else{var q,x;k.some(function(b){x=d._getIdenticalSvcIdx(a,b);return-1!==x?(q=b,g=(c=(h=d.findServerInfo(q.server))&&h.owningSystemUrl)&&d.findCredential(c,q.userId),e=x,!0):!1});if(l)q&&(q.resources.splice(e,1),this._removeResource(a,g));else if(q)return this._addResource(a,g),q}};c.prototype._findOAuthInfo=function(a){var b=this.findOAuthInfo(a);if(!b)for(var d=0,e=this.oAuthInfos;d<e.length;d++){var c=e[d];if(this._isIdProvider(c.portalUrl,
a)){b=c;break}}return b};c.prototype._addResource=function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)};c.prototype._removeResource=function(a,b){var d=-1;b&&(d=this._getIdenticalSvcIdx(a,b),-1<d&&b.resources.splice(d,1))};c.prototype._useProxy=function(a,b){return b&&b.isAdmin&&!u.hasSameOrigin(a.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(a.tokenServiceUrl)&&"10.1"===String(a.currentVersion)&&!u.hasSameOrigin(a.tokenServiceUrl,window.location.href)};c.prototype._getOrigin=
function(a){a=new y.Url(a);return a.scheme+"://"+a.host+(null!=a.port?":"+a.port:"")};c.prototype._getServerInstanceRoot=function(a){var b=a.toLowerCase(),d=b.indexOf(this._agsRest);-1===d&&this._isAdminResource(a)&&(d=this._agsAdmin.test(a)?a.replace(this._agsAdmin,"$1").length:a.search(this._adminSvcs));-1===d&&(d=b.indexOf("/sharing"));-1===d&&"/"===b.substr(-1)&&(d=b.length-1);return-1<d?a.substring(0,d):a};c.prototype._hasSameServerInstance=function(a,b){"/"===a.substr(-1)&&(a=a.slice(0,-1));
a=a.toLowerCase();b=this._getServerInstanceRoot(b).toLowerCase();a=this._normalizeAGOLorgDomain(a);b=this._normalizeAGOLorgDomain(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b};c.prototype._normalizeAGOLorgDomain=function(a){var b=/^https?:\/\/(?:cdn|\w+\.maps)\.arcgis\.com/i,d=/^https?:\/\/(?:cdndev|\w+\.mapsdevext)\.arcgis\.com/i,e=/^https?:\/\/(?:cdnqa|\w+\.mapsqa)\.arcgis\.com/i;b.test(a)?a=a.replace(b,"https://www.arcgis.com"):d.test(a)?a=a.replace(d,"https://devext.arcgis.com"):
e.test(a)&&(a=a.replace(e,"https://qaext.arcgis.com"));return a};c.prototype._sanitizeUrl=function(a){var b=(F.request.proxyUrl||"").toLowerCase(),d=b?a.toLowerCase().indexOf(b+"?"):-1;-1!==d&&(a=a.substring(d+b.length+1));a=u.normalize(a);return u.urlToObject(a).path};c.prototype._isRESTService=function(a){return-1<a.indexOf(this._agsRest)};c.prototype._isAdminResource=function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)};c.prototype._isServerRsrc=function(a){return this._isRESTService(a)||
this._isAdminResource(a)};c.prototype._isIdenticalService=function(a,b){var d;this._isRESTService(a)&&this._isRESTService(b)?(a=this._getSuffix(a).toLowerCase(),b=this._getSuffix(b).toLowerCase(),d=a===b,d||(d=/(.*)\/(MapServer|FeatureServer).*/gi,d=a.replace(d,"$1")===b.replace(d,"$1"))):this._isAdminResource(a)&&this._isAdminResource(b)?d=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(d=!0);return d};c.prototype._isPortalDomain=function(a){var b=this,d=new y.Url(a.toLowerCase()),
e=this._portalConfig,c=d.authority&&-1!==d.authority.indexOf(this._agolSuffix);!c&&e&&(c=this._hasSameServerInstance(this._getServerInstanceRoot(e.restBaseUrl),d.uri));c||F.portalUrl&&(c=u.hasSameOrigin(a,F.portalUrl,!0));c||(c=this._portals.some(function(a){return b._hasSameServerInstance(a,d.uri)}));return c=c||this._agsPortal.test(d.path)};c.prototype._isIdProvider=function(a,b){var d=-1,e=-1;this._gwDomains.forEach(function(c,f){-1===d&&c.regex.test(a)&&(d=f);-1===e&&c.regex.test(b)&&(e=f)});
var c=!1;if(-1<d&&-1<e)if(0===d||4===d){if(0===e||4===e)c=!0}else if(1===d){if(1===e||2===e)c=!0}else 2===d?2===e&&(c=!0):3===d&&3===e&&(c=!0);if(!c){var g=this.findServerInfo(b),h=g&&g.owningSystemUrl;h&&R(g)&&this._isPortalDomain(h)&&this._isIdProvider(a,h)&&(c=!0)}return c};c.prototype._getIdenticalSvcIdx=function(a,b){for(var d=-1,e=0;e<b.resources.length;e++)if(this._isIdenticalService(a,b.resources[e])){d=e;break}return d};c.prototype._getSuffix=function(a){return a.replace(this._regexSDirUrl,
"").replace(this._regexServerType,"$1")};c.prototype._getTokenSvcUrl=function(a){var b=this,d,e;if(this._isRESTService(a)||this._isAdminResource(a))return e=this._getServerInstanceRoot(a),d=e+"/admin/generateToken",a=e+"/rest/info",e=z(a,{query:{f:"json"}}).then(function(a){return a.data}),{adminUrl:d,promise:e};if(this._isPortalDomain(a)){var c="";this._gwDomains.some(function(b){b.regex.test(a)&&(c=b.tokenServiceUrl);return!!c});c||this._portals.some(function(d){b._hasSameServerInstance(d,a)&&(c=
d+b._gwTokenUrl);return!!c});c||(d=a.toLowerCase().indexOf("/sharing"),-1!==d&&(c=a.substring(0,d)+this._gwTokenUrl));c||(c=this._getOrigin(a)+this._gwTokenUrl);c&&(d=(new y.Url(a)).port,/^http:\/\//i.test(a)&&"7080"===d&&(c=c.replace(/:7080/i,":7443")),c=c.replace(/http:/i,"https:"));return c}if(-1!==a.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"};c.prototype._getPortalSelf=function(a,b){var d;this._gwDomains.some(function(b){b.regex.test(a)&&
(d=b.customBaseUrl);return!!d});if(d)return v.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:d,portalMode:"multitenant",supportsOAuth:!0});"https:"===window.location.protocol?a=a.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return z(a,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(function(a){return a.data})};c.prototype._hasPortalSession=function(){return!!this._getEsriAuthCookie()};c.prototype._getEsriAuthCookie=
function(){var a=null;if(navigator.cookieEnabled){for(var b=this._getAllCookies("esri_auth"),d=void 0,e=0;e<b.length;e++){var c=JSON.parse(b[e]);if(c.portalApp){a=c;break}d?d.push(c):d=[c]}if(!a&&d)for(b=0;b<d.length;b++)if(c=d[b],window.location.hostname===c.urlKey+"."+c.customBaseUrl){a=c;break}}a&&(c=null,a.expires&&("number"===typeof a.expires?c=a.expires:"string"===typeof a.expires&&(c=Date.parse(a.expires)),isNaN(c)&&(c=null),a.expires=c),c&&c<Date.now()&&(a=null));return a};c.prototype._getAllCookies=
function(a){var b=[];if(a=document.cookie.match(new RegExp("(?:^|; )"+N.escapeRegExpString(a)+"\x3d([^;]*)","g")))for(var d=0;d<a.length;d++){var c=a[d],f=c.indexOf("\x3d");-1<f&&(c=c.substring(f+1),b.push(decodeURIComponent(c)))}return b};c.prototype._doPortalSignIn=function(a,b){if(navigator.cookieEnabled){var d=this._getEsriAuthCookie(),c=this._portalConfig,f=window.location.href,g=this.findServerInfo(a);if((b||this.useSignInPage)&&(c||this._isPortalDomain(f)||d)&&(g?g.hasPortal||g.owningSystemUrl&&
this._isPortalDomain(g.owningSystemUrl):this._isPortalDomain(a))&&(this._isIdProvider(f,a)||c&&(this._hasSameServerInstance(this._getServerInstanceRoot(c.restBaseUrl),a)||this._isIdProvider(c.restBaseUrl,a))||u.hasSameOrigin(f,a,!0)))return!0}return!1};c.prototype._canUsePortalSignInWorkflow=function(a){return this._doPortalSignIn(a)&&(window===window.top||this._hasPortalSession())};c.prototype._checkProtocol=function(a,b,d,c){var e=!0;c=c?b.adminTokenServiceUrl:b.tokenServiceUrl;0===c.trim().toLowerCase().indexOf("https:")&&
0!==window.location.href.toLowerCase().indexOf("https:")&&u.getProxyRule(c)&&(e=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,serverInfo:b}):!1,e||(a=new p("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."),d(a)));return e};c.prototype._enqueue=function(a,b,d,c,f,g){c||(c=v.createResolver());c.resUrl_=a;c.sinfo_=b;c.options_=d;c.admin_=f;c.refresh_=g;this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?
(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(c)):this._xoReqs.push(c):this._doSignIn(c);return c.promise};c.prototype._doSignIn=function(a){var b=this;this._busy=a;this._rejectOnPersistedPageShow=!1;var c=function(c){var d=a.options_&&a.options_.resource,e=a.resUrl_,k=a.refresh_,f=!1;-1===b.credentials.indexOf(c)&&(k&&-1!==b.credentials.indexOf(k)?(k.userId=c.userId,k.token=c.token,k.expires=c.expires,k.validity=c.validity,k.ssl=c.ssl,k.creationTime=
c.creationTime,f=!0,c=k):b.credentials.push(c));c.resources||(c.resources=[]);c.resources.push(d||e);c.scope=b._isServerRsrc(e)?"server":"portal";c.emitTokenChange();var d=b._soReqs,g={};b._soReqs=[];d.forEach(function(a){if(!b._isIdenticalService(e,a.resUrl_)){var d=b._getSuffix(a.resUrl_);g[d]||(g[d]=!0,c.resources.push(a.resUrl_))}});a.resolve(c);d.forEach(function(a){b._hasSameServerInstance(b._getServerInstanceRoot(e),a.resUrl_)?a.resolve(c):b._soReqs.push(a)});b._busy=a.resUrl_=a.sinfo_=a.refresh_=
null;f||b.emit("credential-create",{credential:c});b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},e=function(c){a.reject(c);b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},f=function(d,f,g,l){var k=a.sinfo_,h=!a.options_||!1!==a.options_.prompt,q=k.hasPortal&&b._findOAuthInfo(a.resUrl_);b._canUsePortalSignInWorkflow(a.resUrl_)?(d=b._getEsriAuthCookie(),q=
b._portalConfig,d?(k.webTierAuth||"web"!==(d.auth_tier&&d.auth_tier.toLowerCase())||(k.webTierAuth=!0),c(new w({userId:d.email,server:k.server,token:k.webTierAuth?null:d.token,expires:d.expires}))):h?(h="",d=window.location.href,h=b.signInPage?b.signInPage:q?q.baseUrl+q.signin:b._isIdProvider(d,a.resUrl_)?b._getOrigin(d)+"/home/signin.html":k.tokenServiceUrl.replace(b._rePortalTokenSvc,"")+"/home/signin.html",h=h.replace(/http:/i,"https:"),q&&!1===q.useSSL&&(h=h.replace(/https:/i,"http:")),0===d.toLowerCase().replace("https",
"http").indexOf(h.toLowerCase().replace("https","http"))?(k=new p("identity-manager:unexpected-error","Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+a.resUrl_),e(k)):(b._rejectOnPersistedPageShow=!0,b._redirectFunc?b._redirectFunc({signInPage:h,returnUrlParamName:"returnUrl",returnUrl:d,resourceUrl:a.resUrl_,serverInfo:k}):window.location.href=h+"?returnUrl\x3d"+encodeURIComponent(d))):(k=new p("identity-manager:not-authenticated","User is not signed in."),
e(k))):d?c(new w({userId:d,server:k.server,token:g,expires:null!=l?Number(l):null,ssl:!!f})):q?(d=q._oAuthCred,d||(f=new P(q,window.localStorage),g=new P(q,window.sessionStorage),f.isValid()&&g.isValid()?f.expires>g.expires?(d=f,g.destroy()):(d=g,f.destroy()):d=f.isValid()?f:g,q._oAuthCred=d),d.isValid()?c(new w({userId:d.userId,server:k.server,token:d.token,expires:d.expires,ssl:d.ssl,_oAuthCred:d})):b._oAuthHash&&b._oAuthHash.state.portalUrl===q.portalUrl?(h=b._oAuthHash,k=new w({userId:h.username,
server:k.server,token:h.access_token,expires:Date.now()+1E3*Number(h.expires_in),ssl:"true"===h.ssl,oAuthState:h.state,_oAuthCred:d}),d.storage=h.persist?window.localStorage:window.sessionStorage,d.token=k.token,d.expires=k.expires,d.userId=k.userId,d.ssl=k.ssl,d.save(),b._oAuthHash=null,c(k)):h?a._pendingDfd=b.oAuthSignIn(a.resUrl_,k,q,a.options_).then(c,e):(k=new p("identity-manager:not-authenticated","User is not signed in."),e(k))):h?b._checkProtocol(a.resUrl_,k,e,a.admin_)&&(h=a.options_,a.admin_&&
(h=h||{},h.isAdmin=!0),a._pendingDfd=b.signIn(a.resUrl_,k,h).then(c,e)):(k=new p("identity-manager:not-authenticated","User is not signed in."),e(k))},g=function(){var d=a.sinfo_,f=d.owningSystemUrl,g=a.options_,h,l,n,m;g&&(h=g.token,l=g.error,n=g.prompt);m=b._findCredential(f,{token:h,resource:a.resUrl_});if(!m)for(var g=0,p=b.credentials;g<p.length;g++){var r=p[g];if(b._isIdProvider(f,r.server)){m=r;break}}m?(f=b.findCredential(a.resUrl_,m.userId))?c(f):H(d,b._legacyFed)?(r=m.toJSON(),r.server=
d.server,r.resources=null,c(new w(r))):(a._pendingDfd=b.generateToken(b.findServerInfo(m.server),null,{serverUrl:a.resUrl_,token:m.token,signal:a.options_.signal,ssl:m.ssl})).then(function(b){c(new w({userId:m.userId,server:d.server,token:b.token,expires:null!=b.expires?Number(b.expires):null,ssl:!!b.ssl,isAdmin:a.admin_,validity:b.validity}))},e):(b._busy=null,h&&(a.options_.token=null),(a._pendingDfd=b.getCredential(f.replace(/\/?$/,"/sharing"),{resource:a.resUrl_,owningTenant:d.owningTenant,signal:a.options_.signal,
token:h,error:l,prompt:n})).then(function(){b._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},function(a){e(a)}))};this._errbackFunc=e;var h=a.sinfo_.owningSystemUrl,l=this._isServerRsrc(a.resUrl_),n=a.sinfo_._restInfoPms;n?n.promise.then(function(d){var c=a.sinfo_;c._restInfoPms&&(c.adminTokenServiceUrl=c._restInfoPms.adminUrl,c._restInfoPms=null,c.tokenServiceUrl=C.getDeepValue("authInfo.tokenServicesUrl",d)||C.getDeepValue("authInfo.tokenServiceUrl",d)||C.getDeepValue("tokenServiceUrl",d),
c.shortLivedTokenValidity=C.getDeepValue("authInfo.shortLivedTokenValidity",d),c.currentVersion=d.currentVersion,c.owningTenant=d.owningTenant,(d=c.owningSystemUrl=d.owningSystemUrl)&&b._portals.push(d));l&&c.owningSystemUrl?g():f()},function(){a.sinfo_._restInfoPms=null;var b=new p("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");e(b)}):l&&h?g():a.sinfo_._selfReq?a.sinfo_._selfReq.selfDfd.then(function(d){var c={},e,f,g,h;d&&(e=d.user&&
d.user.username,c.username=e,c.allSSL=d.allSSL,f=d.supportsOAuth,g=d.currentVersion,"multitenant"===d.portalMode&&(h=d.customBaseUrl));a.sinfo_.webTierAuth=!!e;return e&&b.normalizeWebTierAuth?b.generateToken(a.sinfo_,null,{ssl:c.allSSL}).catch(function(){return null}).then(function(a){c.portalToken=a&&a.token;c.tokenExpiration=a&&a.expires;return c}):!e&&f&&4.4<=parseFloat(g)&&!b._canUsePortalSignInWorkflow(a.resUrl_)?b._generateOAuthInfo({portalUrl:a.sinfo_.server,customBaseUrl:h,owningTenant:a.sinfo_._selfReq.owningTenant}).catch(function(){return null}).then(function(){return c}):
c}).catch(function(){return null}).then(function(b){a.sinfo_._selfReq=null;b?f(b.username,b.allSSL,b.portalToken,b.tokenExpiration):f()}):f()};c.prototype._generateOAuthInfo=function(a){var b=this,d,c=a.portalUrl,f=a.customBaseUrl,g=a.owningTenant;if(a=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal){d=window.location.href;var h=d.indexOf("?");-1<h&&(d=d.slice(0,h));h=d.search(/\/(apps|home)\//);d=-1<h?d.slice(0,h):null}a&&d?(this._hasTestedIfAppIsOnPortal=!0,
a=z(d+"/sharing/rest",{query:{f:"json"}}).then(function(){b.defaultOAuthInfo=new Q({appId:"arcgisonline",popup:!0,popupCallbackUrl:d+"/home/oauth-callback.html"})})):a=v.resolve();return a.then(function(){if(b.defaultOAuthInfo)return c=c.replace(/^http:/i,"https:"),z(c+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:g,client_id:b.defaultOAuthInfo.appId,redirect_uri:u.makeAbsolute(b.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(function(a){if(a.data.valid){var d=b.defaultOAuthInfo.clone();
d.portalUrl=a.data.urlKey&&f?"https://"+a.data.urlKey+"."+f:c;b.oAuthInfos.push(d)}})})};c.prototype._doOAuthSignIn=function(a,b,d){var c=this,f={portalUrl:d.portalUrl};!d.popup&&d.preserveUrlHash&&window.location.hash&&(f.hash=window.location.hash);f={client_id:d.appId,response_type:"token",state:JSON.stringify(f),expiration:d.expiration,locale:d.locale,redirect_uri:d.popup?u.makeAbsolute(d.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};d.forceLogin&&(f.force_login=!0);var g=d.portalUrl.replace(/^http:/i,
"https:")+"/sharing/oauth2/authorize",h=g+"?"+u.objectToQuery(f);if(d.popup){var l=window.open(h,"esriJSAPIOAuth",d.popupWindowFeatures);l?(l.focus(),this._oAuthDfd.oAuthWin_=l,this._oAuthIntervalId=setInterval(function(){if(l.closed){clearInterval(c._oAuthIntervalId);var a=c._oAuthDfd;if(a){var b=new p("identity-manager:user-aborted","ABORTED");a.reject(b)}}},500)):(a=new p("identity-manager:popup-blocked","ABORTED"),this._oAuthDfd.reject(a))}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?
this._oAuthRedirectFunc({authorizeParams:f,authorizeUrl:g,resourceUrl:a,serverInfo:b,oAuthInfo:d}):window.location.href=h};return c=t([r.subclass("esri.identity.IdentityManagerBase")],c)}(r.declared(M));E.IdentityManagerBase=I;var w=function(p){function c(a){var b=p.call(this,a)||this;b._oAuthCred=null;b.tokenRefreshBuffer=2;a&&a._oAuthCred&&(b._oAuthCred=a._oAuthCred);return b}K(c,p);c.prototype.initialize=function(){this.resources=this.resources||[];null==this.creationTime&&(this.creationTime=Date.now())};
c.prototype.refreshToken=function(){var a=this,b=m.id.findServerInfo(this.server),c=b&&b.owningSystemUrl,e=!!c&&"server"===this.scope,f=e&&H(b,m.id._legacyFed),g=b.webTierAuth,h=g&&m.id.normalizeWebTierAuth,l=D[this.server],n=l&&l[this.userId],l=this.resources&&this.resources[0],k=e&&m.id.findServerInfo(c),q={username:this.userId,password:n},p;if(!g||h)if(e&&!k&&m.id.serverInfos.some(function(a){m.id._isIdProvider(c,a.server)&&(k=a);return!!k}),g=k&&m.id.findCredential(k.server,this.userId),!e||g)if(f)g.refreshToken();
else{if(e)p={serverUrl:l,token:g&&g.token,ssl:g&&g.ssl};else if(h)q=null,p={ssl:this.ssl};else if(n)this.isAdmin&&(p={isAdmin:!0});else return e=void 0,l&&(l=m.id._sanitizeUrl(l),this._enqueued=1,e=m.id._enqueue(l,b,null,null,this.isAdmin,this),e.then(function(){a._enqueued=0;a.refreshServerTokens()}).catch(function(){a._enqueued=0})),e;return m.id.generateToken(e?k:b,e?null:q,p).then(function(b){a.token=b.token;a.expires=null!=b.expires?Number(b.expires):null;a.creationTime=Date.now();a.validity=
b.validity;a.emitTokenChange();a.refreshServerTokens()}).catch(function(){})}};c.prototype.refreshServerTokens=function(){var a=this;"portal"===this.scope&&m.id.credentials.forEach(function(b){var c=m.id.findServerInfo(b.server),e=c&&c.owningSystemUrl;b!==a&&b.userId===a.userId&&e&&"server"===b.scope&&(m.id._hasSameServerInstance(a.server,e)||m.id._isIdProvider(e,a.server))&&(H(c,m.id._legacyFed)?(b.token=a.token,b.expires=a.expires,b.creationTime=a.creationTime,b.validity=a.validity,b.emitTokenChange()):
b.refreshToken())})};c.prototype.emitTokenChange=function(a){clearTimeout(this._refreshTimer);var b=this.server&&m.id.findServerInfo(this.server),c=(b=b&&b.owningSystemUrl)&&m.id.findServerInfo(b);!1===a||b&&"portal"!==this.scope&&(!c||!c.webTierAuth||m.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer();this.emit("token-change")};c.prototype.destroy=function(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null;
this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var a=m.id.credentials.indexOf(this);-1<a&&m.id.credentials.splice(a,1);this.emitTokenChange();this.emit("destroy")};c.prototype.toJSON=function(){var a=A.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),b=this.resources;b&&0<b.length&&(a.resources=b.slice());return a};c.prototype._startRefreshTimer=
function(){clearTimeout(this._refreshTimer);var a=6E4*this.tokenRefreshBuffer,b=(this.validity?this.creationTime+6E4*this.validity:this.expires)-Date.now();0>b&&(b=0);this._refreshTimer=setTimeout(this.refreshToken.bind(this),b>a?b-a:b)};t([r.property()],c.prototype,"creationTime",void 0);t([r.property()],c.prototype,"expires",void 0);t([r.property()],c.prototype,"isAdmin",void 0);t([r.property()],c.prototype,"oAuthState",void 0);t([r.property()],c.prototype,"resources",void 0);t([r.property()],c.prototype,
"scope",void 0);t([r.property()],c.prototype,"server",void 0);t([r.property()],c.prototype,"ssl",void 0);t([r.property()],c.prototype,"token",void 0);t([r.property()],c.prototype,"tokenRefreshBuffer",void 0);t([r.property()],c.prototype,"userId",void 0);t([r.property()],c.prototype,"validity",void 0);return c=t([r.subclass("esri.identity.Credential")],c)}(r.declared(M.EventedAccessor));E.Credential=w});