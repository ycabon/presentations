// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/Handles ../core/jsonMap ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/urlUtils ../core/accessorSupport/decorators ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/spatialReferenceUtils ./Layer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(V,W,k,A,f,q,r,t,B,C,m,D,E,u,F,G,H,v,I,d,J,K,l,L,M,N,O,P,Q,R,S,w,T,n,x){function U(d,b){return d.some(function(e){for(var a in e)if(J.willPropertyWrite(e,a,null,b))return!0;return!1})}function z(d,b,e){var a=[],c=new Map;d.forEach(function(g){var d=new n;d.read(g,b);e&&-1===e.indexOf(d.name)&&(d.visible=!1);c.set(d.id,d);null!=g.parentLayerId&&-1!==g.parentLayerId?(g=c.get(g.parentLayerId),g.sublayers||(g.sublayers=[]),g.sublayers.unshift(d)):a.unshift(d)});return a}var p=new F.JSONMap({svg:"image/svg+xml",
png:"image/png",jpg:"image/jpeg",gif:"image/gif",bmp:"image/bmp"},{ignoreUnknown:!1});return function(y){function b(e,a){var c=y.call(this,e)||this;c._sublayersHandles=new u;c.allSublayers=new E({root:c,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});c.customParameters=null;c.customLayerParameters=null;c.copyright=null;c.description=null;c.fullExtent=null;c.fullExtents=null;c.featureInfoFormat=null;c.featureInfoUrl=null;c.imageFormat=null;c.imageMaxHeight=2048;
c.imageMaxWidth=2048;c.imageTransparency=!0;c.legendEnabled=!0;c.mapUrl=null;c.isReference=null;c.operationalLayerType="WMS";c.spatialReference=null;c.spatialReferences=null;c.sublayers=null;c.type="wms";c.url=null;c.version=null;c.watch("sublayers",function(a,e){e&&(e.forEach(function(a){a.layer=null}),c._sublayersHandles.removeAll(),c._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),c._sublayersHandles||(c._sublayersHandles=new u),c._sublayersHandles.add([a.on("after-add",
function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})]))},!0);return c}A(b,y);b.prototype.normalizeCtorArgs=function(e,a){return"string"===typeof e?k({url:e},a):e};b.prototype.load=function(e){var a=this,c=G.isSome(e)?e.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},e).then(function(){return a._fetchService(c)}));return v.resolve(this)};b.prototype.readFullExtentFromItemOrMap=function(e,a){e=a.extent;return new K({xmin:e[0][0],
ymin:e[0][1],xmax:e[1][0],ymax:e[1][1]})};b.prototype.writeFullExtent=function(e,a){a.extent=[[e.xmin,e.ymin],[e.xmax,e.ymax]]};b.prototype.readImageFormat=function(e,a){return(e=a.supportedImageFormatTypes)&&-1<e.indexOf("image/png")?"image/png":e&&e[0]};b.prototype.readSpatialReferenceFromItemOrDocument=function(e,a){return new l(a.spatialReferences[0])};b.prototype.writeSpatialReferences=function(e,a){var c=this.spatialReference&&this.spatialReference.wkid;e&&c?(a.spatialReferences=e.filter(function(a){return a!==
c}),a.spatialReferences.unshift(c)):a.spatialReferences=e};b.prototype.readSublayersFromItemOrMap=function(e,a,c){return z(a.layers,c,a.visibleLayers)};b.prototype.readSublayers=function(e,a,c){return z(a.layers,c)};b.prototype.writeSublayers=function(e,a,c,b){a.layers=[];var d=new Map;e=e.flatten(function(a){return(a=a.sublayers)&&a.toArray()}).toArray();e.forEach(function(a){"number"===typeof a.parent.id&&(d.has(a.parent.id)?d.get(a.parent.id).push(a.id):d.set(a.parent.id,[a.id]))});e.forEach(function(c){var e=
k({sublayer:c},b),f=c.write({parentLayerId:"number"===typeof c.parent.id?c.parent.id:-1},e);d.has(c.id)&&(f.sublayerIds=d.get(c.id));!c.sublayers&&c.name&&(c=c.write({},e),delete c.id,a.layers.push(c))});a.visibleLayers=e.filter(function(a){return a.visible&&!a.sublayers}).map(function(a){return a.name})};b.prototype.createExportImageParameters=function(e,a,c,b){c=b&&b.pixelRatio||1;a=L.getScale({extent:e,width:a})*c;this._exportWMSImageParameters=new T({layer:this,extent:e,scale:a});return this._exportWMSImageParameters.toJSON()};
b.prototype.fetchImage=function(e,a,c,b){return r(this,void 0,void 0,function(){var d,f,g,h;return q(this,function(X){d=this.mapUrl;f=this.createExportImageParameters(e,a,c,b);if(!f.layers)return g=document.createElement("canvas"),g.width=a,g.height=c,[2,g];h={responseType:"image",query:this._mixCustomParameters(k({width:a,height:c},f)),signal:b&&b.signal};b&&b.timestamp&&(h.query=k({_ts:b.timestamp},h.query));return[2,m(d,h).then(function(a){return a.data})]})})};b.prototype.fetchFeatureInfo=function(b,
a,c,d,f){var e=this,g=x.getPopupLayers(this._exportWMSImageParameters.visibleSublayers);if(!this.featureInfoUrl||!g)return null;d=k({query_layers:g,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:a,height:c},"1.3.0"===this.version?{I:d,J:f}:{x:d,y:f});var h=k({},this.createExportImageParameters(b,a,c),d),h=this._mixCustomParameters(h);return m(this.featureInfoUrl,{query:h,responseType:"text"}).then(function(a){var c=e.featureInfoUrl,c=c+(-1===c.indexOf("?")?"?":
""),b;for(b in h)c+="?"===c.substring(c.length-1,c.length)?"":"\x26",c+=b+"\x3d"+h[b];b=document.createElement("iframe");b.src=c;b.frameBorder="0";b.marginHeight="0";b.marginWidth="0";b.innerHTML=a.data;b.style.width="100%";return new B({sourceLayer:e,popupTemplate:new C({title:e.title,content:b})})})};b.prototype.findSublayerById=function(b){return this.allSublayers.find(function(a){return a.id===b})};b.prototype.supportsSpatialReference=function(b){return S.isWmsServer(this.url)||this.spatialReferences.some(function(a){a=
900913===a?l.WebMercator:new l({wkid:a});return M.equals(a,b)})};b.prototype._fetchService=function(b){return r(this,void 0,void 0,function(){var a=this;return q(this,function(c){return[2,v.resolve().then(function(){if(a.resourceInfo)return{data:a.resourceInfo};a.parsedUrl.query&&a.parsedUrl.query.service&&(a.parsedUrl.query.SERVICE=a.parsedUrl.query.service,delete a.parsedUrl.query.service);a.parsedUrl.query&&a.parsedUrl.query.request&&(a.parsedUrl.query.REQUEST=a.parsedUrl.query.request,delete a.parsedUrl.query.request);
return m(a.parsedUrl.path,{query:k({SERVICE:"WMS",REQUEST:"GetCapabilities"},a.parsedUrl.query,a.customParameters),responseType:"xml",signal:b})}).then(function(c){if(!a.resourceInfo){c.data=x.parseCapabilities(c.data);var b=new I.Url(a.parsedUrl.path);"https"!==b.scheme||b.port&&"443"!==b.port||-1!==t.request.httpsDomains.indexOf(b.host)||t.request.httpsDomains.push(b.host)}c.data&&a.read(c.data,{origin:"service"})})]})})};b.prototype._mixCustomParameters=function(b){if(!this.customLayerParameters&&
!this.customParameters)return b;var a=k({},this.customParameters,this.customLayerParameters),c;for(c in a)b[c.toLowerCase()]=a[c];return b};f([d.property({readOnly:!0})],b.prototype,"allSublayers",void 0);f([d.property({json:{type:Object,write:!0}})],b.prototype,"customParameters",void 0);f([d.property({type:["show","hide","hide-children"]})],b.prototype,"listMode",void 0);f([d.property({json:{type:Object,write:!0}})],b.prototype,"customLayerParameters",void 0);f([d.property({type:String,json:{write:!0}})],
b.prototype,"copyright",void 0);f([d.property()],b.prototype,"description",void 0);f([d.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{service:{read:{source:"extent"}}}}})],b.prototype,"fullExtent",void 0);f([d.reader(["web-document","portal-item"],"fullExtent",["extent"])],b.prototype,"readFullExtentFromItemOrMap",null);f([d.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],b.prototype,"writeFullExtent",null);f([d.property()],
b.prototype,"fullExtents",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoFormat",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoUrl",void 0);f([d.property({type:String,json:{origins:{"web-document":{default:"image/png",type:p.jsonValues,read:{reader:p.read,source:"format"},write:{writer:p.write,target:"format"}}}}})],b.prototype,"imageFormat",void 0);f([d.reader("imageFormat",["supportedImageFormatTypes"])],
b.prototype,"readImageFormat",null);f([d.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],b.prototype,"imageMaxHeight",void 0);f([d.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],b.prototype,"imageMaxWidth",void 0);f([d.property()],b.prototype,"imageTransparency",void 0);f([d.property(w.legendEnabled)],b.prototype,"legendEnabled",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"mapUrl",void 0);
f([d.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],b.prototype,"isReference",void 0);f([d.property({type:["WMS"]})],b.prototype,"operationalLayerType",void 0);f([d.property({type:l,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],b.prototype,"spatialReference",void 0);f([d.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],b.prototype,"readSpatialReferenceFromItemOrDocument",null);
f([d.property({type:[Number],json:{read:{source:"spatialReferences"},write:{ignoreOrigin:!0}}})],b.prototype,"spatialReferences",void 0);f([d.writer(["web-document","portal-item"],"spatialReferences")],b.prototype,"writeSpatialReferences",null);f([d.property({type:D.ofType(n),json:{write:{target:"layers",overridePolicy:function(b,a,c){if(U(this.allSublayers,c))return{ignoreOrigin:!0}}}}})],b.prototype,"sublayers",void 0);f([d.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],
b.prototype,"readSublayersFromItemOrMap",null);f([d.reader("service","sublayers",["layers"])],b.prototype,"readSublayers",null);f([d.writer("sublayers",{layers:{type:[n]},visibleLayers:{type:[String]}})],b.prototype,"writeSublayers",null);f([d.property({json:{read:!1},readOnly:!0,value:"wms"})],b.prototype,"type",void 0);f([d.property(w.url)],b.prototype,"url",void 0);f([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"version",void 0);return b=f([d.subclass("esri.layers.WMSLayer")],
b)}(d.declared(Q.RefreshableLayer(R.ScaleRangeLayer(O.OperationalLayer(P.PortalLayer(H.MultiOriginJSONMixin(N)))))))});