// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../request ../core/Collection ../core/Error ../core/Handles ../core/lang ../core/MultiOriginJSONSupport ../core/object ../core/promiseUtils ../core/SetUtils ../core/urlUtils ../core/accessorSupport/decorators ../geometry/Extent ./Layer ./WebTileLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/TileInfo ./support/WMTSLayerInfo ./support/WMTSSublayer ./support/wmtsUtils".split(" "),
function(N,O,g,r,f,t,u,l,v,w,m,n,x,y,z,A,B,e,C,D,E,F,G,H,I,J,K,h,k){function L(e,b){return e.map(function(a){var c=new h;c.read(a,b);return c})}var q={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},M=A.createSetFromValues("version service request layer style format tilematrixset tilematrix tilerow tilecol".split(" "));
return function(p){function b(a,c){var d=p.call(this,a)||this;d._sublayersHandles=new m;d.copyright="";d.customParameters=null;d.customLayerParameters=null;d.fullExtent=null;d.operationalLayerType="WebTiledLayer";d.resourceInfo=null;d.serviceMode="RESTful";d.sublayers=null;d.type="wmts";d.version="1.0.0";d.watch("activeLayer",function(a,c){c&&(c.layer=null);a&&(a.layer=d)},!0);d.watch("sublayers",function(a,c){c&&(c.forEach(function(a){a.layer=null}),d._sublayersHandles.removeAll(),d._sublayersHandles=
null);a&&(a.forEach(function(a){a.layer=d}),d._sublayersHandles||(d._sublayersHandles=new m),d._sublayersHandles.add([a.on("after-add",function(a){a.item.layer=d}),a.on("after-remove",function(a){a.item.layer=null})]))},!0);return d}r(b,p);b.prototype.normalizeCtorArgs=function(a,c){return"string"===typeof a?g({url:a},c):a};b.prototype.load=function(a){var c=this;if("KVP"!==this.serviceMode&&"RESTful"!==this.serviceMode)console.error("WMTS mode could only be 'KVP' or 'RESTful'");else return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},
a).then(function(){return c._fetchService(a)}).catch(function(a){throw new w("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:a});})),z.resolve(this)};Object.defineProperty(b.prototype,"activeLayer",{get:function(){return this._get("activeLayer")},set:function(a){this._set("activeLayer",a)},enumerable:!0,configurable:!0});b.prototype.readActiveLayerFromService=function(a,c,d){var b=this,e;this.activeLayer?c.layers.some(function(a){return a.id===b.activeLayer.id?
(e=a,!0):!1}):(this.activeLayer=new h,e=c.layers[0]);this.activeLayer.read(e,d);return this.activeLayer};b.prototype.readActiveLayerFromItemOrWebDoc=function(a,c){a=c.templateUrl?this._getLowerCasedUrlParams(c.templateUrl):null;return new h({id:c.wmtsInfo.layerIdentifier,tileMatrixSetId:c.wmtsInfo.tileMatrixSet,imageFormat:a&&a.format,styleId:a&&a.style})};b.prototype.writeActiveLayer=function(a,c,d,b){a=this.activeLayer;c.templateUrl=this.getUrlTemplate(a.id,a.tileMatrixSetId,a.imageFormat,a.styleId);
d=y.getDeepValue("tileMatrixSet.tileInfo",a);c.tileInfo=d?d.toJSON(b):null;c.wmtsInfo=g({},c.wmtsInfo,{layerIdentifier:a.id,tileMatrixSet:a.tileMatrixSetId})};b.prototype.readCustomParameters=function(a,c){return(a=c.wmtsInfo)?this._mergeParams(a.customParameters,a.url):null};Object.defineProperty(b.prototype,"fullExtents",{get:function(){var a=[];this.activeLayer.tileMatrixSets.forEach(function(c){c.fullExtent&&a.push(c.fullExtent)});return a},enumerable:!0,configurable:!0});b.prototype.readServiceMode=
function(a,c){return-1<c.templateUrl.indexOf("?")?"KVP":"RESTful"};b.prototype.readSublayersFromService=function(a,c,b){return L(c.layers,b)};Object.defineProperty(b.prototype,"supportedSpatialReferences",{get:function(){return this.activeLayer.tileMatrixSets.map(function(a){return a.tileInfo.spatialReference}).toArray()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"title",{get:function(){return"Layer"===this._get("title")?this.activeLayer&&this.activeLayer.title:this._get("title")},
set:function(a){this._set("title",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"url",{get:function(){return this._get("url")},set:function(a){a&&"/"===a.substr(-1)?this._set("url",a.slice(0,-1)):this._set("url",a)},enumerable:!0,configurable:!0});b.prototype.createWebTileLayer=function(a){var c=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),b=this._getTileMatrixSetById(a.tileMatrixSetId).tileInfo,
e=a.fullExtent;a=new K.default({layerIdentifier:a.id,tileMatrixSet:a.tileMatrixSetId,url:this.url});this.customLayerParameters&&(a.customLayerParameters=this.customLayerParameters);this.customParameters&&(a.customParameters=this.customParameters);return new E({fullExtent:e,urlTemplate:c,tileInfo:b,wmtsInfo:a})};b.prototype.fetchTile=function(a,c,b){a=this.getTileUrl(a,c,b);return l(a,{responseType:"image"}).then(function(a){return a.data})};b.prototype.findSublayerById=function(a){return this.sublayers.find(function(c){return c.id===
a})};b.prototype.getTileUrl=function(a,c,b){var d=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId).tileInfo.lods[a];a=d?d.levelValue?d.levelValue:""+d.level:""+a;(d=this.resourceInfo?"":k.getTileUrlFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,a,c,b))||(d=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,
this.activeLayer.styleId).replace(/\{level\}/gi,a).replace(/\{row\}/gi,""+c).replace(/\{col\}/gi,""+b));return d=this._appendCustomLayerParameters(d)};b.prototype.getUrlTemplate=function(a,c,b,e){if(!this.resourceInfo){var d=k.getTileUrlTemplateFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},a,c,e);if(d)return d}return"KVP"===this.serviceMode?this.url+"?SERVICE\x3dWMTS\x26VERSION\x3d"+this.version+"\x26REQUEST\x3dGetTile\x26LAYER\x3d"+a+"\x26STYLE\x3d"+e+"\x26FORMAT\x3d"+
b+"\x26TILEMATRIXSET\x3d"+c+"\x26TILEMATRIX\x3d{level}\x26TILEROW\x3d{row}\x26TILECOL\x3d{col}":"RESTful"===this.serviceMode?(d="",q[b.toLowerCase()]&&(d=q[b.toLowerCase()]),this.url+a+"/"+e+"/"+c+"/{level}/{row}/{col}"+d):""};b.prototype._fetchService=function(a){return u(this,void 0,void 0,function(){var c,b,e;return t(this,function(d){switch(d.label){case 0:if(!this.resourceInfo)return[3,1];"KVP"===this.resourceInfo.serviceMode&&(this.url+=-1<this.url.indexOf("?")?"":"?");c={ssl:!1,data:this.resourceInfo};
return[3,6];case 1:b=this._getCapabilitiesUrl(this.serviceMode),d.label=2;case 2:return d.trys.push([2,4,,6]),[4,l(b,g({},a,{responseType:"text"}))];case 3:return c=d.sent(),[3,6];case 4:return d.sent(),e="KVP"===this.serviceMode?"RESTful":"KVP",b=this._getCapabilitiesUrl(e),[4,l(b,g({},a,{responseType:"text"}))];case 5:return c=d.sent(),[3,6];case 6:return c.data=this.resourceInfo?k.parseResourceInfo(c.data):k.parseCapabilities(c.data,{serviceMode:this.serviceMode,url:this.url}),c.data&&this.read(c.data,
{origin:"service"}),[2]}})})};b.prototype._getTileMatrixSetById=function(a){return this.findSublayerById(this.activeLayer.id).tileMatrixSets.find(function(c){return c.id===a})};b.prototype._appendCustomParameters=function(a){if(this.customParameters)for(var c in this.customParameters)a+=(-1===a.indexOf("?")?"?":"\x26")+c+"\x3d"+encodeURIComponent(this.customParameters[c]);return a};b.prototype._appendCustomLayerParameters=function(a){if(this.customLayerParameters||this.customParameters){var c=g({},
n.clone(this.customParameters||{}),this.customLayerParameters),b;for(b in c)a+=(-1===a.indexOf("?")?"?":"\x26")+b+"\x3d"+encodeURIComponent(c[b])}return a};b.prototype._getCapabilitiesUrl=function(a){var b;this.url=this.url.split("?")[0];"KVP"===a?b=this.url+"?request\x3dGetCapabilities\x26service\x3dWMTS\x26version\x3d"+this.version:"RESTful"===a&&(b=this.url+"/"+this.version+"/WMTSCapabilities.xml");return b=this._appendCustomParameters(b)};b.prototype._getLowerCasedUrlParams=function(a){if(!a)return null;
var b=B.urlToObject(a).query;if(!b)return null;var d={};Object.keys(b).forEach(function(a){d[a.toLowerCase()]=b[a]});return d};b.prototype._mergeParams=function(a,b){var c=this._getLowerCasedUrlParams(b);c&&(b=Object.keys(c),b.length&&(a=a?n.clone(a):{},b.forEach(function(b){a.hasOwnProperty(b)||M.has(b)||(a[b]=c[b])})));return a};f([e.property()],b.prototype,"dimensionMap",void 0);f([e.property()],b.prototype,"layerMap",void 0);f([e.property({type:h,dependsOn:["sublayers"],json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],
b.prototype,"activeLayer",null);f([e.reader("service","activeLayer",["layers"])],b.prototype,"readActiveLayerFromService",null);f([e.reader(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],b.prototype,"readActiveLayerFromItemOrWebDoc",null);f([e.writer(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:J},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],b.prototype,"writeActiveLayer",null);f([e.property({type:String,
value:"",json:{write:!0}})],b.prototype,"copyright",void 0);f([e.property({type:["show","hide"]})],b.prototype,"listMode",void 0);f([e.property({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],b.prototype,"customParameters",void 0);f([e.reader("web-document","customParameters"),e.reader("portal-item",
"customParameters")],b.prototype,"readCustomParameters",null);f([e.property({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],b.prototype,"customLayerParameters",void 0);f([e.property({type:C,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],
b.prototype,"fullExtent",void 0);f([e.property({readOnly:!0,dependsOn:["activeLayer"]})],b.prototype,"fullExtents",null);f([e.property({type:["WebTiledLayer"]})],b.prototype,"operationalLayerType",void 0);f([e.property()],b.prototype,"resourceInfo",void 0);f([e.property()],b.prototype,"serviceMode",void 0);f([e.reader(["portal-item","web-document"],"serviceMode",["templateUrl"])],b.prototype,"readServiceMode",null);f([e.property({type:v.ofType(h)})],b.prototype,"sublayers",void 0);f([e.reader("service",
"sublayers",["layers"])],b.prototype,"readSublayersFromService",null);f([e.property({readOnly:!0,dependsOn:["activeLayer"]})],b.prototype,"supportedSpatialReferences",null);f([e.property({dependsOn:["activeLayer"],json:{read:{source:"title"}}})],b.prototype,"title",null);f([e.property({json:{read:!1},readOnly:!0,value:"wmts"})],b.prototype,"type",void 0);f([e.property({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},
write:{target:"wmtsInfo.url"}}}}})],b.prototype,"url",null);f([e.property()],b.prototype,"version",void 0);return b=f([e.subclass("esri.layers.WMTSLayer")],b)}(e.declared(H.RefreshableLayer(I.ScaleRangeLayer(F.OperationalLayer(G.PortalLayer(x.MultiOriginJSONMixin(D)))))))});