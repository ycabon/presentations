// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../geometry ../../../Graphic ../../../core/Evented ../../../core/HandleOwner ../../../core/maybe ../../../core/Promise ../../../core/accessorSupport/decorators ../data/StreamFeatureManager ../sources/connections/GeoEventConnection ../../../views/3d/support/EventedSet".split(" "),function(h,k,g,l,n,m,p,q,r,t,e,u,v,w){Object.defineProperty(k,"__esModule",{value:!0});var x=function(){function c(a,
b){this.layer=a;this.collection=b;this._idToGraphic=new Map;this._idToFeature=new Map}c.prototype.destroy=function(){this._idToGraphic.clear();this._idToFeature.clear()};c.prototype.add=function(a){var b=m.fromJSON(a);b.sourceLayer=b.layer=this.layer;this._idToGraphic.set(a.objectId,b);this.collection.addMany([b])};c.prototype.forEach=function(a){this._idToFeature.forEach(a)};c.prototype.removeById=function(a){var b=this._idToFeature.get(a),f=this._idToGraphic.get(a);f.sourceLayer=f.layer=null;this.collection.remove(f);
this._idToFeature.delete(a);this._idToGraphic.delete(a);return b};c.prototype.update=function(a,b){if(r.isSome(b)){a=[];for(var f=0;f<b.length;f++){var c=b[f],d=this._idToGraphic.get(c.objectId);d.sourceLayer=d.layer=null;a.push(d);this._idToFeature.delete(c.objectId);this._idToGraphic.delete(c.objectId)}this.collection.removeMany(a)}};Object.defineProperty(c.prototype,"size",{get:function(){return this.collection.length},enumerable:!0,configurable:!0});return c}();h=function(c){function a(){var b=
null!==c&&c.apply(this,arguments)||this;b.graphics=new w.EventedSet;return b}l(a,c);a.prototype.initialize=function(){var b=this;this.addResolvingPromise(this.layer.when(function(){var a=b.layer,c=a.source,d=a.parsedUrl,e=a.spatialReference,g=a.definitionExpression,h=a.geometryDefinition,k=a.objectIdField,l=a.timeInfo,a=a.purgeOptions,m=n.featureGeometryTypeKebabDictionary.toJSON(b.layer.geometryType);b.store=new x(b.layer,b.graphics);b.featuresManager=new u.default(b.store,k,l.toJSON(),a);d&&(b.connection=
new v.default(d.path,e,b.layerView.view.spatialReference,m,{geometry:h,where:g}),b.connection.on("feature",function(a){return b._onFeature(a)}));if(c)for(d=0,c=JSON.parse(JSON.stringify(c));d<c.length;d++)b.featuresManager.add(c[d]);b.layer.on("message",function(a){return b._onFeature(JSON.parse(a))})}))};a.prototype.destroy=function(){this.connection&&this.connection.destroy();this.store&&this.store.destroy()};Object.defineProperty(a.prototype,"updating",{get:function(){return!this.connection||"connected"===
this.connection.connectionStatus},enumerable:!0,configurable:!0});a.prototype._onFeature=function(a){this.emit("data-received",{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry});try{this.featuresManager.add(a)}catch(f){}};g([e.property()],a.prototype,"connection",void 0);g([e.property()],a.prototype,"layer",void 0);g([e.property()],a.prototype,"layerView",void 0);g([e.property({readOnly:!0,dependsOn:["connection.connectionStatus"]})],a.prototype,"updating",null);return a=g([e.subclass("esri.layers.graphics.controllers.StreamController")],
a)}(e.declared(q.HandleOwnerMixin(t.EsriPromiseMixin(p.EventedAccessor))));k.default=h});