// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../request ../../../core/Error ../../../core/Loadable ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators ../../../tasks/QueryTask ../../../tasks/operations/queryAttachments ../../../tasks/operations/zscale".split(" "),
function(v,w,D,n,m,x,q,t,B,E,C,u,r,k,F,G,H){function I(f){return q(this,void 0,void 0,function(){var b;return x(this,function(a){return"string"===typeof f?(b=r.dataComponents(f),[2,b?b:{data:f}]):[2,u.create(function(a,d){var c=new FileReader;c.readAsDataURL(f);c.onload=function(){return a(r.dataComponents(c.result))};c.onerror=function(a){return d(a)}})]})})}Object.defineProperty(w,"__esModule",{value:!0});v=function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a.type="feature-layer";
return a}D(b,f);b.prototype.load=function(a){a=C.isSome(a)?a.signal:null;this.addResolvingPromise(this._fetchService(a));return u.resolve(this)};Object.defineProperty(b.prototype,"queryTask",{get:function(){var a=this.layer,c=a.parsedUrl,d=a.gdbVersion,b=a.spatialReference;return new F({url:null!=a.dynamicDataSource?c.path+"?"+r.objectToQuery(c.query):c.path,gdbVersion:d,sourceSpatialReference:b})},enumerable:!0,configurable:!0});b.prototype.addAttachment=function(a,c){var d=this;return this.load().then(function(){var b=
a.attributes[d.layer.objectIdField],p=d.layer.parsedUrl.path+"/"+b+"/addAttachment",l=m({f:"json"},d.layer.parsedUrl.query,{gdbVersion:d.layer.gdbVersion}),l=d._getFormDataForAttachment(c,l);return t(p,{body:l}).then(function(a){return d._createFeatureEditResult(a.data.addAttachmentResult)}).catch(function(a){throw d._createAttachmentErrorResult(b,a);})})};b.prototype.updateAttachment=function(a,c,d){var b=this;return this.load().then(function(){var e=a.attributes[b.layer.objectIdField],l=b.layer.parsedUrl.path+
"/"+e+"/updateAttachment",g=m({f:"json"},b.layer.parsedUrl.query,{gdbVersion:b.layer.gdbVersion,attachmentId:c}),g=b._getFormDataForAttachment(d,g);return t(l,{body:g}).then(function(a){return b._createFeatureEditResult(a.data.updateAttachmentResult)}).catch(function(a){throw b._createAttachmentErrorResult(e,a);})})};b.prototype.applyEdits=function(a,c){return q(this,void 0,void 0,function(){var d,b,p,l,g,z,h,A,y,f,m,k,n,q,u,r,v,w;return x(this,function(e){switch(e.label){case 0:return[4,this.load()];
case 1:e.sent(),d=a.addFeatures.map(this._serializeFeature,this),b=a.updateFeatures.map(this._serializeFeature,this),p=this._getFeatureIds(a.deleteFeatures),H.unapplyEditsZUnitScaling(d,b,this.layer.spatialReference),l=[],g=[],z=a.deleteAttachments.slice(),h=0,A=a.addAttachments,e.label=2;case 2:if(!(h<A.length))return[3,5];y=A[h];m=(f=l).push;return[4,this._serializeAttachment(y)];case 3:m.apply(f,[e.sent()]),e.label=4;case 4:return h++,[3,2];case 5:k=0,n=a.updateAttachments,e.label=6;case 6:if(!(k<
n.length))return[3,9];y=n[k];u=(q=g).push;return[4,this._serializeAttachment(y)];case 7:u.apply(q,[e.sent()]),e.label=8;case 8:return k++,[3,6];case 9:return r=l.length||g.length||z.length?{adds:l,updates:g,deletes:z}:null,v={f:"json",adds:d.length?JSON.stringify(d):null,updates:b.length?JSON.stringify(b):null,deletes:p.length?p.join(","):null,gdbVersion:c&&c.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:c&&c.rollbackOnFailureEnabled,useGlobalIds:c&&c.globalIdUsed,attachments:r&&JSON.stringify(r)},
[4,t(this.layer.parsedUrl.path+"/applyEdits",{query:v,method:"post",responseType:"json"})];case 10:return w=e.sent(),[2,this._createEditsResult(w)]}})})};b.prototype.deleteAttachments=function(a,c){var d=this;return this.load().then(function(){var b=a.attributes[d.layer.objectIdField];return t(d.layer.parsedUrl.path+"/"+b+"/deleteAttachments",{query:m({f:"json"},d.layer.parsedUrl.query,{gdbVersion:d.layer.gdbVersion,attachmentIds:c.join(",")}),method:"post",responseType:"json"}).then(function(a){return a.data.deleteAttachmentResults.map(d._createFeatureEditResult)}).catch(function(a){throw d._createAttachmentErrorResult(b,
a);})})};b.prototype.queryAttachments=function(a,c){var d=this;void 0===c&&(c={});var b=this.layer.parsedUrl,p=b.path;return this.load().then(function(){var e=m({},c,{query:m({},b.query,{gdbVersion:d.layer.gdbVersion,f:"json"}),responseType:"json"});if(!d.layer.get("capabilities.operations.supportsQueryAttachments")){for(var g=a.objectIds,f=[],h=0;h<g.length;h++)f.push(t(p+"/"+g[h]+"/attachments",e));return u.all(f).then(function(a){return g.map(function(c,b){return{parentObjectId:c,attachmentInfos:a[b].data.attachmentInfos}})}).then(function(a){return G.processAttachmentQueryResult(a,
p)})}return d.queryTask.executeAttachmentQuery(a,e)})};b.prototype.queryFeatures=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.execute(a,c)})};b.prototype.queryFeaturesJSON=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeJSON(a,c)})};b.prototype.queryObjectIds=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForIds(a,c)})};b.prototype.queryFeatureCount=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForCount(a,
c)})};b.prototype.queryExtent=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeForExtent(a,c)})};b.prototype.queryRelatedFeatures=function(a,c){var b=this;return this.load().then(function(){return b.queryTask.executeRelationshipQuery(a,c)})};b.prototype._fetchService=function(a){return q(this,void 0,void 0,function(){var c,b;return x(this,function(d){switch(d.label){case 0:return(c=this.layer.sourceJSON)?(this.sourceJSON=c,[2]):[4,t(this.layer.parsedUrl.path,{query:m({f:"json"},
this.layer.parsedUrl.query),responseType:"json",signal:a})];case 1:return this.sourceJSON=b=d.sent().data,[2]}})})};b.prototype._serializeFeature=function(a){var c=a.geometry;a=a.attributes;return C.isNone(c)?{attributes:a}:"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:a}};b.prototype._serializeAttachment=function(a){return q(this,void 0,void 0,function(){var c,b,e,f,l,g,k,h,m;return x(this,function(d){switch(d.label){case 0:c=a.feature;b=a.attachment;e=b.globalId;f=b.name;
l=b.contentType;g=b.data;k=b.uploadId;h={globalId:e,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};c&&(h.parentGlobalId="attributes"in c?c.attributes&&c.attributes[this.layer.globalIdField]:c.globalId);if(!k)return[3,1];h.uploadId=k;return[3,3];case 1:return g?[4,I(g)]:[3,3];case 2:m=d.sent(),h.contentType=m.mediaType,h.data=m.data,g instanceof File&&(h.name=g.name),d.label=3;case 3:return f&&(h.name=f),l&&(h.contentType=l),[2,h]}})})};b.prototype._getFeatureIds=function(a){var c=
a[0];return c?"objectId"in c?this._getIdsFromFeatureIdentifier(a):this._getIdsFromFeatures(a):[]};b.prototype._getIdsFromFeatures=function(a){var c=this.layer.objectIdField;return a.map(function(a){return a.attributes&&a.attributes[c]})};b.prototype._getIdsFromFeatureIdentifier=function(a){return a.map(function(a){return a.objectId})};b.prototype._createEditsResult=function(a){var b=a.data;a=a.data&&a.data.attachments;return{addFeatureResults:b.addResults?b.addResults.map(this._createFeatureEditResult,
this):[],updateFeatureResults:b.updateResults?b.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:b.deleteResults?b.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:a&&a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:a&&a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:a&&a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}};b.prototype._createFeatureEditResult=
function(a){var b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new B("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};b.prototype._createAttachmentErrorResult=function(a,b){return{objectId:a,globalId:null,error:new B("feature-layer-source:attachment-failure",b.details.messages&&b.details.messages[0]||b.message,{code:b.details.httpStatus||b.details.messageCode})}};b.prototype._getFormDataForAttachment=function(a,
b){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(var c in b){var e=b[c];null!=e&&(a.set?a.set(c,e):a.append(c,e))}return a};n([k.property()],b.prototype,"type",void 0);n([k.property({constructOnly:!0})],b.prototype,"layer",void 0);n([k.property({readOnly:!0,dependsOn:["layer.parsedUrl","layer.gdbVersion","layer.dynamicDataSource"]})],b.prototype,"queryTask",null);return b=n([k.subclass("esri.layers.graphics.sources.FeatureLayerSource")],b)}(k.declared(E));w.default=v});