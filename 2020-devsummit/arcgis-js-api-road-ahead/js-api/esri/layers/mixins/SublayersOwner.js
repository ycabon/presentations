// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Collection ../../core/CollectionFlattener ../../core/Error ../../core/Logger ../../core/accessorSupport/decorators ../../core/accessorSupport/PropertyOrigin ../../core/accessorSupport/utils ../support/Sublayer ../support/sublayerUtils".split(" "),function(E,n,F,w,k,v,x,y,z,h,q,A,r,B){function C(f,m){var c=[],b={};if(!f)return c;f.forEach(function(d){var e=
new r;e.read(d,m);b[e.id]=e;null!=d.parentLayerId&&-1!==d.parentLayerId?(d=b[d.parentLayerId],d.sublayers||(d.sublayers=[]),d.sublayers.unshift(e)):c.unshift(e)});return c}function t(f,m){f&&f.forEach(function(c){m(c);c.sublayers&&c.sublayers.length&&t(c.sublayers,m)})}Object.defineProperty(n,"__esModule",{value:!0});var D=z.getLogger("esri.layers.TileLayer"),u=v.ofType(r);n.forEachSublayer=t;n.SublayersOwner=function(f){return function(f){function c(){for(var b,d=[],e=0;e<arguments.length;e++)d[e]=
arguments[e];var a=f.apply(this,d)||this;a.allSublayers=new x({root:a,rootCollectionNames:["sublayers"],getChildrenFunction:function(a){return a.sublayers}});a.sublayersSourceJSON=(b={},b[2]={},b[3]={},b[4]={},b[5]={},b);a.watch("sublayers",function(b,d){return a._handleSublayersChange(b,d)},!0);return a}w(c,f);c.prototype.readSublayers=function(b,d){if(d&&b){var e=this.sublayersSourceJSON,a=q.nameToId(d.origin);2>a||(e[a]={context:d,visibleLayers:b.visibleLayers||e[a].visibleLayers,layers:b.layers||
e[a].layers},2<a||(this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers),d=this.createSublayersForOrigin("web-document"),b=d.sublayers,d=d.origin,e=A.getProperties(this),e.setDefaultOrigin(d),this._set("sublayers",new u(b)),e.setDefaultOrigin("user")))}};c.prototype.findSublayerById=function(b){return this.allSublayers.find(function(d){return d.id===b})};c.prototype.createServiceSublayers=function(){return this.createSublayersForOrigin("service").sublayers};c.prototype.createSublayersForOrigin=
function(b){var d="web-document"===b?q.nameToId("web-map"):q.nameToId(b),e=2;b=this.sublayersSourceJSON[2].layers;for(var a=this.sublayersSourceJSON[2].context,c=null,g=0,f=[3,4,5].filter(function(a){return a<=d});g<f.length;g++){var h=f[g],l=this.sublayersSourceJSON[h];B.isSublayerOverhaul(l.layers)&&(e=h,b=l.layers,a=l.context,l.visibleLayers&&(c={visibleLayers:l.visibleLayers,context:l.context}))}for(var k=null,g=0,f=[3,4,5].filter(function(a){return a>e&&a<=d});g<f.length;g++){var p=this.sublayersSourceJSON[f[g]],
h=p.layers,l=p.visibleLayers,p=p.context;h&&(k={layers:h,context:p});l&&(c={visibleLayers:l,context:p})}b=C(b,a);var m=new Map,n=new Set;if(k)for(a=0,g=k.layers;a<g.length;a++)f=g[a],m.set(f.id,f);if(c)for(a=0,g=c.visibleLayers;a<g.length;a++)n.add(g[a]);t(b,function(a){k&&a.read(m.get(a.id),k.context);c&&a.read({defaultVisibility:n.has(a.id)},c.context)});return{origin:q.idToName(e),sublayers:new u({items:b})}};c.prototype.read=function(b,d){this.inherited(arguments);this.readSublayers(b,d)};c.prototype._handleSublayersChange=
function(b,d){var c=this;d&&(d.forEach(function(a){a.parent=null;a.layer=null}),this.handles.remove("sublayers-owner"));b&&(b.forEach(function(a){a.parent=c;a.layer=c}),this.handles.add([b.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),b.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})],"sublayers-owner"),"tile"===this.type&&this.handles.add(b.on("before-changes",function(a){D.error(new y("tilelayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",
{layer:c}));a.preventDefault()}),"sublayers-owner"))};k([h.property({readOnly:!0})],c.prototype,"allSublayers",void 0);k([h.property({readOnly:!0,type:v.ofType(r)})],c.prototype,"serviceSublayers",void 0);k([h.property({value:null,type:u,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],c.prototype,"sublayers",void 0);k([h.property({readOnly:!0})],c.prototype,"sublayersSourceJSON",void 0);return c=k([h.subclass("esri.layers.mixins.SublayersOwner")],c)}(h.declared(f))}});