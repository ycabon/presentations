// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../kernel ../../request ../../core/arrayUtils ../../core/maybe ../../core/promiseUtils ../FeatureLayer ../../portal/Portal ../../portal/PortalItem".split(" "),function(m,n,g,e,u,t,x,k,q,v,y,z){Object.defineProperty(n,"__esModule",{value:!0});m=function(){function f(b,c){this.layer=b;this.signal=c;this.rootDocument=null;if(b=this.layer.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i))this.urlParts=
{root:b[1],layerId:parseInt(b[2],10)}}f.prototype.fetch=function(){return e(this,void 0,void 0,function(){var b,c,d;return g(this,function(a){switch(a.label){case 0:if(!this.urlParts||-1===["mesh-pyramids","points"].indexOf(this.layer.profile))return[2,null];if(!this.layer.portalItem)return[3,1];c=this.layer.portalItem;return[3,3];case 1:return[4,this.portalItemFromServiceItemId()];case 2:c=a.sent(),a.label=3;case 3:return b=c,k.isNone(b)?[2,this.loadFromUrl()]:[4,this.findAndLoadRelatedPortalItem(b)];
case 4:return d=a.sent(),k.isNone(d)?[2,null]:[2,this.loadFeatureLayerFromPortalItem(d)]}})})};f.prototype.fetchRootDocument=function(){return e(this,void 0,void 0,function(){var b,c,d;return g(this,function(a){switch(a.label){case 0:if(k.isSome(this.rootDocument))return[2,this.rootDocument];if(k.isNone(this.urlParts))return this.rootDocument={},[2,{}];b={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal};c=this.urlParts.root+"/SceneServer";a.label=1;case 1:return a.trys.push([1,
3,,4]),[4,t(c,b)];case 2:return d=a.sent(),this.rootDocument=d.data,[3,4];case 3:return a.sent(),this.rootDocument={},[3,4];case 4:return[2,this.rootDocument]}})})};f.prototype.fetchServiceOwningPortalUrl=function(){return e(this,void 0,void 0,function(){var b,c,d,a,w;return g(this,function(h){switch(h.label){case 0:if((b=u.id&&u.id.findServerInfo(this.layer.parsedUrl.path))&&b.owningSystemUrl)return[2,b.owningSystemUrl];c=this.layer.parsedUrl.path.replace(/(.*\/rest)\/.*/i,"$1")+"/info";h.label=
1;case 1:return h.trys.push([1,3,,4]),[4,t(c,{query:{f:"json"},responseType:"json",signal:this.signal})];case 2:return d=h.sent(),(a=d.data.owningSystemUrl)?[2,a]:[3,4];case 3:return w=h.sent(),q.throwIfAbortError(w),[3,4];case 4:return[2,null]}})})};f.prototype.findAndLoadRelatedPortalItem=function(b){return e(this,void 0,void 0,function(){var c,d;return g(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,b.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},
{signal:this.signal})];case 1:return c=a.sent(),[2,x.find(c,function(a){return"Feature Service"===a.type})||null];case 2:return d=a.sent(),q.throwIfAbortError(d),[2,null];case 3:return[2]}})})};f.prototype.loadFeatureLayerFromPortalItem=function(b){return e(this,void 0,void 0,function(){var c,d;return g(this,function(a){switch(a.label){case 0:return[4,b.load({signal:this.signal})];case 1:return a.sent(),[4,this.findMatchingAssociatedSublayerUrl(b.url)];case 2:return c=a.sent(),d=new v({url:c,portalItem:b}),
[2,d.load({signal:this.signal})]}})})};f.prototype.loadFromUrl=function(){return e(this,void 0,void 0,function(){var b,c;return g(this,function(d){switch(d.label){case 0:return[4,this.findMatchingAssociatedSublayerUrl(this.urlParts.root+"/FeatureServer")];case 1:return b=d.sent(),c=new v({url:b}),[2,c.load({signal:this.signal})]}})})};f.prototype.findMatchingAssociatedSublayerUrl=function(b){return e(this,void 0,void 0,function(){var c,d,a,f,h,e,k,m,r,l,p,n;return g(this,function(g){switch(g.label){case 0:return c=
b.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),d={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal},a=this.urlParts.layerId,f=this.fetchRootDocument(),h=t(c,d),[4,q.all([h,f])];case 1:e=g.sent();k=e[0];r=(m=e[1])&&m.layers;l=k.data&&k.data.layers;if(!Array.isArray(l))throw Error("expected layers array");if(Array.isArray(r))for(p=0;p<Math.min(r.length,l.length);p++){if(n=r[p],n.id===a)return[2,c+"/"+l[p].id]}else if(a<l.length)return[2,c+"/"+l[a].id];throw Error("could not find matching associated sublayer");
}})})};f.prototype.portalItemFromServiceItemId=function(){return e(this,void 0,void 0,function(){var b,c,d,a;return g(this,function(e){switch(e.label){case 0:return[4,this.fetchRootDocument()];case 1:b=e.sent();c=b.serviceItemId;if(!c)return[2,null];d=new z({id:c});return[4,this.fetchServiceOwningPortalUrl()];case 2:a=e.sent();k.isSome(a)&&(d.portal=new y({url:a}));try{return[2,d.load({signal:this.signal})]}catch(h){return q.throwIfAbortError(h),[2,null]}}})})};return f}();n.FetchAssociatedFeatureLayer=
m});