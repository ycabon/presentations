// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/compilerUtils ../../core/Error ../../core/JSONSupport ../../core/lang ../../core/Logger ../../core/accessorSupport/decorators".split(" "),function(y,z,r,l,t,u,v,w,x,h){var m=x.getLogger("esri.layers.support.PixelBlock");return function(p){function c(b){b=p.call(this,b)||this;b.width=null;b.height=null;b.pixelType="f32";b.validPixelCount=null;b.mask=null;b.maskIsAlpha=!1;b.pixels=null;b.statistics=
null;return b}r(c,p);n=c;c.createEmptyBand=function(b,a){return new (n.getPixelArrayConstructor(b))(a)};c.getPixelArrayConstructor=function(b){var a;switch(b){case "u1":case "u2":case "u4":case "u8":a=Uint8Array;break;case "u16":a=Uint16Array;break;case "u32":a=Uint32Array;break;case "s8":a=Int8Array;break;case "s16":a=Int16Array;break;case "s32":a=Int32Array;break;case "u32":a=Uint32Array;break;case "f32":a=Float32Array;break;case "f64":a=Float64Array;break;case "c64":case "c128":case "unknown":a=
Float32Array;break;default:t.neverReached(b)}return a};c.prototype.castPixelType=function(b){if(!b)return"f32";b=b.toLowerCase();-1<["u1","u2","u4"].indexOf(b)?b="u8":-1==="unknown u8 s8 u16 s16 u32 s32 f32 f64".split(" ").indexOf(b)&&(b="f32");return b};c.prototype.getPlaneCount=function(){return this.pixels&&this.pixels.length};c.prototype.addData=function(b){if(!b.pixels||b.pixels.length!==this.width*this.height)throw new u("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");
this.pixels||(this.pixels=[]);this.statistics||(this.statistics=[]);this.pixels.push(b.pixels);this.statistics.push(b.statistics||{minValue:null,maxValue:null})};c.prototype.getAsRGBA=function(){var b=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case "s8":case "s16":case "u16":case "s32":case "u32":case "f32":case "f64":this._fillFromNon8Bit(b);break;default:this._fillFrom8Bit(b)}return new Uint8ClampedArray(b)};c.prototype.getAsRGBAFloat=function(){var b=new Float32Array(this.width*
this.height*4);this._fillFrom32Bit(b);return b};c.prototype.updateStatistics=function(){var b=this;this.statistics=this.pixels.map(function(a){return b._calculateBandStatistics(a,b.mask)});var a=this.mask,d=0;if(a)for(var g=0;g<a.length;g++)a[g]&&d++;else d=this.width*this.height;this.validPixelCount=d};c.prototype.clamp=function(b){if(b&&"f64"!==b&&"f32"!==b){var a;switch(b){case "u8":a=[0,255];break;case "u16":a=[0,65535];break;case "u32":a=[0,4294967295];break;case "s8":a=[-128,127];break;case "s16":a=
[-32768,32767];break;case "s32":a=[-2147483648,2147483647];break;default:a=[-3.4*1E39,3.4*1E39]}var d=a[0];a=a[1];for(var g=this.pixels,k=this.width*this.height,e=g.length,f,c,h,q=[],l=0;l<e;l++){h=n.createEmptyBand(b,k);f=g[l];for(var m=0;m<k;m++)c=f[m],h[m]=c>a?a:c<d?d:c;q.push(h)}this.pixels=q;this.pixelType=b}};c.prototype.clone=function(){var b=new n({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});this.mask&&(b.mask=
this.mask instanceof Uint8Array?new Uint8Array(this.mask):this.mask.slice(0));var a,d=n.getPixelArrayConstructor(this.pixelType);if(this.pixels&&0<this.pixels.length){b.pixels=[];var g=this.pixels[0].slice;for(a=0;a<this.pixels.length;a++)b.pixels[a]=g?this.pixels[a].slice(0,this.pixels[a].length):new d(this.pixels[a])}if(this.statistics)for(b.statistics=[],a=0;a<this.statistics.length;a++)b.statistics[a]=w.clone(this.statistics[a]);return b};c.prototype._fillFrom8Bit=function(b){var a=this.mask,
d=this.maskIsAlpha,g=this.pixels;if(b&&g&&g.length){var k,e,f;k=e=f=g[0];3<=g.length?(e=g[1],f=g[2]):2===g.length&&(e=g[1]);b=new Uint32Array(b);g=this.width*this.height;if(k.length!==g)m.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");else if(a&&a.length===g)if(d)for(d=0;d<g;d++)a[d]&&(b[d]=a[d]<<24|f[d]<<16|e[d]<<8|k[d]);else for(d=0;d<g;d++)a[d]&&(b[d]=-16777216|f[d]<<16|e[d]<<8|k[d]);else for(d=0;d<g;d++)b[d]=-16777216|f[d]<<16|e[d]<<8|k[d]}else m.error("getAsRGBA()",
"Unable to convert to RGBA. The input pixel block is empty.")};c.prototype._fillFromNon8Bit=function(b){var a=this.pixels,d=this.mask,g=this.statistics;if(b&&a&&a.length){var k=this.pixelType,e=1,f=0,e=1;g&&0<g.length?(f=g.map(function(a){return a.minValue}).reduce(function(a,b){return Math.min(a,b)}),e=g.map(function(a){return a.maxValue-a.minValue}).reduce(function(a,b){return Math.max(a,b)}),e=255/e):(e=255,"s8"===k?(f=-128,e=127):"u16"===k?e=65535:"s16"===k?(f=-32768,e=32767):"u32"===k?e=4294967295:
"s32"===k?(f=-2147483648,e=2147483647):"f32"===k?(f=-3.4*1E39,e=3.4*1E39):"f64"===k&&(f=-Number.MAX_VALUE,e=Number.MAX_VALUE),e=255/(e-f));b=new Uint32Array(b);var k=this.width*this.height,c,h,g=c=h=a[0];if(g.length!==k)return m.error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(2<=a.length)if(c=a[1],3<=a.length&&(h=a[2]),d&&d.length===k)for(a=0;a<k;a++)d[a]&&(b[a]=-16777216|(h[a]-f)*e<<16|(c[a]-f)*e<<8|(g[a]-f)*e);else for(a=0;a<k;a++)b[a]=-16777216|(h[a]-f)*e<<16|(c[a]-
f)*e<<8|(g[a]-f)*e;else if(d&&d.length===k)for(a=0;a<k;a++)c=(g[a]-f)*e,d[a]&&(b[a]=-16777216|c<<16|c<<8|c);else for(a=0;a<k;a++)c=(g[a]-f)*e,b[a]=-16777216|c<<16|c<<8|c}else m.error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.")};c.prototype._fillFrom32Bit=function(b){var a=this.pixels,d=this.mask;if(!b||!a||!a.length)return m.error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");var g,c,e;g=c=e=a[0];3<=a.length?(c=a[1],e=a[2]):2===a.length&&
(c=a[1]);var f=this.width*this.height;if(g.length!==f)return m.error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");var h=0;if(d&&d.length===f)for(a=0;a<f;a++)b[h++]=g[a],b[h++]=c[a],b[h++]=e[a],b[h++]=d[a]&1;else for(a=0;a<f;a++)b[h++]=g[a],b[h++]=c[a],b[h++]=e[a],b[h++]=1};c.prototype._calculateBandStatistics=function(b,a){var d=Infinity,c=-Infinity,h=b.length,e,f=0;if(a)for(e=0;e<h;e++)a[e]&&(f=b[e],d=f<d?f:d,c=f>c?f:c);else for(e=0;e<h;e++)f=b[e],d=f<d?f:d,c=f>c?f:
c;return{minValue:d,maxValue:c}};var n;l([h.property({json:{write:!0}})],c.prototype,"width",void 0);l([h.property({json:{write:!0}})],c.prototype,"height",void 0);l([h.property({json:{write:!0}})],c.prototype,"pixelType",void 0);l([h.cast("pixelType")],c.prototype,"castPixelType",null);l([h.property({json:{write:!0}})],c.prototype,"validPixelCount",void 0);l([h.property({json:{write:!0}})],c.prototype,"mask",void 0);l([h.property({json:{write:!0}})],c.prototype,"maskIsAlpha",void 0);l([h.property({json:{write:!0}})],
c.prototype,"pixels",void 0);l([h.property({json:{write:!0}})],c.prototype,"statistics",void 0);return c=n=l([h.subclass("esri.layers.support.PixelBlock")],c)}(h.declared(v.JSONSupport))});