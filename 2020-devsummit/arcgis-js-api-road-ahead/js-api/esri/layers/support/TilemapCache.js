// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../request ../../core/Accessor ../../core/Error ../../core/Handles ../../core/Logger ../../core/LRUCache ../../core/PooledArray ../../core/promiseUtils ../../core/scheduling ../../core/urlUtils ../../core/watchUtils ../../core/accessorSupport/decorators ./Tilemap".split(" "),function(h,n,x,
z,l,A,B,C,D,r,E,F,G,H,k,I,J,K,f,p){Object.defineProperty(n,"__esModule",{value:!0});n.TILEMAP_SIZE_EXP=5;var L=F.getLogger("esri.layers.support.TilemapCache");h=function(h){function b(a){a=h.call(this,a)||this;a._handles=new E;a._pendingTilemapRequests={};a._availableLevels={};a.levels=5;a.cacheByteSize=2097152;a.request=C;a._prefetchingEnabled=!0;return a}z(b,h);q=b;b.prototype.initialize=function(){var a=this;this._tilemapCache=new G(this.cacheByteSize);this._handles.add([this.watch(["layer.parsedUrl",
"layer.tileServers?"],function(){return a._initializeTilemapDefinition()}),K.init(this,"layer.tileInfo.lods",function(e){return a._initializeAvailableLevels(e)},!0)]);this._initializeTilemapDefinition()};b.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)};b.prototype.castLevels=function(a){return 2>=a?(L.error("Minimum levels for Tilemap is 3, but got ",a),3):a};Object.defineProperty(b.prototype,"size",{get:function(){return 1<<this.levels},enumerable:!0,configurable:!0});
b.prototype.fetchTilemap=function(a,e,b,c){var d=this;if(!this._availableLevels[a])return k.reject(new r("tilemap-cache:level-unavailable","Level "+a+" is unavailable in the service"));var f=this._tmpTilemapDefinition;if(a=this._tilemapFromCache(a,e,b,f))return k.resolve(a);var v=c&&c.signal;c=x({},c,{signal:null});return k.create(function(a,e){k.onAbort(v,function(){return e(k.createAbortError())});var b=p.tilemapDefinitionId(f),m=d._pendingTilemapRequests[b];if(!m){var m=p.Tilemap.fromDefinition(f,
c).then(function(a){d._tilemapCache.put(b,a,a.byteSize);return a}),g=function(){return delete d._pendingTilemapRequests[b]};d._pendingTilemapRequests[b]=m;m.then(g,g)}m.then(a,e)})};b.prototype.getAvailability=function(a,e,b){return this._availableLevels[a]?(a=this._tilemapFromCache(a,e,b,this._tmpTilemapDefinition))?a.getAvailability(e,b):"unknown":"unavailable"};b.prototype.getAvailabilityUpsample=function(a,e,b,c){c.level=a;c.row=e;c.col=b;a=this.layer.tileInfo;for(a.updateTileInfo(c);;)if(e=this.getAvailability(c.level,
c.row,c.col),"unavailable"===e){if(!a.upsampleTile(c))return"unavailable"}else return e};b.prototype.fetchAvailability=function(a,b,d,c){return this._availableLevels[a]?this.fetchTilemap(a,b,d,c).catch(function(a){return a}).then(function(c){if(c instanceof p.Tilemap)return c=c.getAvailability(b,d),"unavailable"===c?k.reject(new r("tile-map:tile-unavailable","Tile is not available",{level:a,row:b,col:d})):c;if(k.isAbortError(c))throw c;return"unknown"}):k.reject(new r("tilemap-cache:level-unavailable",
"Level "+a+" is unavailable in the service"))};b.prototype.fetchAvailabilityUpsample=function(a,b,d,c,f){var e=this;c.level=a;c.row=b;c.col=d;var v=this.layer.tileInfo;v.updateTileInfo(c);var g=this.fetchAvailability(a,b,d,f).catch(function(a){if(k.isAbortError(a))throw a;if(v.upsampleTile(c))return e.fetchAvailabilityUpsample(c.level,c.row,c.col,c);throw a;});this._fetchAvailabilityUpsamplePrefetch(c.id,a,b,d,f,g);return g};b.prototype._fetchAvailabilityUpsamplePrefetch=function(a,b,d,c,f,l){return B(this,
void 0,void 0,function(){var e,g,h,m,t,n,p,r,y,w;return A(this,function(u){switch(u.label){case 0:if(!this._prefetchingEnabled)return[2];e="prefetch-"+a;if(this._handles.has(e))return[2];g=k.createAbortController();l.then(function(){return g.abort()},function(){return g.abort()});h=!1;m={remove:function(){h||(h=!0,g.abort())}};this._handles.add(m,e);u.label=1;case 1:return u.trys.push([1,3,,4]),[4,I.waitTicks(10,g.signal)];case 2:return u.sent(),[3,4];case 3:return u.sent(),[3,4];case 4:h||(h=!0,
this._handles.remove(e));if(k.isAborted(g))return[2];t={id:a,level:b,row:d,col:c};n=x({},f,{signal:g.signal});p=this.layer.tileInfo;r=function(a){var b=y.fetchAvailability(t.level,t.row,t.col,n);q._prefetches.push(b);a=function(){q._prefetches.removeUnordered(b)};b.then(a,a)};y=this;for(w=0;q._prefetches.length<q._maxPrefetch&&p.upsampleTile(t);++w)r(w);return[2]}})})};b.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var a=this.layer.parsedUrl,b=a.query;this._tilemapCache.clear();
this._tmpTilemapDefinition={service:{url:a.path,query:b?J.objectToQuery(b):null,tileServers:this.layer.tileServers,request:this.request,type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}};b.prototype._tilemapFromCache=function(a,b,d,c){a=this._getTilemapDefinition(a,b,d,c);a=p.tilemapDefinitionId(a);return this._tilemapCache.get(a)};b.prototype._getTilemapDefinition=function(a,b,d,c){c.level=a;a=a>n.TILEMAP_SIZE_EXP;c.row=a?b-b%this.size:b;c.col=a?d-d%this.size:d;return c};
b.prototype._initializeAvailableLevels=function(a){var b=this;this._availableLevels={};a&&a.forEach(function(a){return b._availableLevels[a.level]=!0})};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{get prefetchingEnabled(){return a._prefetchingEnabled},set prefetchingEnabled(b){a._prefetchingEnabled=b},hasTilemap:function(b,d,c){return!!a._tilemapFromCache(b,d,c,a._tmpTilemapDefinition)}}},enumerable:!0,configurable:!0});var q;b._maxPrefetch=4;b._prefetches=new H({initialSize:q._maxPrefetch});
l([f.property({constructOnly:!0,type:Number})],b.prototype,"levels",void 0);l([f.cast("levels")],b.prototype,"castLevels",null);l([f.property({readOnly:!0,dependsOn:["levels"],type:Number})],b.prototype,"size",null);l([f.property({constructOnly:!0,type:Number})],b.prototype,"cacheByteSize",void 0);l([f.property({constructOnly:!0})],b.prototype,"layer",void 0);l([f.property({constructOnly:!0})],b.prototype,"request",void 0);return b=q=l([f.subclass("esri.layers.support.TilemapCache")],b)}(f.declared(D));
n.TilemapCache=h});