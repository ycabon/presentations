// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/assignHelper ../../../geometry ../../../request ../../../core/Error ../../../core/JSONSupport ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators ../commonProperties ../TileInfo ./RawBlockCache ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper".split(" "),
function(ba,ca,R,w,E,n,H,L,S,J,T,U,V,W,X,t,Y,Z,O,aa,P,u){return function(I){function c(){var a=null!==I&&I.apply(this,arguments)||this;a.rasterJobHandler=null;a.datasetName=null;a.datasetFormat=null;a.rasterInfo=null;a.ioConfig={bandIds:null,sampling:"closest"};return a}R(c,I);c.prototype.init=function(){return n(this,void 0,void 0,function(){var a;return E(this,function(d){switch(d.label){case 0:return a=u.load(),this.addResolvingPromise(a),[4,this.when()];case 1:return d.sent(),[2]}})})};c.prototype.normalizeCtorArgs=
function(a){a&&a.ioConfig&&(a=H({},a,{ioConfig:H({resolution:null,bandIds:null,sampling:"closest",tileInfo:Z.create()},a.ioConfig)}));return a};Object.defineProperty(c.prototype,"url",{set:function(a){a=X.urlToObject(a);this._set("url",a.path)},enumerable:!0,configurable:!0});c.prototype.open=function(a){return n(this,void 0,void 0,function(){return E(this,function(a){throw new J("BaseRaster:open-not-implemented","open() is not implemented");})})};c.prototype.fetchTile=function(a,d,l,g){void 0===
g&&(g={});return n(this,void 0,void 0,function(){var e,f,b,h;return E(this,function(q){e=g.tileInfo;f=e.lodAt(a);b=new L.Point({x:f.resolution,y:f.resolution,spatialReference:e.spatialReference});h=this._getTileExtent(b,d,l,e);return[2,this.fetchPixels(h,e.size[0],e.size[1],g)]})})};c.prototype.identify=function(a,d){void 0===d&&(d={});return n(this,void 0,void 0,function(){var l,g,e,f,b,h,q,k,c,x,v,F,p,r,z;return E(this,function(m){switch(m.label){case 0:l=this.rasterInfo;g=l.spatialReference;e=
l.extent;f=d.datumTransformation;b=u.projectPoint(a,g,f);if(!e.intersects(b))return[2,{location:b,value:null}];h=0;if(!d.srcResolution)return[3,1];q=u.snapPyramid(d.srcResolution,this.rasterInfo,this.ioConfig.sampling);h=q.pyramidLevel;return[3,3];case 1:return[4,this.computeBestPyramidLevelForLocation(a,d)];case 2:h=m.sent();if(null==h)return[2,{location:b,value:null}];m.label=3;case 3:k=this.identifyPixelLocation(b,h,null);if(null===k)return[2,{location:b,value:null}];c=k.row;x=k.col;v=k.rowOffset;
F=k.colOffset;return[4,this.fetchRawTile(h,c,x,d)];case 4:p=m.sent();if(!(p.pixels&&0<p.pixels.length))return[2,{location:b,value:null}];r=v*this.rasterInfo.storageInfo.blockHeight+F;z=!p.mask||p.mask[r]?p.pixels.map(function(a){return a[r]}):null;return[2,{location:b,value:z,pyramidLevel:h}]}})})};c.prototype.fetchPixels=function(a,d,l,g){void 0===g&&(g={});return n(this,void 0,void 0,function(){var e,f,b,h,q,k,c,x,v,F,p,r,z,n,t,y,w,Q,K,D,G,A,B,C;return E(this,function(m){switch(m.label){case 0:e=
a.clone().normalize();a=e[0];f=this.rasterInfo.spatialReference;b=!a.spatialReference.equals(f);h=g.datumTransformation;q=new L.Point({x:(a.xmax-a.xmin)/d,y:(a.ymax-a.ymin)/l,spatialReference:a.spatialReference});k=g.srcResolution||(b?u.projectResolution(q,f,a,h):q);if(!k)return[2,null];c=u.snapPyramid(k,this.rasterInfo,this.ioConfig.sampling);x=c.pyramidLevel;v=c.pyramidResolution;if(F=c.excessiveReading)return[2,null];p=this.rasterInfo.storageInfo;r=b?u.projectExtent(a,f,h):a;z={x:Math.floor((r.xmin-
p.origin.x)/v.x+.1),y:Math.floor((p.origin.y-r.ymax)/v.y+.1)};n=Math.ceil((r.xmax-r.xmin)/v.x-.1);t=Math.ceil((r.ymax-r.ymin)/v.y-.1);return 8<n/d||8<t/l?[2,null]:[4,this.fetchRawPixels(x,z,{width:n,height:t},g)];case 1:y=m.sent();if(!y)return[2,null];w=0<x?p.pyramidBlockWidth:p.blockWidth;Q=0<x?p.pyramidBlockHeight:p.blockHeight;if(K=!b&&1===y.pixelBlocks.length&&w===d&&Q===l&&k.x===q.x&&k.y===q.y)return[2,{extent:a,srcExtent:r,pixelBlock:y.pixelBlocks[0],transformGrid:null}];D=u.getProjectionOffsetGrid(a,
y.extent,q,h);A=!g.requestRawData;B={rows:D.spacing[0],cols:D.spacing[1]};return this.rasterJobHandler?[4,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:y.pixelBlocks,srcMosaicSize:y.mosaicSize,destDimension:A?{width:d,height:l}:null,coefs:A?D.coefficients:null,sampleSpacing:A?B:null},g)]:[3,3];case 2:return G=m.sent(),[3,4];case 3:C=P.mosaic(y.pixelBlocks,y.mosaicSize),G=A?P.approximateTransform(C,{width:d,height:l},D.coefficients,B):C,m.label=4;case 4:return[2,{srcExtent:r,pixelBlock:G,
transformGrid:D,extent:a}]}})})};c.prototype.fetchRawPixels=function(a,d,l,g){return n(this,void 0,void 0,function(){var e,f,b,h,c,k,m,x,v,F,p,r,z,n,t,y,w,u,K,D,G,A,B,C,H,I,M,N,J;return E(this,function(q){switch(q.label){case 0:e=this.rasterInfo.storageInfo;f=e.origin;b=e.blockBoundary;h=0<a?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth;c=0<a?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;k=Math.floor(d.x/h);m=Math.floor(d.y/
c);x=Math.floor((d.x+l.width-1)/h);v=Math.floor((d.y+l.height-1)/c);F=this.rasterInfo;p=F.pixelSize;r=F.spatialReference;z=b[a];if(!z)return[2,null];n=z.minRow;t=z.minCol;y=z.maxCol;w=z.maxRow;if(v<n||x<t||m>w||k>y)return[2,null];u=[];K=this.url;D=g.registryId;for(B=m;B<=v;B++)for(C=k;C<=x;C++)B>=n&&C>=t&&w>=B&&y>=C?(G=a+"/"+B+"/"+C,A=O.getBlock(K,D,G),U.isSome(A)||(A=this.fetchRawTile(a,B,C,g),O.putBlock(K,D,G,A)),u.push(A)):u.push(null);return 0===u.length?[2,null]:[4,W.all(u)];case 1:return H=
q.sent(),I={height:(v-m+1)*h,width:(x-k+1)*c},M=p.x*Math.pow(2,a),N=p.y*Math.pow(2,a),J=new L.Extent({xmin:f.x+k*h*M,xmax:f.x+(x+1)*h*M,ymin:f.y-(v+1)*c*N,ymax:f.y-m*c*N,spatialReference:r}),[2,{extent:J,pixelBlocks:H,mosaicSize:I}]}})})};c.prototype.fetchRawTile=function(a,d,c,g){return n(this,void 0,void 0,function(){return E(this,function(a){throw new J("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");})})};c.prototype.decodePixelBlock=function(a,d){return this.rasterJobHandler?
this.rasterJobHandler.decode({data:a,options:d}):aa.decode(a,d)};c.prototype.request=function(a,d){return n(this,void 0,void 0,function(){var c,g,e,f,b,h,q;return E(this,function(k){switch(k.label){case 0:c=this.ioConfig.customFetchParameters,g=a.url,e=a.range,f=a.query,b=a.responseType,null==a.retryCount&&this.ioConfig.retryCount&&(a.retryCount=this.ioConfig.retryCount),h=e?{Range:"bytes\x3d"+e.from+"-"+e.to}:null,k.label=1;case 1:return k.trys.push([1,3,,4]),[4,S(g,{query:H({},f,c),headers:h,responseType:b,
signal:d})];case 2:return q=k.sent().data,[2,q];case 3:return k.sent(),0<a.retryCount?(a.retryCount--,[2,this.request(a,d)]):[2,null];case 4:return[2]}})})};c.prototype.getSliceIndex=function(a){var d=this.rasterInfo.multidimensionalInfo;if(!d||0===a.length)return null;for(var c=0,g=a[0].variableName,e=function(b){b=d.variables[b];var e=b.dimensions;if(b.name!==g)return c+=e.map(function(a){return a.values.length}).reduce(function(a,c){return a+c}),"break";var k=e.map(function(a){return a.values.length}),
f=e.length;b=function(d){var b=a.filter(function(a){return a.dimensionName===e[d].name})[0];if(null==b)return{value:null};b=Array.isArray(b.values[0])?b.values[0][0]:b.values[0];b=e[d].values.indexOf(b);if(-1===b)return{value:null};k.shift();c=d===f-1?c+b:c+b*k.reduce(function(a,b){return a+b})};for(var h=0;h<f;h++){var l=b(h);if("object"===typeof l)return l}},f=0;f<d.variables.length;f++){var b=e(f);if("object"===typeof b)return b.value;if("break"===b)break}return c};c.prototype.computeBestPyramidLevelForLocation=
function(a,d){void 0===d&&(d={});return n(this,void 0,void 0,function(){return E(this,function(a){return[2,0]})})};c.prototype.identifyPixelLocation=function(a,d,c){var g=this.rasterInfo,e=g.pixelSize,f=g.extent,b=this.rasterInfo.storageInfo,h=b.blockWidth,l=b.blockHeight,k=b.maximumPyramidLevel,m=b.pyramidScalingFactor,n=b.origin,b=b.blockBoundary;a=u.projectPoint(a,g.spatialReference,c);if(!f.intersects(a)||0>d||d>k)return null;f=Math.pow(m,d);m=b[d];k=Math.max(m.minRow,Math.min(m.maxRow,(n.y-a.y)/
(f*e.y)/l));e=Math.max(m.minCol,Math.min(m.maxCol,(a.x-n.x)/(f*e.x)/h));return{pyramidLevel:d,row:Math.floor(k),col:Math.floor(e),rowOffset:Math.min(l-1,Math.floor((k-Math.floor(k))*l)),colOffset:Math.min(h-1,Math.floor((e-Math.floor(e))*h)),srcLocation:a}};c.prototype._getTileExtent=function(a,c,l,g){var d=g.origin,f=g.size[0],b=g.size[1];l=d.x+l*f*a.x;c=d.y-c*b*a.y;return new L.Extent({xmin:l,xmax:l+f*a.x,ymin:c-b*a.y,ymax:c,spatialReference:g.spatialReference})};w([t.property(Y.url)],c.prototype,
"url",null);w([t.property({type:String,json:{write:!0}})],c.prototype,"datasetName",void 0);w([t.property({type:String,json:{write:!0}})],c.prototype,"datasetFormat",void 0);w([t.property()],c.prototype,"rasterInfo",void 0);w([t.property()],c.prototype,"ioConfig",void 0);return c=w([t.subclass("esri.layers.support.rasterDatasets.BaseRaster")],c)}(t.declared(V.EsriPromiseMixin(T.JSONSupport)))});