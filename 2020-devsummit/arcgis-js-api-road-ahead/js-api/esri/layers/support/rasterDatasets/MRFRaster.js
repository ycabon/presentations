// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/declareExtendsHelper ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../PixelBlock ../RasterInfo ../RasterStorageInfo ./BaseRaster ./xmlUtilities".split(" "),function(U,V,K,A,L,M,B,y,N,O,v,P,Q,R,S,d){var T=function(){var d=new ArrayBuffer(4),b=new Uint8Array(d);
(new Uint32Array(d))[0]=1;return 1===b[0]}(),g=new Map;g.set("Int8","s8");g.set("UInt8","u8");g.set("Int16","s16");g.set("UInt16","u16");g.set("Int32","s32");g.set("UInt32","u32");g.set("Float32","f32");g.set("Float64","f32");g.set("Double64","f32");var C=new Map;C.set("lerc",".lrc");C.set("none",".til");C.set("deflate",".pzp");C.set("jpeg",".jzp");return function(E){function b(){var a=null!==E&&E.apply(this,arguments)||this;a._files=null;a._storageIndex=null;return a}M(b,E);b.prototype.open=function(a){return L(this,
void 0,void 0,function(){var c,F,h,k,e,n,f,w,x,r,m,t,q,p,d,I,b,g,G,D,l;return K(this,function(u){switch(u.label){case 0:return[4,this.init()];case 1:return u.sent(),this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),c=a?N.unwrap(a.signal):null,[4,this.request({url:this.url,responseType:"xml"},c)];case 2:return F=u.sent(),h=this._parseHeader(F),k=h.rasterInfo,e=h.files,this._set("rasterInfo",k),this._files=e,[4,this.request({url:e.index,responseType:"array-buffer"},c)];case 3:n=u.sent();
this._storageIndex=this._parseIndex(n);f=0;w=-1;m=this.rasterInfo.storageInfo;t=m.blockWidth;q=m.blockHeight;p=m.compression;d=this.rasterInfo.storageInfo.pyramidScalingFactor;I=this.rasterInfo;b=I.width;g=I.height;G=I.bandCount;D=[];for(l="none"===p?1:G;f<this._storageIndex.length;)w++,x=Math.ceil(b/t/Math.pow(d,w)),r=Math.ceil(g/q/Math.pow(d,w)),f+=x*r*l*4,D.push({maxRow:r,maxCol:x,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=D;0<w&&(this.rasterInfo.storageInfo.firstPyramidLevel=
1,this.rasterInfo.storageInfo.maximumPyramidLevel=w);return[2]}})})};b.prototype.fetchRawTile=function(a,c,F,h){void 0===h&&(h={});return L(this,void 0,void 0,function(){var k,e,n,f,d,x,r,m,t,q,p,u,b,g,y,G,D,l,v,C,A,B,E,J,z,H;return K(this,function(w){switch(w.label){case 0:k=this.rasterInfo.storageInfo;e=k.blockWidth;n=k.blockHeight;f=k.blockBoundary;d=k.compression;x=f[a];if(!x||x.maxRow<c||x.maxCol<F||x.minRow>c||x.minCol>F)return[2,null];r=this.rasterInfo;m=r.bandCount;t=r.pixelType;q=this._getTileLocation(a,
c,F);p=q.ranges;u=q.actualTileWidth;b=q.actualTileHeight;if(!p||0===p.length)return[2,null];if(0===p[0].from&&0===p[0].to)return g=new Uint8Array(e*n),[2,new P({width:e,height:n,pixels:null,mask:g,validPixelCount:0})];y=this.ioConfig.bandIds;G="none"===d?1:m;D=[];for(l=l=0;l<G;l++)(!y||-1<y.indexOf[l])&&D.push(this.request({url:this._files.data,range:{from:p[l].from,to:p[l].to},responseType:"array-buffer"},h.signal));return[4,O.all(D)];case 1:v=w.sent();C=v.map(function(a){return a.byteLength}).reduce(function(a,
c){return a+c});A=new Uint8Array(C);for(l=B=0;l<G;l++)A.set(new Uint8Array(v[l]),B),B+=v[l].byteLength;E="lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip";return[4,this.decodePixelBlock(A.buffer,{width:e,height:n,format:E,pixelType:t})];case 2:J=w.sent();H=z=0;if(u!==e||b!==n)if(g=J.mask)for(l=0;l<n;l++)for(H=l*e,z=l<b?u:0;z<e;z++)g[H+z]=0;else for(g=new Uint8Array(e*n),J.mask=g,l=0;l<b;l++)for(H=l*e,z=0;z<u;z++)g[H+z]=1;return[2,J]}})})};b.prototype._parseIndex=function(a){if(0<a.byteLength%
16)throw"invalid array buffer must be multiples of 16";var c,d,h,k,e;if(T){c=new Uint8Array(a);h=new ArrayBuffer(a.byteLength);d=new Uint8Array(h);for(k=0;k<a.byteLength/4;k++)for(e=0;4>e;e++)d[4*k+e]=c[4*k+3-e];a=new Uint32Array(h)}else a=new Uint32Array(a);return a};b.prototype._getTileLocation=function(a,c,d){var h=this.rasterInfo.storageInfo,k=h.blockWidth,e=h.blockHeight,n=h.pyramidScalingFactor,f=this.rasterInfo,b=f.width,g=f.height,f=f.bandCount,h="none"===h.compression?1:f,r,m,t=0,q=0;for(m=
0;m<a;m++)q=Math.pow(n,m),f=Math.ceil(b/k/q),r=Math.ceil(g/e/q),t+=f*r;q=Math.pow(n,a);f=Math.ceil(b/k/q);r=Math.ceil(g/e/q);t=4*(t+(c*f+d))*h;a=this._storageIndex.subarray(t,t+4*h);m=n=0;for(var t=[],p=0;p<h;p++)n=a[4*p+0]*Math.pow(2,32)+a[4*p+1],m=n+a[4*p+2]*Math.pow(2,32)+a[4*p+3],t.push({from:n,to:m});return{ranges:t,actualTileWidth:d<f-1?k:Math.ceil(b/q)-k*(f-1),actualTileHeight:c<r-1?e:Math.ceil(g/q)-e*(r-1)}};b.prototype._parseHeader=function(a){var c=d.getElement(a,"MRF_META/Raster");if(!c)throw new y("mrf:open",
"not a valid MRF format");var b=d.getElement(c,"Size"),h=parseInt(b.getAttribute("x"),10),k=parseInt(b.getAttribute("y"),10),e=parseInt(b.getAttribute("c"),10),b=(d.getElementValue(c,"Compression")||"none").toLowerCase(),n=["none","lerc"];if(!b||-1===n.indexOf(b))throw new y("mrf:open","currently does not support compression "+b);var f=d.getElementValue(c,"DataType")||"UInt8",n=g.get(f);if(null==n)throw new y("mrf:open","currently does not support pixel type "+f);var w=d.getElement(c,"PageSize"),
f=parseInt(w.getAttribute("x"),10),w=parseInt(w.getAttribute("y"),10),c=d.getElement(c,"DataValues"),x;c&&(c=c.getAttribute("NoData"),null!=c&&(x=c.trim().split(" ").map(function(a){return parseFloat(a)})));if(d.getElement(a,"MRF_META/CachedSource"))throw new y("mrf:open","currently does not support MRF referencing other data files");var r=d.getElement(a,"MRF_META/GeoTags"),m=d.getElement(r,"BoundingBox");if(null==m)throw new y("mrf:open","missing node MRF_META/GeoTags/BoundingBox");var c=parseFloat(m.getAttribute("minx")),
t=parseFloat(m.getAttribute("miny")),q=parseFloat(m.getAttribute("maxx")),p=parseFloat(m.getAttribute("maxy")),u=d.getElementValue(r,"Projection"),r=d.getElementValue(a,"datafile"),m=d.getElementValue(a,"IndexFile"),v;"LOCAL_CS[]"!==u&&(v=new B.SpatialReference({wkt:u}));u=new B.Extent(c,t,q,p);u.spatialReference=v;a=d.getElement(a,"MRF_META/Rsets");a=parseInt(a&&a.getAttribute("scale")||"2",10);a=new R({origin:new B.Point({x:u.xmin,y:u.ymax,spatialReference:v}),blockWidth:f,blockHeight:w,pyramidBlockWidth:f,
pyramidBlockHeight:w,compression:b,pyramidScalingFactor:a});f=new B.Point({x:(q-c)/h,y:(p-t)/k,spatialReference:v});h=new Q({width:h,height:k,extent:u,spatialReference:v,bandCount:e,pixelType:n,pixelSize:f,noDataValue:x,storageInfo:a});k={mrf:this.url,index:m||this.url.replace(".mrf",".idx"),data:r||this.url.replace(".mrf",C.get(b))};return{rasterInfo:h,files:k}};A([v.property()],b.prototype,"_files",void 0);A([v.property()],b.prototype,"_storageIndex",void 0);A([v.property({type:String,json:{write:!0}})],
b.prototype,"datasetFormat",void 0);return b=A([v.subclass("esri.layers.support.rasterIO.MRFRaster")],b)}(v.declared(S))});