// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../geometry","../rasterFunctions/rasterProjectionHelper"],function(u,h,r,m){function t(b,a){if(!c.has(b))return null;b=c.get(b);return null==b[a]?null:b[a]}Object.defineProperty(h,"__esModule",{value:!0});var c=new Map;h.register=function(b,a){a={extent:null,rasterInfo:a,cache:new Map};if(c.has(b))return b=c.get(b),b.push(a),b.length-1;c.set(b,[a]);return 0};h.unregister=function(b,a){c.has(b)&&(c.get(b)[a]=null)};h.deleteRaster=function(b){c.delete(b)};h.getBlock=
function(b,a,d){if(!c.has(b))return null;var f=c.get(b);if(null==f[a]){for(var e=0;e<f.length;e++)if(f[e].cache.has(d))return f[e].cache.get(d);return null}b=f[a].cache;if(b.has(d))return b.get(d);for(e=0;e<f.length;e++)if(e!==a&&f[e]&&f[e].cache.has(d))return a=f[e].cache.get(d),b.set(d,a),a;return null};h.putBlock=function(b,a,d,f){if(!c.has(b))return null;b=c.get(b);if(null==b[a])return null;b[a].cache.set(d,f)};h.update=function(b,a,d,f,e,c,g){void 0===g&&(g=null);b=t(b,a);a=b.extent;var h=b.cache,
k=b.rasterInfo;d=d.clone().normalize()[0];if(!a||a.xmin!==d.xmin||a.xmax!==d.xmax||a.ymin!==d.ymin||a.ymax!==d.ymax){var l=k.spatialReference;a=m.projectExtent(d,l,g);f=new r.Point({x:f,y:f,spatialReference:d.spatialReference});if(null===e&&(e=m.projectResolution(f,l,d,g),!e))return;g=m.snapPyramid(e,k,c||"closest");e=g.pyramidLevel;c=g.pyramidResolution;if(!g.excessiveReading){l=Math.floor((a.xmin-k.storageInfo.origin.x)/c.x);g=Math.floor((k.storageInfo.origin.y-a.ymax)/c.y);var n=0<e?k.storageInfo.pyramidBlockWidth:
k.storageInfo.blockWidth,p=0<e?k.storageInfo.pyramidBlockHeight:k.storageInfo.blockHeight,k=Math.floor(l/n);f=Math.floor(g/p);l=Math.floor((l+Math.ceil((a.xmax-a.xmin)/c.x-.1)-1)/n);a=Math.floor((g+Math.ceil((a.ymax-a.ymin)/c.y-.1)-1)/p);var q=new Set;for(c=f-1;c<=a+1;c++)for(g=k-1;g<=l+1;g++)q.add(e+"/"+c+"/"+g);h.forEach(function(b,a){q.has(a)||h.delete(a)});b.extent={xmin:d.xmin,ymin:d.ymin,xmax:d.xmax,ymax:d.ymax}}}}});