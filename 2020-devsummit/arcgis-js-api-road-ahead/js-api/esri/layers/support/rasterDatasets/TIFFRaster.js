// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/assignHelper ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ./BaseRaster ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags".split(" "),function(R,S,E,m,u,L,M,F,H,N,f,O,P,Q,G,x){var B=function(h,b){return(h=
h.get(b))&&h.values},y=function(h,b){return(h=h.get(b))&&h.values[0]};return function(h){function b(){var c=null!==h&&h.apply(this,arguments)||this;c._files=null;c._headerInfo=null;c._bufferSize=1048576;return c}L(b,h);b.prototype.open=function(c){return u(this,void 0,void 0,function(){var p,r,d,k,l,e,a,g,b,t,I,C,D,h,q,n,z,J,f,A,v,m,u,x,y,B,K;return E(this,function(w){switch(w.label){case 0:return[4,this.init()];case 1:return w.sent(),p=c?N.unwrap(c.signal):null,[4,this.request({url:this.url,range:{from:0,
to:this._bufferSize},responseType:"array-buffer"},p)];case 2:r=w.sent();if(!r)throw new H("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);d=G.parseSignature(r);k=d.littleEndian;l=d.firstIFD;e=[];return[4,this.readIFDs(e,r,k,l,0,4,p)];case 3:w.sent();a=G.getImageInfo(e);g=a.width;b=a.height;t=a.tileWidth;I=a.tileHeight;C=a.planes;D=a.pixelType;h=a.compression;q=a.firstPyramidLevel;n=a.maximumPyramidLevel;z=a.pyramidBlockWidth;J=a.pyramidBlockHeight;
f=a.tileBoundary;A=a.metadata;v=F.Extent.fromJSON(a.extent);m=v.spatialReference;u=v?new F.Point({x:v.xmin,y:v.ymax,spatialReference:m}):new F.Point({x:0,y:0});x=new P({blockWidth:t,blockHeight:I,pyramidBlockWidth:z,pyramidBlockHeight:J,compression:h,origin:u,firstPyramidLevel:q,maximumPyramidLevel:n,blockBoundary:f});y=new F.Point({x:(v.xmax-v.xmin)/g,y:(v.ymax-v.ymin)/b,spatialReference:m});B=A?{BandProperties:A.bandProperties,DataType:A.dataType}:null;K=new O({width:g,height:b,bandCount:C,pixelType:D,
compression:h,pixelSize:y,storageInfo:x,spatialReference:m,keyProperties:B,extent:v,statistics:A?A.statistics:null});this._set("rasterInfo",K);this._headerInfo=M({littleEndian:k,ifds:e},a);if(!this._headerInfo.isSupported)throw new H("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);return[2]}})})};b.prototype.fetchRawTile=function(c,p,b,d){void 0===d&&(d={});return u(this,void 0,void 0,function(){var k,l,e,a,g,h,t,r,C,D,m,q,n,z,f;return E(this,function(w){switch(w.label){case 0:if(!this._headerInfo&&
this._headerInfo.isSupported)return[2,null];k=this.rasterInfo.storageInfo.blockBoundary;l=0<c?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth;e=0<c?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;a=k[c];if(!a||a.maxRow<p||a.maxCol<b||a.minRow>p||a.minCol>b)return[2,null];g=this.getTileLocation(c,p,b);if(!g)return[2,null];h=g.range;t=g.actualTileWidth;r=g.actualTileHeight;C=g.ifd;return[4,this.request({url:this.url,range:h,
responseType:"array-buffer"},d.signal)];case 1:return D=w.sent(),[4,this.decodePixelBlock(D,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:C,offset:0,size:0},width:l,height:e,planes:null,pixelType:null})];case 2:m=w.sent();if(t!==l||r!==e)if(f=m.mask)for(q=0;q<e;q++)for(z=q*l,n=q<r?t:0;n<l;n++)f[z+n]=0;else for(f=new Uint8Array(l*e),m.mask=f,q=0;q<r;q++)for(z=q*l,n=0;n<t;n++)f[z+n]=1;return[2,m]}})})};b.prototype.readIFDs=function(c,b,r,d,k,l,e){void 0===l&&(l=4);return u(this,void 0,
void 0,function(){var a;return E(this,function(g){switch(g.label){case 0:return d?d>=b.byteLength||0>d?[4,this.request({url:this.url,range:{from:d+k,to:d+k+this._bufferSize},responseType:"array-buffer"},e)]:[3,2]:[2,null];case 1:b=g.sent(),k=d+k,d=0,g.label=2;case 2:return[4,this.readIFD(b,r,d,k,x.TIFF_TAGS,l,e)];case 3:return a=g.sent(),c.push(a.ifd),a.nextIFD?[4,this.readIFDs(c,b,r,a.nextIFD-k,k,l,e)]:[2,null];case 4:return g.sent(),[2]}})})};b.prototype.readIFD=function(c,b,r,d,k,l,e){void 0===
k&&(k=x.TIFF_TAGS);void 0===l&&(l=4);return u(this,void 0,void 0,function(){var a,g,h,t,m,f,p,u,q;return E(this,function(n){switch(n.label){case 0:if(!c)return[2,null];a=G.parseIFD(c,b,r,d,k,l);if(!a.success)return[3,5];g=[];a.ifd.forEach(function(a){a.values||g.push(a)});if(!(0<g.length))return[3,2];h=g.map(function(a){return a.offlineOffsetSize});t=Math.min.apply(null,h.map(function(a){return a[0]}));m=Math.min.apply(null,h.map(function(a){return a[0]+a[1]}));return m-t<=this._bufferSize?[4,this.request({url:this.url,
range:{from:t,to:t+this._bufferSize},responseType:"array-buffer"},e)]:[3,2];case 1:c=n.sent(),d=t,g.forEach(function(a){return G.parseFieldValues(c,b,a,d)}),n.label=2;case 2:if(!a.ifd.has("GEOKEYDIRECTORY"))return[3,4];f=a.ifd.get("GEOKEYDIRECTORY");p=f.values;if(!(p&&4<p.length))return[3,4];u=p[0]+"."+p[1]+"."+p[2];return[4,this.readIFD(c,b,f.valueOffset+6-d,d,x.GEO_KEYS,2,e)];case 3:q=n.sent(),f.data=q.ifd,f.data&&f.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[u]}),
n.label=4;case 4:return[2,a];case 5:return a.requiredBufferSize&&a.requiredBufferSize!==c.byteLength?[4,this.request({url:this.url,range:{from:d,to:d+a.requiredBufferSize+4},responseType:"array-buffer"},e)]:[3,7];case 6:return c=n.sent(),c.byteLength<a.requiredBufferSize?[2,null]:[2,this.readIFD(c,b,0,d,x.TIFF_TAGS,4,e)];case 7:return[2]}})})};b.prototype.getTileLocation=function(c,b,f){var d=this.rasterInfo.storageInfo,k=d.firstPyramidLevel,l=d.blockBoundary,e=0===c?0:c-(k-1);c=this._headerInfo.ifds[e];
if(!c)return null;d=B(c,"TILEOFFSETS");if(void 0===d)return null;var k=B(c,"TILEBYTECOUNTS"),e=l[e],a=e.minRow,g=e.minCol,l=e.maxRow,e=e.maxCol;if(b>l||f>e||b<a||f<g)return null;var a=y(c,"IMAGEWIDTH"),g=y(c,"IMAGELENGTH"),h=y(c,"TILEWIDTH"),m=y(c,"TILELENGTH"),p=b*(e+1)+f,d=d[p],k=k[p];return null==d||null==k?null:{range:{from:d,to:d+k-1},ifd:c,actualTileWidth:f===e?a%h:h,actualTileHeight:b===l?g%m:m}};m([f.property()],b.prototype,"_files",void 0);m([f.property()],b.prototype,"_headerInfo",void 0);
m([f.property()],b.prototype,"_bufferSize",void 0);m([f.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0);return b=m([f.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],b)}(f.declared(Q))});