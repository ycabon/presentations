// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../PixelBlock"],function(J,G,I){function H(e){var p=e.altitude,a=e.azimuth,q=e.hillshadeType,d=e.pixelSizePower,u=e.pixelSizeFactor,k=e.scalingType,v=e.isGCS,E=e.resolution,l="multi-directional"===q?2*e.zFactor:e.zFactor,z=E.x,x=E.y;e=l/(8*z);var w=l/(8*x);v&&.001<l&&(e/=111E3,w/=111E3);"adjusted"===k&&(v?(e=111E3*z,w=111E3*x,e=(l+Math.pow(e,d)*u)/(8*e),w=(l+Math.pow(w,d)*u)/(8*w)):(e=(l+Math.pow(z,d)*u)/(8*z),w=(l+Math.pow(x,d)*u)/(8*x)));var m=(90-p)*Math.PI/180,p=Math.cos(m),
B=(360-a+90)*Math.PI/180,a=Math.sin(m)*Math.cos(B),m=Math.sin(m)*Math.sin(B),d=[315,270,225,360,180,0],u=[60,60,60,60,60,90],l=[3,5,3,2,1,4],f=l.reduce(function(a,d){return a+d}),l=l.map(function(a){return a/f}),k=[],v=[],x=[],z="multi-directional"===q?d.length:1;if("multi-directional"===q)for(var g=0;g<z;g++)p=u[g],a=d[g],m=(90-p)*Math.PI/180,p=Math.cos(m),B=(360-a+90)*Math.PI/180,a=Math.sin(m)*Math.cos(B),m=Math.sin(m)*Math.sin(B),k.push(p),v.push(a),x.push(m);return{resolution:E,factor:[e,w],sinZcosA:a,
sinZsinA:m,cosZ:p,sinZcosAs:v,sinZsinAs:x,cosZs:k,weights:l,hillshadeType:["traditional","multi-directional"].indexOf(q)}}Object.defineProperty(G,"__esModule",{value:!0});G.calculateHillshadeParams=H;G.hillshade=function(e,p){if(!(e&&"esri.layers.support.PixelBlock"===e.declaredClass&&e.pixels&&0<e.pixels.length))return e;var a=e.width,q=e.height,d=e.mask,u=new Uint8Array(a*q);d&&u.set(d);var k=H(p),v=k.factor,E=k.sinZcosA,l=k.sinZsinA,z=k.cosZ,x=k.sinZcosAs,w=k.sinZsinAs,m=k.cosZs,k=k.weights,B=
v[0],v=v[1];p=p.hillshadeType;for(var f=e.pixels[0],g=new Uint8Array(a*q),y,C,A,n,F,r,D,t,h=1;h<q-1;h++)for(var c=h*a,b=1;b<a-1;b++)if(d&&!d[c+b])g[c+b]=0;else{n=0;if(d&&(n=d[c-a+b-1]+d[c-a+b]+d[c-a+b+1]+d[c+b-1]+d[c+b+1]+d[c+a+b-1]+d[c+a+b]+d[c+a+b+1],7>n)){g[c+b]=0;u[c+b]=0;continue}7===n?(y=d[c-a+b-1]?f[c-a+b-1]:f[c+b],C=d[c-a+b]?f[c-a+b]:f[c+b],A=d[c-a+b+1]?f[c-a+b+1]:f[c+b],n=d[c+b-1]?f[c+b-1]:f[c+b],F=d[c+b+1]?f[c+b+1]:f[c+b],r=d[c+a+b-1]?f[c+a+b-1]:f[c+b],D=d[c+a+b]?f[c+a+b]:f[c+b],t=d[c+a+
b+1]?f[c+a+b+1]:f[c+b]):(y=f[c-a+b-1],C=f[c-a+b],A=f[c-a+b+1],n=f[c+b-1],F=f[c+b+1],r=f[c+a+b-1],D=f[c+a+b],t=f[c+a+b+1]);n=(A+F+F+t-(y+n+n+r))*B;y=(r+D+D+t-(y+C+C+A))*v;C=Math.sqrt(1+n*n+y*y);A=0;if("traditional"===p)r=255*(z+l*y-E*n)/C,0>r&&(r=0),A=r;else for(D=w.length,t=0;t<D;t++)r=255*(m[t]+w[t]*y-x[t]*n)/C,0>r&&(r=0),A+=r*k[t];g[c+b]=A}for(h=0;h<q;h++)g[h*a]=g[h*a+1],g[(h+1)*a-1]=g[(h+1)*a-2];for(h=1;h<a-1;h++)g[h]=g[h+a],g[h+(q-1)*a]=g[h+(q-2)*a];return new I({width:a,height:q,pixels:[g],mask:d?
u:null,pixelType:"u8",validPixelCount:e.validPixelCount,statistics:[{minValue:0,maxValue:255}]})}});