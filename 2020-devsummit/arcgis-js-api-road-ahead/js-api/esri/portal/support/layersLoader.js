// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../request ../../core/Error ../../core/promiseUtils ../../layers/support/lazyLayerLoader ../Portal ./jsonContext ../../renderers/support/styleUtils".split(" "),function(A,l,m,n,t,p,h,g,u,v,w){function x(b,f){return n(this,void 0,void 0,function(){var a,c,k,e,d,g;return m(this,function(h){switch(h.label){case 0:a=b.instance;c=a.portalItem;k=c.url;e=c.title;d=v.createForItem(c);if("group"===a.type)return a.read({title:e},
d),[2,y(a,b)];k&&a.read({url:k},d);return[4,q(b,f)];case 1:return(g=h.sent())&&a.read(g,d),a.read({title:e},d),[2,w.loadStyleRenderer(a,d)]}})})}function y(b,f){var a;a=b.portalItem.type;switch(a){case "Feature Service":a=g.layerLookupMap.FeatureLayer;break;case "Stream Service":a=g.layerLookupMap.StreamLayer;break;case "Scene Service":a=g.layerLookupMap.SceneLayer;break;case "Feature Collection":a=g.layerLookupMap.FeatureLayer;break;default:throw new p("portal:unsupported-item-type-as-group","The item type '"+
a+"' is not supported as a 'GroupLayer'");}var c;return a().then(function(a){c=a;return q(f)}).then(function(a){return a&&Array.isArray(a.layers)?r(b,c,a):z(b,c)})}function z(b,f){return b.portalItem.url?t(b.portalItem.url,{responseType:"json",query:{f:"json"}}).then(function(a){if((a=a.data)&&Array.isArray(a.layers))return a=a.layers.map(function(a){return{id:a.id,name:a.name}}),r(b,f,{layers:a})}):h.resolve()}function r(b,f,a){var c=a.showLegend;a=a.layers.slice();a.reverse();a.forEach(function(a){var e=
new f({portalItem:b.portalItem,layerId:a.id,sublayerTitleMode:"service-name"});if("Feature Collection"===b.portalItem.type){var d={origin:"portal-item",portal:b.portalItem.portal||u.getDefault()};e.read(a,d);null!=c&&e.read({showLegend:c},d)}b.add(e)})}function q(b,f){if(!1===b.supportsData)return h.resolve();var a=b.instance;return a.portalItem.fetchData("json",f).catch(function(){return null}).then(function(c){var b,e;e="stream"===a.type?!1:"layerId"in a;if(e){e=!0;if(c&&Array.isArray(c.layers)){null==
a.layerId&&(a.layerId=c.layers[0].id);for(var d=0;d<c.layers.length;d++)if(c.layers[d].id===a.layerId){b=c.layers[d];break}b&&(1===c.layers.length&&(e=!1),null!=c.showLegend&&(b.showLegend=c.showLegend))}e&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name");return b}return c})}Object.defineProperty(l,"__esModule",{value:!0});l.load=function(b,f){return n(this,void 0,void 0,function(){var a;return m(this,function(c){switch(c.label){case 0:return(a=b.instance.portalItem)&&
a.id?[4,a.load(f)]:[2,h.resolve()];case 1:c.sent();c=b.instance.portalItem;if(-1===b.supportedTypes.indexOf(c.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:c.type,expectedType:b.supportedTypes.join(", ")});return[2,x(b,f)]}})})}});