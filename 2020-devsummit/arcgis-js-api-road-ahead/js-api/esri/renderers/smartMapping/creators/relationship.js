// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper dojo/i18n!../../nls/smartMapping ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/promiseUtils ./type ./support/utils ../support/utils ../symbology/relationship ../../support/AuthoringInfo ../../support/AuthoringInfoClassBreakInfo ../../support/AuthoringInfoFieldInfo ../../../symbols/support/utils".split(" "),function(da,r,G,m,n,H,k,N,v,
O,P,u,w,y,Q,I,J,R){function S(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,g,l,h,t,p;return m(this,function(q){switch(q.label){case 0:if(!(b&&b.layer&&b.view&&b.field1&&b.field2))throw new k("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");a=G({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"quantile";a.numClasses=
a.numClasses||3;a.focus=a.focus||null;if(-1===T.indexOf(a.classificationMethod))throw new k("relationship-renderer:invalid-parameters","classification method "+a.classificationMethod+" is not supported");if(2>a.numClasses||4<a.numClasses)throw new k("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(b.focus&&-1===U.indexOf(b.focus))throw new k("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");c=[0,2,1,3];d=w.createLayerAdapter(a.layer,
c);a.layer=d;if(!d)throw new k("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+w.getLayerTypeLabels(c).join(", "));f=v.isSome(a.signal)?{signal:a.signal}:null;return[4,d.load(f)];case 1:q.sent();e=d.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled="point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=
a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new k("relationship-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(g&&"polygon"===e)throw new k("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new k("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}l=a.field1;h=a.field2;t=[l.field,h.field];l.normalizationField&&t.push(l.normalizationField);h.normalizationField&&t.push(h.normalizationField);if(p=u.verifyBasicFieldValidity(d,t,"relationship-renderer:invalid-parameters"))throw p;return[2,a]}})})}function V(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,g;return m(this,function(l){if(!(b&&b.renderer&&b.numClasses))throw new k("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");a=b.field1;
c=b.field2;d=b.renderer;f=b.numClasses;e=b.colors;g=Math.pow(f,2);if((a||c)&&!(a&&c&&a.field&&c.field))throw new k("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(a&&!a.classBreakInfos||c&&!c.classBreakInfos)throw new k("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!d.authoringInfo)throw new k("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");
if(d.uniqueValueInfos.length!==g)throw new k("update-relationship-renderer:invalid-parameters","Renderer must have "+g+" unique value infos to support "+f+" classes");if(e&&e.length!==g)throw new k("update-relationship-renderer:invalid-parameters","The scheme must have "+g+" colors");return[2,b]})})}function W(b){return n(this,void 0,void 0,function(){var a,c,d,f,e;return m(this,function(g){switch(g.label){case 0:return a=b.relationshipScheme,d=c=null,[4,u.getBasemapInfo(b.basemap,b.view)];case 1:f=
g.sent();c=v.isSome(f.basemapId)?f.basemapId:null;d=v.isSome(f.basemapTheme)?f.basemapTheme:null;if(a)return[2,{scheme:y.cloneScheme(a),basemapId:c,basemapTheme:d}];if(e=y.getSchemes({basemap:c,basemapTheme:d,geometryType:b.geometryType,theme:b.theme,worldScale:b.worldScale,view:b.view}))a=e.primaryScheme,c=e.basemapId,d=e.basemapTheme;return[2,{scheme:a,basemapId:c,basemapTheme:d}]}})})}function K(b,a){b=N.clone(X[b]);return y.flatten2DArray(b,a)}function Y(b,a){return K(b,a).map(function(a){return{value:a,
count:0}})}function L(b,a,c,d){var f=b.field;b=b.normalizationField;var e=a.field;a=a.normalizationField;c=c.map(function(a){return[a.minValue,a.maxValue]});d=d.map(function(a){return[a.minValue,a.maxValue]});var g=Z[c.length];return"\n  var field1 \x3d $feature['"+f+"'];\n  var field2 \x3d $feature['"+e+"'];\n  var hasNormField1 \x3d "+(b?"true":"false")+";\n  var hasNormField2 \x3d "+(a?"true":"false")+";\n  var normField1 \x3d "+(b?"$feature['"+b+"']":"null")+";\n  var normField2 \x3d "+(a?"$feature['"+
a+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 \x26\x26 (IsEmpty(normField1) || normField1 \x3d\x3d 0)) ||\n    (hasNormField2 \x26\x26 (IsEmpty(normField2) || normField2 \x3d\x3d 0))\n  ) {\n    return null;\n  }\n\n  var value1 \x3d IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 \x3d IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 \x3d "+JSON.stringify(c)+";\n  var breaks2 \x3d "+JSON.stringify(d)+";\n  var classCodes \x3d "+
JSON.stringify(g)+";\n\n  function getClassCode(value, breaks) {\n    var code \x3d null;\n\n    for (var i in breaks) {\n      var info \x3d breaks[i];\n      if (value \x3e\x3d info[0] \x26\x26 value \x3c\x3d info[1]) {\n        code \x3d classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 \x3d getClassCode(value1, breaks1);\n  var code2 \x3d getClassCode(value2, breaks2);\n\n  var classValue \x3d IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}
function aa(b,a,c){return n(this,void 0,void 0,function(){var d,f,e,g,l,h,t,p,q,z,n,M,u,A,x,B,r,v,C,E,F,w;return m(this,function(m){switch(m.label){case 0:d=b.basemap;f=b.classificationMethod;e=b.field1;g=b.field2;l=b.focus;h=b.numClasses;t=b.signal;p=b.layer;q=a.classBreakInfos;z=c.classBreakInfos;if(h!==q.length||q.length!==z.length)throw new k("relationship-renderer:error","incompatible class breaks");n=Y(h,l);M=L(b.field1,b.field2,q,z);return[4,W({basemap:d,geometryType:p.geometryType,theme:"default",
relationshipScheme:b.relationshipScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 1:return u=m.sent(),A=u.scheme,[4,P.createRenderer({layer:p,basemap:d,valueExpression:M,valueExpressionTitle:H.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:b.defaultSymbolEnabled,typeScheme:G({colors:y.getColors(A,h,l)},A),statistics:{uniqueValueInfos:n},legendOptions:b.legendOptions,outlineOptimizationEnabled:b.outlineOptimizationEnabled,sizeOptimizationEnabled:b.sizeOptimizationEnabled,
symbolType:b.symbolType,colorMixMode:b.colorMixMode,edgesType:b.edgesType,view:b.view,signal:t})];case 2:x=m.sent();B=x.renderer;r=B.uniqueValueInfos;v=H.relationship;C=0;for(E=r;C<E.length;C++)F=E[C],F.label=v[F.value];w=new Q({type:"relationship",classificationMethod:f,numClasses:h,focus:l,field1:{field:e.field,normalizationField:e.normalizationField,classBreakInfos:q.map(D)},field2:{field:g.field,normalizationField:g.normalizationField,classBreakInfos:z.map(D)}});B.authoringInfo=w;return[2,{renderer:B,
classBreaks:{field1:a,field2:c},uniqueValueInfos:x.uniqueValueInfos,relationshipScheme:A,basemapId:x.basemapId,basemapTheme:x.basemapTheme}]}})})}function ba(b,a,c){var d=K(a,c);b.sort(function(a,b){a=d.indexOf(a.value);b=d.indexOf(b.value);var c=0;a<b?c=-1:a>b&&(c=1);return c})}function ca(b,a){var c=b.authoringInfo;c.numClasses=a.numClasses;c.focus=a.focus||null;c.focus||delete c.focus;var d=a.field1;a=a.field2;c.field1=new J.default({field:d.field,normalizationField:d.normalizationField,classBreakInfos:d.classBreakInfos.map(function(a){return new I.default(D(a))})});
c.field2=new J.default({field:a.field,normalizationField:a.normalizationField,classBreakInfos:a.classBreakInfos.map(function(a){return new I.default(D(a))})});b.authoringInfo=c}Object.defineProperty(r,"__esModule",{value:!0});var T=["equal-interval","natural-breaks","quantile"],U=["HH","HL","LH","LL"],X={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},Z={2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]},D=function(b){return{minValue:b.minValue,maxValue:b.maxValue}};r.updateRenderer=function(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,g,l,h,k;return m(this,function(p){switch(p.label){case 0:return[4,V(b)];case 1:return a=p.sent(),c=a.field1,d=a.field2,f=a.renderer,e=a.numClasses,g=a.focus,l=a.colors,h=f.clone(),h.valueExpression=L(c,d,c.classBreakInfos,d.classBreakInfos),ba(h.uniqueValueInfos,e,g),l&&(k=u.createColors(l,l.length),h.uniqueValueInfos.forEach(function(a,
b){return R.applyColorToSymbol(a.symbol,k[b])})),ca(h,a),[2,h]}})})};r.createRenderer=function(b){return n(this,void 0,void 0,function(){var a,c,d,f,e,g,l,h,t,p,q,n,r;return m(this,function(m){switch(m.label){case 0:return[4,S(b)];case 1:return a=m.sent(),c=a.layer,d=a.classificationMethod,f=a.field1,e=a.field2,g=a.numClasses,l=a.view,h=a.signal,t={layer:c,classificationMethod:d,field:f.field,normalizationField:f.normalizationField,normalizationType:f.normalizationField?"field":null,minValue:f.minValue,
maxValue:f.maxValue,analyzeData:!(null!=f.minValue&&null!=f.maxValue),numClasses:g,view:l,signal:h},p={layer:c,classificationMethod:d,field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationField?"field":null,minValue:e.minValue,maxValue:e.maxValue,analyzeData:!(null!=e.minValue&&null!=e.maxValue),numClasses:g,view:l,signal:h},[4,O.all([u.getClassBreaks(t),u.getClassBreaks(p)])];case 2:q=m.sent();n=q[0];r=q[1];if(!n||!r)throw new k("relationship-renderer:error","error when calculating class breaks");
return[2,aa(a,n.result,r.result)]}})})}});