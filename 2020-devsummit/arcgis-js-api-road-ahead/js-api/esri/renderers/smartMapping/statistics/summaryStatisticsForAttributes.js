// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/tsSupport/restHelper ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ./support/utils ../support/utils".split(" "),function(E,F,y,v,n,w,r,z,A,B,t){function C(a){return n(this,void 0,void 0,function(){var e,k,d,g,h,c,m,b,l,q,f,u,x,n;return v(this,function(p){switch(p.label){case 0:if(!(a&&a.layer&&a.attributes))throw new r("summary-statistics-for-attributes:missing-parameters",
"'layer' and 'attributes' parameters are required");if((e=a.attributes.some(function(a){return!!a.valueExpression}))&&!a.view)throw new r("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");k=[2,1];d=a.layer;g=w(a,["layer"]);h=t.createLayerAdapter(d,k);c=y({layerAdapter:h},g);c.includeZeros=null==c.includeZeros||c.includeZeros;c.includeNegatives=null==c.includeNegatives||c.includeNegatives;if(!h)throw new r("summary-statistics-for-attributes:invalid-parameters",
"'layer' must be one of these types: "+t.getLayerTypeLabels(k).join(", "));m=c.view;b=z.isSome(c.signal)?{signal:c.signal}:null;return[4,A.all([m&&m.when(),h.load(b)])];case 1:p.sent(),l=[],q=0,f=c.attributes,p.label=2;case 2:if(!(q<f.length))return[3,5];u=f[q];return[4,t.getFieldsList({field:u.field,valueExpression:u.valueExpression})];case 3:x=p.sent(),Array.prototype.push.apply(l,x),p.label=4;case 4:return q++,[3,2];case 5:if(n=B.verifyBasicFieldValidity(h,l,"summary-statistics-for-attributes:invalid-parameters"))throw n;
return[2,c]}})})}function D(a,e,k){var d=[],g=[],h=[],c=[],m=[];a.forEach(function(a,f){var b=a.field?"field":"expression",e=a.field||a.valueExpression;a.field?(m.push(e),g.push("var "+b+f+' \x3d Number($feature["'+e+'"]);')):(d.push("function getValueForExpr"+f+"() {\n  "+e+" \n}"),g.push("var "+b+f+" \x3d Number(getValueForExpr"+f+"());"));k||h.push(""+b+f+" \x3d IIf("+b+f+" \x3c 0, 0, "+b+f+");");c.push(""+b+f)});a="return sum;";var b=d.length?null:m.reduce(function(a,b){return a+" + "+b}),l=null;
e||k?e?k||(a="return IIf(sum \x3e\x3d 0, sum, null);",b&&(l="(( "+b+" ) \x3e\x3d 0)")):(a="return IIf(sum !\x3d 0, sum, null);",b&&(l="(( "+b+" ) \x3c\x3e 0)")):(a="return IIf(sum \x3e 0, sum, null);",b&&(l="(( "+b+" ) \x3e 0)"));return{valueExpression:[d.length?d.join("\n"):"",g.join("\n"),h.join("\n"),"var sum \x3d "+c.join(" + ")+";",a].filter(Boolean).join("\n\n"),sqlExpression:b,sqlWhere:l}}return function(a){return n(this,void 0,void 0,function(){var e,k,d,g;return v(this,function(h){switch(h.label){case 0:return[4,
C(a)];case 1:return e=h.sent(),k=e.layerAdapter,d=w(e,["layerAdapter"]),g=D(d.attributes,d.includeZeros,d.includeNegatives),[2,k.summaryStatistics({valueExpression:g.valueExpression,sqlExpression:g.sqlExpression,sqlWhere:g.sqlWhere,view:d.view,signal:d.signal})]}})})}});