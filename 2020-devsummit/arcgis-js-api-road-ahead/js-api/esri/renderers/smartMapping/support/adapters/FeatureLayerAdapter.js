// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../geometry ../../../../core/arrayUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/quantizationUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/arcgisLayerUrl ../../../../layers/support/fieldUtils ../../statistics/support/predominanceUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../../tasks/GenerateRendererTask ../../../../tasks/support/GenerateRendererParameters ../../../../tasks/support/QuantizationParameters ../../../../tasks/support/Query ../../../../tasks/support/StatisticDefinition ../../../../tasks/support/UniqueValueDefinition".split(" "),
function(V,W,z,M,G,w,v,N,H,u,O,q,A,C,I,J,P,B,D,r,K,Q,n,R,E,S,T,F,U){return function(L){function g(a){return L.call(this,a)||this}M(g,L);g.prototype.destroy=function(){this._hasLocalSource=null};g.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!P.isHostedAgolService(a.url)&&10.5>a.version?q.reject(new u("feature-layer-adapter:not-supported","Layer does not support statistics query")):q.resolve()};
g.prototype._fetchFeaturesFromMemory=function(a,c,b){return v(this,void 0,void 0,function(){var d,f,e,h;return w(this,function(k){switch(k.label){case 0:return d=this.layer,this._hasLocalSource?[4,d.queryFeatures(c)]:[3,2];case 1:return f=k.sent(),[2,f.features];case 2:if(!a)throw new u("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView");return[4,a.whenLayerView(d)];case 3:return e=k.sent(),[4,A.whenFalseOnce(e,"updating")];case 4:return k.sent(),[4,
e.queryFeatures(c,{signal:b})];case 5:return h=k.sent(),[2,h.features]}})})};g.prototype._fetchFeaturesFromService=function(a,c){return this.layer.queryFeatures(a,{signal:c}).then(function(a){return a&&a.features})};g.prototype._fetchFeaturesForStats=function(a){var c=this;return K.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}).then(function(b){return c.getSampleFeatures({sampleSize:-1,view:a.view,requiredFields:b,signal:a.signal})})};g.prototype._hasRequiredFieldsInView=
function(a,c){return v(this,void 0,void 0,function(){var b,d,f=this;return w(this,function(e){switch(e.label){case 0:return[4,c.whenLayerView(this.layer)];case 1:return b=e.sent(),[4,A.whenFalseOnce(b,"updating")];case 2:return e.sent(),d=!0,a&&a.length&&(d=a.every(function(a){a=f.getField(a);return-1<b.availableFields.indexOf(a.name)})),[2,d]}})})};g.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,
classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue,signal:a.signal}).then(function(a){var b,c,d;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(d=b.maxValue-b.minValue,c=b.minValue+d/2,d*=4);return n.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:d})})};g.prototype._getSummaryStatsQuery=function(a,c){var b=a.field,d=a.normalizationType,
f=a.normalizationField,e=a.normalizationTotal;c=this.supportsSQLExpression&&c?n.msSinceUnixEpochSQL(this,b):a.sqlExpression;var e=n.getFieldExpr({field:b,normalizationType:d,normalizationField:f,normalizationTotal:e,layer:this}),h=c||e,e=h?r.getRangeExpr(h,a.minValue,a.maxValue):null,b=r.getSQLFilterForNormalization({field:b,normalizationField:f,normalizationType:d});a=r.mergeWhereClauses(a.sqlWhere,b);a=r.mergeWhereClauses(a,e);b=this.layer.createQuery();b.where=r.mergeWhereClauses(b.where,a);b.sqlFormat=
c?"standard":null;b.outStatistics=n.statisticTypes.map(function(a){var b=new F;b.statisticType="variance"===a?"var":a;b.onStatisticField=h;b.outStatisticFieldName=a+"_value";return b});return b};g.prototype._summaryStatsFromServiceQuery=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e;return w(this,function(h){switch(h.label){case 0:return[4,this._isStatsSupportedOnService()];case 1:h.sent();if("percent-of-total"!==a.normalizationType)return[3,3];b=a;return[4,this._getNormalizationTotal(a.field,
a.normalizationType)];case 2:b.normalizationTotal=h.sent(),h.label=3;case 3:return d=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(d,{signal:a.signal})];case 4:return f=h.sent(),e=n.getSummaryStatisticsFromFeatureSet(f,c),[2,n.processSummaryStatisticsResult(e)]}})})};g.prototype._summaryStatsFromClientQuery=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e,h,k,l,m,g;return w(this,function(p){switch(p.label){case 0:b=a.view;d=a.signal;if(!b)throw new u("feature-layer-adapter:insufficient-data",
"view is required to query stats from layerView");return[4,b.whenLayerView(this.layer)];case 1:return f=p.sent(),[4,A.whenFalseOnce(f,"updating")];case 2:return p.sent(),[4,K.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 3:return e=p.sent(),[4,this._hasRequiredFieldsInView(e,b)];case 4:return h=p.sent(),k=this._getSummaryStatsQuery(a,c),!this._hasLocalSource||h?[3,6]:[4,this.layer.queryFeatures(k,{signal:d})];case 5:return m=p.sent(),
[3,8];case 6:return[4,f.queryFeaturesJSON(k,{signal:d})];case 7:m=p.sent(),p.label=8;case 8:return l=m,g=n.getSummaryStatisticsFromFeatureSet(l,c),[2,n.processSummaryStatisticsResult(g)]}})})};g.prototype._summaryStatsFromMemory=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e,h,k,l,m,g,p,x;return w(this,function(t){switch(t.label){case 0:return b=a.field,d=a.valueExpression,f=a.view,e={field:b,valueExpression:d,normalizationField:a.normalizationField,view:f,signal:a.signal},(k=a.features)?
[3,2]:[4,this._fetchFeaturesForStats(e)];case 1:k=t.sent(),t.label=2;case 2:l=(h=k)&&h.length;if(!l)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");m=z({},a);return"percent-of-total"!==m.normalizationType?[3,4]:[4,n.calculateStatsFromMemory({field:b},h)];case 3:g=t.sent();p=g.sum;if(null==p)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");m.normalizationTotal=p;t.label=4;case 4:return[4,n.calculateStatsFromMemory(m,
h,c)];case 5:return x=t.sent(),[2,n.processSummaryStatisticsResult(x)]}})})};g.prototype._uvFromGenRenderer=function(a,c){var b=this,d=a.field,f=new U;f.attributeField=d;var e=new E;e.classificationDefinition=f;return this.generateRenderer(e,a.signal).then(function(a){var c={},f=b.getField(d);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:B.isNumericField(f)&&b?Number(b):
b}:c[b].count+=a.count});return{count:c}}).then(function(b){return n.createUVResult(b,c,a.returnAllCodedValues)})};g.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,d="countOF"+(c||"Expr"),f=new F;f.statisticType="count";f.onStatisticField=b?"1":c;f.outStatisticFieldName=d;d=this.layer.createQuery();d.where=r.mergeWhereClauses(d.where,a.sqlWhere);d.sqlFormat=b?"standard":null;d.outStatistics=[f];d.groupByFieldsForStatistics=[c||b];return d};g.prototype._uvFromServiceQuery=function(a,
c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a),{signal:a.signal})}).then(function(c){return n.getUniqueValuesFromFeatureSet(c,b,a.field,null,a.signal)}).then(function(b){return n.createUVResult(b,c,a.returnAllCodedValues)})};g.prototype._uvFromClientQuery=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e,h;return w(this,function(k){switch(k.label){case 0:b=a.view;d=a.signal;if(!b)throw new u("feature-layer-adapter:insufficient-data",
"view is required to query stats from layerView");return[4,b.whenLayerView(this.layer)];case 1:return f=k.sent(),[4,A.whenFalseOnce(f,"updating")];case 2:return k.sent(),[4,f.queryFeaturesJSON(this._getUVQuery(a),{signal:d})];case 3:return e=k.sent(),[4,n.getUniqueValuesFromFeatureSet(e,this,a.field,null,a.signal)];case 4:return h=k.sent(),[2,n.createUVResult(h,c,a.returnAllCodedValues)]}})})};g.prototype._uvFromMemory=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e,h,k,l;return w(this,
function(m){switch(m.label){case 0:b=a.field;d=a.valueExpression;f=a.view;e=a.signal;h={field:b,valueExpression:d,view:f,signal:e};if(!a.features)return[3,1];l=a.features;return[3,3];case 1:return[4,this._fetchFeaturesForStats(h)];case 2:l=m.sent(),m.label=3;case 3:return k=l,[2,n.calculateUniqueValuesFromMemory(a,k,c)]}})})};g.prototype._calcBinsSQL=function(a,c){var b=[],d=c.length;c.forEach(function(c,e){c=r.mergeWhereClauses(a+" \x3e\x3d "+c[0],a+(e===d-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+
c+") THEN "+(e+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};g.prototype._getNormalizationTotal=function(a,c,b){return a&&"percent-of-total"===c?this.summaryStatistics({field:a,signal:b}).then(function(a){return a.sum}):q.resolve(null)};g.prototype._getQueryParamsForExpr=function(a,c){var b=a.signal;if(!a.valueExpression&&!a.sqlExpression){var d=a.field,f=d?this.getField(d):null,f=B.isDateField(f);c={field:d,normalizationType:a.normalizationType,normalizationField:a.normalizationField,
normalizationTotal:c,layer:this};return{sqlExpression:f?n.msSinceUnixEpochSQL(this,d):n.getFieldExpr(c),sqlWhere:f?null:a.sqlWhere||r.getSQLFilterForNormalization(a),signal:b}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,signal:b}};g.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?q.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};g.prototype._histogramForExpr=function(a){var c=this;return this._getNormalizationTotal(a.field,
a.normalizationType,a.signal).then(function(b){var d=c._getQueryParamsForExpr(a,b);return c._getDataRange(d,a.minValue,a.maxValue).then(function(f){var e=f.min,h=f.max,k=a.numBins||10;f=n.getEqualIntervalBins(e,h,k);f=c._calcBinsSQL(d.sqlExpression,f);var l=new F({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),m=c.layer.createQuery();m.where=r.mergeWhereClauses(m.where,d.sqlWhere);m.sqlFormat="standard";m.outStatistics=[l];m.groupByFieldsForStatistics=[f];m.orderByFields=
[f];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(m,{signal:d.signal})}).then(function(a){return n.getHistogramFromFeatureSet(a,e,h,k,b)})})})};g.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?q.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){if(!a.count)throw new u("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");
return{min:a.min,max:a.max}});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins,a.signal)})};g.prototype._getBins=function(a,c,b,d){void 0===b&&(b=10);var f=a.min,e=a.max,h=a.normTotal,k=a.excludeZerosExpr,l=a.intervals||n.getEqualIntervalBins(f,e,b);return this._queryBins(l,a.sqlExpr||c,k,d).then(function(a){return{bins:a.map(function(a,b){return{minValue:l[b][0],maxValue:l[b][1],count:a.value}}),minValue:f,maxValue:e,normalizationTotal:h}})};g.prototype._queryBins=
function(a,c,b,d){for(var f=this,e=[],h=a.length,k=0;k<h;k++){var l=r.mergeWhereClauses(b,r.mergeWhereClauses(c+" \x3e\x3d "+a[k][0],null!==a[k][1]?c+(k===h-1?" \x3c\x3d ":" \x3c ")+a[k][1]:""));e.push(l)}return q.eachAlways(e.map(function(a){return f.queryFeatureCount(a,d)}))};g.prototype._binParamsFromGenRend=function(a,c){var b=this,d=a.field,f=a.normalizationType,e=a.normalizationField,h=a.signal,k=r.getSQLFilterForNormalization({field:d,normalizationType:f,normalizationField:e});a=new E({classificationDefinition:n.createCBDefn({field:d,
normalizationType:f,normalizationField:e,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||10}),where:r.mergeWhereClauses(k,c)});return this.generateRenderer(a,h).then(function(a){return n.generateBinParams({field:d,normalizationType:f,normalizationField:e,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:k,layer:b})})};g.prototype._histogramFromMemory=function(a){var c=this,b=a.field,d=a.normalizationType,
f=a.valueExpression,e=a.classificationMethod,h=a.minValue,k=a.maxValue,l=a.view,g=a.signal,t={field:b,valueExpression:f,normalizationField:a.normalizationField,view:l,signal:g};return(a.features?q.resolve(a.features):this._fetchFeaturesForStats(t)).then(function(m){if(!m||!m.length)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram");var p=null!=h&&null!=k,t=null;e&&"equal-interval"!==e||d?(p=z({},a),p.features=m,t=c._getBinParamsFromMemory(p)):
t=p?q.resolve({min:h,max:k,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:f,features:m,view:l,signal:g}).then(function(a){return a.count?{min:a.min,max:a.max}:q.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return t.then(function(b){return n.calculateHistogramFromMemory(a,b,m)})})};g.prototype._getBinParamsFromMemory=function(a){return v(this,void 0,void 0,function(){var c,b,d,f,e,h,k,l,g,t,p,x=this;return w(this,
function(m){c=a.field;b=a.valueExpression;d=a.classificationMethod;f=a.standardDeviationInterval;e=a.normalizationType;h=a.normalizationField;k=a.minValue;l=a.maxValue;g=a.features;t=a.view;p=a.signal;return[2,this._classBreaksFromMemory({field:c,valueExpression:b,normalizationType:e,normalizationField:h,classificationMethod:d,standardDeviationInterval:f,minValue:k,maxValue:l,numClasses:a.numBins,features:g,view:t,signal:p}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var d=r.getSQLFilterForNormalization({field:c,
normalizationType:e,normalizationField:h});return n.generateBinParams({field:c,normalizationType:e,normalizationField:h,normalizationTotal:b,classBreaks:a,where:d,layer:x})})]})})};g.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField,f=a.normalizationTotal,e=a.signal,h=r.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d}),f=n.getFieldExpr({field:c,normalizationType:b,normalizationField:d,normalizationTotal:f,layer:this}),
f=r.getRangeExpr(f,a.minValue,a.maxValue),c=n.createCBDefn({field:c,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new E;b.classificationDefinition=c;b.where=r.mergeWhereClauses(h,f);return this.generateRenderer(b,e).then(function(b){return n.resolveCBResult(a,b)})};g.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,d=a.numClasses||5,f=[],
e=(b-c)/d,h=0;h<d;h++){var k=c+h*e;f.push({minValue:k,maxValue:k+e})}f[d-1].maxValue=b;a=n.resolveCBResult(a,{classBreaks:f,normalizationTotal:a.normalizationTotal});return q.resolve(a)};g.prototype._classBreaksFromMemory=function(a){return v(this,void 0,void 0,function(){var c,b,d,f,e,h,k,l,g,t,p,x;return w(this,function(m){switch(m.label){case 0:return c=a.field,b=a.normalizationField,d=a.valueExpression,f=a.view,e=a.signal,h={field:c,valueExpression:d,normalizationField:b,view:f,signal:e},(l=a.features)?
[3,2]:[4,this._fetchFeaturesForStats(h)];case 1:l=m.sent(),m.label=2;case 2:g=(k=l)&&k.length;if(!g)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");t=z({},a);return"percent-of-total"!==t.normalizationType?[3,4]:[4,n.calculateStatsFromMemory({field:c},k)];case 3:p=m.sent();x=p.sum;if(null==x)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");t.normalizationTotal=x;m.label=4;case 4:return[2,n.calculateClassBreaksFromMemory(t,
k)]}})})};g.prototype._heatmapStatsFromMemory=function(a,c){return v(this,void 0,void 0,function(){var b,d,f,e,h,k,g,m,t,p,x,q;return w(this,function(l){switch(l.label){case 0:b=a.blurRadius;d=a.field;f=a.view;e=a.signal;h=f.state;k=h.resolution;g=h.size;m=new S.default({extent:f.extent,tolerance:k});t=new T({returnGeometry:!0,geometry:f.extent,quantizationParameters:m});if(!a.features)return[3,1];x=this._quantizeFeatures(a.features,m,f);return[3,3];case 1:return[4,this._fetchFeaturesFromMemory(f,
t,e)];case 2:x=l.sent(),l.label=3;case 3:p=x;if(!p||!p.length)return[2,{count:0,min:null,max:null,avg:null,stddev:null}];if(q=n.calculateHeatmapStats(p,b,c,d,g[0],g[1]))return[2,{count:q.count,min:q.min,max:q.max,avg:q.mean,stddev:q.stdDev}];throw new u("feature-layer-adapter:invalid","unable to calculate heatmap statistics");}})})};g.prototype._quantizeFeatures=function(a,c,b){var d=this,f=I.toQuantizationTransform(c);c=b.spatialReference;var e=b.size,h=J.isWrappable(c);b=J.getInfo(c);var k=Math.round((b.valid[1]-
b.valid[0])/f.scale[0]);return a.map(function(a){var b=new N.Point(O.unwrap(a.geometry));I.quantizePoint(f,b,b,b.hasZ,b.hasM);a.geometry=h?d._wrapPoint(b,k,e[0]):b;return a})};g.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};g.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};g.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:
null};g.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};g.prototype.summaryStatistics=function(a){var c=this,b=a.field,b=b?this.getField(b):null,d=B.isDateField(b),f=(b=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,e=a.view,e=e&&"3d"===e.type;return this._hasLocalSource||a.features||f?f||a.features||e?this._summaryStatsFromMemory(a,d):this._summaryStatsFromClientQuery(a,d):this.supportsSQLExpression||!d&&!b?(a.normalizationType&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(a):
this._summaryStatsFromServiceQuery(a,d)).catch(function(){q.throwIfAborted(a.signal);return c._summaryStatsFromMemory(a,d)}):q.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};g.prototype.uniqueValues=function(a){var c=this,b=a.field,d=a.valueExpression,f=a.sqlExpression,e=a.signal,h=(b?this.getField(b):null)&&this.getFieldDomain(b),k=d&&(!f||!this.supportsSQLExpression),g=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||
a.features||k?k||a.features||g?this._uvFromMemory(a,h):this._uvFromClientQuery(a,h):this._uvFromServiceQuery(a,h).catch(function(b){q.throwIfAborted(e);return a.field?c._uvFromGenRenderer(a,h):b}).catch(function(){q.throwIfAborted(e);return k||a.features||g?c._uvFromMemory(a,h):c._uvFromClientQuery(a,h)})};g.prototype.histogram=function(a){var c=this,b=a.field,d=a.normalizationType,f=a.normalizationField,e=a.classificationMethod,h=a.signal,k=b?this.getField(b):null,k=B.isDateField(k),g=a.valueExpression||
a.sqlExpression,m=g&&!a.sqlExpression,t=this.supportsSQLExpression,p=!e||"equal-interval"===e,x=a.minValue,w=a.maxValue,v=null!=x&&null!=w,y=a.numBins||10;return this._hasLocalSource||a.features||m?this._histogramFromMemory(a):(g||t)&&p?g&&!t?q.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):k&&p?q.reject(new u("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):
d||!p?this._binParamsFromGenRend(a).then(function(e){if(!v)return c._getBins(e,b,y,h);if(x>e.max||w<e.min)throw new u("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(p)return c._getBins({min:x,max:w,sqlExpr:e.sqlExpr,excludeZerosExpr:e.excludeZerosExpr},b,y,h);e=n.getFieldExpr({field:b,normalizationType:d,normalizationField:f,normalizationTotal:e.normTotal,layer:c});e=r.getRangeExpr(e,x,w);return c._binParamsFromGenRend(a,
e).then(function(a){return c._getBins(a,b,y,h)})}):this._histogramForField(a)};g.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||a.features||a.valueExpression;return b&&d?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(){q.throwIfAborted(a.signal);return c._classBreaksFromMemory(a)})};g.prototype.queryFeatureCount=function(a,c){if(this._hasLocalSource)return q.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support count query"));var b=this.layer,d=b.createQuery();d.where=r.mergeWhereClauses(d.where,a);return b.queryFeatureCount(d,{signal:c})};g.prototype.generateRenderer=function(a,c){var b=this.layer;if(this._hasLocalSource||10.1>b.version)return q.reject(new u("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var d=new R({url:b.parsedUrl.path,source:b.dynamicDataSource,gdbVersion:b.gdbVersion}),b=b.createQuery();
a.where=r.mergeWhereClauses(a.where,b.where);return d.execute(a,{signal:c})};g.prototype.heatmapStatistics=function(a){var c=this,b=a.field,d=a.fieldOffset,f=a.signal;return(b&&null==d?this.summaryStatistics({field:b,signal:f}):q.resolve(null)).then(function(b){var e=d||0;if(b){var f=b.min,g=b.max;b.count?f===g&&0===f?e=1:0>=g?e="abs":0>f&&(e=-1.01*f):e=1}return c._heatmapStatsFromMemory(a,e).then(function(a){return z({},a,{summaryStatistics:b,fieldOffset:e})})})};g.prototype.predominantCategories=
function(a){return v(this,void 0,void 0,function(){var c,b,d,f,e,h,g,l,m,t,p,n,q,r,y,v;return w(this,function(k){switch(k.label){case 0:if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new u("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");c=a.fields;b=a.view;d=a.signal;f=D.getArcadeForPredominantCategory(c);e=D.getSQLForPredominantCategoryName(c);return b&&this._hasLocalSource?[4,this._uvFromMemory({valueExpression:f,view:b,
signal:d})]:[3,2];case 1:return g=k.sent(),[3,4];case 2:return[4,this._uvFromServiceQuery({sqlExpression:e.expression,valueExpression:f,signal:d})];case 3:g=k.sent(),k.label=4;case 4:h=g;l=h.uniqueValueInfos;m=l.map(function(a){return a.value});t=c.filter(function(a){return-1===m.indexOf(a)});p=0;for(n=t;p<n.length;p++)q=n[p],l.push({value:q,count:0});l.sort(function(a,b){return c.indexOf(a.value)-c.indexOf(b.value)});r=0;for(y=l;r<y.length;r++)v=y[r],v.value===D.noDominantCategoryField&&(v.value=
null);return[2,{predominantCategoryInfos:l}]}})})};g.prototype.getSampleFeatures=function(a){return v(this,void 0,void 0,function(){var c,b,d,f,e,h,g,l,m,n,p,r,u,v;return w(this,function(k){switch(k.label){case 0:c=a.view,b=a.sampleSize,d=a.requiredFields,f=a.returnGeometry,e=a.signal,h=this.layer.createQuery(),g=1,h.outSpatialReference=a.spatialReference||c&&c.spatialReference,h.returnGeometry=!!f,h.outFields=d,l=[],m=!1,k.label=1;case 1:return k.trys.push([1,5,,6]),[4,this._hasRequiredFieldsInView(d,
c)];case 2:return(m=k.sent())?[4,this._fetchFeaturesFromMemory(c,h,e)]:[3,4];case 3:l=k.sent();if(l.length&&0<b&&b<=l.length)return[2,H.pickRandom(l,b,g)];k.label=4;case 4:return[3,6];case 5:return k.sent(),q.throwIfAborted(e),[3,6];case 6:return k.trys.push([6,10,,11]),this._hasLocalSource?[2,m?l:this._fetchFeaturesFromService(h,e)]:[4,this.queryFeatureCount(null,e)];case 7:n=k.sent();p=this.layer.capabilities.query.maxRecordCount;r=-1===b?n:b;r=p&&r>p?p:r;if(n<=l.length||l.length>=p)return[2,l];
u=c.extent.width/c.width/c.scale*4E5;h.maxAllowableOffset=a.resolution||u;return n<=r?[2,this._fetchFeaturesFromService(h,e)]:2E4>=n?[4,this.layer.queryObjectIds()]:[3,9];case 8:return v=k.sent(),h.objectIds=H.pickRandom(v,r,g),[2,this._fetchFeaturesFromService(h,e)];case 9:return this.layer.get("capabilities.query.supportsPagination")&&(h.num=Math.min(r,2E4)),[2,this._fetchFeaturesFromService(h,e)];case 10:return k.sent(),q.throwIfAborted(e),[2,l];case 11:return[2]}})})};g.prototype.load=function(a){var c=
this;a=this.layer.load(a).then(function(a){c.geometryType=a.geometryType;c.objectIdField=a.objectIdField;c.supportsSQLExpression=a.get("capabilities.query.supportsSqlExpression");c._hasLocalSource=!a.url&&!!a.source;c.hasQueryEngine=c._hasLocalSource;c.minScale=a.minScale;c.maxScale=a.maxScale;c.fullExtent=a.fullExtent});this.addResolvingPromise(a);return q.resolve(this)};G([C.property({constructOnly:!0})],g.prototype,"layer",void 0);return g=G([C.subclass("esri.renderers.smartMapping.support.adapters.FeatureLayerAdapter")],
g)}(C.declared(Q))});