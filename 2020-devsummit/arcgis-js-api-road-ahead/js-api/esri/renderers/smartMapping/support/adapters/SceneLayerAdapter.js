// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../Graphic ../../../../core/arrayUtils ../../../../core/Error ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/fieldUtils ../../statistics/support/utils ./FeatureLayerAdapter ./LayerAdapter ./support/utils ../../../../tasks/support/FeatureSet".split(" "),
function(H,I,p,C,x,q,m,y,z,l,f,D,t,w,E,F,G,n,A){return function(B){function c(a){return B.call(this,a)||this}C(c,B);c.prototype._hasCachedStatistics=function(a){return this.layer.hasCachedStatistics(a)};c.prototype._fetchFeaturesFromMemory=function(a,b){return a?a.whenLayerView(this.layer).then(function(a){var d=D.whenFalseOnce(a,"updating").then(function(){return a.queryFeatures(b)}).then(function(a){return"esri.tasks.support.FeatureSet"===a.declaredClass?a.features:a});return f.timeout(d,1E4,null)}):
f.reject(new l("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))};c.prototype._generateFeatureSetForCachedHistogram=function(a,b,d,g){void 0===b&&(b=a.minimum);void 0===d&&(d=a.maximum);for(var h=[],k=0;k<g;k++)h[k]=0;for(var e=a.counts.length,r=a.minimum,u=a.maximum,k=0;k<e;k++){var c=(k+.5)/e,c=((1-c)*r+c*u-b)/(d-b)*g;0<=c&&c<=g&&(h[c===g?g-1:Math.floor(c)]+=a.counts[k])}var f=[];h.forEach(function(a,b){var d=new y({attributes:{}});d.attributes.EXPR_1=
b+1;d.attributes.countOFExpr=a;f.push(d)});a=new A;a.features=f;return a};c.prototype._getCachedStatistics=function(a,b){var d=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?f.reject(new l("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):d.queryCachedStatistics(b&&b.name,{signal:a.signal}).then(function(a){var b=a.stats;a=b.min;
var d=b.max,e=b.avg,c=b.stddev,g=b.sum,f=b.variance,b=b.count;if(0!==a||0!==d)e=0===e?null:e,g=0===g?null:g,c=0===c?null:c,f=0===f?null:f,b=0===b?null:b;null==b&&null!=g&&null!=e&&(b=Math.round(g/e));return{avg:e,count:b,max:d,min:a,stddev:c,sum:g,variance:f}})};c.prototype._getSummaryStatisticsFromMemory=function(a,b){return m(this,void 0,void 0,function(){var d,g,c,k,e,r,f,v;return q(this,function(h){switch(h.label){case 0:if(!a.features)return[3,1];g=a.features;return[3,3];case 1:return[4,this._fetchFeaturesFromMemory(a.view)];
case 2:g=h.sent(),h.label=3;case 3:c=(d=g)&&d.length;if(!c)throw new l("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");k=w.isDateField(b);e=p({},a);return"percent-of-total"!==e.normalizationType?[3,5]:[4,n.calculateStatsFromMemory({field:e.field},d)];case 4:r=h.sent();f=r.sum;if(null==f)throw new l("scene-layer-adapter:invalid","invalid normalizationTotal");e.normalizationTotal=f;h.label=5;case 5:return[4,n.calculateStatsFromMemory(e,d,k)];case 6:return v=
h.sent(),[2,n.processSummaryStatisticsResult(v)]}})})};c.prototype._getCachedStatisticsForUniqueValues=function(a,b){var d=this,c=this.layer,h=b&&b.name,k=b&&this.getFieldDomain(a.field);return a.valueExpression||a.sqlExpression||a.sqlWhere?f.reject(new l("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):c.queryCachedStatistics(h,{signal:a.signal}).then(function(e){var g=e.stats;e=e.labels&&
e.labels.labels;var k={},f=[];if(g.mostFrequentValues){var l="countOF"+h;g.mostFrequentValues.forEach(function(a){var d=new y({attributes:{}});d.attributes[h]=b&&b.name!==c.objectIdField&&(w.isNumericField(b)||w.isDateField(b))?Number(a.value):a.value;d.attributes[l]=a.count;f.push(d)});e&&e.forEach(function(a){k[a.value]=a.label})}g=new A;g.features=f;return n.getUniqueValuesFromFeatureSet(g,d,a.field,k,a.signal)}).then(function(b){return n.createUVResult(b,k,a.returnAllCodedValues)})};c.prototype._getUniqueValuesFromMemory=
function(a,b){var d=b&&this.getFieldDomain(a.field);return(a.features?f.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(b){return n.calculateUniqueValuesFromMemory(a,b,d)})};c.prototype._getCachedStatisticsForHistogram=function(a,b){var d=this,c=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?f.reject(new l("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):
c.queryCachedStatistics(b&&b.name,{signal:a.signal}).then(function(b){b=b.stats;var c=a.minValue,e=a.maxValue,c=null!=c?c:b.min,e=null!=e?e:b.max,g=a.numBins||10;b=d._generateFeatureSetForCachedHistogram(b.histogram,c,e,g);return n.getHistogramFromFeatureSet(b,c,e,g)})};c.prototype._getClassBreaksFromMemory=function(a){return m(this,void 0,void 0,function(){var b,d,c,h,k,e;return q(this,function(g){switch(g.label){case 0:if(!a.features)return[3,1];d=a.features;return[3,3];case 1:return[4,this._fetchFeaturesFromMemory(a.view)];
case 2:d=g.sent(),g.label=3;case 3:c=(b=d)&&b.length;if(!c)throw new l("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");h=p({},a);return"percent-of-total"!==h.normalizationType?[3,5]:[4,n.calculateStatsFromMemory({field:h.field},b)];case 4:k=g.sent();e=k.sum;if(null==e)throw new l("scene-layer-adapter:invalid","invalid normalizationTotal");h.normalizationTotal=e;g.label=5;case 5:return[2,n.calculateClassBreaksFromMemory(h,b)]}})})};c.prototype._getHistogramFromMemory=
function(a){var b=this;return(a.features?f.resolve(a.features):this._fetchFeaturesFromMemory(a.view)).then(function(d){if(!d||!d.length)throw new l("scene-layer-adapter:insufficient-data","No features are available to calculate histogram");var c=a.field,h=a.normalizationType,k=a.valueExpression,e=a.classificationMethod,r=a.minValue,u=a.maxValue,v=a.view,q=null!=r&&null!=u,m=null;e&&"equal-interval"!==e||h?(c=p({},a),c.features=d,m=b._getBinParamsFromMemory(c)):m=q?f.resolve({min:r,max:u}):b.summaryStatistics({field:c,
valueExpression:k,features:d,view:v,signal:a.signal}).then(function(a){return a.count?{min:a.min,max:a.max}:f.reject(new l("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return m.then(function(b){return n.calculateHistogramFromMemory(a,b,d)})})};c.prototype._getBinParamsFromMemory=function(a){return m(this,void 0,void 0,function(){var b,d,c,h,k,e,f,l,m,p,t=this;return q(this,function(g){b=a.field;d=a.valueExpression;c=a.classificationMethod;h=a.standardDeviationInterval;
k=a.normalizationType;e=a.normalizationField;f=a.minValue;l=a.maxValue;m=a.features;p=a.view;return[2,this._getClassBreaksFromMemory({field:b,valueExpression:d,normalizationType:k,normalizationField:e,classificationMethod:c,standardDeviationInterval:h,minValue:f,maxValue:l,numClasses:a.numBins,features:m,view:p}).then(function(a){var c=a.normalizationTotal;a=a.classBreakInfos;var d=E.getSQLFilterForNormalization({field:b,normalizationType:k,normalizationField:e});return n.generateBinParams({field:b,
normalizationType:k,normalizationField:e,normalizationTotal:c,classBreaks:a,where:d,layer:t})})]})})};c.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};c.prototype.getFieldUsageInfo=function(a){a=this.getField(a);if(!a)return null;a=this.layer.getFieldUsageInfo(a.name);return{supportsLabelingInfo:a.supportsLabelingInfo,supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:!0}};c.prototype.getFieldDomain=
function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,b):null};c.prototype.summaryStatistics=function(a){var b=this,c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):this._hasCachedStatistics(c&&c.name)?this._getCachedStatistics(a,c).catch(function(){f.throwIfAborted(a.signal);return b._getSummaryStatisticsFromMemory(a,c)}):this._getSummaryStatisticsFromMemory(a,c)};c.prototype.uniqueValues=function(a){var b=
this,c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(c&&c.name)?this._getCachedStatisticsForUniqueValues(a,c).catch(function(){f.throwIfAborted(a.signal);return b._getUniqueValuesFromMemory(a,c)}):this._getUniqueValuesFromMemory(a,c)};c.prototype.histogram=function(a){var b=this,c=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):this._hasCachedStatistics(c&&c.name)?this._getCachedStatisticsForHistogram(a,
c).catch(function(){f.throwIfAborted(a.signal);return b._getHistogramFromMemory(a)}):this._getHistogramFromMemory(a)};c.prototype.classBreaks=function(a){var b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(a):this._hasCachedStatistics(b&&b.name)?f.reject(new l("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(a)};c.prototype.queryFeatureCount=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(a,
b):f.reject(new l("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};c.prototype.generateRenderer=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a,b):f.reject(new l("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};c.prototype.heatmapStatistics=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(a):
f.reject(new l("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))};c.prototype.predominantCategories=function(a){return m(this,void 0,void 0,function(){return q(this,function(b){if(this._featureLayerAdapter)return[2,this._featureLayerAdapter.predominantCategories(a)];throw new l("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support predominantCategories");})})};c.prototype.getSampleFeatures=
function(a){return m(this,void 0,void 0,function(){var b,c,g,h,f,e,m;return q(this,function(d){switch(d.label){case 0:if("mesh"===this.layer.geometryType)throw new l("scene-layer-adapter:not-supported","getSampleFeatures does not support scene layer with mesh geometry type");b=a.view;c=a.sampleSize;g=1;h=this.layer.createQuery();h.outFields=null;h.returnGeometry=!0;h.where=null;h.num=c;f=[];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this._fetchFeaturesFromMemory(b,h)];case 2:return f=d.sent(),
f.length&&0<c&&c<=f.length?[2,z.pickRandom(f,c,g)]:[3,4];case 3:return d.sent(),[3,4];case 4:e=null;if(!this._featureLayerAdapter)return[3,6];m=p({},a);delete m.view;return[4,this._featureLayerAdapter.getSampleFeatures(m)];case 5:e=d.sent(),d.label=6;case 6:return e&&e.length?[2,e]:[2,z.pickRandom(f,f.length,g)]}})})};c.prototype.load=function(a){var b=this,c=this.layer.load(a).then(function(c){var d=c.associatedLayer;b.geometryType=c.geometryType;if(d)return b._featureLayerAdapter=new F({layer:d}),
b._featureLayerAdapter.load(a).then(function(){b.objectIdField=b._featureLayerAdapter.objectIdField;b.supportsSQLExpression=b._featureLayerAdapter.supportsSQLExpression;b.minScale=b._featureLayerAdapter.minScale;b.maxScale=b._featureLayerAdapter.maxScale;b.fullExtent=b._featureLayerAdapter.fullExtent});b.objectIdField=c.objectIdField;b.supportsSQLExpression=!1;b.hasQueryEngine=!1;b.fullExtent=c.fullExtent});this.addResolvingPromise(c);return f.resolve(this)};x([t.property({constructOnly:!0})],c.prototype,
"layer",void 0);return c=x([t.subclass("esri.renderers.smartMapping.support.adapters.SceneLayerAdapter")],c)}(t.declared(G))});