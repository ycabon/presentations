// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../rasterRenderers ../../core/JSONSupport ../../core/Logger ../../core/accessorSupport/decorators ../../layers/support/RasterInfo ../../layers/support/rasterFunctions/pixelUtils ../../layers/support/rasterFunctions/surfaceUtils ../support/colorRampUtils".split(" "),function(E,F,m,A,t,G,H,v,
B,C,n,D,g,w,x){var y=C.getLogger("esri.renderers.support.RasterSymbolizer");return function(z){function e(a){return z.call(this,a)||this}A(e,z);e.prototype.readRenderer=function(a,b,c){return v.read(a,c)};e.prototype.bind=function(){this.lookup={};if(!this.renderer)return!1;var a;switch(this.renderer.type){case "unique-value":a=this._updateUVRenderer(this.renderer);break;case "raster-colormap":a=this._updateColormapRenderer(this.renderer);break;case "raster-stretch":a=this._updateStretchRenderer(this.renderer);
break;case "class-breaks":a=this._updateClassBreaksRenderer(this.renderer);break;case "raster-shaded-relief":a=this._updateShadedReliefRenderer(this.renderer)}return a};e.prototype.symbolize=function(a){var b=a&&a.pixelBlock;if(!this.isValidPixelBlock(b))return b;if(a.simpleStretchParams&&"raster-stretch"===this.renderer.type)return this.simpleStretch(b,a.simpleStretchParams);try{3<b.pixels.length&&(b=g.extractBands(b,[0,1,2]));var c=void 0;switch(this.renderer.type){case "unique-value":case "raster-colormap":c=
this._symbolize_colormap(b);break;case "class-breaks":c=this._symbolize_classBreaks(b);break;case "raster-stretch":c=this._symbolize_stretch(b);break;case "raster-shaded-relief":var f=a.extent,c=this._symbolize_shadedRelief(b,{isGCS:f.spatialReference.isGeographic,resolution:{x:(f.xmax-f.xmin)/b.width,y:(f.ymax-f.ymin)/b.height}})}return c}catch(d){return y.error("symbolize",d.message),b}};e.prototype.simpleStretch=function(a,b){if(!this.isValidPixelBlock(a))return a;try{return 3<a.pixels.length&&
(a=g.extractBands(a,[0,1,2])),g.stretch(a,b)}catch(c){return y.error("symbolize",c.message),a}};e.prototype.generateWebGLParameters=function(a){if(-1<["unique-value","raster-colormap","class-breaks"].indexOf(this.renderer.type)){var b=this.lookup.lut;return{colormap:b.indexedColormap,colormapOffset:b.colormapOffset,type:"lut"}}var b=a.pixelBlock,c=a.isGCS;a=a.resolution;return"raster-stretch"===this.renderer.type?this.generateStretchWebGLParams(b,this.renderer):"raster-shaded-relief"===this.renderer.type?
this.generateShadedReliefWebGLParams(this.renderer,c,a):null};e.prototype._isLUTChanged=function(a){if(!this.lookup)return!0;if("colorRamp"in this.renderer){var b=this.renderer.colorRamp;if(a)return JSON.stringify(b.toJSON())!==JSON.stringify(this.lookup.rendererJson.colorRamp);a=m({},this.renderer.toJSON());b=m({},this.lookup.rendererJson);a.colorRamp=null;b.colorRamp=null}return JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)};e.prototype._symbolize_colormap=function(a){return this._isLUTChanged()&&
!this.bind()?a:g.colorize(a,this.lookup.lut)};e.prototype._symbolize_classBreaks=function(a){var b=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType);return this._isLUTChanged()&&!this.bind()?a:b?g.colorize(a,this.lookup.lut):g.remapColor(a,this.lookup.lut)};e.prototype._symbolize_stretch=function(a){var b=this.rasterInfo.pixelType,c=this.renderer,f=-1<["u8","u16","s8","s16"].indexOf(b),d=c.gamma,u=c.useGamma;if(f){if(c.dynamicRangeAdjustment)f=this.getStretchCutoff(c,a),b=g.createStretchLUT(m({pixelType:b},
f,{gamma:u?d:null}));else{if(this._isLUTChanged()&&(d=this.bind(),!d))return a;b=this.lookup?this.lookup.lut:null}if(!b)return a;b=g.lookupPixels(a,b)}else f=this.getStretchCutoff(c,a),b=g.stretch(a,m({},f,{gamma:u?d:null}));if(c.colorRamp){if(this._isLUTChanged(!0)&&(d=this.bind(),!d))return a;b=g.colorize(b,this.lookup.colorRampLut)}return b};e.prototype._symbolize_shadedRelief=function(a,b){var c=this.renderer;b=m({},c.toJSON(),b);a=w.hillshade(a,b);return!c.colorRamp||this._isLUTChanged(!0)&&
!this.bind()?a:(c=this.lookup?this.lookup.colorRamplut:null)?g.lookupPixels(a,c):a};e.prototype._updateUVRenderer=function(a){var b=this.rasterInfo,c=b.bandCount,f=b.attributeTable,d=b.statistics,b=-1<["u8","s8"].indexOf(b.pixelType)&&d&&null!=d[0].min&&null!=d[0].max;if(1!==c||!f&&!b)return!1;var u=a.field;if(!u)return!1;var e=[];if(f){var r=f.fields.filter(function(a){return"value"===a.name.toLowerCase()})[0];if(!r)return!1;f.features.forEach(function(b){var c=a.uniqueValueInfos.filter(function(a){return String(a.value)===
String(b.attributes[u])})[0];(c=c&&c.symbol&&c.symbol.color)&&e.push([b.attributes[r.name],c.r,c.g,c.b,1<c.a?c.a:Math.round(255*c.a)])})}else{if("Value"!==u.toLowerCase())return!1;a.uniqueValueInfos.forEach(function(a){var b=a&&a.symbol&&a.symbol.color;b&&e.push([parseInt(a.value,10),b.r,b.g,b.b,1<b.a?b.a:Math.round(255*b.a)])})}if(0===e.length)return!1;c=g.createColormapLUT({colormap:e});this.lookup={rendererJson:a.toJSON(),lut:c};return this.canRenderInWebGL=!0};e.prototype._updateColormapRenderer=
function(a){var b=a.extractColormap();if(!b||0===b.length)return!1;b=g.createColormapLUT({colormap:b});this.lookup={rendererJson:a.toJSON(),lut:b};return this.canRenderInWebGL=!0};e.prototype._updateShadedReliefRenderer=function(a){if(a.colorRamp){var b=x.convertColorRampToColormap(a.colorRamp,256),b=g.createColormapLUT({colormap:b});this.lookup={rendererJson:a.toJSON(),colorRampLut:b}}else this.lookup=null;return this.canRenderInWebGL=!0};e.prototype._updateClassBreaksRenderer=function(a){var b=
-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType),c=a.classBreakInfos;if(!c||0===c.length)return!1;var f=c.sort(function(a,b){return a.minValue-b.minValue}),c=f[f.length-1];if(!b)return b=f.map(function(a){return{value:a.minValue,mappedColor:[a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,1<a.symbol.color.a?a.symbol.color.a:Math.round(255*a.symbol.color.a)]}}),b.push({value:c.maxValue,mappedColor:[c.symbol.color.g,c.symbol.color.b,1<c.symbol.color.a?c.symbol.color.a:Math.round(255*
c.symbol.color.a)]}),this.lookup={rendererJson:a.toJSON(),lut:b},this.canRenderInWebGL=!1,!0;var d=[],e,h=0;f.forEach(function(a){e=Math.ceil(a.minValue);h=Math.floor(a.maxValue);for(var b=e;b<h;b++)d.push([b,a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,1<a.symbol.color.a?a.symbol.color.a:Math.round(255*a.symbol.color.a)])});d.push([c.maxValue,c.symbol.color.r,c.symbol.color.g,c.symbol.color.b,1<c.symbol.color.a?c.symbol.color.a:Math.round(255*c.symbol.color.a)]);b=g.createColormapLUT({colormap:d,
fillUnspecified:!1});this.lookup={rendererJson:a.toJSON(),lut:b};return this.canRenderInWebGL=!0};e.prototype._updateStretchRenderer=function(a){if(!(a.statistics||this.rasterInfo.statistics||a.dynamicRangeAdjustment))return!1;var b=a.histograms||this.rasterInfo.histograms;if(!a.dynamicRangeAdjustment&&"percent-clip"===a.stretchType&&!b)return!1;var c=a.gamma,f=a.useGamma,b=a.colorRamp,d=this.rasterInfo.pixelType;if(!a.dynamicRangeAdjustment&&-1<["u8","u16","s8","s16"].indexOf(d)){var e=this.getStretchCutoff(a),
c=g.createStretchLUT(m({pixelType:d},e,{gamma:f?c:null}));this.lookup={rendererJson:a.toJSON(),lut:c}}b&&(b=x.convertColorRampToColormap(b,256),this.lookup.colorRampLut=g.createColormapLUT({colormap:b}),this.lookup.rendererJson=a.toJSON());return this.canRenderInWebGL=!0};e.prototype.getStretchCutoff=function(a,b){var c,f,d=a.stretchType;a.dynamicRangeAdjustment?"min-max"===d&&b.statistics?c=b.statistics.map(function(a){return[a.minValue,a.maxValue,0,0]}):(f=g.estimateStatisticsHistograms(b),c=f.statistics,
f=f.histograms):(c=a.statistics&&0<a.statistics.length?a.statistics:this.rasterInfo.statistics,f=a.histograms||this.rasterInfo.histograms);b=c||f?(c||f).length:this.rasterInfo.bandCount;var e=[],h=[],r,m,p,q,k,l;c[0]instanceof Array||(c=c.map(function(a){return[a.min,a.max,a.avg,a.stddev]}));switch(d){case "min-max":for(d=0;d<b;d++)e[d]=c[d][0],h[d]=c[d][1];break;case "standard-deviation":for(d=0;d<b;d++)e[d]=c[d][2]-a.numberOfStandardDeviations*c[d][3],h[d]=c[d][2]+a.numberOfStandardDeviations*c[d][3],
e[d]<c[d][0]&&(e[d]=c[d][0]),h[d]>c[d][1]&&(h[d]=c[d][1]);break;case "percent-clip":for(d=0;d<b;d++){c=f[d];q=new Uint32Array(c.size);p=c.counts;m=0;r=(c.max-c.min)/c.size;k=-.5===c.min&&1===r?.5:0;for(l=0;l<c.size;l++)m+=p[l],q[l]=m;p=a.minPercent*m/100;for(l=0;l<c.size;l++)if(q[l]>p){e[d]=c.min+r*(l+k);break}p=(1-a.maxPercent/100)*m;for(l=c.size-2;0<=l;l--)if(q[l]<p){h[d]=c.min+r*(l+2-k);break}}break;default:for(d=0;d<b;d++)e[d]=c[d][0],h[d]=c[d][1]}return{minCutOff:e,maxCutOff:h,outMax:a.outputMax||
255,outMin:a.outputMin||0}};e.prototype.generateStretchWebGLParams=function(a,b){var c=null,e=null,d=this.lookup&&this.lookup.colorRampLut;b.colorRamp&&d&&(c=d.indexedColormap,e=d.offset);var d=b.gamma,g=b.useGamma,h=this.getStretchCutoff(b,a);b=h.minCutOff;var m=h.maxCutOff,n=h.outMin,h=h.outMax;a&&a.pixels&&2===a.pixels.length&&(a=a.clone(),a.statistics=[a.statistics[0]],a.pixels=[a.pixels[0]]);a=Math.min(3,a&&a.getPlaneCount()||this.rasterInfo.bandCount);var p=new Float32Array(a),q=null==c?255:
1,k;for(k=0;k<a;k++)p[k]=(h-n)/(m[k]-b[k])/q;var l=new Float32Array(a);if(g)for(k=0;k<a;k++)l[k]=1<d[k]?2<d[k]?6.5+Math.pow(d[k]-2,2.5):6.5+100*Math.pow(2-d[k],4):1;return{bandCount:a,outMin:n/q,outMax:h/q,minCutOff:b,maxCutOff:m,factor:p,useGamma:g,gamma:g?d:[1,1,1],gammaCorrection:g?l:[1,1,1],colormap:c,colormapOffset:e,type:"stretch"}};e.prototype.generateShadedReliefWebGLParams=function(a,b,c){var e=null,d=null,g=this.lookup&&this.lookup.colorRampLut;a.colorRamp&&g&&(e=g.indexedColormap,d=g.offset);
b=m({},a.toJSON(),{isGCS:b,resolution:c});b=w.calculateHillshadeParams(b);return m({},b,{hillshadeType:"traditional"===a.hillshadeType?0:1,type:"hillshade",colormap:e,colormapOffset:d})};e.prototype.isValidPixelBlock=function(a){return!!(a&&a.pixels&&0<a.pixels.length&&0!==a.validPixelCount)};t([n.property({types:v.rasterRendererTypes,json:{write:!0}})],e.prototype,"renderer",void 0);t([n.reader("renderer")],e.prototype,"readRenderer",null);t([n.property({type:D,json:{write:!0}})],e.prototype,"rasterInfo",
void 0);t([n.property({json:{write:!0}})],e.prototype,"lookup",void 0);t([n.property({})],e.prototype,"canRenderInWebGL",void 0);return e=t([n.subclass("esri.renderers.support.RasterSymbolizer")],e)}(n.declared(B.JSONSupport))});