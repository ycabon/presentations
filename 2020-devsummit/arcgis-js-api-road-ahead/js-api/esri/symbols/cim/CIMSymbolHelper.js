// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../Color ../../core/Logger ../../geometry/support/jsonUtils ../cim/CIMCursor ../cim/CIMEffects ../cim/CIMOperators ../cim/CIMPlacements ./CIMSymbolDrawHelper ./packingUtils".split(" "),function(m,q,B,C,t,u,x,D,y,v,E){function w(e,a){switch(a.type){case "CIMSymbolReference":var b={type:"point",x:0,y:0};e.drawSymbol(a.symbol,b);break;case "CIMPointSymbol":b={type:"point",x:0,y:0};e.drawSymbol(a,b);break;case "CIMVectorMarker":b=new y.Placement,e.drawMarker(a,b)}return e.envelope()}
Object.defineProperty(q,"__esModule",{value:!0});var z=Math.PI,F=z/2,A=C.getLogger("esri.symbols.cim.CIMSymbolHelper");m=function(){function e(){}e.getEnvelope=function(a){var b=new v.EnvDrawHelper;if(Array.isArray(a)){for(var c=void 0,d=0;d<a.length;d++){var f=a[d];c?c.union(w(b,f)):c=w(b,f)}return c}return w(b,a)};e.getTextureAnchor=function(a){a=this.getEnvelope(a);if(!a||0>=a.width||0>=a.height)return[0,0];var b=96/72;return[(a.x+.5*a.width)*b/(a.width*b+2),-(a.y+.5*a.height)*b/(a.height*b+2)]};
e.rasterize=function(a,b,c){void 0===c&&(c=!0);var d=this.getEnvelope(b);if(!d||0>=d.width||0>=d.height)return[null,0,0,0,0];var f=96/72,g=(d.x+.5*d.width)*f,e=(d.y+.5*d.height)*f;a.width=d.width*f+2;a.height=d.height*f+2;d=a.getContext("2d");f=v.Transformation.createScale(f,-f);f.translate(.5*a.width-g,.5*a.height+e);f=new v.CanvasDrawHelper(d,f);switch(b.type){case "CIMPointSymbol":f.drawSymbol(b,{type:"point",x:0,y:0});break;case "CIMVectorMarker":var h=new y.Placement;f.drawMarker(b,h)}b=d.getImageData(0,
0,a.width,a.height);b=new Uint8Array(b.data);if(c)for(c=void 0,d=0;d<b.length;d+=4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;return[b,a.width,a.height,-g/a.width,-e/a.height]};e.fromSimpleMarker=function(a){var b,c,d=a.style;if("circle"===d||"esriSMSCircle"===d){b=Math.acos(.995);c=Math.ceil(z/b/4);0===c&&(c=1);b=F/c;c*=4;d=[];d.push([50,0]);for(var f=1;f<c;f++)d.push([50*Math.cos(f*b),-50*Math.sin(f*b)]);d.push([50,0]);b={rings:[d]};c={xmin:-50,ymin:-50,xmax:50,ymax:50}}else if("cross"===d||"esriSMSCross"===
d)b=0,b={rings:[[[b,50],[b,b],[50,b],[50,-b],[b,-b],[b,-50],[-b,-50],[-b,-b],[-50,-b],[-50,b],[-b,b],[-b,50],[b,50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("diamond"===d||"esriSMSDiamond"===d)b={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===d||"esriSMSSquare"===d)b={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===d||"esriSMSX"===d)b=0,b={rings:[[[0,b],[50-b,50],[50,50-
b],[b,0],[50,b-50],[50-b,-50],[0,-b],[b-50,-50],[-50,b-50],[-b,0],[-50,50-b],[b-50,50],[0,b]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===d||"esriSMSTriangle"===d)c=2/3*100,d=c-100,b={rings:[[[-57.735026918962575,d],[0,c],[57.735026918962575,d],[-57.735026918962575,d]]]},c={xmin:-57.735026918962575,ymin:d,xmax:57.735026918962575,ymax:c};var g;b&&c&&(g=[{type:"CIMSolidFill",enable:!0,color:a.color}],a.outline&&g.push({type:"CIMSolidStroke",enable:!0,width:a.outline.width,color:a.outline.color}),
g={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:a.angle,size:a.size,offsetX:a.xoffset,offsetY:a.yoffset,frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:b,symbol:{type:"CIMPolygonSymbol",symbolLayers:g}}]}]});return g};e.getFillColor=function(a){if(!a)return null;switch(a.type){case "CIMPolygonSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=e.getFillColor(a[b]);if(null!=c)return c}}break;case "CIMTextSymbol":return e.getFillColor(a.symbol);
case "CIMSolidFill":return a.color}};e.getStrokeColor=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=e.getStrokeColor(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return e.getStrokeColor(a.symbol);case "CIMSolidStroke":return a.color}};e.getStrokeWidth=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=
e.getStrokeWidth(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return e.getStrokeWidth(a.symbol);case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return a.width}};e.getSize=function(a){if(a)switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":var b=0;if(a.symbolLayers){var c=0;for(a=a.symbolLayers;c<a.length;c++){var d=e.getSize(a[c]);d>b&&(b=d)}}return b;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return a.width;
case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return a.size}};e.getMarkerScaleRatio=function(a){if(a)switch(a.type){case "CIMVectorMarker":if(!1!==a.scaleSymbolsProportionally&&a.frame)return a.size/(a.frame.ymax-a.frame.ymin)}return 1};e.executeEffects=function(a,b,c){void 0===c&&(c=!1);var d=96/72,f=a?a.length:0;f&&c&&--f;for(c=0;c<f;++c){var g=a[c];if(g){var e=D.getEffectOperator(g);e&&(b=e.execute(b,g,d))}}return b};e.processEffects=function(a,b,c){var d;a.effects&&
0<a.effects.length&&(d=u.deltaEncodeGeometry(c),d=new x.SimpleGeometryCursor(d),d=e.executeEffects(a.effects,d));a=a.symbolLayers[b];a.effects&&0<a.effects.length&&(b=!1,"CIMGeometricEffectDashes"===a.effects[a.effects.length-1].type&&(b=!0),d||(d=u.deltaEncodeGeometry(c),d=new x.SimpleGeometryCursor(d)),d=e.executeEffects(a.effects,d,b));if(!d)return c;c=[];for(a=d.next();a;)c.push(a),a=d.next();d=c.length;switch(d){case 0:return null;case 1:return u.deltaEncodeGeometry(c[0]);default:a=c[0];for(b=
1;b<d;++b){var f=c[b];t.isPolygon(a)&&t.isPolygon(f)&&Array.prototype.push.apply(a.rings,f.rings);t.isPolyline(a)&&t.isPolyline(f)&&Array.prototype.push.apply(a.paths,f.paths)}return u.deltaEncodeGeometry(a)}};return e}();q.CIMSymbolHelper=m;m=function(){function e(){}e.rasterizeSimpleFill=function(a,b){"solid"!==b&&"none"!==b&&"esriSFSSolid"!==b&&"esriSFSNull"!==b||console.error("Unexpected: style does not require rasterization");a.width=8;a.height=8;var c=a.getContext("2d");c.strokeStyle="#FFFFFF";
c.lineWidth=1;c.beginPath();if("vertical"===b||"cross"===b||"esriSFSCross"===b||"esriSFSVertical"===b)c.moveTo(0,0),c.lineTo(0,8);if("horizontal"===b||"cross"===b||"esriSFSCross"===b||"esriSFSHorizontal"===b)c.moveTo(0,0),c.lineTo(8,0);if("forward-diagonal"===b||"diagonal-cross"===b||"esriSFSDiagonalCross"===b||"esriSFSForwardDiagonal"===b)c.moveTo(0,0),c.lineTo(8,8);if("backward-diagonal"===b||"diagonal-cross"===b||"esriSFSBackwardDiagonal"===b||"esriSFSDiagonalCross"===b)c.moveTo(8,0),c.lineTo(0,
8);c.stroke();b=c.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);for(var d=0;d<b.length;d+=4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;return[b,a.width,a.height]};e.rasterizeSimpleLine=function(a,b){switch(b){case "butt":b="Butt";break;case "square":b="Square";break;default:b="Round"}var c="Butt"===b;switch(a){case "dash":case "esriSLSDash":a=c?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=c?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=c?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=
c?[8,3]:[7,4];break;case "long-dash-dot":case "esriSLSLongDashDot":a=c?[8,3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=c?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=c?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=c?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=c?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=c?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":A.error("Unexpected: style does not require rasterization");
a=[0,0];break;default:A.error("Tried to rasterize SLS, but found an unexpected style: "+a+"!"),a=[0,0]}return this.rasterizeDash(a,b)};e.rasterizeDash=function(a,b){var c="Butt"===b,d="Square"===b;b=!c&&!d;for(var f=0,g=0;g<a.length;g++)var e=a[g],f=f+e;for(var f=15*f,h=31*f,g=new Float32Array(h),k=b?225:15,e=0;e<h;++e)g[e]=k;for(var k=h=0,m=!0,q=0;q<a.length;q++){for(var e=a[q],h=k,k=k+15*e,n=h;n<k;){for(var r=0;31>r;){var e=r*f+n,p=b?(r-15)*(r-15):Math.abs(r-15);g[e]=m?c?Math.max(Math.max(h+7.5-
n,p),Math.max(n-k+7.5,p)):p:b?Math.min((n-h)*(n-h)+p,(n-k)*(n-k)+p):d?Math.min(Math.max(n-h,p),Math.max(k-n,p)):Math.min(Math.max(n-h+7.5,p),Math.max(k+7.5-n,p));r++}n++}m=!m}a=g.length;c=new Uint8Array(4*a);for(e=0;e<a;++e)E.packFloatRGBA((b?Math.sqrt(g[e]):g[e])/15,c,4*e);return[c,f,31]};return e}();q.SymbolHelper=m;m=function(){function e(){}e.findApplicableOverrides=function(a,b,c){if(b){if(a.primitiveName){for(var d=!1,f=0;f<c.length;f++){var g=c[f];if(g.primitiveName===a.primitiveName){d=!0;
break}}if(!d)for(d=0;d<b.length;d++)g=b[d],g.primitiveName===a.primitiveName&&c.push(g)}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(d=0,f=a.effects;d<f.length;d++)g=f[d],e.findApplicableOverrides(g,b,c);if(a.symbolLayers)for(g=0,a=a.symbolLayers;g<a.length;g++)e.findApplicableOverrides(a[g],b,c);break;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":case "CIMSolidFill":case "CIMPictureFill":case "CIMHatchFill":case "CIMGradientFill":case "CIMVectorMarker":case "CIMCharacterMarker":case "CIMPictureMarker":if(a.effects)for(d=
0,f=a.effects;d<f.length;d++)g=f[d],e.findApplicableOverrides(g,b,c);a.markerPlacement&&e.findApplicableOverrides(a.markerPlacement,b,c);if("CIMVectorMarker"===a.type){if(a.markerGraphics)for(g=0,a=a.markerGraphics;g<a.length;g++)d=a[g],e.findApplicableOverrides(d,b,c),e.findApplicableOverrides(d.symbol,b,c)}else"CIMCharacterMarker"===a.type?e.findApplicableOverrides(a.symbol,b,c):"CIMHatchFill"===a.type&&e.findApplicableOverrides(a.lineSymbol,b,c)}}};e.applyOverrides=function(a,b,c,d){if(b){if(a.primitiveName)for(var f=
0;f<b.length;f++){var g=b[f];if(g.primitiveName===a.primitiveName){var l;l=(l=g.propertyName)?l.charAt(0).toLowerCase()+l.substr(1):l;d&&d.push({cim:a,nocapPropertyName:l,value:a[l]});g.expression&&(g.value=e.toValue(g.propertyName,g.expression));if(c){for(var h=!1,k=0,m=c;k<m.length;k++)m[k].primitiveName===a.primitiveName&&(h=!0);h||c.push(g)}a[l]=g.value}}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(g=0,l=a.effects;g<l.length;g++)f=l[g],e.applyOverrides(f,
b,c,d);if(a.symbolLayers)for(f=0,a=a.symbolLayers;f<a.length;f++)e.applyOverrides(a[f],b,c,d);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(a.effects)for(g=0,l=a.effects;g<l.length;g++)f=l[g],e.applyOverrides(f,b,c,d);if("CIMVectorMarker"===a.type&&a.markerGraphics)for(f=0,a=a.markerGraphics;f<a.length;f++)g=a[f],e.applyOverrides(g,b,c,d),e.applyOverrides(g.symbol,b,c,d)}}};e.restoreOverrides=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.cim[c.nocapPropertyName]=
c.value}};e.buildOverrideKey=function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];void 0!==d.value&&(b+=""+d.primitiveName+d.propertyName+JSON.stringify(d.value))}return b};e.toValue=function(a,b){return"DashTemplate"===a?b.split(" ").map(function(a){return Number(a)}):"Color"===a?(a=(new B(b)).toRgba(),a[3]*=255,a):b};return e}();q.OverrideHelper=m});