// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../request ../../core/promiseUtils ../../core/screenUtils ../../geometry/support/jsonUtils ./cimAnalyzer ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(W,X,w,F,P,G,r,Q,H,R,S,g,T,U){function V(a){return(a?Object.keys(a):[]).map(function(b){return{name:b,alias:b,type:"string"===typeof a[b]?"esriFieldTypeString":"esriFieldTypeDouble"}})}
var L=function(a,b){return a&&a.targetSize?a.targetSize/b.referenceSize:a&&a.scaleFactor?a.scaleFactor:1};return function(){function a(b,c){this._spatialReference=b;this._avoidSDF=c;this._resourceCache=new Map;this._rasterizer=new R.default;this._textRasterizer=new S.default;this._pictureMarkerCache=new Map}a.prototype.rasterizeCIMSymbolAsync=function(b,c,h,e,d,f,D){return F(this,void 0,void 0,function(){var k,a;return w(this,function(g){switch(g.label){case 0:return k=c?null!==c.centroid?"esriGeometryPolygon":
Q.getJsonType(c.geometry):null,[4,this.analyzeCIMSymbol(b,c?V(c.attributes):null,h,k,D)];case 1:return a=g.sent(),[2,this.rasterizeCIMSymbol(a,c,e,d,f)]}})})};a.prototype.analyzeCIMSymbol=function(b,c,h,e,d){return F(this,void 0,void 0,function(){var f,D,k,a,g,p,t;return w(this,function(n){switch(n.label){case 0:return[4,T.fetchSymbol(b,d)];case 1:return f=n.sent(),D=[],c?k={geometryType:e,spatialReference:this._spatialReference,fields:c}:(f=f.clone(),f.data.primitiveOverrides=[],k=null),[4,H.analyzeCIMSymbol(f.data,
h,k,D,this._avoidSDF)];case 2:n.sent();G.throwIfAborted(d);g=0;for(p=D;g<p.length;g++)t=p[g],"CIMPictureMarker"===t.cim.type&&(a||(a=[]),a.push(this.fetchPictureMarkerResource(t,d)));return a?[4,G.all(a)]:[3,4];case 3:n.sent(),n.label=4;case 4:return[2,D]}})})};a.prototype.fetchPictureMarkerResource=function(b,c){return F(this,void 0,void 0,function(){var h,e,d;return w(this,function(f){switch(f.label){case 0:return h=b.materialHash,this._pictureMarkerCache.get(h)?[3,2]:[4,P(b.cim.url,{responseType:"image",
signal:c&&c.signal})];case 1:e=f.sent(),d=e.data,this._pictureMarkerCache.set(h,d),f.label=2;case 2:return[2]}})})};a.prototype.rasterizeCIMSymbol=function(b,c,h,e,d){for(var f=[],a=0;a<b.length;a++){var k=b[a];!h||"function"!==typeof h.scaleFactor||"marker"!==k.type&&"text"!==k.type||(h.scaleFactor=h.scaleFactor(c,e,d));var g=this._getRasterizedResource(k,c,h,e,d);null!=g&&f.push({cimLayer:k,rasterizedResource:g})}return this.getSymbolImage(f,c,h,e,d)};a.prototype.getSymbolImage=function(b,c,h,e,
d){for(var f=document.createElement("canvas"),a=f.getContext("2d"),k=0,K=0,E=0,p=0,t=[],n=0;n<b.length;n++){var q=b[n],m=q.rasterizedResource;if(m){var l=q.cimLayer;if("line"!==l.type&&"fill"!==l.type){var x=L(h,l),B=m.size,I=g.evaluateValueOrFunction(l.offsetX,c,e,d)*x,x=g.evaluateValueOrFunction(l.offsetY,c,e,d)*x,I=I?I:0,x=x?x:0,J=q.rasterizedResource.anchorX,q=q.rasterizedResource.anchorY,w=!1,F=l.type,y=void 0;"marker"===l.type&&(y=g.evaluateValueOrFunction(l.rotation,c,e,d),w=l.rotateClockwise?
l.rotateClockwise:!1);if("text"===l.type){y=g.evaluateValueOrFunction(l.angle,c,e,d);if(void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case "left":J=-.5;break;case "right":J=.5;break;default:J=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case "top":q=.5;break;case "bottom":q=-.5;break;case "baseline":q=-.25;break;default:q=0}}var l=r.pt2px(I)-B[0]*(.5+J),z=r.pt2px(x)-B[1]*(.5+q),C=l+B[0],v=z+B[1];if(y){w&&(y=-y);var u=Math.sin(y*Math.PI/180),A=Math.cos(y*Math.PI/180),
B=l*A-z*u,G=l*u+z*A,H=l*A-v*u,M=l*u+v*A,N=C*A-v*u,v=C*u+v*A,O=C*A-z*u,u=C*u+z*A,l=Math.min(B,H,N,O),z=Math.min(G,M,v,u),C=Math.max(B,H,N,O),v=Math.max(G,M,v,u)}k=l<k?l:k;K=z<K?z:K;E=C>E?C:E;p=v>p?v:p;l=a.createImageData(m.size[0],m.size[1]);l.data.set(new Uint8ClampedArray(m.image.buffer));m={offsetX:I,offsetY:x,rotateClockwise:w,type:F,angle:y,rasterizedImage:l,anchorX:J,anchorY:q};t.push(m)}}}f.width=E-k;f.height=p-K;b=-k;for(n=0;n<t.length;n++)m=t[n],c=this._imageDataToCanvas(m.rasterizedImage),
h=b-m.rasterizedImage.width*(.5+m.anchorX),e=p-m.rasterizedImage.height*(.5-m.anchorY),m.angle?(d=(360-m.angle)*Math.PI/180,a.save(),a.translate(r.pt2px(m.offsetX),-r.pt2px(m.offsetY)),a.translate(b,p),a.rotate(d),a.translate(-b,-p),a.drawImage(c,h,e),a.restore()):a.drawImage(c,h+r.pt2px(m.offsetX),e-r.pt2px(m.offsetY));t=new U.default({x:b/f.width-.5,y:p/f.height-.5});return{imageData:0!==f.width&&0!==f.height?a.getImageData(0,0,f.width,f.height):a.createImageData(1,1),anchorPosition:t}};a.prototype._imageDataToCanvas=
function(b){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var c=this._imageDataCanvas,a=c.getContext("2d");c.width=b.width;c.height=b.height;a.putImageData(b,0,0);return c};a.prototype._imageTo32Array=function(b,c,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var e=this._imageDataCanvas,d=e.getContext("2d");e.width=c;e.height=a;d.drawImage(b,0,0,c,a);return new Uint32Array(d.getImageData(0,0,c,a).data.buffer)};a.prototype._getRasterizedResource=
function(b,c,a,e,d){var f;if("text"===b.type)f=b.cim,b=this._rasterizeTextResource(b,c,a,e,d);else{var h=this._resourceCache,k=void 0;"function"===typeof b.materialHash?(k=b.materialHash,k=k(c,e,d),f=H.analyzeCIMResource(b.cim,b.materialOverrides)):(k=b.materialHash,a&&(k+=JSON.stringify(a)),f=b.cim);if(h.has(k))return h.get(k);a=L(a,b);if("CIMPictureMarker"===b.cim.type){d=g.evaluateValueOrFunction(b.cim.size,c,e,d)*a;c=this._pictureMarkerCache.get(b.materialHash);if(!c)return null;a=c.height/c.width;
e=1<a?r.pt2px(d):r.pt2px(d)/a;d=1<a?r.pt2px(d)*a:r.pt2px(d);b={image:this._imageTo32Array(c,e,d),size:[e,d],sdf:!1,simplePattern:!1,anchorX:b.anchorPoint?b.anchorPoint.x:0,anchorY:b.anchorPoint?b.anchorPoint.y:0}}else f.size*=a,b=this._rasterizer.rasterizeJSONResource(f,this._avoidSDF);h.set(k,b)}return b};a.prototype._rasterizeTextResource=function(b,a,h,e,d){var c=L(h,b);h=g.evaluateValueOrFunction(b.text,a,e,d);if(!h||0===h.length)return null;var r=g.evaluateValueOrFunction(b.fontName,a,e,d),k=
g.evaluateValueOrFunction(b.style,a,e,d),w=g.evaluateValueOrFunction(b.weight,a,e,d),E=g.evaluateValueOrFunction(b.decoration,a,e,d),c=g.evaluateValueOrFunction(b.size,a,e,d)*c,p=g.evaluateValueOrFunction(b.horizontalAlignment,a,e,d),t=g.evaluateValueOrFunction(b.verticalAlignment,a,e,d),n=g.colorToArray(g.evaluateValueOrFunction(b.color,a,e,d)),q=g.colorToArray(g.evaluateValueOrFunction(b.outlineColor,a,e,d));b=g.evaluateValueOrFunction(b.outlineSize,a,e,d);return this._textRasterizer.rasterizeText(h,
{color:n,size:c,horizontalAlignment:p,verticalAlignment:t,font:{family:r,style:k,weight:w,decoration:E},halo:{size:b||0,color:q,style:k},pixelRatio:1,premultiplyColors:!this._avoidSDF})};return a}()});