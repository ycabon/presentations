// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/assignHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../request ../core/compilerUtils ../core/promiseUtils ../core/accessorSupport/decorators ../geometry/Extent ../geometry/SpatialReference ../geometry/support/normalizeUtils ../layers/support/Field ../layers/support/MapImage ./Task ./support/DataFile ./support/FeatureSet ./support/GPMessage ./support/JobInfo ./support/LinearUnit ./support/ParameterValue ./support/RasterData".split(" "),
function(C,L,k,D,h,E,F,p,r,n,f,G,w,H,x,y,I,t,u,J,q,z,K,A){return function(B){function c(b){b=B.call(this,b)||this;b._timers=new Map;b.outSpatialReference=null;b.processExtent=null;b.processSpatialReference=null;b.returnFeatureCollection=!1;b.returnM=!1;b.returnZ=!1;return b}D(c,B);c.prototype.destroy=function(){this._timers.forEach(function(b){clearInterval(b)})};c.prototype.cancelJob=function(b,d){var a=this.parsedUrl.path;d=k({},this.requestOptions,d,{query:{f:"json"}});this._clearTimer(b);return p(a+
"/jobs/"+b+"/cancel",d).then(function(a){return q.fromJSON(a.data)})};c.prototype.checkJobStatus=function(b,d){var a=this.parsedUrl.path;d=k({},this.requestOptions,d,{query:{f:"json"}});return p(a+"/jobs/"+b,d).then(function(a){return q.fromJSON(a.data)})};c.prototype.execute=function(b,d){var a=this;return this._constructRequest("execute",b,d).then(function(b){var d=b.data.messages||[];return{results:(b.data.results||[]).map(a._decode),messages:d.map(function(a){return J.fromJSON(a)})}})};c.prototype.getResultData=
function(b,d,a){var e=this,g=this.parsedUrl.path,c=this._gpEncode({returnFeatureCollection:this.returnFeatureCollection||void 0,returnM:this.returnM||void 0,returnZ:this.returnZ||void 0,outSR:this.outSpatialReference,returnType:"data",f:"json"},null);a=k({},this.requestOptions,a,{query:c});return p(g+"/jobs/"+b+"/results/"+d,a).then(function(a){return e._decode(a.data)})};c.prototype.getResultImage=function(b,d,a,e){var c=this,l=this.parsedUrl.path;a=k({},a.toJSON(),{f:"json"});a=this._gpEncode(a);
e=k({},this.requestOptions,e,{query:a});return p(l+"/jobs/"+b+"/results/"+d,e).then(function(a){return c._decode(a.data)})};c.prototype.getResultMapImageLayer=function(b){return F(this,void 0,void 0,function(){var d,a,e,c,l;return E(this,function(g){switch(g.label){case 0:return d=this.parsedUrl.path,a=d.indexOf("/GPServer/"),e=d.substring(0,a),c=e+"/MapServer/jobs/"+b,[4,n.create(function(a){return C(["../layers/MapImageLayer"],a)})];case 1:return l=g.sent(),[2,new l({url:c})]}})})};c.prototype.submitJob=
function(b,d){return this._constructRequest("submitJob",b,d).then(function(a){return q.fromJSON(a.data)})};c.prototype.waitForJobCompletion=function(b,d){var a=this;void 0===d&&(d={});var e=d.interval,c=void 0===e?1E3:e,l=d.signal,k=d.statusCallback;return n.create(function(d,e){n.onAbort(l,function(){a._clearTimer(b);e(n.createAbortError())});a._clearTimer(b);var g=setInterval(function(){a._timers.has(b)||e(n.createAbortError());a._getJobStatus(b,a.requestOptions).then(function(c){var g=c.jobStatus;
switch(g){case "job-succeeded":a._clearTimer(b);d(c);break;case "job-submitted":case "job-executing":case "job-waiting":case "job-new":k&&k(c);break;case "job-cancelled":case "job-cancelling":case "job-deleted":case "job-deleting":case "job-timed-out":case "job-failed":a._clearTimer(b);e(c);break;default:r.neverReached(g)}})},c);a._timers.set(b,g)})};c.prototype._clearTimer=function(b){this._timers.has(b)&&(clearInterval(this._timers.get(b)),this._timers.delete(b))};c.prototype._constructRequest=
function(b,d,a){var e=this,c={},l={},f=[];this._collectGeometries(d,f,c);return H.normalizeCentralMeridian(f).then(function(g){var f=e.outSpatialReference,m=e.processExtent,h=e.processSpatialReference,n=e.returnFeatureCollection,q=e.returnM,t=e.returnZ,u=e.parsedUrl.path,v;for(v in c){var r=c[v];l[v]=g.slice(r[0],r[1])}g=f?f.wkid||f:null;h=h?h.wkid||h:null;m=k({},m?{context:{extent:m,outSR:g,processSR:h}}:{"env:outSR":g,"env:processSR":h},d,"execute"===b?{returnFeatureCollection:n||void 0,returnM:q||
void 0,returnZ:t||void 0}:null,{f:"json"});m=e._gpEncode(m,null,l);m=k({},e.requestOptions,a,{query:m});return p(u+"/"+b,m)})};c.prototype._collectGeometries=function(b,d,a){for(var e in b){var c=b[e];c&&"object"===typeof c&&c instanceof u&&(c=c.features,a[e]=[d.length,d.length+c.length],c.forEach(function(a){d.push(a.geometry)}))}};c.prototype._decode=function(b){var c=b.dataType,a=K.fromJSON(b);switch(c){case "GPBoolean":case "GPDouble":case "GPLong":case "GPString":break;case "GPDate":a.value=
new Date(a.value);break;case "GPDataFile":a.value=t.fromJSON(a.value);break;case "GPLinearUnit":a.value=z.fromJSON(a.value);break;case "GPFeatureRecordSetLayer":case "GPRecordSet":a.value=b.value.url?t.fromJSON(a.value):u.fromJSON(a.value);break;case "GPRasterData":case "GPRasterDataLayer":b=b.value.mapImage;a.value=b?y.fromJSON(b):A.fromJSON(a.value);break;case "GPField":a.value=x.fromJSON(a.value);break;case "GPMultiValue:GPBoolean":case "GPMultiValue:GPDouble":case "GPMultiValue:GPLong":case "GPMultiValue:GPString":break;
case "GPMultiValue:GPDate":a.value=a.value.map(function(a){return new Date(a)});break;case "GPMultiValue:GPDataFile":a.value=a.value.map(function(a){return t.fromJSON(a)});break;case "GPMultiValue:GPLinearUnit":a.value=a.value.map(function(a){return z.fromJSON(a)});break;case "GPMultiValue:GPFeatureRecordSetLayer":case "GPMultiValue:GPRecordSet":a.value=a.value.map(function(a){return u.fromJSON(a)});break;case "GPMultiValue:GPRasterData":case "GPMultiValue:GPRasterDataLayer":a.value=a.value.map(function(b){return b?
y.fromJSON(b):A.fromJSON(a.value)});break;case "GPMultiValue:GPField":a.value=a.value.map(function(a){return x.fromJSON(a)});break;default:r.neverReached(c)}return a};c.prototype._gpEncode=function(b,c,a){var d=this,g;for(g in b){var f=b[g];Array.isArray(f)?b[g]=JSON.stringify(f.map(function(a){return d._gpEncode({item:a},!0).item},this)):f instanceof Date&&(b[g]=f.getTime())}return this._encode(b,c,a)};c.prototype._getJobStatus=function(b,c){b=this.parsedUrl.path+"/jobs/"+b;c=k({},this.requestOptions,
c,{query:{f:"json"}});return p(b,c).then(function(a){return q.fromJSON(a.data)})};h([f.property({type:w})],c.prototype,"outSpatialReference",void 0);h([f.property({type:G})],c.prototype,"processExtent",void 0);h([f.property({type:w})],c.prototype,"processSpatialReference",void 0);h([f.property({nonNullable:!0})],c.prototype,"returnFeatureCollection",void 0);h([f.property({nonNullable:!0})],c.prototype,"returnM",void 0);h([f.property({nonNullable:!0})],c.prototype,"returnZ",void 0);return c=h([f.subclass("esri/tasks/Geoprocessor")],
c)}(f.declared(I))});