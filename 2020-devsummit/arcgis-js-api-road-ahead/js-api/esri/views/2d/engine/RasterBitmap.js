// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/assignHelper ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/vec2f32 ../../../layers/support/rasterFunctions/pixelUtils ./DisplayObject ./webgl/WGLRasterUtils".split(" "),function(g,l,q,r,e,t,h,u,v,k){function m(e){n.has(e)&&(p.splice(p.indexOf(e),1),n.delete(e))}Object.defineProperty(l,"__esModule",{value:!0});var p=[],n=new Set,w={bandCount:3,outMin:0,outMax:1,
minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,type:"stretch"};g=function(g){function c(a,b,c,f){void 0===a&&(a=null);void 0===b&&(b=null);void 0===c&&(c=null);void 0===f&&(f=function(){return null});var d=g.call(this)||this;d.stencilRef=0;d.coordScale=[1,1];d._symbolizerParameters=null;d.height=null;d.pixelRatio=1;d.resolution=0;d.rotation=0;d._source=null;d.rawPixelData=null;d._suspended=!1;
d._bandIds=null;d._interpolation=null;d._transformGrid=null;d.width=null;d.x=0;d.y=0;d.transforms={dvs:t.mat3f32.create()};d.source=a;d.transformGrid=b;d.interpolation=c;d.requestRender=f;return d}q(c,g);Object.defineProperty(c.prototype,"symbolizerParameters",{get:function(){return this._symbolizerParameters||w},set:function(a){this._symbolizerParameters=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"source",{get:function(){return this._source},set:function(a){this._source=
a;this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"suspended",{get:function(){return this._suspended},set:function(a){this._suspended&&!a&&this.attached&&(this.ready(),this.requestRender());this._suspended=a},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"bandIds",{get:function(){return this._bandIds},set:function(a){this.attached&&this._updateRasterTexture(a);this._bandIds=a},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"interpolation",{get:function(){return this._interpolation},set:function(a){this._interpolation=a;this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===a?9729:9728)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"transformGrid",{get:function(){return this._transformGrid},set:function(a){this._transformGrid=a;this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null)},enumerable:!0,
configurable:!0});c.prototype.attach=function(){this.updateTexture();return!0};c.prototype.detach=function(){this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null);this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null);this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null);m(this)};c.prototype.invalidateTexture=function(){this.attached?this.updateTexture():m(this)};c.prototype.setTransform=function(a){var b=
e.mat3.identity(this.transforms.dvs),c=a.toScreenNoRotation([0,0],this.x,this.y),f=this.resolution/this.pixelRatio/a.resolution,d=f*this.width,f=f*this.height,g=Math.PI*this.rotation/180;e.mat3.translate(b,b,h.vec2f32.fromValues(c[0],c[1]));e.mat3.translate(b,b,h.vec2f32.fromValues(d/2,f/2));e.mat3.rotate(b,b,-g);e.mat3.translate(b,b,h.vec2f32.fromValues(-d/2,-f/2));e.mat3.scaleByVec2(b,b,h.vec2f32.fromValues(d,f));e.mat3.multiply(this.transforms.dvs,a.displayViewMat3,b)};c.prototype.updateTexture=
function(){var a=this.stage.context,b=this.source,b=b&&b.pixels&&0<b.pixels.length;!this._rasterTexture&&b&&this._updateRasterTexture(this.bandIds);this._rasterTexture&&b&&(this._updateColormapTexture(),this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=k.createTransformTexture(a,this.transformGrid)));this._rasterTexture&&!b&&this._rasterTexture.setData(null);this.suspended||(this.ready(),this.requestRender())};c.prototype.getUniforms=function(){var a=this.source,b=this.transformGrid,
c;switch(this.symbolizerParameters.type){case "lut":c=this._getColormapUniforms();break;case "stretch":c=this._getStretchUniforms();break;case "hillshade":c=this._getShadedReliefUniforms()}a=r({},c,{u_srcImageSize:[a.width,a.height],u_resampling:"nearest",u_flipY:!0,u_applyTransform:b?!0:!1,u_dvsMat3:this.transforms.dvs});this.transformGrid&&(a.u_transformSpacing=b.spacing,a.u_transformGridSize=b.size,a.u_targetImageSize=new Float32Array([this.width,this.height]));return a};c.prototype.getTextures=
function(){if(!this._rasterTexture)return null;var a=[],b=[];this._transformGridTexture&&(b.push(this._transformGridTexture),a.push("u_transformGrid"));this._rasterTexture&&(b.push(this._rasterTexture),a.push("u_image"));this._colormapTexture&&(b.push(this._colormapTexture),a.push("u_colormap"));return{names:a,textures:b}};c.prototype._getColormapUniforms=function(){var a=this.symbolizerParameters;return{u_colormapOffset:a.colormapOffset||0,u_colormapMaxIndex:a.colormap.length/4-1,u_isFloatTexture:!1}};
c.prototype._getStretchUniforms=function(){var a=this.symbolizerParameters,b={u_bandCount:a.bandCount,u_minOutput:a.outMin,u_maxOutput:a.outMax,u_minCutOff:a.minCutOff,u_maxCutOff:a.maxCutOff,u_factor:a.factor,u_useGamma:a.useGamma,u_gamma:a.gamma,u_gammaCorrection:a.gammaCorrection,u_contrast:a.contrast,u_brightness:a.brightness};a.colormap&&(b.u_colormapOffset=a.colormapOffset||0,b.u_colormapMaxIndex=a.colormap.length/4-1,b.u_isFloatTexture=!1,b.u_applyColormap=!0);return b};c.prototype._getShadedReliefUniforms=
function(){var a=this.symbolizerParameters,b={u_hillshadeType:a.hillshadeType,u_sinZcosA:a.sinZcosA,u_sinZsinA:a.sinZsinA,u_cosZ:a.cosZ,u_sinZcosAs:a.sinZcosAs,u_sinZsinAs:a.sinZsinAs,u_cosZs:a.cosZs,u_weights:a.weights,u_factor:a.factor,u_applyColormap:!1};a.colormap&&(b.u_colormapOffset=a.colormapOffset||0,b.u_colormapMaxIndex=a.colormap.length/4-1,b.u_isFloatTexture=!1,b.u_applyColormap=!0);return b};c.prototype._updateRasterTexture=function(a){var b=this.source?u.extractBands(this.source,a):null;
if(b&&b.pixels&&0<b.pixels.length){a=null==a&&null==this.bandIds||a&&this.bandIds&&a.join("")===this.bandIds.join("");if(this._rasterTexture){if(a)return;this._rasterTexture.dispose();this._rasterTexture=null}this._rasterTexture=k.createRasterTexture(this.stage.context,b,this.interpolation||"nearest")}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null)};c.prototype._updateColormapTexture=function(){var a=this._colormap,b=this.symbolizerParameters.colormap;if(b){var c=
this.stage.context;if(!a)this._colormapTexture=k.createColormapTexture(c,b),this._colormap=b;else if(b.length!==a.length||b.some(function(b,c){return b!==a[c]}))this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=k.createColormapTexture(c,b),this._colormap=b}else this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormap=null};return c}(v.DisplayObject);l.RasterBitmap=g});