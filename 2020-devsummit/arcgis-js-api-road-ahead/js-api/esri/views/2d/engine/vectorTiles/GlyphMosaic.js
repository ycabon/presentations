// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/has ../../../../core/promiseUtils ../../../webgl ./RectangleBinPack ../webgl/Rect".split(" "),function(A,B,C,x,y,t,z){return function(){function b(e,c,a){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=e;this.height=c;this._glyphSource=a;this._binPack=new t(e-4,c-4);this._glyphData.push(new Uint8Array(e*c));this._dirties.push(!0);this._textures.push(void 0)}
b.prototype.getGlyphItems=function(e,c){for(var a=this,m=[],q=this._glyphSource,b=new Set,f=1/256,g=0;g<c.length;g++)b.add(Math.floor(c[g]*f));var h=[];b.forEach(function(d){if(256>=d){var c=e+d;a._rangePromises.has(c)?h.push(a._rangePromises.get(c)):(d=q.getRange(e,d).then(function(){a._rangePromises["delete"](c)},function(){a._rangePromises["delete"](c)}),a._rangePromises.set(c,d),h.push(d))}});return x.all(h).then(function(){var d,b=a._glyphIndex[e];b||(b={},a._glyphIndex[e]=b);for(var h=0;h<c.length;h++){d=
c[h];var k=b[d];if(k)m[d]={sdf:!0,rect:k.rect,metrics:k.metrics,page:k.page};else{var n=q.getGlyph(e,d);if(n&&n.metrics){var k=n.metrics,l=void 0;if(0===k.width)l=new z.default(0,0,0,0);else{var f=k.width+6,g=k.height+6,r=f%4?4-f%4:4,p=g%4?4-g%4:4;1===r&&(r=5);1===p&&(p=5);l=a._binPack.allocate(f+r,g+p);l.isEmpty&&(a._dirties[a._currentPage]||(a._glyphData[a._currentPage]=null),a._currentPage=a._glyphData.length,a._glyphData.push(new Uint8Array(a.width*a.height)),a._dirties.push(!0),a._textures.push(void 0),
a._binPack=new t(a.width-4,a.height-4),l=a._binPack.allocate(f+r,g+p));var r=a._glyphData[a._currentPage],n=n.bitmap,w=p=void 0;if(n)for(var u=0;u<g;u++)for(var p=f*u,w=a.width*(l.y+u+1)+l.x,v=0;v<f;v++)r[w+v+1]=n[p+v]}b[d]={rect:l,metrics:k,tileIDs:null,page:a._currentPage};m[d]={sdf:!0,rect:l,metrics:k,page:a._currentPage};a._dirties[a._currentPage]=!0}}}return m})};b.prototype.removeGlyphs=function(e){for(var c in this._glyphIndex){var a=this._glyphIndex[c];if(a){var b=void 0,q;for(q in a)if(b=
a[q],b.tileIDs["delete"](e),0===b.tileIDs.size){for(var t=this._glyphData[b.page],f=b.rect,g=void 0,h=void 0,d=0;d<f.height;d++)for(g=this.width*(f.y+d)+f.x,h=0;h<f.width;h++)t[g+h]=0;delete a[q];this._dirties[b.page]=!0}}}};b.prototype.bind=function(b,c,a,m){void 0===m&&(m=0);this._textures[a]||(this._textures[a]=new y.Texture(b,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var e=this._textures[a];e.setSamplingMode(c);this._dirties[a]&&
e.setData(this._glyphData[a]);b.bindTexture(e,m);this._dirties[a]=!1};b.prototype.dispose=function(){this._binPack=null;for(var b=0,c=this._textures;b<c.length;b++){var a=c[b];a&&a.dispose()}this._textures.length=0};return b}()});