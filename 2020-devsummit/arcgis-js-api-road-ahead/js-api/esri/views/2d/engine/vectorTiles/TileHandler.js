// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/has ../../../../core/ItemCache ../../../../core/maybe ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/workers ../../../../geometry/support/aaBoundingRect ../vectorTiles/VectorTile ./GeometryUtils ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ../../tiling/TileKey".split(" "),function(v,
w,t,n,k,x,C,D,p,E,l,F,G,H,y,I,J,K,z,u){Object.defineProperty(w,"__esModule",{value:!0});var A=new D(10),r=new Map;v=function(){function c(a,e,g,d,b,h){this._vectorTileLayer=a;this.devicePixelRatio=e;this.allowUpdates=g;this._container=d;this._memCache=b;this._enableCachingWorkerTiles=h;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._updateToAbortController=new Map;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}c.prototype.destroy=function(){this._updateToAbortController&&
this._updateToAbortController.forEach(function(a){return a.abort()});this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(c.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});c.prototype.start=function(a){return k(this,void 0,void 0,function(){var e,g,d,b,h,f=this;return n(this,function(c){e=this._vectorTileLayer.sourceNameToSource;g=[];for(d in e)g.push(this._fetchTileMap(e[d],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){f._spriteMosaic=
new K(1024,1024,250);f._spriteMosaic.setSpriteSource(a)});b=this._vectorTileLayer.styleRepository;h=new J(b.glyphs);this._glyphMosaic=new I(1024,1024,h);this._broadcastPromise=F.open("WorkerTileHandler",{client:this,scheduler:a.scheduler,signal:a.signal}).then(function(d){f._connection=d;return l.all(f._connection.broadcast("setLayers",{style:b.styleJSON,enableCachingTiles:f._enableCachingWorkerTiles},t({},a)))});return[2,l.all(g)]})})};c.prototype.updateStyle=function(){return k(this,void 0,void 0,
function(){var a,e=this;return n(this,function(g){switch(g.label){case 0:return[4,this._broadcastPromise];case 1:return g.sent(),this._updateToAbortController.forEach(function(a){return a.abort()}),this._updateToAbortController.clear(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=l.create(function(d,b){l.all(e._connection.broadcast("updateStyle",a.styleJSON)).then(d,b)}),[2,this._broadcastPromise]}})})};c.prototype.abortTileUpdate=function(a){this._updateToAbortController.has(a)&&
(this._updateToAbortController.get(a).abort(),this._updateToAbortController.delete(a))};c.prototype.updateTile=function(a,e){return k(this,void 0,void 0,function(){var g,d,b,h,f=this;return n(this,function(c){switch(c.label){case 0:return this.allowUpdates&&a.isReady?[4,this._broadcastPromise]:[2];case 1:c.sent();g=Math.round(y.degToByte(e.state.rotation));if(a.rotation===g)return[2,null];b=a.key;this._updateToAbortController.has(b.id)&&(d=this._updateToAbortController.get(b.id),d.abort(),this._updateToAbortController.delete(b.id));
d=l.createAbortController();a.rotation=g;h=a.client.invoke("updateSymbols",{key:a.id,rotation:g},{signal:d.signal}).then(function(d){f._updateToAbortController.delete(b.id);a.isReady&&a.updateSymbolData(d)}).catch(function(a){l.isAbortError(a)||f._updateToAbortController.delete(b.id)});this._updateToAbortController.set(a.id,d);return[2,h]}})})};c.prototype.updateTileData=function(a){for(var e=a.tileId,g=this._container.children,d,b=0;b<g.length;b++)if(d=g[b],d.id===e){d.updateTileData(a.tileData);
break}};c.prototype.getVectorTile=function(a,e,g,d){return k(this,void 0,void 0,function(){var b,h,f,c,B,k,m;return n(this,function(q){switch(q.label){case 0:return b=new u(a,e,g,0),p.isSome(this._memCache)&&(h=this._memCache.get(b.id))?(h.reference(),[2,h]):[4,this._getVectorTileData(b)];case 1:f=q.sent();l.throwIfAborted(d);if(p.isSome(this._memCache)&&(c=this._memCache.get(b.id)))return c.reference(),[2,c];B=this._vectorTileLayer.tileInfo;k=B.getTileBounds(G.create(),b);m=new H.VectorTile(b,this._vectorTileLayer.styleRepository,
k,[512,512],0,!1);f&&f.tileData?(m.setData(f.tileData,f.client),p.isSome(this._memCache)&&(m.reference(),this._memCache.put(m.key.id,m,m.getMemoryUsage()*m.referenced,E.MIN_PRIORITY))):m.setData(null,null);return[2,m]}})})};c.prototype.releaseVectorTile=function(a){p.isNone(this._memCache)||a.release()||this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};c.prototype.fetchTileData=function(a,e){return k(this,void 0,void 0,function(){var g,d,b,c;return n(this,function(f){switch(f.label){case 0:return[4,
this._getRefKeys(a,e)];case 1:g=f.sent();d=this._vectorTileLayer.sourceNameToSource;b=[];for(c in d)b.push(c);return[2,this._getSourcesData(b,g,e)]}})})};c.prototype.parseTileData=function(a,e,g){return k(this,void 0,void 0,function(){var d,b,c,f,q,k,l,m,p=this;return n(this,function(h){switch(h.label){case 0:d=a&&a.data;if(!d)return[2,null];b=d.sourceName2DataAndRefKey;c=d.transferList;return 0===Object.keys(b).length?[2,null]:[4,this._broadcastPromise];case 1:return h.sent(),f=Math.round(y.degToByte(e)),
q=this._connection.getAvailableClient(),[4,q.invoke("createTileAndParse",{key:a.key.id,rotation:f,cacheTile:this.allowUpdates,sourceName2DataAndRefKey:b},t({},g,{transferList:c})).catch(function(){p._enableCachingWorkerTiles&&q.invoke("destructTileData",a.key.id).catch(function(){});return null})];case 2:k=h.sent();if(C("esri-vector-tiles-debug")){l={};for(m in b)l[m]=b[m].refKey;return[2,{tileData:k,client:q,refKeys:l}]}return[2,{tileData:k,client:q}]}})})};Object.defineProperty(c.prototype,"updating",
{get:function(){return 0<this._ongoingTileRequests.size},enumerable:!0,configurable:!0});c.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};c.prototype.getSprites=function(a){return k(this,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return[4,this._spriteSourcePromise];case 1:return e.sent(),[2,this._spriteMosaic.getSpriteItems(a)]}})})};c.prototype.getGlyphs=
function(a){return this._glyphMosaic.getGlyphItems(a.font,a.codePoints)};c.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};c.prototype._getTilePayload=function(a,e,g){return k(this,void 0,void 0,function(){var d,b,c,f,k;return n(this,function(h){switch(h.label){case 0:return d=u.pool.acquire(a.id),b=this._vectorTileLayer.sourceNameToSource,c=b[e],f=c.getSourceTileUrl(d.level,d.row,d.col),u.pool.release(d),[4,x(f,t({responseType:"array-buffer"},g))];case 1:return k=
h.sent(),[2,{protobuff:k.data,sourceName:e}]}})})};c.prototype._fetchTileMap=function(a,e){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return l.resolve();var c=A.get(a.tileMapURL);if(c)return a.tileIndex=c,l.resolve();if(r.has(a.tileMapURL))return r.get(a.tileMapURL).then(function(d){a.tileIndex=new z(d.data)});e=x(a.tileMapURL,e);e.then(function(d){a.tileIndex=new z(d.data);r["delete"](a.tileMapURL);A.put(a.tileMapURL,a.tileIndex)});r.set(a.tileMapURL,e);return e};c.prototype._getRefKeys=
function(a,e){return k(this,void 0,void 0,function(){var c,d,b,h,f;return n(this,function(g){c=this._vectorTileLayer.sourceNameToSource;d=[];for(b in c)h=c[b],f=h.getRefKey(a,e),d.push(f);return[2,l.eachAlways(d)]})})};c.prototype._getSourcesData=function(a,e,c){return k(this,void 0,void 0,function(){var d,b,g,f,k,p,r;return n(this,function(h){switch(h.label){case 0:d=[];for(b=0;b<e.length;b++)null==e[b].value||null==a[b]?d.push(null):(g=this._getTilePayload(e[b].value,a[b],c),d.push(g));return[4,
l.eachAlways(d)];case 1:f=h.sent();k={};p=[];for(b=0;b<f.length;b++)f[b].value&&f[b].value&&f[b].value.protobuff&&0<f[b].value.protobuff.byteLength&&(r=e[b].value.id,k[f[b].value.sourceName]={refKey:r,protobuff:f[b].value.protobuff},p.push(f[b].value.protobuff));return[2,{sourceName2DataAndRefKey:k,transferList:p}]}})})};c.prototype._getVectorTileData=function(a){return k(this,void 0,void 0,function(){var c,g,d,b,h=this;return n(this,function(e){c=a.id;if(this._ongoingTileRequests.has(c))return[2,
this._ongoingTileRequests.get(c)];g=new AbortController;d={signal:g.signal};b=this._getParsedVectorTileData(a,d).then(function(a){h._ongoingTileRequests.delete(c);h._ongoingRequestToController.delete(c);return a}).catch(function(){h._ongoingTileRequests.delete(c);h._ongoingRequestToController.delete(c);return null});this._ongoingTileRequests.set(c,b);this._ongoingRequestToController.set(c,g);return[2,b]})})};c.prototype._getParsedVectorTileData=function(a,c){return k(this,void 0,void 0,function(){var e;
return n(this,function(d){switch(d.label){case 0:return[4,this.fetchTileData(a,c)];case 1:return e=d.sent(),[2,this.parseTileData({key:a,data:e},0,c)]}})})};return c}();w.TileHandler=v});