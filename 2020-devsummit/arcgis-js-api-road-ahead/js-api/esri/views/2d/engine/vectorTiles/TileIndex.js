// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/promiseUtils","../../../../layers/support/TilemapCache","../../tiling/TileKey"],function(m,n,h,l,k){return function(){function g(a){if(a instanceof l.TilemapCache)this._tilemapCache=a;else if(a&&"index"in a)this._tilemap=a.index;else throw Error("Invalid tilemap!");}g.prototype.dataKey=function(a,b){if(this._tilemapCache){var c=a.level,d=a.row,e=a.col,f=new k(a);return this._tilemapCache.fetchAvailabilityUpsample(c,d,e,f,b).then(function(){return f}).catch(function(a){if(h.isAbortError(a))throw a;
f.level=c;f.row=d;f.col=e;return f})}return this._getIndexedDataKey(a)};g.prototype.forEach=function(a,b,c,d,e){this._callback=e;this._maxLevel=b+a;this._forEach(this._tilemap,b,c,d)};g.prototype._forEach=function(a,b,c,d){0!==a&&(this._callback(b,c,d),b!==this._maxLevel&&"object"===typeof a&&(this._forEach(a[0],b+1,2*c,2*d),this._forEach(a[1],b+1,2*c,2*d+1),this._forEach(a[2],b+1,2*c+1,2*d),this._forEach(a[3],b+1,2*c+1,2*d+1)))};g.prototype._getIndexedDataKey=function(a){var b=[a];if(0>a.level||
0>a.row||0>a.col||0<a.row>>a.level||0<a.col>>a.level)return h.resolve(null);for(;0!==a.level;)a=new k(a.level-1,a.row>>1,a.col>>1,a.world),b.push(a);a=this._tilemap;var c=b.pop(),d,e;if(1===a)return h.resolve(c);for(;b.length;)if(d=b.pop(),e=(d.col&1)+((d.row&1)<<1),a){if(0===a[e]){c=null;break}if(1===a[e]){c=d;break}c=d;a=a[e]}return h.resolve(c)};return g}()});