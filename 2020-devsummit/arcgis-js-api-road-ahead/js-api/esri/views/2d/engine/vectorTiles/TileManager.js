// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/LRUCache","../../tiling/TileCoverage","../../tiling/TileKey"],function(h,l,n,t,p){Object.defineProperty(l,"__esModule",{value:!0});var u=function(c,a){return c+1/(1<<2*a)};h=function(){function c(a,b){this._tiles=new Map;this._tileCache=new n(40,function(a){return a.dispose()});this._viewSize=[0,0];this.fadeDuration=300;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;a.fadeDuration&&(this.fadeDuration=a.fadeDuration);
this._container=b}c.prototype.destroy=function(){this._tiles.clear();this._tiles=null;this._tileCache.clear();this._tileCache=null};c.prototype.update=function(a){var b=this;this._updateCacheSize(a);a=this.tileInfoView.getTileCoverage(a.state,0,"smallest");for(var d=a.spans,e=a.lodInfo,c=e.level,k=new Set,h=new Set,q=0;q<d.length;q++)for(var f=d[q],l=f.row,n=f.colTo,m=f.colFrom;m<=n;m++){var f=p.getId(c,l,e.normalizeCol(m),e.getWorldForColumn(m)),g=this._getOrAcquireTile(f);k.add(f);g.hasData()?this._container.addChild(g):
h.add(new p(f))}h.forEach(function(a){return b._findPlaceholdersForMissingTiles(a,k)});k.forEach(function(a){b._tiles.get(a).clearSymbolFadeHold()});var r=[];this._tiles.forEach(function(a,b){k.has(b)||r.push(b)});for(d=0;d<r.length;d++)f=r[d],g=this._tiles.get(f),g.hasSymbolBuckets&&!g.isHoldingForFade?g.setSymbolHoldDuration(this.fadeDuration):g.hasSymbolBuckets&&!g.isSymbolFadeDone||this._releaseTile(f);t.pool.release(a)};c.prototype._findPlaceholdersForMissingTiles=function(a,b){var d=this,c=
[];this._tiles.forEach(function(e){d._addPlaceholderChild(c,e,a,b)});var v=c.reduce(u,0);1E-6>Math.abs(1-v)||this._addPlaceholderParent(a.id,b)};c.prototype._addPlaceholderChild=function(a,b,d,c){if(!(b.key.level<=d.level)&&b.hasData()){var e=b.key,k=e.level-d.level;d.row===e.row>>k&&d.col===e.col>>k&&d.world===e.world&&(this._container.addChild(b),c.add(b.id),a.push(b.key.level-d.level))}};c.prototype._addPlaceholderParent=function(a,b){for(;;){var d=a.split("/");a=d[1];var c=d[2],h=d[3],d=parseInt(d[0],
10);a=0===d?null:d-1+"/"+(parseInt(a,10)>>1)+"/"+(parseInt(c,10)>>1)+"/"+parseInt(h,10);if(!a||b.has(a))break;if((c=this._getTile(a))&&c.hasData()){this._container.addChild(c);b.add(c.id);break}}};c.prototype._getOrAcquireTile=function(a){var b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))||(b=this.acquireTile(new p(a)));this._tiles.set(a,b);return b};c.prototype._getTile=function(a){var b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))&&this._tiles.set(a,b);return b};c.prototype._releaseTile=
function(a){var b=this._tiles.get(a);this.releaseTile(b);this._container.removeChild(b);this._tiles.delete(a);b.hasData()?this._tileCache.put(a,b,1):b.dispose()};c.prototype._updateCacheSize=function(a){a=a.state.size;if(a[0]!==this._viewSize[0]||a[1]!==this._viewSize[1]){var b=Math.ceil(a[0]/512)+1,c=Math.ceil(a[1]/512)+1;this._viewSize[0]=a[0];this._viewSize[1]=a[1];this._tileCache.maxSize=5*b*c}};return c}();l.TileManager=h});