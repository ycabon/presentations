// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/pbf ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./Feature ./FillBucket ./LineBucket ./SourceLayerData ./SymbolBucket ../webgl/TileClipper ../../tiling/enums".split(" "),function(xa,ya,ma,na,oa,I,pa,qa,ra,sa,ta,ua,va,n,wa){return function(){function e(b,a,l){this._pbfTiles={};this._tileClippers={};this._client=l;this._tile=a;this._layers=a.getLayers();var g=
a.tileKey.split("/").map(parseFloat);a=g[0];l=g[1];g=g[2];this._level=a;for(var e=Math.max(8,Math.round(1*this._level)-8),c=0,h=Object.keys(b);c<h.length;c++){var k=h[c],d=b[k];this._pbfTiles[k]=new oa(new Uint8Array(d.protobuff),new DataView(d.protobuff));if(d.refKey&&(d=d.refKey.split("/").map(parseFloat)[0],d=a-d,0<d)){var p=(1<<d)-1;this._tileClippers[k]=new n.TileClipper(d,l&p,g&p,8,e)}this._tileClippers[k]||(this._tileClippers[k]=new n.SimpleBuilder)}}e.prototype.parse=function(b){return na(this,
void 0,void 0,function(){var a,l,g,e,c,h,k,d,p,u,x,n,q,v,J,f,r,K,ea,fa,y,L,M,N,z,A,B,O,ga,C,P,m,w,Q,t,R,S,T,U,ha,ia,D,V,ja,E,W,X,F,Y,G,Z,aa,H,ba,ka,la,ca,da;return ma(this,function(za){a=b&&b.signal;l=this._parseTileData(this._pbfTiles);g=this._layers;e=this._level;h=[];k=this._tileClippers;d={};p={};for(u=g.length-1;0<=u;u--)if(c=g[u],!(c.minzoom&&e<c.minzoom||c.maxzoom&&e>=c.maxzoom||c.layout&&c.layout.visibility&&"none"===c.layout.visibility||0===c.type)&&l[c.source]&&k[c.source]&&(x=l[c.source],
n=k[c.source],q=c.sourceLayer,v=x[q]))if((J=p[c.source])||(J=p[c.source]=new Set),J.add(c.sourceLayer),f=this._createBucket(c))f.layerIndex=u,f.layerExtent=v.extent,f.tileClipper=n,(r=d[c.source])||(r=d[c.source]={}),(K=r[q])||(K=r[q]=[]),K.push(f);ea=10*this._level;fa=10*(this._level+1);y=[];L=[];M=[];N=[];z=new Set;A={};B=[];O=[];ga=function(a){p[a].forEach(function(b){B.push(b);O.push(a)})};C=0;for(P=Object.keys(p);C<P.length;C++)m=P[C],ga(m);for(w=0;w<B.length;w++){m=O[w];Q=B[w];if(!l[m]||!d[m])break;
x=l[m];v=x[Q];r=d[m];t=r[Q];if(!t||0===t.length)break;if(I.isAborted(a))return[2,void 0];for(R=v.getData();R.next(2);){S=R.getMessage();T=new ra(S,v);S.release();if(U=T.values){if((ha=U._minzoom)&&ha>=fa)continue;if((ia=U._maxzoom)&&ia<=ea)continue}D=0;for(V=t;D<V.length;D++)f=V[D],f.pushFeature(T)}}ja=this._tile;E=0;for(W=Object.keys(d);E<W.length;E++)for(q in m=W[E],X=d[m],X)for(t=X[q],F=0,Y=t;F<Y.length;F++)f=Y[F],f.hasFeatures()&&(3===f.layer.type?(y.push(f),ja.addBucket(f)):f.layer.refLayerId?
M.push(f):(L.push(f),N[f.layer.id]=f));G=0;for(Z=y;G<Z.length;G++)aa=f=Z[G],aa.getResources(aa.tileClipper,z,A);if(this._tile.status===wa.TileStatus.INVALID)return[2,I.resolve([])];H=[];ba=this._tile.getWorkerTileHandler();0<z.size&&(ka=ba.fetchSprites(z,this._client,b),H.push(ka));for(ca in A)da=A[ca],0<da.size&&(la=ba.fetchGlyphs(this._tile.tileKey,ca,da,this._client,b),H.push(la));return[2,I.all(H).then(function(){for(var a=0,b=L;a<b.length;a++){var c=b[a];c.processFeatures(c.tileClipper);h.push(c)}a=
0;for(b=M;a<b.length;a++){var c=b[a],d=N[c.layer.refLayerId];d&&(d.assignBufferInfo(c),h.push(c))}a=0;for(b=y;a<b.length;a++)c=b[a],c.processFeatures(c.tileClipper),h.push(c);h.sort(function(a,b){return a.layerIndex-b.layerIndex});return h})]})})};e.prototype._parseTileData=function(b){for(var a={},e=0,g=Object.keys(b);e<g.length;e++){for(var n=g[e],c=b[n],h={};c.next();)switch(c.tag()){case 3:var k=c.getMessage(),d=new ua(k);k.release();h[d.name]=d;break;default:c.skip()}a[n]=h}return a};e.prototype._createBucket=
function(b){switch(b.type){case 0:return this._createBackgroundBucket(b);case 1:return this._createFillBucket(b);case 2:return this._createLineBucket(b);case 4:return this._createCircleBucket(b);case 3:return this._createSymbolBucket(b)}};e.prototype._createBackgroundBucket=function(b){return new pa(b,this._level)};e.prototype._createFillBucket=function(b){var a=this._tile;return new sa(b,this._level,b.hasDataDrivenFill?a.fillDDVertexBuffer:a.fillVertexBuffer,a.fillIndexBuffer,b.hasDataDrivenOutline?
a.outlineDDVertexBuffer:a.outlineVertexBuffer,a.outlineIndexBuffer)};e.prototype._createLineBucket=function(b){var a=this._tile;return new ta(b,this._level,b.hasDataDrivenLine?a.lineDDVertexBuffer:a.lineVertexBuffer,a.lineIndexBuffer)};e.prototype._createCircleBucket=function(b){var a=this._tile;return new qa(b,this._level,a.circleVertexBuffer,a.circleIndexBuffer)};e.prototype._createSymbolBucket=function(b){var a=this._tile;return new va(b,this._level,b.hasDataDrivenIcon?a.iconDDVertexBuffer:a.iconVertexBuffer,
a.iconIndexBuffer,b.hasDataDrivenText?a.textDDVertexBuffer:a.textVertexBuffer,a.textIndexBuffer,a.placementEngine,a.getWorkerTileHandler())};return e}()});