// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ../../../webgl ../../engine ./FadeRecorder ../webgl/definitions ../webgl/enums ../webgl/TiledDisplayObject ../../tiling/TileCoverage ../../tiling/TileKey".split(" "),function(u,w,B,C,D,E,F,
G,H,z,N,I,J,m,n,K,L,M){function A(g,e){if(g){var a=g.getLayoutProperty("visibility");if(!a||"none"!==a.getValue()&&(void 0===g.minzoom||g.minzoom<e+1E-6)&&(void 0===g.maxzoom||g.maxzoom>=e-1E-6))return!0}return!1}Object.defineProperty(w,"__esModule",{value:!0});u=function(g){function e(a,b){a=g.call(this,a,b)||this;a._backgroundTiles=[];a._fadeRecorder=new J.FadeRecorder(400);a._pointToCallbacks=new Map;a._parsedDataQueue=new Map;return a}B(e,g);e.prototype.destroy=function(){this.removeAllChildren();
this.children.forEach(function(a){return a.destroy()})};e.prototype.dispose=function(){this._spriteMosaic&&this._spriteMosaic.dispose();this._glyphMosaic&&this._glyphMosaic.dispose();g.prototype.dispose.call(this)};Object.defineProperty(e.prototype,"updating",{get:function(){return 0<this._parsedDataQueue.size},enumerable:!0,configurable:!0});e.prototype.setStyleResources=function(a,b,c){this._spriteMosaic=a;this._glyphMosaic=b;this._styleRepository=c};e.prototype.hitTest=function(a,b){return E(this,
void 0,void 0,function(){var c,h;return D(this,function(d){c=[a,b];h=H.createResolver();this._pointToCallbacks.set(c,h);this.requestRender();return[2,h.promise]})})};e.prototype.setTileData=function(a,b){var c=this.stage;c.dataUploadCounter<m.MAX_GPU_UPLOADS_PER_FRAME&&b?(a.setData(b.tileData,b.client,b.refKeys),c.dataUploadCounter++):b?this._parsedDataQueue.set(a,b):a.setData(null,null)};e.prototype.createRenderParams=function(a){return C({},g.prototype.createRenderParams.call(this,a),{renderPass:null,
styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,fadeRecorder:this._fadeRecorder,hasClipping:!!this._clippingInfos})};e.prototype.doRender=function(a){!this.visible||a.drawPhase!==n.WGLDrawPhase.MAP&&a.drawPhase!==n.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||g.prototype.doRender.call(this,a)};e.prototype.removeChild=function(a){this._parsedDataQueue.has(a)&&this._parsedDataQueue.delete(a);return g.prototype.removeChild.call(this,a)};e.prototype.renderChildren=
function(a){if(a.drawPhase===n.WGLDrawPhase.DEBUG)g.prototype.renderChildren.call(this,a);else{var b=this.stage;if(0<this._parsedDataQueue.size&&b.dataUploadCounter<m.MAX_GPU_UPLOADS_PER_FRAME)for(var c=F.pairsOfMap(this._parsedDataQueue),h=0;h<c.length&&b.dataUploadCounter<m.MAX_GPU_UPLOADS_PER_FRAME;h++){var d=c[h][0],f=c[h][1];d.setData(f.tileData,f.client,f.refKeys);this._parsedDataQueue.delete(d);b.dataUploadCounter++}this._fadeRecorder.recordLevel(a.displayLevel);this._doRender(a);(0<this._parsedDataQueue.size||
this._fadeRecorder.needsRedraw())&&this.requestRender();0<this._pointToCallbacks.size&&(b=a.context,c=b.getBoundFramebufferObject(),a.drawPhase=n.WGLDrawPhase.HITTEST,h=a.painter.effects.hittest,h.bind(a),this._doRender(a),h.draw(a,this._pointToCallbacks,6),b.bindFramebuffer(c))}};e.prototype.removeAllChildren=function(){this._parsedDataQueue.clear();for(var a=0;a<this.children.length;a++)this.children[a].dispose();g.prototype.removeAllChildren.call(this)};e.prototype._doRender=function(a){var b=
a.context,c=this._styleRepository,h=c.layers;0<c.backgroundBucketIds.length&&(a.renderPass="background",this._renderBackgroundLayers(a,c.backgroundBucketIds));g.prototype.renderChildren.call(this,a);for(var c=this.children.filter(function(a){return a.visible}),d=0;d<c.length;d++){var f=c[d];f.triangleCount=0;f.commitChanges()}b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(7680,7680,7681);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);
b.setDepthFunction(515);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);a.renderPass="opaque";for(d=h.length-1;0<=d;d--)this._renderStyleLayer(d,a,c);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(1,771,1,771);a.renderPass="translucent";for(d=0;d<h.length;d++)this._renderStyleLayer(d,a,c);b.setDepthTestEnabled(!1);a.renderPass="symbol";for(d=0;d<h.length;d++)this._renderStyleLayer(d,a,c);b.bindVAO();b.setStencilTestEnabled(!0)};e.prototype._renderStyleLayer=function(a,
b,c){var h=b.painter,d=b.renderPass,f=this._styleRepository.layers[a];if(void 0!==f){var e;switch(f.type){case 0:return;case 1:if("opaque"!==d&&"translucent"!==b.renderPass)return;e="vtlFill";break;case 2:if("translucent"!==d)return;e="vtlLine";break;case 4:if("symbol"!==d)return;e="vtlCircle";break;case 3:if("symbol"!==d)return;e="vtlSymbol"}d=b.displayLevel;if(!(0===c.length||void 0!==f.minzoom&&f.minzoom>=d+1E-6||void 0!==f.maxzoom&&f.maxzoom<d-1E-6))for(b.styleLayerId=a,b.styleLayer=f,f=0;f<c.length;f++)if(c[f].layerData[a]){h.renderObjects(b,
c,e);break}}};e.prototype._renderBackgroundLayers=function(a,b){for(var c=a.context,e=a.displayLevel,d=a.painter,f=a.state,g=this._styleRepository,q=!1,r=0;r<b.length;r++){var p=b[r];if(A(g.layers[p],e)){q=!0;break}}if(q){var q=this._tileInfoView.getTileCoverage(a.state,0,"smallest"),p=q.spans,v=q.lodInfo,n=v.level,x=z.create(),r=[];if(this._renderPasses){var t=this._renderPasses[0];G.isSome(this._clippingInfos)&&(t.brushes[0].prepareState(a,this._clippingInfos[0]),t.brushes[0].drawMany(a,this._clippingInfos))}for(var t=
this._backgroundTiles,m=0,k,y=0;y<p.length;y++)for(var l=p[y],u=l.row,w=l.colTo,l=l.colFrom;l<=w;l++)m<t.length?(k=t[m],k.key.set(n,u,v.normalizeCol(l),v.getWorldForColumn(l)),this._tileInfoView.getTileBounds(x,k.key,!1),k.bounds=x,k.coords[0]=x[0],k.coords[1]=x[3]):(k=new M(n,u,v.normalizeCol(l),v.getWorldForColumn(l)),k=new K.TiledDisplayObject(k,this._tileInfoView.getTileBounds(z.create(),k),[512,512],[4096,4096]),t.push(k)),k.setTransform(f,this._tileInfoView.getTileResolution(k.key)),r.push(k),
m++;c.setStencilWriteMask(0);c.setColorMask(!0,!0,!0,!0);c.setStencilOp(7680,7680,7681);c.setStencilFunction(514,0,255);c.setStencilTestEnabled(!0);for(c=0;c<b.length;c++)p=b[c],f=g.layers[p],A(f,e)&&(a.styleLayerId=p,a.styleLayer=f,d.renderObjects(a,r,"vtlBackground"));L.pool.release(q)}};return e}(I.TileContainer);w.VectorTileContainer=u});