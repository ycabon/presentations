// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/maybe ../../../../core/promiseUtils ./BackgroundBucket ./CircleBucket ./FillBucket ./GeometryUtils ./IndexMemoryBuffer ./LineBucket ./Placement ./SymbolBucket ./TileParser ./VertexMemoryBuffer ../../tiling/enums".split(" "),function(O,P,F,G,w,v,H,I,J,x,m,K,L,M,N,g,q){return function(){function d(){this.rotation=0;this.status=q.TileStatus.INITIALIZED;this._symbolBuckets=[];this.placementEngine=
new L.PlacementEngine;this.fillVertexBuffer=new g.FillVertexBuffer(!1);this.fillDDVertexBuffer=new g.FillVertexBuffer(!0);this.fillIndexBuffer=new m.TriangleIndexBuffer;this.outlineVertexBuffer=new g.OutlineVertexBuffer(!1);this.outlineDDVertexBuffer=new g.OutlineVertexBuffer(!0);this.outlineIndexBuffer=new m.TriangleIndexBuffer;this.lineVertexBuffer=new g.LineVertexBuffer(!1);this.lineDDVertexBuffer=new g.LineVertexBuffer(!0);this.lineIndexBuffer=new m.TriangleIndexBuffer;this.iconVertexBuffer=new g.SymbolVertexBuffer(!1);
this.iconDDVertexBuffer=new g.SymbolVertexBuffer(!0);this.iconIndexBuffer=new m.TriangleIndexBuffer;this.textVertexBuffer=new g.SymbolVertexBuffer(!1);this.textDDVertexBuffer=new g.SymbolVertexBuffer(!0);this.textIndexBuffer=new m.TriangleIndexBuffer;this.circleVertexBuffer=new g.CircleVertexBuffer;this.circleIndexBuffer=new m.TriangleIndexBuffer}d.prototype.initialize=function(e,f,a,k){void 0===k&&(k=0);this.tileKey=e;this.refKeys=f;this._workerTileHandler=a;this.rotation=k;this.placementEngine.setAngle(x.C_DEG_TO_RAD*
k)};d.prototype.release=function(){this.tileKey="";this.refKeys=null;this.status=q.TileStatus.INITIALIZED;this.rotation=0;this.resetData();this._workerTileHandler=null};d.prototype.resetData=function(){this.fillVertexBuffer.reset();this.fillDDVertexBuffer.reset();this.fillIndexBuffer.reset();this.outlineVertexBuffer.reset();this.outlineDDVertexBuffer.reset();this.outlineIndexBuffer.reset();this.lineVertexBuffer.reset();this.lineDDVertexBuffer.reset();this.lineIndexBuffer.reset();this.iconVertexBuffer.reset();
this.iconDDVertexBuffer.reset();this.iconIndexBuffer.reset();this.textVertexBuffer.reset();this.textDDVertexBuffer.reset();this.textIndexBuffer.reset();this.circleVertexBuffer.reset();this.circleIndexBuffer.reset();this.placementEngine.reset();this._symbolBuckets.length=0};d.prototype.reparse=function(e){this.resetData();return this.setDataAndParse(this._data,e)};d.prototype.setDataAndParse=function(e,f){var a=this,k=f&&f.signal;if(w.isSome(k)){var d=function(){k.removeEventListener("abort",d);a.status=
q.TileStatus.INVALID};k.addEventListener("abort",d)}this._data=e;return this._parse(e,f).then(function(e){a.status=q.TileStatus.READY;for(var f=new Uint32Array([1,a.fillVertexBuffer.sizeInBytes,2,a.fillDDVertexBuffer.sizeInBytes,3,a.fillIndexBuffer.sizeInBytes,4,a.outlineVertexBuffer.sizeInBytes,5,a.outlineDDVertexBuffer.sizeInBytes,6,a.outlineIndexBuffer.sizeInBytes,7,a.lineVertexBuffer.sizeInBytes,8,a.lineDDVertexBuffer.sizeInBytes,9,a.lineIndexBuffer.sizeInBytes,10,a.iconVertexBuffer.sizeInBytes,
11,a.iconDDVertexBuffer.sizeInBytes,12,a.iconIndexBuffer.sizeInBytes,13,a.textVertexBuffer.sizeInBytes,14,a.textDDVertexBuffer.sizeInBytes,15,a.textIndexBuffer.sizeInBytes,16,a.circleVertexBuffer.sizeInBytes,17,a.circleIndexBuffer.sizeInBytes]),c=[],k=e.length,d=0;d<k;d++){var b=e[d];if(b instanceof J)c.push(b.layerIndex),c.push(1),c.push(b.fillIndexStart),c.push(b.fillIndexCount),c.push(b.outlineIndexStart),c.push(b.outlineIndexCount);else if(b instanceof K)c.push(b.layerIndex),c.push(2),c.push(b.lineIndexStart),
c.push(b.lineIndexCount);else if(b instanceof M){c.push(b.layerIndex);c.push(3);c.push(b.sdfMarker?1:0);var n=b.markerPageMap;c.push(n.size);n.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])});b=b.glyphsPageMap;c.push(b.size);b.forEach(function(a,b){c.push(b);c.push(a[0]);c.push(a[1])})}else b instanceof I?(c.push(b.layerIndex),c.push(4),c.push(b.circleIndexStart),c.push(b.circleIndexCount)):b instanceof H&&(c.push(b.layerIndex),c.push(0))}e=new Uint32Array(c);var k=a.fillVertexBuffer.toBuffer(),
d=a.fillDDVertexBuffer.toBuffer(),b=a.fillIndexBuffer.toBuffer(),n=a.outlineVertexBuffer.toBuffer(),g=a.outlineDDVertexBuffer.toBuffer(),l=a.outlineIndexBuffer.toBuffer(),m=a.lineVertexBuffer.toBuffer(),h=a.lineDDVertexBuffer.toBuffer(),B=a.lineIndexBuffer.toBuffer(),C=a.iconVertexBuffer.toBuffer(),v=a.iconDDVertexBuffer.toBuffer(),y=a.iconIndexBuffer.toBuffer(),w=a.textVertexBuffer.toBuffer(),x=a.textDDVertexBuffer.toBuffer(),z=a.textIndexBuffer.toBuffer(),D=a.circleVertexBuffer.toBuffer(),E=a.circleIndexBuffer.toBuffer();
return{result:{bufferDataInfo:f.buffer,bucketDataInfo:e.buffer,bufferData:[k,d,b,n,g,l,m,h,B,C,v,y,w,x,z,D,E]},transferList:[k,d,b,n,g,l,m,h,B,C,v,y,w,x,z,D,E,f.buffer,e.buffer]}})};d.prototype.addBucket=function(e){this._symbolBuckets.push(e)};d.prototype.updateSymbols=function(e,f){var a=this,d=this._symbolBuckets;if(!d||0===d.length)return v.resolve();var g=f&&f.signal;if(w.isSome(g)){var m=function(){g.removeEventListener("abort",m);a.status=q.TileStatus.INVALID};g.addEventListener("abort",m)}this.rotation=
e;var p=this.placementEngine;p.reset();p.setAngle(e/256*360*x.C_DEG_TO_RAD);var c=this.iconVertexBuffer;c.reset();var r=this.iconDDVertexBuffer;r.reset();var t=this.iconIndexBuffer;t.reset();var b=this.textVertexBuffer;b.reset();f=this.textDDVertexBuffer;f.reset();e=this.textIndexBuffer;e.reset();for(var n=[],u=0;u<d.length;u++){var l=d[u];if(l&&l.layer){var A=l.layer;if(l=l.copy(A.hasDataDrivenIcon?r:c,t,A.hasDataDrivenText?f:b,e,p))n.push(l),l.updateSymbols()}}if(this.status===q.TileStatus.INVALID||
this.status===q.TileStatus.INITIALIZED||0===c.sizeInBytes&&0===r.sizeInBytes&&0===t.sizeInBytes&&0===b.sizeInBytes&&0===f.sizeInBytes&&0===e.sizeInBytes)return v.reject();for(var d=new Uint32Array([10,c.sizeInBytes,11,r.sizeInBytes,12,t.sizeInBytes,13,b.sizeInBytes,14,f.sizeInBytes,15,e.sizeInBytes]),h=[],u=0;u<n.length;u++)p=n[u],h.push(p.layerIndex),h.push(3),h.push(p.sdfMarker?1:0),l=p.markerPageMap,h.push(l.size),l.forEach(function(a,b){h.push(b);h.push(a[0]);h.push(a[1])}),p=p.glyphsPageMap,
h.push(p.size),p.forEach(function(a,b){h.push(b);h.push(a[0]);h.push(a[1])});n=new Uint32Array(h);c=c.toBuffer();r=r.toBuffer();t=t.toBuffer();b=b.toBuffer();f=f.toBuffer();e=e.toBuffer();return v.resolve({result:{bufferDataInfo:d.buffer,bucketDataInfo:n.buffer,bufferData:[c,r,t,b,f,e]},transferList:[c,r,t,b,f,e,d.buffer,n.buffer]})};d.prototype.setObsolete=function(){this.status=q.TileStatus.INVALID};d.prototype.getLayers=function(){return this._workerTileHandler.getLayers()};d.prototype.getWorkerTileHandler=
function(){return this._workerTileHandler};d.prototype._parse=function(d,f){return G(this,void 0,void 0,function(){var a;return F(this,function(e){if(0===Object.keys(d).length)return[2,[]];this.status=q.TileStatus.MODIFIED;a=new N(d,this,f.client);return[2,a.parse(f)]})})};return d}()});