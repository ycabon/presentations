// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../webgl ./definitions ./Utils ./util/debug ../../../webgl/FramebufferObject".split(" "),function(v,w,B,C,x,D,E,d,F,y,e,q,z,G){Object.defineProperty(w,"__esModule",{value:!0});var r=E.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),n=z.createDebugLogger(z.DEBUG_ATTR_UPDATES,
r),A=function(){function c(a,b,g){this._lastTexture=this._texture=null;this._fbos={};this.texelSize=4;var f=a.buffer,c=a.pixelType;a=a.textureOnly;var h=q.getPixelArrayCtor(c);this.shared=g;this.pixelType=c;this.size=b;this.textureOnly=a;a||(this.data=new h(d.expect(f)));this._resetRange()}c.prototype.destroy=function(){d.andThen(this._texture,function(a){return a.dispose()});var a=function(a){d.andThen(b._fbos[a],function(b){"0"===a&&b.detachColorTexture();b.dispose()});b._fbos[a]=null},b=this,g;
for(g in this._fbos)a(g);this._texture=null};Object.defineProperty(c.prototype,"_textureDesc",{get:function(){return{target:3553,wrapMode:33071,pixelFormat:6408,dataType:this.pixelType,samplingMode:9728,width:this.size,height:this.size}},enumerable:!0,configurable:!0});c.prototype.setData=function(a,b,g){a&=2147483647;var f=d.expect(this.data);b=a*this.texelSize+b;!f||b>=f.length||(f[b]=g,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};c.prototype.getData=function(a,
b){if(d.isNone(this.data))return null;a=(a&2147483647)*this.texelSize+b;return!this.data||a>=this.data.length?null:this.data[a]};c.prototype.getTexture=function(a){var b=this;return d.unwrapOr(this._texture,function(){return b._initTexture(a)})};c.prototype.getFBO=function(a,b){void 0===b&&(b=0);if(d.isNone(this._fbos[b])){var g=0===b?this.getTexture(a):this._textureDesc;this._fbos[b]=new G(a,{colorTarget:0,depthStencilTarget:0},g)}return this._fbos[b]};Object.defineProperty(c.prototype,"locked",
{get:function(){return 5121===this.pixelType&&this.shared&&!this.textureOnly&&D("esri-atomics")&&this.data?1===Atomics.load(this.data,0):!1},enumerable:!0,configurable:!0});c.prototype.updateTexture=function(a){if(!this.locked)try{var b=this.dirtyStart,g=this.dirtyEnd;if(!(b>g)){this._resetRange();var f=d.expect(this.data).buffer,c=this.getTexture(a),h=(b-b%this.size)/this.size,k=(g-g%this.size)/this.size,m=h*this.size*4,p=4*(this.size+k*this.size)-m,l=q.getPixelArrayCtor(this.pixelType),e=l.BYTES_PER_ELEMENT;
try{new l(f,m*e,p)}catch(t){console.debug(t)}var n=new l(f,m*e,p),u=this.size;a=k-h+1;a>this.size?r.error(new x("mapview-webgl","Out-of-bounds index when updating AttributeData")):c.updateData(0,0,h,u,a,n)}}catch(t){console.debug(t)}};c.prototype.update=function(a){var b=a.data,g=a.start,c=a.end;if(d.isSome(b))for(var e=this.data,h=g*this.texelSize,k=0;k<b.length;k++)a.layout&1<<k%this.texelSize&&(e[h+k]=b[k]);this.dirtyStart=Math.min(this.dirtyStart,g);this.dirtyEnd=Math.max(this.dirtyEnd,c)};c.prototype.resize=
function(a,b){var c=this.size;this.size=b;this.textureOnly?c!==this.size&&(this._lastTexture=this._texture,this._texture=null):(b=q.getPixelArrayCtor(this.pixelType),this.destroy(),this.data=new b(d.expect(a.buffer)))};c.prototype._resetRange=function(){this.dirtyStart=2147483647;this.dirtyEnd=0};c.prototype._initTexture=function(a){var b=new y.Texture(a,this._textureDesc,d.unwrapOr(this.data,void 0));if(d.isSome(this._lastTexture)&&this._fbos[0]){var c=this._lastTexture.descriptor.width,f=this._lastTexture.descriptor.height,
e=this._lastTexture.descriptor.dataType,h=this._lastTexture.descriptor.pixelFormat,k=this.getFBO(a),m=q.getPixelBytes(e),p=q.getPixelArrayCtor(e),m=new ArrayBuffer(c*f*m*this.texelSize),p=new p(m),m=a.getBoundFramebufferObject(),l=a.getViewport(),n=l.x,r=l.y,u=l.width,l=l.height;a.bindFramebuffer(k);k.readPixels(0,0,c,f,h,e,p);b.updateData(0,0,0,2*c,f/2,p);a.setViewport(n,r,u,l);a.bindFramebuffer(m)}this.destroy();return this._texture=b};return c}();v=function(){function c(){this._locked=this._forceNextUpload=
this._initialized=!1}c.prototype.initialize=function(a){var b=a.blocks,c=a.shared,f=a.size;this.shared=c;this.size=f;n("Initializing AttributeStoreView",a);if(d.isNone(this._data))this._data=d.mapMany(b,function(a){return new A(a,f,c)});else for(a=0;a<this._data.length;a++){var e=this._data[a],h=b[a];d.isSome(h)&&(d.isNone(e)?this._data[a]=new A(h,f,c):e.resize(h,f))}this._initialized=!0};c.prototype.destroy=function(){d.andThen(this._data,function(a){return d.mapMany(a,function(a){return a.destroy()})});
d.andThen(this._defaultTexture,function(a){return a.dispose()})};c.prototype.getBlock=function(a){return d.isNone(this._data)?null:this._data[a]};c.prototype.setLabelMinZoom=function(a,b){this.setData(a,0,1,b)};c.prototype.getLabelMinZoom=function(a){return this.getData(a,0,1,255)};c.prototype.getFilterFlags=function(a){return this.getData(a,0,0,0)};c.prototype.getVVSize=function(a){return this.getData(a,e.ATTRIBUTE_DATA_VV,0,0)};c.prototype.getData=function(a,b,c,f){if(!this._data)return 0;b=d.expect(this._data)[b];
if(d.isNone(b))return 0;a=b.getData(a,c);return d.isSome(a)?a:f};c.prototype.setData=function(a,b,c,f){b=d.expect(this._data)[b];d.expect(b).setData(a,c,f)};c.prototype.lockTextureUpload=function(){this._locked=!0};c.prototype.unlockTextureUpload=function(){this._locked=!1};c.prototype.forceTextureUpload=function(){this._forceNextUpload=!0};c.prototype.requestUpdate=function(a){return C(this,void 0,void 0,function(){var b;return B(this,function(c){if(this._pendingAttributeUpdate)return r.error(new x("mapview-webgl",
"Tried to update attribute data with a pending update")),[2];b=F.createResolver();n("AttributeStoreView Update Requested",a);this._pendingAttributeUpdate={data:a,resolver:b};return[2,b.promise]})})};c.prototype.update=function(){if(this._initialized&&d.isSome(this._pendingAttributeUpdate)){for(var a=this._pendingAttributeUpdate,b=a.data,a=a.resolver,c=d.expect(this._data),f=function(a){var f=b.blocks[a];d.andThen(c[a],function(b){return d.andThen(f,function(c){n("Updating block "+a,c);b.update(c)})})},
e=0;e<b.blocks.length;e++)f(e);this._pendingAttributeUpdate=null;a()}};c.prototype.bindTextures=function(a){this.update();var b=this._getDefaultTexture(a);if(this._initialized){var c=d.expect(this._data);if(!this._locked||this._forceNextUpload)d.forEachSome(c,function(b){return b.updateTexture(a)}),this._forceNextUpload=!1;a.bindTexture(d.mapOr(c[0],b,function(b){return b.getTexture(a)}),e.TEXTURE_BINDING_ATTRIBUTE_DATA_0);a.bindTexture(d.mapOr(c[1],b,function(b){return b.getTexture(a)}),e.TEXTURE_BINDING_ATTRIBUTE_DATA_1);
a.bindTexture(d.mapOr(c[2],b,function(b){return b.getTexture(a)}),e.TEXTURE_BINDING_ATTRIBUTE_DATA_2);a.bindTexture(d.mapOr(c[3],b,function(b){return b.getTexture(a)}),e.TEXTURE_BINDING_ATTRIBUTE_DATA_3)}else a.bindTexture(b,e.TEXTURE_BINDING_ATTRIBUTE_DATA_0),a.bindTexture(b,e.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(b,e.TEXTURE_BINDING_ATTRIBUTE_DATA_2),a.bindTexture(b,e.TEXTURE_BINDING_ATTRIBUTE_DATA_3)};c.prototype._getDefaultTexture=function(a){d.isNone(this._defaultTexture)&&(this._defaultTexture=
new y.Texture(a,{wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array(4)));return this._defaultTexture};return c}();w.AttributeStoreView=v});