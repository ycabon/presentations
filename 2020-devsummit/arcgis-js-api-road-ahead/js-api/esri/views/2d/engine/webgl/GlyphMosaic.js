// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/has ../../../../core/promiseUtils ../../../webgl ./Rect ./RectangleBinPack".split(" "),function(t,u,v,l,q,r,n){return function(){function b(d,a,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=d;this.height=a;this._glyphSource=c;this._binPack=new n(d-4,a-4);this._glyphData.push(new Uint8Array(d*a));this._dirties.push(!0);this._textures.push(void 0);
this._addDecorationGlyph()}b.prototype.getGlyphItems=function(d,a,c){for(var f=this,e=[],p=this._glyphSource,b=new Set,h=1/256,g=0;g<a.length;g++)b.add(Math.floor(a[g]*h));var m=[];b.forEach(function(a){if(256>=a){var e=d+a;f._rangePromises.has(e)?m.push(f._rangePromises.get(e)):(a=p.getRange(d,a,c).then(function(){f._rangePromises["delete"](e)}).catch(function(a){f._rangePromises["delete"](e);if(!l.isAbortError(a))throw Error("Unable to query resource");}),f._rangePromises.set(e,a),m.push(a))}});
return l.all(m).then(function(){var c,b=f._glyphIndex[d];b||(b={},f._glyphIndex[d]=b);for(var g=0;g<a.length;g++){c=a[g];var k=b[c];if(k)e[c]={sdf:!0,rect:k.rect,metrics:k.metrics,page:k.page};else if((k=p.getGlyph(d,c))&&k.metrics){var h=f._recordGlyph(k);b[c]={rect:h,metrics:k.metrics,tileIDs:null,page:f._currentPage};e[c]={sdf:!0,rect:h,metrics:k.metrics,page:f._currentPage};f._dirties[f._currentPage]=!0}}return e})};b.prototype._recordGlyph=function(d){var a=d.metrics;if(0===a.width)a=new r.default(0,
0,0,0);else{var c=a.width+6,f=a.height+6,e=c%4?4-c%4:4,b=f%4?4-f%4:4;1===e&&(e=5);1===b&&(b=5);a=this._binPack.allocate(c+e,f+b);a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new n(this.width-4,this.height-4),a=this._binPack.allocate(c+e,f+b));e=this._glyphData[this._currentPage];d=d.bitmap;
var l=b=void 0;if(d)for(var h=0;h<f;h++)for(var b=c*h,l=this.width*(a.y+h+1)+a.x,g=0;g<c;g++)e[l+g+1]=d[b+g]}return a};b.prototype._addDecorationGlyph=function(){for(var d=[117,149,181,207,207,181,149,117],a=[],c=0;c<d.length;c++)for(var b=d[c],e=0;11>e;e++)a.push(b);d={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(a)};this._recordGlyph(d)};b.prototype.bind=function(d,a,c,b){this._textures[c]||(this._textures[c]=new q.Texture(d,{pixelFormat:6406,dataType:5121,width:this.width,
height:this.height},new Uint8Array(this.width*this.height)));var e=this._textures[c];e.setSamplingMode(a);this._dirties[c]&&e.setData(this._glyphData[c]);d.bindTexture(e,b);this._dirties[c]=!1};b.prototype.dispose=function(){this._binPack=null;for(var b=0,a=this._textures;b<a.length;b++){var c=a[b];c&&c.dispose()}this._textures.length=0;this._glyphData.length=0};return b}()});