// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Error ../../../../core/has ../../../../core/maybe ../../../webgl ./GeometryUtils ./Rect ./RectangleBinPack".split(" "),function(x,y,v,p,w,q,r,t,u){function k(d){return d&&"static"===d.type}return function(){function d(a,b,c,f){void 0===f&&(f=0);this._mosaicPages=[];this._currentPage=this._maxItemSize=0;this._fixSpriteLocationsTable=p("fix-sprite-locations");this._testId=p("test-id");this._pageHeight=this._pageWidth=0;this._mosaicRects=new Map;this._spriteCopyQueue=
[];this.pixelRatio=1;(0>=b||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=b;this._pageHeight=c;this._requestRender=a;0<f&&(this._maxItemSize=f);this.pixelRatio=window.devicePixelRatio||1;if(this._fixSpriteLocationsTable){a=[];for(var d in this._fixSpriteLocationsTable[this._testId])b=this._fixSpriteLocationsTable[this._testId][d],a[b.page]=b.pageSize;for(d=0;d<a.length;d++)b=a[d],this._mosaicPages.push({mosaicsData:{type:"static",
data:new Uint32Array(b[0]*b[1])},size:[b[0],b[1]],dirty:!0,texture:void 0})}this._binPack=new u(this._pageWidth,this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight))},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}d.prototype.getWidth=function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[0]};d.prototype.getHeight=function(a){return a>=this._mosaicPages.length?-1:this._mosaicPages[a].size[1]};
d.prototype.getPageTexture=function(a){return a<this._mosaicPages.length?this._mosaicPages[a].texture:null};d.prototype.has=function(a){return this._mosaicRects.has(a)};Object.defineProperty(d.prototype,"itemCount",{get:function(){return this._mosaicRects.size},enumerable:!0,configurable:!0});d.prototype.getSpriteItem=function(a){return this._mosaicRects.get(a)};d.prototype.addSpriteItem=function(a,b,c,f,d,e){var g;if(this._mosaicRects.has(a))return this._mosaicRects.get(a);var h,l;k(c)?this._fixSpriteLocationsTable&&
this._fixSpriteLocationsTable[this._testId]&&this._fixSpriteLocationsTable[this._testId][a]?(g=this._fixSpriteLocationsTable[this._testId][a],h=g.rect,l=g.page,g=g.pageSize):(g=this._allocateImage(b[0],b[1]),h=g[0],l=g[1],g=g[2]):(h=new t.default(0,0,b[0],b[1]),l=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:c,size:b,dirty:!0,texture:void 0}));if(0>=h.width||0>=h.height)return null;e={rect:h,width:b[0],height:b[1],sdf:d,simplePattern:e,pixelRatio:1,page:l};this._mosaicRects.set(a,e);
k(c)&&this._copy({rect:h,spriteSize:b,spriteData:c.data,page:l,pageSize:g,repeat:f,sdf:d});return e};d.prototype.hasItemsToProcess=function(){return 0!==this._spriteCopyQueue.length};d.prototype.processNextItem=function(){var a=this._spriteCopyQueue.pop();a&&this._copy(a)};d.prototype.getSpriteItems=function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];b[d]=this.getSpriteItem(d)}return b};d.prototype.getMosaicItemPosition=function(a){var b=(a=this.getSpriteItem(a))&&a.rect;if(!b)return null;b.width=
a.width;b.height=a.height;var c=this._mosaicPages[a.page];return{size:[a.width,a.height],tl:[(b.x+1)/c[0],(b.y+1)/c[1]],br:[(b.x+1+a.width)/c[0],(b.y+1+a.height)/c[1]],page:a.page}};d.prototype.bind=function(a,b,c,d){void 0===c&&(c=0);void 0===d&&(d=0);c=this._mosaicPages[c];var f=c.mosaicsData,e=c.texture;e||(e=c.size,e=k(f)?new q.Texture(a,{pixelFormat:6408,dataType:5121,width:e[0],height:e[1]},new Uint8Array(f.data.buffer)):new q.Texture(a,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,
width:e[0],height:e[1]},null),c.texture=e);e.setSamplingMode(b);k(f)?(a.bindTexture(e,d),c.dirty&&(e.setData(new Uint8Array(f.data.buffer)),e.generateMipmap())):(b=f.data,f=b.bindFrame(a,e,d),w.isSome(this._requestRender)&&f&&0<b.frameCount&&this._requestRender.requestRender(),b.bindFrame(a,e,d));c.dirty=!1};d._copyBits=function(a,b,c,d,l,e,g,h,k,n,m){var f=d*b+c;g=h*e+g;if(m)for(g-=e,m=-1;m<=n;m++,f=((m+n)%n+d)*b+c,g+=e)for(h=-1;h<=k;h++)l[g+h]=a[f+(h+k)%k];else for(m=0;m<n;m++){for(h=0;h<k;h++)l[g+
h]=a[f+h];f+=b;g+=e}};d.prototype._copy=function(a){if(!(a.page>=this._mosaicPages.length)){var b=this._mosaicPages[a.page],c=b.mosaicsData;if(!k(b.mosaicsData))throw new v("mapview-invalid-resource","unsuitable data type!");var f=a.spriteData;(c=c.data)&&f||console.error("Source or target images are uninitialized!");d._copyBits(f,a.spriteSize[0],0,0,c,a.pageSize[0],a.rect.x+1,a.rect.y+1,a.spriteSize[0],a.spriteSize[1],a.repeat);b.dirty=!0}};d.prototype._allocateImage=function(a,b){a+=2;b+=2;var c=
Math.max(a,b);if(this._maxItemSize&&this._maxItemSize<c){var c=Math.pow(2,Math.ceil(r.log2(a))),d=Math.pow(2,Math.ceil(r.log2(b)));a=new t.default(0,0,a,b);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(c*d)},size:[c,d],dirty:!0,texture:void 0});return[a,this._mosaicPages.length-1,[c,d]]}c=this._binPack.allocate(a,b);return 0>=c.width?(c=this._mosaicPages[this._currentPage],!c.dirty&&k(c.mosaicsData)&&(c.mosaicsData=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",
data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new u(this._pageWidth,this._pageHeight),this._allocateImage(a,b)):[c,this._currentPage,[this._pageWidth,this._pageHeight]]};d.prototype.dispose=function(){this._binPack=null;for(var a=0,b=this._mosaicPages;a<b.length;a++){var c=b[a],d=c.texture;d&&d.dispose();c=c.mosaicsData;k(c)||c.data.pause()}this._mosaicPages=null;this._mosaicRects.clear()};return d}()});