// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../config ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./fontUtils ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./animatedFormats/apng ./animatedFormats/gif ./util/Result ./util/symbolUtils".split(" "),
function(T,U,D,m,u,H,z,n,I,v,E,F,J,K,q,r,L,M,N,O,P,A,B,C,t){function Q(e){return m(this,void 0,void 0,function(){var a,d;return u(this,function(c){switch(c.label){case 0:a=window.URL.createObjectURL(e),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,z(a,{responseType:"image"})];case 2:return d=c.sent().data,window.URL.revokeObjectURL(a),[2,d];case 3:return c.sent(),window.URL.revokeObjectURL(a),[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+a)];case 4:return[2]}})})}
function R(e,a){return m(this,void 0,void 0,function(){var d,c,b,f,h,g,k,w,p;return u(this,function(l){switch(l.label){case 0:d=e.imageData?"data:"+e.contentType+";base64,"+e.imageData:e.url;if(-1===d.indexOf(";base64,"))return[3,1];b=d.indexOf(";base64,")+8;f=d.substring(b);h=atob(f);g=new Uint8Array(h.length);for(k=0;k<h.length;k++)g[k]=h.charCodeAt(k);c=g.buffer;return[3,4];case 1:return l.trys.push([1,3,,4]),[4,z(d,D({responseType:"array-buffer"},a))];case 2:return c=w=l.sent().data,[3,4];case 3:return p=
l.sent(),v.isAbortError(p)?[3,4]:[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+d)];case 4:return[2,c]}})})}var G=J.vec2f32.create(),x=I.getLogger("esri.views.2d.engine.webgl.TextureManager"),S=function(){function e(a,d,c){this.mosaicType=a;this.page=d;this.sdf=c}e.fromMosaic=function(a,d){return new e(a,d.page,d.sdf)};return e}();return function(){function e(a){this._invalidFontsMap=new Map;this._sdfConverter=new O.default(126);this._bindingInfos=[];this._hashToBindingIndex=
new Map;this._rasterizer=new K.default;this._spriteMosaic=new P(a,2048,2048,500);this._glyphSource=new N(H.fontsUrl+"/{fontstack}/{range}.pbf");this._glyphMosaic=new M(1024,1024,this._glyphSource)}Object.defineProperty(e.prototype,"sprites",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"glyphs",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0});e.prototype.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();
this._rasterizer.dispose();this._rasterizer=this._glyphMosaic=this._spriteMosaic=null};e.prototype._hashMosaic=function(a,d){return 1|a<<1|(d.sdf?1:0)<<2|d.page<<3};e.prototype._setTextureBinding=function(a,d){var c=this._hashMosaic(a,d);this._hashToBindingIndex.has(c)||(a=S.fromMosaic(a,d),this._hashToBindingIndex.set(c,this._bindingInfos.length+1),this._bindingInfos.push(a));d.textureBinding=this._hashToBindingIndex.get(c)};e.prototype.rasterizeItem=function(a,d,c){var b=this;void 0===d&&(d=null);
return a?a.type&&-1!==a.type.toLowerCase().indexOf("3d")?(x.error(new n("mapview-invalid-type","MapView does not support 3d symbol type: "+a.type,a)),v.resolve({glyphMosaicItems:[],spriteMosaicItem:null})):!a.type||"text"!==a.type&&"esriTS"!==a.type&&"CIMTextSymbol"!==a.type?this._rasterizeSpriteSymbol(a,c).then(function(a){C.ok(a)&&a&&b._setTextureBinding(r.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}):this._rasterizeTextSymbol(a,d,c).then(function(a){a.forEach(function(a){return b._setTextureBinding(r.MosaicType.GLYPH,
a)});return{glyphMosaicItems:a}}):(x.error(new n("mapview-null-resource","Unable to rasterize null resource")),v.resolve(null))};e.prototype.bindTextures=function(a,d,c,b){void 0===b&&(b=1);if(0!==c.textureBinding){var f=this._bindingInfos[c.textureBinding-1];c=f.page;switch(f.mosaicType){case r.MosaicType.SPRITE:f=this.sprites.getWidth(c)/b;b=this.sprites.getHeight(c)/b;b=F.vec2.set(G,f,b);this._bindSpritePage(a,c,q.TEXTURE_BINDING_SPRITE_ATLAS,9729);d.setUniform1i("u_texture",q.TEXTURE_BINDING_SPRITE_ATLAS);
d.setUniform2fv("u_mosaicSize",b);break;case r.MosaicType.GLYPH:f=this.glyphs.width/b;b=this.glyphs.height/b;b=F.vec2.set(G,f,b);this._bindGlyphsPage(a,c,q.TEXTURE_BINDING_GLYPH_ATLAS);d.setUniform1i("u_texture",q.TEXTURE_BINDING_GLYPH_ATLAS);d.setUniform2fv("u_mosaicSize",b);break;default:x.error("mapview-texture-manager","Cannot handle unknown type "+f.mosaicType)}}};e.prototype._bindSpritePage=function(a,d,c,b){b||(b=9729);this._spriteMosaic.bind(a,b,d,c)};e.prototype._bindGlyphsPage=function(a,
d,c){this._glyphMosaic.bind(a,9729,d,c)};e.prototype._rasterizeTextSymbol=function(a,d,c){var b=this,f=L.getFullyQualifiedFontName(a.font);a=this._invalidFontsMap.has(f);return this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":f,d,c).catch(function(){x.error(new n("mapview-invalid-resource","Couldn't find font "+f+". Falling back to Arial Unicode MS Regular"));b._invalidFontsMap.set(f,!0);return b._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",d,c)})};e.prototype._rasterizeSpriteSymbol=
function(a,d){return m(this,void 0,void 0,function(){var c,b,f,e,g,k;return u(this,function(h){h="CIMSolidStroke"===a.type||"CIMSolidFill"===a.type?!0:a&&(t.isFillSymbol(a)||t.isLineSymbol(a))&&"style"in a&&("solid"===a.style||"esriSFSSolid"===a.style||"esriSLSSolid"===a.style||"none"===a.style||"esriSFSNull"===a.style||"esriSLSNull"===a.style);if(h)return[2,null];c=t.keyFromSymbol(a);return this._spriteMosaic.has(c)?[2,this._spriteMosaic.getSpriteItem(c)]:"simple-marker"!==a.type&&"esriSMS"!==a.type||
!a.path?a.url||a.imageData?[2,this._handleImage(a,c,d)]:(b=this._rasterizer.rasterizeJSONResource(a))?(f=b.size,e=b.image,g=b.sdf,k=b.simplePattern,[2,this._addItemToMosaic(c,f,{type:"static",data:e},!t.isMarkerSymbol(a),g,k)]):[2,new n("TextureManager","unrecognized or null rasterized image")]:[2,this._handleSVG(a,c,d)]})})};e.prototype._handleSVG=function(a,d,c){return m(this,void 0,void 0,function(){var b,f;return u(this,function(e){switch(e.label){case 0:return b=[126,126],[4,this._sdfConverter.draw(a.path,
c)];case 1:return f=e.sent(),[2,this._addItemToMosaic(d,b,{type:"static",data:new Uint32Array(f.buffer)},!1,!0,!0)]}})})};e.prototype._handleGIFOrPNG=function(a,d,c){return m(this,void 0,void 0,function(){var b,e,h,g,k,w,p,l,y,m,q,r;return u(this,function(f){switch(f.label){case 0:return[4,R(a,c)];case 1:b=f.sent();if(!C.ok(b))return[3,10];e=B.isGIF(b);h=A.isPNG(b);if(!e&&!h)return[2,new n("mapview-invalid-resource","Image data is neither GIF nor PNG!")];g=void 0;f.label=2;case 2:return f.trys.push([2,
7,,8]),e&&B.isAnimatedGIF(b)?[4,B.default.create(b,c)]:[3,4];case 3:return g=f.sent(),[3,6];case 4:return h&&A.isAnimatedPNG(b)?[4,A.default.create(b,c)]:[3,6];case 5:g=f.sent(),f.label=6;case 6:return[3,8];case 7:return k=f.sent(),v.isAbortError(k)?[3,8]:[2,new n("mapview-invalid-resource","Could not fetch requested resource!")];case 8:if(g&&C.ok(g))return[2,this._addItemToMosaic(d,[g.width,g.height],{type:"animated",data:g},!t.isMarkerSymbol(a),!1,!1)];w=e?"image/gif":"image/png";p=new Blob([b],
{type:w});return[4,Q(p)];case 9:if((l=f.sent())&&l instanceof HTMLImageElement)return y=this._rasterizer.rasterizeImageResource(l,a.colorSubstitutions),m=y.size,q=y.sdf,r=y.image,[2,this._addItemToMosaic(d,m,{type:"static",data:r},!t.isMarkerSymbol(a),q,!1)];f.label=10;case 10:return[2,new n("mapview-invalid-resource","Could not handle resource!")]}})})};e.prototype._handleImage=function(a,d,c){return m(this,void 0,void 0,function(){var b,f,e,g,k,m,p;return u(this,function(l){switch(l.label){case 0:var h;
(h=a.url&&-1!==a.url.indexOf(".gif")||a.contentType&&"image/gif"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/gif"))||(h=a.url&&-1!==a.url.indexOf(".png")||a.contentType&&"image/png"===a.contentType||a.imageData&&-1!==a.imageData.indexOf("data:image/png"));if(h)return[2,this._handleGIFOrPNG(a,d,c)];b=a.imageData?"data:"+a.contentType+";base64,"+a.imageData:a.url;l.label=1;case 1:return l.trys.push([1,3,,4]),[4,z(b,D({responseType:"image"},c))];case 2:return f=l.sent().data,-1!==
b.indexOf("data:image/svg+xml")&&(f.width=E.pt2px(a.width),f.height=E.pt2px(a.height)),e=this._rasterizer.rasterizeImageResource(f,a.colorSubstitutions),g=e.size,k=e.sdf,m=e.image,[2,this._addItemToMosaic(d,g,{type:"static",data:m},!t.isMarkerSymbol(a),k,!1)];case 3:return p=l.sent(),v.isAbortError(p)?[3,4]:[2,new n("mapview-invalid-resource","Could not fetch requested resource at "+b)];case 4:return[2,void 0]}})})};e.prototype._addItemToMosaic=function(a,d,c,b,e,h){return this._spriteMosaic.addSpriteItem(a,
d,c,b,e,h)};return e}()});