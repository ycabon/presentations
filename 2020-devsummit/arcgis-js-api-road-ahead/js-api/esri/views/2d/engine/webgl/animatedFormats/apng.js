// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Error ../../../../../core/promiseUtils".split(" "),function(m,p,u,v,n,q,r){function x(a){var c=a.constructor===Uint8Array?a:new Uint8Array(a);return w.some(function(a,d){return a!==c[d]})?!1:!0}function F(a,c){var b=new Uint8Array(c);if(w.some(function(a,d){return a!==b[d]}))return G;var d=!1;t(b,function(a){return!(d="acTL"===
a)});if(!d)return y;var g=[],f=[],k=null,e=null,z=0;t(b,function(d,b,c,h){var l=new DataView(b.buffer);switch(d){case "IHDR":k=b.subarray(c+8,c+8+h);a.width=l.getUint32(c+8);a.height=l.getUint32(c+12);break;case "acTL":a.numPlays=l.getUint32(c+8+4);break;case "fcTL":e&&(a.frames.push(e),z++);e=new H;e.width=l.getUint32(c+8+4);e.height=l.getUint32(c+8+8);e.left=l.getUint32(c+8+12);e.top=l.getUint32(c+8+16);d=l.getUint16(c+8+20);b=l.getUint16(c+8+22);0===b&&(b=100);e.delay=1E3*d/b;10>=e.delay&&(e.delay=
100);a.playTime+=e.delay;e.disposeOp=l.getUint8(c+8+24);e.blendOp=l.getUint8(c+8+25);e.dataParts=[];0===z&&2===e.disposeOp&&(e.disposeOp=1);break;case "fdAT":e&&e.dataParts.push(b.subarray(c+8+4,c+8+h));break;case "IDAT":e&&e.dataParts.push(b.subarray(c+8,c+8+h));break;case "IEND":f.push(A(b,c,12+h));break;default:g.push(A(b,c,12+h))}});if(0===a.frames.length)return y;a.frameCount=a.frames.length;var m=new Blob(g),h=new Blob(f);a.frames.forEach(function(a){var c=[];c.push(w);k.set(B(a.width),0);k.set(B(a.height),
4);c.push(C("IHDR",k));c.push(m);a.dataParts.forEach(function(a){return c.push(C("IDAT",a))});c.push(h);a.data=new Blob(c,{type:"image/png"});delete a.dataParts;c=null});return a}function t(a,c){var b=new DataView(a.buffer),d=8,g,f,k;do f=b.getUint32(d),g=d+4,g=Array.prototype.slice.call(a.subarray(g,g+4)),g=String.fromCharCode.apply(String,g),k=c(g,a,d,f),d+=12+f;while(!1!==k&&"IEND"!==g&&d<a.length)}function I(a){for(var c=new Uint8Array(a.length),b=0;b<a.length;b++)c[b]=a.charCodeAt(b);return c}
function A(a,c,b){var d=new Uint8Array(b);d.set(a.subarray(c,c+b));return d}function C(a,c){var b=a.length+c.length,d=new Uint8Array(b+8),g=new DataView(d.buffer);g.setUint32(0,c.length);d.set(I(a),4);d.set(c,8);var f=4,k=b;void 0===f&&(f=0);void 0===k&&(k=d.length-f);a=-1;c=f;for(f+=k;c<f;c++)a=a>>>8^D[(a^d[c])&255];g.setUint32(b+4,a^-1);return d}function B(a){return new Uint8Array([a>>>24&255,a>>>16&255,a>>>8&255,a&255])}Object.defineProperty(p,"__esModule",{value:!0});var D=new Uint32Array(256);
for(m=0;256>m;m++){n=m;for(var E=0;8>E;E++)n=0!==(n&1)?3988292384^n>>>1:n>>>1;D[m]=n}var G=new q("Not a PNG"),y=new q("Not an animated PNG"),w=new Uint8Array([137,80,78,71,13,10,26,10]);p.isPNG=x;p.getPNGSize=function(a){a=new Uint8Array(a);var c,b;t(a,function(a,g,f){g=new DataView(g.buffer);"IHDR"===a&&(c=g.getUint32(f+8),b=g.getUint32(f+12))});return[c,b]};p.isAnimatedPNG=function(a){a=new Uint8Array(a);if(!x(a))return!1;var c=!1;t(a,function(a){return!(c="acTL"===a)});return c};m=function(){function a(){this.playTime=
this.numPlays=this.height=this.width=0;this.frames=[];this.playing=this.paused=!1;this.playSpeed=1;this.currentFrameNumber=0;this._lastUsedFrame=-1}a.create=function(c,b){return v(this,void 0,void 0,function(){var d,g;return u(this,function(f){switch(f.label){case 0:d=new a,f.label=1;case 1:return f.trys.push([1,3,,4]),[4,d._load(c,b)];case 2:return f.sent(),[3,4];case 3:return g=f.sent(),r.isAbortError(g)?[3,4]:[2,new q("invalid-resource","Could not load PNG: "+g.message)];case 4:return[2,d]}})})};
a.prototype.play=function(){this.playing||(this.paused=!1,this.playing=!0,this._play())};a.prototype.pause=function(){this.paused=!0;this.playing=!1;clearTimeout(this.timerID)};a.prototype.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()};a.prototype.bindFrame=function(a,b,d){a.bindTexture(b,d);a=this.frameChanged();if(!a)return!1;d=this.currentFrame;var c=d.frameData,f=b.descriptor;(d.left||d.top||d.width!==f.width||d.height!==f.height)&&b.setData(null);b.updateData(0,d.left,
d.top,d.width,d.height,c);this.updateUsedFrame();return a};a.prototype.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber};a.prototype.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber};a.prototype._load=function(a,b){return v(this,void 0,void 0,function(){var c,b,f=this;return u(this,function(d){switch(d.label){case 0:d.trys.push([0,2,,3]);c=F(this,a);if(c!==this)return[2,c];this._resizeCanvas=document.createElement("canvas");this._resizeCanvas.width=
this.width;this._resizeCanvas.height=this.height;return[4,r.all(this.frames.map(function(a){return a.createImage(f._resizeCanvas)}))];case 1:return d.sent(),[3,3];case 2:return b=d.sent(),r.isAbortError(b)?[3,3]:[2,new q("invalid-resource","Could not parse PNG")];case 3:return this.play(),[2]}})})};a.prototype._play=function(){var a=this,b;if(0===this.playSpeed)this.pause();else{0>this.playSpeed?(--this.currentFrameNumber,0>this.currentFrameNumber&&(this.currentFrameNumber=this.frames.length-1),b=
this.currentFrameNumber,--b,0>b&&(b=this.frames.length-1),b=1*-this.frames[b].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,b=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);var d=this.frames[this.currentFrameNumber];this.currentFrame={frameData:d.imageData,top:d.top,left:d.left,width:d.width,height:d.height};this.timerID=window.setTimeout(function(){return a._play()},b)}};return a}();p.default=m;var H=function(){function a(){this.blendOp=
this.disposeOp=this.delay=this.height=this.width=this.top=this.left=0;this.imageData=this.data=null}a.prototype.createImage=function(a){return v(this,void 0,void 0,function(){var c=this;return u(this,function(d){return null!==this.imageData?[2]:[2,r.create(function(d,b){var f=URL.createObjectURL(c.data),e=document.createElement("img");e.onload=function(){URL.revokeObjectURL(f);var b;a.width=e.width;a.height=e.height;b=a.getContext("2d");b.drawImage(e,0,0,e.width,e.height);b=b.getImageData(0,0,e.width,
e.height);b=new Uint8Array(b.data);for(var g,h=0;h<b.length;h+=4)g=b[h+3]/255,b[h]*=g,b[h+1]*=g,b[h+2]*=g;b=new ImageData(new Uint8ClampedArray(b.buffer),e.width,e.height);c.imageData=b;d()};e.onerror=function(){URL.revokeObjectURL(f);c.imageData=null;b(Error("Image creation error"))};e.src=f})]})})};return a}()});