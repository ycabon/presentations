// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/libs/gl-matrix-2/vec2f32 ../../../../../core/libs/gl-matrix-2/vec4f32 ../../../../webgl ../definitions ../enums ../GeometryUtils ../number ./WGLBrush".split(" "),function(E,C,H,K,z,A,F,I,L,N,O){Object.defineProperty(C,"__esModule",{value:!0});var P=1/65536,M=[1,1,1,1];E=function(D){function h(){var b=null!==D&&D.apply(this,arguments)||this;b._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,
stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]};b._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,
offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]};b._iconProgramOptions={id:!1,dd:!1,sdf:!1};b._sdfProgramOptions={id:!1,dd:!1};b._spritesTextureSize=K.vec2f32.create();b._haloColor=z.vec4f32.create();b._sdfColor=z.vec4f32.create();b._color=z.vec4f32.create();return b}
H(h,D);h.prototype.dispose=function(){};h.prototype.drawMany=function(b,a){var d=b.drawPhase,e=b.styleLayerId,c=b.styleLayer,G=b.fadeRecorder.getFadeValues(),n;d===I.WGLDrawPhase.HITTEST&&(n=N.u32to4Xu8(e));this._drawIcons(b,c,a,G,n);this._drawText(b,c,a,G,n)};h.prototype._drawIcons=function(b,a,d,e,c){for(var G=this,n=b.context,f=b.displayLevel,r=b.drawPhase,k=b.painter,h=b.state,p=b.styleLayerId,v,B=!1,t=0;t<d.length;t++){var u=d[t];if(u.layerData[p]&&(v=u.layerData[p],0<v.iconPerPageElementsMap.size)){B=
!0;break}}if(B){var u=a.hasDataDrivenIconSize?1:a.getLayoutValue("icon-size",f),l=a.hasDataDrivenIconColor?M:a.getPaintValue("icon-color",f),q=a.hasDataDrivenIconOpacity?1:a.getPaintValue("icon-opacity",f),B=a.getPaintValue("icon-translate",f),t=a.getPaintValue("icon-translate-anchor",f),x=k.getVectorTileProgramCach(),k=l[3]*q;this._color[0]=k*l[0];this._color[1]=k*l[1];this._color[2]=k*l[2];this._color[3]=k;k=a.getLayoutValue("icon-rotation-alignment",f);2===k&&(k=1===a.getLayoutValue("symbol-placement",
f)?0:1);var l=v.isSDF,w=a.hasDataDrivenIcon,r=r===I.WGLDrawPhase.HITTEST,q=this._iconProgramOptions;q.id=r;q.dd=w;q.sdf=l;var g=x.getProgram(4,(r?1:0)<<2|(w?1:0)<<1|(l?1:0),q);n.bindProgram(g);l&&(l=a.getPaintValue("icon-halo-color",f),q=a.getPaintValue("icon-halo-width",f),g.setUniform4f("u_outlineColor",l[0],l[1],l[2],l[3]),g.setUniform1f("u_outlineSize",q));g.setUniformMatrix3fv("u_displayViewMat3",0===k?h.displayViewMat3:h.displayMat3);g.setUniformMatrix3fv("u_displayMat3",1===t?h.displayMat3:
h.displayViewMat3);g.setUniform2fv("u_iconTranslation",B);g.setUniform1f("u_depth",a.z);g.setUniform1f("u_mapRotation",L.degToByte(h.rotation));g.setUniform1f("u_keepUpright",0);g.setUniform1f("u_level",10*f);g.setUniform1f("u_fadeSpeed",10*e.fadeSpeed);g.setUniform1f("u_minfadeLevel",10*e.minfadeLevel);g.setUniform1f("u_maxfadeLevel",10*e.maxfadeLevel);g.setUniform1f("u_fadeChange",10*(f+e.fadeChange));g.setUniform1i("u_texture",F.VTL_TEXTURE_BINDING_UNIT_SPRITES);g.setUniform1f("u_size",u);g.setUniform4fv("u_color",
this._color);r&&g.setUniform4fv("u_id",c);a=function(a){if(!a.layerData[p])return"continue";v=a.layerData[p];if(0===v.iconPerPageElementsMap.size)return"continue";var c=y._getIconVAO(n,a,w,x);if(!c)return"continue";n.bindVAO(c);g.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs);v.iconPerPageElementsMap.forEach(function(c,d){G._renderIconRange(b,g,c,d,a)})};var y=this;for(e=0;e<d.length;e++)u=d[e],a(u)}};h.prototype._renderIconRange=function(b,a,d,e,c){var h=b.context,n=b.hasClipping,f=b.requiredLevel;
b=b.spriteMosaic;this._spritesTextureSize[0]=b.getWidth(e)/4;this._spritesTextureSize[1]=b.getHeight(e)/4;a.setUniform2fv("u_mosaicSize",this._spritesTextureSize);b.bind(h,9729,e,F.VTL_TEXTURE_BINDING_UNIT_SPRITES);a=!0;f!==c.key.level||n?h.setStencilFunction(514,c.stencilRef,255):a=!1;h.setStencilTestEnabled(a);h.drawElements(4,d[1],5125,12*d[0]);c.triangleCount+=d[1]/3};h.prototype._drawText=function(b,a,d,e,c){for(var h=this,n=b.context,f=b.displayLevel,r=b.drawPhase,k=b.glyphMosaic,A=b.hasClipping,
p=b.painter,v=b.pixelRatio,B=b.requiredLevel,t=b.state,u=b.styleLayerId,l,q=!1,x=0;x<d.length;x++)if(b=d[x],b.layerData[u]&&(l=b.layerData[u],0<l.glyphPerPageElementsMap.size)){q=!0;break}if(q){b=a.getLayoutValue("text-rotation-alignment",f);2===b&&(b=1===a.getLayoutValue("symbol-placement",f)?0:1);var q=0===b,q=a.getLayoutValue("text-keep-upright",f)&&q,r=r===I.WGLDrawPhase.HITTEST,v=.8*3/v,x=a.hasDataDrivenTextSize?1:a.getLayoutValue("text-size",f),w=a.hasDataDrivenTextColor?M:a.getPaintValue("text-color",
f),g=a.hasDataDrivenTextOpacity?1:a.getPaintValue("text-opacity",f),y=a.getPaintValue("text-halo-color",f),z=a.getPaintValue("text-halo-width",f),D=3*a.getPaintValue("text-halo-blur",f),E=3*z,C=p.getVectorTileProgramCach(),p=w[3]*g;this._sdfColor[0]=p*w[0];this._sdfColor[1]=p*w[1];this._sdfColor[2]=p*w[2];this._sdfColor[3]=p;p=y[3]*g;this._haloColor[0]=p*y[0];this._haloColor[1]=p*y[1];this._haloColor[2]=p*y[2];this._haloColor[3]=p;this._glyphTextureSize||(this._glyphTextureSize=K.vec2f32.fromValues(k.width/
4,k.height/4));var p=a.getPaintValue("text-translate",f),w=a.getPaintValue("text-translate-anchor",f),J=a.hasDataDrivenText,g=this._sdfProgramOptions;g.id=r;g.dd=J;var m=C.getProgram(6,(r?1:0)<<1|(J?1:0),g);n.bindProgram(m);m.setUniformMatrix3fv("u_displayViewMat3",0===b?t.displayViewMat3:t.displayMat3);m.setUniformMatrix3fv("u_displayMat3",1===w?t.displayMat3:t.displayViewMat3);m.setUniform2fv("u_textTranslation",p);m.setUniform1f("u_depth",a.z+P);m.setUniform2fv("u_mosaicSize",this._glyphTextureSize);
m.setUniform1f("u_mapRotation",L.degToByte(t.rotation));m.setUniform1f("u_keepUpright",q?1:0);m.setUniform1f("u_level",10*f);m.setUniform1f("u_fadeSpeed",10*e.fadeSpeed);m.setUniform1f("u_minfadeLevel",10*e.minfadeLevel);m.setUniform1f("u_maxfadeLevel",10*e.maxfadeLevel);m.setUniform1f("u_fadeChange",10*(f+e.fadeChange));m.setUniform1i("u_texture",F.VTL_TEXTURE_BINDING_UNIT_GLYPHS);m.setUniform1f("u_size",x);m.setUniform1f("u_antialiasingWidth",v);r&&m.setUniform4f("u_id",c[0],c[1],c[2],c[3]);a=function(a){if(!a.layerData[u])return"continue";
l=a.layerData[u];if(0===l.glyphPerPageElementsMap.size)return"continue";var b=H._getSDFVAO(n,a,J,C);if(!b)return"continue";n.bindVAO(b);m.setUniformMatrix3fv("u_dvsMat3",a.transforms.dvs);b=!0;B!==a.key.level||A?n.setStencilFunction(514,a.stencilRef,255):b=!1;n.setStencilTestEnabled(b);l.glyphPerPageElementsMap.forEach(function(b,c){h._renderGlyphRange(n,b,c,k,m,y[3],z,D,E,a)})};var H=this;for(e=0;e<d.length;e++)b=d[e],a(b)}};h.prototype._renderGlyphRange=function(b,a,d,e,c,h,n,f,r,k){e.bind(b,9729,
d,F.VTL_TEXTURE_BINDING_UNIT_GLYPHS);0<h&&0<n&&(c.setUniform4fv("u_color",this._haloColor),c.setUniform1f("u_halo",1),c.setUniform1f("u_edgeDistance",r),c.setUniform1f("u_edgeBlur",f),b.drawElements(4,a[1],5125,12*a[0]),k.triangleCount+=a[1]/3);0<this._sdfColor[3]&&(c.setUniform4fv("u_color",this._sdfColor),c.setUniform1f("u_halo",0),c.setUniform1f("u_edgeDistance",0),c.setUniform1f("u_edgeBlur",0),b.drawElements(4,a[1],5125,12*a[0]),k.triangleCount+=a[1]/3)};h.prototype._getIconVAO=function(b,a,
d,e){if(d){if(a.iconDDVertexArrayObject)return a.iconDDVertexArrayObject;d=a.iconDDVertexBuffer;var c=a.iconIndexBuffer;if(!d||!c)return null;a.iconDDVertexArrayObject=new A.VertexArrayObject(b,e.getProgramAttributes(4),this._vertexAttributesDD,{geometry:d},c);return a.iconDDVertexArrayObject}if(a.iconVertexArrayObject)return a.iconVertexArrayObject;d=a.iconVertexBuffer;c=a.iconIndexBuffer;if(!d||!c)return null;a.iconVertexArrayObject=new A.VertexArrayObject(b,e.getProgramAttributes(4),this._vertexAttributes,
{geometry:d},c);return a.iconVertexArrayObject};h.prototype._getSDFVAO=function(b,a,d,e){if(d){if(a.textDDVertexArrayObject)return a.textDDVertexArrayObject;d=a.textDDVertexBuffer;var c=a.textIndexBuffer;if(!d||!c)return null;a.textDDVertexArrayObject=new A.VertexArrayObject(b,e.getProgramAttributes(6),this._vertexAttributesDD,{geometry:d},c);return a.textDDVertexArrayObject}if(a.textVertexArrayObject)return a.textVertexArrayObject;d=a.textVertexBuffer;c=a.textIndexBuffer;if(!d||!c)return null;a.textVertexArrayObject=
new A.VertexArrayObject(b,e.getProgramAttributes(6),this._vertexAttributes,{geometry:d},c);return a.textVertexArrayObject};return h}(O.default);C.WGLBrushVTLSymbol=E});