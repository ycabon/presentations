// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/Error ../../../../../../core/has ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../core/promiseUtils ../../../../../../geometry/support/jsonUtils ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../WGLDisplayObject ../MeshData ../VertexVector ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../templates/WGLTemplateStore".split(" "),
function(x,y,N,A,B,C,O,D,t,E,F,G,v,g,H,I,r,J,K,L,z){Object.defineProperty(y,"__esModule",{value:!0});var u=D.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),M={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null,esriGeometryEnvelope:null};x=function(){function d(b,a,c,k,q,f){this._isDD=!1;this._labelsDebugTemplate=
null;this._isDD=t.isSome(c)&&"dot-density"===c.type;this._geometryType=b;this._idField=a;this._templateStore=k;this._setLabelTemplates(q,c,f)}d.prototype.update=function(b,a,c){this._isDD=t.isSome(a)&&"dot-density"===a.type;this._setLabelTemplates(b,a,c)};d.prototype._setLabelTemplates=function(b,a,c){b&&this._validateLabelingInfo(b)&&(this._labelTemplates=b.map(function(b){return J.default.fromLabelClass(a,b,c)}))};Object.defineProperty(d.prototype,"templates",{get:function(){return this._templateStore},
enumerable:!0,configurable:!0});d.prototype.createMeshData=function(b){var a=Array(5),c=this._labelTemplates&&0<this._labelTemplates.length,k="esriGeometryPolyline"===this._geometryType?v.HEURISTIC_GLYPHS_PER_LINE:v.HEURISTIC_GLYPHS_PER_FEATURE;a[g.WGLGeometryType.MARKER]=new r.VertexVectors(g.WGLGeometryType.MARKER,b);a[g.WGLGeometryType.FILL]=new r.VertexVectors(g.WGLGeometryType.FILL,b,this._isDD);a[g.WGLGeometryType.LINE]=new r.VertexVectors(g.WGLGeometryType.LINE,b);a[g.WGLGeometryType.TEXT]=
new r.VertexVectors(g.WGLGeometryType.TEXT,b);a[g.WGLGeometryType.LABEL]=new r.VertexVectors(g.WGLGeometryType.LABEL,c?k:0);return new I.MeshData([],a)};d.prototype.analyze=function(b,a,c,k,q){return B(this,void 0,void 0,function(){var f,d,l,e,m,g,n,h,w;return A(this,function(p){switch(p.label){case 0:return f=b,E.isAborted(q)?[2,[]]:t.isSome(a)?[4,a.analyze(this._idField,b,c,k,q)]:[3,2];case 1:p.sent(),p.label=2;case 2:d=0;for(l=f;d<l.length;d++){e=l[d];m=e.groupId;if(null==m||-1===m)m=a.match(this._idField,
e,this._geometryType,c,k);if(z.isDynamicId(m))for(g=this._templateStore.getDynamicTemplateGroup(m),n=0,h=g;n<h.length;n++)(w=h[n])&&w.analyze&&w.analyze(this._templateStore,e,c,k);e.groupId=m}return[2,this._templateStore.finalize(q).then(function(){return f})]}})})};d.prototype.write=function(b,a,c,k,d,f,g){var l=this._templateStore.getTemplateGroup(a.groupId),e=a.localId;if(null!=e){var m=new H(e),q=!!f&&!!this._labelTemplates&&f.has(e);if(z.isDynamicId(a.groupId))for(var n=0;n<l.length;n++){var h=
l[n];h.bindFeature(a,c,k)}if(l&&(a.geometry||a.centroid)){k=m.displayRecords;h=a.insertAfter;void 0!==h&&(m.insertAfter=h);(c=this._geometryType)||(c=null!=a.centroid?"esriGeometryPolygon":F.getJsonType(a.geometry));for(n=0;n<l.length;n++){var h=l[n],p=b.get(h.geometryType);h.writeMesh(k,p,c,e,a)}q&&(l=this._getLabelReference(l),f=f.get(e),this._writeLabelMesh(m,b,e,a,g,f,l,d,c));b.pushDisplayObject(m)}}};d.prototype._hasBadLabelClass=function(b,a){var c=b.labelPlacement,k=M[a];if(!b.symbol)return u.warn("No LabelClass symbol specified."),
!0;if(!k)return u.error(new C("mapview-labeling:unsupported-geometry-type","Unable to create labels for Feature Layer, "+a+" is not supported")),!0;k.some(function(a){return a===c})||(k=k[0],c&&u.warn("Found invalid label placement type "+c+" for "+a+". Defaulting to "+k),b.labelPlacement=k);return!1};d.prototype._validateLabelingInfo=function(b){var a=this;return!b.some(function(b){return a._hasBadLabelClass(b,a._geometryType)})};d.prototype._getLabelReference=function(b){for(var a=0;a<b.length;a++){var c=
b[a];if(c instanceof L.default)return c}return null};d.prototype._writeLabelMesh=function(b,a,c,k,d,f,g,l,e){for(var m=b.displayRecords,q=[],n=0;n<f.length;n++){var h=f[n],p=h.text,r=h.rtl,h=this._labelTemplates[h.id],t=a.get(h.geometryType),u=d.get(h.symbolId).glyphMosaicItems;h.bindReferenceTemplate(g);h.bindTextInfo(u,p,r);h.writeMesh(m,t,e,c,k,l,q)}b.metrics=q;v.DEBUG_LABELS&&this._debugLabels(b,a)};d.prototype._debugLabels=function(b,a){var c=b.displayRecords,d=b.id,g=0;for(b=b.metrics;g<b.length;g++)for(var f=
b[g],p=0,l=f.boxes?f.boxes.concat([f.bounds]):[f.bounds];p<l.length;p++){var e=l[p],e={geometry:{paths:[[[f.anchor[0]+f.offsetX+e.center[0]-e.width/2,f.anchor[1]+f.offsetY+e.center[1]+e.height/2],[0,-e.height],[e.width,0],[0,e.height],[-e.width,0]]]},attributes:{}},m=this._getLabelDebugTemplate(),r=a.get(m.geometryType);m.writeMesh(c,r,"esriGeometryPolyline",d,e)}};d.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate());
return this._labelsDebugTemplate};d.prototype._createLabelsDebugTemplate=function(){var b=new G({style:"solid",width:1,color:[255,0,0,1]});return K.default.fromSimpleLine(null,!1,b,null,!1)};return d}();y.WGLMeshFactory=x});