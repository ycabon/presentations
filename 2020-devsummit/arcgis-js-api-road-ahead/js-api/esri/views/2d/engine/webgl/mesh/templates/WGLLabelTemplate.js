// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/mathUtils ../../../../../../core/mathUtils ../../../../../../core/libs/gl-matrix-2/mat2d ../../../../../../core/libs/gl-matrix-2/mat2df32 ../../../../../../core/libs/gl-matrix-2/vec2 ../../../../../../core/libs/gl-matrix-2/vec2f32 ../../../vectorTiles/GeometryUtils ../../color ../../definitions ../../enums ../../number ../../TextShaping ../../collisions/Metric ../../materialKey/MaterialKey ./GlyphGroup ./util ./WGLTextTemplate".split(" "),
function(M,B,T,U,V,N,W,D,X,O,Y,Z,P,u,aa,G,H,Q,K,E,C,ba){function ca(u){switch(u){case "above-left":return[-1,-1];case "above-center":case "above-along":return[0,-1];case "above-right":return[1,-1];case "center-left":return[-1,0];case "center-center":case "center-along":return[0,0];case "center-right":return[1,0];case "below-left":return[-1,1];case "below-center":case "below-along":return[0,1];case "below-right":return[1,1];case "always-horizontal":return[0,0];default:L("Found invalid placement type "+
u)}}Object.defineProperty(B,"__esModule",{value:!0});var da=V.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),R=Y.vec2f32.create(),ea=X.mat2df32.create(),S={xOffset:0,yOffset:0,width:0,height:0},L=function(u,h){void 0===h&&(h="mapview-labeling");return da.error(U(h,u))};B.isMapAligned=function(u){switch(u){case "above-along":case "below-along":case "center-along":return 1;default:return 0}};M=function(B){function h(c,b,a,f){a=B.call(this,c,a.font.size,a.haloSize||0,a.color&&P.premultiplyAlphaRGBA(a.color)||
0,a.haloColor&&P.premultiplyAlphaRGBA(a.haloColor)||0,a.horizontalAlignment,a.verticalAlignment,a.font.decoration,!1,a.angle||0,a.xoffset,a.yoffset,a.id)||this;a._refTemplate=S;a.geometryType=aa.WGLGeometryType.LABEL;var l=b.symbol,e;e=!!b.minScale&&f.scaleToZoom(b.minScale)||0;e=N.clamp(e,0,25.5);f=!!b.maxScale&&f.scaleToZoom(b.maxScale)||255;f=N.clamp(f,0,25.5);var t=ca(b.labelPlacement),r=t[0],t=t[1];a._justify=(-1*r+1)/2;a._xAlignD=r;a._yAlignD=t;a._xPlacementD=r;a._yPlacementD=t;a._minZoom=e;
a._maxZoom=f;c=K.LabelMaterialKey.load(K.createMaterialKey(a.geometryType,c,!1,b));c.sdf=!0;a._materialKey=c.data;c=l.font.decoration.toLowerCase();"underline"===c?a._decorationTop=6:"line-through"===c&&(a._decorationTop=-5);return a}T(h,B);h.fromLabelClass=function(c,b,a){return new h(c,b,b.symbol,a)};h.prototype.bindTextInfo=function(c,b,a){c=this._computeShaping(c,this._justify).getShaping(b,a);isNaN(this._decorationTop)||H.TextShaping.addDecoration(c,this._decorationTop);this._shapedGlyphs=c;
this._shapedBox=H.TextShaping.getBox(c)};h.prototype._computeShaping=function(c,b){return new H.TextShaping([c],u.TEXT_MAX_WIDTH,u.TEXT_LINE_HEIGHT,u.TEXT_SPACING,[0,0],.5,.5,b)};Object.defineProperty(h.prototype,"bounds",{get:function(){return this._bounds},enumerable:!0,configurable:!0});h.prototype.bindReferenceTemplate=function(c){this._refTemplate=c||S};h.prototype._placeGlyphs=function(c,b,a,f){var l=this._size,e=this._haloSize,t=this._shapedBox,r=this._shapedGlyphs,y=this._computeGlyphTransform(t);
if("esriGeometryPolyline"!==c)for(var n=0;n<a.length;n++)for(var p=a[n],m=0,d=r;m<d.length;m++){var g=d[m];p.place(g,c,b,y,this._materialKey,l,e,t,f,this._minZoom,this._maxZoom)}else for(n=0;n<a.length;n++)for(var p=a[n],m=g=p.order,d=m-(m-1)/2-1,q=d-(d-1)/2-1,k=q-(q-1)/2-1,g=-1===g?0:m%2?d%2?q%2?k%2?0:f-3.1:f-2.1:f-1.1:f-.1,m=Math.max(f+W.log2((this._shapedBox.width*this._scale+48)/p.pathLen),Math.max(g,this._minZoom)),d=0,q=r;d<q.length;d++)g=q[d],p.place(g,c,b,y,this._materialKey,l,e,t,f,m,this._maxZoom)};
h.prototype.writeMesh=function(c,b,a,f,l,e,t){var r=this,y=this._computeAnchors(a,l),n=G.i8888to32(0,0,0,this._bitset);if(y.length&&this._shapedGlyphs.length)if(this._placeGlyphs(a,l,y,e),l=K.LabelMaterialKey.load(this._materialKey),"esriGeometryPolyline"!==a){a=y[0];e=this._computeGlyphTransform(this._shapedBox);e=this._createBounds(this._shapedBox,e);var p=a.glyphs.get(0),m=p[0],d=m.anchorX,g=m.anchorY,q=Math.floor(10*m.minZoom),m=Math.floor(10*m.maxZoom),k=c.length;p.forEach(function(a){a.minZoom=
25.5;a.maxZoom=25.5});k=new Q.default(f,{from:k,count:c.length-k},d,g,q);d=Math.floor(d/u.COLLISION_BUCKET_SIZE);g=Math.floor(g/u.COLLISION_BUCKET_SIZE);d>=u.COLLISION_TILE_BOX_SIZE||g>=u.COLLISION_TILE_BOX_SIZE||0>d||0>g||(this._writeVertices(c,b,f,p,n,q,m),p=Math.max(this._refTemplate.height,this._refTemplate.width),l.vvSizeFieldStops||l.vvSizeMinMaxValue||l.vvSizeScaleStops||l.vvSizeUnitValue?k.setVV(p,this._xPlacementD,this._yPlacementD):(k.offsetX=(p/2+u.COLLISION_PLACEMENT_PADDING)*this._xPlacementD,
k.offsetY=(p/2+u.COLLISION_PLACEMENT_PADDING)*this._yPlacementD),k.bounds=e,t.push(k),a.clear())}else{l=function(a){var d=y[a],e=d.x,l=d.y;a=c.length;var k=new Q.default(f,{from:a,count:-1},e,l,25.5);d.glyphs.forEach(function(a){for(var m=0;m<a.length;m++){var g=a[m];g.minZoom=Math.max(d.minZoom,g.minZoom);if(g.bounds){var p=g.anchorY-l;g.bounds.center[0]+=g.anchorX-e;g.bounds.center[1]+=p;k.add(g.bounds)}}k.bounds&&r._writeHalos(c,b,f,a,n)});d.glyphs.forEach(function(a){k.bounds&&r._writeText(c,
b,f,a,n)});k.range.count=c.length-a;k.bounds&&t.push(k);d.clear()};for(a=0;a<y.length;a++)l(a);this._computedGlyphs=[]}};h.prototype._outsideTile=function(c,b){return 0>c||512<=c||0>b||512<=b};h.prototype._smoothVertices=function(c,b){if(!(0>=b)){var a=c.length;if(!(3>a)){var f=[],l=0;f.push(0);for(var e=1;e<a;e++)l+=C.dist(c[e],c[e-1]),f.push(l);b=Math.min(b,.2*l);l=[];l.push(c[0][0]);l.push(c[0][1]);var t=c[a-1][0],r=c[a-1][1],e=C.sub([0,0],c[0],c[1]);C.normalize(e);c[0][0]+=b*e[0];c[0][1]+=b*e[1];
C.sub(e,c[a-1],c[a-2]);C.normalize(e);c[a-1][0]+=b*e[0];c[a-1][1]+=b*e[1];for(e=1;e<a;e++)f[e]+=b;f[a-1]+=b;for(var y=.5*b,e=1;e<a-1;e++){for(var n=0,p=0,m=0,d=e-1;0<=d&&!(f[d+1]<f[e]-y);d--){var g=y+f[d+1]-f[e],q=f[d+1]-f[d],k=f[e]-f[d]<y?1:g/q;if(1E-6>Math.abs(k))break;var h=k*k,u=k*g-.5*h*q,w=k*q/b,v=c[d+1],x=c[d][0]-v[0],z=c[d][1]-v[1],n=n+w/u*(v[0]*k*g+.5*h*(g*x-q*v[0])-h*k*q*x/3),p=p+w/u*(v[1]*k*g+.5*h*(g*z-q*v[1])-h*k*q*z/3),m=m+w}for(d=e+1;d<a&&!(f[d-1]>f[e]+y);d++){g=y-f[d-1]+f[e];q=f[d]-
f[d-1];k=f[d]-f[e]<y?1:g/q;if(1E-6>Math.abs(k))break;h=k*k;u=k*g-.5*h*q;w=k*q/b;v=c[d-1];x=c[d][0]-v[0];z=c[d][1]-v[1];n+=w/u*(v[0]*k*g+.5*h*(g*x-q*v[0])-h*k*q*x/3);p+=w/u*(v[1]*k*g+.5*h*(g*z-q*v[1])-h*k*q*z/3);m+=w}l.push(n/m);l.push(p/m)}l.push(t);l.push(r);for(d=e=0;e<a;e++)c[e][0]=l[d++],c[e][1]=l[d++]}}};h.prototype._computeLineAnchors=function(c,b,a){b=b.paths;var f=this._scale*this._shapedBox.width;a=f/2+a;for(var f=f/2+16,l=this._shapedBox.width*this._scale,e=0;e<b.length;e++){var t=b[e],
r=[];r.push(t[0]);for(var h=1;h<t.length;h++){var n=r[h-1],p=n[0],n=n[1],p=p+t[h][0],n=n+t[h][1];r.push([p,n])}this._smoothVertices(r,l);t=[];t.push(r[0]);for(h=1;h<r.length;h++){var n=r[h-1],m=r[h],p=Math.round(m[0]-n[0]),n=Math.round(m[1]-n[1]);t.push([p,n])}b[e]=t;r=this._getPathLength(t);if(!(r<2*f))for(var h=r/2,d=0,m=t[0][0],g=t[0][1],q=1;q<t.length;q++){var p=t[q][0],n=t[q][1],k=Math.sqrt(p*p+n*n),d=d+k;if(0<=d-h){var u=d-h,B=k-u,w=B/k,v=m+p*w,x=g+n*w;this._outsideTile(v,x)||(d=new E.default(v,
x,w,e,q,m,g,k,r,-1),c.push(d));for(var z=-1,x=0,x=B-a;0<=x;x-=a){var w=x/k,v=m+p*w,A=g+n*w;z++;this._outsideTile(v,A)||(d=new E.default(v,A,w,e,q,m,g,k,r,z),c.push(d))}d=x+a;x=k-u;w=m;v=g;for(A=q-1;0!==A;A--){var C=t[A][0],I=t[A][1],F=Math.sqrt(C*C+I*I);if(d+F>=a){for(var J=d=a-d;J<F;J+=a){var D=J/F,G=w-C*D,H=v-I*D;z++;(d=J+x+f<h)&&!this._outsideTile(G,H)&&(d=new E.default(G,H,1-D,e,A,w-C,v-I,F,r,z),c.push(d))}d=F-(J-a)}else d+=F;x+=F;w-=C;v-=I}z=-1;for(x=B+a;x<=k;x+=a)w=x/k,v=m+p*w,B=g+n*w,z++,this._outsideTile(v,
B)||(d=new E.default(v,B,w,e,q,m,g,k,r,z),c.push(d));w=m+p;v=g+n;d=k-(x-a);x=u;for(A=q+1;A<t.length;A++){p=t[A][0];n=t[A][1];m=Math.sqrt(p*p+n*n);if(d+m>=a){for(g=d=a-d;g<m;g+=a)q=g/m,k=w+p*q,u=v+n*q,z++,(d=g+x+f<h)&&!this._outsideTile(k,u)&&(d=new E.default(k,u,q,e,A,w,v,m,r,z),c.push(d));d=m-(g-a)}else d+=m;x+=m;w+=p;v+=n}break}m+=p;g+=n}}return c};h.prototype._computeAnchors=function(c,b){var a=[];switch(c){case "esriGeometryPoint":return b=b.geometry,c=b.x,b=b.y,c=new E.default(c,b),a.push(c),
a;case "esriGeometryPolygon":if(b.centroid)return b=b.centroid,c=b.x,b=b.y,c=new E.default(c,b),a.push(c),a;L("Non-centroid polygon anchor placement not supported");break;case "esriGeometryPolyline":return this._computeLineAnchors(a,b.geometry,376);default:return L("Unable to handle geometryType: "+c),a}};h.prototype._getPathLength=function(c){for(var b=0,a=1;a<c.length;a++)var f=c[a][0],l=c[a][1],b=b+Math.sqrt(f*f+l*l);return b};h.prototype._computeGlyphTransform=function(c){var b=this._scale,a=
this._angle*Z.C_DEG_TO_RAD,f=c.width/2,l=c.height/2,f=this._xAlignD*f*b+(this._xOffset+this._refTemplate.xOffset)+(c.x+f);c=this._yAlignD*l*b-(this._yOffset+this._refTemplate.yOffset)-(c.y+l);l=D.mat2d.identity(ea);D.mat2d.translate(l,l,O.vec2.set(R,f,c));D.mat2d.scale(l,l,O.vec2.set(R,b,b));D.mat2d.rotate(l,l,a);return l};h.prototype._writeVertex=function(c,b,a,f,l,e,h,r,u){b=b.get("geometry");h=Math.min(Math.floor(Math.max(this._refTemplate.width,this._refTemplate.height)),255);var n=this._xPlacementD+
1,p=this._yPlacementD+1;r=G.i8888to32(r,u,0,0);this._refSymbolAndPlacementOffset=G.i8888to32(e.angle,h,n,p);b.push(f);b.push(a);b.push(l);b.push(e.vertexOffsetUpperLeft);b.push(e.texFontSizeUpperLeft);b.push(this._refSymbolAndPlacementOffset);b.push(r);b.push(f);b.push(a);b.push(l);b.push(e.vertexOffsetUpperRight);b.push(e.texFontSizeUpperRight);b.push(this._refSymbolAndPlacementOffset);b.push(r);b.push(f);b.push(a);b.push(l);b.push(e.vertexOffsetLowerLeft);b.push(e.texFontSizeLowerLeft);b.push(this._refSymbolAndPlacementOffset);
b.push(r);b.push(f);b.push(a);b.push(l);b.push(e.vertexOffsetLowerRight);b.push(e.texFontSizeLowerRight);b.push(this._refSymbolAndPlacementOffset);b.push(r);c.vertexCount+=4};return h}(ba.default);B.default=M});