// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/awaiterHelper ../../../../../../core/tsSupport/generatorHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/support/defaults ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/BidiText ../../util/Lock ../../util/Result".split(" "),function(u,p,f,g,v,B,m,q,C,
D,E,r,w,t,x,F,y,n){function k(e,a){var c=e.length;e.push(null);a.then(function(a){return e[c]=a});return e}function z(e){return!!(e&1)}Object.defineProperty(p,"__esModule",{value:!0});var h=B.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),A=[];p.isDynamicId=z;u=function(){function e(a,c){this._templateIdCounter=this._idCounter=1;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=new Map;this._cimAnalyses=
[];this._lock=new y.default;this._fetchResource=a;this._joinOnUTurn=c}Object.defineProperty(e.prototype,"_markerError",{get:function(){return this._errorTemplates.marker[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_fillError",{get:function(){return this._errorTemplates.fill[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_lineError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,
"_textError",{get:function(){return this._errorTemplates.line[0]},enumerable:!0,configurable:!0});e.prototype.createTemplateGroup=function(a,c,b){this._initErrorTemplates();var d=a.hash();if(this._symbolToTemplate.has(d))return this._symbolToTemplate.get(d);var e=[];c&&this._createMeshTemplates(e,c,b,!0);this._createMeshTemplates(e,a,b,!1);a=this._createGroupId("expanded-cim"===a.type);this._idToTemplateGroup.set(a,e);this._symbolToTemplate.set(d,a);return a};e.prototype.getCIMMosaicItem=function(a,
c){var b=this,d=this._createTemplateId(),e=m.create(function(a){return b._idToResolver.set(d,a)});this._fetchQueue.push({symbol:a,id:d,glyphIds:c});return e};e.prototype.getTemplateGroup=function(a){return this._idToTemplateGroup.has(a)?this._idToTemplateGroup.get(a):A};e.prototype.getDynamicTemplateGroup=function(a){if(!this._idToTemplateGroup.has(a))return A;z(a)||h.error("mapview-template-store","Id "+a+" does not refer to a dynamic template");return this._idToTemplateGroup.get(a)};e.prototype.finalize=
function(a){return this._fetchQueue.length||this._lock.isHeld()?y.withLock(this._lock,this._fetchAllQueuedResources.bind(this),a):m.resolve()};e.prototype._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],q.errorPolygonSymbol2D,null,!1),marker:this._createMeshTemplates([],q.errorPointSymbol2D,null,!1),line:this._createMeshTemplates([],q.errorPolylineSymbol2D,null,!1)})};e.prototype._fetchAllQueuedResources=function(a){var c=this;if(!this._fetchQueue.length)return m.resolve();
var b=this._fetchQueue,d=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return m.all(d).then(function(){return c._fetchResource(b,a).then(function(a){for(var b=0;b<a.length;b++){var d=a[b],e=d.id,d=d.mosaicItem;c._idToResolver.get(e)(d);c._idToResolver.delete(e)}})}).catch(function(a){m.isAbortError(a)?c._fetchQueue=c._fetchQueue.concat(b):h.error(v("mapview-template-store","Unable to fetch requested texture resources",a))})};e.prototype._createGroupId=function(a){return this._idCounter++<<
1|(a?1:0)};e.prototype._createTemplateId=function(){return this._templateIdCounter++};e.prototype._getCodepoints=function(a){a=F.bidiText(a.text)[0];for(var c=[],b=0;b<a.length;b++)c.push(a.charCodeAt(b));return c};e.prototype._getMosaicItem=function(a){var c=this,b=this._createTemplateId(),d="text"===a.type&&this._getCodepoints(a),e=m.create(function(a){return c._idToResolver.set(b,a)});this._fetchQueue.push({symbol:a.toJSON(),id:b,glyphIds:d});return e};e.prototype._createSMS=function(a,c){return f(this,
void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return b=d.sent().spriteMosaicItem,n.ok(b,h)?[2,t.default.fromSimpleMarker(c,a,b)]:[2,this._markerError]}})})};e.prototype._createPMS=function(a,c){return f(this,void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:return[4,this._getMosaicItem(a)];case 1:return b=d.sent().spriteMosaicItem,n.ok(b,h)?[2,t.default.fromPictureMarker(c,a,b)]:[2,this._markerError]}})})};
e.prototype._createSFS=function(a,c,b){return f(this,void 0,void 0,function(){var d,e;return g(this,function(l){switch(l.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=l.sent().spriteMosaicItem,e=a,n.ok(d,h)?[2,r.default.fromSimpleFill(c,e,d,b)]:[2,this._fillError]}})})};e.prototype._createPFS=function(a,c,b){return f(this,void 0,void 0,function(){var d,e;return g(this,function(l){switch(l.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=l.sent().spriteMosaicItem,e=a,
n.ok(d,h)?[2,r.default.fromPictureFill(c,e,d,b)]:[2,this._fillError]}})})};e.prototype._createSLS=function(a,c,b){return f(this,void 0,void 0,function(){var d,e;return g(this,function(l){switch(l.label){case 0:return[4,this._getMosaicItem(a)];case 1:return d=l.sent().spriteMosaicItem,e=a,n.ok(d,h)?[2,w.default.fromSimpleLine(c,b,e,d,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createTS=function(a,c){return f(this,void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:return[4,
this._getMosaicItem(a)];case 1:return b=d.sent().glyphMosaicItems,[2,x.default.fromText(c,a,b)]}})})};e.prototype._createCIMText=function(a,c){return f(this,void 0,void 0,function(){var b,d,e,l,f,k;return g(this,function(g){switch(g.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(E.default.fromCIMText(c,a))];b=[];if(d=a.text)for(e=d.length,l=0;l<e;l++)f=d.charCodeAt(l),b.push(f);a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim,b)];case 1:return k=g.sent().glyphMosaicItems,
n.ok(k,h)?[2,x.default.fromCIMText(c,a,k)]:[2,this._textError]}})})};e.prototype._createCIMFill=function(a,c){return f(this,void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:return a.cim.mosaicHash=a.materialHash,[4,this.getCIMMosaicItem(a.cim)];case 1:return b=d.sent().spriteMosaicItem,n.ok(b,h)?[2,r.default.fromCIMFill(c,a,b,!1)]:[2,this._fillError]}})})};e.prototype._createCIMLine=function(a,c){return f(this,void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:if("function"===
typeof a.materialHash)return[2,m.resolve(C.default.fromCIMLine(c,a))];a.cim.mosaicHash=a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return b=d.sent().spriteMosaicItem,n.ok(b,h)?[2,w.default.fromCIMLine(c,a,b,!1,this._joinOnUTurn)]:[2,this._lineError]}})})};e.prototype._createCIMMarker=function(a,c){return f(this,void 0,void 0,function(){var b;return g(this,function(d){switch(d.label){case 0:if("function"===typeof a.materialHash)return[2,m.resolve(D.default.fromCIMMarker(c,a))];a.cim.mosaicHash=
a.materialHash;return[4,this.getCIMMosaicItem(a.cim)];case 1:return b=d.sent().spriteMosaicItem,n.ok(b,h)?[2,t.default.fromCIMMarker(c,a,b)]:[2,this._markerError]}})})};e.prototype._createCIM=function(a,c){return f(this,void 0,void 0,function(){var b,d,e=this;return g(this,function(f){b=a.templateHash;if(this._cimTemplateCache.has(b))return[2,this._cimTemplateCache.get(b)];switch(a.type){case "marker":d=this._createCIMMarker(a,c);break;case "line":d=this._createCIMLine(a,c);break;case "fill":d=this._createCIMFill(a,
c);break;case "text":d=this._createCIMText(a,c)}d.then(function(a){return e._cimTemplateCache.set(b,a)});return[2,d]})})};e.prototype._createMeshTemplates=function(a,c,b,d){if(-1!==c.type.indexOf("3d"))return h.error("3D symbols are not supported with MapView"),a;switch(c.type){case "cim":return h.error(v("mapview-bad-type","Found a cim type not yet expanded")),a;case "expanded-cim":d=0;for(c=c.layers;d<c.length;d++)k(a,this._createCIM(c[d],b));return a;case "simple-marker":return k(a,this._createSMS(c,
b));case "picture-marker":return k(a,this._createPMS(c,b));case "simple-fill":return k(a,this._createSFS(c,b,d)),c.outline&&k(a,this._createSLS(c.outline,b,!0)),a;case "picture-fill":return k(a,this._createPFS(c,b,d)),c.outline&&k(a,this._createSLS(c.outline,b,!0)),a;case "simple-line":return k(a,this._createSLS(c,b,!1));case "text":return k(a,this._createTS(c,b));default:return h.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),a}};return e}();p.WGLTemplateStore=
u});