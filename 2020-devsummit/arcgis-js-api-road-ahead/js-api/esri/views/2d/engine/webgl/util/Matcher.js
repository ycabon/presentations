// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/support/cimSymbolUtils ../../../arcade/utils".split(" "),function(h,r,w,t,n,H,I,m,J,B,C,v,D){function K(f,b){return n(this,void 0,
void 0,function(){var a,e;return t(this,function(c){switch(c.label){case 0:return a=f||1,"number"===typeof a?[2,function(c,e,b){return a}]:[4,C.createRendererExpression(a,b.spatialReference,b.fields)];case 1:return e=c.sent(),[2,function(a,c,f){return D.callWithFeature(e,a,{$view:f},b.geometryType,c)||1}]}})})}Object.defineProperty(r,"__esModule",{value:!0});var E=m.getLogger("esri/views/2d/engine/webgl/util/Matcher");h=function(){function f(){this._defaultResult=null}f.fromBasicRenderer=function(b,
a,e){return n(this,void 0,void 0,function(){var c,d,g;return t(this,function(A){switch(A.label){case 0:return[4,v.expandSymbols(b.getSymbols(),b,e)];case 1:return c=A.sent(),d=new f,c.length?[4,a.createTemplateGroup(c[0],null,b)]:[3,3];case 2:g=A.sent(),d.setDefault(g),A.label=3;case 3:return[2,d]}})})};f.prototype.size=function(){return 1};f.prototype.getDefault=function(){return this._defaultResult};f.prototype.setDefault=function(b){this._defaultResult=b};f.prototype.match=function(b,a,e,c,d){return this.getDefault()};
f.prototype.analyze=function(b,a,e,c,d){return n(this,void 0,void 0,function(){return t(this,function(a){return[2]})})};return f}();r.FeatureMatcher=h;m=function(f){function b(a,e,c,d){var g=f.call(this)||this;g._intervals=[];g._isMaxInclusive=e;d?g._getValue=D.callWithFeature.bind(null,d):a&&a.length?"function"===typeof a?(g._field=null,g._getValue=a):(g._field=a,g._normalizationInfo=c,g._getValue=g._getValueFromField.bind(g)):g._field=null;return g}w(b,f);b.fromCBRenderer=function(a,e,c){return n(this,
void 0,void 0,function(){var d,g,f,F,y,G,z,q,h,p,u,l,x,m=this;return t(this,function(k){switch(k.label){case 0:return d=a.isMaxInclusive,g=a.normalizationField,f=a.normalizationTotal,F=a.normalizationType,y=a.field,G={normalizationField:g,normalizationTotal:f,normalizationType:F},(h=z=a.valueExpression)?[4,C.createRendererExpression(z,c.spatialReference,c.fields)]:[3,2];case 1:h=k.sent(),k.label=2;case 2:return q=h,p=new b(y,d,G,q),[4,v.expandSymbol(a.backgroundFillSymbol,a,c)];case 3:return u=k.sent(),
[4,B.all(a.classBreakInfos.map(function(d){return n(m,void 0,void 0,function(){var g,b,f;return t(this,function(k){switch(k.label){case 0:return[4,v.expandSymbol(d.symbol,a,c)];case 1:return g=k.sent(),[4,e.createTemplateGroup(g,u,a)];case 2:return b=k.sent(),f={min:d.minValue,max:d.maxValue},p.add(f,b),[2]}})})}))];case 4:return k.sent(),[4,v.expandSymbol(a.defaultSymbol,a,c)];case 5:return(l=k.sent())?[4,e.createTemplateGroup(l,u,a)]:[3,7];case 6:x=k.sent(),p.setDefault(x),k.label=7;case 7:return[2,
p]}})})};b.prototype.add=function(a,e){this._intervals.push({interval:a,result:e});this._intervals.sort(function(a,e){return a.interval.min-e.interval.min})};b.prototype.size=function(){return f.prototype.size.call(this)+this._intervals.length};b.prototype.match=function(a,e,c,d,g){if(!this._getValue)return this.getDefault();a=this._getValue(e,{$view:g},c,d);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(e=0;e<this._intervals.length;e++)if(d=this._intervals[e],c=d.interval,d=
d.result,g=this._isMaxInclusive?a<=c.max:a<c.max,a>=c.min&&g)return d;return this.getDefault()};b.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};b.prototype._getValueFromField=function(a){var e=a.attributes[this._field];if(!this._needsNormalization())return e;var c=this._normalizationInfo,d=c.normalizationField,g=c.normalizationTotal,c=c.normalizationType;a=!!d&&a.attributes[d];if(c)switch(c){case "field":return(a||
void 0)&&e/a;case "log":return Math.log(e)*Math.LOG10E;case "percent-of-total":return e/g*100;default:E.error("Found unknown normalization type: "+c)}else E.error("Normalization is required, but no type was set!")};return b}(h);r.IntervalMatcher=m;m=function(f){function b(a,e,c){var d=f.call(this)||this;d._nullResult=null;d._resultsMap=new Map;c?d._getValue=D.callWithFeature.bind(null,c):a&&a.length?"function"===typeof a[0]?(d._fields=null,d._getValue=a[0]):(d._fields=a,d._seperator=e||"",d._getValue=
d._getValueFromFields.bind(d)):d._fields=null;return d}w(b,f);b.fromUVRenderer=function(a,e,c){return n(this,void 0,void 0,function(){var d,g,f,h,y,m,z,q,r,p,u=this;return t(this,function(l){switch(l.label){case 0:return d=a.uniqueValueInfos,g=a.fieldDelimiter,f=[a.field],h=a.valueExpression,a.field2&&f.push(a.field2),a.field3&&f.push(a.field3),[4,v.expandSymbol(a.backgroundFillSymbol,a,c)];case 1:return y=l.sent(),(z=h)?[4,C.createRendererExpression(h,c.spatialReference,c.fields)]:[3,3];case 2:z=
l.sent(),l.label=3;case 3:return m=z,q=new b(f,g,m),[4,B.all(d.map(function(d){return n(u,void 0,void 0,function(){var g,b;return t(this,function(f){switch(f.label){case 0:return[4,v.expandSymbol(d.symbol,a,c)];case 1:return g=f.sent(),[4,e.createTemplateGroup(g,y,a)];case 2:return b=f.sent(),"\x3cNull\x3e"===d.value?q.setNullResult(b):q.add(d.value,b),[2]}})})}))];case 4:return l.sent(),[4,v.expandSymbol(a.defaultSymbol,a,c)];case 5:return(r=l.sent())?[4,e.createTemplateGroup(a.defaultSymbol,y,a)]:
[3,7];case 6:p=l.sent(),q.setDefault(p),l.label=7;case 7:return[2,q]}})})};b.prototype.setNullResult=function(a){this._nullResult=a};b.prototype.add=function(a,e){this._resultsMap.set(a.toString(),e)};b.prototype.size=function(){return f.prototype.size.call(this)+this._resultsMap.size};b.prototype.match=function(a,e,c,d,b){if(!this._getValue)return this.getDefault();a=this._getValue(e,{$view:b},c,d);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(!a&&null==
a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};b.prototype._getValueFromFields=function(a){for(var e=[],c=0,d=this._fields;c<d.length;c++)e.push(a.attributes[d[c]]);return e.join(this._seperator)};return b}(h);r.MapMatcher=m;m=function(f){function b(a,e,c,d){var b=f.call(this)||this;b._fidToAttributeHash=new Map;b._attributeHashToGroup=new Map;b._renderer=a;b._fieldMap=a.fieldMap;b._templates=e;b._info=c;b._scaleFn=d;return b}w(b,
f);b.fromDictionaryRenderer=function(a,e,c){return n(this,void 0,void 0,function(){var d;return t(this,function(f){switch(f.label){case 0:return a.fetchResources({spatialReference:c.spatialReference,fields:c.fields}),[4,K(a.scaleExpression,c)];case 1:return d=f.sent(),[2,new b(a,e,c,d)]}})})};b.prototype._analyzeFeature=function(a,b,c,d,f){return n(this,void 0,void 0,function(){var e,g,h,m,n,q,r,p,u,l,x,w;return t(this,function(k){switch(k.label){case 0:e=a.attributes[b];g=this._fidToAttributeHash.get(e);
h=this._hashAttributes(a);if(g===h)return[2];this._fidToAttributeHash.set(e,h);if(m=this._attributeHashToGroup.has(h))return[3,5];n=H({},d,{spatialReference:this._info.spatialReference,abortOptions:f,fields:this._info.fields});return[4,this._scaleFn(a,c,d)];case 1:return q=k.sent(),[4,this._renderer.getSymbolAsync(a,n)];case 2:return r=k.sent(),[4,v.expandSymbol(r,this._renderer,this._info,f)];case 3:p=k.sent();if("expanded-cim"!==p.type)return E.error(new I("mapview-bad-type","Found unexpected type "+
p.type+" in dictionary response")),[2];u=0;for(l=p.layers;u<l.length;u++)x=l[u],x.scaleFactor=q,x.templateHash+="-"+q;return[4,this._templates.createTemplateGroup(p,null,this._renderer)];case 4:w=k.sent(),this._attributeHashToGroup.set(h,w),k.label=5;case 5:return[2]}})})};b.prototype.analyze=function(a,b,c,d,f){return n(this,void 0,void 0,function(){var e,g=this;return t(this,function(h){switch(h.label){case 0:return e=b.map(function(b){return g._analyzeFeature(b,a,c,d,f)}),[4,B.all(e)];case 1:return h.sent(),
[2]}})})};b.prototype.match=function(a,b){a=this._fidToAttributeHash.get(b.attributes[a]);return this._attributeHashToGroup.get(a)};b.prototype._hashAttributes=function(a){var b="",c;for(c in this._fieldMap)b+=". "+a.attributes[this._fieldMap[c]];return b};return b}(h);r.DictionaryMatcher=m;h=function(f){function b(a){var b=f.call(this)||this;b._templates=a;return b}w(b,f);b.prototype.match=function(a,b){return J.isNone(b.symbol)?0:b.groupId?b.groupId:this._templates.createTemplateGroup(b.symbol,
null,null)};return b}(h);r.GraphicMatcher=h});