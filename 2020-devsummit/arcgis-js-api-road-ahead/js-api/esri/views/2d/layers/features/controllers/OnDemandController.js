// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/ArrayPool ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/now ../../../../../core/promiseUtils ../../../../../core/watchUtils ../../../../../core/workers ../../../../../core/accessorSupport/decorators ../../../../../geometry/Extent ../../../../../geometry/support/jsonUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../tasks/operations/query ../../../../../tasks/support/QuantizationParameters ../../../engine ./BaseController ./EditsQueue ../support/DataTile ../support/DataTileFeaturesIndex ../support/Tile ../support/TileUpdateQueue ../../../tiling/TileQueue".split(" "),
function(p,M,S,x,A,r,k,T,U,C,V,N,B,E,W,w,X,O,D,P,Y,Z,F,aa,G,ba,H,ca,Q){Object.defineProperty(M,"__esModule",{value:!0});var I=V.getLogger("esri.views.2d.layers.features.controllers.OnDemandController");p=C("esri-featurelayer-webgl");C=C("esri-mobile");var J=p&&"object"===typeof p&&null!=p.maxDrillLevel?p.maxDrillLevel:C?1:4,R=p&&"object"===typeof p&&null!=p.maxRecordCountFactor?p.maxRecordCountFactor:C?1:3,da=p&&"object"===typeof p&&null!=p.enablePBFQuery?p.enablePBFQuery:!0,K=new Set,z=[],ea=function(){function g(c,
a){this.objectIdField=a;this.client=W.openWithPorts(c)}g.prototype.destroy=function(){this.client.close();this.client=null};g.prototype.executeQuery=function(c,a){return k(this,void 0,void 0,function(){var b;return r(this,function(d){switch(d.label){case 0:return[4,this.client.invoke("queryFeatures",c.toJSON(),a)];case 1:return b=d.sent(),[2,D.convertFromFeatureSet(b,this.objectIdField)]}})})};return g}(),fa=function(){function g(c,a){this.source=c;this.sourceSpatialReference=a}g.prototype.destroy=
function(){};g.prototype.executeQuery=function(c,a){return k(this,void 0,void 0,function(){var b;return r(this,function(d){switch(d.label){case 0:return[4,P.executeQueryPBF(this.source,c,{type:"optimized",sourceSpatialReference:this.sourceSpatialReference},a)];case 1:return b=d.sent().data,[2,b]}})})};return g}(),ga=function(){function g(c,a,b){this.source=c;this.objectIdField=a;this.sourceSpatialReference=b}g.prototype.destroy=function(){};g.prototype.executeQuery=function(c,a){return k(this,void 0,
void 0,function(){var b;return r(this,function(d){switch(d.label){case 0:return[4,P.executeQuery(this.source,c,this.sourceSpatialReference,a)];case 1:return b=d.sent().data,[2,D.convertFromFeatureSet(b,this.objectIdField)]}})})};return g}();F=function(g){function c(){var a=null!==g&&g.apply(this,arguments)||this;a.type="on-demand";a._queryInfoHash=null;a._dataTileIndex=new ba.default;a._editsQueue=new aa.EditsQueue({processEdits:a._processEdits.bind(a)});a._featuresInFlight=new Map;a.service=null;
return a}S(c,g);c.prototype.initialize=function(){var a=this,b=this._createFeatureStore();b.onFeatureAdd=this.onFeatureAdd.bind(this);b.onFeatureRemove=this.onFeatureRemove.bind(this);this._set("featureStore",b);this._dataTileIndex.featureStore=this.featureStore;this._dataTileIndex.forEach(function(a){return a.done=!1});this._fetchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(b,d){return k(a,void 0,void 0,function(){var a;return r(this,
function(f){switch(f.label){case 0:return[4,this._fetchTile(b,this.queryInfo,d)];case 1:return a=f.sent(),this._handleResponse(b,a),[2,a]}})})}});this._patchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(b,d){return a._fetchTile(b.dataTile,b.queryInfo,d)}});this._updateQueue=new ca.default({tileInfoView:this.tileStore.tileScheme,process:function(b,d,f){return a._updateTile(b,d,f)}});var d=this.service,b=d.capabilities,f=d.source,c=d.objectIdField,
d=d.spatialReference;Array.isArray(f)?this.sourceAdapter=new ea(f,c):this.sourceAdapter=da&&b.query.supportsFormatPBF?new fa(f,d):new ga(f,c,d);this.handles.add([this.watch("updating",function(b){return!b&&a.onIdle()})]);this.featureStore.events.on("valueRangesChanged",function(b){a.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:b.valueRanges}})})};c.prototype.destroy=function(){this._fetchQueue.clear();this._patchQueue.clear();this._updateQueue.clear();this._editsQueue.destroy();
this.queryEngine.destroy();this.sourceAdapter.destroy()};Object.defineProperty(c.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0});c.prototype.update=function(a,b){return k(this,void 0,void 0,function(){var d,
f,c,l,t,L,u=this;return r(this,function(e){switch(e.label){case 0:return this.validateConfig(a),d=JSON.stringify(this.config.filters),f=this.renderer.getAttributeHash(),c=a.availableFields.filter(function(a){return-1===u.availableFields.indexOf(a)}),l=this.config.definitionExpression,this._set("config",a),l!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];case 1:return e.sent(),t=d!==JSON.stringify(a.filters),L=f!==
this.renderer.getAttributeHash(),b?L?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:e.sent(),e.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return e.sent(),[4,this.featureStore.update(t,a)];case 5:return e.sent(),this.refresh(),[2];case 6:return c.length?[4,this._handleAttributeChange(c)]:[3,8];case 7:e.sent(),e.label=8;case 8:return"heatmap"===this.renderer.type?[2]:L?[4,this.attributeStore.setAttributeBindings(this.renderer,
this.arcadeInfo)]:[3,10];case 9:e.sent(),this.featureStore.forEach(function(a){return u.attributeStore.setAttributeData(a.localId,a,u.geometryInfo,u.viewParams)}),e.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return e.sent(),[4,this.featureStore.update(t,a)];case 12:return e.sent(),[4,this.attributeStore.sendUpdates()];case 13:return e.sent(),[2]}})})};c.prototype.invalidate=function(){return k(this,void 0,void 0,function(){var a,b,d;return r(this,function(f){a=0;for(b=
this.tileStore.tiles;a<b.length;a++)d=b[a],this._updateQueue.push(d.id,Date.now());return[2]})})};c.prototype.onIdle=function(){this.featureStore.sweepClusters()};c.prototype.onEdits=function(a){var b=this;this._fetchQueue.pause();this._fetchQueue.reset();return this._editsQueue.push(a).then(function(){b._editsQueue.updating||b._fetchQueue.resume()})};c.prototype.queryFeatures=function(a){return this.queryEngine.executeQuery(a)};c.prototype.queryFeatureCount=function(a){return this.queryEngine.executeQueryForCount(a)};
c.prototype.queryObjectIds=function(a){return this.queryEngine.executeQueryForIds(a)};c.prototype.queryExtent=function(a){return this.queryEngine.executeQueryForExtent(a)};c.prototype.queryStatistics=function(){return k(this,void 0,void 0,function(){var a,b,d,f=this;return r(this,function(c){switch(c.label){case 0:return d=b=a=0,[4,B.all(this.tileStore.tiles.map(function(c){return k(f,void 0,void 0,function(){var f,h,l,e,q,m,n,v,y,k,g;return r(this,function(t){switch(t.label){case 0:return f=this.queryInfo,
h=f.returnCentroid,l=f.returnGeometry,e=this._pixelBuffer,q={pixelBuffer:e,returnGeometry:l,returnCentroid:h,returnOutline:this.returnOutline},m=N(),[4,this.featureStore.executeTileQuery(c,this.spatialReference,q)];case 1:n=t.sent().features;v=N();d+=v-m;a+=n.length;y=0;for(k=n;y<k.length;y++)g=k[y],g.geometry&&(O.isPolygon(g.geometry)?b+=g.geometry.rings.reduce(function(a,b){return a+b.length},0):O.isPolyline(g.geometry)&&(b+=g.geometry.paths.reduce(function(a,b){return a+b.length},0)));return[2]}})})}))];
case 1:return c.sent(),[2,A({},this.featureStore.storeStatistics,{displayedFeatureCount:a,displayedVertexCount:b,displayPreProcessTime:d})]}})})};c.prototype.refresh=function(){return k(this,void 0,void 0,function(){var a=this;return r(this,function(b){switch(b.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),this._updateQueue.clear(),[4,E.whenFalseOnce(this._fetchQueue,
"updating")];case 1:return b.sent(),[4,E.whenFalseOnce(this._updateQueue,"updating")];case 2:return b.sent(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,E.whenFalseOnce(this._fetchQueue,"updating")];case 3:return b.sent(),this.featureStore.sweep(),this.featureStore.forEach(function(b){return a.attributeStore.setAttributeData(b.localId,b,a.geometryInfo,a.viewParams)}),this.attributeStore.sendUpdates(),this._updateQueue.resume(),
[2]}})})};c.prototype.setViewState=function(a){var b=this,d=this.viewState&&this.viewState.scale;this.inherited(arguments);this._fetchQueue.state=a;this._updateQueue.state=a;d!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach(function(a){return b.attributeStore.setAttributeData(a.localId,a,b.geometryInfo,b.viewParams)}),this.attributeStore.sendUpdates())};c.prototype.getAggregate=function(a){return this.featureStore.getAggregate(a)};c.prototype.getAggregateValueRanges=
function(){return this.featureStore.getAggregateValueRanges()};c.prototype.onTileUpdate=function(a){this._manageTiles(a.added,a.removed);this.featureStore.onTileUpdate(a)};c.prototype.onFeatureAdd=function(a){if(this._featuresInFlight.has(a.objectId)){var b=this._featuresInFlight.get(a.objectId).attributes;a.attributes=A({},b,a.attributes);this._featuresInFlight.delete(a.objectId)}a.localId=this.attributeStore.createLocalId(a.objectId);this.attributeStore.setAttributeData(a.localId,a,this.geometryInfo,
this.viewParams)};c.prototype._handleAttributeChange=function(a){return k(this,void 0,void 0,function(){return r(this,function(b){switch(b.label){case 0:return[4,this._fetchChangedFields(a)];case 1:return b.sent(),[2]}})})};c.prototype._fetchChangedTileFields=function(a,b){return k(this,void 0,void 0,function(){var d;return r(this,function(f){return(d=this._dataTileIndex.get(a.id))?[2,this._fetchChangedTileFieldsDrill(d,b)]:[2]})})};c.prototype._fetchChangedTileFieldsDrill=function(a,b,d){void 0===
d&&(d=0);return k(this,void 0,void 0,function(){var f,c,l,t,k,u,e,q,m,n,g=this;return r(this,function(h){switch(h.label){case 0:return f=A({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:b.concat([this.service.objectIdField])}),a.returnExceeded=a.returnExceeded||d>=J,c=a.key,l={key:c,dataTile:a,queryInfo:f},[4,this._patchQueue.push(l)];case 1:t=h.sent();if(!(t.exceededTransferLimit&&d<J))return[3,3];k=a.tile.createChildTiles();u=k.map(function(b){var d=new G.default;d.tile=b;d.displayTile=
a.displayTile;return d});return[4,B.all(u.map(function(a){return g._fetchChangedTileFieldsDrill(a,b,d+1)}))];case 2:return h.sent(),[2];case 3:e=0;for(q=t.features;e<q.length;e++)m=q[e],this.featureStore.has(m.objectId)?(n=this.featureStore.getFeature(m.objectId),n.attributes=A({},n.attributes,m.attributes)):this._featuresInFlight.set(m.objectId,m);return[2]}})})};c.prototype._fetchChangedTileFieldsPaged=function(a,b,d){void 0===d&&(d=0);return k(this,void 0,void 0,function(){var f,c,l,t,k,g,e,q,
m,n,v;return r(this,function(h){switch(h.label){case 0:return f=this.service.capabilities.query.supportsMaxRecordCountFactor,c=this.service.tileMaxRecordCount,l=c*(f?1:R),t=A({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:b.concat([this.service.objectIdField]),resultOffset:d*l,num:l}),a.returnExceeded=!0,k=a.key,g={key:k,dataTile:a,queryInfo:t},[4,this._patchQueue.push(g)];case 1:e=h.sent();q=0;for(m=e.features;q<m.length;q++)n=m[q],this.featureStore.has(n.objectId)?(v=this.featureStore.getFeature(n.objectId),
v.attributes=A({},v.attributes,n.attributes)):this._featuresInFlight.set(n.objectId,n);return e.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(a,b,d+1)]:[2]}})})};c.prototype._fetchChangedFields=function(a){return k(this,void 0,void 0,function(){var b,d,c=this;return r(this,function(f){switch(f.label){case 0:return b=this.tileStore.tiles,d=b.map(function(b){return c._fetchChangedTileFields(b,a)}),[4,B.all(d)];case 1:return f.sent(),[2]}})})};c.prototype._manageTiles=function(a,b){void 0===
b&&(b=null);for(var d=this._dataTileIndex,c=this._fetchQueue,h=this._updateQueue,l="esriGeometryPoint"===this.service.geometryType,t=function(a){var b=d.get(a.id);b?(b.displayTile=a,l?d.forEach(function(d){H.isChildOf(d,b)&&(d.displayTile=a)}):b.done=!1):(b=new G.default,b.tile=a.clone(),b.displayTile=a,d.add(b));k._processDataTile(b)},k=this,g=0;g<a.length;g++){var e=a[g];t(e)}if(b)for(a=0;a<b.length;a++)e=b[a],K.add(e),h.abort(e.id);d.forEach(function(a){K.has(a.displayTile)&&z.push(a)});for(h=
0;h<z.length;h++)e=z[h],c.abort(e.id),d.delete(e);z.length=0;K.clear()};c.prototype._processDataTile=function(a){var b=this,d=a.key,c=this._fetchQueue,h=d.id,l=this._queryInfoHash,d=d.level-a.displayTile.key.level>=J;this._dataTileIndex.add(a);if(a.done||c.has(h)){if(a.queryInfoHash!==l||a.returnExceeded!==d)if(a.done)a.done=!1;else if(c.isOngoing(h))c.abort(h);else{a.queryInfoHash=l;a.returnExceeded=d;return}}else a.queryInfoHash=l,a.returnExceeded=d;a.done?this._invalidateTile(a.displayTile):c.has(h)||
c.push(a).catch(function(d){B.isAbortError(d)||I.error(new U("featurelayer-controller:tile-error","Encountered an error when handling tile response",d));a.done=!0;b._invalidateTile(a.displayTile)})};c.prototype._handleResponse=function(a,b){a.done=!0;D.hydrateOptimizedFeatureSet(b);if(b.exceededTransferLimit)if(a.returnExceeded)this._dataTileIndex.setTileFeatures(a,b.features),this._deleteChildrenDataTiles(a);else{b=a.tile.createChildTiles();for(var d=0;d<b.length;d++){var c=b[d],h=new G.default;
h.tile=c;h.displayTile=a.displayTile;this._processDataTile(h)}T.release(b)}else this._dataTileIndex.setTileFeatures(a,b.features),this._deleteChildrenDataTiles(a);this._invalidateTile(a.tile)};c.prototype._deleteChildrenDataTiles=function(a){this._dataTileIndex.forEach(function(b){H.isChildOf(b,a)&&z.push(b)});for(var b=0;b<z.length;b++){var d=z[b];this._fetchQueue.abort(d.id);this._dataTileIndex.delete(d)}z.length=0};c.prototype._createQuery=function(a,b,d,c,h,l){var f=this.service.geometryType;
c=this._createDefaultQuery(c);c.maxRecordCountFactor=h;c.returnExceededLimitFeatures=l;c.resultType="tile";c.geometry=a;if(this.service.capabilities.query.supportsQuantization)c.quantizationParameters=new Y.default({mode:"view",originPosition:"upper-left",tolerance:d,extent:b}),"esriGeometryPolyline"===f&&(c.maxAllowableOffset=d);else if("esriGeometryPolyline"===f||"esriGeometryPolygon"===f)c.maxAllowableOffset=d;return c};c.prototype._fetchTile=function(a,b,c){return k(this,void 0,void 0,function(){var d,
h,l,g,k,u,e,q,m,n,v;return r(this,function(f){switch(f.label){case 0:return d=new X({xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}),h=this.service.geometryType,l="esriGeometryPoint"===h?a.tile:a.displayTile,g=l.extent,k=l.resolution,u=a.returnExceeded,e=this._createQuery(d,g,k,b,R,u),[4,this.sourceAdapter.executeQuery(e,c)];case 1:q=f.sent();if(q.transform&&"esriGeometryPolygon"===h)for(m=0,n=q.features;m<n.length;m++)v=n[m],v.geometry=
D.removeCollinearVectices(v.geometry,v.geometry,h,!1,!1);return[2,q]}})})};c.prototype._invalidateTile=function(a){var b=this._updateQueue,c=0;for(a=this.tileStore.intersections(a,this._pixelBuffer);c<a.length;c++){var f=a[c].tile;b.push(f.id,f.updateTimestamp)}};c.prototype._updateTile=function(a,b,c){return k(this,void 0,void 0,function(){var d,h,g,k,p,u,e,q,m,n,v,y,w=this;return r(this,function(f){switch(f.label){case 0:return d=this.tileStore.get(a),h=this.queryInfo,g=h.returnCentroid,k=h.returnGeometry,
p=this._pixelBuffer,u={pixelBuffer:p,returnGeometry:k,returnCentroid:g,returnOutline:this.returnOutline},[4,this.featureStore.executeTileQuery(d,this.spatialReference,u)];case 1:return e=f.sent(),q=e.features,m=e.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return f.sent(),n={geometryType:this.service.geometryType,features:q,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:d.transform},v=[],y=!0,this._dataTileIndex.forEach(function(a){d.id!==a.id&&H.isChildOf(a,
d)&&y&&!a.done&&(y=!1)}),y&&d&&d.objectIds.forEach(function(a){m.has(a)||(a=w.attributeStore.getLocalId(a),v.push(a))}),m.forEach(function(a){d.objectIds.add(a)}),d.updateTimestamp=b,[2,this.processor.onTileData(d,{clear:!0,addOrUpdate:n.features,remove:v,transformParams:Z.Utils.getTransformParams(n)},c).catch(function(a){B.isAbortError(a)||I.error("update-tile",a)})]}})})};c.prototype._processEdits=function(a,b,c){return k(this,void 0,void 0,function(){var d,h,g,t,p,u=this;return r(this,function(e){switch(e.label){case 0:return d=
this._createTempQueryEngine(),h=this._createObjectIdsQuery(a),a.length?[4,this.sourceAdapter.executeQuery(h)]:[3,2];case 1:g=e.sent(),D.hydrateOptimizedFeatureSet(g),this._dataTileIndex.addOrUpdateFeatures(g.features),d.featureStore.addMany(g.features),e.label=2;case 2:return t=b.concat(a).map(function(a){return u.attributeStore.getLocalId(a)}),this._dataTileIndex.deleteFeaturesById(b),this.attributeStore.sendUpdates(),p=A({},this.queryInfo,{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),
this.tileStore.tiles.map(function(a){return k(u,void 0,void 0,function(){var b,e;return r(this,function(f){switch(f.label){case 0:return[4,d.featureStore.executeTileQuery(a,this.spatialReference,p)];case 1:return b=f.sent().features,e={transform:a.transform,hasZ:!1,hasM:!1},[2,this.processor.onTileData(a,{addOrUpdate:b,remove:t,transformParams:e},c).catch(function(a){B.isAbortError(a)||I.error("update-tile",a)})]}})})}),d.destroy(),[2]}})})};c.prototype._createObjectIdsQuery=function(a){var b=this._createDefaultQuery(this.queryInfo);
b.objectIds=a;return b};x([w.property()],c.prototype,"_fetchQueue",void 0);x([w.property()],c.prototype,"_patchQueue",void 0);x([w.property()],c.prototype,"_updateQueue",void 0);x([w.property()],c.prototype,"_editsQueue",void 0);x([w.property({readOnly:!0})],c.prototype,"featureStore",void 0);x([w.property({constructOnly:!0})],c.prototype,"service",void 0);x([w.property()],c.prototype,"sourceAdapter",void 0);x([w.property({readOnly:!0,dependsOn:["featureStore","service"]})],c.prototype,"queryEngine",
null);x([w.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],c.prototype,"updating",null);return c=x([w.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],c)}(w.declared(F.default));M.default=F});