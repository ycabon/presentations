// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Error ../../../../../core/has ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/executeTileQuery ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/graphics/data/projectionSupport ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/GeoEventConnection ./BaseController ./support/DispatchQueue".split(" "),
function(n,p,A,h,N,l,m,q,O,B,k,t,f,C,D,E,r,F,G,H,I){Object.defineProperty(p,"__esModule",{value:!0});var J=function(){function c(a,b){this.store=a;this.onUpdate=b}c.prototype.add=function(a){this.store.add(a)};c.prototype.forEach=function(a){this.store.forEach(a)};c.prototype.removeById=function(a){return this.store.removeById(a)};c.prototype.update=function(a,b){this.onUpdate(a,b)};Object.defineProperty(c.prototype,"size",{get:function(){return this.store.numFeatures},enumerable:!0,configurable:!0});
return c}();n=function(c){function a(){var b=null!==c&&c.apply(this,arguments)||this;b.type="stream";b._tileDispatchMap=new Map;b._updateIntervalId=0;return b}A(a,c);a.prototype.initialize=function(){var b=this,a=this.service,d=a.source,g=a.objectIdField,K=a.timeInfo,L=a.purgeOptions,M=a.serviceFilter,c=a.geometryType,a=a.spatialReference;this._set("store",new E.default(this.geometryInfo));this._set("streamFeatureManager",new F.default(new J(this.store,function(a,e){return b._onUpdate(a,e)}),g,K,
L));d&&(this.connection=new G.default(d,a,this.spatialReference,c,M),this.connection.on("feature",function(a){return b._onFeature(a)}));["connectionStatus","errorString"].forEach(function(a){b.watch("connection."+a,function(e){return b.remoteClient.invoke("setProperty",{propertyName:a,value:e})})});this._updateIntervalId=setInterval(function(){return b.streamFeatureManager.checkForUpdates()},64);this._shouldPushDataReceived=this.service.enableDataReceived};a.prototype.startup=function(){return t.all([this.inherited(arguments),
r.checkProjectionSupport(this.service.spatialReference,this.spatialReference)]).then(function(){})};a.prototype.destroy=function(){clearInterval(this._updateIntervalId);this.connection&&this.connection.destroy();this.queryEngine.destroy();this._tileDispatchMap.forEach(function(b){return b.destroy()})};Object.defineProperty(a.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.store)},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return this._tempQueryEngine&&
!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0});a.prototype.update=function(b){return m(this,void 0,void 0,function(){var a,d,g=this;return l(this,function(e){switch(e.label){case 0:return this.validateConfig(b),a=this.renderer.getAttributeHash(),this._set("config",b),[4,this.updatePixelBuffer()];case 1:e.sent();if("heatmap"===this.renderer.type)return[2];if(a===this.renderer.getAttributeHash())return[3,3];d=this.queryEngine.featureStore;
return[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)];case 2:e.sent(),d.forEach(function(b){return g.attributeStore.setAttributeData(b.localId,b,g.geometryInfo,g.viewParams)}),e.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return e.sent(),[4,this.attributeStore.sendUpdates()];case 5:return e.sent(),[2]}})})};a.prototype.invalidate=function(){this._repushActiveTiles()};a.prototype.onEdits=function(){};a.prototype.queryFeatures=function(b){return this.queryEngine.executeQuery(b)};
a.prototype.queryFeatureCount=function(b){return this.queryEngine.executeQueryForCount(b)};a.prototype.queryObjectIds=function(b){return this.queryEngine.executeQueryForIds(b)};a.prototype.queryExtent=function(b){return this.queryEngine.executeQueryForExtent(b)};a.prototype.queryLatestObservations=function(b){return m(this,void 0,void 0,function(){return l(this,function(a){if(!this.service.timeInfo.trackIdField)throw q("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");
return[2,this.queryEngine.executeQueryForLatestObservations(b)]})})};a.prototype.queryStatistics=function(){throw q("Method not implemented.");};a.prototype.refresh=function(){};a.prototype.setViewState=function(){var b=this,a=this.viewState&&this.viewState.scale;this.inherited(arguments);a!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach(function(a){return b.attributeStore.setAttributeData(a.localId,a,b.geometryInfo,b.viewParams)}),this.attributeStore.sendUpdates())};
a.prototype.postFeature=function(b){try{var a=JSON.parse(b);a.geometry=r.project(a.geometry,this.spatialReference);this._onFeature(a)}catch(d){}};a.prototype.onTileUpdate=function(b){var a=this,d=b.added;b.removed.forEach(function(b){return a._handleTileRemove(b)});d.forEach(function(b){return a._handleTileAdd(b)})};a.prototype.enableEvent=function(b){"data-received"===b.name&&(this._shouldPushDataReceived=b.value)};a.prototype._onFeature=function(b){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",
{name:"data-received",event:{attributes:b.attributes,centroid:b.centroid,geometry:b.geometry}});try{var a=this.geometryInfo,d=C.convertFromFeature(b,a.geometryType,a.hasZ,a.hasM,this.service.objectIdField);this.streamFeatureManager.add(d)}catch(g){}};a.prototype._createStoreWithFeatures=function(b){if(k.isNone(b))return null;var a=this._createFeatureStore();a.addMany(b);return a};a.prototype._onUpdate=function(a,e){return m(this,void 0,void 0,function(){var b,g,c=this;return l(this,function(d){switch(d.label){case 0:return k.isSome(a)&&
a.forEach(function(a){return c.onFeatureAdd(a)}),b=this._createStoreWithFeatures(a),g=this._createStoreWithFeatures(e),this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?[4,this._updateActiveTiles(b,g)]:[3,2];case 1:return d.sent(),[3,3];case 2:this._repushActiveTiles(),d.label=3;case 3:return k.isSome(e)&&e.forEach(function(a){return c.onFeatureRemove(a)}),[2]}})})};a.prototype._handleTileAdd=function(a){if(this._tileDispatchMap.has(a.id)){var b=this._tileDispatchMap.get(a.id);
b.up()}else b=new I.default,this._tileDispatchMap.set(a.id,b);this._queryTileFeatures(a,!0,this.queryEngine)};a.prototype._handleTileRemove=function(a){this._tileDispatchMap.get(a.id).destroy();this._tileDispatchMap.delete(a.id)};a.prototype._anyUpdatesQueued=function(){return B.valuesOfMap(this._tileDispatchMap).some(function(a){return a.hasAction()})};a.prototype._updateActiveTiles=function(a,e){return m(this,void 0,void 0,function(){var b,c,f=this;return l(this,function(d){switch(d.label){case 0:return b=
k.applySome(a,function(a){return f._createQueryEngine(a)}),c=k.applySome(e,function(a){return f._createQueryEngine(a)}),[4,t.all(this.tileStore.tiles.map(function(a){return f._queryTileFeatures(a,!1,b,c)}))];case 1:return d.sent(),[2]}})})};a.prototype._repushActiveTiles=function(){for(var a=0,e=this.tileStore.tiles;a<e.length;a++)this._queryTileFeatures(e[a],!0,this.queryEngine)};a.prototype._queryTileFeatures=function(a,e,d,c){return m(this,void 0,void 0,function(){var b,f,g,h,n,u,p,q,r,x,v,y,w=
this;return l(this,function(z){switch(z.label){case 0:return b={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]}},f=this.queryInfo,g=f.returnCentroid,h=f.returnGeometry,n=this._pixelBuffer,u={returnCentroid:g,returnGeometry:h,pixelBuffer:n,returnOutline:this.returnOutline},p=this._tileDispatchMap.get(a.id),[4,k.applySome(d,function(b){return b.featureStore.executeTileQuery(a,w.spatialReference,u)})];case 1:return q=z.sent(),
r=k.mapOr(q,[],function(a){return a.features}),x=k.mapOr(c,[],function(b){return D.executeTileQueryForIds(b,a,u)}).map(function(a){return w.attributeStore.getLocalId(a)}),v=t.createResolver(),y=function(c){return m(w,void 0,void 0,function(){return l(this,function(d){switch(d.label){case 0:return[4,this.processor.onTileData(a,{addOrUpdate:r,remove:x,clear:e,transformParams:b},{signal:c})];case 1:return d.sent(),v.resolve(),[2]}})})},p.enqueue(y),[2,v.promise]}})})};h([f.property()],a.prototype,"connection",
void 0);h([f.property()],a.prototype,"service",void 0);h([f.property({readOnly:!0})],a.prototype,"store",void 0);h([f.property({readOnly:!0})],a.prototype,"streamFeatureManager",void 0);h([f.property({readOnly:!0,dependsOn:["store","service","config"]})],a.prototype,"queryEngine",null);h([f.property()],a.prototype,"updating",null);return a=h([f.subclass("esri.views.2d.layers.features.controllers.StreamController")],a)}(f.declared(H.default));p.default=n});