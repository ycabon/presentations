// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/MapPool ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../geometry/SpatialReference ../../../../../layers/support/LabelClass ../../../../../layers/support/labelFormatUtils ../../../../../renderers/support/jsonUtils ../../../engine ../../../arcade/utils ../../../engine/webgl/util/symbolUtils ../../../engine/webgl/util/vvFlagUtils ./BaseProcessor".split(" "),
function(w,x,D,h,V,n,t,fa,ga,W,y,N,k,l,O,X,Y,Z,u,aa,ba,ca,da){Object.defineProperty(x,"__esModule",{value:!0});var ea=W.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");w=function(z){function b(){var c=null!==z&&z.apply(this,arguments)||this;c._symbolToMosaicItemMap=new Map;c._visualSetPromises=new Map;c.type="symbol";return c}D(b,z);b.prototype.initialize=function(){this._factory=this._createFactory()};b.prototype.destroy=function(){this._visualSetPromises.clear();this._symbolToMosaicItemMap.clear();
this.notifyChange("updating")};Object.defineProperty(b.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelingInfo",{get:function(){return!this.config||N.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map(function(c){return X.fromJSON(c)})},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelClassInfos",{get:function(){var c=this;return this.labelingInfo?k.all(this.labelingInfo.map(function(a,
b){return t(c,void 0,void 0,function(){var c;return n(this,function(e){switch(e.label){case 0:return c={index:b,minScale:a.minScale,maxScale:a.maxScale},[4,Y.createLabelFunction(a,this.service.fields,this.spatialReference)];case 1:return[2,(c.builder=e.sent(),c.symbol=a.symbol,c)]}})})})):k.resolve()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hydrate",{get:function(){return aa.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"renderer",{get:function(){return this.config?Z.fromJSON(this.config.renderer):null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._visualSetPromises.size},enumerable:!0,configurable:!0});b.prototype.update=function(c){return t(this,void 0,void 0,function(){var a;return n(this,function(b){a=this._getMeshHash();this._set("config",c);a!==this._getMeshHash()?this._factory=this._createFactory():this._factory.update(this.labelingInfo,this.renderer,
this.tileStore.tileScheme.tileInfo);return[2]})})};b.prototype.onTileData=function(c,a,b){var d=this,e=a.addOrUpdate,p=a.remove,q=a.clear;a=e&&e.length?this._processFeatures(c,e,a.transformParams):k.resolve();var m=b.signal;a=a.then(function(a){return d.remoteClient.invoke("tileRenderer.onTileData",{tileKey:c.id,data:{addOrUpdate:a&&a.message||null,remove:p,clear:q}},{transferList:a&&a.transferList||null,signal:m})}).catch(function(a){return d._handleError(c,a,b)});this._visualSetPromises.set(c,a);
k.always(a,function(){return d._cleanPromise(c)});this.notifyChange("updating");return a};b.prototype.onTileError=function(c,a,b){var d=this;a=this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:c.id,error:a},{signal:b.signal});this._visualSetPromises.set(c,a);k.always(a,function(){return d._cleanPromise(c)});this.notifyChange("updating");return a};b.prototype._getMeshHash=function(){var c=ca.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+
"."+c};b.prototype._createFactory=function(){var c=this,a=this.service,b=a.geometryType,d=a.objectIdField,a=a.fields,e=O.fromJSON(this.spatialReference),a={geometryType:b,fields:a,spatialReference:e},e=new u.WGLTemplateStore(function(a,b){return c.remoteClient.invoke("tileRenderer.getMaterialItems",a,b)},!1),g=this.tileStore.tileScheme.tileInfo;this._matcher=u.createMatcher(e,a,this.renderer);return new u.WGLMeshFactory(b,d,this.renderer,e,this.labelingInfo,g)};b.prototype._cleanPromise=function(c){this._visualSetPromises.delete(c);
this.notifyChange("updating")};b.prototype._processFeatures=function(c,a,b){var d=this;if(!a||!a.length)return k.resolve(null);var e=this._factory,g={viewingMode:"",scale:c.scale};return this._matcher.then(function(c){return e.analyze(a,c,b,g)}).then(function(a){return d._getLabelMosaicItems(c,a,b).then(function(g){return d._writeFeatures(c,a,b,g,e)})})};b.prototype._writeFeatures=function(c,a,b,d,e){for(var g=e.createMeshData(a.length),p={viewingMode:"",scale:c.scale},m=this._symbolToMosaicItemMap,
f=0;f<a.length;f++){var r=a[f];try{e.write(g,r,b,p,c.level,d,m)}catch(ha){}}return this._encodeDisplayData(g)};b.prototype._encodeDisplayData=function(c){var a={},b=[];c.encode(a,b);return{message:a,transferList:b}};b.prototype._handleError=function(b,a,p){p=p.signal;if(!k.isAbortError(a))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a.message},{signal:p})};b.prototype._getLabelMosaicItems=function(b,a,p){return t(this,void 0,void 0,function(){var c,e,g,q,m,f;return n(this,
function(d){switch(d.label){case 0:return c=y.acquire(),[4,this._createLabelFeatures(b.scale,a,c,p)];case 1:e=d.sent();g=this._symbolToMosaicItemMap;q=y.acquire();m=[];f=0;c.forEach(function(a,b){if(g.has(b.id)){var c=g.get(b.id).glyphMosaicItems,e=[];a.forEach(function(a){if(c&&c.length<a||!c[a])e[a]=a});0<e.length&&(q.set(f,b),m.push({symbol:b.toJSON(),id:f,glyphIds:e}),f++)}else{q.set(f,b);var d=[];a.forEach(function(a){return d.push(a)});m.push({symbol:b.toJSON(),id:f,glyphIds:d});f++}});if(0<
m.length)return[2,this.remoteClient.invoke("tileRenderer.getMaterialItems",m).then(function(a){for(var b=0;b<a.length;b++){var c=a[b],d=q.get(c.id);if(d)if(ba.isTextSymbol(d))if(g.has(d.id)){if(d=g.get(d.id).glyphMosaicItems,c=c.mosaicItem.glyphMosaicItems)for(var f=0;f<c.length;f++)null!=c[f]&&(d[f]=c[f])}else g.set(d.id,c.mosaicItem);else g.set(d.id,c.mosaicItem)}y.release(q);return e})];y.release(c);return[2,k.resolve(e)]}})})};b.prototype._getLabelClassInfosForScale=function(b){return t(this,
void 0,void 0,function(){var a;return n(this,function(c){switch(c.label){case 0:return[4,this.labelClassInfos];case 1:return a=c.sent(),[2,a.filter(function(a){var c=a.minScale;a=a.maxScale;return(!c||c>=b||0===c)&&(!a||a<=b||0===a)})]}})})};b.prototype._createLabelFeatures=function(b,a,p,d){return t(this,void 0,void 0,function(){var c,g,q,m,f,r,l,h,k,t,z,E,F,G,B,C,w,x,P,H,Q,R,S,I,T,v,J,K,L,U;return n(this,function(e){switch(e.label){case 0:return this.labelingInfo&&a&&0!==a.length?[4,this._getLabelClassInfosForScale(b)]:
[2,null];case 1:c=e.sent();if(0===c.length)return[2,null];g=y.acquire();q=new u.CollisionGrid(u.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE);m=0;for(f=a;m<f.length;m++){r=f[m];l=this.service.geometryType;k=h=0;if("esriGeometryPoint"===l||"esriGeometryPolygon"===l)if("esriGeometryPoint"===l?(t=r.geometry,h=t.x,k=t.y):(h=r.centroid.x,k=r.centroid.y),z=q.checkOverlap(h,k))continue;E=r.localId;F=[];G=!1;for(B=0;B<c.length;B++){C=c[B];w=C.index;x=C.builder;P=C.symbol;H=r;if(!d)return ea.error("mapview-labeling",
"Tried to evaluate geometry expression but no transformation found"),[2,void 0];Q=d.transform;R=d.hasZ;S=d.hasM;I=this.hydrate(r.geometry,Q,R,S);T=V({},r,{geometry:I});I.spatialReference=O.fromJSON(this.spatialReference);H=T;v=x.evaluate(H);if(!N.isNone(v)&&""!==v){G=!0;u.definitions.DEBUG_LABELS&&(J="-"+E,v=v.substring(0,v.length-J.length)+J);K=u.bidiText(v);L=K[0];U=K[1];var n=P;e=L;var A=p;A.has(n)||A.set(n,new Set);for(var n=A.get(n),A=e.length,M=0;M<A;M++){var D=e.charCodeAt(M);n.add(D)}F.push({text:L,
rtl:U,id:w})}}G&&q.markUsed(h,k);g.set(E,F)}return[2,g]}})})};h([l.property({readOnly:!0})],b.prototype,"supportsTileUpdates",null);h([l.property()],b.prototype,"config",void 0);h([l.property({dependsOn:["config"]})],b.prototype,"labelingInfo",null);h([l.property({dependsOn:["labelingInfo","service","spatialReference"]})],b.prototype,"labelClassInfos",null);h([l.property({dependsOn:["service"]})],b.prototype,"hydrate",null);h([l.property({dependsOn:["config"],readOnly:!0})],b.prototype,"renderer",
null);h([l.property({readOnly:!0})],b.prototype,"updating",null);return b=h([l.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],b)}(l.declared(da.default));x.default=w});