// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/has ../../../../core/screenUtils ../../../../core/libs/rbush/rbush ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/contains ../../../../geometry/support/extentUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ./GraphicStoreItem ./graphicsUtils".split(" "),function(A,B,x,C,D,E,n,y,F,G,H,v,q){function w(f,c,a,b,e){u.minX=c;u.minY=a;u.maxX=b;u.maxY=e;return f.search(u)}
Object.defineProperty(B,"__esModule",{value:!0});var u={minX:0,minY:0,maxX:0,maxY:0},r=n.create(),z=[];A=function(){function f(c,a,b,e,k,l){this._graphics=e;this._onAdd=k;this._onRemove=l;this._index=E(9,C("csp-restrictions")?function(a){return{minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this._itemByGraphic=new Map;this._currentLevel=-Infinity;this._tileInfoView=c;this._uidFieldName=b;if(c=c.getClosestInfoForScale(a))this._currentLevel=c.level,
this._resolution=this._tileInfoView.getTileResolution(c.level)}f.prototype.hitTest=function(c,a,b,e,k){c=H.normalizeMapX(c,this._tileInfoView.spatialReference);var l=.5*e*b;r[0]=c-l;r[1]=a-l;r[2]=c+l;r[3]=a+l;b=.5*e*(b+50);b=w(this._index,c-b,a-b,c+b,a+b);if(!b||0===b.length)return[];for(var l={x:c,y:a},h=[],d,f=0;f<b.length;f++){var g=b[f];if(g.graphic.visible)switch(G.getJsonType(g.geometry)){case "esriGeometryPoint":d=g.symbol;if(!d)continue;var m=g.geometry,p=void 0;switch(d.type){case "text":p=
q.getTextSymbolBounds(m.x,m.y,d,g.size,this._resolution,k);break;case "cim":p=q.getCIMMarkerBounds(m.x,m.y,d,this._resolution,k);break;default:p=q.getMarkerSymbolBounds(m.x,m.y,d,this._resolution,k)}y.polygonContainsPoint(p,l)&&h.push(g);break;case "esriGeometryPolyline":d=g.symbol;if(!d)continue;d=1.5*e*window.devicePixelRatio*D.pt2px(d.width);q.isPointOnPolyline(g.geometry,c,a,d)&&h.push(g);break;case "esriGeometryEnvelope":d=g.geometry;d=n.fromValues(d.xmin,d.ymin,d.xmax,d.ymax);n.intersects(d,
r)&&h.push(g);break;case "esriGeometryPolygon":if(y.polygonContainsPoint(g.geometry,l)){h.push(g);break}d=F.getPolygonExtent(g.geometry);if(Math.abs(d.ymax-d.ymin)<5*e||Math.abs(d.xmax-d.xmin)<5*e)d=n.fromValues(d.xmin,d.ymin,d.xmax,d.ymax),n.intersects(d,r)&&h.push(g);break;case "esriGeometryMultipoint":if(d=g.symbol)for(var m=g.geometry.points,p=void 0,t=0;t<m.length;t++)if(p="text"===d.type?q.getTextSymbolBounds(m[t][0],m[t][1],d,g.size,this._resolution,k):q.getMarkerSymbolBounds(m[t][0],m[t][1],
d,this._resolution,k),y.polygonContainsPoint(p,l)){h.push(g);break}}}h.sort(function(a,b){var c=q.graphicGeometryToNumber(a.graphic),d=q.graphicGeometryToNumber(b.graphic);return c===d?b.zorder-a.zorder:c-d});return h.map(function(a){return a.graphic})};f.prototype.getGraphicsData=function(c,a,b){var e=w(this._index,a.bounds[0],a.bounds[1],a.bounds[2],a.bounds[3]);if(0===e.length||0===b.length)return[];e.sort(function(a,b){return a.zorder-b.zorder});e[0].insertAfter=-1;for(var k=1;k<e.length;k++)e[k].insertAfter=
e[k-1].graphic.uid;e.sort(function(a,b){return a.graphic.uid-b.graphic.uid});b.sort(function(a,b){return a.uid-b.uid});var l=k=0,h,d=[];a={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};for(var f=0;f<b.length;f++){for(var g=b[f],l=-2;k<e.length;)if(h=e[k],k++,g.uid===h.graphic.uid){l=h.insertAfter;break}if(h.geometry&&-2!==l){var m=h.getGeometryQuantized(a),p=x({},h.graphic.attributes);p[this._uidFieldName]=g.uid;null==h.groupId&&(h.groupId=c.createTemplateGroup(h.symbol,
null,null));d.push({centroid:v.default.getCentroidQuantized(h,a),geometry:m,attributes:p,symbol:h.symbol,groupId:h.groupId,insertAfter:l})}}return d};f.prototype.getGraphicData=function(c,a,b){var e=this._itemByGraphic.get(b);if(!e)return null;var k=w(this._index,a.bounds[0],a.bounds[1],a.bounds[2],a.bounds[3]);k.sort(function(a,b){return a.zorder-b.zorder});var f=k.indexOf(e),k=0===f||-1===f?-1:k[f-1].graphic.uid;a={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],
a.bounds[3]]};var f=e.getGeometryQuantized(a),h=x({},e.graphic.attributes);h[this._uidFieldName]=b.uid;null==e.groupId&&(e.groupId=c.createTemplateGroup(e.symbol,null,null));return{centroid:v.default.getCentroidQuantized(e,a),geometry:f,attributes:h,symbol:e.symbol,groupId:e.groupId,insertAfter:k}};f.prototype.queryTileData=function(c,a){var b=n.pad(a.bounds,50*a.resolution,n.create()),b=w(this._index,b[0],b[1],b[2],b[3]),e=[];this._createTileGraphics(e,c,b,{originPosition:"upperLeft",scale:[a.resolution,
a.resolution],translate:[a.bounds[0],a.bounds[3]]});return e};f.prototype.has=function(c){return this._itemByGraphic.has(c)};f.prototype.getBounds=function(c){return this._itemByGraphic.has(c)?this._itemByGraphic.get(c).bounds:null};f.prototype.add=function(c,a,b){if(c)return this._onAdd(c),a=v.default.acquire(c,a,b,this._resolution,this._tileInfoView.spatialReference),this._itemByGraphic.set(c,a),b&&this._index.insert(a),a.bounds};f.prototype.remove=function(c){if(this._itemByGraphic.has(c)){this._onRemove(c);
var a=this._itemByGraphic.get(c);this._index.remove(a);this._itemByGraphic.delete(c)}};f.prototype.updateZ=function(){for(var c=this._graphics.items,a,b=0;b<c.length;b++)if(a=c[b],a=this._itemByGraphic.get(a))a.zorder=b};f.prototype.update=function(c,a,b){var e=this._itemByGraphic.get(c),f=n.clone(e.bounds);e.size[0]=e.size[1]=0;this._index.remove(e);e.set(c,a,b,this._resolution,this._tileInfoView.spatialReference);b&&this._index.insert(e);return{oldBounds:f,newBounds:e.bounds}};f.prototype.updateLevel=
function(c){var a=this;this._currentLevel!==c&&(this._currentLevel=c,this._resolution=this._tileInfoView.getTileResolution(c),this._index.clear(),z.length=0,this._itemByGraphic.forEach(function(b){b.updateBounds(a._resolution,a._tileInfoView.spatialReference);b.geometry&&z.push(b)}),this._index.load(z))};f.prototype.clear=function(){this._itemByGraphic.clear();this._index.clear()};f.prototype._createTileGraphics=function(c,a,b,e){var f=this._uidFieldName;b.sort(function(a,b){return a.zorder-b.zorder});
for(var l,h,d,n,g=0;g<b.length;g++){d=b[g];l=d.graphic;h=d.getGeometryQuantized(e);n=0===g?-1:b[g-1].graphic.uid;var m=x({},d.graphic.attributes);m[f]=l.uid;null==d.groupId&&(d.groupId=a.createTemplateGroup(d.symbol,null,null));c.push({centroid:v.default.getCentroidQuantized(d,e),geometry:h,attributes:m,symbol:d.symbol,groupId:d.groupId,insertAfter:n})}};return f}();B.default=A});