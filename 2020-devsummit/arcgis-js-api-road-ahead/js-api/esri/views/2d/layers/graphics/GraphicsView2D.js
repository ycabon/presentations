// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/Identifiable ../../../../core/MapPool ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/coordsUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../../../symbols/support/cimSymbolUtils ../../../../symbols/support/defaults ../../engine ../../engine/webgl/definitions ../features/support/AttributeStore ../features/support/TileStore ./GraphicContainer ./GraphicProcessingQueue ./GraphicStore ./graphicsUtils ../../../layers/GraphicsView".split(" "),
function(w,D,G,u,Z,x,y,H,I,J,E,K,z,m,L,M,q,N,O,t,P,n,A,F,Q,B,r,R,S,T,U,V,W,X,Y){function C(m,d,a){if(a.has(m))return a.get(m);d={tile:d,addedOrModified:[],removed:[]};a.set(m,d);return d}Object.defineProperty(D,"__esModule",{value:!0});w=function(w){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=w.apply(this,a)||this;a._tiles=new Map;a._graphicStoreUpdate=!1;a._graphicsSet=new Set;a._matcher=m.resolve(null);a._tileUpdateSet=new Set;a._tilesToUpdate=new Map;a._graphicIdToAbortController=
new Map;a._attached=!1;a._highlightIds=new Map;a._updatingGraphicsTimer=null;a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a.addOrUpdateGraphic=a.addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}G(d,w);d.prototype.initialize=function(){var a=this;this._tileStore=new T.default(this.view.featuresTilingScheme);this.container=new U.default(this.view.featuresTilingScheme,
null);this._attributeStore=new S.default({type:"local",initialize:function(b){return m.resolve(a.container.attributeView.initialize(b))},update:function(b){return a.container.attributeView.requestUpdate(b)},render:function(){return a.container.requestRender()}});this._graphicStore=new W.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,function(b){a._attributeStore.createLocalId(b.uid);a._setFilterState(b.uid,b.visible)},function(b){a._attributeStore.freeLocalId(b.uid)});
this._graphicProcessingQueue=new V.default({process:this.addOrUpdateGraphic});var b=new r.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),!0),c=this._tileStore.tileScheme.tileInfo;this._matcher=this.renderer?r.createMatcher(b,null,this.renderer):r.createMatcher(b,null);this._meshFactory=new r.WGLMeshFactory(null,this.uid,null,b,null,c);this._templateStore=b;this.watch("renderer",function(c){c&&(a._matcher=a.renderer?r.createMatcher(b,null,a.renderer):r.createMatcher(b,null))});
this._tileStore.on("update",this._onTileUpdate.bind(this));this.container.on("attach",function(){0<a.graphics.items.length&&a._graphicsChangeHandler({target:a.graphics,added:a.graphics.items,removed:[],moved:[]});a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics");a._attached=!0;a.notifyChange("updating")});this.container.on("detach",function(){a._graphicProcessingQueue&&a._graphicProcessingQueue.clear()})};d.prototype.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),
this._updatingGraphicsTimer=null,this.notifyChange("updating"));this.container.dispose();this._set("graphics",null);this._graphicProcessingQueue&&(this._graphicProcessingQueue.destroy(),this._graphicProcessingQueue=null);this._graphicStore.clear();this._tileStore.destroy();this._attributeStore=null};Object.defineProperty(d.prototype,"updating",{get:function(){return!this._attached||null!==this._updatingGraphicsTimer||this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size},
enumerable:!0,configurable:!0});d.prototype.install=function(a){a.addChild(this.container)};d.prototype.uninstall=function(a){a.removeChild(this.container)};d.prototype.hitTest=function(a,b){if(!this.view||!this.view.position)return m.resolve();a=this.view.toMap(M.createScreenPoint(a,b));return this.searchFeatures(a).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,b){var c=this;void 0===b&&(b=2);return m.create(function(e){e(c._graphicStore.hitTest(a.x,a.y,b,
c.view.state.resolution,c.view.state.rotation))})};d.prototype.update=function(a){a=a.state;var b=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(b);this._tileStore.setViewState(a);this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate(this))};d.prototype.processUpdate=function(a){this.updateRequested&&
(this.updateRequested=!1,this.update(a))};d.prototype.graphicUpdateHandler=function(a){var b=a.newValue,c=a.graphic;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(c,"update");break;case "visible":this._setFilterState(c.uid,b),this._attributeStore.sendUpdates()}};d.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var e=this._highlightIds.get(c);this._highlightIds.set(c,e+1)}else this._highlightIds.set(c,1)}this._updateHighlight()};
d.prototype.removeHighlight=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var e=this._highlightIds.get(c)-1;0===e?this._highlightIds.delete(c):this._highlightIds.set(c,e)}}this._updateHighlight()};d.prototype._updateHighlight=function(){this._attributeStore.setHighlight(K.keysOfMap(this._highlightIds))};d.prototype._getIntersectingTiles=function(a){return(a=this._graphicStore.getBounds(a))&&0!==t.width(a)&&0!==t.height(a)?this._tileStore.boundsIntersections(a):[]};
d.prototype._updateTile=function(a){var b=this,c=a.tile,e=this._getGraphicsData(this._templateStore,c,a.addedOrModified);return this._processGraphics(c.key,e).then(function(e){b._patchTile(c.key,{addOrUpdate:e,remove:a.removed});return e})};d.prototype._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),this.container.onTileData(a,b),this.container.requestRender())};d.prototype._graphicsChangeHandler=function(a){var b=this;if(!this._graphicStoreUpdate){var c=this.view.state,e=this.view.featuresTilingScheme.getClosestInfoForScale(c.scale).level;
this._graphicStore.updateLevel(e);this._tileStore.setViewState(c)}var d=a.added,e=a.removed;a=a.moved;for(var g=this._tilesToUpdate,f,c=[],p=Array(d.length),l=0;l<d.length;l++){var h=d[l];p[l]=h;this._graphicsSet.add(h);c.push(this.addGraphic(h))}for(l=0;l<e.length;l++){h=e[l];this._abortProcessingGraphic(h.uid);for(var d=this._getIntersectingTiles(h),v=0,n=d;v<n.length;v++)d=n[v],f=d.key.id,d=C(f,d,g),d.removed.push(this._attributeStore.getLocalId(h.uid));this._graphicsSet.delete(h);this._graphicStore.remove(h)}for(e=
0;e<a.length;e++)for(l=a[e],d=this._getIntersectingTiles(l),h=0,v=d;h<v.length;h++)d=v[h],f=d.key.id,d=C(f,d,g),d.addedOrModified.push(l);this._flipUpdatingGraphics();m.all(c).then(function(){for(var a,c=0;c<p.length;c++){a=p[c];for(var d=0,e=b._getIntersectingTiles(a);d<e.length;d++){var k=e[d];f=k.key.id;C(f,k,g).addedOrModified.push(a)}}b._graphicStore.updateZ();var h=[];g.forEach(function(a){return h.push(b._updateTile(a))});return m.all(h).then(function(){g.clear();b.notifyChange("updating")})}).catch(function(){g.clear();
b.notifyChange("updating")})};d.prototype._getArcadeInfo=function(a){var b=(a.attributes?Object.keys(a.attributes):[]).map(function(b){return{name:b,alias:b,type:"string"===typeof a.attributes[b]?"esriFieldTypeString":"esriFieldTypeDouble"}});return z.isNone(a.geometry)?null:{geometryType:n.getJsonType(a.geometry),spatialReference:O.fromJSON(a.geometry.spatialReference),fields:b}};d.prototype._getSymbolForGraphic=function(a,b){return y(this,void 0,void 0,function(){return x(this,function(c){return z.isSome(a.symbol)?
[2,a.symbol]:this.renderer?[2,this.renderer.getSymbolAsync(a,{scale:this.view.scale,abortOptions:b})]:[2,this._getNullSymbol(a)]})})};d.prototype._getSymbolResources=function(a,b){return y(this,void 0,void 0,function(){var c,d,k,g,f,p,l,h,n,q;return x(this,function(e){switch(e.label){case 0:if(!this.container.attached)return[2,m.resolve(null)];c=this._getArcadeInfo(a);k=Q.expandSymbol;return[4,this._getSymbolForGraphic(a,b)];case 1:return[4,k.apply(void 0,[e.sent(),null,c,b])];case 2:d=e.sent();if("text"!==
d.type)return[3,4];g=new Set;f=d;p=r.bidiText(f.text)[0];for(l=0;l<p.length;l++)g.add(p.charCodeAt(l));h=[];g.forEach(function(a){return h.push(a)});n={symbol:d.toJSON(),id:0,glyphIds:h};return[4,this.container.getMaterialItems([n])];case 3:return q=e.sent()[0].mosaicItem,[2,{symbol:d,mosaicItem:q}];case 4:return[2,{symbol:d,mosaicItem:null}]}})})};d.prototype._projectAndNormalizeGeometry=function(a){return y(this,void 0,void 0,function(){var b,c,d,k=this;return x(this,function(e){if(z.isNone(a.geometry))return[2,
m.resolve(null)];b=a.geometry;n.isPolygon(b)?(c=b.rings,b.rings=c):n.isPolyline(b)?(d=b.paths,b.paths=d):n.isExtent(b)&&(b=N.fromExtent(b));return[2,F.checkProjectionSupport(b.spatialReference,this.view.spatialReference).then(function(){var a=X.normalizeCentralMeridian(b),a=F.project(a,b.spatialReference,k.view.spatialReference);P.closeRingsAndFixWinding(a);return a})]})})};d.prototype._onTileUpdate=function(a){var b=A.getInfo(this.view.spatialReference);if(a.added&&0<a.added.length)for(var c=0,d=
a.added;c<d.length;c++)this._addNewTile(d[c],b);if(a.removed&&0<a.removed.length)for(b=0,a=a.removed;b<a.length;b++)this._removeTile(a[b].key)};d.prototype.addOrUpdateGraphic=function(a,b,c){return this._addOrUpdateGraphic(a,b,c)};d.prototype.addGraphic=function(a){var b=this;this._abortProcessingGraphic(a.uid);var c=L.createAbortController();this._graphicIdToAbortController.set(a.uid,c);return this._addOrUpdateGraphic(a,"add",{signal:c.signal}).then(function(){b._graphicIdToAbortController.delete(a.uid)}).catch(function(c){b._graphicIdToAbortController.delete(a.uid);
if(!m.isAbortError(c))throw c;})};d.prototype._addOrUpdateGraphic=function(a,b,c){var d=this,k=this._projectAndNormalizeGeometry(a),g=this._getSymbolResources(a,c);return m.all([k,g]).then(function(e){var f=e[0];e=e[1];return"add"===b?d._addProjectedGraphic(a,e,f):d._updateGraphic(a,e,f,c)})};d.prototype._addProjectedGraphic=function(a,b,c){this._graphicsSet.has(a)&&this._graphicStore.add(a,b,c)};d.prototype._updateGraphic=function(a,b,c,d){var e=this;if(!this._graphicStore.has(a)||m.isAborted(d))return m.resolve();
c=this._graphicStore.update(a,b,c);b=c.oldBounds;c=c.newBounds;var g=0===t.width(b)&&0===t.height(b),f=0===t.width(c)&&0===t.height(c),g=g?[]:this._tileStore.boundsIntersections(b);b=f?[]:this._tileStore.boundsIntersections(c);c=E.acquire();for(var p=0;p<g.length;p++)f=g[p],c.set(f.key,{addOrUpdate:null,remove:[this._attributeStore.getLocalId(a.uid)]});for(g=0;g<b.length;g++)f=b[g],p=this._getGraphicData(this._templateStore,f,a),c.has(f.key)?(f=c.get(f.key),f.remove.length=0,f.addOrUpdate=p):c.set(f.key,
{addOrUpdate:p,remove:null});var l=[];c.forEach(function(a,b){var c=e._processGraphics(b,a.addOrUpdate,d).then(function(c){e._patchTile(b,{addOrUpdate:c,remove:a.remove})});l.push(c)});E.release(c);return m.all(l).then(function(){})};d.prototype._addTile=function(a,b){var c=t.create();this.view.featuresTilingScheme.getTileBounds(c,a);c=new r.WGLTile(a,c,!0);b={clear:!0,addOrUpdate:b,remove:[]};this._tiles.set(a,c);this.container.addChild(c);c.setData(b,!1,!1)};d.prototype._addNewTile=function(a,b){var c=
this,d=this._graphicStore.queryTileData(this._templateStore,a);if(b){b=Math.round((b.valid[1]-b.valid[0])/a.resolution);for(var k=0;k<d.length;k++){var g=d[k];g.geometry&&n.isPoint(g.geometry)&&this._wrapPoints(g,b)}}var f=a.key;this._tileUpdateSet.add(a.key);this.notifyChange("updating");this._processGraphics(f,d).then(function(a){c._addTile(f,a);c._tileUpdateSet.delete(f);c.notifyChange("updating")}).catch(function(a){c._tileUpdateSet.delete(f);c.notifyChange("updating");if(!m.isAbortError(a))throw a;
})};d.prototype._removeTile=function(a){if(this._tiles.has(a)){var b=this._tiles.get(a);this.container.removeChild(b);b.destroy();this._tiles.delete(a)}};d.prototype._setFilterState=function(a,b){var c=this._attributeStore.getLocalId(a);a=this._attributeStore.getHighlightFlag(a);this._attributeStore.setData(c,0,0,a|(b?R.FILTER_FLAG_0:0))};d.prototype._getGraphicsData=function(a,b,c){var d=A.getInfo(this.view.spatialReference);a=this._graphicStore.getGraphicsData(a,b,c);if(d)for(b=Math.round((d.valid[1]-
d.valid[0])/b.resolution),d=0;d<a.length;d++)c=a[d],c.geometry&&n.isPoint(c.geometry)&&this._wrapPoints(c,b);a.sort(function(a,b){return a.insertAfter-b.insertAfter});return a};d.prototype._getGraphicData=function(a,b,c){a=this._graphicStore.getGraphicData(a,b,c);c=[a];var d=A.getInfo(this.view.spatialReference);d&&(b=Math.round((d.valid[1]-d.valid[0])/b.resolution),a.geometry&&n.isPoint(a.geometry)&&this._wrapPoints(a,b));return c};d.prototype._wrapPoints=function(a,b){var c=a.geometry;512===b?20>
c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:492<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]}):-20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:532<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};d.prototype._processGraphics=function(a,b,c){return y(this,void 0,void 0,function(){var d,k,g;return x(this,function(e){switch(e.label){case 0:d=b&&b.length;if(!d||!this._meshFactory)return[2,null];k=this._meshFactory;return[4,this._matcher.then(function(a){return k.analyze(b,a,null,null,c)})];case 1:return g=e.sent(),
this._attributeStore.sendUpdates(),[2,this._processAnalyzedGraphics(a,g)]}})})};d.prototype._processAnalyzedGraphics=function(a,b){for(var c=this._meshFactory,d=c.createMeshData(b.length),k=this._attributeStore,g=0;g<b.length;g++){var f=b[g];f.insertAfter=-1===f.insertAfter?-1:k.getLocalId(f.insertAfter);f.localId=k.getLocalId(f.attributes[this.uid]);c.write(d,f,null,null,a.level)}return r.TileData.fromMeshData(d)};d.prototype._abortProcessingGraphic=function(a){this._graphicIdToAbortController.has(a)&&
this._graphicIdToAbortController.get(a).abort()};d.prototype._getNullSymbol=function(a){a=a.geometry;return n.isPolyline(a)?B.errorPolylineSymbol2D:n.isPolygon(a)||n.isExtent(a)?B.errorPolygonSymbol2D:B.errorPointSymbol2D};d.prototype._flipUpdatingGraphics=function(){var a=this;this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer);this._updatingGraphicsTimer=setTimeout(function(){a._updatingGraphicsTimer=null;a.notifyChange("updating")},160);this.notifyChange("updating")};u([q.property()],
d.prototype,"_graphicProcessingQueue",void 0);u([q.property({constructOnly:!0})],d.prototype,"graphics",void 0);u([q.property({dependsOn:["_graphicProcessingQueue.updating"]})],d.prototype,"updating",null);u([q.property()],d.prototype,"view",void 0);u([q.property()],d.prototype,"updateRequested",void 0);return d=u([q.subclass("esri.views.2d.layers.support.GraphicsView2D")],d)}(q.declared(Y.GraphicsView(I.HandleOwnerMixin(J.IdentifiableMixin(H)))));D.default=w});