// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Extent ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../engine ../../viewStateUtils ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(H,I,J,x,y,z,d,A,m,a,r,B,C,D,E,n,F,G){var e=B.create(),f=[0,0],t=new G(0,0,0,0);return function(u){function c(c){var b=u.call(this,c)||this;b._imagePromise=null;b.hidpi=!1;b.imageMaxWidth=2048;b.imageMaxHeight=2048;b.imageRotationSupported=!1;b.imageNormalizationSupported=!1;b.update=m.debounce(function(c,k){return y(b,void 0,void 0,function(){var b,a,d,p,w,e,v,q,l,g=this;return x(this,function(K){b=c.state;a=C.getInfo(b.spatialReference);d=this.hidpi?c.pixelRatio:1;if(!c.stationary||this.destroyed)return[2];
this.imageRotationSupported?(f[0]=b.size[0],f[1]=b.size[1]):n.getOuterSize(f,b);p=Math.floor(f[0]*d)>this.imageMaxWidth||Math.floor(f[1]*d)>this.imageMaxHeight;w=a&&(b.extent.xmin<a.valid[0]||b.extent.xmax>a.valid[1]);e=!this.imageNormalizationSupported&&w;v=!p&&!e;q=this.imageRotationSupported?b.rotation:0;v?this._imagePromise=this._singleExport(b,f,q,d,k):(l=Math.min(this.imageMaxWidth,this.imageMaxHeight),e&&(l=Math.min(b.worldScreenWidth,l)),this._imagePromise=this._tiledExport(b,l,q,d,k));return[2,
this._imagePromise.then(function(b){g._imagePromise=null;var c=g.container.children.slice();g.container.removeAllChildren();b.forEach(g.container.addChild,g.container);g.disposeSource&&c.forEach(function(b){g.disposeSource(b.source)},g)}).catch(function(b){g._imagePromise=null;throw b;})]})})},5E3);return b}z(c,u);c.prototype.destroy=function(){};Object.defineProperty(c.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0});c.prototype.updateExports=
function(c){for(var b=0,d=this.container.children;b<d.length;b++){var a=d[b];if(!a.visible||!a.attached)break;c(a)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(a.invalidateTexture(),a.requestRender())}};c.prototype._export=function(c,b,a,d,e,f){var k=this;return m.resolve().then(function(){return k.fetchSource(c,Math.floor(b*e),Math.floor(a*e),{rotation:d,pixelRatio:e,signal:f})}).then(function(a){a=new E.Bitmap(a);a.x=c.xmin;a.y=c.ymax;a.resolution=c.width/b;a.rotation=
d;a.pixelRatio=e;return a})};c.prototype._singleExport=function(a,b,c,d,f){n.getBBox(e,a.center,a.resolution,b);a=new r(e[0],e[1],e[2],e[3],a.spatialReference);return this._export(a,b[0],b[1],c,d,f).then(function(b){return[b]})};c.prototype._tiledExport=function(a,b,c,d,f){var k=this,h=D.create({size:b,spatialReference:a.spatialReference,scales:[a.scale]}),p=new F(h),h=p.getTileCoverage(a);if(!h)return null;var n=[];h.forEach(function(h,m,q,l){t.set(h,m,q,l);p.getTileBounds(e,t);h=new r(e[0],e[1],
e[2],e[3],a.spatialReference);n.push(k._export(h,b,b,c,d,f))});return m.all(n)};d([a.property()],c.prototype,"_imagePromise",void 0);d([a.property()],c.prototype,"container",void 0);d([a.property()],c.prototype,"disposeSource",void 0);d([a.property()],c.prototype,"fetchSource",void 0);d([a.property()],c.prototype,"hidpi",void 0);d([a.property()],c.prototype,"imageMaxWidth",void 0);d([a.property()],c.prototype,"imageMaxHeight",void 0);d([a.property()],c.prototype,"imageRotationSupported",void 0);d([a.property()],
c.prototype,"imageNormalizationSupported",void 0);d([a.property()],c.prototype,"requestUpdate",void 0);d([a.property({dependsOn:["_imagePromise"]})],c.prototype,"updating",null);return c=d([a.subclass("esri.views.2d.layers.support.ExportStrategy")],c)}(a.declared(A))});