// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(z,A,u,v,w,x,r){var d=new x("0/0/0/0"),y=function(){function d(a,b,c,d,k,e,q,g){this.x=a;this.ymin=b;this.ymax=c;this.invM=d;this.leftAdjust=k;this.rightAdjust=e;this.leftBound=q;this.rightBound=g}d.create=function(a,b){var c;a[1]>b[1]&&(c=[b,a],a=c[0],b=c[1]);c=a[0];a=a[1];var t=b[0];b=b[1];var k=t-c,e=b-a,e=0!==e?k/e:0,q=(Math.ceil(a)-a)*e,g=(Math.floor(a)-a)*
e;return new d(c,Math.floor(a),Math.ceil(b),e,0>k?q:g,0>k?g:q,0>k?t:c,0>k?c:t)};d.prototype.incrRow=function(){this.x+=this.invM};d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return d}(),h=[[0,0],[0,0],[0,0],[0,0]];return function(){function f(a,b){var c=this;this.tileInfo=a;this.fullExtent=b;this.scales=[];this._lodInfos=null;this._infoByScale={};this._infoByLevel=
{};var d=a.lods.slice();d.sort(function(a,b){return b.scale-a.scale});var k=this._lodInfos=d.map(function(c){return v.create(a,c,b)});d.forEach(function(a,b){c._infoByLevel[a.level]=k[b];c._infoByScale[a.scale]=k[b];c.scales[b]=a.scale},this);this._wrap=a.isWrappable}Object.defineProperty(f.prototype,"spatialReference",{get:function(){return this.tileInfo.spatialReference},enumerable:!0,configurable:!0});f.prototype.getLODInfoAt=function(a){return this._infoByLevel["number"===typeof a?a:a.level]};
f.prototype.getTileBounds=function(a,b,c){void 0===c&&(c=!1);d.set(b);return(b=this._infoByLevel[d.level])?b.getTileBounds(a,d,c):a};f.prototype.getTileCoords=function(a,b,c){void 0===c&&(c=!1);d.set(b);return(b=this._infoByLevel[d.level])?b.getTileCoords(a,d,c):a};f.prototype.getTileCoverage=function(a,b,c){void 0===b&&(b=192);void 0===c&&(c="closest");c="closest"===c?this.getClosestInfoForScale(a.scale):this.getSmallestInfoForScale(a.scale);var d=w.pool.acquire(c),k=this._wrap,e;e=Infinity;var f=
-Infinity,g,m,p=d.spans;h[0][0]=h[0][1]=h[1][1]=h[3][0]=-b;h[1][0]=h[2][0]=a.size[0]+b;h[2][1]=h[3][1]=a.size[1]+b;for(b=0;b<h.length;b++){var l=h[b];a.toMap(l,l);l[0]=c.getColumnForX(l[0]);l[1]=c.getRowForY(l[1])}a=[];l=3;for(b=0;4>b;b++){if(h[b][1]!==h[l][1]){var n=y.create(h[b],h[l]);e=Math.min(n.ymin,e);f=Math.max(n.ymax,f);void 0===a[n.ymin]&&(a[n.ymin]=[]);a[n.ymin].push(n)}l=b}if(null==e||null==f||100<f-e)return null;for(l=[];e<f;){null!=a[e]&&(l=l.concat(a[e]));g=Infinity;m=-Infinity;for(b=
l.length-1;0<=b;b--)n=l[b],g=Math.min(g,n.getLeftCol()),m=Math.max(m,n.getRightCol());g=Math.floor(g);m=Math.floor(m);if(e>=c.first[1]&&e<=c.last[1])if(k)if(c.size[0]<c.worldSize[0])for(n=Math.floor(m/c.worldSize[0]),b=Math.floor(g/c.worldSize[0]);b<=n;b++)p.push(new r(e,Math.max(c.getFirstColumnForWorld(b),g),Math.min(c.getLastColumnForWorld(b),m)));else p.push(new r(e,g,m));else g>c.last[0]||m<c.first[0]||(g=Math.max(g,c.first[0]),m=Math.min(m,c.last[0]),p.push(new r(e,g,m)));e+=1;for(b=l.length-
1;0<=b;b--)n=l[b],n.ymax>=e?n.incrRow():l.splice(b,1)}return d};f.prototype.getTileParentId=function(a){d.set(a);a=this._lodInfos.indexOf(this._infoByLevel[d.level])-1;if(0>a)return null;this._getTileIdAtLOD(d,this._lodInfos[a],d);return d.id};f.prototype.getTileResolution=function(a){return(a=this._infoByLevel["object"===typeof a?a.level:a])?a.resolution:-1};f.prototype.getTileScale=function(a){return(a=this._infoByLevel[a.level])?a.scale:-1};f.prototype.intersects=function(a,b){d.set(b);b=this._infoByLevel[d.level];
var c=a.lodInfo;if(c.resolution>b.resolution){this._getTileIdAtLOD(d,c,d);for(var f=c.denormalizeCol(d.col,d.world),k=0,e=a.spans;k<e.length;k++){var h=e[k];if(h.row===d.row&&h.colFrom<=f&&h.colTo>=f)return!0}}if(c.resolution<b.resolution){e=a.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]);a=e[0];var f=e[1],k=e[2],e=e[3],g=b.denormalizeCol(d.col,d.world),h=c.getColumnForX(b.getXForColumn(g)),
m=c.getRowForY(b.getYForRow(d.row)),g=c.getColumnForX(b.getXForColumn(g+1))-1;b=c.getRowForY(b.getYForRow(d.row+1))-1;return!(h>e||g<k||m>f||b<a)}var p=c.denormalizeCol(d.col,d.world);return a.spans.some(function(a){return a.row===d.row&&a.colFrom<=p&&a.colTo>=p})};f.prototype.normalizeBounds=function(a,b,c){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];this._wrap&&(b=u.getInfo(this.tileInfo.spatialReference),c=-c*(b.valid[1]-b.valid[0]),a[0]+=c,a[2]+=c);return a};f.prototype.getSmallestInfoForScale=function(a){var b=
this.scales;if(this._infoByScale[a])return this._infoByScale[a];if(a>b[0])return this._infoByScale[b[0]];for(var c=1;c<b.length-1;c++)if(a>b[c]+1E-6)return this._infoByScale[b[c-1]];return this._infoByScale[b[b.length-1]]};f.prototype.getClosestInfoForScale=function(a){var b=this.scales;if(this._infoByScale[a])return this._infoByScale[a];a=b.reduce(function(b,d){return Math.abs(d-a)<Math.abs(b-a)?d:b},b[0]);return this._infoByScale[a]};f.prototype.scaleToLevel=function(a){var b=this.scales;if(this._infoByScale[a])return this._infoByScale[a].level;
for(var c=b.length-1;0<=c;c--)if(a<b[c])return c===b.length-1?this._infoByScale[b[b.length-1]].level:this._infoByScale[b[c]].level+(b[c]-a)/(b[c]-b[c+1]);return this._infoByScale[b[0]].level};f.prototype.scaleToZoom=function(a){return this.tileInfo.scaleToZoom(a)};f.prototype._getTileIdAtLOD=function(a,b,c){var d=this._infoByLevel[c.level];a.set(c);if(b.resolution<d.resolution)return null;if(b.resolution===d.resolution)return a;a.level=b.level;a.col=Math.floor(c.col*d.resolution/b.resolution+.01);
a.row=Math.floor(c.row*d.resolution/b.resolution+.01);return a};return f}()});