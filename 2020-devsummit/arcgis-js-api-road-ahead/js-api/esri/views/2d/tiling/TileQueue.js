// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/Accessor ../../../core/SetUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../support/QueueProcessor".split(" "),function(z,A,e,u,v,q,c,w,x){function y(c,b){c.length=0;b.forEach(function(a){return c.push(a)});return c}var n=new Set,k=[],f=new Map,t=[0,0];return function(r){function b(a){a=r.call(this,a)||this;a._keyToItem=new Map;a.concurrency=
6;a.strategy="scale-first";a.tileInfoView=null;return a}u(b,r);b.prototype.initialize=function(){var a=this,b=this.process;this._queue=new x.QueueProcessor({concurrency:this.concurrency,process:function(p,c){p=a._keyToItem.get(p);return b(p,{signal:c})},peeker:"scale-first"===this.strategy?function(b){return a._peekByScaleFirst(b)}:function(b){return a._peekByCenterFirst(b)}})};b.prototype.destroy=function(){this.clear();this._queue.destroy();this._queue=null};Object.defineProperty(b.prototype,"length",
{get:function(){return this._queue?this._queue.length:0},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"onGoingCount",{get:function(){return this._keyToItem.size},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this.length||0<this.onGoingCount},enumerable:!0,configurable:!0});b.prototype.abort=function(a){this._queue.abort("string"===typeof a?a:a.id)};b.prototype.clear=function(){this._queue.clear();this._keyToItem.clear();
this.notifyChange("updating")};b.prototype.has=function(a){return"string"===typeof a?this._keyToItem.has(a):this._keyToItem.has(a.id)};b.prototype.isOngoing=function(a){a="string"===typeof a?a:a.id;return this.has(a)&&this._queue.isOngoing(a)};b.prototype.pause=function(){this._queue.pause()};b.prototype.push=function(a){var b=this,c=a.key.id;if(this.has(c))return this.get(c);var h=this._queue.push(c),g=function(){b._keyToItem.delete(c);b.notifyChange("updating")};this._keyToItem.set(c,a);h.then(g,
g);this.notifyChange("updating");return h};b.prototype.reset=function(){this._queue.reset();this.notifyChange("updating")};b.prototype.resume=function(){this._queue.resume()};b.prototype._peekByScaleFirst=function(a){var b=this;if(!this.state)return q.firstOfSet(a);var c=this.tileInfoView,h=Number.NEGATIVE_INFINITY,g=Number.POSITIVE_INFINITY;a.forEach(function(a){a=b._keyToItem.get(a);var c=b.tileInfoView.getTileScale(a.key);f.has(c)||(f.set(c,[]),h=Math.max(c,h),g=Math.min(c,g));f.get(c).push(a.key);
n.add(c)});var d=this.state.scale;f.has(d)||(y(k,n),k.sort(),d=k.reduce(function(a,b){return Math.abs(b-d)<Math.abs(a-d)?b:a},k[0]));d=Math.min(d,h);d=Math.max(d,g);a=f.get(d);var l=c.getClosestInfoForScale(d),e=l.getColumnForX(this.state.center[0]),m=l.getRowForY(this.state.center[1]);a.sort(function(a,b){var c=l.denormalizeCol(a.col,a.world),d=l.denormalizeCol(b.col,b.world);return Math.sqrt((e-c)*(e-c)+(m-a.row)*(m-a.row))-Math.sqrt((e-d)*(e-d)+(m-b.row)*(m-b.row))});n.clear();f.clear();return a[0].id};
b.prototype._peekByCenterFirst=function(a){var b=this;if(!this.state)return q.firstOfSet(a);var c=this.tileInfoView,e=this.state.center,g=Number.POSITIVE_INFINITY,d=null;a.forEach(function(a){a=b._keyToItem.get(a);c.getTileCoords(t,a.key);var f=w.vec2.distance(t,e);f<g&&(g=f,d=a.key)});return d.id};e([c.property({constructOnly:!0})],b.prototype,"concurrency",void 0);e([c.property({constructOnly:!0})],b.prototype,"process",void 0);e([c.property()],b.prototype,"state",void 0);e([c.property({constructOnly:!0})],
b.prototype,"strategy",void 0);e([c.property({constructOnly:!0})],b.prototype,"tileInfoView",void 0);e([c.property({readOnly:!0})],b.prototype,"updating",null);return b=e([c.subclass("esri.views.2d.tiling.TileQueue")],b)}(c.declared(v))});