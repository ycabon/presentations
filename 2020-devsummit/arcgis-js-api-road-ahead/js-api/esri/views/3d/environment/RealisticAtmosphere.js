// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../core/Handles ../../../core/promiseUtils ../../../core/watchUtils ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ./atmosphereUtils ./RealisticAtmosphereTechnique ../support/earthUtils ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl/BufferObject ../../webgl/VertexArrayObject".split(" "),
function(g,m,K,L,C,D,v,n,k,e,f,w,p,x,u,q,E,F,G,H,I){Object.defineProperty(m,"__esModule",{value:!0});g=function(){function b(a,c){this._view=a;this.canRender=!0;this._skyslot=14;this._hazeSlot=15;this._renderData={texDepth:k.vec2f64.create(),cameraPosition:f.vec3f64.create(),cameraUp:f.vec3f64.create(),cameraRight:f.vec3f64.create(),cameraDir:f.vec3f64.create(),halfSizeNearPlane:k.vec2f64.create(),cameraCenterOffset:k.vec2f64.create(),heightParameters:p.vec4f64.create(),atmosphereParameters1:p.vec4f64.create(),
atmosphereParameters2:p.vec4f64.create(),atmosphereParameters3:f.vec3f64.create(),invWavelength:y,invWavelengthScaled:l,radii:k.vec2f64.create(),scale:0,scaleDepth:r,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:t,oneOverScaleDepthBlue:z,scaleOverScaleDepthBlue:0,g:d,g2:d*d,miePhaseCoefficients:A,nearFar:k.vec2f64.create(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0};this._lowerElevationBoundRadius=0;this._earthRadius=q.earthRadius;
this._updateRadius(q.earthRadius);this._techniqueRepository=c;this._atmosphereTechniqueConfig=new u.RealisticAtmosphereTechniqueConfiguration}b.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);this._vao&&(this._vao.dispose(),this._vao=null)};b.prototype.when=function(){return D.resolve()};b.prototype.initializeRenderContext=function(a){var c=this;a=a.rctx;this._handles=new C;this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,
tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,context:"ground"});this._handles.add(v.on(this._view,"basemapTerrain","elevation-change",function(a){return c._updateElevation(a)},function(){return c._updateElevation()}));this._handles.add(v.on(this._view,"basemapTerrain","elevation-bounds-change",function(){return c._updateVisibleElevationBounds()},function(){return c._updateVisibleElevationBounds()}));this._atmosphereTechniqueConfig.haze=!1;this._atmosphereTechnique=
this._techniqueRepository.acquireAndReleaseExisting(u.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereTechnique);this._atmosphereTechniqueConfig.haze=!0;this._atmosphereHazeTechnique=this._techniqueRepository.acquireAndReleaseExisting(u.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique);this._vao=this._createVertexArrayObject(a)};b.prototype.uninitializeRenderContext=function(){this.destroy()};b.prototype.render=function(a){if(a.slot!==
this._hazeSlot&&a.slot!==this._skyslot||0!==a.pass)return!1;this._update(a.camera);a.slot===this._skyslot&&this._renderSky(a);a.slot===this._hazeSlot&&this._renderHaze(a);return!0};b.prototype._renderSky=function(a){var c=a.rctx,b=this._atmosphereTechnique.program;c.bindProgram(b);this._atmosphereTechnique.bindPipelineState(c);b.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3);this._renderCommon(b,a)};b.prototype._renderHaze=function(a){var c=this,b=a.rctx,d=a.offscreenRenderingHelper,
e=this._atmosphereHazeTechnique.program;b.bindProgram(e);this._atmosphereHazeTechnique.bindPipelineState(b);d.renderDepthDetached(function(){b.bindTexture(d.depthTexture,0);e.setUniform1i("depthTex",0);c._renderCommon(e,a)})};b.prototype._renderCommon=function(a,c){var b=c.rctx;a.setUniform3fv("invWavelength",this._renderData.invWavelength);a.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled);c.scenelightingData.setLightDirectionUniform(a);a.setUniform4fv("heightParameters",
this._renderData.heightParameters);a.setUniform3fv("cameraPosition",this._renderData.cameraPosition);a.setUniform3fv("cameraUp",this._renderData.cameraUp);a.setUniform3fv("cameraRight",this._renderData.cameraRight);a.setUniform3fv("cameraDir",this._renderData.cameraDir);a.setUniform2fv("nearFar",this._renderData.nearFar);a.setUniform2fv("halfSizeNearPlane",this._renderData.halfSizeNearPlane);a.setUniform2fv("cameraCenterOffset",this._renderData.cameraCenterOffset);a.setUniform2fv("radii",this._renderData.radii);
a.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1);a.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2);a.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance);a.setUniform1f("altitudeFade",this._renderData.altitudeFade);b.bindVAO(this._vao);a.assertCompatibleVertexAttributeLocations(this._vao);b.drawArrays(5,0,4)};b.prototype._createVertexArrayObject=function(a){var c=B.createBuffer(4);c.position.setVec(0,[-1,-1,1]);c.position.setVec(1,
[1,-1,1]);c.position.setVec(2,[-1,1,1]);c.position.setVec(3,[1,1,1]);c.uv0.setVec(0,[0,0]);c.uv0.setVec(1,[1,0]);c.uv0.setVec(2,[0,1]);c.uv0.setVec(3,[1,1]);return new I(a,G.Default3D,{geometry:E.glLayout(B)},{geometry:H.createVertex(a,35044,c.buffer)})};b.prototype._adjustRadiusForTesselation=function(a){return a*Math.cos(Math.PI/Math.pow(2,4)/16)};b.prototype._updateElevation=function(a){a=a?a.tile:this._view.basemapTerrain.rootTiles[0];0===a.lij[0]&&(a=this._adjustRadiusForTesselation(q.earthRadius+
a.elevationBounds[0]),a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._earthRadius=-1,this._updateVisibleElevationBounds()))};b.prototype._updateVisibleElevationBounds=function(){var a=this._adjustRadiusForTesselation(q.earthRadius+this._view.basemapTerrain.elevationBounds.min);(0>this._earthRadius||a<this._earthRadius)&&this._updateRadius(a)};b.prototype._updateRadius=function(a){this._earthRadius=a;var c=a/10*10.25,b=1/(c-a),f=b/r,g=b/t,k=.3*(c-a)+a,h=this._renderData;
w.vec4.set(h.atmosphereParameters1,b,r,f,J);w.vec4.set(h.atmosphereParameters2,d,t,g,z);e.vec3.set(h.atmosphereParameters3,d*d,A,k);n.vec2.set(h.radii,a,c);h.scale=b;h.lowerAlphaBlendBound=k;h.scaleOverScaleDepth=f;h.scaleOverScaleDepthBlue=g;c=x.INNER_ATMOSPHERE_DEPTH;h.innerFadeDistance=2*Math.sqrt((2*a-c)*c)};b.prototype._update=function(a){a&&(e.vec3.negate(this._renderData.cameraDir,a.viewForward),e.vec3.copy(this._renderData.cameraUp,a.viewUp),e.vec3.copy(this._renderData.cameraRight,a.viewRight),
this._renderData.cameraHeight=e.vec3.length(a.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=p.vec4f64.fromValues(this._renderData.cameraHeight,this._renderData.cameraHeightSq,this._renderData.C,this._renderData.CSur),
e.vec3.copy(this._renderData.cameraPosition,a.eye),n.vec2.set(this._renderData.halfSizeNearPlane,Math.tan(a.fovX/2)/(a.width/a.fullWidth),Math.tan(a.fovY/2)/(a.height/a.fullHeight)),n.vec2.set(this._renderData.cameraCenterOffset,(a.padding[3]+a.width/2)/a.fullWidth-.5,(a.padding[2]+a.height/2)/a.fullHeight-.5),n.vec2.set(this._renderData.nearFar,a.near,a.far),this._renderData.altitudeFade=x.computeInnerAltitudeFade(this._renderData.cameraHeight-this._earthRadius))};b.isSupported=function(a){return a.rctx.capabilities.depthTexture};
return b}();m.RealisticAtmosphere=g;m=.02*Math.PI;g=.004*Math.PI;var y=f.vec3f64.fromValues(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),l=f.vec3f64.clone(y);e.vec3.scale(l,l,m);e.vec3.add(l,l,f.vec3f64.fromValues(g,g,g));var r=.25,t=.05,J=1/r,z=1/t,d=-.99999,A=(1-d*d)/(2+d*d)*1.5,B=F.newLayout().vec3f("position").vec2f("uv0")});