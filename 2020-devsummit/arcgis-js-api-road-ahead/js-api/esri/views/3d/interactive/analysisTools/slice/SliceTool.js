// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/clock ../../../../../core/Collection ../../../../../core/collectionUtils ../../../../../core/Handles ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../layers/Layer ../../../../../layers/buildingSublayers/BuildingComponentSublayer ../../manipulatorUtils ./sliceToolConfig ./sliceToolUtils ./sliceToolUtils ../../../support/geometryUtils ../../../support/stack ../../../webgl-engine/lib/Intersector ../../../../interactive/InteractiveToolBase ../../../../interactive/interactiveToolUtils".split(" "),
function(q,Q,D,n,E,F,y,z,G,l,H,p,I,m,r,g,v,A,J,K,e,f,t,d,h,L,M,w){function B(g,c,e,a){e=f.createShiftPlane(e,a.plane,g.direction,d.plane.create());a=v.vec3f64.create();return d.plane.intersectRay(e,g,a)?{type:"shift",creatingPointerId:c,shiftPlane:e,depth:0,startPoint:a}:null}function x(d){return"mouse"!==d.pointerType||0===d.button}var C=G.getLogger("esri.views.3d.interactive.analysisTools.slice.SliceTool");q=function(q){function c(a){var b=q.call(this,a)||this;b.clock=E.default;b.deferCreation=
!0;b.cursor=null;b.layersMode="none";b.shiftManipulator=null;b.rotateManipulator=null;b.resizeManipulators=null;b.disableEngineLayers=!1;b._handles=new z;b._viewHandles=new z;b._frameTask=null;b._prevPointerMoveTimeout=null;b._previewOutlineManipulator=null;b._previewOutlineMaterial=null;b._outlineManipulator=null;b._gridManipulator=null;b._gridMaterial=null;b._startPlane=d.boundedPlane.create();b._previewPlane=null;b._activeKeyModifiers={};b._lastCursorPosition=p.createScreenPoint();b._baseOpacity=
1;b._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];b._intersector=new L.Intersector(a.view.viewingMode);b._intersector.options.store=0;return b}D(c,q);u=c;c.prototype.initialize=function(){var a=this,b=I.init(this,"state",function(b){"ready"!==b&&a.create();"sliced"===b&&a.complete()},!0);this._handles.add([b,this.view.state.watch("camera",function(){a._updateManipulators()}),this.excludedLayers.on("before-add",
function(b){var c=b.item;null!=c&&(c instanceof A||c instanceof J)?c instanceof A&&f.isAlwaysDrapedLayer(c)?(C.error("excludedLayers","Layer '"+c.title+", id:"+c.id+"' of type '"+c.type+"' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead."),b.preventDefault()):a.excludedLayers.includes(c)&&b.preventDefault():(C.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),b.preventDefault())})]);var c=function(b,c){a._setSingleManipulatorInteractive(b,
c);c||(a.plane&&d.boundedPlane.copy(a.plane,a._startPlane),a.inputState=null)};this.shiftManipulator=f.createShiftManipulator(this.view);this.manipulators.add(this.shiftManipulator);this.shiftManipulator.events.on("grab-changed",function(b){a._onShiftGrab(b)});this.shiftManipulator.events.on("drag",function(b){a._onShiftDrag(b)});this._handles.add(this.shiftManipulator.watch("grabbing",function(b){c(a.shiftManipulator,b)},!0));this.rotateManipulator=f.createRotateManipulator(this.view);this.manipulators.add(this.rotateManipulator);
this.rotateManipulator.events.on("grab-changed",function(b){a._onRotateGrab(b)});this.rotateManipulator.events.on("drag",function(b){a._onRotateDrag(b)});this._handles.add(this.rotateManipulator.watch("grabbing",function(b){c(a.rotateManipulator,b)},!0));this.resizeManipulators=this._resizeHandles.map(function(b,N){var k=f.createResizeManipulator(a.view,b);k.events.on("grab-changed",function(b){a._onResizeGrab(b,N)});k.events.on("drag",function(b){a._onResizeDrag(b)});a._handles.add(k.watch("grabbing",
function(a){c(k,a)},!0));return k});this.manipulators.addMany(this.resizeManipulators);var b=f.createOutlineManipulator(this.view),e=b.material;this._previewOutlineManipulator=b.manipulator;this._previewOutlineMaterial=e;this.manipulators.add(this._previewOutlineManipulator,2);this._outlineManipulator=f.createOutlineManipulator(this.view).manipulator;this.manipulators.add(this._outlineManipulator,1);b=f.createGridManipulator(this.view);e=b.material;this._gridManipulator=b.manipulator;this._gridMaterial=
e;this.manipulators.add(this._gridManipulator,2)};c.prototype.destroy=function(){this.detach();this._handles.destroy();this._handles=null;this._viewHandles.destroy();this._viewHandles=null;this._removeFrameTask();this._clearPointerMoveTimeout()};Object.defineProperty(c.prototype,"state",{get:function(){var a=!!this.plane,b=!!this.inputState;return a?a&&b?"slicing":a&&!b?"sliced":"ready":"ready"},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"isSupported",{get:function(){return"3d"===
this.get("view.type")},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"plane",{set:function(a){this._set("plane",a);this.visible&&this.attached&&this.view&&(this._updateLayerViews(),this.view.slicePlane=a,this._updateManipulators(),a&&this._unsetOtherToolPlanes())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"excludedLayers",{get:function(){return this._get("excludedLayers")||new F},set:function(a){this._set("excludedLayers",y.referenceSetter(a,this._get("excludedLayers")))},
enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"excludeGroundSurface",{set:function(a){this._set("excludeGroundSurface",a);this.view&&this._updateLayerViews()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"inputState",{get:function(){return this._get("inputState")},set:function(a){this._set("inputState",a);this._updateMaterials()},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_isTargeting",{get:function(){return!this.inputState&&!this.plane&&
this.active},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_creatingPointerId",{get:function(){return this.inputState&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null},enumerable:!0,configurable:!0});c.prototype.enterExcludeLayerMode=function(){this.created&&(this._set("layersMode","exclude"),w.setActive(this,!0))};c.prototype.exitExcludeLayerMode=function(){this.created&&(this._set("layersMode","none"),w.setActive(this,!1))};c.prototype.deactivate=function(){this._updateMouseCursor();
this._set("layersMode","none");this._updatePreviewPlane(null)};c.prototype.onDetach=function(){this.plane=null;this._set("layersMode","none")};c.prototype.onShow=function(){var a=this;this._updateMouseCursor();this._updateLayerViews();this._updateManipulators();var b=this.view;b.slicePlane=this.plane;0===this._viewHandles.size&&this._viewHandles.add([b.allLayerViews.on("change",function(){a._updateLayerViews()}),this.excludedLayers.on("change",function(){a._updateLayerViews()})])};c.prototype.onHide=
function(){this._updateMouseCursor();this._updateLayerViews();this.view.slicePlane=null;this._viewHandles.removeAll();this._clearPointerMoveTimeout()};c.prototype.onInputEvent=function(a){switch(a.type){case "pointer-down":if(!x(a))break;this._onPointerDown(a)&&(a.stopPropagation(),this._updateMouseCursor());break;case "pointer-drag":if(!x(a))break;this._onPointerDrag(a)&&a.stopPropagation();break;case "pointer-move":this._onPointerMove(a);this._updateMouseCursor();break;case "pointer-up":this._onPointerUp(a)&&
a.stopPropagation();break;case "click":if(!x(a))break;this._onClick(a)&&a.stopPropagation();break;case "drag":this.inputState&&a.stopPropagation();break;case "key-down":this._onKeyDown(a)&&a.stopPropagation();break;case "key-up":this._onKeyUp(a)&&a.stopPropagation()}};c.prototype._updateLayerViews=function(){var a=function(a){return a instanceof u&&!!a.plane&&a.visible},b=a(this.view.activeTool)||this.view.tools.some(a),c=[],e=function(a){"layers"in a?a.layers.forEach(e):c.push(a)};this.excludedLayers.forEach(e);
this.view.allLayerViews.forEach(function(a){"slicePlaneEnabled"in a&&(a.slicePlaneEnabled=b&&0>c.indexOf(a.layer));"componentLayerViews"in a&&a.componentLayerViews.forEach(function(a){a.slicePlaneEnabled=b&&0>c.indexOf(a.layer)})});this.view.basemapTerrain.slicePlaneEnabled=b&&!this.excludeGroundSurface};c.prototype._onPointerDown=function(a){if("exclude"===this.layersMode)return!0;if(this._isTargeting){var b=d.boundedPlane.create();if(this._pickPlane(p.createScreenPointFromEvent(a),!1,this._activeKeyModifiers,
b)){d.boundedPlane.copy(b,this._startPlane);var c=this._calculatePickRay(p.createScreenPointFromEvent(a));this.inputState=B(c,a.pointerId,b.origin,b);this.plane=b;return!0}}return!1};c.prototype._onPointerDrag=function(a){return a.pointerId===this._creatingPointerId?(a=p.createScreenPointFromEvent(a),this.shiftManipulator.events.emit("drag",{action:"start",start:a,screenPoint:a}),!0):!1};c.prototype._onPointerMove=function(a){this._lastCursorPosition.x=a.x;this._lastCursorPosition.y=a.y;this._resetPointerMoveTimeout();
"touch"!==a.pointerType&&this._updatePreviewPlane(p.createScreenPointFromEvent(a),this._activeKeyModifiers)};c.prototype._onPointerUp=function(a){return a.pointerId===this._creatingPointerId?(d.boundedPlane.copy(this.plane,this._startPlane),this.inputState=null,!0):!1};c.prototype._onClick=function(a){var b=this;if("exclude"!==this.layersMode||!this.created)return!1;this.view.hitTest(p.createScreenPointFromEvent(a)).then(function(a){a.results.length?(a=(a=a.results[0])&&a.graphic)&&(a=a.sourceLayer||
a.layer)&&b.excludedLayers.push(a):a.ground.layer?b.excludedLayers.push(a.ground.layer):b.excludeGroundSurface=!0});this._set("layersMode","none");w.setActive(this,!1);return!0};c.prototype._onKeyDown=function(a){return a.key===e.forceVerticalModifier||a.key===e.forceHorizontalModifier?(this._activeKeyModifiers[a.key]=!0,l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0):!1};c.prototype._onKeyUp=function(a){return a.key!==e.forceVerticalModifier&&
a.key!==e.forceHorizontalModifier||!this._activeKeyModifiers[a.key]?!1:(delete this._activeKeyModifiers[a.key],l.isSome(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)};c.prototype._onShiftGrab=function(a){"start"===a.action&&(a=this._calculatePickRay(a.screenPoint),d.boundedPlane.copy(this.plane,this._startPlane),this.inputState=B(a,null,this.shiftManipulator.position,this.plane))};c.prototype._onShiftDrag=function(a){if(this.inputState&&"shift"===
this.inputState.type){a=this._calculatePickRay(a.screenPoint);var b=h.sv3d.get();if(d.plane.intersectRay(this.inputState.shiftPlane,a,b)){a=Math.min((1-Math.abs(g.vec3.dot(this.plane.plane,a.direction)))/.001,1);var b=-d.plane.signedDistance(this._startPlane.plane,b),c=-d.plane.signedDistance(this._startPlane.plane,this.inputState.startPoint);this.inputState.depth=this.inputState.depth*(1-a)+b*a-c;a=g.vec3.copy(h.sv3d.get(),this._startPlane.origin);b=g.vec3.copy(h.sv3d.get(),this._startPlane.plane);
g.vec3.scale(b,b,-this.inputState.depth);g.vec3.add(b,b,a);d.boundedPlane.fromValues(b,this.plane.basis1,this.plane.basis2,this.plane);this.plane=this.plane}}};c.prototype._onRotateGrab=function(a){if("start"===a.action){var b=f.createRotatePlane(this.plane,this.view.renderCoordsHelper,d.plane.create());a=this._calculatePickRay(a.screenPoint);var c=v.vec3f64.create();d.plane.intersectRay(b,a,c)&&(d.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:b,startPoint:c})}};
c.prototype._onRotateDrag=function(a){if(this.inputState&&"rotate"===this.inputState.type){a=this._calculatePickRay(a.screenPoint);var b=h.sv3d.get();if(d.plane.intersectRay(this.inputState.rotatePlane,a,b)){a=this.inputState.rotatePlane;var c=K.calculateInputRotationTransform(this.inputState.startPoint,b,this.plane.origin,a),b=r.mat4.identity(h.sm4d.get());r.mat4.rotate(b,b,c,a);a=g.vec3.transformMat4(h.sv3d.get(),this._startPlane.basis1,b);b=g.vec3.transformMat4(h.sv3d.get(),this._startPlane.basis2,
b);d.boundedPlane.fromValues(this.plane.origin,a,b,this.plane);this.plane=this.plane}}};c.prototype._onResizeGrab=function(a,b){if("start"===a.action){a=this._calculatePickRay(a.screenPoint);var c=h.sv3d.get();d.plane.intersectRay(this.plane.plane,a,c)&&(d.boundedPlane.copy(this.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:b,startPoint:v.vec3f64.clone(c)})}};c.prototype._onResizeDrag=function(a){if(this.inputState&&"resize"===this.inputState.type){a=this._calculatePickRay(a.screenPoint);
var b=h.sv3d.get();d.plane.intersectRay(this.plane.plane,a,b)&&(this.plane=f.resizePlane(this._resizeHandles[this.inputState.activeHandleIdx],this.inputState.startPoint,b,this.view._stage.getCamera(),this._startPlane,this.plane))}};c.prototype._updatePreviewPlane=function(a,b){var c=this;void 0===b&&(b={});var f=this._previewPlane;this._previewPlane=null;if(l.isNone(a))this._removeFrameTask(),this._updateManipulators();else{if(!this.plane&&this.active){var k=l.isSome(f)?f:d.boundedPlane.create(),
f=l.isSome(f)?d.boundedPlane.copy(f,O):null;this._pickPlane(a,!0,b,k)&&(a=e.PREVIEW_FADE_DOT_THRESHOLD,b=!1,l.isSome(f)&&(b=g.vec3.dot(f.plane,k.plane)<a||g.vec3.dot(g.vec3.normalize(h.sv3d.get(),f.basis1),g.vec3.normalize(h.sv3d.get(),k.basis1))<a),b&&(this._baseOpacity=0),this._previewPlane=k)}l.isSome(this._previewPlane)&&l.isNone(this._frameTask)&&0===this._baseOpacity?this._frameTask=H.addFrameTask({update:function(a){c._baseOpacity=Math.min(c._baseOpacity+a.deltaTime/(1E3*e.PREVIEW_FADE_DURATION_SECONDS),
1);c._updateManipulators();1===c._baseOpacity&&c._removeFrameTask()}}):l.isNone(this._previewPlane)&&l.isSome(this._frameTask)&&(this._removeFrameTask(),this._updateManipulators())}};c.prototype._removeFrameTask=function(){l.isSome(this._frameTask)&&(this._frameTask.remove(),this._frameTask=null)};c.prototype._calculatePickRay=function(a){var b=d.ray.create();a=p.screenPointObjectToArray(a,P);d.ray.fromScreen(this.view.state.camera,a,b);g.vec3.normalize(b.direction,b.direction);return b};c.prototype._pickMinResult=
function(a){a=p.screenPointObjectToArray(a,h.sv2d.get());this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector);return this._intersector.results.min};c.prototype._pickPlane=function(a,b,c,d){var k=this._pickMinResult(a);a=h.sv3d.get();if(!k.getIntersectionPoint(a))return!1;var k=k.getTransformedNormal(h.sv3d.get()),l=this.view._stage.getCamera();0<g.vec3.dot(k,l.viewForward)&&g.vec3.scale(k,k,-1);var m=f.calculatePlaneHalfSize(a,l);b=(b?1:-1)*m*e.INITIAL_DEPTH_OFFSET_FRAC;
b=g.vec3.scale(h.sv3d.get(),k,b);g.vec3.add(b,b,a);f.createPlane(b,k,0,m,m,l,c[e.forceVerticalModifier]?"vertical":c[e.forceHorizontalModifier]?"horizontal":null,this.view.renderCoordsHelper,d);return!0};c.prototype._updateMouseCursor=function(){this._set("cursor",null);this._isTargeting||"exclude"===this.layersMode?this._set("cursor","crosshair"):l.isSome(this._creatingPointerId)&&this._set("cursor","grabbing")};c.prototype._clearPointerMoveTimeout=function(){this._prevPointerMoveTimeout&&(this._prevPointerMoveTimeout.remove(),
this._prevPointerMoveTimeout=null)};c.prototype._resetPointerMoveTimeout=function(){var a=this;this._clearPointerMoveTimeout();this.shiftManipulator.state|=t.DidPointerMoveRecentlyFlag;this.rotateManipulator.state|=t.DidPointerMoveRecentlyFlag;this._prevPointerMoveTimeout=this.clock.setTimeout(function(){a.shiftManipulator.state&=~t.DidPointerMoveRecentlyFlag;a.rotateManipulator.state&=~t.DidPointerMoveRecentlyFlag},e.POINTER_MOVE_TIMER_MS)};c.prototype._unsetOtherToolPlanes=function(){var a=this;
this.view.tools.forEach(function(b){b!==a&&b instanceof u&&b._set("plane",null)})};c.prototype._updateManipulators=function(){var a=this;if(!this.disableEngineLayers){var b=this.plane||l.isSome(this._previewPlane)&&this._previewPlane,c=null!=b&&b===this.plane,e=null!=b&&b===this._previewPlane,d=b?f.calculateBoundedPlaneTranslateRotate(b,h.sm4d.get()):null;this.shiftManipulator.visible=c;this.rotateManipulator.visible=c;this.resizeManipulators.forEach(function(a){a.visible=c});c&&(f.updateShiftRestartHandle(this.shiftManipulator,
d,this.plane,this.view.renderCoordsHelper,this.view._stage.getCamera()),f.updateRotateHeadingHandle(this.rotateManipulator,d,this.plane,this.view.renderCoordsHelper),this.resizeManipulators.forEach(function(b,c){f.updateResizeHandle(b,a._resizeHandles[c],d,a.plane)}));this._previewOutlineManipulator.visible=e;this._outlineManipulator.visible=c;this._gridManipulator.visible=!!b;b&&(b=g.vec3.set(h.sv3d.get(),g.vec3.length(b.basis1),g.vec3.length(b.basis2),1),b=r.mat4.fromScaling(h.sm4d.get(),b),b=r.mat4.multiply(b,
d,b),b[12]=0,b[13]=0,b[14]=0,e=g.vec3.set(h.sv3d.get(),d[12],d[13],d[14]),this._previewOutlineManipulator.modelTransform=b,this._previewOutlineManipulator.position=e,this._outlineManipulator.modelTransform=b,this._outlineManipulator.position=e,this._gridManipulator.modelTransform=b,this._gridManipulator.position=e,this._updateMaterials())}};c.prototype._updateMaterials=function(){this._previewOutlineMaterial.setParameterValues({color:[e.PLANE_OUTLINE_COLOR[0],e.PLANE_OUTLINE_COLOR[1],e.PLANE_OUTLINE_COLOR[2],
e.PLANE_OUTLINE_COLOR[3]*this._baseOpacity]});this._gridMaterial.setParameterValues({backgroundColor:[e.PLANE_BACKGROUND_COLOR[0],e.PLANE_BACKGROUND_COLOR[1],e.PLANE_BACKGROUND_COLOR[2],e.PLANE_BACKGROUND_COLOR[3]*this._baseOpacity],gridColor:this.inputState&&"resize"===this.inputState.type?e.GRID_COLOR:[0,0,0,0]})};c.prototype._setSingleManipulatorInteractive=function(a,b){b?(this.shiftManipulator.interactive=this.shiftManipulator===a,this.rotateManipulator.interactive=this.rotateManipulator===a,
this.resizeManipulators.forEach(function(b){b.interactive=b===a})):(this.shiftManipulator.interactive=!0,this.rotateManipulator.interactive=!0,this.resizeManipulators.forEach(function(a){a.interactive=!0}))};var u;n([m.property()],c.prototype,"clock",void 0);n([m.property({constructOnly:!0})],c.prototype,"view",void 0);n([m.property({dependsOn:["plane","inputState"],readOnly:!0})],c.prototype,"state",null);n([m.property({dependsOn:["view.type"],readOnly:!0})],c.prototype,"isSupported",null);n([m.property({readOnly:!0})],
c.prototype,"cursor",void 0);n([m.property({value:null})],c.prototype,"plane",null);n([m.property({readOnly:!0})],c.prototype,"layersMode",void 0);n([m.property({cast:y.castForReferenceSetter})],c.prototype,"excludedLayers",null);n([m.property({type:Boolean,value:!1})],c.prototype,"excludeGroundSurface",null);n([m.property({value:null})],c.prototype,"inputState",null);return c=u=n([m.subclass("esri.views.3d.interactive.analysisTools.slice.SliceTool")],c)}(m.declared(M.InteractiveToolBase));var O=
d.boundedPlane.create(),P=p.createScreenPointArray();return q});