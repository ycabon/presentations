// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/compilerUtils ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/quat ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../manipulatorUtils ./sliceToolConfig ../../../support/geometryUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/materials/ColorMaterial ../../../webgl-engine/materials/NativeLineMaterial ../../../webgl-engine/materials/RibbonLineMaterial ../../../webgl-engine/materials/SlicePlaneMaterial ../../../../interactive/Manipulator3D".split(" "),
function(Y,g,Z,H,I,J,q,K,S,b,t,W,h,w,m,r,v,A,L,T,X,C){function U(a,d,f,c,e,z){var n=b.vec3.dot(a,d),n=Math.abs(n)>h.VERTICAL_DOT_THRESHOLD?"vertical":"horizontal",l=m.sv3d.get(),k=m.sv3d.get(),x=function(){b.vec3.cross(l,d,f.viewUp);b.vec3.cross(k,d,l)},g=function(a){b.vec3.cross(k,a,d);b.vec3.copy(l,d)};if(I.isSome(c)&&c!==n)switch(c){case "vertical":x();break;case "horizontal":g(f.viewUp);break;default:H.neverReached(c)}else switch(n){case "vertical":x();break;case "horizontal":g(a);break;default:H.neverReached(n)}a=
b.vec3.cross(m.sv3d.get(),l,k);0<b.vec3.dot(a,f.viewForward)&&b.vec3.scale(k,k,-1);b.vec3.normalize(e,l);b.vec3.normalize(z,k)}function M(a,d){return Math.abs(b.vec3.dot(d.basis1,a))>Math.abs(b.vec3.dot(d.basis2,a))?1:2}function V(a){return{basis1Positive:{position:b.vec3.add(m.sv3d.get(),a.origin,a.basis1),rotationIdx:0},basis2Positive:{position:b.vec3.add(m.sv3d.get(),a.origin,a.basis2),rotationIdx:1},basis1Negative:{position:b.vec3.subtract(m.sv3d.get(),a.origin,a.basis1),rotationIdx:2},basis2Negative:{position:b.vec3.subtract(m.sv3d.get(),
a.origin,a.basis2),rotationIdx:3}}}function N(a,d,f){var c=f.projectPoint(b.vec3.add(m.sv3d.get(),a,d),J.castRenderScreenPointArray3(m.sv3d.get()));a=f.projectPoint(b.vec3.subtract(m.sv3d.get(),a,d),J.castRenderScreenPointArray3(m.sv3d.get()));return b.vec3.squaredLength(b.vec3.subtract(c,c,a))}function B(a){var d=b.vec3.length(a.basis1);a=b.vec3.length(a.basis2);return h.RESIZE_HANDLE_EDGE_PADDING_FRAC*Math.min(d,a)}function E(a){return 0!==a.direction[0]&&0!==a.direction[1]}function O(a,d,f){var c=
function(e){var c=(e?d:a).slice(0),n=b.vec3.subtract(m.sv3d.get(),c[0],c[1]);b.vec3.normalize(n,n);var l=b.vec3.subtract(m.sv3d.get(),c[c.length-1],c[c.length-2]);b.vec3.normalize(l,l);if(0<f.padding){var k=b.vec3.scale(t.vec3f64.create(),l,-f.padding);c[c.length-1]=b.vec3.add(k,k,c[c.length-1]);f.bothEnds&&(k=b.vec3.scale(t.vec3f64.create(),n,-f.padding),c[0]=b.vec3.add(k,k,c[0]))}var h=e?f.tipFocusMultiplier:1,k=f.tipLength*(f.focusTipLength?h:1),g=f.tipRadius*h,h=q.mat4.identity(m.sm4d.get());
if(0<f.padding){var p=k/4,u=b.vec3.set(m.sv3d.get(),0,p,0),p=1+f.padding/p;q.mat4.translate(h,h,u);q.mat4.scale(h,h,b.vec3.set(m.sv3d.get(),p,p,p));q.mat4.translate(h,h,b.vec3.scale(u,u,-1/p))}p=q.mat4.identity(K.mat4f64.create());u=t.vec3f64.fromValues(0,1,0);l=q.mat4.fromQuat(K.mat4f64.create(),S.quat.rotationTo(m.sq4d.get(),u,l));l[12]=c[c.length-1][0];l[13]=c[c.length-1][1];l[14]=c[c.length-1][2];q.mat4.multiply(l,l,h);e=f.tubeRadius*(e?f.tubeFocusMultiplier:1)+f.padding;var y=f.flat,P=[];if(I.isSome(y))P.push([e,
y.thickness/2],[-e,y.thickness/2],[-e,-y.thickness/2],[e,-y.thickness/2]);else for(y=0;12>y;y++){var w=y/12*2*Math.PI;P.push([Math.cos(w)*e,Math.sin(w)*e])}e=v.createPathExtrusionGeometry(P,c,[],[],!1);e=[{part:"tube",geometry:new r(e,"arrow-tube"),transform:p}];var D;I.isSome(f.flat)?p=new r(v.createExtrudedTriangle(k,g,g,f.flat.thickness),"arrow-tip"):(p=new r(v.createConeGeometry(k,g,24,!1,!1,!0),"arrow-tip"),D=new r(v.createConeGeometry(k,g,24,!1,!0,!1),"arrow-cap"));e.push({part:"tip",geometry:p,
transform:l});D&&e.push({part:"cap",geometry:D,transform:l});f.bothEnds&&(n=q.mat4.fromQuat(K.mat4f64.create(),S.quat.rotationTo(m.sq4d.get(),u,n)),n[12]=c[0][0],n[13]=c[0][1],n[14]=c[0][2],q.mat4.multiply(n,n,h),e.push({part:"tip",geometry:p,transform:n}),D&&e.push({part:"cap",geometry:D,transform:n}));return e};return{normal:c(!1),focused:c(!0)}}function Q(a,d){var f=b.vec3.subtract(t.vec3f64.create(),a[a.length-1],a[a.length-2]);b.vec3.normalize(f,f);b.vec3.scale(f,f,h.ROTATE_HEADING_TIP_LENGTH);
b.vec3.add(f,f,a[a.length-1]);return d?(d=b.vec3.subtract(t.vec3f64.create(),a[0],a[1]),b.vec3.normalize(d,d),b.vec3.scale(d,d,h.ROTATE_HEADING_TIP_LENGTH),b.vec3.add(d,d,a[0]),[d].concat(a,[f])):a.concat([f])}function R(a,d){return Math.abs(b.vec3.dot(a.plane,d))<=h.PERPENDICULAR_GROUND_DOT_THRESHOLD}Object.defineProperty(g,"__esModule",{value:!0});g.createPlane=function(a,d,f,c,e,h,n,l,k){l=l.worldUpAtPosition(a,m.sv3d.get());U(d,l,h,n,k.basis1,k.basis2);b.vec3.scale(k.basis1,k.basis1,c);b.vec3.scale(k.basis2,
k.basis2,e);b.vec3.copy(k.origin,d);b.vec3.scale(k.origin,k.origin,-f);b.vec3.add(k.origin,k.origin,a);return w.boundedPlane.fromValues(k.origin,k.basis1,k.basis2,k)};g.normalToBases=U;g.resizePlane=function(a,d,f,c,e,g){var n=b.vec3.copy(m.sv3d.get(),e.origin);b.vec3.add(n,n,b.vec3.scale(m.sv3d.get(),e.basis1,0>a.direction[0]?1:-1));b.vec3.add(n,n,b.vec3.scale(m.sv3d.get(),e.basis2,0>a.direction[1]?1:-1));var l=b.vec3.length(e.basis1),k=b.vec3.length(e.basis2);f=b.vec3.subtract(m.sv3d.get(),f,n);
var z=b.vec3.subtract(m.sv3d.get(),d,n),q=0;d=0;if(E(a)){var p=B(e),u=B(g),q=l-.5*a.direction[0]*b.vec3.dot(e.basis1,z)/l;d=k-.5*a.direction[1]*b.vec3.dot(e.basis2,z)/k;z=u/p;q*=z;d*=z}z=.5*a.direction[0]*b.vec3.dot(e.basis1,f)/l;p=.5*a.direction[1]*b.vec3.dot(e.basis2,f)/k;f=q+z;d+=p;l=b.vec3.scale(m.sv3d.get(),e.basis1,f/l);e=b.vec3.scale(m.sv3d.get(),e.basis2,d/k);(0>=f||N(g.origin,l,c)<=h.PLANE_MIN_BASIS_SCREEN_LEN2)&&b.vec3.copy(l,g.basis1);(0>=d||N(g.origin,e,c)<=h.PLANE_MIN_BASIS_SCREEN_LEN2)&&
b.vec3.copy(e,g.basis2);c=b.vec3.copy(m.sv3d.get(),n);b.vec3.add(c,c,b.vec3.scale(m.sv3d.get(),l,0>a.direction[0]?-1:1));b.vec3.add(c,c,b.vec3.scale(m.sv3d.get(),e,0>a.direction[1]?-1:1));return w.boundedPlane.fromValues(c,l,e,g)};g.calculatePlaneHalfSize=function(a,d){return h.INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION*Math.min(d.width,d.height)*d.computeRenderPixelSizeAt(a)};g.createShiftPlane=function(a,d,f,c){f=b.vec3.cross(m.sv3d.get(),d,f);b.vec3.cross(f,f,d);return w.plane.fromPositionAndNormal(a,
f,c)};g.calculateBoundedPlaneTranslateRotate=function(a,d){return W.calculateTranslateRotateFromBases(a.basis1,a.basis2,a.origin,d)};g.createRotatePlane=function(a,d,f){var c=d.worldUpAtPosition(a.origin,m.sv3d.get());d=R(a,c);c=M(c,a);d=b.vec3.copy(m.sv3d.get(),d?1===c?a.basis1:a.basis2:a.plane);return w.plane.fromPositionAndNormal(a.origin,d,f)};g.updateShiftRestartHandle=function(a,d,f,c,e){var g=c.worldUpAtPosition(f.origin,m.sv3d.get());c=R(f,g);var g=M(g,f),n=V(f),g=c&&2!==g?n.basis2Positive:
n.basis1Positive;c=m.sm4d.get();q.mat4.rotateZ(c,d,g.rotationIdx*Math.PI/2);d=b.vec3.subtract(m.sv3d.get(),g.position,f.origin);b.vec3.normalize(d,d);d=b.vec3.scale(m.sv3d.get(),d,e.computeScreenPixelSizeAt(g.position)*h.SHIFT_RESTART_OFFSET_DISTANCE);b.vec3.add(d,d,g.position);var g=e.projectPoint(d,J.castRenderScreenPointArray3(m.sv3d.get())),l=e.viewport,n=l[0],k=l[1],x=l[2],l=l[3],r=Math.min(x,l)/16,p=!0;g[0]<n+r?(g[0]=n+r,p=!1):g[0]>n+x-r&&(g[0]=n+x-r,p=!1);g[1]<k+r?(g[1]=k+r,p=!1):g[1]>k+l-
r&&(g[1]=k+l-r,p=!1);n=p;w.ray.fromRender(e,g,F);b.vec3.normalize(F.direction,F.direction);e=m.sv3d.get();!n&&w.boundedPlane.intersectRay(f,F,e)&&(d=e);c[12]=0;c[13]=0;c[14]=0;a.modelTransform=c;a.position=t.vec3f64.clone(d);a.state=n?a.state|G:a.state&~G};g.updateResizeHandle=function(a,d,f,c){var e=b.vec3.length(c.basis1),g=b.vec3.length(c.basis2),h=B(c),l=B(c),k=b.vec3.set(m.sv3d.get(),0,0,0);b.vec3.add(k,b.vec3.scale(m.sv3d.get(),c.basis1,d.direction[0]),b.vec3.scale(m.sv3d.get(),c.basis2,d.direction[1]));
b.vec3.add(k,c.origin,k);c=0;var x=1;E(d)?(1===d.direction[0]&&-1===d.direction[1]?c=Math.PI/2:1===d.direction[0]&&1===d.direction[1]?c=Math.PI:-1===d.direction[0]&&1===d.direction[1]&&(c=3*Math.PI/2),x=l):(d=0!==d.direction[0]?1:2,c=1===d?Math.PI/2:0,x=(1===d?g:e)-h);e=q.mat4.identity(m.sm4d.get());q.mat4.rotateZ(e,e,c);q.mat4.scale(e,e,b.vec3.set(m.sv3d.get(),x,x,x));q.mat4.multiply(e,f,e);e[12]=0;e[13]=0;e[14]=0;a.modelTransform=e;a.position=k};g.updateRotateHeadingHandle=function(a,d,f,c){var e=
c.worldUpAtPosition(f.origin,m.sv3d.get());c=R(f,e);e=M(e,f);f=V(f);f=c&&2!==e?f.basis2Negative:f.basis1Negative;e=q.mat4.identity(m.sm4d.get());q.mat4.rotateZ(e,e,f.rotationIdx*Math.PI/2);c&&q.mat4.rotateX(e,e,Math.PI/2);q.mat4.multiply(e,d,e);e[12]=0;e[13]=0;e[14]=0;a.modelTransform=e;a.position=f.position};g.calculateScreenSpaceBasisLength2=N;g.calculateResizeHandlePadding=B;g.calculateDiagonalResizeHandleScale=function(a){return B(a)};g.isDiagonalResizeHandle=E;g.createShiftManipulator=function(a){var d=
[t.vec3f64.fromValues(0,0,-h.SHIFT_RESTART_ARROW_LENGTH/2),t.vec3f64.fromValues(0,0,h.SHIFT_RESTART_ARROW_LENGTH/2)],f=Q(d,!0),c=function(a,c){return O(d,d,{tubeRadius:h.SHIFT_RESTART_TUBE_RADIUS,tipRadius:h.SHIFT_RESTART_TIP_RADIUS,tipLength:h.SHIFT_RESTART_TIP_LENGTH,tubeFocusMultiplier:h.SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:h.SHIFT_RESTART_TIP_FOCUS_MULTIPLIER,padding:a,bothEnds:!0,flat:null,focusTipLength:!0,addCap:c})},e=c(0,!1),c=c(h.SHIFT_RESTART_ARROW_OUTLINE_WIDTH,!0),b=
new A({color:h.SHIFT_RESTART_ARROW_TIP_COLOR,cullFace:2},"slice-shift");b.renderOccluded=16;var n=new A({color:h.SHIFT_RESTART_ARROW_CAP_COLOR,cullFace:2},"slice-shift");n.renderOccluded=16;var l=new A({color:h.SHIFT_RESTART_TUBE_COLOR,cullFace:2},"slice-shift");l.renderOccluded=16;var k=new A({color:h.SHIFT_RESTART_OUTLINE_COLOR,transparent:!0,writeDepth:!1,cullFace:1},"slice-shift");k.renderOccluded=2;var m=new r(v.createPolylineGeometry([[0,0,0],[-h.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),
q=new r(v.createPolylineGeometry([[0,0,0],[-h.SHIFT_RESTART_OFFSET_DISTANCE,0,0]]),"slice-rotate-heading"),p=new L({color:h.SHIFT_RESTART_CALLOUT_COLOR},"slice-rotate-heading");p.renderOccluded=4;return new C.Manipulator3D({view:a,renderObjects:e.normal.map(function(a){var d=a.part;return{geometry:a.geometry,material:"tip"===d?b:"cap"===d?n:l,transform:a.transform,stateMask:1|g.DidPointerMoveRecentlyFlag}}).concat(c.normal.map(function(a){return{geometry:a.geometry,material:k,transform:a.transform,
stateMask:1|g.DidPointerMoveRecentlyFlag}}),[{geometry:m,material:p,stateMask:1|g.DidPointerMoveRecentlyFlag|G}],e.focused.map(function(a){var d=a.part;return{geometry:a.geometry,material:"tip"===d?b:"cap"===d?n:l,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),c.focused.map(function(a){return{geometry:a.geometry,material:k,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),[{geometry:q,material:p,stateMask:2|g.DidPointerMoveRecentlyFlag|G}]),autoScaleRenderObjects:!1,
collisionType:{type:"line",paths:[f]},collisionPriority:1,radius:h.SHIFT_RESTART_TIP_RADIUS,snapToPointer:!1,moveOnDrag:!1,state:g.DidPointerMoveRecentlyFlag})};g.createRotateManipulator=function(a){var d=.1*Math.PI,f=1.7*Math.PI,c=h.ROTATE_HEADING_DISC_RADIUS,b=c*h.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,m=h.ROTATE_HEADING_DISC_ARROW_RADIUS*h.ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER,n=h.ROTATE_HEADING_OFFSET_DISTANCE,l=function(a){for(var c=[],b=0;32>b;b++){var e=Math.PI+d+(f-d)*b/31;c.push(t.vec3f64.fromValues(n+
a*Math.cos(e),a*Math.sin(e),0))}return c},k=l(h.ROTATE_HEADING_DISC_ARROW_RADIUS),l=l(m),m=Q(k,!1),k=O(k,l,{tubeRadius:h.ROTATE_HEADING_TUBE_RADIUS,tipRadius:h.ROTATE_HEADING_TIP_RADIUS,tipLength:h.ROTATE_HEADING_TIP_LENGTH,tubeFocusMultiplier:h.ROTATE_HEADING_TUBE_FOCUS_MULTIPLIER,tipFocusMultiplier:h.ROTATE_HEADING_TIP_FOCUS_MULTIPLIER,padding:0,bothEnds:!1,flat:{thickness:2},focusTipLength:!0,addCap:!0}),q=new A({color:h.ROTATE_HEADING_ARROW_COLOR,cullFace:2},"slice-rotate-heading");q.renderOccluded=
16;var l=new r(v.createPolylineGeometry([[0,0,0],[n-c,0,0]]),"slice-rotate-heading"),w=new r(v.createPolylineGeometry([[0,0,0],[n-b,0,0]]),"slice-rotate-heading"),p=new L({color:h.ROTATE_HEADING_CALLOUT_COLOR},"slice-rotate-heading");p.renderOccluded=4;var u=t.vec3f64.fromValues(0,0,1),y=t.vec3f64.fromValues(n,0,0),c=new r(v.createCylinderGeometry(1,c,32,u,y),"slice-rotate-heading"),b=new r(v.createCylinderGeometry(1,b,32,u,y),"slice-rotate-heading"),u=new A({color:h.ROTATE_HEADING_DISC_COLOR,transparent:!0,
writeDepth:!1,cullFace:2},"slice-rotate-heading");u.renderOccluded=16;return new C.Manipulator3D({view:a,renderObjects:k.normal.map(function(a){return{geometry:a.geometry,material:q,transform:a.transform,stateMask:1|g.DidPointerMoveRecentlyFlag}}).concat([{geometry:c,material:u,stateMask:1|g.DidPointerMoveRecentlyFlag},{geometry:l,material:p,stateMask:1|g.DidPointerMoveRecentlyFlag}],k.focused.map(function(a){return{geometry:a.geometry,material:q,transform:a.transform,stateMask:2|g.DidPointerMoveRecentlyFlag}}),
[{geometry:b,material:u,stateMask:2|g.DidPointerMoveRecentlyFlag},{geometry:w,material:p,stateMask:2|g.DidPointerMoveRecentlyFlag}]),autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[m]},collisionPriority:1,radius:h.ROTATE_HEADING_TIP_RADIUS,snapToPointer:!1,moveOnDrag:!1,state:g.DidPointerMoveRecentlyFlag})};g.createOutlineManipulator=function(a){var d=new r(v.createPolylineGeometry([[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]),"slice-outline"),b=h.PLANE_OUTLINE_COLOR.slice(),b=new T({color:b,
writeDepth:!1,width:h.PLANE_OUTLINE_WIDTH},"slice-outline");b.renderOccluded=4;return{manipulator:new C.Manipulator3D({view:a,renderObjects:[{geometry:d,material:b}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:b}};g.createGridManipulator=function(a){var b=new r(v.createSquareGeometry(),"slice-grid"),f=h.PLANE_BACKGROUND_COLOR.slice(),f=new X({backgroundColor:f,gridColor:h.GRID_COLOR,gridWidth:4},"slice-grid");f.renderOccluded=4;return{manipulator:new C.Manipulator3D({view:a,
renderObjects:[{geometry:b,material:f}],interactive:!1,autoScaleRenderObjects:!1,worldSized:!0}),material:f}};g.createResizeManipulator=function(a,b){var d=(b=E(b))?[t.vec3f64.fromValues(1,0,0),t.vec3f64.fromValues(0,0,0),t.vec3f64.fromValues(0,1,0)]:[t.vec3f64.fromValues(1,0,0),t.vec3f64.fromValues(-1,0,0)],c=new r(v.createPolylineGeometry(d),"slice-resize"),e=h.HANDLE_COLOR.concat([1]),g=function(a){a=new T({color:e,width:a},"slice-resize");a.renderOccluded=4;return a},m=function(){var a=new L({color:e},
"slice-resize");a.renderOccluded=4;return a},l=b?h.RESIZE_HANDLE_CORNER_WIDTH:h.RESIZE_HANDLE_EDGE_WIDTH,k=l*h.DISPLAY_FOCUS_MULTIPLIER;return new C.Manipulator3D({view:a,renderObjects:[{geometry:c,material:1<l?g(l):m(),stateMask:1},{geometry:c,material:1<k?g(k):m(),stateMask:2}],collisionType:{type:"line",paths:[d]},autoScaleRenderObjects:!1,worldSized:!0,radius:b?h.RESIZE_HANDLE_CORNER_INPUT_RADIUS:h.RESIZE_HANDLE_EDGE_INPUT_RADIUS,snapToPointer:!1,moveOnDrag:!1})};g.createArrowGeometry=O;g.addArrowTips=
Q;g.isAlwaysDrapedLayer=function(a){switch(a.type){case "building-scene":case "csv":case "feature":case "geo-rss":case "geojson":case "graphics":case "group":case "integrated-mesh":case "kml":case "map-notes":case "point-cloud":case "route":case "scene":case "stream":case "unknown":case "unsupported":case null:return!1;case "base-dynamic":case "base-elevation":case "base-tile":case "bing-maps":case "elevation":case "imagery":case "imagery-tile":case "map-image":case "open-street-map":case "tile":case "vector-tile":case "web-tile":case "wms":case "wmts":return!0;
default:return H.neverReached(a.type),!1}};g.DidPointerMoveRecentlyFlag=16;var G=32,F=w.ray.create()});