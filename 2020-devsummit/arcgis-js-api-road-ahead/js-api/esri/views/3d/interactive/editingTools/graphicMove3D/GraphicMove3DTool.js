// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../manipulatorDragUtils ../manipulatorUtils ../settings ../visualElementUtils ./isSupportedGraphic ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ../../../layers/graphics/GraphicState ../../../../interactive/InteractiveToolBase".split(" "),
function(p,l,m,z,q,A,B,r,C,t,k,D,E,F,u,G,v,H,I,J,w,K,L,M,N){Object.defineProperty(l,"__esModule",{value:!0});var x=function(){return function(e){this.allGraphics=e;this.type="graphic-move-start"}}();l.GraphicMoveStartEvent=x;var y=function(){return function(e,a,b,f){this.dx=e;this.dy=a;this.dz=b;this.allGraphics=f;this.type="graphic-move"}}();l.GraphicMoveEvent=y;var n=function(){return function(e){this.allGraphics=e;this.type="graphic-move-stop"}}();l.GraphicMoveStopEvent=n;p=function(e){function a(b){b=
e.call(this,b)||this;b.graphics=new A;b.enableZ=!0;b.type="move-3d";b._toolHandles=new r;b._handles=new r;return b}z(a,e);a.prototype.initialize=function(){var b=this;this._toolHandles.add([this.graphics.on("change",function(){b._refreshManipulators()}),v.settings.zManipulator.watch(v.settings.zManipulator.keys(),function(){return b._refreshManipulators()})]);this._refreshManipulators()};a.prototype.destroy=function(){this._handles.destroy();this._handles=null;this._toolHandles.destroy();this._toolHandles=
null;this.graphics.removeAll();this._set("view",null)};a.prototype.reset=function(){};a.prototype._refreshManipulators=function(){var b=this;this._handles.removeAll();this._moveManipulation&&this._moveManipulation.destroy();this.manipulators.removeAll();var f=this.graphics.toArray().filter(function(b){return 0===I.isSupportedGraphic(b)}).map(function(b){return new O(b)});f.length&&(this.createManipulators(f),this.createVisualElements(f),this._handles.add(f.map(function(f){return b.view.trackGraphicState(f.state)})))};
a.prototype.createManipulators=function(b){for(var f=this,a=function(a){var c=a.state;a.manipulationXY=new L.MoveXYGraphicManipulation({tool:g,view:g.view,graphicState:c});a.manipulationXY.forEachManipulator(function(b){return f._handles.add(b.events.on("immediate-click",function(b){f.emit("immediate-click",q({},b,{graphic:c.graphic}));b.stopPropagation()}))});g._handles.add(a.manipulationXY.createDragPipeline(function(c,a,d){return f.buildDragEventPipeline(c,a,d,b)}))},g=this,d=0;d<b.length;d++)a(b[d]);
this.createMoveManipulation(b)};a.prototype.createMoveManipulation=function(b){var f=this,a=new w.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===b.length?w.MoveManipulation.radiusForSymbol(b[0].graphic.symbol):J.DISC_RADIUS_SMALL});this._moveManipulation=a;a.elevationInfo={mode:"absolute-height",offset:0};a.forEachManipulator(function(b){f._handles.add(b.events.on("immediate-click",function(c){a.zManipulation.hasManipulator(b)||
1!==f.graphics.length||f.emit("immediate-click",q({},c,{graphic:f.graphics.getItemAt(0)}));c.stopPropagation()}))});for(var g=function(){return f.updateMoveManipulation(b)},d=0;d<b.length;d++){var h=b[d];this._handles.add([h.state.on("changed",g),h.state.watch("displaying",g)])}var c=b[b.length-1];this._handles.add(c.state.on("changed",function(){return f.updateMoveManipulationAngle(c)}));this._handles.add(a.createDragPipeline(function(c,a,d){f.buildDragEventPipeline(c,a,d,b)},E.getGraphicEffectiveElevationInfo(c.graphic),
t.expect(c.graphic.geometry).spatialReference));g();this.updateMoveManipulationAngle(c)};a.prototype.createVisualElements=function(b){for(var a=this,e=function(b){g._handles.add(H.createVisualElements({view:g.view,graphic:b.graphic,forEachManipulator:function(c){b.manipulationXY.forEachManipulator(c);a._moveManipulation.forEachManipulator(c)},onManipulatorsChanged:function(){return C.makeHandle()}}))},g=this,d=0;d<b.length;d++)e(b[d])};a.prototype.updateMoveManipulationAngle=function(b){this._moveManipulation.angleDeferred=
function(){return K.primaryShapeOrientation(b.graphic.geometry)}};a.prototype.updateMoveManipulation=function(b){for(var a=D.makeDehydratedPoint(0,0,0,this.view.spatialReference),e=0,g=!1,d=this._moveManipulation,h=0;h<b.length;h++){var c=b[h];c.state.displaying&&(c=c.state.graphic,this.enableZ&&G.canMoveZ(c)&&(g=!0),c=F.getGraphicAttachmentOrigin(this.view,c),t.isSome(c)&&(a.x+=c.x,a.y+=c.y,a.z+=c.z,e++))}0<e?(a.x/=e,a.y/=e,a.z/=e,d.location=a,d.xyManipulation.available=!0,d.xyAxisManipulation.available=
!0,d.zManipulation.available=g):d.available=!1};a.prototype.buildDragEventPipeline=function(a,f,e,g){var b=this,h=[],c=[],k=null,l=null,m=function(){for(var b=0;b<h.length;b++)h[b].dragging=!1;h.length=0;c.length=0;l=k=null};f.next(function(f){if("start"===f.action){h.length=0;for(var e=c.length=0;e<g.length;e++){var d=g[e];d.dragging||!d.manipulationXY.hasManipulator(a)&&d.manipulationXY.grabbing||(h.push(d),c.push(d.graphic),d.dragging=!0)}0!==c.length&&(k=u.dragGraphicMany(c),l=u.resetGraphicMany(c),
b.emit("graphic-move-start",new x(c)))}return 0!==c.length?f:null}).next(function(b){return k(b)}).next(function(a){switch(a.action){case "start":case "update":(a.translationX||a.translationY||a.translationZ)&&b.emit("graphic-move",new y(a.translationX,a.translationY,a.translationZ,c));break;case "end":b.emit("graphic-move-stop",new n(c)),m()}});e.next(function(a){return l(a)}).next(function(){b.emit("graphic-move-stop",new n(c));m()})};m([k.property({constructOnly:!0,nonNullable:!0})],a.prototype,
"view",void 0);m([k.property({readOnly:!0})],a.prototype,"graphics",void 0);m([k.property({constructOnly:!0,nonNullable:!0})],a.prototype,"enableZ",void 0);m([k.property({readOnly:!0})],a.prototype,"type",void 0);return a=m([k.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMove3DTool")],a)}(k.declared(B.EventedMixin(N.InteractiveToolBase)));l.GraphicMove3DTool=p;var O=function(){function e(a){this.manipulationXY=this.geometryRepresentation=this.state=null;this.dragging=!1;this.state=
new M.GraphicState({graphic:a})}Object.defineProperty(e.prototype,"graphic",{get:function(){return this.state.graphic},enumerable:!0,configurable:!0});return e}()});