// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/assignHelper ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/math/common ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../manipulatorDragUtils ../manipulations/config ../../../support/geometryUtils ../../../support/mathUtils ../../../support/stack ../../../webgl-engine/lib/Geometry ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/materials/ColorMaterial".split(" "),
function(E,F,ca,da,ea,fa,K,L,M,G,n,N,H,O,w,P,p,y,Q,R,S,A,B,e,r,T,k,I,C,U){function V(a,b){var d=p.vec3.subtract(k.sv3d.get(),b.renderStart,a.origin);a=p.vec3.subtract(k.sv3d.get(),b.renderEnd,a.origin);d=p.vec3.length(d);a=p.vec3.length(a);return 0===d?0:a/d}function W(a,b){var d=a.allLayerViews.find(function(d){return d.layer===b.layer});if(n.isNone(b.symbol))return null;var f=b.symbol;return{symbolLayers:f.symbolLayers.map(function(b){var a=null,e=null;"object"===b.type&&(a=b.heading);e=d.getSymbolLayerSize(f,
b);return{heading:a,size:e}}).toArray()}}function X(a,b,d,f){a.symbolLayers.forEach(function(a,e){var c=b.symbolLayers[e];e=c.heading;c=c.size;"object"===a.type&&(a.heading=(n.isSome(e)?e:0)-Q.toDegree(d),n.isSome(c)&&"width"in c&&(a.width=c.width*f,a.depth=c.depth*f,a.height=c.height*f))})}function Y(a,b,d,f){var c=a.renderStart;a=a.renderEnd;var h=z(c,f,k.sv3d.get());a=z(a,f,k.sv3d.get());if(p.vec3.squaredDistance(h,a)<e.DRAG_THRESHOLD_PX*e.DRAG_THRESHOLD_PX)return null;var n=p.vec3.subtract(k.sv3d.get(),
c,d);b=p.vec3.cross(k.sv3d.get(),n,b);c=p.vec3.add(k.sv3d.get(),c,b);d=z(d,f,k.sv3d.get());f=z(c,f,k.sv3d.get());c=p.vec3.subtract(k.sv3d.get(),f,h);f=p.vec3.subtract(k.sv3d.get(),h,d);h=r.ray.wrap(h,c);f=r.ray.wrap(d,f);return r.ray.distance2(h,a)<r.ray.distance2(f,a)?"rotate":"scale"}function z(a,b,d){a=b.projectPoint(a,H.castRenderScreenPointArray(Z));b=b.renderToScreen(a,aa);return p.vec3.set(d,b[0],b[1],0)}function J(a,b){var d=null,c=1,D=function(){return c};return{start:function(){c=a.getScale();
d=a.getScale;a.getScale=D;b()},update:function(d){c+=((c+1)/2-c)*Math.min(d*e.RING_RESET_ANIMATION_SPEED_FACTOR,1);b();return.01>Math.abs(c-1)?1:0},destroy:function(){a.getScale=d;b()}}}function ba(a,b){var d=0,c=null,D=function(){return!1};return{start:function(){c=a.getFocused;a.getFocused=D;d=0;b()},update:function(b){d+=b;return!c()||d>e.RING_INDICATOR_DELAY_MS?1:0},destroy:function(){a.getFocused=c;b()}}}Object.defineProperty(F,"__esModule",{value:!0});var c;(function(a){a.ScaleIn=32;a.ScaleOut=
64;a.RotateLeft=128;a.RotateRight=256;a.Unlocked=1024;a.DelayedFocused=2048;a.TouchInput=32768})(c||(c={}));E=function(){function a(b){var d=this;this.mode=null;this._handles=new M;this._activeAnimation=this._scaleRotateDragData=null;this.events=new L;this.getFocused=function(){return d.ringManipulator.focused};this.getScale=function(){return n.isSome(d._scaleRotateDragData)&&"scale"===d._scaleRotateDragData.mode?d._scaleRotateDragData.scale:1};this.tool=b.tool;this.mode=b.mode;this.createManipulator();
this.updateDragState();this.updateManipulatorTransform()}a.prototype.destroy=function(){n.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null);this._handles.removeAll();this.tool.manipulators.remove(this.ringManipulator);this.ringManipulator=null};a.prototype.startAnimation=function(b){var d=this;this.cancelActiveAnimation();b.start();var a=N.addFrameTask({update:function(a){b.update(a.deltaTime)&&d.cancelActiveAnimation()}});this._activeAnimation=K({},
b,{frameTask:a})};a.prototype.cancelActiveAnimation=function(){n.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)};a.prototype.forEachManipulator=function(b){b(this.ringManipulator,2)};a.prototype.createManipulator=function(){var b=this;this.ringManipulator=this.createRingManipulator();this.tool.manipulators.add(this.ringManipulator);var a=this.tool.graphicState.graphic,c=B.createManipulatorDragEventPipeline(this.ringManipulator,
function(c,d,f){b._scaleRotateDragData=null;var h=W(b.tool.view,a);if(n.isNone(h))return b.updateDragState(),null;var g={mode:"none",origin:y.vec3f64.clone(c.renderLocation),angle:0,startAngle:b.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:h};b._scaleRotateDragData=g;b.updateDragState();h=k.sv3d.get();b.tool.view.renderCoordsHelper.worldUpAtPosition(c.renderLocation,h);d.next(B.screenToRenderPlane(b.tool.view,r.plane.fromPositionAndNormal(c.renderLocation,h))).next(function(c){var d=
A.calculateInputRotationTransform(c.renderStart,c.renderEnd,g.origin,c.plane),f=T.cyclicalPI.shortestSignedDiff(g.angle,d);g.angleDir=G.clamp(g.angleDir+f,-e.ROTATE_INDICATOR_DIRECTION_BUFFER,e.ROTATE_INDICATOR_DIRECTION_BUFFER);g.angle=d;d=V(g,c);g.scaleDir=G.clamp(g.scaleDir+(d-g.scale),-e.SCALE_INDICATOR_DIRECTION_BUFFER,e.SCALE_INDICATOR_DIRECTION_BUFFER);g.scale=d;b.onScaleChanged();if("none"===g.mode&&(d=b.mode||Y(c,c.plane,g.origin,b.tool.view.state.camera),n.isSome(d))){switch(d){case "rotate":b.tool.emit("graphic-rotate-start",
{graphic:a,angle:g.angle});break;case "scale":b.tool.emit("graphic-scale-start",{graphic:a,scale:g.scale})}g.mode=d}b.updateDragState();if(n.isSome(a.symbol)){var d=a.symbol.clone(),f=0,h=1;switch(g.mode){default:case "none":break;case "scale":h=g.scale;break;case "rotate":f=g.angle}X(d,g.startSymbolData,f,h);a.symbol=d;b.updateManipulatorTransform()}switch(c.action){case "start":case "update":switch(g.mode){case "rotate":b.tool.emit("graphic-rotate",{graphic:a,angle:g.angle});break;case "scale":b.tool.emit("graphic-scale",
{graphic:a,scale:g.scale})}break;case "end":switch(g.mode){case "rotate":b.tool.emit("graphic-rotate-stop",{graphic:a,angle:g.angle});break;case "scale":b.tool.emit("graphic-scale-stop",{graphic:a,scale:g.scale})}}"end"===c.action&&(b.startAnimation(J(b,function(){return b.onScaleChanged()})),b._scaleRotateDragData=null,b.updateDragState())});f.next(B.resetSymbol(a)).next(function(){if(n.isSome(b._scaleRotateDragData)){switch(b._scaleRotateDragData.mode){case "rotate":b.tool.emit("graphic-rotate-stop",
{graphic:a,angle:b._scaleRotateDragData.startAngle});break;case "scale":b.tool.emit("graphic-scale-stop",{graphic:a,scale:1})}b.startAnimation(J(b,function(){return b.onScaleChanged()}));b._scaleRotateDragData=null}})});this._handles.add(c);this._handles.add([this.ringManipulator.events.on("focus-changed",function(a){"focus"===a.action?b.startAnimation(ba(b,function(){return b.updateDelayedFocusedState()})):b.updateDelayedFocusedState()}),this.ringManipulator.events.on("immediate-click",function(b){b.stopPropagation()}),
O.init(this.tool.graphicState,"displaying",function(a){return b.ringManipulator.available=a}),this.tool.graphicState.on("changed",function(){return A.placeAtGraphic(b.tool.view,b.ringManipulator,a)})]);A.placeAtGraphic(this.tool.view,this.ringManipulator,a)};a.prototype.onScaleChanged=function(){this.events.emit("scale-changed");this.updateManipulatorTransform()};a.prototype.updateDelayedFocusedState=function(){this.ringManipulator.updateStateEnabled(c.DelayedFocused,this.getFocused())};a.prototype.updateDragState=
function(){this.ringManipulator.updateStateEnabled(c.Unlocked,!(n.isSome(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode));if(n.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this.ringManipulator.updateStateEnabled(c.ScaleIn|c.ScaleOut,!1);this.ringManipulator.updateStateEnabled(c.RotateLeft,0>this._scaleRotateDragData.angleDir);this.ringManipulator.updateStateEnabled(c.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this.ringManipulator.updateStateEnabled(c.RotateLeft|
c.RotateRight,!1),this.ringManipulator.updateStateEnabled(c.ScaleIn,0>this._scaleRotateDragData.scaleDir),this.ringManipulator.updateStateEnabled(c.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this.ringManipulator.updateStateEnabled(c.ScaleIn|c.ScaleOut|c.RotateLeft|c.RotateRight,!1)};a.prototype.updateManipulatorTransform=function(){var b=w.mat4.identity(k.sm4d.get());w.mat4.rotate(b,b,this.tool.symbolRotationAngle,y.vec3f64.fromValues(0,0,1));var a=this.getScale(),a=w.mat4.fromScaling(k.sm4d.get(),
p.vec3.set(k.sv3d.get(),a,a,a)),c=w.mat4.identity(k.sm4d.get());w.mat4.multiply(c,a,b);this.ringManipulator.modelTransform=c};a.prototype.createRingManipulator=function(){for(var b=function(a,b,c){for(var d=[],f=Math.ceil(e.GEOMETRY_SEGMENTS*(b-a)/(2*Math.PI)),g=0;g<f+1;g++){var h=a+g*(b-a)/f;d.push(y.vec3f64.fromValues(c*Math.cos(h),c*Math.sin(h),0))}return d},a=function(a){return b(0,2*Math.PI,a)},f=function(a,b){return new I(C.createPathExtrusionGeometry([[-b/2,0],[b/2,0],[b/2,e.RING_HEIGHT/2],
[-b/2,e.RING_HEIGHT/2]],a,[],[],!1),"graphic-transform-ring")},k=a(e.RING_RADIUS),h=f(k,e.RING_THICKNESS),n=[],p=[],g=[],t=0;2>t;t++){var m=t*Math.PI-Math.PI/4,l=Math.PI/2-e.ROTATE_INDICATOR_ARC_LENGTH,u=m+l,m=m+Math.PI/2-l,l=b(u,m,e.INNER_INDICATOR_RADIUS),v=f(l,e.INDICATOR_THICKNESS);g.push(l);g.push(b(u,m,e.OUTER_INDICATOR_RADIUS-e.RING_THICKNESS/2));n.push(v);p.push(v);for(v=0;2>v;v++){var r=0===v,q=P.mat4f64.create();if(r){w.mat4.scale(q,q,[1,-1,1]);w.mat4.rotate(q,q,-u,[0,0,1]);var x=Math.round(e.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*
(l.length-1))}else w.mat4.rotate(q,q,m,[0,0,1]),x=Math.round((1-e.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(l.length-1));q[12]=l[x][0];q[13]=l[x][1];q[14]=l[x][2];x=C.createExtrudedTriangle(e.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,e.ROTATE_INDICATOR_ARROW_TIP_RADIUS,e.RING_HEIGHT);C.transformInPlace(x,q);q=new I(x,"graphic-transform-ring-rotate");(r?n:p).push(q)}}v=[];for(t=0;2>t;t++)m=t*Math.PI-Math.PI/4,l=Math.PI/2-e.SCALE_INDICATOR_ARC_LENGTH,u=m+l,m=m+Math.PI/2-l,l=b(u,m,e.OUTER_INDICATOR_RADIUS),
v.push(f(l,e.INDICATOR_THICKNESS));t=a(e.RING_RADIUS+e.SCALE_INDICATOR_OFFSET1);u=a(e.RING_RADIUS+e.SCALE_INDICATOR_OFFSET2);t=f(t,e.INDICATOR_THICKNESS);u=f(u,e.INDICATOR_THICKNESS);m=a(e.RING_RADIUS-e.SCALE_INDICATOR_OFFSET1);l=a(e.RING_RADIUS-e.SCALE_INDICATOR_OFFSET2);a=f(m,e.INDICATOR_THICKNESS);f=f(l,e.INDICATOR_THICKNESS);m=this.createMaterial();l=this.createMaterial(.66);q=this.createMaterial(.5);r=this.createMaterial(.33);h=[{geometry:h,material:m,stateMask:c.DelayedFocused},{geometry:h,
material:q,stateMask:0}];this.mode&&"scale"!==this.mode||(h=h.concat([{geometry:v,material:m,stateMask:c.DelayedFocused|c.Unlocked},{geometry:t,material:l,stateMask:c.DelayedFocused|c.ScaleIn},{geometry:u,material:r,stateMask:c.DelayedFocused|c.ScaleIn},{geometry:a,material:l,stateMask:c.DelayedFocused|c.ScaleOut},{geometry:f,material:r,stateMask:c.DelayedFocused|c.ScaleOut}]));this.mode&&"rotate"!==this.mode||(h=h.concat([{geometry:p,material:m,stateMask:c.DelayedFocused|c.Unlocked},{geometry:n,
material:m,stateMask:c.DelayedFocused|c.RotateLeft},{geometry:p,material:m,stateMask:c.DelayedFocused|c.RotateRight}]));k=[k].concat(g);return new S.Manipulator3D({view:this.tool.view,renderObjects:h,autoScaleRenderObjects:!1,worldOriented:!0,radius:e.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:R.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:k,direction:y.vec3f64.fromValues(0,0,1)}})};a.prototype.createMaterial=function(a){void 0===
a&&(a=1);var b=e.HANDLE_COLOR.concat([a]);a=new U({color:b,transparent:1!==a,cullFace:2},"graphic-transform");a.renderOccluded=2;return a};Object.defineProperty(a.prototype,"test",{get:function(){return{ringManipulator:this.ringManipulator}},enumerable:!0,configurable:!0});return a}();F.GraphicScaleRotateTransform=E;var Z=y.vec3f64.create(),aa=H.createScreenPointArray()});