// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/assignHelper ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Color ../../../Graphic ../../../core/Collection ../../../core/has ../../../core/Logger ../../../core/MapUtils ../../../core/mathUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/workers ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeOnDemand ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./I3SMeshViewLabeler ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SIntersectionHandler ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/layerViewUpdatingProperties ../support/debugFlags ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl ../webgl-engine/lib/Texture ../webgl-engine/lib/TextureBackedBuffer/BufferManager @dojo/framework/shim/Promise".split(" "),
function(Z,r,E,aa,n,ba,ca,da,F,ea,fa,ga,J,G,g,x,ha,K,ia,ja,ka,k,la,ma,L,M,N,na,y,oa,O,pa,P,qa,ra,sa,ta,Q,R,ua,va,wa,xa,h,ya,H,za,I,Aa,B,Ba,Ca,A,Da,S,Ea){function T(g){var h=g.metallicRoughness;return h&&0<=h.baseColorTextureId||h&&0<=h.metallicRoughnessTextureId||0<=g.normalTextureId||0<=g.emissiveTextureId||0<=g.occlusionTextureId}function U(h){return g.isSome(h)&&K.isArrayBuffer(h.data)}function V(h,k){for(var c=1024,a=0;a<h.length;a++)var b=h[a],c=c+(b.interleavedVertexData.byteLength+(b.indices?
b.indices.byteLength:0)),c=c+(b.positionData.data.byteLength+b.positionData.indices.byteLength);if(g.isSome(k))for(h=0;h<k.length;h++)a=k[h],g.isSome(a)&&K.isArrayBuffer(a.data)&&(c+=a.data.byteLength);return c}function W(g,h){return 104857600<h.byteSize?(u.warn("Node is too big to store in IndexedDB cache: "+g.id+" ("+h.byteSize+" bytes)"),!1):0<h.byteSize}Object.defineProperty(r,"__esModule",{value:!0});var u=ga.getLogger("esri.views.3d.layers.SceneLayerView3D"),X=[1,1,1,1],Fa=function(){return function(g,
h,c,a,b,d,e){this.node=g;this.featureIds=h;this.objectHandle=c;this.cachedRendererVersion=a;this.attributeInfo=b;this.material=d;this.textures=e;this.cachedEdgeMaterials=[];this.cachedSymbology=null}}();r.I3SMeshView3D=function(r){return function(r){function c(){var a=null!==r&&r.apply(this,arguments)||this;a._elevationProvider=null;a._intersectionHandler=null;a._worker=new Q;a._workerThread=null;a._nodeId2Meta=new Map;a._addTasks=new Map;a._rendererVersion=0;a._colorVariable=null;a._opacityVariable=
null;a._rendererFields=null;a._symbologyFields=null;a._symbologyOverride=null;a._symbologyOverrideFields=null;a._symbolInfos=new Map;a._idbCache=new ya.IDBCache("esri-scenelayer-cache","geometries");a._labeler=null;a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._layerUrl="";a._cacheKeySuffix=null;a._arcade=null;a._tmpAttributeOnlyGraphic=new F(null,null,{});return a}aa(c,r);Object.defineProperty(c.prototype,"layerUid",{get:function(){return this.layer&&this.layer.uid},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"sublayerUid",{get:function(){return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||g.isSome(this._labeler)&&this._labeler.updating},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?
"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendererTextureUsage",{get:function(){return h.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.layer?this.layer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=ia.getMetersPerVerticalUnitForSR(this.layer.spatialReference),d=sa.getMetersPerUnit(a.unit);return g.unwrapOr(a.offset,
0)*d/b}return 0},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useCompressedTextures",{get:function(){var a=this.layer.version,a=!fa("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.renderView.has("s3tc")&&a},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;ka.open("SceneLayerWorker").then(function(b){a.destroyed?b.close():a._workerThread=b});h.checkSceneLayerValid(this.layer);h.checkSceneLayerCompatibleWithView(this.layer,this.view);this._layerUrl=this.layer.parsedUrl.path;this._controller=new oa({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=
this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._collection=this._stage.renderView.componentObjectCollection;this._highlights=new ua({collection:this._collection,forAllFeatures:function(b){return a._forAllFeatures(b,null,1)},forAllFeaturesOfNode:function(b,e){return a._forAllFeaturesOfNode(b,e)}});if(this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var b=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(b&&b.faceRange&&
b.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(b){return a._deleteComponentObject(b)});this._intersectionHandler=new xa.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,
slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(b){return a._nodeId2Meta.forEach(function(a){return b(a.node,a.objectHandle)})}});this._elevationProvider=new va({layerView:this,intersectionHandler:this._intersectionHandler});this.updatingHandles.add(this,"view.clippingArea",function(){return a._clippingAreaChanged()},2);this.updatingHandles.add(this,"fullOpacity",function(b){return a._opacityChange(b)});this.updatingHandles.add(this,"slicePlaneEnabled",function(b){return a._slicePlaneEnabledChange(b)});
this.updatingHandles.add(this,"elevationOffset",function(b,e){return a._reloadAll(e)});this.updatingHandles.add(this,"filter",function(){return a._filterChange()},2);this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",function(){return a._updatePBR()});b=function(){a._reloadAll();a._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",b);this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",b);this.updatingHandles.add(this,"suspended",
function(b){return a._suspendedChange(b)},2);this.updatingHandles.add(this.layer,"labelsVisible",function(){return a._labelingChanged()},2);this.updatingHandles.add(this.layer,"labelingInfo",function(){return a._labelingChanged()},2);this.handles.add(ja.init(I,"I3S_TREE_SHOW_TILES",function(b){if(b&&!a._treeDebugger){var d=a._controller.crsIndex;(new Promise(function(a,b){Z(["./support/I3STreeDebugger"],a,b)})).then(function(b){b=b.I3STreeDebugger;!a._treeDebugger&&I.I3S_TREE_SHOW_TILES&&(a._treeDebugger=
new b({lv:a,view:a.view,nodeSR:d}))})}else b||!a._treeDebugger||I.I3S_TREE_SHOW_TILES||(a._treeDebugger.destroy(),a._treeDebugger=null)}));this._cacheKeySuffix=h.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(function(a){return u.warn("Failed to initialize IndexedDB cache: "+a)});this._componentColorManager=this._hasSymbolColors?new Ea.BufferManager(this._stage.renderView.renderingContext):null};c.prototype.destroy=function(){this._clearAddTasks();
this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null);this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);this._workerThread&&(this._workerThread.close(),this._workerThread=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._stage=this._collection=this._memCache=null;g.isSome(this._labeler)&&
(this._labeler.destroy(),this._labeler=null);this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2Meta=null;this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.memEstimateTextureAdded=function(a){a=a.estimatedTexMemRequired;
this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};c.prototype.memEstimateGeometryAdded=function(a){a=this._collection.getObjectMemoryUsageGPU(a);this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a;return a};c.prototype.memEstimateGeometryRemoved=function(a){a=this._collection.getObjectMemoryUsageGPU(a);this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};c.prototype.isNodeLoaded=
function(a){return this._nodeId2Meta.has(a)};c.prototype.getUsedMemory=function(){var a=g.isSome(this._labeler)?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(function(b){return a+=b.node.memory});return a};c.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(g.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)};c.prototype.ignoresMemoryFactor=function(){return!1};c.prototype._labelingChanged=function(){var a=this;if(!pa.areLabelsVisible(this.layer)||
!this._supportsLabeling)g.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);else if(!g.isSome(this._labeler)){var b=new ta.default({view:this.view,layer:this.layer,collection:this._collection});this._nodeId2Meta.forEach(function(d){return a._addMetaToLabeler(b,d)});this._labeler=b}};c.prototype._addMetaToLabeler=function(a,b){var d=this;a.addNodeMeta(b,function(a,b){return d._createAttributes(a,b)})};c.prototype._suspendedChange=function(a){a?(this._removeAllNodeDataFromStage(),
this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))};c.prototype.getLoadedAttributes=function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.loadedAttributes};c.prototype.getAttributeData=
function(a){if((a=this._nodeId2Meta.get(a))&&a.attributeInfo)return a.attributeInfo.attributeData};c.prototype.setAttributeData=function(a,b){var d=this;if(a=this._nodeId2Meta.get(a))a.attributeInfo=b,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,g.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(a,function(a,b){return d._createAttributes(a,b)}),this._updateEngineObject(a)};c.prototype.getLoadedNodeIds=function(){var a=[];this._nodeId2Meta.forEach(function(b){return a.push(b.node.id)});
return a.sort()};c.prototype.getLoadedNodes=function(){var a=[];this._nodeId2Meta.forEach(function(b){return a.push(b.node)});return a};c.prototype.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach(function(b,d){return a.push(d)})};c.prototype._createTexture=function(a,b,d,c){if(g.isNone(d)||null==d.data)return null;var e=d.data,m=b.wrapTextures;b=d.usage&1?"opaque"===b.alphaMode?3:4:3;var C=!0,p;d.encoding===h.DDS_ENCODING_STRING?p=S.DDS_ENCODING:C=G.isPowerOfTwo(e.width)&&G.isPowerOfTwo(e.height);
C=(c?this._enableAtlasMipMaps:this._enableMipMaps)&&C;d=new S(e,a.id+"/"+d.id,{mipmap:C,wrap:c||!m?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:c&&C&&this._disableAtlasAnisotropy,encoding:p,noUnpackFlip:!0,components:b});this._stage.add(4,d);a.memory+=this.memEstimateTextureAdded(d);return d};c.prototype._getVertexBufferLayout=function(a,b){a={hasTexture:T(a.params.material),hasNormals:null!=b.vertexAttributes.normal,hasRegions:null!=b.vertexAttributes.uvRegion};return Ba.glLayout(Ca.createVertexBufferLayout(this._getGeometryParameters(a)))};
c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=H.attributeLookup(a.attributes,this._getObjectIdField()),d=null;J.someMap(this._nodeId2Meta,function(a){var c=a.featureIds.indexOf(b);if(-1===c)return!1;d={node:a.node,index:c};return!0});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.index);if(!a)return[];for(var d=[],c=this._getObjectIdField(),f=0;f<b.length;f++){var m=H.attributeLookup(b[f].attributes,
c),m=a.featureIds.indexOf(m);-1!==m&&d.push(m)}return d};c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return x.reject();var b=this._nodeId2Meta.get(a.node.index).objectHandle;a=wa.boundingBoxCornerPoints(a.index,this._collection,b,new Float64Array(24));if(B.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=y.empty(),y.expandWithBuffer(b,a,0,8),x.resolve({boundingBox:b,screenSpaceObjects:[]})};c.prototype.whenGraphicAttributes=
function(a,b){var d=this;return h.whenGraphicAttributes(this.layer,a,this._getObjectIdField(),b,function(a){for(var b=new Map,c=[],e=0;e<a.length;e++){var p=a[e],g=d._findGraphicNodeAndIndex(p),l=b.get(g.node);l||(l={node:g.node,indices:[],graphics:[]},c.push(l));l.indices.push(g.index);l.graphics.push(p)}return c},{populateObjectId:!0})};c.prototype.getGraphicFromIntersectorMetadata=function(a){if(null==a.nodeIndex||null==a.componentIndex)return null;var b=this._nodeId2Meta.get(a.nodeIndex);return null==
b||null==b.featureIds||a.componentIndex>=b.featureIds.length?null:this._createGraphic(a.componentIndex,b)};c.prototype._getCacheKey=function(a){return this._layerUrl+"/v11/"+a.id+this._cacheKeySuffix};c.prototype._getMemCacheKey=function(a,b){void 0===b&&(b=this.elevationOffset);return a+"#"+b};c.prototype._cachingEnabled=function(){return!this._controller.disableIDBCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix};c.prototype.loadCachedGPUData=function(a){return this._memCache.pop(this._getMemCacheKey(a.index))};
c.prototype.loadMissingTextures=function(a,b,d,c){var e=this,m=a.filter(function(a,d){if(0===(a.usage&e.rendererTextureUsage))return!1;if(g.isNone(b))return!0;a=h.selectEncoding(a.encodings,e.useCompressedTextures);d=b[d];return g.isNone(d)||null==d.data||a&&d.encoding!==a.encoding?!0:!1});return 0===m.length?x.resolve(!1):d(m,c).then(function(d){for(var c=0,e=0;e<a.length;e++)c<d.length&&d[c].id===a[e].id&&(b[e]=d[c],c++);return!0})};c.prototype.loadCachedNodeData=function(a,b,d){var c=this;return this._cachingEnabled()?
this._idbCache.get(this._getCacheKey(a),b).then(function(e){if(null==e)return null;if(e.nodeVersion!==a.version)return c._idbCache.remove(c._getCacheKey(a)),null;a.obb||c._setComputedObb(a,e.nodeObb);return c.loadMissingTextures(e.requiredTextures,e.textureData,d,b).then(function(d){d&&c._idbCache.initialized&&g.isSome(e.textureData)&&(e.byteSize=V(e.transformedGeometries,e.textureData),e.textureData.every(U)&&W(a,e)&&c._idbCache.put(c._getCacheKey(a),e).catch(function(b){return u.warn("Failed to update node with textures in IndexedDB cache: "+
a.id+": "+b)}));x.throwIfAborted(b);return e})}):x.resolve(null)};c.prototype.addNodeData=function(a,b){var d=this;if(0===b.allGeometryData.length||0===b.allGeometryData[0].geometries.length)return x.resolve();1!==b.allGeometryData.length&&u.warn("Node with",b.allGeometryData.length,"geometries is unsupported");return this._addData(a,b.attributeDataInfo,function(){return d._transformNode(a,b).then(function(c){return d._controller.reschedule(a.index,function(){a.obb||d._setComputedObb(a,c.obb);b.allGeometryData[0].componentOffsets=
c.componentOffsets;c.featureIds&&(b.allGeometryData[0].featureIds=Array.prototype.slice.call(c.featureIds));var e={geometryData:b.allGeometryData[0],transformedGeometries:c.transformedGeometries,requiredTextures:b.requiredTextures,textureData:b.textureData,nodeVersion:a.version,nodeObb:a.obb,byteSize:d._cachingEnabled()?V(c.transformedGeometries,b.textureData):0};if(W(a,e)&&d._idbCache.initialized){var m=g.isSome(e.textureData)?e.textureData.map(function(a){return U(a)?a:null}):null;d._idbCache.put(d._getCacheKey(a),
E({},e,{textureData:m})).catch(function(b){return u.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)})}return d._addCachedNodeData(a,e)})})})};c.prototype._setComputedObb=function(a,b){a.obb=Aa.clone(b);a.isComputedObb=!0;this._controller.updateVisibility(a.index)};c.prototype._transformNode=function(a,b){for(var d=this,c=b.allGeometryData[0].geometries,f=Array(c.length),m=0;m<c.length;++m)f[m]=this._getVertexBufferLayout(c[m],b.geometryIndex);var g={geometryBuffer:b.geometryBuffer,geometryData:b.allGeometryData[0],
geometryIndex:b.geometryIndex,layouts:f,mbs:a.mbs,obb:a.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",g,{transferList:[b.geometryBuffer]}):Q.ensureDracoDecoder(g).then(function(){return d._controller.reschedule(a.index,
function(){return d._worker.transform(g)})})};c.prototype.addCachedGPUData=function(a,b,d){this._controller.isGeometryVisible(a)?(g.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,b),this._addNodeMeta(a.index,b),this.updateNodeStatus(a.index,d),this._collection.setObjectVisibility(b.objectHandle,!0),this._updateMaterial(b),this._updateEngineObject(b),this._highlights.objectCreated(b),this._treeDebugger&&this._treeDebugger.update()):(d=this._controller.indexDepth-a.level,this._memCache.put(this._getMemCacheKey(a.index),
b,a.memory,d))};c.prototype.addCachedNodeData=function(a,b,d){var c=this;return this._addData(a,d,function(){return c._addCachedNodeData(a,b)})};c.prototype._addCachedNodeData=function(a,b){var d=this;if(this.suspended||!this._controller.isGeometryVisible(a))return x.resolve();var c=b.geometryData,f=b.transformedGeometries,m=g.isSome(b.textureData)?b.textureData.filter(function(a){return g.isSome(a)&&0!==(a.usage&d.rendererTextureUsage)}):null;a.memory=0;var h=c.componentOffsets,p=c.geometries,c=
c.featureIds,z=null,l=null;if(this._hasSymbolColors)for(var z=this._componentColorManager.getBuffer(c.length),l=new Uint16Array(c.length),v=0;v<c.length;v++)l[v]=z.acquireIndex();var t=this._collection,p=p[0],f=f[0],q=this._materialParameters(p,f.layout),h=h||new Uint16Array([0,f.indices?f.indices.length:f.interleavedVertexData.byteLength/f.layout[0].stride]),h={vertices:{data:f.interleavedVertexData,count:f.interleavedVertexData.byteLength/f.layout[0].stride,layoutParameters:q.geometryParams},positionData:{positions:f.positionData.data,
indices:f.positionData.indices},indices:f.indices,primitiveType:4,componentOffsets:h},l=p.transformation?M.mat4f64.clone(p.transformation):M.mat4f64.create();L.mat4.multiply(l,f.corMatrices.globalTrafo,l);var z=L.mat4.getTranslation(N.vec3f64.create(),l),l=la.mat3.fromMat4(ma.mat3f32.create(),l),v=this.view.renderSpatialReference,k=this.view.basemapTerrain.spatialReference,n=N.vec3f64.create(),r=[1,1,1];B.localLinearScaleFactors(z,v,r,k);B.vectorToVector(z,v,n,k);var u=t.createObject({toMapSpace:[n[0],
n[1],r[0],r[1]],geometry:h,obb:a.renderObb,transform:{position:z,rotationScale:l},visible:!1}),h={isSchematic:p.params.material.isSchematic},z=g.isSome(m)?m.map(function(b){return d._createTexture(a,q.material,b,2===q.geometryParams.textureCoordinates)}):[];this._configureMaterial(u,p.params.material,z,m);a.memory+=this.memEstimateGeometryAdded(u);var y=this._addTasks.get(a.index),w=new Fa(a,c,u,this._getInvalidRendererVersion(),y.attributeInfo,h,z);y.meta=w;!this._hasTextures&&b.requiredTextures.some(function(a){return 0!==
(a.usage&19)})&&(this._hasTextures=!0);this._hasData=!0;this._hasColors=this._hasColors||f.hasColors;this._hasTextures=this._hasTextures||!!a.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var A=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(w).then(function(b){b&&d._edgeView.updateObjectVisibility(w.objectHandle,!1);return d._controller.reschedule(a.index,function(){var c=d._addTasks.get(a.index);if(c)if(g.isSome(d._labeler)&&d._addMetaToLabeler(d._labeler,w),d._addNodeMeta(a.index,
w),d.suspended)d._removeNodeStageData(a.index,d.elevationOffset);else{t.setObjectVisibility(u,!0);w.attributeInfo=c.attributeInfo;var c=w.cachedRendererVersion!==d._rendererVersion,e=A!==d.slicePlaneEnabled;d._setObjectSymbology(w);var f=d._applyFiltersToNode(w);b&&d._edgeView.updateObjectVisibility(w.objectHandle,!0);(c||b&&(e||f))&&d._addOrUpdateEdgeRendering(w);d.visibleGeometryChanged(w);d._highlights.objectCreated(w);d._updateMaterial(w);d._markParentsAsHole(a.index);d._treeDebugger&&d._treeDebugger.update()}})}).catch(function(a){g.isSome(y.meta)&&
d._deleteComponentObject(y.meta);throw a;})};c.prototype._addNodeMeta=function(a,b){this._nodeId2Meta.has(a)&&(u.error("Removing duplicated node"),this._deleteComponentObject(this._nodeId2Meta.get(a)));this._nodeId2Meta.set(a,b)};c.prototype._materialParameters=function(a,b){a=a.params.material;var d=b.some(function(a){return"uvRegion"===a.name});b=b.some(function(a){return"normalCompressed"===a.name});var c=T(a);return{geometryParams:this._getGeometryParameters({hasTexture:c,hasNormals:b,hasRegions:d}),
material:a}};c.prototype._configureMaterial=function(a,b,d,c){var e=this,m=this.rendererTextureUsage,h=function(a){a:{a&=m;if(!g.isNone(c)&&0!==a)for(var b=0;b<c.length;b++){var e=c[b];if(g.isSome(e)&&0!==(e.usage&a)){a=d[b].id;break a}}a=null}return a};this._collection.updateMaterial(a,function(a){var d=b.metallicRoughness.baseColorFactor,c=G.clamp(b.metallicRoughness.baseColorFactor[3],0,1);a.baseColor=[d[0],d[1],d[2],c];a.objectOpacity=e.fullOpacity;a.mrrFactors=[b.metallicRoughness.metallicFactor,
b.metallicRoughness.roughnessFactor,b.isSchematic?.2:.5];a.emissiveFactor=b.emissiveFactor;a.usePBR=e._usePBR(b.isSchematic);a.isIntegratedMesh=e._isIntegratedMesh;a.alphaCutoff="mask"===b.alphaMode?b.alphaCutoff:Da.defaultMaskAlphaCutoff;a.alphaDiscardMode="opaque"===b.alphaMode?1:"mask"===b.alphaMode?2:3;d=e._stage.renderView.textureRepository;if(c=h(33))a.baseColorTexture=new A.RenderTexture(d,c);if(c=h(2))a.metallicRoughnessTexture=new A.RenderTexture(d,c);if(c=h(16))a.emissionTexture=new A.RenderTexture(d,
c);if(c=h(8))a.occlusionTexture=new A.RenderTexture(d,c);if(c=h(4))a.normalTexture=new A.RenderTexture(d,c);a.commonMaterialParameters.slicePlaneEnabled=e.slicePlaneEnabled;a.commonMaterialParameters.doubleSided=b.doubleSided;a.commonMaterialParameters.cullFace=b.cullFace;e._updateMaterialOverlay(a)})};c.prototype._getGeometryParameters=function(a){return{textureCoordinates:a.hasTexture?a.hasRegions?2:1:0,colors:this._hasVertexColors,normals:a.hasNormals&&!this._isIntegratedMesh}};c.prototype._addData=
function(a,b,d){var c=this,f=this._addTasks.get(a.index);f?f.attributeInfo=b:(f=E({},x.createResolver(),{attributeInfo:b,meta:null}),this._addTasks.set(a.index,f),d().then(f.resolve,f.reject).then(function(){return c._addTasks.delete(a.index)}).catch(function(b){c._addTasks.delete(a.index);throw b;}));return f.promise};c.prototype._clearAddTasks=function(){var a=this;this._addTasks.forEach(function(b){g.isSome(b.meta)&&a._deleteComponentObject(b.meta)});this._addTasks.clear()};c.prototype._markParentsAsHole=
function(a){if(this._isIntegratedMesh){var b=this._controller;for(a=b.getParentIndex(a);a;a=b.getParentIndex(a))this.updateNodeStatus(a,"hole")}};c.prototype._clippingAreaChanged=function(){var a=y.create();B.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){this._applyFilters(!1)};c.prototype._applyFilters=
function(a){var b=this;this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){b._applyFiltersToNode(a)&&(b._addOrUpdateEdgeRendering(a),b.visibleGeometryChanged(a))})};c.prototype.getFilters=function(){var a=this,b=[];this._clippingArea&&b.push(function(b,c){return a._boundingboxFilter(b,c,a._clippingArea)});return b};c.prototype.addSqlFilter=function(a,b,d,c){var e=this;b&&d&&a.push(function(a,f){return e._sqlFilter(a,f,b,d,c)})};
c.prototype._sqlFilter=function(a,b,d,c,f){var e={},g=this._createLayerGraphic(e),p=this.layer.objectIdField,k=b.featureIds,l=b.attributeInfo.attributeData;c.every(function(a){return null!=l[a]||a===p})&&h.filterInPlace(a,k,function(a){e[p]=k[a];for(var b=0;b<c.length;b++){var m=c[b];m!==p&&(e[m]=h.getCachedAttributeValue(l[m],a))}try{if(Array.isArray(d)){for(a=0;a<d.length;a++)if(d[a].testFeature(g))return!0;return!1}return d.testFeature(g)}catch(Ga){return f(Ga),!1}})};c.prototype._boundingboxNodeTest=
function(a,b){B.mbsToMbs(a.node.mbs,this._controller.crsIndex,Y,this.view.renderSpatialReference);return h.intersectBoundingBoxWithMbs(b,Y)};c.prototype._boundingboxFeatureTest=function(a,b,d){return y.intersects(d,this._collection.getComponentAABB(a.objectHandle,b,Ha))};c.prototype._boundingboxFilter=function(a,b,d){var c=this,f=this._collection,g=this._boundingboxNodeTest(b,d);if(3!==g)if(0===g)a.length=0;else if(f=f.getComponentCount(b.objectHandle),f.invisible+f.visible===b.featureIds.length){var k=
this._transformAABB(Ia,d,b.objectHandle);h.filterInPlace(a,b.featureIds,function(a){return c._boundingboxFeatureTest(b,a,k)})}};c.prototype._transformAABB=function(a,b,d){var c=this._collection.getObjectTransform(d);d=c.position;c=c.rotationScale;a[0]=(b[0]-d[0])/c[0];a[1]=(b[1]-d[1])/c[4];a[2]=(b[2]-d[2])/c[8];a[3]=(b[3]-d[0])/c[0];a[4]=(b[4]-d[1])/c[4];a[5]=(b[5]-d[2])/c[8];return a};c.prototype._addOrUpdateEdgeRendering=function(a,b){void 0===b&&(b=!0);if(!this._edgeView)return x.resolve(!1);var c=
a.objectHandle,e=this._edgeView.hasObject(c);a=this._extractObjectEdgeMaterials(a);var f=a.perFeatureEdgeMaterials,g={slicePlaneEnabled:this.slicePlaneEnabled};if(a.hasEdges)return e?(this._edgeView.updateAllComponentMaterials(c,f,g,b),this._edgeView.updateObjectVisibility(c,!0),x.resolve(!0)):this._collection.addEdges(c,this._edgeView,f,g).then(function(){return!0});e&&this._edgeView.removeObject(c);return x.resolve(!1)};c.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&
this._edgeView.removeObject(a.objectHandle)};c.prototype._applyFiltersToNode=function(a){return this._applyFiltersToNodeComponents(a)?(g.isSome(this._labeler)&&this._labeler.applyFilterChange(a),!0):!1};c.prototype._applyFiltersToNodeComponents=function(a){var b=this._collection,c=0===b.getComponentCount(a.objectHandle).invisible;b.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!c;this._updateCachedFilteredIds(a);if(a.filteredIds===a.featureIds)return!c;
c=this._computeFilteredComponentIndices(a);b.setAllComponentVisibilities(a.objectHandle,c);return!0};c.prototype._updateCachedFilteredIds=function(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters};c.prototype._computeFilteredIds=function(a){for(var b=a.featureIds.slice(),c=0,e=this._filters;c<e.length&&((0,e[c])(b,a),0!==b.length);c++);return b.length===a.featureIds.length?a.featureIds:b};c.prototype._computeFilteredComponentIndices=
function(a){var b=[];a.featureIds.forEach(function(c,e){a.filteredIds[b.length]===c&&b.push(e)});return b};c.prototype._removeAllNodeDataFromStage=function(a){var b=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(c,e){return b._removeNodeStageData(e,a)})};c.prototype.removeNodeData=function(a,b){for(var c=this.elevationOffset;0<a.length&&!b.done;){var e=a.pop();this._removeNodeStageData(e,c);b.madeProgress()}};c.prototype._removeNodeStageData=function(a,b){var c=this._nodeId2Meta.get(a);
if(c){this._collection.setObjectVisibility(c.objectHandle,!1);this.visibleGeometryChanged(c);this._removeEdgeRendering(c);g.isSome(this._labeler)&&this._labeler.removeNodeMeta(c);this._nodeId2Meta.delete(a);this._highlights.objectDeleted(c);var e=this._controller.indexDepth-c.node.level+1;this._memCache.put(this._getMemCacheKey(a,b),c,c.node.memory,e);this._treeDebugger&&this._treeDebugger.update()}};c.prototype._deleteComponentObject=function(a){this._edgeView&&this._edgeView.removeObject(a.objectHandle);
this.memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);if(a.textures){var b=0;for(a=a.textures;b<a.length;b++){var c=a[b];this.memEstimateTextureRemoved(c);this._stage.remove(4,c.id)}}};c.prototype.updateNodeStatus=function(a,b){(a=this._nodeId2Meta.get(a))&&this._collection.updateMaterial(a.objectHandle,function(a){a.polygonOffsetEnabled="hole"===b})};c.prototype._invalidateAllSymbols=function(){this._rendererVersion=h.addWraparound(this._rendererVersion,1);
this._controller&&this._controller.requestUpdate()};c.prototype._getInvalidRendererVersion=function(){return h.addWraparound(this._rendererVersion,-1)};c.prototype._rendererChange=function(a){return ca(this,void 0,void 0,function(){var b,c,e,f,g,k,p,n,l,v;return ba(this,function(d){switch(d.label){case 0:this._currentRenderer=a;this.notifyChange("rendererTextureUsage");this._rendererVersion=h.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;
this._invalidateAllSymbols();if(!a)return[3,2];b=this;c=O.fixFields;e=[this.layer.fields];return[4,a.getRequiredFields(this.layer.fields)];case 1:b._rendererFields=c.apply(void 0,e.concat([d.sent()])),d.label=2;case 2:this._updateSymbologyFields();if(!(!this._arcade&&a&&"arcadeRequired"in a&&a.arcadeRequired))return[3,4];f=this;return[4,qa.loadArcade()];case 3:f._arcade=d.sent(),d.label=4;case 4:if(a&&"visualVariables"in a&&a.visualVariables)for(g=0,k=a.visualVariables;g<k.length;g++)p=k[g],"color"===
p.type?this._colorVariable=p:"opacity"===p.type?this._opacityVariable=p:u.warn("Unsupported visual variable type for 3D Object Scene Services: "+p.type);if(a)for(n=0,l=a.getSymbols();n<l.length;n++)v=l[n],"mesh-3d"!==v.type&&u.error("Symbols of type '"+v.type+"' are not supported for 3D Object Scene Services.");this._controller&&this._controller.requestUpdate();return[2]}})})};c.prototype._getCachedEdgeMaterials=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);
return a.cachedEdgeMaterials};c.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);var b=a.cachedSymbology;return function(a,c){a*=5;na.vec4.set(c.externalColor,b[a+0]/255,b[a+1]/255,b[a+2]/255,b[a+3]/255);c.externalColorMixMode=b[a+4]&15;c.castShadows=0!==(b[a+4]&16);c.pickable=0!==(b[a+4]&32)}};c.prototype._getSymbolInfo=function(a,b){b=a&&a.getSymbol(b,{arcade:this._arcade});if(!(b instanceof ra))return null;
a=b.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);b=h.getSymbolInfo(b);this._symbolInfos.set(a,b);return b};c.prototype._setSymbologyOverride=function(a,b){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=b,this._invalidateAllSymbols(),this._updateSymbologyFields())};c.prototype._updateSymbologyFields=function(){this._symbologyFields=g.isSome(this._symbologyOverrideFields)&&0<this._symbologyOverrideFields.length?g.isSome(this._rendererFields)&&
0<this._rendererFields.length?O.fixFields(this.layer.fields,this._rendererFields.concat(this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields};c.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var b=this._tmpAttributeOnlyGraphic,c={};b.attributes=c;var e=this._currentRenderer,f=a.attributeInfo.attributeData,m=null!=a.featureIds?this.layer.objectIdField:null,k=null!=f&&g.isSome(this._symbologyFields)&&
0<this._symbologyFields.length,p=k?[]:null,n=k?[]:null;if(k&&g.isSome(this._symbologyFields))for(var l=0,v=this._symbologyFields;l<v.length;l++){var t=v[l],q=f[t];q&&(p.push(t),n.push(q))}a.cachedSymbology||(a.cachedSymbology=new Uint8Array(5*a.featureIds.length));f={color:D,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null};for(v=l=0;v<a.featureIds.length;v++){null!=m&&(c[m]=a.featureIds[v]);if(k)for(t=0;t<p.length;t++)c[p[t]]=h.getCachedAttributeValue(n[t],v);var t=this._getSymbolInfo(e,
b),u=q=null;if(e&&"visualVariables"in e){if(this._colorVariable){var r=P.getColor(this._colorVariable,b,{color:Ja,arcade:this._arcade});r&&(q=D,q[0]=r.r/255,q[1]=r.g/255,q[2]=r.b/255,this._opacityVariable||null===r.a||(u=r.a))}this._opacityVariable&&(u=P.getOpacity(this._opacityVariable,b,{arcade:this._arcade}))}t&&t.material&&(r=t.material,q=g.isNone(q)||g.isNone(u)?R.overrideColor(q,u,r.color,r.alpha,X,D):R.overrideColor(q,u,null,null,X,D));g.isNone(q)&&(q=D,q[0]=1,q[1]=1,q[2]=1,q[3]=1);f.pickable=
!0;f.castShadows=t?t.castShadows:!0;f.colorMixMode=t&&t.material?t.material.colorMixMode:1;f.edgeMaterial=t?t.edgeMaterial:null;g.isSome(this._symbologyOverride)&&(f.color=q,this._symbologyOverride(b,f),q=f.color);a.cachedEdgeMaterials[v]=f.edgeMaterial;a.cachedSymbology[l+0]=Math.round(255*q[0]);a.cachedSymbology[l+1]=Math.round(255*q[1]);a.cachedSymbology[l+2]=Math.round(255*q[2]);a.cachedSymbology[l+3]=Math.round(255*q[3]);a.cachedSymbology[l+4]=f.colorMixMode|+f.castShadows<<4|+f.pickable<<5;
l+=5}}};c.prototype._extractObjectEdgeMaterials=function(a){var b=a.objectHandle,c=a.featureIds?a.featureIds.length:1,e=Array(c),f={opacity:this.fullOpacity,objectTransparency:2};this._collection.updateMaterial(b,function(a){f.objectTransparency=a.hasVisibleComponents?a.hasTransparency?1:2:0});var m=!1,k=null,p=null,n=this._getCachedEdgeMaterials(a);for(a=0;a<c;a++)e[a]=h.transparentEdgeMaterial;this._collection.forEachVisibleComponent(b,function(a){var b=n[a];if(g.isNone(b))return!0;p!==b&&(p=b,
(k=g.isSome(b)?E({},b,f):null)&&(m=!0));e[a]=g.isSome(k)?k:h.transparentEdgeMaterial;return!0});return{hasEdges:m,perFeatureEdgeMaterials:e}};c.prototype._setObjectSymbology=function(a){if(this._hasSymbolColors){var b=a.objectHandle,c=this._getSymbolColors(a);this._collection.setComponentData(b,c);this._stage.renderView.setNeedsRender();this._updateEdgeRendering(a)}};c.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&
this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._nodeId2Meta.forEach(function(c){b._collection.updateMaterial(c.objectHandle,function(b){return b.objectOpacity=a});b._updateEdgeRendering(c)})};c.prototype._updateMaterial=function(a){var b=this;this._collection.updateMaterial(a.objectHandle,function(c){c.commonMaterialParameters.slicePlaneEnabled=b.slicePlaneEnabled;c.usePBR=b._usePBR(a.material.isSchematic);c.objectOpacity=b.fullOpacity;b._updateMaterialOverlay(c)})};
c.prototype._updateMaterialOverlay=function(a){};c.prototype._updateEngineObject=function(a){this._setObjectSymbology(a);this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this.visibleGeometryChanged(a)};c.prototype._slicePlaneEnabledChange=function(a){var b=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=a);g.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(function(c){b._collection.updateMaterial(c.objectHandle,function(b){b.commonMaterialParameters.slicePlaneEnabled=
a});b._updateEdgeRendering(c,!1)})};c.prototype._updatePBR=function(){var a=this;this._nodeId2Meta.forEach(function(b){a._collection.updateMaterial(b.objectHandle,function(c){c.usePBR=a._usePBR(b.material.isSchematic)})})};c.prototype._usePBR=function(a){return!this._isIntegratedMesh&&(a?this.view.qualitySettings.physicallyBasedRenderingEnabled:!0)};c.prototype._updateEdgeRendering=function(a,b){void 0===b&&(b=!0);this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,
b)};c.prototype._forAllNodes=function(a){this._nodeId2Meta.forEach(a)};c.prototype._forAllFeatures=function(a,b,c){var d=this;void 0===c&&(c=0);J.someMap(this._nodeId2Meta,function(e){if(g.isSome(b))switch(b(e)){case 0:return!0;case 2:return!1}var f=1;switch(c){case 1:f=d._forAllFeaturesOfNode(e,a);break;case 0:f=d._forVisibleFeaturesOfNode(e,a);break;case 2:f=d._forAllFeaturesOfNodeInClippingArea(e,a)}return 0===f})};c.prototype._forAllFeaturesOfNode=function(a,b){for(var c=1,e=a.featureIds,f=0;f<
e.length&&(c=b(e[f],f,a),0!==c);f++);return c};c.prototype._forVisibleFeaturesOfNode=function(a,b){var c=1,e=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,function(d){c=b(e[d],d,a);return 1===c});return c};c.prototype._forAllFeaturesOfNodeInClippingArea=function(a,b){if(null==this._clippingArea)return this._forAllFeaturesOfNode(a,b);var c=this._boundingboxNodeTest(a,this._clippingArea);if(0===c)return 1;if(3===c)return this._forAllFeaturesOfNode(a,b);for(var c=a.featureIds,
e=h.getClipAABB(this._clippingArea,this._collection.getObjectTransform(a.objectHandle)),f=0;f<c.length;f++)if(this._boundingboxFeatureTest(a,f,e)){var g=b(c[f],f,a);if(0===g)return g}return 1};c.prototype._createAttributes=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=b.attributeInfo.attributeData;if(null!=b)for(var e=0,f=Object.keys(b);e<f.length;e++){var g=f[e];c[g]=h.getCachedAttributeValue(b[g],a)}return c};c.prototype._createGraphic=function(a,b){return this._createLayerGraphic(this._createAttributes(a,
b))};c.prototype.highlight=function(a){var b=this,c=this._highlights;"number"===typeof a?a=[a]:a instanceof F?a=[a]:a instanceof ea&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof F){a=a.map(function(a){return H.attributeLookup(a.attributes,b._getObjectIdField())});var e=c.acquireSet(),f=e.set,e=e.handle;c.setFeatureIds(f,a);return e}if("number"===typeof a[0])return e=c.acquireSet(),f=e.set,e=e.handle,c.setFeatureIds(f,a),e}return Ka};c.prototype.visibleGeometryChanged=function(a){var b=
this;this._elevationProvider&&(this._elevationProvider.objectChanged(a.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=ha.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null})))};Object.defineProperty(c.prototype,"resourceInfo",{get:function(){var a={displayedFeatures:0,maxFeatures:0,totalFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/
1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._cachingEnabled()&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a},enumerable:!0,configurable:!0});c.prototype.test=function(){var a=this;return{controller:this._controller,get visibleObjectIds(){var b=[];a._forAllFeatures(function(a){b.push(a);
return 1},null,0);b.sort(function(a,b){return a-b});return b},get numNodes(){return a._nodeId2Meta.size}}};n([k.property()],c.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);n([k.property()],c.prototype,"view",void 0);n([k.property()],c.prototype,"layer",void 0);n([k.property()],c.prototype,"_controller",void 0);n([k.property()],c.prototype,"_labeler",void 0);n([k.property({dependsOn:["updatingMeshView3D"]})],c.prototype,"updating",void 0);n([k.property({dependsOn:["_controller.updating",
"_visibleGeometryChangedSchedulerHandle","_labeler.updating"]})],c.prototype,"updatingMeshView3D",null);n([k.property({dependsOn:["_controller.rootNodeVisible"]})],c.prototype,"suspended",void 0);n([k.property(za.updatingProgress)],c.prototype,"updatingProgress",void 0);n([k.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],c.prototype,"updatingProgressValue",void 0);n([k.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);n([k.property({readOnly:!0})],c.prototype,
"rendererTextureUsage",null);n([k.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null);n([k.property({type:Boolean})],c.prototype,"slicePlaneEnabled",void 0);n([k.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);n([k.property({dependsOn:["layer.version"]})],c.prototype,"useCompressedTextures",null);return c=n([k.subclass("esri.views.3d.layers.I3SMeshView3D")],
c)}(k.declared(r))};var Ha=y.create(),Ia=y.create(),D=[0,0,0,0],Ja=new da([0,0,0,0]),Y=[0,0,0,0],Ka={remove:function(){},pause:function(){},resume:function(){}}});