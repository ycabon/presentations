// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../Color ../../../../core/compilerUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/MeshComponent ../../../../geometry/support/MeshMaterialMetallicRoughness ../../../../geometry/support/webMercatorUtils ../../../../geometry/support/meshUtils/projection ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ../support/edgeUtils ../support/symbolColorUtils ../../support/debugFlags ../../support/projectionUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Texture ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/NativeLineMaterial".split(" "),
function(r,J,Y,Z,aa,qa,F,ba,t,Q,ca,da,E,m,q,R,G,ea,fa,ga,S,ha,T,ia,ja,ka,U,V,K,L,M,la,ma,na,oa,W){Object.defineProperty(J,"__esModule",{value:!0});var l=na.VertexAttrConstants;r=function(r){function d(a,b,c,e){a=r.call(this,a,b,c,e)||this;a._materials=new Map;a._textures=new Map;a.ensureDrapedStatus(!1);return a}Y(d,r);d.prototype.doLoad=function(){return aa(this,void 0,void 0,function(){return Z(this,function(a){V.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new W({color:[1,0,1,1]},
"debugVertexNormal"),this._debugFaceNormalMaterial=new W({color:[0,1,1,1]},"debugFAceNormal"));return[2]})})};d.prototype.destroy=function(){var a=this;r.prototype.destroy.call(this);this._materials.forEach(function(b){a._context.stage.remove(3,b.material.id)});this._textures.forEach(function(b){a._context.stage.remove(4,b.id)});this._materials.clear();this._textures.clear()};d.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometryType(b.geometry,d.validGeometryTypes,
"fill on mesh-3d")||!this._validateGeometry(b.geometry))return null;var c="graphic"+b.uid,e=this.getGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,e,c,b.uid)};d.prototype.layerOpacityChanged=function(a,b){var c=this,e=this._getLayerOpacity();this._materials.forEach(function(a){a.material.setParameterValues({layerOpacity:e});var b=a.material.getParameters();c._setMaterialTransparentParameter(b,a);a.material.setParameterValues({transparent:b.transparent})});a.forEach(function(a){a=
b(a);t.isSome(a)&&a.layerOpacityChanged(e,c._context.isAsync)});return!0};d.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,T.needsElevationUpdates3D)};d.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;this._materials.forEach(function(a){a.material.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});a.forEach(function(a){a=b(a);t.isSome(a)&&a.slicePlaneEnabledChanged(c._context.slicePlaneEnabled,c._context.isAsync)});
return!0};d.prototype.physicalBasedRenderingChanged=function(){var a=this;this._materials.forEach(function(b){b.material.setParameterValues({usePBR:a._context.physicalBasedRenderingEnabled,isSchematic:!0})});return!0};d.prototype.pixelRatioChanged=function(){return!0};d.prototype._requiresSymbolVertexColors=function(){return this._drivenProperties.color||this._drivenProperties.opacity};d.prototype._colorOrTextureUid=function(a){return a?a instanceof F?a.toHex():a.contentHash:"-"};d.prototype._materialPropertiesDefault=
function(a,b){var c=this._requiresSymbolVertexColors(),e=!!a.vertexAttributes.color;a=!!a.vertexAttributes.tangent;return{hasSymbolVertexColors:c,hasVertexColors:e,hasVertexTangents:a,uid:"vc:"+e+",vt:"+a+",vct"+b+",svc:"+c}};d.prototype._materialProperties=function(a,b,c){a=this._materialPropertiesDefault(a,c);if(!b.material)return a;var e=b.material;c=e.color;var h=e.colorTexture,f=e.normalTexture,d=e.doubleSided,k=e.alphaCutoff,e=e.alphaMode,g=this._colorOrTextureUid(c),l=this._colorOrTextureUid(h),
m=this._colorOrTextureUid(f);a.color=c;a.colorTexture=h;a.normalTexture=f;a.uid=a.uid+",cmuid:"+g+",ctmuid:"+l+",ntmuid:"+m+",ds:"+d+",ac:"+k+",am:"+e;b.material instanceof fa&&(k=b.material,b=k.metallic,c=k.roughness,h=k.metallicRoughnessTexture,f=k.emissiveColor,d=k.emissiveTexture,k=k.occlusionTexture,e=this._colorOrTextureUid(h),g=this._colorOrTextureUid(f),l=this._colorOrTextureUid(d),m=this._colorOrTextureUid(k),a.metallic=b,a.roughness=c,a.metallicRoughnessTexture=h,a.emissiveColor=f,a.emissiveTexture=
d,a.occlusionTexture=k,a.uid=a.uid+",mrm:"+b+",mrr:"+c+",mrt:"+e+",emuid:"+g+",etmuid:"+l+",otmuid:"+m);return a};d.prototype._setInternalColorValueParameters=function(a,b){b.diffuse=F.toUnitRGB(a);b.opacity=a.a};d.prototype._getLoadableTextureResource=function(a){return a.data?a.data:a.url};d.prototype._getInternalTextureId=function(a,b){var c=this._getLoadableTextureResource(a);if(c){var e=a.contentHash,h=this._textures.get(e);h||(h=new ma(c,b+"_"+e+"_tex",{mipmap:!0,wrap:this._castTextureWrap(a.wrap),
noUnpackFlip:!0,preMultiplyAlpha:!0}),this._textures.set(e,h),this._context.stage.add(4,h));return h.id}};d.prototype._castTextureWrap=function(a){void 0===a&&(a="repeat");return"string"===typeof a?(a=this._castTextureWrapIndividual(a),{s:a,t:a}):{s:this._castTextureWrapIndividual(a.horizontal),t:this._castTextureWrapIndividual(a.vertical)}};d.prototype._castTextureWrapIndividual=function(a){switch(a){case "clamp":return 33071;case "mirror":return 33648;default:return 10497}};d.prototype._setInternalMaterialParameters=
function(a,b,c){a.color&&this._setInternalColorValueParameters(a.color,c);a.colorTexture&&(c.textureId=this._getInternalTextureId(a.colorTexture,b));a.normalTexture&&(c.normalTextureId=this._getInternalTextureId(a.normalTexture,b));a.emissiveColor&&(c.emissiveFactor=F.toUnitRGB(a.emissiveColor));a.emissiveTexture&&(c.emissiveTextureId=this._getInternalTextureId(a.emissiveTexture,b));a.occlusionTexture&&(c.occlusionTextureId=this._getInternalTextureId(a.occlusionTexture,b));a.metallicRoughnessTexture&&
(c.metallicRoughnessTextureId=this._getInternalTextureId(a.metallicRoughnessTexture,b))};d.prototype._setExternalMaterialParameters=function(a){var b=this._drivenProperties.color,c=t.isSome(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;b?a.externalColor=R.vec4f64.ONES:(b=t.isSome(this.symbolLayer.material)?this.symbolLayer.material.color:null,t.isSome(b)?a.externalColor=F.toUnitRGBA(b):(c=null,a.externalColor=R.vec4f64.ONES));c&&(a.colorMixMode=c)};d.prototype._hasTransparentVertexColors=
function(a){a=a.vertexAttributes.color;if(!a)return!1;for(var b=3;b<a.length;b+=4)if(255!==a[b])return!0;return!1};d.prototype._getOrCreateMaterial=function(a,b){var c=b.material&&b.material.color,e=b.material&&b.material.colorTexture,h=b.material&&"blend"===b.material.alphaMode,c=!(b.material&&"opaque"===b.material.alphaMode)&&(this._hasTransparentVertexColors(a)||c&&1>c.a||e&&e.transparent||h);a=this._materialProperties(a,b,c);if(e=this._materials.get(a.uid))return e.material;var c={material:null,
isComponentTransparent:c,alphaMode:b.material?b.material.alphaMode:"opaque"},e=this._getIdHint(),h=null==a.metallicRoughnessTexture&&null==a.metallic&&null==a.roughness,f={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:h,vertexColors:a.hasVertexColors,symbolColors:a.hasSymbolVertexColors,vertexTangents:a.hasVertexTangents,ambient:q.vec3f64.ZEROS,diffuse:q.vec3f64.ONES,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,textureAlphaPremultiplied:!0,layerOpacity:this._getLayerOpacity(),
slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};h||(f.mrrFactors=[null!=a.metallic?a.metallic:1,null!=a.roughness?a.roughness:1,.5]);b.material&&(f.doubleSided=b.material.doubleSided,f.cullFace=b.material.doubleSided?0:2,f.textureAlphaCutoff=b.material.alphaCutoff);this._setInternalMaterialParameters(a,e,f);this._setExternalMaterialParameters(f);this._setMaterialTransparentParameter(f,c);b=new oa(f,e+"_"+a.uid+"_mat");c.material=b;this._materials.set(a.uid,c);this._context.stage.add(3,
b);return b};d.prototype._setMaterialTransparentParameter=function(a,b){a.transparent=this.needsDrivenTransparentPass||b.isComponentTransparent||1>a.layerOpacity||1>a.opacity||a.externalColor&&1>a.externalColor[3];a.textureAlphaMode="auto"===b.alphaMode?a.transparent?"maskBlend":"opaque":b.alphaMode};d.prototype._addDebugNormals=function(a,b,c,e){var h,f,d,k,q=b.length,A=a.spatialReference.isGeographic?20015077/180:1,r=.1*Math.max(a.extent.width*A,a.extent.height*A,a.extent.zmax-a.extent.zmin),t=
[],B=[];a=[];for(var A=[],N=0;N<q;N++)for(var w=b[N],v=w.data.getAttribute(l.POSITION),O=w.data.getAttribute(l.NORMAL),x=w.data.getIndices(l.POSITION),w=w.data.getIndices(l.NORMAL),v=v.data,O=O.data,n=0;n<x.length;n++){for(var u=3*x[n],C=3*w[n],p=0;3>p;p++)t.push(v[u+p]);for(p=0;3>p;p++)t.push(v[u+p]+O[C+p]*r);B.push(B.length);B.push(B.length);if(0===n%3){this._calculateFaceNormal(v,x,n,y);this._getFaceVertices(v,x,n,g,z,D);m.vec3.add(g,g,z);m.vec3.add(g,g,D);m.vec3.scale(g,g,1/3);for(p=0;3>p;p++)a.push(g[p]);
for(p=0;3>p;p++)a.push(g[p]+y[p]*r);A.push(A.length);A.push(A.length)}}q=(h={},h[l.POSITION]={data:new Float64Array(t),size:3},h);h=(f={},f[l.POSITION]=new Uint32Array(B),f);f=new M.GeometryData(q,h,void 0,"line");f=new L(f,"debugVertexNormal");b.push(f);c.push(this._debugVertexNormalMaterial);e.push(E.mat4f64.clone(e[0]));q=(d={},d[l.POSITION]={data:new Float64Array(a),size:3},d);h=(k={},k[l.POSITION]=new Uint32Array(A),k);f=new M.GeometryData(q,h,void 0,"line");f=new L(f,"debugFaceNormal");b.push(f);
c.push(this._debugFaceNormalMaterial);e.push(E.mat4f64.clone(e[0]))};d.prototype._createAs3DShape=function(a,b,c,e,h){a=a.geometry;if("mesh"!==a.type)return null;var f=this._createGeometryInfo(a,b,e);if(!f)return null;b=f.geometries;var d=f.materials,k=f.transformations,f=f.objectTransformation;V.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,b,d,k);h=new la({geometries:b,materials:d,transformations:k,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicUid:h},idHint:e});h.objectTransformation=
f;e=ha.perObjectElevationAligner;k=this._createEdgeMaterial();d=t.isSome(k)?{baseMaterial:d[0],edgeMaterials:[k],addObjectSettings:{mergeGeometries:!0},slicePlaneEnabled:this._context.slicePlaneEnabled}:null;b=new ia(this,h,b,null,null,e,c,d);b.needsElevationUpdates=T.needsElevationUpdates3D(c.mode);c=a.extent.center.clone();c.z=0;b.elevationContext.centerPointInElevationSR=c;b.alignedSampledElevation=e(b,b.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper);return b};
d.prototype._createComponentNormals=function(a,b,c,e){var h=c.shading||"flat";switch(h){case "source":return this._createComponentNormalsSource(a,b,c,e);case "flat":return this._createComponentNormalsFlat(a,e);case "smooth":return this._createComponentNormalsSmooth(a,e);default:ba.neverReached(h)}};d.prototype._createComponentNormalsSource=function(a,b,c,e){if(!b)return this._createComponentNormalsFlat(a,e);var h=!1;if(!c.trustSourceNormals)for(c=0;c<e.length;c+=3){this._calculateFaceNormal(a,e,c,
y);for(var f=0;3>f;f++){var d=3*e[c+f];g[0]=b[d+0];g[1]=b[d+1];g[2]=b[d+2];0>m.vec3.dot(y,g)&&(b[d+0]=-b[d+0],b[d+1]=-b[d+1],b[d+2]=-b[d+2],h=!0)}}return{normals:b,indices:e,didFlipNormals:h}};d.prototype._createComponentNormalsFlat=function(a,b){for(var c=new Float32Array(b.length),e=new Uint32Array(3*b.length),d=0;d<b.length;d+=3)for(var f=this._calculateFaceNormal(a,b,d,y),g=0;3>g;g++)c[d+g]=f[g],e[d+g]=d/3;return{normals:c,indices:e,didFlipNormals:!1}};d.prototype._createComponentNormalsSmooth=
function(a,b){for(var c={},e=0;e<b.length;e+=3)for(var d=this._calculateFaceNormal(a,b,e,y),f=0;3>f;f++){var g=b[e+f],k=c[g];k||(k={normal:q.vec3f64.create(),count:0},c[g]=k);m.vec3.add(k.normal,k.normal,d);k.count++}a=new Float32Array(3*b.length);d=new Uint32Array(3*b.length);for(e=0;e<b.length;e++){g=b[e];k=c[g];1!==k.count&&(m.vec3.normalize(k.normal,k.normal),k.count=1);for(f=0;3>f;f++)a[3*e+f]=k.normal[f];d[e]=e}return{normals:a,indices:d,didFlipNormals:!1}};d.prototype._getFaceVertices=function(a,
b,c,e,d,f){var h=3*b[c+0],g=3*b[c+1];b=3*b[c+2];e[0]=a[h+0];e[1]=a[h+1];e[2]=a[h+2];d[0]=a[g+0];d[1]=a[g+1];d[2]=a[g+2];f[0]=a[b+0];f[1]=a[b+1];f[2]=a[b+2]};d.prototype._calculateFaceNormal=function(a,b,c,e){this._getFaceVertices(a,b,c,g,z,D);m.vec3.subtract(z,z,g);m.vec3.subtract(D,D,g);m.vec3.cross(g,z,D);m.vec3.normalize(e,g);return e};d.prototype._getOrCreateComponents=function(a){return a.components?a.components:pa};d.prototype._createPositionBuffer=function(a){var b=a.vertexAttributes.position,
c=new Float64Array(b.length);K.bufferToBuffer(a.vertexAttributes.position,a.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0,b.length/3);return c};d.prototype._createNormalBuffer=function(a,b){var c=a.vertexAttributes.normal;if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;var e=a.vertexAttributes.position,d=new Float32Array(c.length);return S.projectNormalToECEF(c,e,b,a.spatialReference,d)};d.prototype._createTangentBuffer=function(a,b){var c=
a.vertexAttributes.tangent;if(!c)return null;if("local"===this._context.layerView.view.viewingMode)return c;var e=a.vertexAttributes.position,d=new Float32Array(c.length);return S.projectTangentToECEF(c,e,b,a.spatialReference,d)};d.prototype._createColorBuffer=function(a){return a.vertexAttributes.color};d.prototype._createSymbolColorBuffer=function(a){if(this._requiresSymbolVertexColors()){a=this._getVertexOpacityAndColor(a);var b=U.parseColorMixMode(t.get(this.symbolLayer,"material","colorMixMode")),
c=new Uint8Array(4);U.encodeSymbolColor(a,b,c);return c}return null};d.prototype._createColorIndices=function(a){a=new Uint32Array(a.length);for(var b=0;b<a.length;b++)a[b]=0;return a};d.prototype._createBuffers=function(a,b){var c=a.vertexAttributes&&a.vertexAttributes.position;if(!c)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;var e=a.vertexAttributes.normal,d=a.vertexAttributes.uv,f=a.vertexAttributes.tangent;if(e&&e.length!==c.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),
null;if(f&&f.length/4!==c.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(d&&d.length/2!==c.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;c=this._createPositionBuffer(a);e=this._createColorBuffer(a);b=this._createSymbolColorBuffer(b);var f=this._createNormalBuffer(a,c),g=this._createTangentBuffer(a,c);a=this._transformCenterLocal(a,
c,f);return{positionBuffer:c,normalBuffer:f,tangentBuffer:g,uvBuffer:d,colorBuffer:e,symbolColorBuffer:b,objectTransformation:a}};d.prototype._transformCenterLocal=function(a,b,c){var e=a.extent.center,d=this._context.renderCoordsHelper.spatialReference;H[0]=e.x;H[1]=e.y;H[2]=0;e=E.mat4f64.create();K.computeLinearTransformation(a.spatialReference,H,e,d);da.mat4.invert(X,e);for(a=0;a<b.length;a+=3)g[0]=b[a+0],g[1]=b[a+1],g[2]=b[a+2],m.vec3.transformMat4(g,g,X),b[a+0]=g[0],b[a+1]=g[1],b[a+2]=g[2];if(c)for(Q.mat3.fromMat4(I,
e),Q.mat3.transpose(I,I),a=0;a<c.length;a+=3)g[0]=c[a+0],g[1]=c[a+1],g[2]=c[a+2],m.vec3.transformMat3(g,g,I),c[a+0]=g[0],c[a+1]=g[1],c[a+2]=g[2];return e};d.prototype._validateFaces=function(a,b){a=a.vertexAttributes.position.length/3;if(b=b.faces){for(var c=-1,e=0;e<b.length;e++){var d=b[e];d>c&&(c=d)}if(a<=c)return this.logger.warn("Vertex index "+c+" is out of bounds of the mesh position buffer"),!1}else if(0!==a%3)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),
!1;return!0};d.prototype._getOrCreateFaces=function(a,b){if(b.faces)return b.faces;a=new Uint32Array(a.vertexAttributes.position.length/3);for(b=0;b<a.length;b++)a[b]=b;return a};d.prototype._isOutsideClippingArea=function(a){if(!this._context.clippingExtent)return!1;var b=a.vertexAttributes&&a.vertexAttributes.position;if(!b)return!1;var c=this._context.elevationProvider.spatialReference,e=b.length/3;a.spatialReference.equals(c)||(b=new Float64Array(b.length),K.bufferToBuffer(a.vertexAttributes.position,
a.spatialReference,0,b,c,0,e));G.empty(P);G.expandWithBuffer(P,b,0,e);return!G.intersectsClippingArea(P,this._context.clippingExtent)};d.prototype._createGeometryInfo=function(a,b,c){var e,d;if(!ga.canProject(a,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(a))return null;var f=this._createBuffers(a,b);if(!f)return null;b=f.positionBuffer;for(var g=f.uvBuffer,k=f.colorBuffer,m=
f.symbolColorBuffer,q=f.normalBuffer,t=f.tangentBuffer,f=f.objectTransformation,r=[],B=[],y=[],w=!1,v=0,z=this._getOrCreateComponents(a);v<z.length;v++){var x=z[v];if(!this._validateFaces(a,x))return null;var n=this._getOrCreateFaces(a,x);if(0!==n.length){var u=this._createComponentNormals(b,q,x,n);u.didFlipNormals&&(w=!0);var C=(e={},e[l.POSITION]={size:3,data:b},e[l.NORMAL]={size:3,data:u.normals},e),u=(d={},d[l.POSITION]=n,d[l.NORMAL]=u.indices,d);k&&(C[l.COLOR]={size:4,data:k},u[l.COLOR]=n);m&&
(C[l.SYMBOLCOLOR]={size:4,data:m},u[l.SYMBOLCOLOR]=this._createColorIndices(n));a.vertexAttributes.uv&&(C[l.UV0]={size:2,data:g},u[l.UV0]=n);a.vertexAttributes.tangent&&(C[l.TANGENT]={size:4,data:t},u[l.TANGENT]=n);n=new M.GeometryData(C,u);n=new L(n,c+"_mesh");r.push(n);B.push(E.mat4f64.create());y.push(this._getOrCreateMaterial(a,x))}}w&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.");
return{geometries:r,transformations:B,materials:y,objectTransformation:f}};d.prototype._createEdgeMaterial=function(){var a={opacity:this._getLayerOpacity()};return ka.createMaterial(this.symbolLayer,a)};d.validGeometryTypes=["mesh"];return d}(ja.default);J.Graphics3DMeshFillSymbolLayer=r;var H=q.vec3f64.create(),g=q.vec3f64.create(),z=q.vec3f64.create(),D=q.vec3f64.create(),y=q.vec3f64.create(),X=E.mat4f64.create(),I=ca.mat3f64.create(),P=G.create(),pa=[new ea];J.default=r});