// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/assignHelper ../../../../Color ../../../../core/lang ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(C,D,U,J,K,ea,E,L,l,M,u,N,g,h,p,m,V,W,F,X,Y,t,O,Z,v,G,aa,w,P,ba,ca,x,da){Object.defineProperty(D,"__esModule",{value:!0});C=function(q){function c(b,a,d,e){b=q.call(this,b,a,d,e)||this;b._removeResource=null;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;b.ensureDrapedStatus(!1);return b}U(c,q);c.prototype.getCachedSize=function(){var b=this._symbolSize;return{width:b[0],depth:b[1],height:b[2]}};c.prototype.doLoad=function(b){return K(this,void 0,void 0,function(){var a,d,e,f;return J(this,
function(c){switch(c.label){case 0:a=this._getIdHint("_objectmat");if(!this._drivenProperties.size&&(d=t.validateSymbolLayerSize(this.symbolLayer)))throw Error();e=this.symbolLayer;return this.isByResource?[4,this._prepareModelResources(e.resource.href,b)]:[3,2];case 1:return c.sent(),[3,3];case 2:f=e.resource?e.resource.primitive:V.defaultPrimitive,this._preparePrimitiveResources(f,a),c.label=3;case 3:return[2]}})})};Object.defineProperty(c.prototype,"isByResource",{get:function(){return!(!this.symbolLayer.resource||
!this.symbolLayer.resource.href)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"lodRenderer",{get:function(){return this._lodRenderer},enumerable:!0,configurable:!0});c.prototype.setMaterialTransparencyParams=function(b,a){void 0===a&&(a=l.get(this.symbolLayer,"material","color"));a=this._getCombinedOpacity(a);b.transparent=1>a||this.needsDrivenTransparentPass;b.opacity=a;return b};c.prototype._preparePrimitiveResources=function(b,a){if(!G.isValidPrimitive(b))throw Error("Unknown object symbol primitive: "+
b);var d=this.symbolLayer;this._resourceBoundingBox=m.create(G.primitiveBoundingBox(b));this._resourceSize=h.vec3f64.fromArray(m.size(this._resourceBoundingBox));this._symbolSize=h.vec3f64.fromArray(t.computeSizeWithResourceSize(this._resourceSize,d));this._isWosr=this._isEsriSymbolResource=!1;var e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:h.vec3f64.ONES,diffuse:h.vec3f64.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,
castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:this.symbolLayer.isPrimitive};this.setMaterialTransparencyParams(e);var f=this.symbol;if("point-3d"===f.type&&f.verticalOffset){var f=f.verticalOffset,c=f.minWorldLength,k=f.maxWorldLength;e.verticalOffset={screenLength:M.pt2px(f.screenLength),minWorldLength:c||0,maxWorldLength:null!=k?k:Infinity};e.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);
this._drivenProperties.color?e.externalColor=p.vec4f64.ONES:(d=l.isSome(d.material)&&d.material.color,d=l.isSome(d)?E.toUnitRGBA(d):p.vec4f64.ONES,e.externalColor=d);this._fastUpdates=w.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled?(L.mixin(e,this._fastUpdates.materialParameters),e.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(e.instanced.push("color"),this._optionalFields.push("color"));
e=new da(e,a);this._lodResources=G.primitiveLodResources(b,e,a);this._originalOpacities=x.materialsFromLodResources(this._lodResources).map(function(){return 1});if(!this._lodResources)throw Error("Unknown object symbol primitive: "+b);this._finalizeSymbolResources();this._initializeLodRenderer();this.complexity=this.computeComplexity()};c.prototype._prepareModelResources=function(b,a){return K(this,void 0,void 0,function(){var d,e,f,c,k,g,R,n,y,z,H,S,p,r,u,v,q,A=this;return J(this,function(Q){switch(Q.label){case 0:return d=
["transformation"],e={instanced:d,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},f={materialParamsMixin:e,streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache},this._fastUpdates=w.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(L.mixin(f.materialParamsMixin,this._fastUpdates.materialParameters),d.push("featureAttribute"),this._optionalFields.push("featureAttribute")):
this._hasPerInstanceColor()&&(d.push("color"),this._optionalFields.push("color")),c=this.symbol,"point-3d"===c.type&&c.verticalOffset&&(k=c.verticalOffset,g=k.screenLength,R=k.minWorldLength,n=k.maxWorldLength,f.materialParamsMixin.verticalOffset={screenLength:M.pt2px(g),minWorldLength:R||0,maxWorldLength:null!=n?n:Infinity},f.materialParamsMixin.castShadows=!1),f.signal=a,f.usePBR=this._context.physicalBasedRenderingEnabled,[4,Z.fetch(b,f)];case 1:return y=Q.sent(),this._isEsriSymbolResource=y.isEsriSymbolResource,
this._isWosr=y.isWosr,this._removeResource=y.remove,z=O.makeLodResources(y.lods),O.fillEstimatedMinScreenSpaceRadius(z),z.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius}),z.levels[0].minScreenSpaceRadius=Math.min(2,z.levels[0].minScreenSpaceRadius),this._lodResources=z,H=this._context,S=this.symbolLayer.material,p=this._getExternalColorParameters(S),r=l.get(this.symbolLayer,"material","color"),u=this._getCombinedOpacity(r,{hasIntrinsicColor:!0}),v=this.needsDrivenTransparentPass,
q=x.materialsFromLodResources(this._lodResources),this._originalOpacities=q.map(function(a){return a.getParameters().opacity||1}),q.forEach(function(a){var b=a.getParameters();a.setParameterValues(p);var d=b.opacity*u;a.setParameterValues({opacity:d,transparent:1>d||v||b.transparent});H.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:H.sharedResources.screenSizePerspectiveSettings})}),this._resourceBoundingBox=y.referenceBoundingBox,this._resourceSize=h.vec3f64.fromArray(m.size(this._resourceBoundingBox)),
this._pivotOffset=h.vec3f64.fromArray(this._lodResources.levels[0].pivotOffset),this._symbolSize=h.vec3f64.fromArray(t.computeSizeWithResourceSize(this._resourceSize,this.symbolLayer)),w.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions())&&q.forEach(function(a){return a.setParameterValues(A._fastUpdates.materialParameters)}),this._finalizeSymbolResources(),this._initializeLodRenderer(),this.complexity=this.computeComplexity(),[2]}})})};c.prototype._finalizeSymbolResources=
function(){var b=this._context.stage;this._materials=x.materialsFromLodResources(this._lodResources);this._materials.forEach(function(a){b.add(3,a)});this._textures=x.texturesFromLodResources(this._lodResources);this._textures.forEach(function(a){b.add(4,a)});this._geometries=x.geometriesFromLodResources(this._lodResources);this._geometries.forEach(function(a){b.add(2,a)})};c.prototype._initializeLodRenderer=function(){var b=this,a=this._context.stage;this._lodRenderer=new ca.LodRenderer(this._lodResources,
this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:function(a){return b._instanceIndexToGraphicUid.get(a)},notifyGraphicUpdate:function(a,e){return b._context.notifyGraphicUpdate(b._instanceIndexToGraphicUid.get(a),e)}},this._fastUpdates.enabled?{applyTransform:function(a,e,c){a.getFeatureAttribute(e,A);u.mat4.copy(c,w.evaluateModelTransform(b._fastUpdates.materialParameters,A,c))},scaleFactor:function(a,e,c){e.getFeatureAttribute(c,A);return w.evaluateModelTransformScale(a,b._fastUpdates.materialParameters,
A)}}:null);this._lodRenderer.slicePlane=this._context.slicePlaneEnabled;a.addRenderPlugin(this._lodRenderer.slots,this._lodRenderer)};c.prototype._getExternalColorParameters=function(b){var a={};this._drivenProperties.color?a.externalColor=p.vec4f64.ONES:l.isSome(b)&&l.isSome(b.color)?a.externalColor=E.toUnitRGBA(b.color):(a.externalColor=p.vec4f64.ONES,a.colorMixMode="ignore");return a};c.prototype.destroy=function(){q.prototype.destroy.call(this);var b=this._context.stage;this._lodRenderer&&(b.removeRenderPlugin(this._lodRenderer),
this._lodRenderer.destroy());this._materials&&this._materials.forEach(function(a){return b.remove(3,a.id)});this._textures&&this._textures.forEach(function(a){return b.remove(4,a.id)});this._geometries&&this._geometries.forEach(function(a){return b.remove(2,a.id)});l.isSome(this._removeResource)&&this._removeResource()};c.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if(!this._validateGeometry(a.geometry))return null;var d=v.placePointOnGeometry(a.geometry);if(l.isNone(d))return this.logger.warn("unsupported geometry type for icon symbol: "+
a.geometry.type),null;var e=this.getGraphicElevationContext(a);return this._createAs3DShape(a,d,b.renderingInfo,e,a.uid)};c.prototype.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};c.prototype.graphicLayerToGraphicId=function(){return 0};c.prototype.layerOpacityChanged=function(){var b=this,a=this._drivenProperties.opacity,d=this.isByResource;this._materials.forEach(function(e,c){var f=l.get(b.symbolLayer,"material","color");c=b._getCombinedOpacity(f,
{hasIntrinsicColor:d})*b._originalOpacities[c];e.setParameterValues({opacity:c,transparent:1>c||a})});return!0};c.prototype.layerElevationInfoChanged=function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,F.needsElevationUpdates3D)};c.prototype.slicePlaneEnabledChanged=function(){var b=this;this._lodRenderer.slicePlane=this._context.slicePlaneEnabled;this._materials.forEach(function(a){a.setParameterValues({slicePlaneEnabled:b._context.slicePlaneEnabled})});return!0};c.prototype.physicalBasedRenderingChanged=
function(){var b=this;this._materials.forEach(function(a){b.isByResource?b._isEsriSymbolResource&&!b._isWosr&&a.setParameterValues({usePBR:b._context.physicalBasedRenderingEnabled,isSchematic:!1}):a.setParameterValues({usePBR:b._context.physicalBasedRenderingEnabled,isSchematic:!0})});return!0};c.prototype.pixelRatioChanged=function(){return!0};c.prototype.applyRendererDiff=function(b,a){var d=this,e;for(e in b.diff)switch(e){case "visualVariables":if(w.updateFastSymbolUpdatesState(this._fastUpdates,
a,this._fastVisualVariableConvertOptions()))this._materials.forEach(function(a){return a.setParameterValues(d._fastUpdates.materialParameters)}),this._lodRenderer.notifyShaderTransformationChanged();else return!1;break;default:return!1}return!0};c.prototype.computeComplexity=function(){if(!this._lodResources)return q.prototype.computeComplexity.call(this);var b=x.geometriesFromLodLevelResources(this._lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(ba.VertexAttrConstants.POSITION).length},
0)/3,a=aa.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,estimated:!1,memory:a}};c.prototype._createAs3DShape=function(b,a,d,e,c){b=this.getFastUpdateAttrValues(b);var f=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?t.mixinColorAndOpacity(d.color,d.opacity):null,k=this._context.clippingExtent;P.pointToVector(a,r,this._context.elevationProvider.spatialReference);if(l.isSome(k)&&!m.containsPoint(k,r))return null;var k=
this._requiresTerrainElevation(e),h=this._computeGlobalTransform(a,e,I,k?B:null);d=this._computeLocalTransform(this.symbolLayer,d,T);var g=this._lodRenderer.instanceData,n=g.addInstance();this._instanceIndexToGraphicUid.set(n,c);g.setLocalTransform(n,d,!1);g.setGlobalTransform(n,h);b&&g.setFeatureAttribute(n,b);f&&g.setColor(n,f);c=new X(this,n,W.perLodInstanceElevationAligner,e);k&&(c.alignedSampledElevation=B.sampledElevation);c.needsElevationUpdates=F.needsElevationUpdates3D(e.mode);v.extendPointGraphicElevationContext(c,
a,this._context.elevationProvider);return c};c.prototype._computeGlobalTransform=function(b,a,d,c){a=F.evaluateElevationAlignmentAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,c);r[0]=b.x;r[1]=b.y;r[2]=a;P.computeLinearTransformation(b.spatialReference,r,d,this._context.renderCoordsHelper.spatialReference);return d};c.prototype._computeLocalTransform=function(b,a,d){u.mat4.identity(d);this._applyObjectRotation(a,!1,d);this._applyObjectRotation(b,!0,d);this._applyObjectScale(a,
d);this._applyAnchor(b,d);return d};c.prototype._applyObjectScale=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=t.computeObjectScale(this._drivenProperties.size&&b.size?b.size:this._symbolSize,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||u.mat4.scale(a,a,b))};c.prototype.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);
this._preparePatchColor(b,a)}};c.prototype.updateGeometry=function(b,a){var d=a&&v.placePointOnGeometry(a);if(l.isNone(d))return!1;a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(d,b.elevationContext,I,a?B:null);a&&(b.alignedSampledElevation=B.sampledElevation);this._lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,I,!0);v.extendPointGraphicElevationContext(b,d,this._context.elevationProvider);
return!0};c.prototype._preparePatchTransform=function(b,a){var d=this;if(a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition){var c=function(a,b,c){return(null!=a&&"complete"===a.type?a.newValue:b)||c},f=c(a.heading,this.symbolLayer.heading,0),g=c(a.tilt,this.symbolLayer.tilt,0),k=c(a.roll,this.symbolLayer.roll,0),l=c(a.width,this.symbolLayer.width,void 0),m=c(a.height,this.symbolLayer.height,void 0),n=c(a.depth,this.symbolLayer.depth,void 0),p=c(a.anchor,this.symbolLayer.anchor,
void 0),c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var q={heading:f,tilt:g,roll:k,anchor:p,anchorPosition:c};1===this.loadStatus&&b.symbolLayerStatePatches.push(function(){d._symbolSize=h.vec3f64.fromArray(t.computeSizeWithResourceSize(d._resourceSize,{width:l,height:m,depth:n,isPrimitive:d.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push(function(a,
b){b=d._computeLocalTransform(q,b,T);d._lodRenderer.instanceData.setLocalTransform(a.instanceIndex,b,!0)})}};c.prototype._preparePatchColor=function(b,a){var c=this;if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var e=a.color.newValue,f=l.isSome(e)?E.toUnitRGBA(e):p.vec4f64.ONES;delete a.color;b.graphics3DGraphicPatches.push(function(a){c._hasPerInstanceColor()?(c._lodRenderer.instanceData.setColor(a.instanceIndex,
f),a=c.setMaterialTransparencyParams({},e)):a=c.setMaterialTransparencyParams({externalColor:f},e);for(var b=0,d=c._materials;b<d.length;b++)d[b].setParameterValues(a)})}};c.prototype._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};c.prototype._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return t.computeObjectRotation(b.heading,b.tilt,b.roll,c)};c.prototype._computeAnchor=function(b){var a=h.vec3f64.create();
switch(b.anchor){case "center":g.vec3.copy(a,m.center(this._resourceBoundingBox));g.vec3.negate(a,a);break;case "top":var c=m.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[5]);break;case "bottom":c=m.center(this._resourceBoundingBox);g.vec3.set(a,-c[0],-c[1],-this._resourceBoundingBox[2]);break;case "relative":var c=m.center(this._resourceBoundingBox),e=m.size(this._resourceBoundingBox);b=(b=b.anchorPosition)?h.vec3f64.fromValues(b.x,b.y,b.z):h.vec3f64.ZEROS;
g.vec3.multiply(a,e,b);g.vec3.add(a,a,c);g.vec3.negate(a,a);break;default:this._pivotOffset?g.vec3.negate(a,this._pivotOffset):g.vec3.copy(a,h.vec3f64.ZEROS)}return a};c.prototype._applyAnchor=function(b,a){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b))&&u.mat4.translate(a,a,b)};c.prototype._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};c.prototype._fastVisualVariableConvertOptions=function(){var b=
this._resourceBoundingBox?h.vec3f64.fromArray(m.size(this._resourceBoundingBox)):h.vec3f64.ONES,a=this._resourceBoundingBox?this._computeAnchor(this.symbolLayer):h.vec3f64.ZEROS,c=this._context.renderCoordsHelper.unitInMeters,e=t.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,c),f=h.vec3f64.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:b,symbolSize:this._symbolSize||h.vec3f64.ONES,unitInMeters:c,transformation:{anchor:a,
scale:e,rotation:f}}};return c}(Y.default);D.Graphics3DObjectSymbolLayer=C;var r=h.vec3f64.create(),T=N.mat4f64.create(),I=N.mat4f64.create(),A=p.vec4f64.create(),B={verticalDistanceToGround:0,sampledElevation:0};D.default=C});