// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat2 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(C,m,Y,ma,Z,aa,ba,ca,E,z,da,K,ea,e,L,M,F,A,N,H,fa,G,O,P,Q,ga,ha,c,ia,ja){function R(g,a,h){switch(a){case "world":for(var b=0,k=g.vertices;b<k.length;b++)a=k[b],e.vec3.add(n,a.pos,g.offset),h.worldUpAtPosition(n,t),a.setFrameFromUpVector(t),a.computeRotationAxisAndAngleFromUpVector();break;case "path":for(e.vec3.add(n,g.vertices[0].pos,g.offset),h.worldUpAtPosition(n,t),c.computeMinimumRotationTangentFrame(g,t),h=0,g=g.vertices;h<g.length;h++){a=g[h];b=E.sign(e.vec3.dot(a.frame.right,a.vRight));
e.vec3.cross(a.rotationFrame.up,a.vRight,a.vLeft);e.vec3.scale(a.rotationFrame.up,a.rotationFrame.up,b);e.vec3.normalize(a.rotationFrame.up,a.rotationFrame.up);var k=e.vec3.dot(a.rotationFrame.up,a.frame.up),v=e.vec3.dot(a.rotationFrame.up,a.frame.right);e.vec3.scale(n,a.frame.up,-v);e.vec3.scale(S,a.frame.right,k);e.vec3.add(n,n,S);e.vec3.normalize(a.rotationFrame.right,n);c.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right);e.vec3.negate(n,a.vLeft);a.rotationAngle=-b*(Math.PI-
E.acosClamped(e.vec3.dot(n,a.vRight)));0<Math.abs(a.rotationAngle)&&(b=1/Math.cos(.5*a.rotationAngle),da.mat2.set(a.miterStretch,1+(b-1)*a.rotationRight[0]*a.rotationRight[0],(b-1)*a.rotationRight[0]*a.rotationRight[1],(b-1)*a.rotationRight[0]*a.rotationRight[1],1+(b-1)*a.rotationRight[1]*a.rotationRight[1]));a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)/Math.cos(.5*(Math.PI-a.rotationAngle)))}}}function T(c,a,h){switch(c){case "symbolValue":return h;case "proportional":return a;
default:return c}}function ka(c,a,h,b){c=c.stageObject;var k=c.geometryRecords,v=k.length,U=0;w.spatialReference=h.spatialReference;la.spatialReference=b.spatialReference;for(var d=0;d<v;d++){var D=k[d].geometry,q=D.metadata,V=q.pathGeometry,x=V.builder.path;W.spatialReference=q.geometrySR;for(var p=x,y=a,g=h,f=b,l=0,r=0,u=p.vertices;r<u.length;r++){var m=u[r];w.x=m.posES[0];w.y=m.posES[1];w.z=m.posES[2];var n=N.evaluateElevationAlignmentAtPoint(w,g,y,f,X),l=l+X.sampledElevation;e.vec3.add(t,m.pos,
p.offset);f.setAltitude(n,t);e.vec3.subtract(m.pos,t,p.offset)}p.updatePathVertexInformation();U+=l/p.vertices.length;"world"!==x.upVector&&R(x,q.upVectorAlignment,b);V.onPathChanged();D.invalidateBoundingInfo();c.geometryVertexAttrsUpdated(d)}return U/v}Object.defineProperty(m,"__esModule",{value:!0});C=function(g){function a(a,b,k,v){a=g.call(this,a,b,k,v)||this;a._intrinsicSize=ea.vec2f64.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}Y(a,g);a.prototype.doLoad=
function(){return aa(this,void 0,void 0,function(){var a,b,k,v,e,d,D,q,g,x,p,y,n,f;return Z(this,function(h){a=z.isSome(this.symbolLayer.width)?this.symbolLayer.width:z.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size;b=z.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[a,1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,
color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?P.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};k=this.symbolLayer.anchor||"center";this.upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");v=this.symbolLayer.profile||"circle";switch(v){default:this._profile=c.Profile.circle(m.NUM_CIRCLE_PROFILE_SUBDIVISIONS);
break;case "quad":this._profile=c.Profile.rect()}e=[0,0];"center"!==k&&(e={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[k],this._profile.translate(e[0],e[1]));d=this.symbolLayer.join||"simple";switch(d){case "round":this._extruder=new c.MiterExtruder(0,m.NUM_ROUND_JOIN_SUBDIVISIONS);break;case "bevel":this._extruder=new c.MiterExtruder(0,1);break;case "miter":this._extruder=new c.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new c.SimpleExtruder}D=this.symbolLayer.cap||"butt";switch(D){case "none":this._startCap=
new c.NoCapBuilder;this._endCap=new c.NoCapBuilder;break;default:this._startCap=new c.TriangulationCapBuilder(this._profile,0);this._endCap=new c.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new c.TriangulationCapBuilder(this._profile,-.5);this._endCap=new c.TriangulationCapBuilder(this._profile,.5,!0);break;case "round":q="quad"===v?!0:!1,this._startCap=new c.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:q,subdivisions:m.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),
this._endCap=new c.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:q,subdivisions:m.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}g=this._getIdHint();x=z.get(this.symbolLayer,"material","color");p=this._getCombinedOpacityAndColor(x);y=M.vec3f64.fromArray(p);n=p[3];f={diffuse:y,ambient:y,opacity:n,transparent:1>n||this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===D?0:void 0,offsetTransparentBackfaces:!0};
if(!this._drivenProperties.size&&(K.vec2.set(this._intrinsicSize,a,b),!O.isValidSize(this._intrinsicSize[0])||!O.isValidSize(this._intrinsicSize[1])))throw new ba("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||K.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(ca.mixin(f,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],
this._intrinsicSize[1],0]}),this._material=new ja(f,g+"_pathmat")):(f.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ia(f,g+"_pathmat"));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(3,this._material);return[2]})})};a.prototype.destroy=function(){g.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};a.prototype.createGraphics3DGraphic=
function(h){var b=h.graphic;if(!this._validateGeometryType(b.geometry,a.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var k="graphic"+b.uid,v=this.getGraphicElevationContext(b);return this._createAs3DShape(b,h.renderingInfo,v,k,b.uid)};a.prototype.layerOpacityChanged=function(){var a=z.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,transparent:1>a||this.needsDrivenTransparentPass});return!0};
a.prototype.layerElevationInfoChanged=function(a,b){var h=this;a.forEach(function(a){var k=b(a);z.isSome(k)&&(a=h.getGraphicElevationContext(a.graphic),k.needsElevationUpdates=H.needsElevationUpdates3D(a.mode),k.elevationContext.set(a))});return H.SymbolUpdateType.UPDATE};a.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};a.prototype.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0});return!0};a.prototype.pixelRatioChanged=function(){return!0};a.prototype.applyRendererDiff=function(a,b){for(var h in a.diff)switch(h){case "visualVariables":if(P.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};a.prototype.getVertexData=function(a){for(var b=0,k=a.paths,h=[],c=a.spatialReference,d=this._context.elevationProvider.spatialReference,
e=this._context.renderCoordsHelper.spatialReference,q=0;q<k.length;q++)var g=k[q],b=b+g.length;for(var q=new Float64Array(3*b),m=new Float64Array(3*b),p=new Float64Array(3*b),n=0,t=0;t<k.length;t++){g=k[t];h.push({index:n,numVertices:g.length});for(var f=0;f<g.length;f++){var l=g[f];q[n++]=l[0];q[n++]=l[1];q[n++]=a.hasZ?l[2]:0}}a=!0;c.equals(d)?this._copyVertices(q,0,m,0,b):a=Q.bufferToBuffer(q,c,0,m,d,0,b);d.equals(e)?this._copyVertices(m,0,p,0,b):Q.bufferToBuffer(m,d,0,p,e,0,b);return{pathVertexDataInfos:h,
vertexDataGS:q,vertexDataES:m,vertexDataRS:p,projectionSuccess:a,terrainElevation:0}};a.prototype._copyVertices=function(a,b,c,e,g){b*=3;e*=3;for(var d=0;d<g;++d)c[e++]=a[b++],c[e++]=a[b++],c[e++]=a[b++]};a.prototype._createAs3DShape=function(a,b,k,g,m){var d=a.geometry,h=[],n=[],v=[],x=d.spatialReference,p=this._context.elevationProvider.spatialReference,y=F.create(),C=this._context.renderCoordsHelper;W.spatialReference=x;w.spatialReference=p;d=this.getVertexData(d);if(!d.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),
null;if(0<d.pathVertexDataInfos.length){for(p=0;p<d.pathVertexDataInfos.length;++p){var f=d.pathVertexDataInfos[p],l=f.index,f=f.numVertices;if(2>f)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");else{if(z.isSome(this._context.clippingExtent)&&(F.empty(y),F.expandWithBuffer(y,d.vertexDataES,3*l,f),!F.intersectsClippingArea(y,this._context.clippingExtent)))continue;for(var r=[],u=l;u<l+3*f;){var A=u++,I=u++,J=u++,B=new c.PathVertex;e.vec3.set(B.posGS,
d.vertexDataGS[A],d.vertexDataGS[I],d.vertexDataGS[J]);e.vec3.set(B.posES,d.vertexDataES[A],d.vertexDataES[I],d.vertexDataES[J]);w.x=B.posES[0];w.y=B.posES[1];w.z=B.posES[2];var E=N.evaluateElevationAlignmentAtPoint(w,this._context.elevationProvider,k,C,null);e.vec3.set(t,d.vertexDataRS[A],d.vertexDataRS[I],d.vertexDataRS[J]);C.setAltitude(E,t);e.vec3.set(B.pos,t[0],t[1],t[2]);r.push(B)}l=new c.Path(r);R(l,this.upVectorAlignment,this._context.renderCoordsHelper);l=new c.Builder(l,this._profile,this._extruder,
this._startCap,this._endCap);f=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,f=u.size?G.getAttributeValue(u.size.field,a):0,r=u.color?G.getAttributeValue(u.color.field,a):0,u=u.opacity?G.getAttributeValue(u.opacity.field,a):0,f=new c.FastUpdatePathGeometry(l,f,r,u)):(f=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(f[0]*=T(b.size[0],b.size[2],this.symbolLayer.width),f[1]*=T(b.size[2],b.size[0],this.symbolLayer.height)),r=null,this._drivenProperties.color&&
(r=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(r=r?[r[0],r[1],r[2],b.opacity]:[1,1,1,b.opacity]),l=new c.StaticPathGeometry(l),l.bake(f),r&&l.bakeVertexColors(r),f=l);l=f.createGeometryData();l=new ga(l,g+"path"+p);l.metadata={pathGeometry:f,geometrySR:x,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};h.push(l);n.push(this._material);v.push(f.xform)}}a={layerUid:this._context.layer.uid,graphicUid:m};if(0<h.length)return g=new ha({geometries:h,materials:n,transformations:v,
castShadow:!0,metadata:a,idHint:g}),h=new fa(this,g,h,null,null,ka,k),h.alignedSampledElevation=d.terrainElevation,h.needsElevationUpdates=H.needsElevationUpdates3D(k.mode),h}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};a.validGeometryTypes=["polyline"];return a}(G.Graphics3DSymbolLayer);m.Graphics3DPathSymbolLayer=C;var la=A.makeDehydratedPoint(0,0,0,null),w=A.makeDehydratedPoint(0,0,0,null),W=A.makeDehydratedPoint(0,0,0,null),t=M.vec3f64.create(),
n=L.vec3f32.create(),S=L.vec3f32.create();m.NUM_ROUND_JOIN_SUBDIVISIONS=3;m.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;m.NUM_CIRCLE_PROFILE_SUBDIVISIONS=10;var X={verticalDistanceToGround:0,sampledElevation:0};m.default=C});