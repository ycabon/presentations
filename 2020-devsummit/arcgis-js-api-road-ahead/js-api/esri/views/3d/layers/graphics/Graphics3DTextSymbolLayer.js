// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Error ../../../../core/maybe ../../../../core/ObjectPool ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../symbols/callouts/calloutUtils ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./pointUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTexture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(n,q,z,A,B,C,g,D,E,F,G,H,v,I,J,w,r,K,L,t,M,N,x){function u(f,c,a){f&&f.forEach(function(b){var y=c(b);g.isSome(y)&&a(y,b.graphic)})}Object.defineProperty(q,"__esModule",{value:!0});var O=[0,0,1];n=function(f){function c(a,b,c,d){a=f.call(this,a,b,c,d)||this;a._geometryDataPool=new D(L.GeometryData,function(a,b,d){var c=b.translation;d=g.isSome(d)?[d.displayWidth,d.displayHeight]:[0,0];b=b.centerOffset;0===a.indexCount?t.createPointGeometry(O,c,null,d,b,[0,0],null,a):t.updatePointGeometry(null,
c,null,d,b,null,null,a)});a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};a.ensureDrapedStatus(!1);return a}z(c,f);c.prototype.doLoad=function(){return B(this,void 0,void 0,function(){var a;return A(this,function(b){if(!this._drivenProperties.size&&(a=w.validateSymbolLayerSize(this.symbolLayer.size)))throw new C("graphics3dtextsymbollayer:invalid-size",a);this._createTextRenderParameters();return[2]})})};c.prototype._createTextRenderParameters=function(){this._textRenderParameters=
M.default.fromSymbol(this.symbolLayer,this._context.layerView.view.pixelRatio)};c.prototype.destroy=function(){f.prototype.destroy.call(this);this._geometryDataPool.destroy()};c.prototype.createGraphics3DGraphic=function(a){a=a.graphic;var b=r.placePointOnGeometry(a.geometry);if(g.isNone(b))return this.logger.warn("unsupported geometry type for text symbol: "+a.geometry.type),null;var c=this.symbolLayer.text;if(!c)return null;var d=G.isCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?
this.symbol:null;return this._createAs3DShape(a,b,c,d)};c.prototype.onRemoveGraphic=function(a){this._geometryDataPool.release(a.stageObject.geometries[0].data)};c.prototype.createLabel=function(a,b,c,d){a=a.graphic;var h=r.placePointOnGeometry(a.geometry);if(g.isNone(h))return this.logger.warn("unsupported geometry type for label: "+a.geometry.type),null;var k=b.text;return k?this._createAs3DShape(a,h,k,b,b,c,d):null};c.prototype.getGraphicElevationContext=function(a,b){void 0===b&&(b=0);a=f.prototype.getGraphicElevationContext.call(this,
a);a.addOffsetRenderUnits(b);return a};c.prototype.layerOpacityChanged=function(){this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");return!1};c.prototype.layerElevationInfoChanged=function(a,b){var c=this;u(a,b,function(a,b){c.updateGraphicElevationContext(b,a)});return v.SymbolUpdateType.UPDATE};c.prototype.slicePlaneEnabledChanged=function(a,b){var c=this;u(a,b,function(a){var b=0;for(a=a.stageObject.geometryRecords;b<a.length;b++)a[b].material.setParameterValues({slicePlaneEnabled:c._context.slicePlaneEnabled})});
return!0};c.prototype.physicalBasedRenderingChanged=function(){return!0};c.prototype.pixelRatioChanged=function(){return!1};c.prototype.updateGraphicElevationContext=function(a,b){a=this.getGraphicElevationContext(a,b.metadata.elevationOffset);b.elevationContext.set(a);b.needsElevationUpdates=v.needsElevationUpdates2D(a.mode)||"absolute-height"===a.mode};c.prototype._defaultElevationInfoNoZ=function(){return P};c.prototype._createAs3DShape=function(a,b,c,d,h,k,f){void 0===h&&(h=Q);var p=this.getGraphicElevationContext(a,
h.elevationOffset),m=this._context.layer.id+"_label_"+a.uid,l="polyline"===g.get(a.geometry,"type"),n=a.uid;a=this._context.stage.renderView.renderingContext;var e=w.namedAnchorToHUDMaterialAnchorPos[h.anchor in w.namedAnchorToHUDMaterialAnchorPos?h.anchor:"center"];a=g.isNone(f)?new N(a,c,this._textRenderParameters,m):null;e={occlusionTest:!0,screenOffset:h.screenOffset,anchorPos:e,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:h.centerOffsetUnits,debugDrawBorder:h.debugDrawBorder,drawInSecondSlot:!0};
g.isSome(a)&&(e.textureId=a.id,e.texCoordScale=a.texcoordScale);g.isSome(f)&&(e.textureId=f.textureId);if(g.isSome(d)&&g.isSome(d.verticalOffset)){d=d.verticalOffset;f=d.minWorldLength;var q=d.maxWorldLength;e.verticalOffset={screenLength:E.pt2px(d.screenLength),minWorldLength:f||0,maxWorldLength:null!=q?q:Infinity}}this._context.screenSizePerspectiveEnabled&&(d=this._context.sharedResources,f=d.screenSizePerspectiveSettings,e.screenSizePerspective=d.screenSizePerspectiveSettingsLabels.overridePadding(this._textRenderParameters.haloSize),
e.screenSizePerspectiveAlignment=f);l&&(e.shaderPolygonOffset=1E-4);e.slicePlaneEnabled=this._context.slicePlaneEnabled;l=null;g.isSome(k)?(d=JSON.stringify(e),l=k.getMaterial(d),null==l&&(l=new x(e,m),k.addMaterial(d,l))):l=new x(e,m);l=[l];e=this._geometryDataPool.acquire(h,a);e=[new K(e,m)];m=r.createStageObjectForHUD(this._context,b,e,l,null,null,p,m,this._context.layer.uid,n);if(null===m)return null;n=H.perObjectElevationAligner;k=new I(this,m.object,e,g.isNone(k)?l:null,g.isSome(a)?[a]:null,
n,p);k.alignedSampledElevation=m.sampledElevation;k.needsElevationUpdates=v.needsElevationUpdates2D(p.mode)||"absolute-height"===p.mode;var p=g.isSome(a)?a:h,t=p.displayWidth,u=p.displayHeight;k.getScreenSize=function(a){void 0===a&&(a=F.vec2f64.create());a[0]=t;a[1]=u;return a};k.metadata={labelText:c,elevationOffset:h.elevationOffset};r.extendPointGraphicElevationContext(k,b,this._context.elevationProvider);return k};return c}(J.default);q.Graphics3DTextSymbolLayer=n;var P={mode:"relative-to-ground",
offset:0},Q={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};q.default=n});