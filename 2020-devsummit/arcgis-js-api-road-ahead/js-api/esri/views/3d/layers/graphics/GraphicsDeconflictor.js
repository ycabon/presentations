// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/Handles ../../../../core/MapUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ./Deconflictor ./LabelDeconflictor ../../support/geometryUtils ../../../support/Scheduler".split(" "),function(g,h,n,p,q,r,t,k,l,u,m,v){function f(e){e=e.layer;return!(!e||!e.featureReduction||"selection"!==e.featureReduction.type)}function w(e){(e=e.graphics3DGraphics)&&
e.forEach(function(d){return d.clearVisibilityFlag(3)})}Object.defineProperty(h,"__esModule",{value:!0});g=function(e){function d(){var a=null!==e&&e.apply(this,arguments)||this;a._handles=new q;a._contexts=new Map;a.visibilityGroup=0;a._iconMarginFactor=-.1;return a}p(d,e);Object.defineProperty(d.prototype,"labels",{get:function(){return this._labels},enumerable:!0,configurable:!0});d.prototype.initialize=function(){var a=this;this._handles.add([this.view.watch("state.camera",function(){a.updateSlicePlane();
a.setDirty()}),this.view.watch("map.ground.opacity",function(b,c){1!==b&&1!==c||a.setDirty()}),t.init(this.view,"slicePlane",function(){return a.updateSlicePlane()})]);this._frameTask=this.view.resourceController.scheduler.registerTask(v.Task.GRAPHICS_DECONFLICTOR,function(b){return a.update(b)},function(){return a.needsUpdate()});this._labels=new u.LabelDeconflictor({view:this.view,parent:this})};d.prototype.destroy=function(){this._labels.destroy();this._labels=null;this._handles.destroy();this._handles=
null;this._frameTask&&(this._frameTask.remove(),this._frameTask=null)};Object.defineProperty(d.prototype,"iconMarginFactor",{get:function(){return this._iconMarginFactor},set:function(a){this._iconMarginFactor=a;this.setDirty()},enumerable:!0,configurable:!0});d.prototype.setDirty=function(){0<this._contexts.size&&(this.inherited(arguments),this._labels.setDirty())};d.prototype.update=function(a){this.inherited(arguments,[a]);this.needsUpdate()||this._labels.setDirty()};d.prototype.setInitialIconVisibilityFlag=
function(a,b){a=!(this._graphicSupportsDeconfliction(b)&&f(a));b.setVisibilityFlag(3,a,0)};d.prototype.updateSlicePlane=function(){var a=this.view&&this.view.slicePlane;a?(this.slicePlaneViewSpace||(this.slicePlaneViewSpace=m.boundedPlane.create()),m.boundedPlane.transform(a,this.view.state.camera.viewMatrix,this.slicePlaneViewSpace),this.slicePlaneChanged()):this.slicePlaneViewSpace&&(this.slicePlaneViewSpace=null,this.slicePlaneChanged())};d.prototype.slicePlaneChanged=function(){r.someMap(this._contexts,
function(a,b){return b.symbolCreationContext.slicePlaneEnabled})&&this.setDirty()};d.prototype.addGraphicsOwner=function(a){var b=this,c=this._contexts.get(a);null==c&&(c=new Map,this._contexts.set(a,c),this.setDirty());return{addGraphic:function(d){return b.addGraphic(a,c,d)},removeGraphic:function(a){return b.removeGraphic(c,a)},labelingInfoChange:function(){return b._labels.enabledChanged(a,c)},featureReductionChange:function(){return b.enabledChanged(a,c)},slicePlaneEnabledChange:function(){return b._slicePlaneEnabledChanged(a,
c)},clear:function(){return c.forEach(function(a){return b.removeGraphic(c,a.graphics3DGraphic)})}}};d.prototype.removeGraphicsOwner=function(a){var b=this,c=this._contexts.get(a);c&&(c.forEach(function(a){return b.removeGraphic(c,a.graphics3DGraphic)}),this._contexts.delete(a),this.setDirty())};d.prototype.addGraphic=function(a,b,c){var d=c.graphic.uid;c=new l.DeconflictorGraphic(c,a.symbolCreationContext.slicePlaneEnabled);b.set(d,c);f(a)&&this.addToActiveGraphics(c);a.labelsEnabled&&this._labels.addToActiveGraphics(c)};
d.prototype.removeGraphic=function(a,b){b=b.graphic.uid;var c=a.get(b);c&&(this.removeFromActiveGraphics(c),this._labels.removeFromActiveGraphics(c),a.delete(b),this.setDirty())};d.prototype.enabledChanged=function(a,b){var c=f(a);c||w(a);this.modifyGraphics(b,c)};d.prototype._slicePlaneEnabledChanged=function(a,b){var c=a.symbolCreationContext.slicePlaneEnabled;b.forEach(function(a){return a.slicePlaneEnabled=c});this.setDirty()};d.prototype.getGraphicsLayers=function(a){return a._graphics};d.prototype._graphicSupportsDeconfliction=
function(a){if(a.isDraped)return!1;a=a._graphics;if(!a||!a.length)return!1;for(var b=0;b<a.length;b++)if(this.layerSupportsDeconfliction(a[b]))return!0;return!1};return d=n([k.subclass("esri.views.3d.layers.graphics.GraphicsDeconflictor")],d)}(k.declared(l.Deconflictor));h.GraphicsDeconflictor=g});