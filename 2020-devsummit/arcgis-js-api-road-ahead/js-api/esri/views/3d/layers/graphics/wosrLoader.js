// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../request ../../../../core/asyncUtils ../../../../core/Error ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/Version ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../support/imageUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(W,x,X,u,r,I,y,J,K,L,B,t,E,F,v,M,N,O,P,Q){function R(e,f){return r(this,void 0,void 0,function(){var b,a;return u(this,function(g){switch(g.label){case 0:return(b=B.isSome(f)&&f.streamDataRequester)?[2,S(e,b,f)]:[4,y.result(I(e,B.unwrap(f)))];case 1:a=g.sent();if(!0===a.ok)return[2,a.value.data];t.throwIfAbortError(a.error);G(a.error);return[2,void 0]}})})}function S(e,f,b){return r(this,void 0,void 0,function(){var a;return u(this,function(g){switch(g.label){case 0:return[4,y.result(f.request(e,
"json",b))];case 1:a=g.sent();if(!0===a.ok)return[2,a.value];t.throwIfAbortError(a.error);G(a.error.details.url);return[2,void 0]}})})}function G(e){throw new J("","Request for object resource failed: "+e);}function T(e){var f=v.empty();e.forEach(function(b){b=b.boundingInfo;v.expand(f,b.getBBMin());v.expand(f,b.getBBMax())});return f}function H(e,f){return r(this,void 0,void 0,function(){var b,a,g,z,n,w,p,l;return u(this,function(A){switch(A.label){case 0:b=[];a=function(a){var g=e[a],l=g.images[0].data;
if(!l)return q.warn("Externally referenced texture data is not yet supported"),"continue";var l=g.encoding+";base64,"+l,n="/textureDefinitions/"+a,c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:!0};a=B.isSome(f)&&f.disableTextures?t.resolve(null):M.requestImage(l,f);b.push(a.then(function(a){return{refId:n,image:a,params:c,alphaChannelUsage:"rgba"===g.channels?g.alphaChannelUsage||"transparency":"none"}}))};for(g in e)a(g);return[4,t.all(b)];case 1:z=A.sent();n={};w=0;for(p=z;w<p.length;w++)l=
p[w],n[l.refId]=l;return[2,n]}})})}function U(e){switch(e){case "mask":return"mask";case "maskAndTransparency":return"maskBlend";case "none":return"opaque";case "transparency":return"blend";default:return"blend"}}Object.defineProperty(x,"__esModule",{value:!0});var q=L.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");x.load=function(e,f){return r(this,void 0,void 0,function(){var b,a;return u(this,function(g){switch(g.label){case 0:return[4,R(e,f)];case 1:return b=g.sent(),[4,H(b.textureDefinitions,
f)];case 2:return a=g.sent(),[2,{resource:b,textures:a}]}})})};x.processLoadResult=function(e,f){var b,a,g=[],z=[],n=[],w=[],p=e.resource,l=E.Version.parse(p.version||"1.0","wosr");V.validate(l);var l=p.model.name,A=p.model.geometries,x=p.materialDefinitions;e=e.textures;for(var u=0,r=new Map,t=0;t<A.length;t++){var c=A[t];a=c;var d=a.params,m=d.topology;b=!0;d.vertexAttributes||(q.warn("Geometry must specify vertex attributes"),b=!1);switch(d.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:m=
d.faces;if(!m)q.warn("Indexed geometries must specify faces"),b=!1;else if(d.vertexAttributes){var k=void 0;for(k in d.vertexAttributes)(d=m[k])&&d.values?(null!=d.valueType&&"UInt32"!==d.valueType&&(q.warn("Unsupported indexed geometry indices type '"+d.valueType+"', only UInt32 is currently supported"),b=!1),null!=d.valuesPerElement&&1!==d.valuesPerElement&&(q.warn("Unsupported indexed geometry values per element '"+d.valuesPerElement+"', only 1 is currently supported"),b=!1)):(q.warn("Indexed geometry does not specify face indices for '"+
k+"' attribute"),b=!1)}break;default:q.warn("Unsupported topology '"+m+"'"),b=!1}a.params.material||(q.warn("Geometry requires material"),b=!1);a=a.params.vertexAttributes;d=void 0;for(d in a)a[d].values||(q.warn("Geometries with externally defined attributes are not yet supported"),b=!1);if(b){a=c.params;b=a.material;a=a.texture;var m=c.params.vertexAttributes,d={},v;for(v in m)k=m[v],d[v]={data:k.values,size:k.valuesPerElement};m={};if("PerAttributeArray"===c.params.topology){for(var c=d.position.data.length/
d.position.size,k=new Uint32Array(c),h=0;h<c;h++)k[h]=h;var c=k,y;for(y in d)m[y]=c}else{var c=c.params.faces,D;for(D in c)m[D]=new Uint32Array(c[D].values)}(c=e&&e[a])&&!r.has(a)&&(k=new P(c.image,l,c.params),w.push(k),r.set(a,k));k=(k=r.get(a))?k.id:void 0;h=n[b]?n[b][a]:null;if(!h){h=b.substring(b.lastIndexOf("/")+1);h=x[h].params;1===h.transparency&&(h.transparency=0);var C=c&&c.alphaChannelUsage,C=0<h.transparency||"transparency"===C||"maskAndTransparency"===C,c={ambient:F.vec3f64.fromArray(h.diffuse),
diffuse:F.vec3f64.fromArray(h.diffuse),opacity:1-(h.transparency||0),transparent:C,textureAlphaMode:c?U(c.alphaChannelUsage):void 0,textureAlphaCutoff:.33,textureId:k,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:h.externalColorMixMode||"tint",textureAlphaPremultiplied:!0};B.isSome(f)&&f.materialParamsMixin&&K.mixin(c,f.materialParamsMixin);h=new Q(c,l);n[b]||(n[b]={});n[b][a]=h}z.push(h);b=new N(new O.GeometryData(d,m),l);u+=m.position?m.position.length:0;g.push(b)}}return{name:l,
stageResources:{textures:w,materials:z,geometries:g},pivotOffset:p.model.pivotOffset,boundingBox:T(g),numberOfVertices:u,lodThreshold:null}};x.createTextureResources=H;var V=new E.Version(1,2,"wosr")});