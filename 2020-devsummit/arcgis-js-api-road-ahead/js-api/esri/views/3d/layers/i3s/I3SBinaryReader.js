// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/Error ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ./LEPCC".split(" "),function(H,h,n,l,D,E,F,u){function G(b,a,c){for(var f="",g=0;g<c;){var d=b[a+g];if(128>d)f+=String.fromCharCode(d),g++;else if(192<=d&&224>d){if(g+1>=c)throw new l("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var e=b[a+g+1],d=(d&31)<<6|e&63,f=f+String.fromCharCode(d),g=g+2}else if(224<=d&&240>
d){if(g+2>=c)throw new l("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");var e=b[a+g+1],k=b[a+g+2],d=(d&15)<<12|(e&63)<<6|k&63,f=f+String.fromCharCode(d),g=g+3}else if(240<=d&&248>d){if(g+3>=c)throw new l("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");e=b[a+g+1];k=b[a+g+2];d=(d&7)<<18|(e&63)<<12|(k&63)<<6|b[a+g+3]&63;f=65536<=d?f+String.fromCharCode((d-65536>>10)+55296,(d&1023)+56320):f+String.fromCharCode(d);g+=4}else throw new l("utf8-decode-error",
"UTF-8 Decode failed. Invalid multi byte sequence.");}return f}function p(b,a){for(var c={byteOffset:0,byteCount:0,fields:Object.create(null)},f=0,g=0;g<a.length;g++){var d=a[g],e=d.valueType||d.type;c.fields[d.property]=(0,h.valueType2ArrayBufferReader[e])(b,f);f+=h.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT}c.byteCount=f;return c}function v(b,a,c){var f=[],g,d=0,e;for(e=0;e<b;e+=1){g=a[e];if(0<g){if(f.push(G(c,d,g-1)),0!==c[d+g-1])throw new l("string-array-error","Invalid string array: missing null termination.");
}else f.push(null);d+=g}return f}function q(b,a){return new h.valueType2TypedArrayClassMap[a.valueType](b,a.byteOffset,a.count*a.valuesPerElement)}function w(b,a){return new Uint8Array(b,a.byteOffset,a.byteCount)}function x(b,a,c){b=null!=a.header?p(b,a.header):{byteOffset:0,byteCount:0,fields:{count:c}};c={header:b,byteOffset:b.byteCount,byteCount:0,entries:Object.create(null)};for(var f=b.byteCount,g=0;g<a.ordering.length;g++){var d=a.ordering[g],e=D.clone(a[d]);e.count=b.fields.count;if("String"===
e.valueType){if(e.byteOffset=f,e.byteCount=b.fields[d+"ByteCount"],"UTF-8"!==e.encoding)throw new l("unsupported-encoding","Unsupported String encoding.",{encoding:e.encoding});}else if(r(e.valueType)){var k=m(e.valueType),f=f+(0!==f%k?k-f%k:0);e.byteOffset=f;e.byteCount=k*e.valuesPerElement*e.count}else throw new l("unsupported-value-type","Unsupported binary valueType",{valueType:e.valueType});f+=e.byteCount;c.entries[d]=e}c.byteCount=f-c.byteOffset;return c}function y(b,a,c){a!==b&&t.error("Invalid "+
c+" buffer size\n expected: "+b+", actual: "+a+")");if(a<b)throw new l("buffer-too-small","Binary buffer is too small",{expectedSize:b,actualSize:a});}function r(b){return h.valueType2TypedArrayClassMap.hasOwnProperty(b)}function m(b){return r(b)?h.valueType2TypedArrayClassMap[b].BYTES_PER_ELEMENT:0}Object.defineProperty(h,"__esModule",{value:!0});var t=E.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");h.readHeader=p;h.readStringArray=v;h.createTypedView=q;h.createRawView=w;h.createAttributeDataIndex=
x;h.createGeometryIndexFromDefinition=function(b,a,c){var f={header:{byteOffset:0,byteCount:b.offset,fields:{}},byteOffset:b.offset,byteCount:0,vertexAttributes:{},featureAttributes:{}},g=b.offset,d=function(b,a,c,d){var e="UInt64"===a.type?8:m(a.type);a={byteOffset:g,byteCount:e*a.component*c,count:c,valueType:a.type,valuesPerElement:a.component};g+=a.byteCount;d[b]=a},e;for(e in z)b[e]&&d(z[e],b[e],a,f.vertexAttributes);if(F.isSome(c))for(var k in A)b[k]&&d(A[k],b[k],c,f.featureAttributes);return f};
var z={position:"position",normal:"normal",uv0:"uv0",color:"color",uvRegion:"uvRegion"},A={featureId:"id",faceRange:"faceRange"};h.createGeometryIndexFromSchema=function(b,a){for(var c=p(b,a&&a.header),f=c.byteCount,g={header:c,byteOffset:c.byteCount,byteCount:0,vertexAttributes:{}},d=c.fields,e=null!=d.vertexCount?d.vertexCount:d.count,k=0,h=a.ordering;k<h.length;k++){var l=h[k];a.vertexAttributes[l]&&(c=n({},a.vertexAttributes[l],{byteOffset:f,count:e}),g.vertexAttributes[B[l]?B[l]:"_"+l]=c,f+=
m(c.valueType)*c.valuesPerElement*e)}e=d.faceCount;if(a.faces&&e)for(g.faces={},k=0,h=a.ordering;k<h.length;k++)l=h[k],a.faces[l]&&(c=n({},a.faces[l],{byteOffset:f,count:e}),g.faces[l]=c,f+=m(c.valueType)*c.valuesPerElement*e);d=d.featureCount;if(a.featureAttributes&&a.featureAttributeOrder&&d)for(g.featureAttributes={},e=0,k=a.featureAttributeOrder;e<k.length;e++)h=k[e],a.featureAttributes[h]&&(c=n({},a.featureAttributes[h],{byteOffset:f,count:d}),g.featureAttributes[h]=c,h="UInt64"===c.valueType?
8:m(c.valueType),f+=h*c.valuesPerElement*d);y(f,b.byteLength,"geometry");g.byteCount=f-g.byteOffset;return g};var C={position:"position",normal:"normal",uv0:"uv0",color:"color","uv-region":"uvRegion"};h.createGeometryIndexFromAttributes=function(b){for(var a={},c=0;c<b.length;c++){var f=b[c];C[f]&&(a[C[f]]={valueType:null})}return{header:null,byteOffset:0,byteCount:0,vertexAttributes:a}};var B={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};h.readBinaryAttribute=function(b,
a,c){if("lepcc-rgb"===b.encoding)return u.decodeRGB(a);if("lepcc-intensity"===b.encoding)return u.decodeIntensity(a);if(null!=b.encoding&&""!==b.encoding)throw new l("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");b["attributeByteCounts "]&&!b.attributeByteCounts&&(t.warn("Warning: Trailing space in 'attributeByteCounts '."),b.attributeByteCounts=b["attributeByteCounts "]);"ObjectIds"===b.ordering[0]&&b.hasOwnProperty("objectIds")&&(t.warn("Warning: Case error in objectIds"),
b.ordering[0]="objectIds");c=x(a,b,c);y(c.byteOffset+c.byteCount,a.byteLength,"attribute");if(b=c.entries.attributeValues||c.entries.objectIds){if("String"===b.valueType){c=c.entries.attributeByteCounts;var f=q(a,c);a=w(a,b);return v(c.count,f,a)}return q(a,b)}throw new l("bad-attribute-storage-info","Bad attributeStorageInfo specification.");};h.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,
Int32:Int32Array};h.valueType2ArrayBufferReader={Float32:function(b,a){return(new DataView(b,0)).getFloat32(a,!0)},Float64:function(b,a){return(new DataView(b,0)).getFloat64(a,!0)},UInt8:function(b,a){return(new DataView(b,0)).getUint8(a)},Int8:function(b,a){return(new DataView(b,0)).getInt8(a)},UInt16:function(b,a){return(new DataView(b,0)).getUint16(a,!0)},Int16:function(b,a){return(new DataView(b,0)).getInt16(a,!0)},UInt32:function(b,a){return(new DataView(b,0)).getUint32(a,!0)},Int32:function(b,
a){return(new DataView(b,0)).getInt32(a,!0)}};h.isValueType=r;h.getBytesPerValue=m});