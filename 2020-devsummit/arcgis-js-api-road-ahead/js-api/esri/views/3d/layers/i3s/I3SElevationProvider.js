// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingRect ../../webgl-engine/lib/Intersector".split(" "),function(B,C,t,
l,u,v,w,h,x,y,m,k,n,z){var g=n.empty(),p=y.mat4f64.create(),b=k.vec3f64.create(),q=k.vec3f64.create(),r=k.vec3f64.create(),A=w.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(k){function c(a){a=k.call(this,a)||this;a.tmpEvent={spatialReference:null,extent:g,context:"scene"};return a}t(c,k);c.prototype.initialize=function(){this.view=this.layerView.view;this.renderCoordsHelper=this.view.renderCoordsHelper;this.intersector=new z.Intersector(this.view.viewingMode);this.intersector.options.store=
0;var a=this.layerView.layer.fullExtent;this.zmin=a.zmin;this.zmax=a.zmax;this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"};c.prototype.getElevation=function(a,c,d,f){b[0]=a;b[1]=c;b[2]=d;if(!this.renderCoordsHelper.toRenderCoords(b,f,b))return A.error("could not project point for elevation alignment"),null;c=this.layerView.elevationOffset;a=this.zmin+c;c=this.zmax+c;m.vec3.copy(q,b);m.vec3.copy(r,b);this.renderCoordsHelper.setAltitude(c,q);this.renderCoordsHelper.setAltitude(a,
r);this.intersector.reset(q,r);this.intersectionHandler.intersect(this.intersector,null,q,r);return this.intersector.results.min.getIntersectionPoint(b)?this.renderCoordsHelper.getAltitude(b):null};c.prototype.layerChanged=function(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))};c.prototype.objectChanged=function(a){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(a),
this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))};c.prototype.computeObjectExtent=function(a){n.empty(g);this.expandExtent(a,g);return g};c.prototype.computeLayerExtent=function(){n.empty(g);for(var a=0,b=this.layerView.getLoadedNodes();a<b.length;a++)this.expandExtent(b[a],g);return g};c.prototype.expandExtent=function(a,c){var d=a.renderObb;if(d)for(x.mat4.fromQuat(p,d.quaternion),p[12]=d.center[0],p[13]=d.center[1],p[14]=d.center[2],a=0;8>a;++a)b[0]=
a&1?d.halfSize[0]:-d.halfSize[0],b[1]=a&2?d.halfSize[1]:-d.halfSize[1],b[2]=a&4?d.halfSize[2]:-d.halfSize[2],m.vec3.transformMat4(b,b,p),this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),n.expand(c,b);else if(a.renderMbs){var f=a.renderMbs[3],d=m.vec3.copy(q,a.renderMbs);d[0]-=f;d[1]-=f;d[2]-=f;var e=m.vec3.copy(r,a.renderMbs);e[0]+=f;e[1]+=f;e[2]+=f;for(a=0;8>a;++a)b[0]=a&1?d[0]:e[0],b[1]=a&2?d[1]:e[1],b[2]=a&4?d[2]:e[2],this.renderCoordsHelper.fromRenderCoords(b,b,this.spatialReference),
n.expand(c,b)}return c};l([h.property({constructOnly:!0})],c.prototype,"layerView",void 0);l([h.property({constructOnly:!0})],c.prototype,"intersectionHandler",void 0);l([h.property()],c.prototype,"view",void 0);l([h.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],c.prototype,"spatialReference",void 0);return c=l([h.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],c)}(h.declared(v.EventedMixin(u)))});