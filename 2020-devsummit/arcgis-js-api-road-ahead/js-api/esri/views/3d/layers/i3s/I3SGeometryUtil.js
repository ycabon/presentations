// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/arrayUtils ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/meshUtils/deduplicate ../../support/projectionUtils ../../webgl-engine/lib/Util".split(" "),
function(M,l,N,O,H,P,I,p,B,Q,R,C,S,A,u){function T(a,c,b,d,e,g,t){switch(b){case 1:for(b=0;b<t;b++)d[e]=a[c],c+=1,e+=g;break;case 2:for(b=0;b<t;b++)d[e]=a[c],d[e+1]=a[c+1],c+=2,e+=g;break;case 3:for(b=0;b<t;b++)d[e]=a[c],d[e+1]=a[c+1],d[e+2]=a[c+2],c+=3,e+=g;break;case 4:for(b=0;b<t;b++)d[e]=a[c],d[e+1]=a[c+1],d[e+2]=a[c+2],d[e+3]=a[c+3],c+=4,e+=g;break;default:throw x("Unhandled stride size "+b);}}function U(a,c,b,d,e,g){switch(c){case 1:for(c=0;c<g;c++)b[d]=a,d+=e;break;case 2:for(c=0;c<g;c++)b[d]=
a,b[d+1]=a,d+=e;break;case 3:for(c=0;c<g;c++)b[d]=a,b[d+1]=a,b[d+2]=a,d+=e;break;case 4:for(c=0;c<g;c++)b[d]=a,b[d+1]=a,b[d+2]=a,b[d+3]=a,d+=e;break;default:throw x("Unhandled stride size "+c);}}function V(a){switch(a){case 5120:return Int8Array;case 5126:return Float32Array;case 5124:return Int32Array;case 5122:return Int16Array;case 5121:return Uint8Array;case 5125:return Uint32Array;case 5123:return Uint16Array}throw Error("Unhandled data type: "+a);}function J(a){switch(a){case 5120:return"Int8";
case 5126:return"Float32";case 5124:return"Int32";case 5122:return"Int16";case 5121:return"UInt8";case 5125:return"UInt32";case 5123:return"UInt16"}throw Error("Unhandled data type: "+a);}function D(a){return 0<a&&0===a%Uint32Array.BYTES_PER_ELEMENT}function x(a){return Error("I3SGeometryUtil processing failed: "+a)}function K(a){var c=a.normals,b=a.positions,d=a.normalInd,e=a.positionInd;u.assert(a.normalInd.length===a.positionInd.length);a=B.vec3f32.create();for(var g=B.vec3f32.create(),t=I.vec2f32.create(),
m=b.data,z=b.offsetIdx,b=b.strideIdx,h=c.data,E=c.offsetIdx,c=c.strideIdx,n=0;n<e.length;n+=3){var k=e[n],k=z+b*k,f=m[k],q=m[k+1],r=m[k+2],k=e[n+1],k=z+b*k;a[0]=m[k]-f;a[1]=m[k+1]-q;a[2]=m[k+2]-r;k=e[n+2];k=z+b*k;g[0]=m[k]-f;g[1]=m[k+1]-q;g[2]=m[k+2]-r;p.vec3.cross(a,a,g);u.encodeNormal(a,t);for(f=0;3>f;f++)q=E+c*d[n+f],h[q]=u.encodeInt16(t[0]),h[q+1]=u.encodeInt16(t[1])}}function F(a,c){return r.intersects(a,c)?r.contains(a,c)?0:2:1}function L(a,c){return r.intersects(a,c)?r.contains(a,c)?1:2:0}
Object.defineProperty(l,"__esModule",{value:!0});var G=new Uint8Array(64);l.interleaveGeometryBuffer=function(a,c,b,d,e){void 0===d&&(d=[]);void 0===e&&(e=[]);var g=a.params.vertexAttributes,t=g.position.count;if(!D(b[0].stride))throw x("Layout stride must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var m=new Uint32Array(b[0].stride/Uint32Array.BYTES_PER_ELEMENT*t);b=b.slice(0).sort(function(a,b){return a.offset-b.offset});a=function(a){if(-1!==e.indexOf(a.name))return"continue";var b=g[a.name],
h=V(a.type),k=void 0,f=!1;if(null==b)if(f=d.filter(function(b){return b.name===a.name})[0]){b={valueType:J(a.type),byteOffset:0,count:t,valuesPerElement:a.count};for(k=0;k<G.length;k++)G[k]=f.byteValue;k=G.buffer;f=!0}else throw x("Geometry definition is missing attribute");else k=c;if(J(a.type)!==b.valueType)throw x("Geometry definition type must match attribute type");if(0!==b.byteOffset%Uint32Array.BYTES_PER_ELEMENT||0!==a.offset%Uint32Array.BYTES_PER_ELEMENT)throw x(a.name+" offset must use "+
Uint32Array.BYTES_PER_ELEMENT+"-byte words");if(!D(b.valuesPerElement*h.BYTES_PER_ELEMENT)||!D(a.count*h.BYTES_PER_ELEMENT))throw x(a.name+" data must use "+Uint32Array.BYTES_PER_ELEMENT+"-byte words");var k=new Uint32Array(k),q=b.byteOffset/Uint32Array.BYTES_PER_ELEMENT,b=b.valuesPerElement*h.BYTES_PER_ELEMENT/Uint32Array.BYTES_PER_ELEMENT,h=a.offset/Uint32Array.BYTES_PER_ELEMENT,z=a.stride/Uint32Array.BYTES_PER_ELEMENT;f?U(k[0],b,m,h,z,t):T(k,q,b,m,h,z,t)};for(var f=0;f<b.length;f++)a(b[f]);return m.buffer};
l.processAndInterleaveNormals=function(a,c,b,d){if("none"===a)K(d);else{var e=d.normals,g="earth-centered"===a?b:null;a=c.length/3;b=e.data;d=e.offsetIdx;e=e.strideIdx;if(null!=g)for(var t=g[0],m=g[1],f=g[2],h=g[4],E=g[5],n=g[6],k=g[8],r=g[9],g=g[10],q=0;q<a;q++){var p=c[3*q],l=c[3*q+1],v=c[3*q+2];w[0]=t*p+m*l+f*v;w[1]=h*p+E*l+n*v;w[2]=k*p+r*l+g*v;u.encodeNormal(w,y);b[d+q*e]=u.encodeInt16(y[0]);b[d+q*e+1]=u.encodeInt16(y[1])}else for(q=0;q<a;q++)w[0]=c[3*q],w[1]=c[3*q+1],w[2]=c[3*q+2],u.encodeNormal(w,
y),b[d+q*e]=u.encodeInt16(y[0]),b[d+q*e+1]=u.encodeInt16(y[1])}};l.computeCompressedNormals=K;l.extractPositionData=function(a,c,b){var d=c[0];if(null==d||"position"!==d.name||5126!==d.type)return null;a=new Float32Array(a);c=d.stride/4;for(var d=d.offset/4,e=3*a.length/c,g=new Float32Array(e),t=0;t<e/3;t++)g[3*t]=a[t*c+d],g[3*t+1]=a[t*c+d+1],g[3*t+2]=a[t*c+d+2];b=S.default(g.buffer,3,{originalIndices:b});return 65536>b.uniqueCount?{data:new Float32Array(b.buffer),indices:new Uint16Array(b.indices)}:
{data:new Float32Array(b.buffer),indices:b.indices}};var r;l.isGeometryEngineLoaded=function(){return!!r};l.loadGeometryEngine=function(){return O(this,void 0,void 0,function(){return N(this,function(a){switch(a.label){case 0:return r?[2,r]:[4,P.create(function(a){return M(["../../../../geometry/geometryEngine"],a)})];case 1:return r=a.sent(),[2,r]}})})};l.processFilterGeometry=function(a,c){if(!a)return null;if("disjoint"===c&&"polygon"===a.type){var b=Array(a.rings.length);for(c=0;c<a.rings.length;++c){var d=
C.fromValues(Infinity,Infinity,-Infinity,-Infinity);C.expandWithNestedArray(d,a.rings[c]);b[c]={type:"polygon",rings:[a.rings[c]],spatialReference:a.spatialReference,aabr:d}}b.sort(function(a,b){return a.aabr[0]-b.aabr[0]});var e=new Set,g=new H.PositionHint;a=function(a){var c=b[a];for(a+=1;a<b.length;++a){var d=b[a];if(d.aabr[0]>=c.aabr[2])break;e.add(d)}e.forEach(function(a){c!==a&&(a.aabr[2]<=c.aabr[0]?e.delete(a):r.intersects(c,a)&&(c.rings=c.rings.concat(a.rings),C.expand(c.aabr,a.aabr),delete c._geVersion,
e.delete(a),a=H.indexOf(b,a,b.length,g),b.splice(a,1)))});e.add(c)};for(c=0;c<b.length;++c)a(c);for(a=0;a<b.length;a++)delete b[a].aabr;return b}return[a]};l.acquireMaskFilterContext=function(a,c,b,d,e){c=c.renderSpatialReference;var g=new Map,f={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:b};f.rings[0][3]=f.rings[0][0];var m,p;switch(a){case "intersects":m=function(a,b){return r.intersects(a,b)?0:2};p=F;break;case "contains":m=function(a,b){return r.contains(a,
b)?2:1};p=F;break;default:m=function(a,b){return r.disjoint(a,b)?2:1},p=L}return{collection:d,object:e,type:a,maskSR:b,renderSR:c,aabbCache:g,triangle:f,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:m,geometryTest:p}};l.computeMaskNodeMBS=function(a,c){var b={x:a[0],y:a[1],hasZ:!1,hasM:!1,type:"point",spatialReference:c.maskSR};return c.maskSR.isWGS84||c.maskSR.isWebMercator?r.geodesicBuffer(b,a[3],1,!0):r.buffer(b,a[3],1,!0)};l.testMaskWithGeometry=function(a,c,
b){switch(b){case "intersects":case "contains":return F(a,c);case "disjoint":return L(a,c)}};var W=Math.pow(2,-32);l.filterWithMask=function(a,c,b){var d=b.collection,e=b.object,g=b.renderSR,f=b.maskSR,m=b.geometryTest,r=b.aabbCache,h=r.get(c);if(!h){var l=d.getObjectTransform(e);d.getComponentAABB(e,c,v);for(var n=[[v[0],v[1],0],[v[0],v[4],0],[v[3],v[4],0],[v[3],v[1],0]],h=0;4>h;++h)p.vec3.transformMat3(n[h],n[h],l.rotationScale),p.vec3.add(n[h],n[h],l.position),A.vectorToVector(n[h],g,n[h],f);h=
{rings:[n],hasZ:!1,hasM:!1,type:"polygon",spatialReference:f};h.rings[0][4]=h.rings[0][0];r.set(c,h)}switch(m(a,h)){case 1:return!1;case 0:return!0}var m=b.triangle,r=b.triangleTest,h=b.positions,l=m.rings[0][0],n=m.rings[0][1],k=m.rings[0][2],u=d.getObjectTransform(e);d.getComponentPositions(e,c,h);c=h.indices;for(var d=h.data,e=h.stride,q=h.endIndex,h=h.startIndex;h<q;h+=3){var w=e*c[h+0],x=e*c[h+1],y=e*c[h+2];p.vec3.set(l,d[w+0],d[w+1],d[w+2]);p.vec3.set(n,d[x+0],d[x+1],d[x+2]);p.vec3.set(k,d[y+
0],d[y+1],d[y+2]);p.vec3.transformMat3(l,l,u.rotationScale);p.vec3.transformMat3(n,n,u.rotationScale);p.vec3.transformMat3(k,k,u.rotationScale);p.vec3.add(l,l,u.position);p.vec3.add(n,n,u.position);p.vec3.add(k,k,u.position);A.vectorToVector(l,g,l,f);A.vectorToVector(n,g,n,f);A.vectorToVector(k,g,k,f);if(!(Math.abs((n[0]-l[0])*(k[1]-l[1])-(n[1]-l[1])*(k[0]-l[0]))<W))switch(delete m._geVersion,r(a,m)){case 1:return!1;case 0:return!0}}switch(b.type){case "intersects":return!1;default:return!0}};l.boundingBoxCornerPoints=
function(a,c,b,d){a=c.getComponentAABB(b,a,v);c=c.getObjectTransform(b);for(b=0;8>b;++b)f[0]=b&1?a[0]:a[3],f[1]=b&2?a[1]:a[4],f[2]=b&4?a[2]:a[5],p.vec3.transformMat3(f,f,c.rotationScale),p.vec3.add(f,f,c.position),d[3*b]=f[0],d[3*b+1]=f[1],d[3*b+2]=f[2];return d};l.boundingBoxTop=function(a,c,b,d){a=c.getComponentAABB(b,a,v);c=c.getObjectTransform(b);d[0]=0;d[1]=0;for(b=d[2]=0;8>b;++b)f[0]=b&1?a[0]:a[3],f[1]=b&2?a[1]:a[4],f[2]=a[5],p.vec3.transformMat3(f,f,c.rotationScale),p.vec3.add(f,f,c.position),
d[0]+=f[0],d[1]+=f[1],d[2]+=f[2];d[0]/=8;d[1]/=8;d[2]/=8;return d};var v=R.create(),w=B.vec3f32.create(),y=I.vec2f32.create(),f=Q.vec3f64.create()});