// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/Accessor ../../../../core/Error ../../../../core/Handles ../../../../core/maybe ../../../../core/accessorSupport/decorators ../../../../geometry/Extent ../../../../layers/graphics/data/QueryEngine ../../../../tasks/support/FeatureSet ../../../../tasks/support/Query".split(" "),function(e,
l,d,p,g,h,q,n,r,t,c,u,v,w,x){Object.defineProperty(l,"__esModule",{value:!0});var y=v.default;e=function(e){function a(b){b=e.call(this,b)||this;b._dataQueryEngineInstance=null;b._handles=new r;return b}p(a,e);Object.defineProperty(a.prototype,"defaultQueryJSON",{get:function(){return(new x({outSpatialReference:this.spatialReference})).toJSON()},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"dataQueryEngine",{get:function(){return this.ensureDataQueryEngine()},enumerable:!0,configurable:!0});
a.prototype.initialize=function(){var b=this;this._handles.add(this.layerView.on("visible-geometry-changed",function(){return b.spatialIndex.events.emit("changed")}))};a.prototype.destroy=function(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null);this._handles&&(this._handles.destroy(),this._handles=null);this._set("layerView",null)};a.prototype.executeQueryForCount=function(b,a){return h(this,void 0,void 0,function(){return g(this,function(m){return[2,
this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(b),a)]})})};a.prototype.executeQueryForExtent=function(a,k){return h(this,void 0,void 0,function(){var b,c,f,d;return g(this,function(m){switch(m.label){case 0:return[4,this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(a),k)];case 1:return b=m.sent(),c=b.count,f=b.extent,d=u.fromJSON(f),[2,{count:c,extent:d}]}})})};a.prototype.executeQueryForIds=function(a,c){return h(this,void 0,void 0,function(){return g(this,function(b){return[2,
this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(a),c)]})})};a.prototype.executeQuery=function(a,c){return h(this,void 0,void 0,function(){var b,d,f,e=this;return g(this,function(k){switch(k.label){case 0:b=this._ensureQueryJSON(a);if(b.returnGeometry)throw new n("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(b.returnCentroid)throw new n("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");
return[4,this.dataQueryEngine.executeQuery(b,c)];case 1:return d=k.sent(),f=w.fromJSON(d),f.features.forEach(function(a){a.geometry=null;a.layer=e.layer;a.sourceLayer=e.layer}),[2,f]}})})};a.prototype._ensureQueryJSON=function(a){if(t.isNone(a))return this.defaultQueryJSON;var b=a.toJSON();b.outSpatialReference||(a.outSpatialReference=this.spatialReference);return b};a.prototype.ensureDataQueryEngine=function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var a=this.layer.objectIdField||
"OBJECTID",c=this.layer.fields.map(function(a){return a.toJSON()}),d=this.layerView.view.resourceController.scheduler,e=this.spatialReference.toJSON();return this._dataQueryEngineInstance=new y({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:c,timeInfo:null,spatialReference:e,objectIdField:a,featureStore:this.spatialIndex,scheduler:d,task:this.task})};d([c.property({constructOnly:!0})],a.prototype,"layerView",void 0);d([c.property({constructOnly:!0})],a.prototype,"task",void 0);d([c.property({constructOnly:!0})],
a.prototype,"spatialIndex",void 0);d([c.property({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],a.prototype,"spatialReference",void 0);d([c.property({readOnly:!0,aliasOf:"layerView.layer"})],a.prototype,"layer",void 0);d([c.property({readOnly:!0,dependsOn:["spatialReference"]})],a.prototype,"defaultQueryJSON",null);return a=d([c.subclass("esri.views.3d.layers.i3s.I3SQueryEngine")],a)}(c.declared(q));l.I3SQueryEngine=e;l.default=e});