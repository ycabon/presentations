// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../geometry/support/aaBoundingBox ./PointHighlights ../../support/geometryUtils ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../webgl-engine/lib/ComponentUtils ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),
function(t,f,F,u,P,Q,q,R,B,S,r,T,U,V,G,W,X,H,Y,Z,n,N,aa){function C(c,a,b,h,d){if(b.drawScreenSpace)return b.fixedSize*a*h;d=(d?256:64)*a*h;return b.drawFixedSize?Math.min(b.fixedSize/2,d):0<b.screenMinSize?Math.min(Math.max(b.screenMinSize*a*h,c/2),d):Math.min(c/2,d)}Object.defineProperty(f,"__esModule",{value:!0});var ba={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};t=function(){function c(a){var b=
this;this._params=a;this.type="Point";this.isGround=!1;this._highlights=new T.PointHighlights({forEachNode:function(a){return b.forEachNode(a)},addHighlight:function(a,d,c){return b.addHighlight(a,d,c)},removeHighlight:function(a,d){return b.removeHighlight(a,d)}});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=r.create(r.POSITIVE_INFINITY);this._techniqueConfig=
new n.PointRendererTechniqueConfiguration;this.tempMatrix4=P.mat4f32.create();this.tempVec3=R.vec3f32.create();this.nodes=[]}Object.defineProperty(c.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0});c.prototype.initializeRenderContext=function(a){this._initContext=a;this._techniqueRep=this._initContext.shaderTechniqueRep;a.requestRender()};c.prototype.uninitializeRenderContext=function(){};c.prototype.intersect=function(a,b,h,d){var c=
this,k=B.vec3f64.create(),g=B.vec3f64.create(),O=B.vec3f64.create(),I=B.vec3f64.create(),f=V.plane.create(),v=a.camera.perScreenPixelRatio/2,z=a.camera.near,p=this._getSizeParams();q.vec3.subtract(g,d,h);var J=1/q.vec3.length(g);q.vec3.scale(g,g,J);q.vec3.negate(O,g);S.vec4.set(f,g[0],g[1],g[2],-q.vec3.dot(g,h));var M=function(){return function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""}}(),w=new M,x=new M,t=[],K=r.create(),L=r.create(this._clipBox);r.offset(L,
-h[0],-h[1],-h[2],L);for(var E=function(l){var D=l.splatSize*u._scaleFactor,e=G.minimumDistancePlane(l.obb,f),m=G.maximumDistancePlane(l.obb,f),e=e-(p.drawScreenSpace?0:C(D,e+z,p,v,l.isLeaf)),m=m-(p.drawScreenSpace?0:C(D,m+z,p,v,l.isLeaf)),e=null!=w.dist&&null!=x.dist&&w.dist<e*J&&x.dist>m*J;if(0>m||e)return"continue";m=C(D,m+z,p,v,l.isLeaf);if(!G.intersectLine(l.obb,h,g,m))return"continue";var ca=m*m;G.toAaBoundingBox(l.obb,K);r.offset(K,-h[0],-h[1],-h[2],K);var y=!r.contains(L,K);q.vec3.subtract(I,
l.origin,h);for(var m=l.coordinates.length/3,e=function(e){k[0]=I[0]+l.coordinates[3*e];k[1]=I[1]+l.coordinates[3*e+1];k[2]=I[2]+l.coordinates[3*e+2];if(y&&!r.containsPoint(L,k))return"continue";var m=q.vec3.dot(k,g),f=q.vec3.squaredLength(k)-m*m;if(f>ca)return"continue";var n=m+z,u=p.drawScreenSpace?0:C(D,n,p,v,l.isLeaf);if(0>m-u)return"continue";n=C(D,n-u,p,v,l.isLeaf);if(f>n*n)return"continue";var A=(m-u)*J,m=function(a){var b=a.point;null==b&&(b=B.vec3f64.create());b[0]=l.origin[0]+l.coordinates[3*
e];b[1]=l.origin[1]+l.coordinates[3*e+1];b[2]=l.origin[2]+l.coordinates[3*e+2];a.point=b;a.dist=A;a.normal=O;a.node=l;a.pointId=e;a.layerUid=c.layerUid};(null==w.dist||A<w.dist)&&(null==b||b(h,d,A))&&m(w);0!==a.options.store&&(null==x.dist||A>x.dist)&&(null==b||b(h,d,A))&&m(x);2!==a.options.store||null!=b&&!b(h,d,A)||(f=new M,m(f),t.push(f))},n=0;n<m;n++)e(n)},u=this,e=0,y=this.nodes;e<y.length;e++)E(y[e]);var F=function(a){var b=a.node,d=a.pointId;return{type:"external",point:a.point,metadata:{layerUid:a.layerUid,
createGraphic:function(){return c._params.createGraphic(b,d,a.point)}}}},E=function(a,b){var d=F(b);a.set(d,b.layerUid+"/"+b.node.id+"/"+b.pointId,b.dist,b.normal,Q.mat4f64.IDENTITY,void 0);a.intersector="PointRenderer"};null!=w.dist&&(e=a.results.min,(null==e.dist||w.dist<e.dist)&&E(e,w));null!=x.dist&&0!==a.options.store&&(e=a.results.max,(null==e.dist||x.dist>e.dist)&&E(e,x));if(2===a.options.store)for(e=U.ray.fromPoints(h,d),y=0;y<t.length;y++){var H=t[y],n=new Z.IntersectorResult(e);E(n,H);a.results.all.push(n)}};
c.prototype.render=function(a){if(0!==a.pass&&1!==a.pass&&4!==a.pass)return!1;for(var b=1===a.pass,h=a.rctx,d=0,c=this.nodes;d<c.length;d++){var k=c[d];null==k.vao&&this._initNode(a,k)}var d=this._getSizeParams(),c=this.selectTechnique(a,d),g=c.program;if(null==g||0===this.nodes.length)return!0;var f=this._clipBox,n=!r.equals(f,r.POSITIVE_INFINITY,function(a,b){return a===b});n||(q.vec3.set(this.tempVec3,-Infinity,-Infinity,-Infinity),g.setUniform3fv("uClipMin",this.tempVec3),q.vec3.set(this.tempVec3,
Infinity,Infinity,Infinity),g.setUniform3fv("uClipMax",this.tempVec3));h.bindProgram(g);c.bindPipelineState(h);g.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);b&&g.setUniform2f("nearFar",a.camera.near,a.camera.far);a.isHighlightPass&&X.OutputHighlight.bindOutputHighlight(h,g,{viewport:a.camera.fullViewport,highlightDepthTexture:a.highlightDepthTexture});b=a.camera.pixelRatio;d.drawFixedSize&&g.setUniform2f("uPointScale",d.fixedSize*b,a.camera.fullHeight);for(var t=this._slicePlaneEnabled?
a.sliceHelper&&a.sliceHelper.plane:null,v=0,z=this.nodes;v<z.length;v++)if(k=z[v],0!==k.coordinates.length&&(!a.isHighlightPass||k.highlights)){g.setUniform2f("uScreenMinMaxSize",d.screenMinSize*b,(k.isLeaf?256:64)*b);d.drawFixedSize||g.setUniform2f("uPointScale",k.splatSize*this._scaleFactor*b,a.camera.fullHeight/b);var p=k.origin;n&&(q.vec3.set(this.tempVec3,f[0]-p[0],f[1]-p[1],f[2]-p[2]),g.setUniform3fv("uClipMin",this.tempVec3),q.vec3.set(this.tempVec3,f[3]-p[0],f[4]-p[1],f[5]-p[2]),g.setUniform3fv("uClipMax",
this.tempVec3));u.mat4.identity(this.tempMatrix4);u.mat4.translate(this.tempMatrix4,this.tempMatrix4,p);u.mat4.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);g.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);W.Slice.bindUniforms(g,c.configuration,t,p);h.bindVAO(k.vao);a.isHighlightPass?this._renderHighlightFragments(h,k):h.drawArrays(0,0,k.coordinates.length/3)}return!0};c.prototype._renderHighlightFragments=function(a,b){var c=b.highlights;if(c){b=F.unwrap(c[0].component);
for(var d=b+1,f=1;f<c.length;f++){var k=F.unwrap(c[f].component);k!==d&&(d-=b,0<d&&a.drawArrays(0,b,d),b=k);d=k+1}c=d-b;0<c&&a.drawArrays(0,b,c)}};Object.defineProperty(c.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=
a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"size",{get:function(){return this._size},set:function(a){this._size!==a&&(this._size=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"sizePx",{get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"clippingBox",{set:function(a){r.set(this._clipBox,a||r.POSITIVE_INFINITY)},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0});c.prototype.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};c.prototype.removeNode=function(a){var b=this,
c=null;this.nodes=this.nodes.filter(function(d){return d.id===a?(c=d,d.vao&&(d.vao.dispose(!0),d.vao=null),b._highlights.nodeRemoved(d),!1):!0});this._requestRender();return c};c.prototype.forEachNode=function(a){this.nodes.forEach(a)};c.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),a.vao=null)});this._highlights.removeAll();this.nodes=[];this._requestRender()};c.prototype.highlight=function(a){return this._highlights.add(a)};c.prototype.addHighlight=function(a,
b,c){a.highlights=H.addHighlight(a.highlights,b,c);this._requestRender()};c.prototype.removeHighlight=function(a,b){a.highlights=H.removeHighlight(a.highlights,b);this._requestRender()};c.prototype._initNode=function(a,b){a=a.rctx;b.vao=new aa(a,Y.Default3D,ba,{positions:N.createVertex(a,35044,b.coordinates),colors:N.createVertex(a,35044,b.rgb)})};c.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()};c.prototype._getSizeParams=function(){var a=this._useFixedSizes,
b=a&&!this._useRealWorldSymbolSizes,c=b?this._sizePx:this._size,d=this._minSizePx;a&&(d=0);return{drawScreenSpace:b,drawFixedSize:a,fixedSize:c,screenMinSize:d}};c.prototype.selectTechnique=function(a,b){this._techniqueConfig.drawScreenSize=b.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=1===a.pass?1:4===a.pass?4:0;return this._techniqueRep.acquireAndReleaseExisting(n.PointRendererTechnique,
this._techniqueConfig,this._technique)};return c}();f.PointRenderer=t;(function(c){c.isInstanceOfNode=function(a){return a.hasOwnProperty("splatSize")}})(t=f.PointRenderer||(f.PointRenderer={}));f.PointRenderer=t});