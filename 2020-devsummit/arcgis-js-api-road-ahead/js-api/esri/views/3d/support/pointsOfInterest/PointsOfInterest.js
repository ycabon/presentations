// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/Accessor ../../../../core/Handles ../../../../core/SetUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./disposeMembers ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/intersectorUtils ../../../support/Scheduler".split(" "),
function(e,l,t,d,g,u,v,w,c,m,p,x,y,z,n,A,B,C,D,E,q,F,k){Object.defineProperty(l,"__esModule",{value:!0});e=function(e){function b(a){a=e.call(this,a)||this;a.handles=new v;a.surfaceAltitudeAtCenter=0;a.surfaceAltitudeAtCenterDirty=!0;a.surfaceAltitudeAtCenterWithContent=0;a.surfaceAltitudeAtCenterWithContentDirty=!0;a.propertiesPool=new x.PropertiesPool({renderPointOfView:G},a);a.renderPointOfView=p.vec3f64.create();return a}t(b,e);b.prototype.initialize=function(){var a=this,b=this.view,c=b.state,
d=b.basemapTerrain,e=b.renderCoordsHelper,b=b.map;this.surfaceIntersector=new q.Intersector(c.mode);this.surfaceIntersector.options.backfacesTerrain=c.isGlobal?!1:!0;this.surfaceIntersector.options.invisibleTerrain=!1;this.contentIntersector=new q.Intersector(c.mode);this.contentIntersectorOptions={exclude:w.createSetFromValues([F.TERRAIN_ID])};var f=function(){return a.estimateSurfaceAltitudeAtCenter()},h={state:c,scheduler:this.view.resourceController.scheduler,surface:d,renderCoordsHelper:e};this._set("centerOnSurfaceInfrequent",
new n.default(g({},h,{task:k.Task.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:f})));this._set("centerOnSurfaceFrequent",new n.default(g({},h,{task:k.Task.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:f})));this._set("centerOnContent",new n.default(g({},h,{task:k.Task.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:function(){return a.estimateSurfaceAltitudeAtCenterWithContent()}})));this._set("cameraOnSurface",new z.default(g({},h,{task:k.Task.POINT_OF_INTEREST_INFREQUENT,
map:b})));this._set("surfaceGeometryUpdates",new E.default(g({},h,{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})));this._set("contentGeometryUpdates",new A.default({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:e}));this._set("surfaceOrigin",new D.default({view:this.view}));this._set("focus",new C.default({state:c,surface:d,renderCoordsHelper:e,centerOnSurface:this.centerOnSurfaceFrequent}));this.handles.add([c.watch("camera",
function(b){return a.cameraChanged(b)},!0),d.watch("extent",function(){return a.updateCenterPointsOfInterest()}),this.surfaceGeometryUpdates.events.on("request-update",function(){return a.updateCenterPointsOfInterest()}),this.contentGeometryUpdates.events.on("request-update",function(){return a.updateCenterOnContent()})]);this.cameraChanged(this.view.state.camera);this.centerOnContent.update();this.centerOnSurfaceFrequent.update();this.centerOnSurfaceInfrequent.update();this.cameraOnSurface.update()};
b.prototype.destroy=function(){B.default(this,"handles","centerOnSurfaceInfrequent","centerOnSurfaceFrequent","cameraOnSurface","centerOnContent","surfaceOrigin","focus","propertiesPool")};Object.defineProperty(b.prototype,"updating",{get:function(){return!!(this.surfaceGeometryUpdates&&this.surfaceGeometryUpdates.updating||this.centerOnContent&&this.centerOnContent.updating||this.centerOnSurfaceInfrequent&&this.centerOnSurfaceInfrequent.updating||this.centerOnSurfaceFrequent&&this.centerOnSurfaceFrequent.updating||
this.cameraOnSurface&&this.cameraOnSurface.updating||this.focus&&this.focus.updating)},enumerable:!0,configurable:!0});b.prototype.estimateSurfaceAltitudeAtCenterWithContent=function(){if(!this.surfaceAltitudeAtCenterWithContentDirty)return this.surfaceAltitudeAtCenterWithContent;this.surfaceAltitudeAtCenterWithContentDirty=!1;var a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,r);this.view.sceneIntersectionHelper.intersectRay(a,this.contentIntersector,f,
this.contentIntersectorOptions)?this.surfaceAltitudeAtCenterWithContent=this.view.renderCoordsHelper.getAltitude(f):this.surfaceAltitudeAtCenterWithContent=this.estimateSurfaceAltitudeAtCenter(a);return this.surfaceAltitudeAtCenterWithContent};b.prototype.estimateSurfaceAltitudeAtCenter=function(a){if(!this.view.basemapTerrain)return 0;if(!this.surfaceAltitudeAtCenterDirty)return this.surfaceAltitudeAtCenter;this.surfaceAltitudeAtCenterDirty=!1;var b=this.view.state.camera;a||(a=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(b,
r));var c=a.origin,d=m.vec3.add(f,a.origin,a.direction);this.surfaceIntersector.resetWithRay(a);this.surfaceIntersector.intersect(null,null,b);this.view.basemapTerrain.intersect(this.surfaceIntersector,null,c,d);this.surfaceIntersector.results.min.getIntersectionPoint(f)&&(this.surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(f));return this.surfaceAltitudeAtCenter};b.prototype.cameraChanged=function(a){this.updateCenterPointsOfInterest();a=a.eye;m.vec3.exactEquals(this.renderPointOfView,
a)||this._set("renderPointOfView",m.vec3.copy(this.propertiesPool.get("renderPointOfView"),a))};b.prototype.updateCenterPointsOfInterest=function(){this.surfaceAltitudeAtCenterWithContentDirty=this.surfaceAltitudeAtCenterDirty=!0;this.centerOnSurfaceFrequent.updateRenderLocation();this.centerOnSurfaceInfrequent.updateRenderLocation();this.cameraOnSurface.updateRenderLocation();this.focus.updateRenderLocation();this.centerOnContent.updateRenderLocation()};b.prototype.updateCenterOnContent=function(){this.surfaceAltitudeAtCenterWithContentDirty=
!0;this.centerOnContent.updateRenderLocation()};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{update:function(){a.surfaceGeometryUpdates.update();a.centerOnSurfaceFrequent.update();a.centerOnSurfaceInfrequent.update()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}},enumerable:!0,configurable:!0});d([c.property({readOnly:!0})],b.prototype,"centerOnContent",void 0);d([c.property({readOnly:!0})],b.prototype,"centerOnSurfaceFrequent",void 0);d([c.property({readOnly:!0})],
b.prototype,"centerOnSurfaceInfrequent",void 0);d([c.property({readOnly:!0})],b.prototype,"cameraOnSurface",void 0);d([c.property({readOnly:!0})],b.prototype,"focus",void 0);d([c.property({readOnly:!0})],b.prototype,"renderPointOfView",void 0);d([c.property({readOnly:!0})],b.prototype,"surfaceOrigin",void 0);d([c.property({readOnly:!0})],b.prototype,"contentGeometryUpdates",void 0);d([c.property({readOnly:!0})],b.prototype,"surfaceGeometryUpdates",void 0);d([c.property({constructOnly:!0})],b.prototype,
"view",void 0);d([c.property({readOnly:!0,dependsOn:"surfaceGeometryUpdates.updating centerOnContent.updating centerOnSurfaceInfrequent.updating centerOnSurfaceFrequent.updating cameraOnSurface.updating focus.updating".split(" ")})],b.prototype,"updating",null);return b=d([c.subclass("esri.views.3d.support.PointsOfInterest")],b)}(c.declared(u));l.PointsOfInterest=e;var G=Array,f=p.vec3f64.create(),r=y.create();l.default=e});