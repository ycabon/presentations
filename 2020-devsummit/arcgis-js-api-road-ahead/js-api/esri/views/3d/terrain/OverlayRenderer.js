// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/SetUtils ../../../core/accessorSupport/decorators/declared ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/vec3f64 ../support/debugFlags ../webgl-engine/core/shaderTechnique/CommonUniformStore ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRep ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/RenderContext ../webgl-engine/lib/renderStats ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/Lightsources ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/lineStippleUtils ../../webgl/FramebufferObject ../../webgl/Texture ../../webgl/Util".split(" "),
function(y,l,H,z,I,h,n,J,K,L,t,u,A,M,N,v,O,P,B,Q,R,S,T,U,C,V,W,X,Y,Z,D){Object.defineProperty(l,"__esModule",{value:!0});var w=I.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");y=function(E){function c(b){var a=E.call(this)||this;a._hasHighlights=!1;a._rendersOccluded=!1;a._lighting=new W.SceneLighting;a._localOrigins=new Q;a._layerViewHandles=new Map;a._layerRenderers=new Map;a._sortedLayerRenderersDirty=!1;a._sortedLayerRenderers=new J;a._stats=new T.RenderStatsAggregator;a._geometries=
new Map;a._renderTargets={};a._uniqueIdx=0;a.longitudeCyclical=null;a._rctx=b.renderingContext;a._renderContext=new S(a._rctx,null,null,null,null,null);a._stippleTextureRepository=new X.StippleTextureRepository;a._shaderTechniqueRepository=new N.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:1,commonUniformStore:new M.CommonUniformStore,stippleTextureRepository:a._stippleTextureRepository});a._materialRepository=new P(b.textureRepository,a._shaderTechniqueRepository);a._materialRepository.onMaterialChanged=
function(b){0<(b.renderOccluded&l.overlayRenderOccludedFlag)!==a._rendersOccluded&&a.updateRendersOccluded();a.emitContentChanged()};a._compositingHelper=b.compositingHelper;a._bindParameters={slot:null,fovY:0,highlightDepthTexture:B.createEmptyDepthTexture(a._rctx),nearFar:[m.near,m.far],origin:null,pixelRatio:null,proj:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,view:null,viewInvTransp:null,viewport:null,hasOccludees:!1};a._lighting.set({lights:[new V.AmbientLight(u.vec3f64.fromValues(1,
1,1))],groundLightingFactor:1,globalFactor:0});return a}H(c,E);c.prototype.dispose=function(){this._layerRenderers.forEach(function(a){return a.dispose()});this._layerRenderers.clear();for(var b in this._renderTargets)this._renderTargets[b].dispose();this._renderTargets=null;this._bindParameters.highlightDepthTexture.dispose();this._bindParameters.highlightDepthTexture=null};c.prototype.disposeRenderTarget=function(b){var a=this._renderTargets[b];a&&a.dispose();delete this._renderTargets[b]};Object.defineProperty(c.prototype,
"updating",{get:function(){return this._sortedLayerRenderersDirty||h.someMap(this._layerRenderers,function(b){return b.updating})},enumerable:!0,configurable:!0});c.prototype.commitChanges=function(){var b=this,a=!1;this._layerRenderers.forEach(function(d,e){d.commitChanges()&&(a=!0);d.isEmpty&&(b._layerRenderers.delete(e),b._sortedLayerRenderersDirty=!0,d=b._layerViewHandles.get(e))&&(d.remove(),b._layerViewHandles.delete(e))});this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),
a=!0);this.emitUpdatingChanged();a&&(this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded())};c.prototype.getRenderTargetTexture=function(b){return(b=this._renderTargets[b])?b.colorTexture:null};c.prototype.addGeometries=function(b,a,d){for(var e=0;e<b.length;e++){var c=b[e];null==c.origin&&(c.origin=this._localOrigins.getOrigin(c.center));c.uniqueName||(c.uniqueName="ov:"+this._uniqueIdx++);this._geometries.set(c.uniqueName,c)}this.ensureLayerRenderer(a).add(b);2===d&&
this.notifyGraphicUpdate(b,a,2)};c.prototype.removeGeometries=function(b,a,d){for(var e=0;e<b.length;e++)this._geometries.delete(b[e].uniqueName);(e=this._layerRenderers.get(a))?(e.remove(b),2===d&&this.notifyGraphicUpdate(b,a,2)):w.warn("Attempted to remove geometry for nonexistent layer")};c.prototype.updateGeometries=function(b,a,d){var e=this._layerRenderers.get(a);e?(e.modify(b,d),this.notifyUpdateGeometries(b,a,d)):w.warn("Attempted to update geometry for nonexistent layer")};c.prototype.notifyUpdateGeometries=
function(b,a,d){this.notifyGraphicUpdate(b,a,4===d||2===d?2:1===d?1:0)};c.prototype.notifyGraphicUpdate=function(b,a,d){if(0!==d)for(var e=-1,c=0;c<b.length;c++){var f=b[c].data.graphicUid;f!==e&&(a.notifyGraphicUpdate(f,d),e=f)}};c.prototype.updateHighlights=function(b,a){(a=this._layerRenderers.get(a))?a.modify(b,8):w.warn("Attempted to update highlights for nonexistent layer")};c.prototype.isEmpty=function(){return 0===this._geometries.size&&!A.OVERLAY_DRAW_DEBUG_TEXTURE};Object.defineProperty(c.prototype,
"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasWater",{get:function(){return h.someMap(this._layerRenderers,function(b){return b.hasWater})},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendersOccluded",{get:function(){return this._rendersOccluded},enumerable:!0,configurable:!0});c.prototype.updateLogic=function(b){var a=!1;this._layerRenderers.forEach(function(d){d.updateLogic(b)&&(a=!0)});return a};
c.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};c.prototype.draw=function(b,a){return this.drawPass(0,b,a)};c.prototype.drawWithoutRasterImage=function(b,a){return this.drawPass(0,b,a,2)};c.prototype.drawNormals=function(b,a){return this.drawPass(2,b,a)};c.prototype.drawHighlights=function(b,a){return this.drawPass(4,b,a)};c.prototype.drawOccluded=function(b,a){return this.drawPass(0,b,a,1)};c.prototype.drawPass=function(b,a,d,e){var c=this;void 0===e&&(e=0);if(0===d.numViews)return!1;
this._pixelRatio=d.pixelRatio*Math.abs(d.views[0].extent[2]-d.views[0].extent[0])/Math.abs(d.views[0].viewport[2]-d.views[0].viewport[0]);if(this.isEmpty()||4===b&&!this.hasHighlights||2===b&&!this.hasWater||!this.hasNonZeroSizedView(d))return!1;var f=d.width,x=d.height,k=this._renderTargets[a];if(!k)return!1;k.resize(f,x);var p=this._rctx,h=m;h.pixelRatio=d.pixelRatio||1;this._renderContext.pass=b;this._bindParameters.pixelRatio=h.pixelRatio;p.bindFramebuffer(k);p.setClearColor(0,0,0,0);p.clearSafe(16384);
this.updateLightingUniforms();1===e&&(this._renderContext.renderOccludedMask=l.overlayRenderOccludedFlag);if(A.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==e)for(a=0;a<d.numViews;a++)this.setViewParameters(d.views[a],h),this.drawDebugTexture(f,x,F[d.index%F.length]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forEach(function(a){var g=a.layerView;a=a.renderer;if(2!==e||!n.isSome(g)||0!==g.drapeSourceType){var l=n.isSome(g)&&n.isSome(g.fullOpacity)&&1>g.fullOpacity&&0===b;l&&(c.bindTemporaryFramebuffer(f,
x),p.clearSafe(16384));for(var m=0;m<d.numViews;m++)c.setViewParameters(d.views[m],h),a.draw(c._renderContext,c._bindParameters,c._stats);l&&(p.bindFramebuffer(k),c._compositingHelper.composite(c.temporaryTexture,2,n.expect(n.expect(g).fullOpacity)))}});p.bindFramebuffer(null);k.colorTexture.descriptor.hasMipmap&&k.colorTexture.generateMipmap();this._renderContext.resetRenderOccludedMask();return!0};c.prototype.createRenderTarget=function(b,a){for(var d=b,e=0;this._renderTargets[d];)d=b+"_"+ ++e;
this._renderTargets[d]=new Y(this._rctx,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:a,maxAnisotropy:8,width:0,height:0});return d};c.prototype.disposeRenderTargetMemory=function(b){(b=this._renderTargets[b])&&b.resize(0,0)};c.prototype.bindTemporaryFramebuffer=function(b,a){n.isNone(this._temporaryRenderTargetId)&&(this._temporaryRenderTargetId=this.createRenderTarget("temp",!1));var d=this._renderTargets[this._temporaryRenderTargetId];
d.resize(b,a);this._rctx.bindFramebuffer(d)};Object.defineProperty(c.prototype,"temporaryTexture",{get:function(){return this._renderTargets[n.expect(this._temporaryRenderTargetId)].colorTexture},enumerable:!0,configurable:!0});c.prototype.getGpuMemoryUsage=function(){var b=0,a;for(a in this._renderTargets)b+=D.getGpuMemoryUsage(this._renderTargets[a]);return b};c.prototype.getStats=function(){return this._stats.getAggregatedStats()};c.prototype.intersect=function(b,a,d){var e=this,c=0;this._geometries.forEach(function(f){if(!d||
d(f)){e.intersectRenderGeometry(f,a,0,b,c);var g=e.longitudeCyclical;g&&(f.center[0]-f.bsRadius<g.min&&e.intersectRenderGeometry(f,a,g.range,b,c),f.center[0]+f.bsRadius>g.max&&e.intersectRenderGeometry(f,a,-g.range,b,c));c++}})};c.prototype.intersectRenderGeometry=function(b,a,d,e,c){var f=this,g=0;n.isSome(b.transformation)&&(d+=b.transformation[12],g=b.transformation[13]);q[0]=a[0]-d;q[1]=a[1]-g;q[2]=1;r[0]=a[0]-d;r[1]=a[1]-g;r[2]=0;b.pixelRatio=this._pixelRatio;b.material.intersect(b,null,b.getShaderTransformation(),
e,q,r,function(a,d,g){f.addIntersectionResult(g,b.material.renderPriority,c,e,b.data.layerUid,b.data.graphicUid)},b.calculateShaderTransformation,!0)};c.prototype.addIntersectionResult=function(b,a,d,e,c,f){var g={type:"external",metadata:{layerUid:c,graphicUid:f}};c=function(c){c.set(g,null,e.results.ground.dist,e.results.ground.normal,e.results.ground.transformation,a,null,null,b,d);c.intersector="OverlayRenderer"};(null==e.results.min.drapedLayerOrder||a>=e.results.min.drapedLayerOrder)&&(null==
e.results.min.dist||e.results.ground.dist<=e.results.min.dist)&&c(e.results.min);0!==e.options.store&&(null==e.results.max.drapedLayerOrder||a<e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||e.results.ground.dist>e.results.max.dist)&&c(e.results.max);2===e.options.store&&(f=new R.IntersectorResult(e.ray),c(f),e.results.all.push(f))};c.prototype.ensureLayerRenderer=function(b){var a=this,d=this._layerRenderers.get(b);d||(d=new U.SortedRenderGeometryRenderer(this._rctx,this._materialRepository,
function(){return a.emitUpdatingChanged()}),this._layerRenderers.set(b,d),this._sortedLayerRenderersDirty=!0,this._layerViewHandles.set(b,b.watch("fullOpacity",function(){return a.emitContentChanged()})));return d};c.prototype.updateSortedLayerRenderers=function(){var b=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var a=h.firstKeyOfMap(this._layerRenderers).view.allLayerViews,d=K.createSetFromValues(h.valuesOfMap(this._layerRenderers));
a.forEach(function(a){var c=b._layerRenderers.get(a);c&&(b._sortedLayerRenderers.push(new G(a,c)),d.delete(c))});d.forEach(function(a){b._sortedLayerRenderers.push(new G(null,a))})}};c.prototype.setViewParameters=function(b,a){a.viewport=b.viewport;var c=b.extent;t.mat4.ortho(a.projectionMatrix,0,c[2]-c[0],0,c[3]-c[1],a.near,a.far);t.mat4.identity(a.viewMatrix);t.mat4.translate(a.viewMatrix,a.viewMatrix,[-b.extent[0],-b.extent[1],0]);a.setGLViewport(this._rctx);this._renderContext.camera=a;this._bindParameters.view=
a.viewMatrix;this._bindParameters.proj=a.projectionMatrix;this._bindParameters.viewInvTransp=a.viewInverseTransposeMatrix;this._bindParameters.viewport=a.fullViewport;this._shaderTechniqueRepository.getProgramsUsingUniform("proj").forEach(function(b){b.setUniformMatrix4fv("proj",a.projectionMatrix)})};c.prototype.updateLightingUniforms=function(){var b=this;this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection").forEach(function(a){b._lighting.setUniforms(a)})};c.prototype.hasNonZeroSizedView=
function(b){for(var a=0;a<b.numViews;a++){var c=b.views[a];if(c.extent[0]!==c.extent[2]&&c.extent[1]!==c.extent[3])return!0}return!1};c.prototype.emitContentChanged=function(){if(this.onContentChanged)this.onContentChanged()};c.prototype.emitUpdatingChanged=function(){if(this.onUpdatingChanged)this.onUpdatingChanged()};c.prototype.updateHasHighlights=function(){var b=h.someMap(this._layerRenderers,function(a){return a.hasHighlights});if(b!==this._hasHighlights&&(this._hasHighlights=b,this.onHasHighlightsChanged))this.onHasHighlightsChanged(this._hasHighlights)};
c.prototype.updateRendersOccluded=function(){var b=h.someMap(this._layerRenderers,function(a){return a.rendersOccluded});if(b!==this._rendersOccluded&&(this._rendersOccluded=b,this.onRendersOccludedChanged))this.onRendersOccludedChanged(this.rendersOccluded)};c.prototype.drawDebugTexture=function(b,a,c){var d=this._rctx;this.ensureDebugPatternResources(b,a);b=this._debugPatternProgram;d.bindProgram(b);d.setPipelineState(this._debugPatternPipelineState);b.setUniform4f("color",c[0],c[1],c[2],1);b.setUniform1i("tex",
0);d.bindTexture(this._debugPatternTexture,0);d.bindVAO(this._quadVAO);d.drawArrays(5,0,D.vertexCount(this._quadVAO,"geometry"))};c.prototype.ensureDebugPatternResources=function(b,a){if(!this._debugPatternTexture){for(var c=new Uint8Array(b*a*4),e=0,g=0;g<a;g++)for(var f=0;f<b;f++){var h=Math.floor(f/10),k=Math.floor(g/10);2>h||2>k||10*h>b-20||10*k>a-20?(c[e++]=255,c[e++]=255,c[e++]=255,c[e++]=255):(c[e++]=255,c[e++]=255,c[e++]=255,h&1&&k&1?c[e++]=f&1^g&1?0:255:c[e++]=h&1^k&1?0:128)}this._debugPatternTexture=
new Z(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:b,height:a},c);b=new C.TextureTechniqueConfiguration;b.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(C.TextureTechnique,b,this._debugTextureTechnique);this._debugPatternProgram=this._debugTextureTechnique.program;this._debugPatternPipelineState=this._debugTextureTechnique.pipeline;this._quadVAO=B.createQuadVAO(this._rctx)}};Object.defineProperty(c.prototype,"test",
{get:function(){return{layerRenderers:this._layerRenderers}},enumerable:!0,configurable:!0});z([v.autoDispose()],c.prototype,"_shaderTechniqueRepository",void 0);z([v.autoDispose()],c.prototype,"_stippleTextureRepository",void 0);return c}(L.declared(v.AutoDisposable));l.OverlayRenderer=y;var G=function(){return function(h,c){this.layerView=h;this.renderer=c}}(),F=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],m=new O.default;m.near=1;m.far=1E4;var q=u.vec3f64.create(),r=u.vec3f64.create();l.DRAPED_Z=-2;l.overlayRenderOccludedFlag=
4});