// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Accessor ../../../core/Handles ../../../core/accessorSupport/decorators ../../../layers/support/layerUtils ../support/projectionUtils ./terrainUtils ./TilingScheme".split(" "),function(p,q,k,d,l,m,c,n,f,g,e){return function(h){function b(a){a=h.call(this,a)||this;a._changeHandles=new m;return a}k(b,h);b.prototype.initialize=function(){var a=this;this._changeHandles.add(this.layers.on("change",
function(){return a._update()}));this._changeHandles.add(this.extentHelper.watch("layerViewsExtent",function(){return a._setAdHocTilingScheme()}));this._update();this.tilingSchemeLocked||this._setAdHocTilingScheme()};b.prototype.destroy=function(){this._changeHandles.destroy();this._changeHandles=null};b.prototype._update=function(){var a=this;this._waitTask=null;if(!this.tilingSchemeLocked){this._set("tilingSchemeDone",!1);var b;this.layers.some(function(c){return!n.isTiledLayer(c)||c.isRejected()?
!1:!c.isFulfilled()||g.getTiledLayerInfo(c,a.viewSpatialReference,a.manifold).tileInfo?(b=c,"vector-tile"!==c.type):!1});if(b)if(b.isResolved()){var c=g.getTiledLayerInfo(b,this.viewSpatialReference,this.manifold).tileInfo,c=new e(c);this._set("tilingSchemeDone",!0);this._lockTilingScheme(c)}else this._updateWhen(b);else this._set("tilingSchemeDone",!0)}};b.prototype._updateWhen=function(a){var b=this,c=a.when().catch(function(a){return a}).then(function(){c===b._waitTask&&b._update()});this._waitTask=
c};b.prototype._lockTilingScheme=function(a){var b=this;if("spherical"===this.manifold){var c=a.levels.length-1;a.spatialReference.isWebMercator?a=e.makeWebMercatorAuxiliarySphere(c):f.canProjectToWGS84ComparableLonLat(a.spatialReference)&&(a=e.makeGCSWithTileSize(a.spatialReference,a.pixelSize,c))}this.tilingSchemeLocked=!0;this.tilingScheme=a;this.extentHelper.tilingScheme=this.tilingScheme;this._updateTiledLayerExtent();this._changeHandles.removeAll();this._changeHandles.add(this.extentHelper.watch("tiledLayersExtent",
function(){return b._updateTiledLayerExtent()}))};b.prototype._updateTiledLayerExtent=function(){this.extent=this.extentHelper.tiledLayersExtent};b.prototype._setAdHocTilingScheme=function(){if("spherical"===this.manifold){var a=this.extentHelper.spatialReference;a.isWebMercator?this.tilingScheme=e.WebMercatorAuxiliarySphere:f.canProjectToWGS84ComparableLonLat(a)&&(this.tilingScheme=e.makeGCSWithTileSize(a,256));this.extent=this.extentHelper.layerViewsExtent}else if(a=this.extentHelper.layerViewsExtent)this.tilingScheme=
e.fromExtent(a,this.extentHelper.spatialReference),this.extent=a};d([c.property()],b.prototype,"tilingScheme",void 0);d([c.property()],b.prototype,"extent",void 0);d([c.property({value:!1})],b.prototype,"tilingSchemeLocked",void 0);d([c.property({readOnly:!0,value:!1})],b.prototype,"tilingSchemeDone",void 0);d([c.property({constructOnly:!0})],b.prototype,"viewSpatialReference",void 0);d([c.property({constructOnly:!0})],b.prototype,"layers",void 0);d([c.property({constructOnly:!0})],b.prototype,"extentHelper",
void 0);d([c.property({constructOnly:!0})],b.prototype,"manifold",void 0);return b=d([c.subclass("esri.views.3d.terrain.SurfaceTilingSchemeLogic")],b)}(c.declared(l))});