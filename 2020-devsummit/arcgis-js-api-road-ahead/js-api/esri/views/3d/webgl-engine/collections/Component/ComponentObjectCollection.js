// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/extendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/typedArrayUtil ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f32 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4 ../../../../../core/libs/gl-matrix-2/vec4f32 ../../../../../geometry/support/aaBoundingBox ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/BufferView ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./interface ./RenderSubmitSystem ./SourceGeometry ./IndexRange/ComponentRangeRunLengthEncoded ./Material/ComponentMaterial ./Material/ComponentTechnique ../../core/util/BucketedObjectStore ../../core/util/TwoVectorPosition ../../lib/AutoDisposable ../../lib/ComponentUtils ../../lib/geometryDataUtils ../../lib/Util ../../lib/TextureBackedBuffer/BufferManager ../../materials/internal/MaterialUtil ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject".split(" "),
function(H,w,pa,x,y,Q,l,R,u,I,p,C,S,T,U,V,W,X,J,Y,Z,aa,ba,ca,z,da,K,ea,h,D,fa,ga,ha,E,F,ia){function ja(c,a,b){var d=[],e=b.length;a.forEachComponent(function(a){0<c[a]&&(e!==a-1&&(d.length&&d.push(b[e+1]-d[d.length-1]),d.push(b[a])),e=a);return!0});d.length&&d.push(b[e+1]-d[d.length-1]);return d}Object.defineProperty(w,"__esModule",{value:!0});var L=Q.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");H=function(){function c(a){this._renderManager=a;this._objects=
new K.BucketedObjectStore;this._renderSubmit=new aa.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);this._componentBufferManager=new ha.BufferManager(a.rctx)}c.prototype.dispose=function(){ga.assert(0===this.count,"ObjectCollection should be empty upon disposal")};c.prototype.createObject=function(a){var b=new M;b.toMapSpace=a.toMapSpace.slice();b.transform=a.transform;b.obb=W.clone(a.obb);b.components=new ka(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=
this._createRenderable(a,b.components);b.intersectionGeometry=new la(a.geometry.positionData,b.components);this._objects.add(a.visible?v:0,b);return b};c.prototype.destroyObject=function(a){this._objects.remove(a);a.dispose();this._notifyDirty()};c.prototype.setObjectVisibility=function(a,b){b!==a.visible&&(this._objects.updateKey(a,b?a.bucketKey|v:a.bucketKey&~v),this._notifyDirty())};Object.defineProperty(c.prototype,"count",{get:function(){return this._objects.count},enumerable:!0,configurable:!0});
c.prototype.preSubmit=function(a){var b=a.camera.eye;this._objects.forEach(function(a,e){e&v&&a.forEach(function(a){var d=p.vec3.squaredDistance(b,a.obb.center);a.renderable.meta.cameraDepthSquared=d})})};c.prototype.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};c.prototype.setAllComponentVisibilities=function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};c.prototype.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};
c.prototype.getComponentCount=function(a){var b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};c.prototype.setComponentData=function(a,b){var d=a.renderable.material;if(Z.isVaryingComponentParameters(b)){a=a.components;for(var e=a.materialDataBuffer,c=a.materialDataIndices,f={castShadows:!0,pickable:!0,externalColor:T.vec4f32.create(),externalColorMixMode:1},e=e.textureBuffer,g=new Uint8Array(4),l=new Uint32Array(g.buffer),m=0,k=0,q=0,n=0,p=!1,h=0,t=0;t<
a.count;t++)b(t,f),m+=+(1>f.externalColor[3]),k+=+(3===f.externalColorMixMode&&1===f.externalColor[3]),q+=+(0<f.externalColor[3]),n+=+f.castShadows,V.encodeSymbolColor(f.externalColor,f.externalColorMixMode,g),g[2]=g[2]&254|+f.castShadows,e.setData(c[t],0,g[0],g[1],g[2],g[3]),p=p||0<t&&h!==l[0],h=l[0],f.pickable!==D.getVisibility(a.pickability,t)&&(a.pickability=D.updateVisibilityWithCount(a.pickability,a.count,t,f.pickable));p?(d.componentParameters=new z.ComponentParametersVarying,d.componentParameters.castShadows=
n===a.count?0:0===n?2:1,d.componentParameters.transparent=m===a.count?0:0===m?2:1,d.componentParameters.opaqueOverride=k===a.count?0:0===k?2:1,d.componentParameters.visible=q===a.count?0:0===q?2:1,d.componentParameters.texture=e,e.updateTexture()):(d.componentParameters=new z.ComponentParametersUniform,d.componentParameters.castShadows=f.castShadows?0:2,d.componentParameters.externalColor=f.externalColor,d.componentParameters.externalColorMixMode=f.externalColorMixMode)}else d.componentParameters=
new z.ComponentParametersUniform,d.componentParameters.castShadows=b.castShadows?0:2,d.componentParameters.externalColor=b.externalColor,d.componentParameters.externalColorMixMode=b.externalColorMixMode;this._notifyDirty()};c.prototype.getComponentAABB=function(a,b,d){return a.intersectionGeometry.getComponentAABB(b,d)};c.prototype.getObjectTransform=function(a){return a.transform};c.prototype.getComponentPositions=function(a,b,d){return a.intersectionGeometry.getComponentPositions(b,d)};c.prototype.intersect=
function(a,b,d,c,r,f){l.isSome(r)&&(r.localOrigin=a.transform.position);var e=u.mat3.invert(N,a.transform.rotationScale);p.vec3.sub(A,b,a.transform.position);p.vec3.sub(B,d,a.transform.position);p.vec3.transformMat3(A,A,e);p.vec3.transformMat3(B,B,e);b=u.mat3.transpose(N,e);return a.intersectionGeometry.intersect(A,B,c,b,r,f)};c.prototype.addEdges=function(a,b,d,c){var e=a.intersectionGeometry;return b.addComponentObject(a,a.transform,a.obb.center,e.positions,e.indices,a.components.offsets,d,c)};
c.prototype.addComponentHighlight=function(a,b){a=a.components;l.isNone(a.highlightCounts)&&(a.highlightCounts=new Uint32Array(a.count+1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};c.prototype.removeComponentHighlight=function(a,b){a=a.components;if(l.isNone(a.highlightCounts))L.warn("Removing non-existing highlight.");else{var d=a.highlightCounts[b],c=a.highlightCounts[a.count];0===d?L.warn("Removing non-existing highlight."):1<d?(a.highlightCounts[b]=
d-1,a.highlightCounts[a.count]=c-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===c?a.highlightCounts=null:a.highlightCounts[a.count]=c-1)}};c.prototype.clearHighlights=function(a){a=a.components;l.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};c.prototype.getObjectMemoryUsageGPU=function(a){return a.renderable.meta.gpuMemoryEstimate};Object.defineProperty(c.prototype,"visibleObjects",{get:function(){return this._objects.getBucket(v)},
enumerable:!0,configurable:!0});c.prototype._createRenderable=function(a,b){for(var d=this._renderManager.rctx,c=a.geometry,r=c.vertices.layoutParameters,f=F.createVertex(d,35044,c.vertices.data),g=l.applySome(c.indices,function(a){return F.createIndex(d,35044,a)}),G=J.glLayout(ba.createVertexBufferLayout(r)),m=new Uint16Array(c.vertices.count),k=0;k<b.count;k++){var q=b.offsets[k],n=b.offsets[k+1],h=b.materialDataIndices[k];if(l.isSome(c.indices))for(;q<n;q++)m[c.indices[q]]=h;else for(;q<n;q++)m[q]=
h}b=F.createVertex(d,35044,m.buffer);k=new ea.TwoVectorPosition(a.transform.position);n=I.mat3f32.clone(a.transform.rotationScale);u.mat3.invert(n,n);u.mat3.transpose(n,n);m=new da.ComponentDrawParameters;p.vec3.copy(m.worldFromModel_TL,k.low);p.vec3.copy(m.worldFromModel_TH,k.high);u.mat3.copy(m.worldFromModel_RS,a.transform.rotationScale);u.mat3.copy(m.transformNormal_GlobalFromModel,n);S.vec4.copy(m.toMapSpace,a.toMapSpace);a=new z.ComponentMaterial;G=new ia(d,a.attributeLocations,{data:G,componentIndices:ma},
{data:f,componentIndices:b},l.unwrap(g));k=new O;k.material=a;k.drawParameters=m;k.geometry=new P(G,c.primitiveType,r,l.isSome(g));k.meta.cameraDepthSquared=.5;k.meta.gpuMemoryEstimate=f.byteSize+b.byteSize+(l.isSome(g)?g.byteSize:0);return k};c.prototype._notifyDirty=function(){this._renderManager.notifyDirty()};return c}();w.ComponentObjectCollection=H;var ka=function(c){function a(a,d){var b=c.call(this)||this;b.pickability=null;b.highlightCounts=null;b.cachedGeometryRanges=null;b.cachedHighlightRanges=
null;b.offsets=R.slice(d);d=b.count;b.visibility=new ca.ComponentRangeRunLengthEncoded(d);b.materialDataBuffer=a.getBuffer(d);b.materialDataIndices=new Uint16Array(d);for(a=0;a<d;a++)b.materialDataIndices[a]=b.materialDataBuffer.acquireIndex();return b}x(a,c);a.prototype.dispose=function(){c.prototype.dispose.call(this);for(var a=0;a<this.count;a++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[a])};Object.defineProperty(a.prototype,"count",{get:function(){return this.offsets.length-
1},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"geometryRanges",{get:function(){l.isNone(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets));return this.cachedGeometryRanges},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"highlightRanges",{get:function(){if(l.isNone(this.highlightCounts))return null;l.isNone(this.cachedHighlightRanges)&&(this.cachedHighlightRanges=ja(this.highlightCounts,this.visibility,
this.offsets));return this.cachedHighlightRanges},enumerable:!0,configurable:!0});a.prototype.highlightsDirty=function(){this.cachedHighlightRanges=null};a.prototype.visibilityDirty=function(){this.cachedHighlightRanges=this.cachedGeometryRanges=null};return a}(h.AutoDisposable),la=function(){function c(a,b){this._indices=l.isSome(a.indices)?a.indices:fa.generateDefaultIndexArray(a.positions.length/3);this._positions=new X.BufferViewVec3f(a.positions);this._components=b}c.prototype.getComponentAABB=
function(a,b){if(l.isSome(this._perComponentAABBs)){for(var c=0;6>c;c++)b[c]=this._perComponentAABBs[6*a+c];return b}this._computePerComponentAABBs();return this.getComponentAABB(a,b)};c.prototype.getComponentPositions=function(a,b){b.indices=this._indices;b.data=this._positions.typedBuffer;b.stride=this._positions.typedBufferStride;b.startIndex=this._components.offsets[a];b.endIndex=this._components.offsets[a+1]};c.prototype.intersect=function(a,b,c,e,r,f){var d=this,h={data:this._positions.typedBuffer,
strideIdx:this._positions.typedBufferStride,offsetIdx:0,size:3},m=this._indices,k=this._components.offsets,q=E.computeInvDir(a,b,na);this._components.visibility.forEachComponent(function(g){if(!D.getVisibility(d._components.pickability,g))return!0;var n=d.getComponentAABB(g,oa);l.isSome(r)&&r.applyToAABB(n);if(!E.intersectAabbInvDir(n,a,q,c))return!0;E.intersectTriangles(a,b,k[g]/3,k[g+1]/3,m,h,void 0,r,function(a,b,c){return f(g,a,p.vec3.transformMat3(b,b,e),c)});return!0})};c.prototype._computePerComponentAABBs=
function(){var a=this._components.count;this._perComponentAABBs=new Float32Array(6*a);for(var b=0;b<a;b++)this._computeAABB(b)};c.prototype._computeAABB=function(a){for(var b=this._indices,c=this._positions,e=this._components.offsets,l=e[a+1],f=[0,0,0],g=[Infinity,Infinity,Infinity],h=[-Infinity,-Infinity,-Infinity],e=e[a];e<l;e++)c.getVec(b[e],f),p.vec3.min(g,g,f),p.vec3.max(h,h,f);a*=6;this._perComponentAABBs[a++]=g[0];this._perComponentAABBs[a++]=g[1];this._perComponentAABBs[a++]=g[2];this._perComponentAABBs[a++]=
h[0];this._perComponentAABBs[a++]=h[1];this._perComponentAABBs[a]=h[2]};Object.defineProperty(c.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"indices",{get:function(){return this._indices},enumerable:!0,configurable:!0});return c}(),P=function(c){function a(a,d,e,h){var b=c.call(this)||this;b.vao=a;b.primitiveType=d;b.parameters=e;b.indexed=h;return b}x(a,c);y([h.autoDispose()],a.prototype,"vao",void 0);return a}(h.AutoDisposable);
w.RenderGeometry=P;var O=function(c){function a(){var a=null!==c&&c.apply(this,arguments)||this;a.meta={cameraDepthSquared:0,gpuMemoryEstimate:0};return a}x(a,c);y([h.autoDispose()],a.prototype,"geometry",void 0);return a}(h.AutoDisposable);w.Renderable=O;var ma=J.glLayout(Y.newLayout().u16("componentIndex")),M=function(c){function a(){return null!==c&&c.apply(this,arguments)||this}x(a,c);Object.defineProperty(a.prototype,"visible",{get:function(){return!!(this.bucketKey&v)},enumerable:!0,configurable:!0});
y([h.autoDispose()],a.prototype,"renderable",void 0);y([h.autoDispose()],a.prototype,"components",void 0);return a}(K.BucketStorable);w.ComponentObject=M;var N=I.mat3f32.create(),na=C.vec3f64.create(),A=C.vec3f64.create(),B=C.vec3f64.create(),oa=U.create(),v=1});