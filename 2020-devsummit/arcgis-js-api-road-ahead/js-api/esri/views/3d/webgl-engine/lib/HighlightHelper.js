// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f32 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/debugFlags ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./glUtil3D ./Util ../shaders/HighlightTechnique ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(C,D,u,r,v,t,w,x,y,z,p,A,q,n,B){return function(){function m(a,b){this._grid={coverageMipmap:null,
vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0};this.blur1Fbo=this.blur0Fbo=this.quadVAO=null;this._rctx=b;this.viewportToRestore=v.vec4f64.create();this.defaultOptions={color:r.vec4f32.fromValues(1,0,1,1),haloColor:r.vec4f32.fromValues(1,0,1,1),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05};b=new p.HighlightCompositionTechniqueConfiguration;b.highlightStage=0;b.gridOptimization=!1;this.blurTechnique=
a.acquireAndReleaseExisting(p.HighlightCompositionTechnique,b,this.blurTechnique);b.highlightStage=0;b.gridOptimization=!0;this.blurGridTechnique=a.acquireAndReleaseExisting(p.HighlightCompositionTechnique,b,this.blurGridTechnique);b.highlightStage=1;b.gridOptimization=!1;this.applyTechnique=a.acquireAndReleaseExisting(p.HighlightCompositionTechnique,b,this.applyTechnique);b.highlightStage=1;b.gridOptimization=!0;this.applyGridTechnique=a.acquireAndReleaseExisting(p.HighlightCompositionTechnique,
b,this.applyGridTechnique);b.highlightStage=2;b.gridOptimization=!1;this.downsampleTechnique=a.acquireAndReleaseExisting(p.HighlightCompositionTechnique,b,this.downsampleTechnique)}Object.defineProperty(m.prototype,"enabled",{get:function(){return null!==this.blur0Fbo},set:function(a){a?this.enable():this.disable()},enumerable:!0,configurable:!0});Object.defineProperty(m.prototype,"profilingCallback",{get:function(){return t.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(a){return console.log(a)}:null},enumerable:!0,
configurable:!0});m.prototype.setDefaultOptions=function(a){this.defaultOptions=a};m.prototype.render=function(a,b,l){var d=a.pixelRatio,e=!t.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,c=this._rctx;z.assert(this.enabled);u.vec4.copy(this.viewportToRestore,a.fullViewport);var g=Math.ceil(a.fullWidth/d),d=Math.ceil(a.fullHeight/d);this.blur0Fbo.resize(g,d);this.blur1Fbo.resize(g,d);c.bindVAO(this.quadVAO);var f=a=null;e&&(this._gridUpdateResources(b,32),this._gridComputeMipmap());e?(a=this._grid.vao,f=this.blurGridTechnique,
c.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,1),f.program.setUniform1i("coverageTex",1)):(a=this.quadVAO,f=this.blurTechnique);f.bindPipelineState(c);c.bindProgram(f.program);c.bindVAO(a);c.bindFramebuffer(this.blur0Fbo);c.setViewport(0,0,g,d);c.setClearColor(0,0,0,0);c.clear(16384);f.program.setUniform1i("tex",0);c.bindTexture(b.colorTexture,0);f.program.setUniform2f("blurSize",1/g,0);c.drawArrays(f.primitiveType,0,n.vertexCount(a,"geometry"));c.bindFramebuffer(this.blur1Fbo);
c.clear(16384);c.bindTexture(this.blur0Fbo.colorTexture,0);f.program.setUniform2f("blurSize",0,1/d);c.drawArrays(f.primitiveType,0,n.vertexCount(a,"geometry"));g=e?this.applyGridTechnique:this.applyTechnique;c.bindFramebuffer(l);g.bindPipelineState(c);c.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]);c.bindProgram(g.program);c.bindTexture(this.blur1Fbo.colorTexture,0);c.bindTexture(b.colorTexture,1);e&&c.bindTexture(this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,
2);g.bindApplyPass(this.defaultOptions);c.drawArrays(g.primitiveType,0,n.vertexCount(a,"geometry"));c.bindVAO(null)};m.prototype.enable=function(){if(!this.enabled){this.quadVAO=y.createQuadVAO(this._rctx);var a={colorTarget:0,depthStencilTarget:0,width:0,height:0},b={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=new q(this._rctx,a,b);this.blur1Fbo=new q(this._rctx,a,b)}};m.prototype.disable=function(){this.enabled&&(this.quadVAO.dispose(!0),
this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.blur1Fbo=this.blur0Fbo=this.quadVAO=null)};m.prototype._gridUpdateResources=function(a,b){var l=this._rctx,d=this._grid,e=!1;null===d.coverageMipmap&&(d.coverageMipmap=[a],e=!0);if(d.viewportWidth!==a.width||d.viewportHeight!==a.height)e=!0,d.viewportWidth=a.width,d.viewportHeight=a.height;d.coverageMipmap[0]=a;d.cellPixelSize!==b&&(d.cellPixelSize=b,e=!0);if(e){for(b=1;b<d.coverageMipmap.length;b++)d.coverageMipmap[b].dispose();d.mipmapLevels=
Math.ceil(Math.log(d.cellPixelSize)*Math.LOG2E);d.coverageMipmap.length=d.mipmapLevels+1;for(b=0;b<d.mipmapLevels;b++)e=d.coverageMipmap[b],e=new q(l,{colorTarget:0,depthStencilTarget:0,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)},{target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(e.width/2),height:Math.ceil(e.height/2)}),d.coverageMipmap[b+1]=e}var e=Math.ceil(a.height/d.cellPixelSize),c=Math.ceil(a.width/d.cellPixelSize);if(!d.vao||d.verticalCellCount!==
e||d.horizontalCellCount!==c){d.verticalCellCount=e;d.horizontalCellCount=c;a=e+1;b=c+1;for(var e=1/e,c=1/c,g=new Float32Array(24*a*b),f=0,h=0;h<a;h++)for(var k=0;k<b;k++)g[f+0]=(k-.5)*c*2-1,g[f+1]=(h-.5)*e*2-1,g[f+2]=k*c,g[f+3]=h*e,g[f+4]=(k+.5)*c*2-1,g[f+5]=(h-.5)*e*2-1,g[f+6]=k*c,g[f+7]=h*e,g[f+8]=(k-.5)*c*2-1,g[f+9]=(h+.5)*e*2-1,g[f+10]=k*c,g[f+11]=h*e,g[f+12]=(k-.5)*c*2-1,g[f+13]=(h+.5)*e*2-1,g[f+14]=k*c,g[f+15]=h*e,g[f+16]=(k+.5)*c*2-1,g[f+17]=(h-.5)*e*2-1,g[f+18]=k*c,g[f+19]=h*e,g[f+20]=(k+
.5)*c*2-1,g[f+21]=(h+.5)*e*2-1,g[f+22]=k*c,g[f+23]=h*e,f+=24;d.vao&&d.vao.dispose(!0);d.vao=new B(l,w.Default3D,{geometry:x.Pos2Tex},{geometry:A.createVertex(l,35044,g)})}};m.prototype._gridComputeMipmap=function(){var a=this._rctx,b=this._grid,l=this.downsampleTechnique.program;this.downsampleTechnique.bindPipelineState(a);a.bindVAO(this.quadVAO);for(var d=0;d<b.mipmapLevels;d++){a.bindFramebuffer(b.coverageMipmap[d+1]);a.bindTexture(b.coverageMipmap[d].colorTexture,0);var e=b.coverageMipmap[d+1].width,
c=b.coverageMipmap[d+1].height;a.bindProgram(l);l.setUniform1i("tex",0);l.setUniform2f("invFramebufferDim",1/e,1/c);a.setViewport(0,0,e,c);a.drawArrays(5,0,n.vertexCount(this.quadVAO,"geometry"))}};m.prototype.getGpuMemoryUsage=function(){var a=n.getGpuMemoryUsage(this.blur0Fbo)+n.getGpuMemoryUsage(this.blur1Fbo);if(this._grid&&this._grid.coverageMipmap)for(var b=0,l=this._grid.coverageMipmap;b<l.length;b++)a+=n.getGpuMemoryUsage(l[b]);return a};return m}()});