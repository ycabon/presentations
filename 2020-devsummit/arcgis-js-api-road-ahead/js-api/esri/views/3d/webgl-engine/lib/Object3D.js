// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/mathUtils ./ComponentUtils ./GeometryRecord ./IdGen ./Object3DStateSet ./Util".split(" "),function(u,C,z,A,t,n,g,p,v,m,q,B,w,r){u=function(){function b(a){void 0===a&&(a={});this._objectTransformation=n.mat4f64.create();this._bvObjectSpace=
new x;this._bvWorldSpace=new x;this._bvDirty=!0;this._hasVolatileTransformation=!1;this._allComponentsVisibleDirty=this._allComponentsHiddenDirty=!0;this.id=b._idGen.gen(a.idHint);this.castShadow=null!=a.castShadow?a.castShadow:!0;(this.metadata=a.metadata)&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new y);this.objectTransformation=n.mat4f64.create();this._initializeGeometryRecords(a.geometries,a.materials,a.transformations,a.origins)}Object.defineProperty(b.prototype,"geometryRecords",
{get:function(){return this._geometryRecords},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"geometries",{get:function(){return this._geometries},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"objectTransformation",{get:function(){return this._objectTransformation},set:function(a){t.mat4.copy(this._objectTransformation,a);this._invalidateBoundingVolume();this._notifyDirty("objTransformation")},enumerable:!0,configurable:!0});b.prototype.dispose=function(){for(var a=
0,c=this._geometryRecords;a<c.length;a++)q.pool.release(c[a]);this._geometries=this._geometryRecords=null};b.prototype._initializeGeometryRecords=function(a,c,d,b){if(Array.isArray(a)){r.assert(c.length===a.length,"Object3D: materials don't match geometries");r.assert(d.length===a.length,"Object3D: transformations don't match geometries");this._geometryRecords=Array(a.length);this._geometries=a.slice();for(var e=0;e<a.length;e++)this._geometryRecords[e]=q.pool.acquire(a[e],c[e],n.mat4f64.clone(d[e]),
{},b&&b[e]);this._hasVolatileTransformation=!1}else this._geometryRecords=[],this._geometries=[]};Object.defineProperty(b.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(a){r.assert(null==this._parentLayer||null==a,"Object3D can only be added to a single Layer");this._parentLayer=a},enumerable:!0,configurable:!0});b.prototype.getNumGeometryRecords=function(){return this._geometryRecords.length};b.prototype.findGeometryRecords=function(a){for(var c=[],d=0;d<this._geometries.length;d++)this._geometries[d]===
a&&c.push(this._geometryRecords[d]);return c};b.prototype.getGeometryRecord=function(a){r.assert(0<=a&&a<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range");return this._geometryRecords[a]};b.prototype.addGeometry=function(a,c,d,b,g,h){d=d?d:n.mat4f64.IDENTITY;this._geometries.push(a);a=q.pool.acquire(a,c,d,b||{},g,h);this._geometryRecords.push(a);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});this._notifyDirty("objGeometryAdded",
a);this._invalidateBoundingVolume();this._allComponentsVisibleDirty=this._allComponentsHiddenDirty=!0;return a};b.prototype.removeGeometry=function(a){var c=this._geometryRecords.splice(a,1)[0];q.pool.release(c);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});this._geometries.splice(a,1);this._notifyDirty("objGeometryRemoved",c);this._invalidateBoundingVolume();this._allComponentsVisibleDirty=this._allComponentsHiddenDirty=!0;return c};b.prototype.removeAllGeometries=
function(){for(;0<this.getNumGeometryRecords();)this.removeGeometry(0)};b.prototype.geometryVertexAttrsUpdated=function(a){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[a]);this._invalidateBoundingVolume()};b.prototype.isHidden=function(){if(this._allComponentsHiddenDirty){this._allComponentsHiddenDirty=!1;this._allComponentsHidden=!0;for(var a=0,c=this._geometryRecords;a<c.length;a++){var d=c[a];if(!m.isAllHidden(d.instanceParameters.componentVisibilities,d.geometry.data.componentOffsets)){this._allComponentsHidden=
!1;break}}}return this._allComponentsHidden};b.prototype.isVisible=function(){if(this._allComponentsVisibleDirty){this._allComponentsVisibleDirty=!1;this._allComponentsVisible=!0;for(var a=0,c=this._geometryRecords;a<c.length;a++){var d=c[a];if(!m.isAllVisible(d.instanceParameters.componentVisibilities,d.geometry.data.componentOffsets)){this._allComponentsVisible=!1;break}}}return this._allComponentsVisible};b.prototype.hide=function(){if(this._allComponentsHiddenDirty||!this._allComponentsHidden){for(var a=
0,c=this._geometryRecords;a<c.length;a++){var d=c[a],b=m.hideAllComponents(d.instanceParameters.componentVisibilities);d.instanceParameters.componentVisibilities=b}this._notifyDirty("visibilityChanged");this._allComponentsVisibleDirty=this._allComponentsHiddenDirty=!1;this._allComponentsHidden=!0;this._allComponentsVisible=!1}};b.prototype.unhide=function(){if(this._allComponentsVisibleDirty||!this._allComponentsVisible){for(var a=0,c=this._geometryRecords;a<c.length;a++){var d=c[a],b=m.unhideAllComponents(d.instanceParameters.componentVisibilities);
d.instanceParameters.componentVisibilities=b}this._notifyDirty("visibilityChanged");this._allComponentsHidden=this._allComponentsVisibleDirty=this._allComponentsHiddenDirty=!1;this._allComponentsVisible=!0}};b.prototype.occlude=function(){for(var a=w.generateObject3DStateId(1),c=0,d=this._geometryRecords;c<d.length;c++){var b=d[c];b.instanceParameters.occludees=m.addOccludee(b.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged");return a};b.prototype.removeOcclude=function(a){for(var c=
0,b=this._geometryRecords;c<b.length;c++){var e=b[c];e.instanceParameters.occludees=m.removeOccludee(e.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged")};b.prototype.highlight=function(){for(var a=w.generateObject3DStateId(0),c=0,b=this._geometryRecords;c<b.length;c++){var e=b[c];e.instanceParameters.componentHighlights=m.addHighlight(e.instanceParameters.componentHighlights,null,a)}this._notifyDirty("highlightChanged");return a};b.prototype.removeHighlight=function(a){for(var c=
0,b=this._geometryRecords;c<b.length;c++){var e=b[c];e.instanceParameters.componentHighlights=m.removeHighlight(e.instanceParameters.componentHighlights,a)}this._notifyDirty("highlightChanged")};b.prototype.getComponentFromTriangleNr=function(a,c){r.assert(0<=a&&a<this._geometryRecords.length,"Object3d.getComponentFromTriangleNr: index out of range");return m.componentFind(this._geometryRecords[a].geometry.data.componentOffsets,3*c)};b.prototype.setGeometryTransformation=function(a,c){r.assert(0<=
a&&a<this._geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");var b=this._geometryRecords[a];q.pool.release(b);c=q.pool.acquire(b.geometry,b.material,n.mat4f64.clone(c),b.instanceParameters);this._geometryRecords[a]=c;this._notifyDirty("objGeometryReplaced",[b,c]);this._invalidateBoundingVolume()};b.prototype.getCombinedStaticTransformation=function(a,c){return t.mat4.multiply(A.unwrapOr(c,n.mat4f64.create()),this.objectTransformation,a.getStaticTransformation())};b.prototype.getCombinedShaderTransformation=
function(a,c){c=c||n.mat4f64.create();t.mat4.multiply(c,this.objectTransformation,a.getShaderTransformation());return c};b.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation};b.prototype.getBBMin=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin};b.prototype.getBBMax=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax};b.prototype.getCenter=function(a){this._validateBoundingVolume();
return a?this._bvObjectSpace.center:this._bvWorldSpace.center};b.prototype.getBSRadius=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius};b.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init();this._bvWorldSpace.init();for(var a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],b=this._geometryRecords[a],c=c.boundingInfo;this._calculateTransformedBoundingVolume(c,
this._bvObjectSpace,b.getShaderTransformation());this._calculateTransformedBoundingVolume(c,this._bvWorldSpace,this.getCombinedShaderTransformation(b))}g.vec3.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5);g.vec3.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);for(var b=p.vec3f64.create(),e=p.vec3f64.create(),k=v.maxScale(this.objectTransformation),a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],h=this._geometryRecords[a].getShaderTransformation(),
f=v.maxScale(h),c=c.boundingInfo;g.vec3.transformMat4(b,c.getCenter(),h);h=g.vec3.distance(b,this._bvObjectSpace.center);c=c.getBSRadius()*f;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,h+c);g.vec3.transformMat4(e,b,this.objectTransformation);f=g.vec3.distance(e,this._bvWorldSpace.center);this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,f+c*k)}this._bvDirty=!1}};b.prototype._calculateTransformedBoundingVolume=function(a,c,b){var d=a.getBBMin();a=a.getBBMax();
var k=p.vec3f64.clone(d),h=p.vec3f64.clone(a);g.vec3.transformMat4(k,k,b);g.vec3.transformMat4(h,h,b);for(var f=0;3>f;++f)c.bbMin[f]=Math.min(c.bbMin[f],k[f],h[f]),c.bbMax[f]=Math.max(c.bbMax[f],k[f],h[f]);for(f=0;3>f;++f){g.vec3.copy(k,d);g.vec3.copy(h,a);k[f]=a[f];h[f]=d[f];g.vec3.transformMat4(k,k,b);g.vec3.transformMat4(h,h,b);for(var l=0;3>l;++l)c.bbMin[l]=Math.min(c.bbMin[l],k[l],h[l]),c.bbMax[l]=Math.max(c.bbMax[l],k[l],h[l])}};b.prototype._invalidateBoundingVolume=function(){this._bvDirty=
!0;this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})};b.prototype._notifyDirty=function(a,c,b,e){this._parentLayer&&this._parentLayer.notifyDirty(a,c,b||1,e||this)};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{hasGeometry:function(c){return-1<a._geometries.indexOf(c)},getGeometryIndex:function(c){return a._geometries.indexOf(c)}}},enumerable:!0,configurable:!0});b._idGen=new B.IdGen;
return b}();var y=function(){function b(){this.bbMin=p.vec3f64.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this.bbMax=p.vec3f64.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}b.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]};return b}(),x=function(b){function a(){var a=b.call(this)||this;a.center=p.vec3f64.create();a.bsRadius=0;return a}z(a,b);a.prototype.init=function(){g.vec3.set(this.bbMin,
Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);g.vec3.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);g.vec3.set(this.center,0,0,0);this.bsRadius=0};a.prototype.getCenter=function(){return this.center};a.prototype.getBSRadius=function(){return this.bsRadius};return a}(y);return u});