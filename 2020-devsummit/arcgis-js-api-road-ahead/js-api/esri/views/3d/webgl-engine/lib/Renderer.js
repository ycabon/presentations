// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/compilerUtils ../../../../core/Handles ../../../../core/MapUtils ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/vec2f64 ../../support/debugFlags ../core/shaderLibrary/hud/HUD.glsl ./BoundingInfo ./depthRange ./depthRangeUtils ./FxaaRenderPass ./glUtil3D ./HighlightHelper ./Material ./OffscreenRenderingHelper ./RenderContext ./rendererUtils ./RenderPluginManager ./renderStats ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../materials/internal/waterMaterialUtils ../../../webgl/Profiling".split(" "),
function(r,W,y,z,t,u,v,A,B,n,p,C,D,E,F,G,H,w,I,J,K,L,M,N,O,P,Q,R,S,T,U,V){r=function(){function b(a,c,g,d,b,e,h){var f=this;this._materialRep=a;this._rctx=d;this._compositingHelper=b;this.requestRender=e;this._stage=h;this._materialRenderers=new Map;this._hasOccludees=this._hasHighlights=!1;this._lighting=new S.SceneLighting;this._content=new Map;this._isRendering=!1;this._fallbackDepthStencilTexture=null;this._stats=new M.RenderStatsAggregator;this._antialiasing=1;this._edgeView=null;this._handles=
new z;this.renderHiddenTransparentEdges=function(){};this._shaderTechniqueRepository=g;this._fxaaPass=new F(this._rctx);this._smaaPass=new P(this._rctx);this._bindParameters={slot:null,view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,viewport:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1};this._offscreenRendering=new I(this._rctx,this._compositingHelper);this._sliceHelper=new O;this._shadowMap=new N(this._rctx);
this._ssaoHelper=new Q(g,this._rctx,function(){return f.requestRender()});this._highlightHelper=new H(g,this._rctx);this._renderPlugins=new L.RenderPluginManager({rctx:this._rctx,shaderTechniqueRep:g,textureRep:c,materialRep:this._materialRep,requestRender:this.requestRender});this._renderContext=new J(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);this._handles.add(A.init(n,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",function(a){f.renderHiddenTransparentEdges=
a?function(){return f.renderEdges(1)}:function(){};f.requestRender()}))}b.prototype.dispose=function(){this._handles.destroy();this._materialRenderers.forEach(function(a){a.dispose()});this._materialRenderers=null;this._edgeView&&(this._edgeView.destroy(),this._edgeView=null);this._offscreenRendering.enabled=!1;this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());
this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);C.tmpIndices.prune();this._content.clear();this._content=null};Object.defineProperty(b.prototype,"updating",{get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources||U.waterTextureRepo.loading()},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new R.EdgeView(this._rctx,this._shaderTechniqueRepository,
{setNeedsRender:function(){return a.requestRender()}}),this._edgeView.initialize());return this._edgeView};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!0,configurable:!0});b.prototype.setLighting=function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.shadowMapResolution&&!1===this._shadowMap.enabled&&(this._shadowMap.textureResolution=a.shadowMapResolution);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap);
void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&(this._ssaoHelper.attenuation=a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);a.background&&
(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this._antialiasing=a.antialiasingEnabled?1:0);void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);void 0!==a.slicePlane&&(this._sliceHelper.plane=a.slicePlane);this.requestRender()};Object.defineProperty(b.prototype,"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!0,configurable:!0});b.prototype.getRenderParams=function(){var a={};this._shadowMap&&
(a.shadowMap=this._shadowMap.enabled,a.shadowMapResolution=this._shadowMap.textureResolution,a.shadowMapMaxCascades=this._shadowMap.maxCascades);this._ssaoHelper&&this._ssaoHelper.isSupported&&(a.ssao=this._ssaoHelper.enabled,a.ssaoAttenuation=this._ssaoHelper.attenuation,a.ssaoRadius=this._ssaoHelper.radius,a.ssaoFilterRadius=this._ssaoHelper.filterRadius,a.ssaoSamples=this._ssaoHelper.samples);return a};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return!0},enumerable:!0,configurable:!0});b.prototype.getStats=function(){return this._stats.getAggregatedStats()};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;
case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture;default:return y.neverReached(a),null}};b.prototype.isEmpty=function(){return 0===this._materialRenderers.size};b.prototype.modify=function(a,c,g,d,b,e){var f=this;void 0===c&&(c=a?a.length:0);void 0===d&&(d=g?g.length:0);void 0===e&&(e=b?b.length:0);this._isRendering&&console.warn("Renderer.modify called while rendering");for(var k=0;k<d;++k)this._content.delete(g[k].uniqueName);
for(k=0;k<c;++k)this._content.set(a[k].uniqueName,a[k]);if(c||d||e){var x=!1;K.splitRenderGeometryChangeSetByMaterial({toAdd:a,numToAdd:c,toRemove:g,numToRemove:d,toUpdate:b,numToUpdate:e}).forEach(function(a,c){var d=f._materialRenderers.get(c);!d&&0<a.toAdd.length&&(d=c.createRenderer(f._rctx,f._materialRep),f._materialRenderers.set(c,d));d&&(d.modify(a),d.isEmpty&&(x=!0))});x&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(f._materialRenderers.delete(c),a.dispose())});this._hasHighlights=
t.someMap(this._materialRenderers,function(a){return a.hasHighlights});this._hasOccludees=t.someMap(this._materialRenderers,function(a){return a.hasOccludees});this.requestRender()}};b.prototype.updateLogic=function(a){var c=!1;this._materialRenderers.forEach(function(g){g.updateLogic&&(c=g.updateLogic(a)||c)});return c};b.prototype.render=function(a){this.renderScene(a);if(this.onPostRender)this.onPostRender()};b.prototype.renderScene=function(a){var c=this;this._isRendering=!0;var g=this._rctx,
d=this._offscreenRendering,b=a.camera,e=a.fbo,h=this._sliceHelper.plane;a.disableSlice&&(this._sliceHelper.plane=null);this._renderPlugins.prepareRender(b);this.renderShadowMap(a);d.enabled=!0;d.initializeFrame(b);this.renderLinearDepth(b);this.renderNormal(b);this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(b,d.linearDepthTexture,d.normalTexture);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._stats.reset();this.updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=
0;this._renderContext.camera=b;this._renderContext.hasOccludees=this._hasOccludees;d.bindFramebuffer();this._renderPlugins.render(0,this._renderContext);this.renderOpaqueGeometry(this._renderContext);this.renderEdges(2);this.renderHiddenTransparentEdges();this.renderTransparentGeometry(this._renderContext);this.renderEdges(1);var k=a=!1;a=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(20,this._renderContext);(k=this.renderTransparentTerrain(this._renderContext))&&a&&(d.compositeTransparentTerrainOntoHUDVisibility(),
d.renderToTargets(function(){return c.renderHUD(p.HUD.TransparentRenderStyle.OCCLUDED)},d.mainColor,d.tmpDepth,void 0,!0,!0));k&&d.compositeTransparentTerrainOntoMain();d.renderToTargets(function(){c.renderInternalSlot(8,c._renderContext);c._renderPlugins.render(15,c._renderContext);c._renderPlugins.render(16,c._renderContext)},d.mainColor,d.mainDepth);this._renderPlugins.needsLaserlineWithContrastControl&&d.renderAndComposite(function(){c._renderPlugins.render(17,c._renderContext)},2);this.renderOccluded();
this.renderAntiAliasing(e,this._antialiasing);g.bindFramebuffer(e);g.clearSafe(256);this.renderHUD(p.HUD.TransparentRenderStyle.NOTOCCLUDED);this.renderHighlights(b,e);this._sliceHelper.plane=h;this._isRendering=!1};b.prototype.renderEdges=function(a){var c=this,b=this._edgeView;b&&b.shouldRender()&&this._offscreenRendering.renderAndComposite(function(){return b.render(c._bindParameters,a)},1)};b.prototype.renderShadowMap=function(a){var c=this._shadowMap;if(c.enabled){n.ENABLE_PROFILE_DEPTH_RANGE&&
v.begin("depthRange");var b=a.camera,d=a.fbo,f=a.lightDirection,e=this.computeDepthRange(b);n.ENABLE_PROFILE_DEPTH_RANGE&&v.end("depthRange");c.prepare(b,f,e);f=c.getCascades();for(e=0;e<f.length;++e){var h=f[e];h.camera.setGLViewport(this._rctx);this.renderGeometryPass(3,h.camera)}a.camera=b;c.finish(d);b.setGLViewport(this._rctx)}c.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderLinearDepth=function(a){var c=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth?
this._offscreenRendering.renderToTargets(function(){return c.renderGeometryPass(1,a)},this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};b.prototype.renderNormal=function(a){var c=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(function(){c.renderGeometryPass(2,a)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};
b.prototype.computeDepthRange=function(a){var c=E.depthRangeFromScene(a,this._content,this._stage.getLayers());D.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a,c){this.updateGlobalUniforms(c.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=c;this.renderOpaqueGeometry(this._renderContext);this.renderTransparentGeometry(this._renderContext);this.renderTransparentTerrain(this._renderContext)};
b.prototype.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this._renderPlugins.render(2,a);this.renderInternalSlot(3,a);this._renderPlugins.render(4,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._renderPlugins.render(14,this._renderContext)};b.prototype.renderTransparentGeometry=function(a){this.renderInternalSlot(5,a);this._renderPlugins.render(6,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderTransparentTerrain=
function(a){return this._renderPlugins.render(7,a)};b.prototype.renderHUDVisibility=function(a){var c=this,b=T.shouldRenderVisibilityDuringRenderPass(a.pass),d=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.enabled,f=!1;b&&d&&a.offscreenRenderingHelper.renderHUDVisibility(function(){f=c.renderInternalSlot(12,a)});return f};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(21,this._renderContext);this.renderInternalSlot(18,this._renderContext);
this.renderInternalSlot(19,this._renderContext)};b.prototype.renderHighlights=function(a,c){var b=this,d=this._highlightHelper;if(d&&d.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)){var f=null;d.profilingCallback&&(f=V.startMeasurement(this._renderContext.rctx));var e=this._offscreenRendering;this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;e=e.renderToTargets(function(){b.renderGeometryPass(4,a);b._rctx.clearSafe(256);b.renderHUD(p.HUD.TransparentRenderStyle.BOTH)},
e.highlight,e.tmpDepth,[0,0,0,0],!0,!0);d.render(a,e,c);null!==f&&d.profilingCallback&&f.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};b.prototype.renderOccluded=function(){var a=this,c=0;this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&8===b.renderOccluded&&(c|=b.renderOccluded,l.push(b))});var b=this._offscreenRendering,d=this._renderContext,f=function(a,d,e,g,f){void 0===e&&(e=function(){return h(d)});
void 0===g&&(g=!0);void 0===f&&(f=!0);0!==(c&d)&&(b.renderToTargets(e,b.tmpColor,b.mainDepth,[0,0,0,0],g,f),b.compositeOccludedOntoMain(a))};0!==l.length&&(this.renderInternalSlot(10,d,l),f(.2,8,function(){return a.renderInternalSlot(11,d,l)},!1,!1),l.length=0);this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&(4===b.renderOccluded||2===b.renderOccluded||32===b.renderOccluded||16===b.renderOccluded)&&(c|=b.renderOccluded,m.push(b))});var e=this._renderPlugins.renderOccludedFlags;if(c|=
e){var h=function(c){d.renderOccludedMask=c;1<e&&a._renderPlugins.render(9,d);a.renderInternalSlot(3,d,m);a.renderInternalSlot(5,d,m);a.renderInternalSlot(8,d,m);d.resetRenderOccludedMask()};d.pass=0;f(.5,4,function(){return h(4)},!0,2);f(.5,2,function(){return h(2)},!0,2);f(1,48,function(){h(16);h(32)},!0,2);m.length=0}};b.prototype.renderAntiAliasing=function(a,c){var b=this;switch(c){case 1:this._smaaPass.loadResources(function(){return b.requestRender()});this._smaaPass.enable()?(this._fxaaPass.disable(),
this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):(this._rctx.bindFramebuffer(a),this._offscreenRendering.composite());break;case 2:this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):(this._rctx.bindFramebuffer(a),this._offscreenRendering.composite());break;default:this._rctx.bindFramebuffer(a),this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}};b.prototype.renderInternalSlot=
function(a,c,b){this._bindParameters.slot=a;this._bindParameters.view=c.camera.viewMatrix;this._bindParameters.proj=c.camera.projectionMatrix;this._bindParameters.viewInvTransp=c.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=c.camera.aboveGround;this._bindParameters.fovY=c.camera.fovY;q[0]=c.camera.near;q[1]=c.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=q;this._bindParameters.viewport=c.camera.fullViewport;this._bindParameters.shadowMap=
c.shadowMap;this._bindParameters.shadowMappingEnabled=!!c.shadowMap&&c.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!c.ssaoHelper&&c.ssaoHelper.enabled;this._bindParameters.pixelRatio=c.camera.pixelRatio;this._bindParameters.slicePlane=c.sliceHelper&&c.sliceHelper.plane;this._bindParameters.hasOccludees=c.hasOccludees;this._bindParameters.hudVisibilityTexture=d?d.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=d&&d.depthTexture||this.getFallbackDepthTexture();return this.renderInternalSlotMaterials(a,
c,b)};b.prototype.renderInternalSlotMaterials=function(a,c,b){var d=this,f=0===c.pass?this._stats:null,e=!1;u.isSome(b)?b.forEach(function(b){w.materialPredicate(b,c)&&(b=d._materialRenderers.get(b),u.isSome(b)&&(e=b.render(a,c,d._bindParameters)||e))}):this._materialRenderers.forEach(function(b,g){w.materialPredicate(g,c)&&(g=f?f.getMaterialRenderStatsObject(b.type):null,e=b.render(a,c,d._bindParameters,g)||e)});return e};b.prototype.updateGlobalUniforms=function(a){for(var b=this._shaderTechniqueRepository.getProgramsUsingUniform("proj"),
g=0;g<b.length;g++)b[g].setUniformMatrix4fv("proj",a);if(this._lighting)for(b=this._shaderTechniqueRepository.getProgramsUsingUniform("lightingMainDirection"),g=0;g<b.length;g++)this._lighting.setUniforms(b[g])};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=G.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?this._offscreenRendering.getGpuMemoryUsage():
0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};Object.defineProperty(b.prototype,"test",{get:function(){return{antialiasing:this._antialiasing}},enumerable:!0,configurable:!0});return b}();var q=B.vec2f64.create(),m=[],l=[];return r});