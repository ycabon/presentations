// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/mathUtils ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f64 ./Camera ./DefaultTextureUnits ./glUtil3D ./Util ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(U,R,S,la,G,w,c,b,N,C,V,W,ma,na,oa,n,pa,qa,ra){function r(a,D){c.vec2.set(X,a[D],a[D+3]);return X}var sa=function(){return function(){this.camera=new ma.default;this.lightMat=w.mat4f64.create()}}();U=function(){function b(a){this.doShadowMapMipmapsWork=!1;this.textureRes=4096;this.numCascades=1;this.maxNumCascades=2;this.splitSchemeLambda=.1;this.warp=!0;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.rctx=a;this.emptyTexture=oa.createEmptyTexture(a);for(a=0;4>a;++a)this.cascades.push(new sa)}
b.prototype.dispose=function(){this.emptyTexture.dispose();this.emptyTexture=null};Object.defineProperty(b.prototype,"textureResolution",{get:function(){return this.textureRes},set:function(a){this.textureRes=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxCascades",{get:function(){return this.maxNumCascades},set:function(a){this.maxNumCascades=S.clamp(Math.floor(a),1,4)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){return!!this.depthTexture},
set:function(a){a?this.enable():this.disable()},enumerable:!0,configurable:!0});b.prototype.getDepthTexture=function(){return this.depthTexture};b.prototype.getCascades=function(){for(var a=0;a<this.numCascades;++a)T[a]=this.cascades[a];T.length=this.numCascades;return T};b.prototype.prepare=function(b,x,t){n.assert(this.enabled);G.mat4.multiply(Y,b.projectionMatrix,b.viewMatrix);var d=t.near;t=t.far;2>d&&(d=2);2>t&&(t=2);d>=t&&(d=2,t=4);this.numCascades=Math.min(1+Math.floor(n.logWithBase(t/d,4)),
this.maxNumCascades);for(var D=(t-d)/this.numCascades,l=Math.pow(t/d,1/this.numCascades),g=d,y=0;y<this.numCascades+1;++y)this.cascadeDistances[y]=S.lerp(g,d,this.splitSchemeLambda),g*=l,d+=D;G.mat4.invert(Z,Y);G.mat4.lookAt(aa,[0,0,0],[-x[0],-x[1],-x[2]],b.up);D=b.viewMatrix;b=b.projectionMatrix;for(y=0;y<this.numCascades;++y){l=this.cascades[y];d=-this.cascadeDistances[y];g=-this.cascadeDistances[y+1];d=(b[10]*d+b[14])/Math.abs(b[11]*d+b[15]);g=(b[10]*g+b[14])/Math.abs(b[11]*g+b[15]);n.assert(d<
g);for(var e=0;8>e;++e){V.vec4.set(ba,0===e%4||3===e%4?-1:1,0===e%4||1===e%4?-1:1,4>e?d:g,1);V.vec4.transformMat4(p[e],ba,Z);for(var h=0;3>h;++h)p[e][h]/=p[e][3]}N.vec3.negate(ca,p[0]);G.mat4.translate(da,aa,ca);l.camera.viewMatrix=da;for(e=0;8>e;++e)N.vec3.transformMat4(p[e],p[e],l.camera.viewMatrix);N.vec3.copy(z,p[0]);N.vec3.copy(A,p[0]);for(e=1;8>e;++e)for(h=0;3>h;++h)z[h]=Math.min(z[h],p[e][h]),A[h]=Math.max(A[h],p[e][h]);z[2]-=200;A[2]+=200;l.camera.near=-A[2];l.camera.far=-z[2];if(this.warp){d=
1/p[0][3];t=1/p[4][3];n.assert(d<t);var e=d+Math.sqrt(d*t),g=Math.sin(S.acosClamped(D[2]*x[0]+D[6]*x[1]+D[10]*x[2])),e=e/g,d=p,w=e,H=g,g=ea,u=fa,k=ta,h=ga,e=ha;c.vec2.set(v,0,0);for(var f=0;4>f;++f)c.vec2.add(v,v,d[f]);c.vec2.scale(v,v,.25);c.vec2.set(J,0,0);for(f=4;8>f;++f)c.vec2.add(J,J,d[f]);c.vec2.scale(J,J,.25);c.vec2.lerp(I[0],d[4],d[5],.5);c.vec2.lerp(I[1],d[5],d[6],.5);c.vec2.lerp(I[2],d[6],d[7],.5);c.vec2.lerp(I[3],d[7],d[4],.5);for(var E=0,B=c.vec2.squaredDistance(I[0],v),f=1;4>f;++f){var K=
c.vec2.squaredDistance(I[f],v);K<B&&(B=K,E=f)}c.vec2.subtract(m,I[E],d[E+4]);f=m[0];m[0]=-m[1];m[1]=f;c.vec2.subtract(ia,J,v);c.vec2.lerp(m,m,ia,H);c.vec2.normalize(m,m);E=H=void 0;H=E=c.vec2.dot(c.vec2.subtract(F,d[0],v),m);for(f=1;8>f;++f)B=c.vec2.dot(c.vec2.subtract(F,d[f],v),m),B<H?H=B:B>E&&(E=B);c.vec2.copy(g,v);c.vec2.scale(F,m,H-w);c.vec2.add(g,g,F);for(var K=-1,C=1,f=w=B=0;8>f;++f){c.vec2.subtract(O,d[f],g);c.vec2.normalize(O,O);var P=m[0]*O[1]-m[1]*O[0];0<P?P>K&&(K=P,B=f):P<C&&(C=P,w=f)}n.verify(0<
K,"leftArea");n.verify(0>C,"rightArea");c.vec2.scale(L,m,H);c.vec2.add(L,L,v);c.vec2.scale(M,m,E);c.vec2.add(M,M,v);Q[0]=-m[1];Q[1]=m[0];u=n.rayRay2D(g,d[w],M,c.vec2.add(F,M,Q),1,u);k=n.rayRay2D(g,d[B],M,F,1,k);h=n.rayRay2D(g,d[B],L,c.vec2.add(F,L,Q),1,h);d=n.rayRay2D(g,d[w],L,F,1,e);n.verify(u,"rayRay");n.verify(k,"rayRay");n.verify(h,"rayRay");n.verify(d,"rayRay");k=ea;d=fa;g=ga;h=ha;e=l.camera.projectionMatrix;c.vec2.subtract(q,g,h);c.vec2.scale(q,q,.5);a[0]=q[0];a[1]=q[1];a[2]=0;a[3]=q[1];a[4]=
-q[0];a[5]=0;a[6]=q[0]*q[0]+q[1]*q[1];a[7]=q[0]*q[1]-q[1]*q[0];a[8]=1;a[6]=-c.vec2.dot(r(a,0),k);a[7]=-c.vec2.dot(r(a,1),k);k=c.vec2.dot(r(a,0),g)+a[6];u=c.vec2.dot(r(a,1),g)+a[7];f=c.vec2.dot(r(a,0),h)+a[6];h=c.vec2.dot(r(a,1),h)+a[7];k=-(k+f)/(u+h);a[0]+=a[1]*k;a[3]+=a[4]*k;a[6]+=a[7]*k;k=1/(c.vec2.dot(r(a,0),g)+a[6]);u=1/(c.vec2.dot(r(a,1),g)+a[7]);a[0]*=k;a[3]*=k;a[6]*=k;a[1]*=u;a[4]*=u;a[7]*=u;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;k=c.vec2.dot(r(a,1),d)+a[7];u=c.vec2.dot(r(a,2),d)+a[8];f=c.vec2.dot(r(a,
1),g)+a[7];h=c.vec2.dot(r(a,2),g)+a[8];k=-.5*(k/u+f/h);a[1]+=a[2]*k;a[4]+=a[5]*k;a[7]+=a[8]*k;k=c.vec2.dot(r(a,1),d)+a[7];u=c.vec2.dot(r(a,2),d)+a[8];f=-u/k;a[1]*=f;a[4]*=f;a[7]*=f;e[0]=a[0];e[1]=a[1];e[2]=0;e[3]=a[2];e[4]=a[3];e[5]=a[4];e[6]=0;e[7]=a[5];e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a[6];e[13]=a[7];e[14]=0;e[15]=a[8];l.camera.projectionMatrix[10]=2/(z[2]-A[2]);l.camera.projectionMatrix[14]=-(z[2]+A[2])/(z[2]-A[2])}else G.mat4.ortho(l.camera.projectionMatrix,z[0],A[0],z[1],A[1],l.camera.near,
l.camera.far);G.mat4.multiply(l.lightMat,l.camera.projectionMatrix,l.camera.viewMatrix);d=this.textureRes/2;l.camera.viewport[0]=0===y%2?0:d;l.camera.viewport[1]=0===Math.floor(y/2)?0:d;l.camera.viewport[2]=d;l.camera.viewport[3]=d}this.lastOrigin=null;this.cascadeDistances[this.numCascades]=100*t;x=this.rctx;x.bindFramebuffer(this.fbo);x.bindTexture(null,7);x.setClearColor(1,1,1,1);x.clearSafe(16640)};b.prototype.finish=function(a){n.assert(this.enabled);this.rctx.bindFramebuffer(a);this.doShadowMapMipmapsWork&&
this.depthTexture.generateMipmap()};b.prototype.bind=function(a,b){var c=this.rctx,d=this.enabled;c.bindTexture(d?this.depthTexture:this.emptyTexture,b);c.bindProgram(a);a.setUniform1i("depthTex",b);a.setUniform1f("depthHalfPixelSz",d?.5/this.textureRes:-1);a.setUniform1i("shadowMapNum",this.numCascades);a.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])};b.prototype.bindToAllPrograms=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");
for(var b=0;b<a.length;b++)this.bind(a[b],na.DefaultTextureUnits.SHADOW_MAP)};b.prototype.bindView=function(a,b){if(this.enabled){var c=this.lastOrigin;if(!c||c[0]!==b[0]||c[1]!==b[1]||c[2]!==b[2])for(this.lastOrigin=this.lastOrigin||C.vec3f64.create(),N.vec3.copy(this.lastOrigin,b),c=0;c<this.numCascades;++c){G.mat4.translate(ja,this.cascades[c].lightMat,b);for(var d=0;16>d;++d)ka[16*c+d]=ja[d]}a.setUniformMatrix4fv("shadowMapMatrix",ka)}};b.prototype.enable=function(){this.enabled||(this.depthTexture=
new qa(this.rctx,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,width:this.textureRes,height:this.textureRes}),this.fbo=new pa(this.rctx,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes},this.depthTexture))};b.prototype.disable=function(){this.enabled&&this.fbo&&(this.fbo.dispose(),this.depthTexture=this.fbo=null)};b.prototype.getGpuMemoryUsage=function(){return ra.getGpuMemoryUsage(this.fbo)};return b}();var da=w.mat4f64.create(),
Y=w.mat4f64.create(),Z=w.mat4f64.create(),ba=W.vec4f64.create(),p=[];for(R=0;8>R;++R)p.push(W.vec4f64.create());var z=C.vec3f64.create(),A=C.vec3f64.create(),ea=b.vec2f64.create(),fa=b.vec2f64.create(),ta=b.vec2f64.create(),ga=b.vec2f64.create(),ha=b.vec2f64.create(),aa=w.mat4f64.create(),ca=C.vec3f64.create(),T=[],ja=w.mat4f64.create(),ka=new Float32Array(64),v=b.vec2f64.create(),J=b.vec2f64.create(),I=[b.vec2f64.create(),b.vec2f64.create(),b.vec2f64.create(),b.vec2f64.create()],m=b.vec2f64.create(),
ia=b.vec2f64.create(),F=b.vec2f64.create(),O=b.vec2f64.create(),L=b.vec2f64.create(),M=b.vec2f64.create(),Q=b.vec2f64.create(),X=b.vec2f64.create(),q=b.vec2f64.create(),a=la.mat3f64.create();return U});