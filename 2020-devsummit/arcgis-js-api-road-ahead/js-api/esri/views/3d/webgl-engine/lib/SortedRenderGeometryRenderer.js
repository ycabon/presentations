// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/MapUtils ../../../../core/PooledArray ./Material ./rendererUtils".split(" "),function(l,m,h,g,n,p){Object.defineProperty(m,"__esModule",{value:!0});var q=function(){return function(){}}();l=function(){function b(c,d,a){this._rctx=c;this._materialRep=d;this.emitUpdatingChanged=a;this._pendingAddsRemoves=new Map;this._adds=new g;this._removes=new g;this._updates=new g({allocator:function(a){return a||new q},deallocator:function(a){a.renderGeometry=null;return a}});
this._materialRenderers=new Map;this._sortedMaterialRenderers=new g;this._hasWater=this._hasHighlights=!1}b.prototype.dispose=function(){this._adds.prune();this._removes.prune();this._updates.prune()};Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._pendingAddsRemoves.size||0<this._updates.length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"hasWater",{get:function(){return this._hasWater},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"rendersOccluded",{get:function(){return h.someMap(this._materialRenderers,function(c){return c.rendersOccluded})},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isEmpty",{get:function(){return!this.updating&&0===this._materialRenderers.size},enumerable:!0,configurable:!0});b.prototype.commitChanges=function(){var c=this,d=!1;if(!this.updating)return!1;this.updateAddsRemoves();
var a=!1,e=!1;p.splitRenderGeometryChangeSetByMaterial({numToAdd:this._adds.length,toAdd:this._adds.data,numToRemove:this._removes.length,toRemove:this._removes.data,numToUpdate:this._updates.length,toUpdate:this._updates.data}).forEach(function(b,k){var f=c._materialRenderers.get(k);!f&&0<b.toAdd.length&&(f=k.createRenderer(c._rctx,c._materialRep),c._materialRenderers.set(k,f),e=a=d=!0);if(f){var g=a||f.hasHighlights,h=e||f.hasWater;f.modify(b);a=a||g!==f.hasHighlights;e=e||h!==f.hasWater;f.isEmpty&&
(c._materialRenderers.delete(k),f.dispose(),d=!0)}});this._adds.clear();this._removes.clear();this._updates.clear();this._pendingAddsRemoves.clear();d&&this.updateSortedMaterialRenderers();a&&(this._hasHighlights=h.someMap(this._materialRenderers,function(a){return a.hasHighlights}));e&&(this._hasWater=h.someMap(this._materialRenderers,function(a){return a.hasWater}));this.emitUpdatingChanged();return!0};b.prototype.add=function(c){for(var d=0===this._pendingAddsRemoves.size,a=0;a<c.length;a++)this._pendingAddsRemoves.set(c[a],
0);d&&0<this._pendingAddsRemoves.size&&this.emitUpdatingChanged()};b.prototype.remove=function(c){for(var d=0===this._pendingAddsRemoves.size,a=0;a<c.length;a++){var e=c[a],f=this._pendingAddsRemoves.get(e);0===f?this._pendingAddsRemoves.set(e,2):2!==f&&this._pendingAddsRemoves.set(e,1)}d&&0<this._pendingAddsRemoves.size&&this.emitUpdatingChanged()};b.prototype.modify=function(c,d){for(var a=0===this._updates.length,e=0;e<c.length;e++){var f=c[e],b=this._updates.pushNew();b.renderGeometry=f;b.updateType=
d}a&&0<this._updates.length&&this.emitUpdatingChanged()};b.prototype.updateLogic=function(c){for(var d=!1,a=0;a<this._sortedMaterialRenderers.length;a++){var e=this._sortedMaterialRenderers.data[a].materialRenderer;e.updateLogic&&e.updateLogic(c)&&(d=!0)}return d};b.prototype.draw=function(c,d,a){for(var e=0;e<this._sortedMaterialRenderers.length;e++){var b=this._sortedMaterialRenderers.data[e];if(n.materialPredicate(b.material,c)){var g=a.getMaterialRenderStatsObject(b.materialRenderer.type);b.materialRenderer.render(null,
c,d,g)}}};b.prototype.updateSortedMaterialRenderers=function(){var c=this;this._sortedMaterialRenderers.clear();this._materialRenderers.forEach(function(b,a){c._sortedMaterialRenderers.push({material:a,materialRenderer:b})});this._sortedMaterialRenderers.sort(function(b,a){return a.material.renderPriority-b.material.renderPriority})};b.prototype.updateAddsRemoves=function(){var b=this;this._adds.clear();this._removes.clear();this._pendingAddsRemoves.forEach(function(a,c){switch(a){case 0:b._adds.push(c);
break;case 1:b._removes.push(c)}});for(var d=0;d<this._updates.length;)this._pendingAddsRemoves.has(this._updates.data[d].renderGeometry)?this._updates.removeUnorderedIndex(d):d++};Object.defineProperty(b.prototype,"test",{get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}},enumerable:!0,configurable:!0});return b}();m.SortedRenderGeometryRenderer=l});