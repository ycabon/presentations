// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/Evented ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f64 ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../support/mathUtils ../../../support/buffer/BufferView ../../../support/buffer/InterleavedLayout ../Util".split(" "),function(p,l,v,w,m,x,
y,q,z,A,B,e,C,r){Object.defineProperty(l,"__esModule",{value:!0});var f;(function(d){d[d.ALLOCATED=1]="ALLOCATED";d[d.ACTIVE=2]="ACTIVE";d[d.VISIBLE=4]="VISIBLE";d[d.HIGHLIGHT=8]="HIGHLIGHT";d[d.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE";d[d.REMOVE=32]="REMOVE";d[d.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED"})(f=l.StateFlags||(l.StateFlags={}));var t=function(){return function(d){this.localTransform=d.getField("localTransform",e.BufferViewMat4f64);this.globalTransform=d.getField("globalTransform",e.BufferViewMat4f64);
this.modelOrigin=d.getField("modelOrigin",e.BufferViewVec3f64);this.model=d.getField("model",e.BufferViewMat3f);this.modelNormal=d.getField("modelNormal",e.BufferViewMat3f);this.modelScaleFactors=d.getField("modelScaleFactors",e.BufferViewVec2f);this.boundingSphere=d.getField("boundingSphere",e.BufferViewVec4f64);this.color=d.getField("color",e.BufferViewVec4f);this.featureAttribute=d.getField("featureAttribute",e.BufferViewVec4f);this.state=d.getField("state",e.BufferViewUint8);this.lodLevel=d.getField("lodLevel",
e.BufferViewUint8)}}();l.View=t;p=function(d){function c(a,b){var c=d.call(this)||this;c._capacity=0;c._size=0;c._next=0;var k=C.newLayout().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");0<=a.indexOf("color")&&(k=k.vec4f("color"));0<=a.indexOf("featureAttribute")&&(k=k.vec4f("featureAttribute"));k=k.u8("state").u8("lodLevel").alignTo(8);c._layout=k;c._shaderTransformation=b;return c}
v(c,d);Object.defineProperty(c.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"buffer",{get:function(){return this._buffer.buffer},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!0});c.prototype.addInstance=function(){this._size+
1>this._capacity&&this.grow();var a=this.findSlot();this._view.state.set(a,f.ALLOCATED);this._size++;this.emit("instance-added",{index:a});return a};c.prototype.removeInstance=function(a){var b=this._view.state;r.assert(0<=a&&a<this._capacity&&b.get(a)&f.ALLOCATED,"invalid instance handle");this.getStateFlag(a,f.ACTIVE)?this.setStateFlags(a,f.REMOVE):this.freeInstance(a);this.emit("instance-removed",{index:a})};c.prototype.freeInstance=function(a){var b=this._view.state;r.assert(0<=a&&a<this._capacity&&
b.get(a)&f.ALLOCATED,"invalid instance handle");b.set(a,0);this._size--};c.prototype.setLocalTransform=function(a,b,c){void 0===c&&(c=!0);this._view.localTransform.setMat(a,b);c&&this.updateModelTransform(a)};c.prototype.getLocalTransform=function(a,b){this._view.localTransform.getMat(a,b)};c.prototype.setGlobalTransform=function(a,b,c){void 0===c&&(c=!0);this._view.globalTransform.setMat(a,b);c&&this.updateModelTransform(a)};c.prototype.getGlobalTransform=function(a,b){this._view.globalTransform.getMat(a,
b)};c.prototype.updateModelTransform=function(a){var b=this._view,c=h,d=g;b.localTransform.getMat(a,u);b.globalTransform.getMat(a,n);var e=y.mat4.multiply(n,n,u);z.vec3.set(c,e[12],e[13],e[14]);b.modelOrigin.setVec(a,c);m.mat3.fromMat4(d,e);b.model.setMat(a,d);c=B.scaleFromMatrix(h,e);c.sort();b.modelScaleFactors.set(a,0,c[1]);b.modelScaleFactors.set(a,1,c[2]);m.mat3.invert(d,d);m.mat3.transpose(d,d);b.modelNormal.setMat(a,d);this.setStateFlags(a,f.TRANSFORM_CHANGED);this.emit("instance-transform-changed",
{index:a})};c.prototype.getModelTransform=function(a,b){var c=this._view;c.model.getMat(a,g);c.modelOrigin.getVec(a,h);b[0]=g[0];b[1]=g[1];b[2]=g[2];b[3]=0;b[4]=g[3];b[5]=g[4];b[6]=g[5];b[7]=0;b[8]=g[6];b[9]=g[7];b[10]=g[8];b[11]=0;b[12]=h[0];b[13]=h[1];b[14]=h[2];b[15]=1};c.prototype.applyShaderTransformation=function(a,b){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,a,b)};c.prototype.getCombinedModelTransform=function(a,b){this.getModelTransform(a,b);this._shaderTransformation&&
this._shaderTransformation.applyTransform(this,a,b);return b};c.prototype.getCombinedLocalTransform=function(a,b){this._view.localTransform.getMat(a,b);this._shaderTransformation&&this._shaderTransformation.applyTransform(this,a,b);return b};c.prototype.getCombinedMaxScaleFactor=function(a){var b=this._view.modelScaleFactors.get(a,1);this._shaderTransformation&&(a=this._shaderTransformation.scaleFactor(h,this,a),b*=Math.max(a[0],a[1],a[2]));return b};c.prototype.getCombinedMedianScaleFactor=function(a){var b=
this._view.modelScaleFactors.get(a,0);this._shaderTransformation&&(a=this._shaderTransformation.scaleFactor(h,this,a),a.sort(),b*=a[1]);return b};c.prototype.getModel=function(a,b){this._view.model.getMat(a,b)};c.prototype.setFeatureAttribute=function(a,b){this._view.featureAttribute.setVec(a,b)};c.prototype.getFeatureAttribute=function(a,b){this._view.featureAttribute.getVec(a,b)};c.prototype.setColor=function(a,b){this._view.color.setVec(a,b)};c.prototype.getColor=function(a,b){this._view.color.getVec(a,
b)};c.prototype.setVisible=function(a,b){b!==this.getVisible(a)&&(this.setStateFlag(a,f.VISIBLE,b),this.emit("instance-visibility-changed",{index:a}))};c.prototype.getVisible=function(a){return this.getStateFlag(a,f.VISIBLE)};c.prototype.setHighlight=function(a,b){b!==this.getHighlight(a)&&(this.setStateFlag(a,f.HIGHLIGHT,b),this.emit("instance-highlight-changed",{index:a}))};c.prototype.getHighlight=function(a){return this.getStateFlag(a,f.HIGHLIGHT)};c.prototype.getState=function(a){return this._view.state.get(a)};
c.prototype.getLodLevel=function(a){return this._view.lodLevel.get(a)};c.prototype.countFlags=function(a){for(var b=0,c=0;c<this._capacity;++c)this.getState(c)&a&&++b;return b};c.prototype.setStateFlags=function(a,b){var c=this._view.state;b|=c.get(a);c.set(a,b)};c.prototype.clearStateFlags=function(a,b){var c=this._view.state;b=c.get(a)&~b;c.set(a,b)};c.prototype.setStateFlag=function(a,b,c){c?this.setStateFlags(a,b):this.clearStateFlags(a,b)};c.prototype.getStateFlag=function(a,b){return!!(this._view.state.get(a)&
b)};c.prototype.grow=function(){var a=Math.max(D,Math.floor(this._capacity*E)),b=this._layout.createBuffer(a);if(this._buffer){var c=new Uint8Array(this._buffer.buffer);(new Uint8Array(b.buffer)).set(c)}this._capacity=a;this._buffer=b;this._view=new t(this._buffer)};c.prototype.findSlot=function(){for(var a=this._view.state,b=this._next;a.get(b)&f.ALLOCATED;)b=(b+1)%this._capacity;this._next=(b+1)%this._capacity;return b};return c}(w);l.InstanceData=p;var D=1024,E=2,h=A.vec3f64.create(),g=x.mat3f64.create(),
u=q.mat4f64.create(),n=q.mat4f64.create()});