// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/extendsHelper ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../support/debugFlags ../../../support/buffer/glUtil ../../core/shaderLibrary/output/OutputHighlight.glsl ../Camera ../DefaultVertexAttributeLocations ../intersectorUtils ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(z,q,Y,N,t,u,O,v,A,B,P,Q,x,R,w,g,S,T,C,U,V,y,W,D,X){function E(b,a,c,e){y.encodeDoubleVec3(b.modelOrigin,a,c.modelOriginHi,c.modelOriginLo,e);c.model.copyFrom(e,b.model,a);c.modelNormal.copyFrom(e,b.modelNormal,a);b.color&&c.color&&c.color.copyFrom(e,b.color,a);b.featureAttribute&&c.featureAttribute&&c.featureAttribute.copyFrom(e,b.featureAttribute,a)}Object.defineProperty(q,"__esModule",{value:!0});var F=function(b){var a=b.baseBoundingSphere.radius;b=b.levels.map(function(a){return a.minScreenSpaceRadius});
return new T.LevelSelector(a,b)};q.setLevelSelectorFactory=function(b){F=b};var G=function(){function b(a,c){var e=a.rctx,b=c.geometry;c=c.material;var d=b.data.toRenderData();this.materialRep=a.materialRep;c.setParameterValues({instancedDoublePrecision:!0});a=c.createBufferWriter();var k=a.vertexBufferLayout,f=a.elementCount(d),r=a.allocate(f);a.write({},d,r,0);this.geometry=b;this.material=c;this.glMaterials=y.acquireMaterials(c,this.materialRep);this.vertexBufferLayout=k;this.vbo=W.createVertex(e,
35044,r.buffer);this.vao=new X(e,x.Default3D,{geometry:B.glLayout(k)},{geometry:this.vbo});this.vertexCount=f}b.prototype.destroy=function(){y.releaseMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(b.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!0,configurable:!0});b.prototype.intersect=
function(a,c,e,b,d,k){var f=this.geometry.id,h=d.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,e,b,function(b,e,r,g){if(0<=b&&(null==c||c(a.rayBeginPoint,a.rayEndPoint,b))){var l={type:"external",metadata:{layerUid:k.layerUid,graphicUid:k.graphicUid(d)}};if(null==a.results.min.drapedLayerOrder||g>=a.results.min.drapedLayerOrder)if(null==a.results.min.dist||b<a.results.min.dist)a.results.min.set(l,h,b,e,a.transform.transform,g,null,f,r),a.results.min.intersector="LodRenderer";
0!==a.options.store&&(null==a.results.max.drapedLayerOrder||g>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||b>a.results.max.dist)&&(a.results.max.set(l,h,b,e,a.transform.transform,g,null,f,r),a.results.min.intersector="LodRenderer");if(2===a.options.store){var p=new R.IntersectorResult(a.results.min.ray);p.set(l,h,b,e,a.transform.transform,g,null,f,r);p.intersector="LodRenderer";a.results.all.push(p)}}})};return b}();q.LodComponentData=G;var H=function(){function b(a,c){var b=this;
this.components=[];this.minScreenSpaceRadius=c.minScreenSpaceRadius;c.components.forEach(function(c){b.components.push(new G(a,c))})}b.prototype.destroy=function(){this.components.forEach(function(a){a.destroy()})};b.prototype.intersect=function(a,c,b,h,d,k){this.components.forEach(function(e){e.intersect(a,c,b,h,d,k)})};Object.defineProperty(b.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=v.empty();this.components.forEach(function(c){v.expand(a,c.boundingInfo.bbMin);v.expand(a,
c.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var a=this.boundingBox,c=u.vec3f64.create();v.center(a,c);this._boundingSphere={center:c,radius:.5*v.diameter(a)}}return this._boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",{get:function(){return this.components.reduce(function(a,c){return a+c.triangleCount},
0)},enumerable:!0,configurable:!0});return b}();q.LodLevelData=H;z=function(){function b(a,c,b,h){var d=this;this.type="Lod";this.isGround=!1;this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new Q.default;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.canRender=!0;this._symbol=a;this._optionalFields=c;this._metadata=b;this._instanceBufferLayout=U.getInstanceBufferLayout({instancedDoublePrecision:!0,
instanced:c});this._glInstanceBufferLayout=B.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new g.InstanceData(this._optionalFields,h);this._instanceData.on("instance-added",function(){d.requestUpdateCycle()});this._instanceData.on("instance-removed",function(){d.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",function(a){d.requestUpdateCycle();d._metadata.notifyGraphicUpdate(a.index,2)});this._instanceData.on("instance-visibility-changed",function(a){d.requestUpdateCycle(!0);
d._metadata.notifyGraphicUpdate(a.index,1)});this._instanceData.on("instance-highlight-changed",function(){d.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;q.lodRenderers.push(this)}b.prototype.destroy=function(){q.lodRenderers.splice(q.lodRenderers.indexOf(this),1)};Object.defineProperty(b.prototype,"levels",{get:function(){return this._levels},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-
1].boundingBox},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-1].components[0].material},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"slicePlane",{get:function(){return this._slicePlane},set:function(a){this._slicePlane=a},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return this._metadata.layerUid},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});this._highlightRenderInstanceData.forEach(function(c){c=
c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});return a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"renderStats",{get:function(){var a=this,c=this._instanceData.size,b=[];this._levels.forEach(function(c,d){d=a._renderInstanceData[d].size+a._highlightRenderInstanceData[d].size;c=c.triangleCount;b.push({renderedInstances:d,renderedTriangles:d*c,trianglesPerInstance:c})});return{totalInstances:c,renderedInstances:b.reduce(function(a,c){return a+c.renderedInstances},0),renderedTriangles:b.reduce(function(a,
c){return a+c.renderedTriangles},0),levels:b}},enumerable:!0,configurable:!0});b.prototype.initializeRenderContext=function(a){var c=this;this._initContext=a;var b=a.rctx;this._symbol.levels.forEach(function(e){c._levels.push(new H(a,e));c._renderInstanceData.push(new C.RenderInstanceData(b,c._instanceBufferLayout));c._highlightRenderInstanceData.push(new C.RenderInstanceData(b,c._instanceBufferLayout))});this._levelSelector=F(this)};b.prototype.uninitializeRenderContext=function(){this.invalidateOctree();
this._levels.forEach(function(a){a.destroy()});this._renderInstanceData.forEach(function(a){a.destroy()});this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};Object.defineProperty(b.prototype,"slots",{get:function(){return[4,6]},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,c){return a+c.size},0)},enumerable:!0,configurable:!0});b.prototype.prepareRender=function(a){this.runUpdates(a)};
b.prototype.render=function(a){var c=this,b=a.rctx,h=4===a.slot?3:6===a.slot?5:null;if(h){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var d=a.camera,k={slot:h,view:d.viewMatrix,proj:d.projectionMatrix,origin:[0,0,0],viewInvTransp:d.viewInverseTransposeMatrix,viewport:d.fullViewport,fovY:d.fovY,nearFar:[d.near,d.far],shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,pixelRatio:d.pixelRatio,
slicePlane:a.sliceHelper&&a.sliceHelper.plane,cameraAboveGround:d.aboveGround,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1};b.bindVAO();for(var b=function(b){var d=a.isHighlightPass?f._highlightRenderInstanceData[b]:f._renderInstanceData[b];f._levels[b].components.forEach(function(f){c.renderComponent(a,h,k,d,f,b)})},f=this,d=0;d<this._levels.length;++d)b(d);
return!0}};b.prototype.intersect=function(a,c,b,h){var d=this;if(this.baseMaterial.isVisible()){var e=u.vec3f64.create();t.vec3.subtract(e,h,b);var f=function(f){d._instanceData.getCombinedModelTransform(f,I);a.transform.set(I);t.vec3.transformMat4(J,b,a.transform.inverse);t.vec3.transformMat4(K,h,a.transform.inverse);var e=d._instanceData.getState(f),k=d._instanceData.getLodLevel(f);w.assert(e&g.StateFlags.ACTIVE,"invalid instance state");w.assert(0<=k&&k<d._levels.length,"invaid lod level");d._levels[k].intersect(a,
c,J,K,f,d._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(f):this.octree.forEachAlongRay(b,e,f)}};b.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};b.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()};b.prototype.requestUpdateCycle=function(a){void 0===a&&(a=!1);this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._initContext.requestRender()};Object.defineProperty(b.prototype,
"needsUpdates",{get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera},enumerable:!0,configurable:!0});b.prototype.runUpdates=function(a){if(!A.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var c=a.equals(this._lastCamera);this._lastCamera.copyFrom(a);c||this.requestUpdateCycle()}c=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,c);this.needsUpdates&&this._initContext.requestRender()}};Object.defineProperty(b.prototype,
"octree",{get:function(){this._octree||(this._octree=this.buildOctree());return this._octree},enumerable:!0,configurable:!0});b.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};b.prototype.buildOctree=function(){for(var a=new S.InstanceOctree(this._instanceData,this.baseBoundingSphere),c=this._instanceData,c=c.view?c.view.state:null,b=0;b<this._instanceData.capacity;++b)c.get(b)&g.StateFlags.ACTIVE&&a.addInstance(b);return a};b.prototype.queryDepthRangeOctree=
function(a){var c=a.eye,b=a.viewForward,h=this.octree.findClosest(b,"front-to-back",a.frustum),d=this.octree.findClosest(b,"back-to-front",a.frustum);return null!=h&&null!=d?(this._instanceData.view.boundingSphere.getVec(h,m),t.vec3.subtract(m,m,c),h=t.vec3.dot(m,b)-m[3],this._instanceData.view.boundingSphere.getVec(d,m),t.vec3.subtract(m,m,c),c=t.vec3.dot(m,b)+m[3],{near:Math.max(a.near,h),far:Math.min(a.far,c)}):{near:Infinity,far:-Infinity}};b.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;
this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()});this.needsUpdates&&this._initContext.requestRender()};b.prototype.updateInstances=function(a,b){var c=this._enableLevelSelection,h=this._levelSelector;h.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var d=this._instanceData.view,k=
a.capacity,f=this._instanceIndex;b=Math.min(a.size,b);for(var r=0;r<b;++r){0===f&&this.startUpdateCycle();var p=d.state.get(f),l=0;if(p&g.StateFlags.ALLOCATED){var n=d.lodLevel.get(f);p&g.StateFlags.ACTIVE&&this._renderInstanceData[n].freeTail();p&g.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[n].freeTail();if(p&g.StateFlags.REMOVE)a.freeInstance(f);else if(p&g.StateFlags.VISIBLE){n=0;c&&(d.modelOrigin.getVec(f,L),n=h.selectLevel(L,a.getCombinedMedianScaleFactor(f)));l=p&~(g.StateFlags.ACTIVE|
g.StateFlags.HIGHLIGHT_ACTIVE|g.StateFlags.TRANSFORM_CHANGED);if(0<=n){var m=this._renderInstanceData[n],q=m.allocateHead();E(d,f,m.view,q);l|=g.StateFlags.ACTIVE;p&g.StateFlags.HIGHLIGHT&&(m=this._highlightRenderInstanceData[n],q=m.allocateHead(),E(d,f,m.view,q),l|=g.StateFlags.HIGHLIGHT_ACTIVE)}d.state.set(f,l);d.lodLevel.set(f,n)}else l=p&~(g.StateFlags.ACTIVE|g.StateFlags.HIGHLIGHT_ACTIVE|g.StateFlags.TRANSFORM_CHANGED),d.state.set(f,l);this._octree&&(n=!!(p&g.StateFlags.ACTIVE),l=!!(l&g.StateFlags.ACTIVE),
!n&&l?this._octree.addInstance(f):n&&!l?this._octree.removeInstance(f):n&&l&&p&g.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(f),this._octree.addInstance(f)));f=(f+1)%k}else f=(f+1)%k,b++}this._instanceIndex=f;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};b.prototype.renderComponent=function(a,b,e,h,d,k){var c=d.glMaterials.get(a.pass);if(c&&c.beginSlot(b)&&0!==h.size){var g=a.rctx,m=g.capabilities.instancing;
c.ensureParameters(e);var l=c.getTechnique();b=c.getPipelineState(b);g.setPipelineState(b);c.bind(g,e);g.bindVAO(d.vao);l.ensureAttributeLocations(d.vao);c=l.program;a.isHighlightPass&&P.OutputHighlight.bindOutputHighlight(g,c,e);l.bindDraw(e);A.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(c.setUniform4fv("externalColor",M[Math.min(k,M.length-1)]),c.setUniform1i("colorMixMode",V.colorMixModes.replace));a=h.capacity;e=h.headIndex;k=h.tailIndex;var c=h.firstIndex,n=this._glInstanceBufferLayout;
b=function(a,b){D.bindVertexBufferLayout(g,x.Default3D,h.buffer,n,a);m.drawArraysInstanced(l.primitiveType,0,d.vertexCount,b-a);D.unbindVertexBufferLayout(g,x.Default3D,h.buffer,n)};d.material.getParameters().transparent&&null!=c?e>k?(w.assert(c>=k&&c<=e,"invalid firstIndex"),b(c,e),b(k,c)):e<k&&(c<=e?(w.assert(0<=c&&c<=e,"invalid firstIndex"),b(c,e),b(k,a),b(0,c)):(w.assert(c>=k&&c<=a,"invalid firstIndex"),b(c,a),b(0,e),b(k,c))):e>k?b(k,e):e<k&&(b(0,e),b(k,a));g.bindVAO(null)}};return b}();q.LodRenderer=
z;q.lodRenderers=[];var L=u.vec3f64.create(),m=O.vec4f64.create(),I=N.mat4f64.create(),J=u.vec3f64.create(),K=u.vec3f64.create(),M=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});