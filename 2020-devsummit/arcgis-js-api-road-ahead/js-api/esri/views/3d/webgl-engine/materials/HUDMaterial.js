// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/geometryDataUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/HUDMaterial.glsl ../shaders/HUDMaterialTechnique".split(" "),
function(N,J,y,O,Z,P,aa,ba,Q,ca,R,h,C,da,ea,fa,ga,ha,S,ia,G,c,u,K,ja,T,H){function U(c,b,a,d,f,g,w,e){b=b-f-(0<e[0]?d[0]*e[0]:0);var z=b+d[0]+2*f;a=a-f-(0<e[1]?d[1]*e[1]:0);f=a+d[1]+2*f;w.textureIsSignedDistanceField&&(w=w.distanceFieldBoundingBox,b+=d[0]*w[0],a+=d[1]*w[1],z-=d[0]*(1-w[2]),f-=d[1]*(1-w[3]),b-=g,z+=g,a-=g,f+=g);return c[0]>b&&c[0]<z&&c[1]>a&&c[1]<f}N=function(q){function b(a,b){b=q.call(this,b)||this;b.techniqueConfig=new H.HUDMaterialTechniqueConfiguration;b.params=K.copyParameters(a,
ka);return b}y(b,q);b.prototype.dispose=function(){};b.prototype.setParameterValues=function(a){for(var b in a)"textureId"===b&&c.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[b]=a[b];this.parametersChanged()};b.prototype.getParameters=function(){return this.params};b.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.verticalOffset=
!!this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective;this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0;this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset;this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest;this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField;this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled;this.techniqueConfig.vvColor=!!this.params.vvColorEnabled;
0===a&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder);4===a&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion);this.techniqueConfig.depthEnabled=this.params.depthEnabled;return this.techniqueConfig};b.prototype.intersect=function(a,b,f,g,w,e,c,h,m){m?this.intersectDrapedHudGeometry(a,e,c,h):this.intersectHudGeometry(a,b,f,g,c,h)};b.prototype.intersectDrapedHudGeometry=function(a,b,f,g){var d=a.getAttribute(c.VertexAttrConstants.POSITION),e=
a.getAttribute(c.VertexAttrConstants.SIZE),z=this.params,h=T.calculateAnchorPosForRendering(z),m=1,n=1;g&&(n=g(V),m=n[0],n=n[5]);m*=a.pixelRatio;n*=a.pixelRatio;g=la*a.pixelRatio;for(var k=0;k<d.data.length/d.size;k++){var p=k*d.size,q=d.data[p],p=d.data[p+1],t=k*e.size;A[0]=e.data[t]*m;A[1]=e.data[t+1]*n;t=void 0;z.textureIsSignedDistanceField&&(t=z.outlineSize*a.pixelRatio/2);U(b,q,p,A,g,t,z,h)&&f()}};b.prototype.intersectHudGeometry=function(a,b,f,g,w,e){if(g.options.selectionMode&&g.options.hud&&
!ga.isAllHidden(b.componentVisibilities,a.componentOffsets)){var d=a.data;a=this.params;var q=b=1;P.mat3.fromMat4(I,f);if(e){q=e(V);b=q[0];q=q[5];e=I;var m=e[0],n=e[1],D=e[2],p=e[3],u=e[4],t=e[5],x=e[6],l=e[7],v=e[8],B=1/Math.sqrt(m*m+n*n+D*D),F=1/Math.sqrt(p*p+u*u+t*t),y=1/Math.sqrt(x*x+l*l+v*v);e[0]=m*B;e[1]=n*B;e[2]=D*B;e[3]=p*F;e[4]=u*F;e[5]=t*F;e[6]=x*y;e[7]=l*y;e[8]=v*y}e=d.getVertexAttr()[c.VertexAttrConstants.POSITION];m=d.getVertexAttr()[c.VertexAttrConstants.SIZE];n=d.getVertexAttr()[c.VertexAttrConstants.NORMAL];
d=d.getVertexAttr()[c.VertexAttrConstants.AUXPOS1];c.assert(3<=e.size);D=g.point;p=g.camera;u=T.calculateAnchorPosForRendering(a);b*=p.pixelRatio;q*=p.pixelRatio;t="screen"===this.params.centerOffsetUnits;for(x=0;x<e.data.length/e.size;x++)l=x*e.size,h.vec3.set(k,e.data[l],e.data[l+1],e.data[l+2]),h.vec3.transformMat4(k,k,f),l=x*m.size,A[0]=m.data[l]*b,A[1]=m.data[l+1]*q,h.vec3.transformMat4(k,k,p.viewMatrix),l=x*d.size,h.vec3.set(r,d.data[l+0],d.data[l+1],d.data[l+2]),t||(k[0]+=r[0],k[1]+=r[1],0!==
r[2]&&(l=r[2],h.vec3.normalize(r,k),h.vec3.subtract(k,k,h.vec3.scale(r,r,l)))),l=x*n.size,h.vec3.set(W,n.data[l],n.data[l+1],n.data[l+2]),this.applyVerticalOffsetTransformation(k,W,I,p,L),p.applyProjection(k,E),-1<E[0]&&(l=Math.floor(E[0])+this.params.screenOffset[0],v=Math.floor(E[1])+this.params.screenOffset[1],t&&(l+=r[0],0!==r[1]&&(v+=G.applyScaleFactor(r[1],L.factorAlignment))),G.applyPrecomputedScaleFactorVec2(A,L.factor,A),B=ma*p.pixelRatio,F=void 0,a.textureIsSignedDistanceField&&(F=a.outlineSize*
p.pixelRatio/2),U(D,l,v,A,B,F,a,u)&&(v=g.ray,h.vec3.transformMat4(X,k,ba.mat4.invert(na,p.viewMatrix)),E[0]=D[0],E[1]=D[1],p.unprojectPoint(E,k),l=C.vec3f64.create(),h.vec3.copy(l,v.direction),B=1/h.vec3.length(l),h.vec3.scale(l,l,B),v=h.vec3.distance(v.origin,k)*B,w(v,l,-1,1,!0,X)))}};b.prototype.computeAttachmentOrigin=function(a,b){a=a.data;var f="getVertexAttr"in a?a.getVertexAttr():"vertexAttr"in a?a.vertexAttr:null;if(!f)return null;var d=c.VertexAttrConstants.POSITION,f=f[d];a="getIndices"in
a?a.getIndices(d):"indices"in a?a.indices[d]:null;return ha.computeAttachmentOriginPoints(f,a,b)};b.prototype.createBufferWriter=function(){return new oa(this)};b.prototype.createRenderer=function(a,b){return new ja(a,b,this)};b.prototype.normalAndViewAngle=function(a,b,f,g){void 0===g&&(g=M);h.vec3.transformMat3(g.normal,a,b);h.vec3.transformMat4(g.normal,g.normal,f.viewInverseTransposeMatrix);g.cosAngle=h.vec3.dot(Y,pa);return g};b.prototype.updateScaleInfo=function(a,b){var f=this.params;f.screenSizePerspective?
a.factor=G.precomputeScaleFactor(M.cosAngle,b,f.screenSizePerspective,a.factor):(a.factor.scale=1,a.factor.factor=0,a.factor.minPixelSize=0,a.factor.paddingPixels=0);f.screenSizePerspectiveAlignment?a.factorAlignment=G.precomputeScaleFactor(M.cosAngle,b,f.screenSizePerspectiveAlignment,a.factorAlignment):(a.factorAlignment.factor=a.factor.factor,a.factorAlignment.scale=a.factor.scale,a.factorAlignment.minPixelSize=a.factor.minPixelSize,a.factorAlignment.paddingPixels=a.factor.paddingPixels)};b.prototype.applyVerticalOffsetTransformation=
function(a,b,f,g,c,e){var d=this.params;da.isMat4(f)&&(f=P.mat3.fromMat4(I,f));if(!d.verticalOffset||!d.verticalOffset.screenLength)return c&&(d.screenSizePerspective||d.screenSizePerspectiveAlignment)?(g=h.vec3.length(a),this.updateScaleInfo(c,g)):c&&(c.factor.scale=1,c.factorAlignment.scale=1),e?h.vec3.copy(e,a):a;b=this.normalAndViewAngle(b,f,g);f=h.vec3.length(a);g=K.verticalOffsetAtDistance(g,f,d.verticalOffset,b.cosAngle,d.screenSizePerspectiveAlignment||d.screenSizePerspective);c&&this.updateScaleInfo(c,
f);return h.vec3.add(e||a,a,h.vec3.scale(b.normal,b.normal,g))};b.prototype.getGLMaterial=function(a){if(0===a.output)return new qa(a);if(4===a.output)return new ra(a)};b.prototype.calculateRelativeScreenBounds=function(a,b,f){void 0===f&&(f=ea.create());var c=this.params,d=f;void 0===d&&(d=sa);ca.vec2.copy(d,c.anchorPos);d[0]*=-a[0];d[1]*=-a[1];d[0]+=c.screenOffset[0]*b;d[1]+=c.screenOffset[1]*b;f[2]=f[0]+a[0];f[3]=f[1]+a[1];return f};b.shouldRenderVisibilityDuringRenderPass=function(a){return 0===
a||4};return b}(ia.Material);J=function(c){function b(a){a=c.call(this,S.makeCtorParameters(a,a.material.getParameters()))||this;a.updateParameters();return a}y(b,c);b.prototype.beginSlot=function(a){return a===(this.params.drawInSecondSlot?19:18)};b.prototype.updateParameters=function(){this.params=K.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram()};b.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,
this.material.getTechniqueConfig(this.output),this.technique)};b.prototype.bind=function(a,b){a.bindProgram(this.technique.program);this.bindTexture(a,this.technique.program);this.bindTextureScale(a,this.technique.program);this.technique.bindPass(a,this.params,b)};return b}(S);var qa=function(c){function b(a){a=c.call(this,O({},a,{output:0}))||this;a.isOcclusionSlot=!1;return a}y(b,c);b.prototype.beginSlot=function(a){var b=this.params.drawInSecondSlot?19:18;if(this.params.occlusionTest)return this.isOcclusionSlot=
12===a,12===a||a===b;this.isOcclusionSlot=!1;return a===b};b.prototype.getTechnique=function(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique};b.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique);this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(H.HUDMaterialTechnique,this.material.getTechniqueConfig(6),this.occlusionTechnique)};b.prototype.bind=
function(a,b){var c=this.getTechnique();a.bindProgram(c.program);this.isOcclusionSlot||(this.bindTexture(a,c.program),this.bindTextureScale(a,c.program));c.bindPass(a,this.params,b)};return b}(J),ra=function(c){function b(a){return c.call(this,O({},a,{output:4}))||this}y(b,c);return b}(J),L={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},sa=R.vec2f64.create(),k=C.vec3f64.create(),W=C.vec3f64.create(),E=Z.createRenderScreenPointArray3(),
Y=C.vec3f64.create(),X=C.vec3f64.create(),I=aa.mat3f64.create(),na=Q.mat4f64.create(),r=C.vec3f64.create(),M={normal:Y,cosAngle:0},V=Q.mat4f64.create(),ma=1,la=2,A=[0,0],pa=C.vec3f64.fromValues(0,0,1),ka={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,
1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:R.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,debugDrawBorder:!1},ta=fa.newLayout().vec3f(c.VertexAttrConstants.POSITION).vec3f(c.VertexAttrConstants.NORMAL).vec2f(c.VertexAttrConstants.UV0).vec4u8(c.VertexAttrConstants.COLOR).vec2f(c.VertexAttrConstants.SIZE).vec4f(c.VertexAttrConstants.AUXPOS1).vec4f(c.VertexAttrConstants.AUXPOS2),
oa=function(){function h(b){this.material=b;this.vertexBufferLayout=ta}h.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};h.prototype.elementCount=function(b){return 6*b.indices[c.VertexAttrConstants.POSITION].length};h.prototype.write=function(b,a,d,f){u.writePosition(a.indices[c.VertexAttrConstants.POSITION],a.vertexAttr[c.VertexAttrConstants.POSITION].data,b.transformation,d.position,f,6);u.writeNormal(a.indices[c.VertexAttrConstants.NORMAL],a.vertexAttr[c.VertexAttrConstants.NORMAL].data,
b.invTranspTransformation,d.normal,f,6);b=a.vertexAttr[c.VertexAttrConstants.UV0].data;var g=void 0,h=void 0,e=void 0,k=void 0;null==b||4>b.length?(b=this.material.getParameters(),h=g=0,e=b.texCoordScale[0],k=b.texCoordScale[1]):(g=b[0],h=b[1],e=b[2],k=b[3]);var e=Math.min(1.99999,e+1),k=Math.min(1.99999,k+1),q=a.indices[c.VertexAttrConstants.POSITION].length,m=d.uv0;b=f;for(var n=0;n<q;++n)m.set(b,0,g),m.set(b,1,h),b+=1,m.set(b,0,e),m.set(b,1,h),b+=1,m.set(b,0,e),m.set(b,1,k),b+=1,m.set(b,0,e),m.set(b,
1,k),b+=1,m.set(b,0,g),m.set(b,1,k),b+=1,m.set(b,0,g),m.set(b,1,h),b+=1;u.writeColor(a.indices[c.VertexAttrConstants.COLOR],a.vertexAttr[c.VertexAttrConstants.COLOR].data,4,d.color,f,6);g=a.indices[c.VertexAttrConstants.SIZE];h=a.vertexAttr[c.VertexAttrConstants.SIZE].data;e=g.length;k=d.size;b=f;for(n=0;n<e;++n)for(var q=h[2*g[n]],m=h[2*g[n]+1],r=0;6>r;++r)k.set(b,0,q),k.set(b,1,m),b+=1;a.indices[c.VertexAttrConstants.AUXPOS1]&&a.vertexAttr[c.VertexAttrConstants.AUXPOS1]&&u.writeBufferVec4(a.indices[c.VertexAttrConstants.AUXPOS1],
a.vertexAttr[c.VertexAttrConstants.AUXPOS1].data,d.auxpos1,f,6);a.indices[c.VertexAttrConstants.AUXPOS2]&&a.vertexAttr[c.VertexAttrConstants.AUXPOS2]&&u.writeBufferVec4(a.indices[c.VertexAttrConstants.AUXPOS2],a.vertexAttr[c.VertexAttrConstants.AUXPOS2].data,d.auxpos2,f,6)};return h}();return N});