// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/assignHelper ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/ComponentUtils ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/MaterialUtil ./renderers/MergedRenderer ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechnique".split(" "),
function(O,ra,P,U,V,W,H,B,X,d,p,e,Y,Z,aa,ba,ca,da,ea,Q,fa,ga,g){function I(d,b,a,c,r){for(var g=0;g<r;g++)a[c++]=d[b++];return c}var G=V.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");O=function(p){function b(a,c){c=p.call(this,c)||this;c.techniqueConfig=new g.RibbonLineTechniqueConfiguration;c.params=Q.copyParameters(a,ha);c.validateParams();c.params.transparent=1>c.params.color[3]||c.params.transparent;c.layout=c.createLayout();return c}P(b,p);b.prototype.dispose=function(){};
b.prototype.setParameterValues=function(a){for(var c in a)"cap"===c?G.error("cap cannot be changed after creation"):"join"===c&&"round"===this.params[c]!==("round"===a[c])?G.error("join cannot be changed after creation"):"stipplePattern"===c&&!!this.params[c]!==!!a[c]?G.error("stippledness cannot be changed after creation"):this.params[c]=a[c];this.validateParams();this.parametersChanged()};b.prototype.getParameters=function(){return this.params};b.prototype.getPassParameters=function(){return this.params};
b.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;a=H.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;this.techniqueConfig.stippleOffColorEnabled=a&&H.isSome(this.params.stippleOffColor);this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.params.join;
this.techniqueConfig.roundCaps="round"===this.params.cap;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.params.innerWidth&&H.isSome(this.params.innerColor);this.techniqueConfig.falloffEnabled=
0<this.params.falloff;this.techniqueConfig.occluder=8===this.renderOccluded;return this.techniqueConfig};b.prototype.intersect=function(a,c,b,g,h,d,f,l,e){e?Q.intersectDrapedRenderLineGeometry(a,g,d,this.params.width,f):this.intersectLineGeometry(a,c,b,g,this.params.width,f)};b.prototype.intersectLineGeometry=function(a,c,b,E,h,n){if(E.options.selectionMode&&!Z.isAllHidden(c.componentVisibilities,a.componentOffsets))if(da.isTranslationMatrix(b)){c=a.data.getVertexAttr();a=c[g.RibbonVertexAttributeConstants.POSITION].data;
this.params.vvSizeEnabled?h*=W.clamp(this.params.vvSizeOffset[0]+c[g.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]):c[g.RibbonVertexAttributeConstants.SIZE]&&(h*=c[g.RibbonVertexAttributeConstants.SIZE].data[0]);var f=E.camera,l=ia;X.vec2.copy(l,E.point);h=h*f.pixelRatio/2+4*f.pixelRatio;d.vec3.set(F[0],l[0]-h,l[1]+h,0);d.vec3.set(F[1],l[0]+h,l[1]+h,0);d.vec3.set(F[2],l[0]+h,l[1]-h,0);d.vec3.set(F[3],
l[0]-h,l[1]-h,0);for(var r=0;4>r;r++)f.unprojectPoint(F[r],y[r]);e.plane.fromPoints(f.eye,y[0],y[1],J);e.plane.fromPoints(f.eye,y[1],y[2],K);e.plane.fromPoints(f.eye,y[2],y[3],L);e.plane.fromPoints(f.eye,y[3],y[0],M);c=Number.MAX_VALUE;for(var p=this.params.isClosed?a.length-2:a.length-5,r=0;r<p;r+=3){q[0]=a[r]+b[12];q[1]=a[r+1]+b[13];q[2]=a[r+2]+b[14];var t=(r+3)%a.length;u[0]=a[t]+b[12];u[1]=a[t+1]+b[13];u[2]=a[t+2]+b[14];if(!(0>e.plane.signedDistance(J,q)&&0>e.plane.signedDistance(J,u)||0>e.plane.signedDistance(K,
q)&&0>e.plane.signedDistance(K,u)||0>e.plane.signedDistance(L,q)&&0>e.plane.signedDistance(L,u)||0>e.plane.signedDistance(M,q)&&0>e.plane.signedDistance(M,u))){f.projectPoint(q,z);f.projectPoint(u,D);if(0>z[2]&&0<D[2]){d.vec3.subtract(x,q,u);var t=f.frustum,N=-e.plane.signedDistance(t.planes[4],q),t=N/d.vec3.dot(x,t.planes[4]);d.vec3.scale(x,x,t);d.vec3.add(q,q,x);f.projectPoint(q,z)}else if(0<z[2]&&0>D[2])d.vec3.subtract(x,u,q),t=f.frustum,N=-e.plane.signedDistance(t.planes[4],u),t=N/d.vec3.dot(x,
t.planes[4]),d.vec3.scale(x,x,t),d.vec3.add(u,u,x),f.projectPoint(u,D);else if(0>z[2]&&0>D[2])continue;z[2]=0;D[2]=0;t=e.lineSegment.distance2(e.lineSegment.fromPoints(z,D,R),l);t<c&&(c=t,d.vec3.copy(S,q),d.vec3.copy(T,u))}}b=E.rayBeginPoint;E=E.rayEndPoint;c<h*h&&(a=Number.MAX_VALUE,e.lineSegment.closestLineSegmentPoint(e.lineSegment.fromPoints(S,T,R),e.lineSegment.fromPoints(b,E,ja),C)&&(d.vec3.subtract(C,C,b),a=d.vec3.length(C),d.vec3.scale(C,C,1/a),a/=d.vec3.distance(b,E)),n(a,C))}else G.error("intersection assumes a translation-only matrix")};
b.prototype.computeAttachmentOrigin=function(a,c){var b=a.data;a="getVertexAttr"in b?b.getVertexAttr():"vertexAttr"in b?b.vertexAttr:null;if(!a)return null;var d=g.RibbonVertexAttributeConstants.POSITION,b="getVertexAttr"in b?b.getIndices(d):null;return aa.computeAttachmentOriginLines(a[d],b,c)};b.prototype.createLayout=function(){var a=Y.newLayout().vec3f(g.RibbonVertexAttributeConstants.POSITION).f32(g.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(g.RibbonVertexAttributeConstants.UV0).vec3f(g.RibbonVertexAttributeConstants.AUXPOS1).vec3f(g.RibbonVertexAttributeConstants.AUXPOS2);
this.params.vvSizeEnabled?a.f32(g.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):a.f32(g.RibbonVertexAttributeConstants.SIZE);this.params.vvColorEnabled?a.f32(g.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):a.vec4f(g.RibbonVertexAttributeConstants.COLOR);this.params.vvOpacityEnabled&&a.f32(g.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE);return a};b.prototype.createBufferWriter=function(){return new ka(this.layout,this.params)};b.prototype.createRenderer=function(a,b){return new fa(a,
b,this,g.ribbonVertexAttributeLocations)};b.prototype.getGLMaterial=function(a){return 0===a.output||4===a.output?new la(a):void 0};b.prototype.validateParams=function(){this.params.width&&1<this.params.width&&(this.params.width=Math.round(this.params.width));"miter"!==this.params.join&&(this.params.miterLimit=0)};return b}(ca.Material);var la=function(d){function b(a){a=d.call(this,a)||this;a.updateParameters();return a}P(b,d);b.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(ga.RibbonLineTechnique,
this.material.getTechniqueConfig(this.output),this.technique)};b.prototype.beginSlot=function(a){return this.technique.configuration.occluder?3===a||10===a||11===a:0===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,a===this.targetSlot):3===a};b.prototype._updateOccludeeState=function(a){a.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:a.hasOccludees}),this.updateParameters())};b.prototype.ensureParameters=
function(a){0===this.output&&this._updateOccludeeState(a)};b.prototype.bind=function(a,b){a.bindProgram(this.technique.program);this.technique.bindPass(a,this.material.getPassParameters(),b)};b.prototype.getPipelineState=function(a,b){return b?this.technique.opaqueOccludeeState:11===a?this.technique.transparentOccluderState:this.technique.configuration.occluder&&3===a?this.technique.opaqueOccluderState:this.technique.pipeline};return b}(ba.GLMaterial),ha=U({width:0,color:[1,1,1,1],join:"miter",cap:"butt",
miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},ea.Default),ka=function(){function e(b,a){this.params=a;this.numJoinSubdivisions=this.numCapSubdivisions=0;this.vertexBufferLayout=b;if(!a.isClosed)switch(this.params.cap){case "butt":this.numCapSubdivisions=0;break;case "square":this.numCapSubdivisions=1;break;case "round":this.numCapSubdivisions=
ma}switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=na}}e.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};e.prototype.elementCount=function(b){var a=2*this.numCapSubdivisions+2,c=b.indices[g.RibbonVertexAttributeConstants.POSITION].length/2+1,d=this.params.isClosed,a=d?2:2*a,e=d?0:1,c=d?c:c-1;if(b.vertexAttr[g.RibbonVertexAttributeConstants.SUBDIVISIONS])for(b=b.vertexAttr[g.RibbonVertexAttributeConstants.SUBDIVISIONS].data;e<
c;++e)a+=4+2*b[e];else a+=(c-e)*(2*this.numJoinSubdivisions+4);return a+2};e.prototype.write=function(b,a,c,e){var p=this,h=oa,n=pa,f=qa,l=a.vertexAttr[g.RibbonVertexAttributeConstants.POSITION].data,q=a.indices&&a.indices[g.RibbonVertexAttributeConstants.POSITION];q&&q.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");q=null;a.vertexAttr[g.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(q=a.vertexAttr[g.RibbonVertexAttributeConstants.SUBDIVISIONS].data);var u=
1,t=0;this.params.vvSizeEnabled?t=a.vertexAttr[g.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:a.vertexAttr[g.RibbonVertexAttributeConstants.SIZE]&&(u=a.vertexAttr[g.RibbonVertexAttributeConstants.SIZE].data[0]);var r=[1,1,1,1],x=0;this.params.vvColorEnabled?x=a.vertexAttr[g.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:a.vertexAttr[g.RibbonVertexAttributeConstants.COLOR]&&(r=a.vertexAttr[g.RibbonVertexAttributeConstants.COLOR].data);var y=0;this.params.vvOpacityEnabled&&
(y=a.vertexAttr[g.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);a=l.length/3;b=b.transformation;var m=new Float32Array(c.buffer);c=this.vertexBufferLayout.stride/4;var k=e*c;e=k;var w=function(a,b,c,d,e,f){m[k++]=b[0];m[k++]=b[1];m[k++]=b[2];m[k++]=d;m[k++]=e;m[k++]=f;m[k++]=a[0];m[k++]=a[1];m[k++]=a[2];m[k++]=c[0];m[k++]=c[1];m[k++]=c[2];p.params.vvSizeEnabled?m[k++]=t:m[k++]=u;p.params.vvColorEnabled?m[k++]=x:(m[k++]=r[0],m[k++]=r[1],m[k++]=r[2],m[k++]=r[3]);p.params.vvOpacityEnabled&&
(m[k++]=y)},k=k+c;d.vec3.set(n,l[0],l[1],l[2]);b&&d.vec3.transformMat4(n,n,b);var z=this.params.isClosed;if(z){var v=l.length-3;d.vec3.set(h,l[v],l[v+1],l[v+2]);b&&d.vec3.transformMat4(h,h,b)}else{d.vec3.copy(h,n);d.vec3.set(f,l[3],l[4],l[5]);b&&d.vec3.transformMat4(f,f,b);for(v=0;v<this.numCapSubdivisions;++v){var A=1-v/this.numCapSubdivisions;w(h,n,f,A,1,-4);w(h,n,f,A,1,4)}w(h,n,f,0,0,-4);w(h,n,f,0,0,4);d.vec3.copy(h,n);d.vec3.copy(n,f)}for(var D=z?a:a-1,v=z?0:1;v<D;v++){A=(v+1)%a*3;d.vec3.set(f,
l[A+0],l[A+1],l[A+2]);b&&d.vec3.transformMat4(f,f,b);w(h,n,f,0,1,-1);w(h,n,f,0,1,1);for(var C=q?q[v]:this.numJoinSubdivisions,B=0;B<C;++B)A=(B+1)/(C+1),w(h,n,f,A,1,-2),w(h,n,f,A,1,2);w(h,n,f,1,0,-2);w(h,n,f,1,0,2);d.vec3.copy(h,n);d.vec3.copy(n,f)}if(z)k=I(m,e+c,m,k,2*c);else for(w(h,n,f,0,1,-5),w(h,n,f,0,1,5),v=0;v<this.numCapSubdivisions;++v)A=(v+1)/this.numCapSubdivisions,w(h,n,f,A,1,-5),w(h,n,f,A,1,5);I(m,e+c,m,e,c);k=I(m,k-c,m,k,c)};return e}(),ma=3,na=1,q=p.vec3f64.create(),u=p.vec3f64.create(),
x=p.vec3f64.create(),C=p.vec3f64.create(),ia=p.vec3f64.create(),z=B.createRenderScreenPointArray3(),D=B.createRenderScreenPointArray3(),S=p.vec3f64.create(),T=p.vec3f64.create(),R=e.lineSegment.create(),ja=e.lineSegment.create(),oa=p.vec3f64.create(),pa=p.vec3f64.create(),qa=p.vec3f64.create(),F=[B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3(),B.createRenderScreenPointArray3()],y=[p.vec3f64.create(),p.vec3f64.create(),p.vec3f64.create(),p.vec3f64.create()],
J=e.plane.create(),K=e.plane.create(),L=e.plane.create(),M=e.plane.create();return O});