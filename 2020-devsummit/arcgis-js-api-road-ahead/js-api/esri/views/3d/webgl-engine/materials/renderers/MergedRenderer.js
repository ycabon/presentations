// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/DefaultVertexAttributeLocations ../../lib/IntervalUtilities ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(z,O,w,A,x,r,B,C,D,E,v,F,G,p,H,I,J){function K(c,
a,b,g){for(var l=new Map,d=a.vertexBufferLayout.stride/4,f=function(g,b){var f=g.origin,h=c.get(f.id),e=l.get(f.id);null==e&&(e={optimalCount:null==h?0:h.optimalCount,sparseCount:null==h?0:h.buffer.size,toAdd:[],toRemove:[],origin:f.vec3},l.set(f.id,e));f=a.elementCount(g.data)*d;b?(e.optimalCount+=f,e.sparseCount+=f,e.toAdd.push(g)):(e.optimalCount-=f,e.toRemove.push(g))},k=0;k<b.length;k++){var h=b[k];f(h,!0)}for(b=0;b<g.length;b++)h=g[b],f(h,!1);return l}z=function(){function c(a,b,g,l){void 0===
l&&(l=C.Default3D);this.type="MergedRenderer";this._dataByOrigin=new Map;this._highlightCount=0;this._hasOccludees=!1;this._rctx=a;this._vertexAttributeLocations=l;this._material=g;this._materialRep=b;this._glMaterials=p.acquireMaterials(this._material,this._materialRep);this._bufferWriter=g.createBufferWriter()}c.prototype.dispose=function(){p.releaseMaterials(this._material,this._materialRep)};Object.defineProperty(c.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!0,
configurable:!0});Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return 0<this._highlightCount},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasOccludees",{get:function(){return this._hasOccludees},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"hasWater",{get:function(){return!this.isEmpty&&w.someMap(this._glMaterials,function(a){return a instanceof F.WaterGLMaterial})},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"rendersOccluded",
{get:function(){return!this.isEmpty&&1!==this._material.renderOccluded},enumerable:!0,configurable:!0});c.prototype.modify=function(a){var b=this,g=L;g.clear();this.updateGeometries(a.toUpdate,g);this.addAndRemoveGeometries(a.toAdd,a.toRemove,g);this.updateHighlightCount();this.updateOccludeeFlag();g.forEach(function(a){return b.updateDisplayedIndexRanges(a)})};c.prototype.addAndRemoveGeometries=function(a,b,g){var l=this,d=this._bufferWriter,f=d.vertexBufferLayout,k=f.stride/4,h=this._dataByOrigin,
e=K(h,d,a,b);e.forEach(function(a,b){e.delete(b);var d=a.optimalCount,c=a.sparseCount,n=h.get(b);null==n&&(v.assert(0<d),n=l.createData(f,d,a.origin),h.set(b,n));if(0===d)n.vao.dispose(!0),n.vao=null,h.delete(b);else{var t=d<a.sparseCount/2;b=M;var m=n.buffer.size,p=n.buffer.array,d=n.buffer.resize(t?d:c,!1);t||d?l.removeAndRebuild(n,a.toRemove,k,p,b):0<a.toRemove.length?(l.removeByErasing(n,a.toRemove,k,b),0<a.toAdd.length&&(b.end=m)):(b.begin=m,b.end=m);d=N;v.setMatrixTranslation3(d,-a.origin[0],
-a.origin[1],-a.origin[2]);l.append(n,a.toAdd,k,d,b);a=n.vao.vertexBuffers.geometry;a.byteSize!==n.buffer.array.buffer.byteLength?a.setData(n.buffer.array):(c=b.begin,d=b.end,c<d&&(c*=4,a.setSubData(n.buffer.array,c,c,4*d)));(b.updatedDisplayedIndexRange||n.displayedIndexRanges)&&g.add(n)}})};c.prototype.updateGeometries=function(a,b){for(var g=this._bufferWriter,l=g.vertexBufferLayout.stride/4,d=0;d<a.length;d++){var f=a[d],k=f.updateType,f=f.renderGeometry,h=this._dataByOrigin.get(f.origin.id),
e=h&&h.instances.get(f.uniqueName);if(!e)break;k&1&&(e.isHidden=p.checkIsHidden(f),b.add(h));k&9&&(e.highlightedIndexRanges=p.generateRenderGeometryHighlightRanges(f),h.highlightCount=null);k&16&&(e.hasOccludees=!!f.instanceParameters.occludees);k&6&&(k=h.buffer.array,h=h.vao,p.calculateTransformRelToOrigin(f,y,u),g.write({transformation:y,invTranspTransformation:u},f.data,g.vertexBufferLayout.createView(k.buffer),e.from),v.assert(e.from+g.elementCount(f.data)===e.to,"material VBO layout has changed"),
h.vertexBuffers.geometry.setSubData(k,e.from*l*4,e.from*l*4,e.to*l*4))}};c.prototype.updateDisplayedIndexRanges=function(a){a.displayedIndexRanges=[];var b=!0;a.instances.forEach(function(g){g.isHidden?b=!1:a.displayedIndexRanges.push([g.from,g.to-1])});a.displayedIndexRanges=b?null:D.mergeIntervals(a.displayedIndexRanges)};c.prototype.updateHighlightCount=function(){var a=this;this._highlightCount=0;this._dataByOrigin.forEach(function(b){if(null==b.highlightCount){var g=0;b.instances.forEach(function(a){a.highlightedIndexRanges&&
++g});b.highlightCount=g}a._highlightCount+=b.highlightCount})};c.prototype.updateOccludeeFlag=function(){this._hasOccludees=w.someMap(this._dataByOrigin,function(a){a.hasOccludees=w.someMap(a.instances,function(a){return a.hasOccludees});return a.hasOccludees})};c.prototype.updateLogic=function(a){return this._material.update(a)};c.prototype.render=function(a,b,g,l){var d=this,f=this._rctx,k=this._glMaterials.get(b.pass),h=4===b.pass,e=a;2===b.pass&&null===e&&(e=22);if(!k||2!==k.ensureResources(f)||
null!=e&&!k.beginSlot(e)||h&&0===this._highlightCount)return!1;k.ensureParameters(g);var c=k.getTechnique(),m=k.getPipelineState(e,!1);f.setPipelineState(m);k.bind(f,g);c.program.setUniformMatrix4fv("model",r.mat4f64.IDENTITY);c.program.hasUniform("modelNormal")&&c.program.setUniformMatrix4fv("modelNormal",r.mat4f64.IDENTITY);var q=!1;this._dataByOrigin.forEach(function(a){if(!h||0!==a.highlightCount)if(g.origin=a.origin,c.bindDraw(g),c.ensureAttributeLocations(a.vao),f.bindVAO(a.vao),h)q=d.renderHighlightPass(c,
a,l)||q;else if(a.hasOccludees){var b=k.getPipelineState(e,!0);q=d.renderDefaultPassWithOccludees(c,a,m,b,l)||q}else q=d.renderDefaultPass(c,a,l)||q});return q};c.prototype.renderDefaultPass=function(a,b,g){var c=this._rctx,d=b.displayedIndexRanges;if(d&&0===d.length)return!1;d?p.drawArraysFaceRange(c,d,0,a.primitiveType,g):(b=4*b.buffer.size/I.getStride(b.vao.layout.geometry),p.drawArrays(c,a.primitiveType,0,b,g));return!0};c.prototype.renderDefaultPassWithOccludees=function(a,b,g,c,d){var f=this._rctx,
k=b.displayedIndexRanges;if(k&&0===k.length)return!1;b.instances.forEach(function(b){b.isHidden||(b.hasOccludees&&f.setPipelineState(c),p.drawArrays(f,a.primitiveType,b.from,b.to-b.from,d),b.hasOccludees&&f.setPipelineState(g))});return!0};c.prototype.renderHighlightPass=function(a,b,g){var c=this._rctx,d=!1;b.instances.forEach(function(b){var f=b.highlightedIndexRanges;if(f&&0!==f.length)for(var h=0;h<f.length;h++){var e=f[h];p.drawArrays(c,a.primitiveType,e?e[0]+b.from:b.from,e?e[1]-e[0]+1:b.to-
b.from,g);d=!0}});return d};c.prototype.createData=function(a,b,g){return{instances:new Map,vao:new J(this._rctx,this._vertexAttributeLocations,{geometry:B.glLayout(a)},{geometry:H.createVertex(this._rctx,35044)}),buffer:new E.ResizableFloat32Array(b),optimalCount:0,origin:g,highlightCount:0,hasOccludees:!1}};c.prototype.removeAndRebuild=function(a,b,g,c,d){for(var f=0;f<b.length;f++){var k=b[f].uniqueName,h=a.instances.get(k);a.optimalCount-=(h.to-h.from)*g;a.instances.delete(k)}var e=0,l=a.buffer.array;
d.begin=0;d.end=0;var m=-1,q=-1,p=0;a.instances.forEach(function(a){var b=a.from*g,d=a.to*g,f=d-b;m!==q&&q!==b?(l.set(c.subarray(m,q),p),p+=q-m,m=b):-1===m&&(m=b);q=d;a.from=e/g;e+=f;a.to=e/g});m!==q&&l.set(c.subarray(m,q),p);d.end=e};c.prototype.removeByErasing=function(a,b,g,c){c.begin=Infinity;c.end=-Infinity;for(var d=-1,f=-1,k=0;k<b.length;k++){var h=b[k].uniqueName,e=a.instances.get(h),l=e.from*g,e=e.to*g;d!==f&&f!==l?(a.buffer.erase(d,f),d=l):-1===d&&(d=l);f=e;a.instances.delete(h);a.optimalCount-=
e-l;l<c.begin&&(c.begin=l);e>c.end&&(c.end=e)}d!==f&&a.buffer.erase(d,f)};c.prototype.append=function(a,b,c,l,d){d.updatedDisplayedIndexRange=!1;for(var f=this._bufferWriter,g=0;g<b.length;g++){var h=b[g],e=h.data,t=A.isSome(h.transformation)?x.mat4.multiply(y,l,h.transformation):l;x.mat4.invert(u,t);x.mat4.transpose(u,u);var m=d.end;f.write({transformation:t,invTranspTransformation:u},e,f.vertexBufferLayout.createView(a.buffer.array.buffer),d.end/c);var e=f.elementCount(e)*c,q=m+e;v.assert(null==
a.instances.get(h.uniqueName));var t=p.checkIsHidden(h),r=p.generateRenderGeometryHighlightRanges(h),n=!!h.instanceParameters.occludees;r&&(a.highlightCount=null);n&&(a.hasOccludees=a.hasOccludees||!0);m=new G.Instance(m/c,q/c,t,r,n);a.instances.set(h.uniqueName,m);t&&(d.updatedDisplayedIndexRange=!0);a.optimalCount+=e;d.end+=e}};Object.defineProperty(c.prototype,"test",{get:function(){return{material:this._material}},enumerable:!0,configurable:!0});return c}();var M={updatedDisplayedIndexRange:!1,
begin:0,end:0},N=r.mat4f64.create(),y=r.mat4f64.create(),u=r.mat4f64.create(),L=new Set;return z});