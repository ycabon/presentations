// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Accessor ../../../../core/Collection ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/now ../../../../core/scheduling ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../layers/support/timeUtils ../../support/animationUtils ../collections/Component/interface ../core/renderPasses/RenderPassManager ../core/shaderTechnique/CommonUniformStore ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/Camera ../lib/CompositingHelper ../lib/GLMaterialRep ../lib/Renderer ../lib/TextureRepository ../lib/tracer ../materials/lineStippleUtils ./ScreenshotManager ../../../webgl/context-util ../../../webgl/RenderingContext".split(" "),
function(g,l,Q,m,d,n,p,q,r,t,u,v,w,R,x,h,y,z,A,B,C,D,E,e,F,G,H,I,J,k,K,L,M,N){Object.defineProperty(l,"__esModule",{value:!0});var O=v.getLogger("esri.views.3d.webgl-engine.parts.View");g=function(g){function b(a,b,f){var c=g.call(this)||this;c._stage=b;c.events=new t;c.updateLogicClients=new r;c._camera=new F.default(y.vec3f64.fromValues(0,100,-100));c._stippleTextureRepository=new K.StippleTextureRepository;c._commonUniformStore=new D.CommonUniformStore;c._componentObjectCollection=null;c._needsUpdate=
!0;c._needsRender=!0;c._idleSuspend=!0;c._logicUpdateLast=0;c._stats={renderGeometriesTotal:0,renderGeometriesVisible:0,renderTimeTotal:0,renderTimeLast:0,frameCount:0};c._container=a;c._initializeContext(f);c._shaderTechniqueRepository=new E.ShaderTechniqueRepository({rctx:c._rctx,viewingMode:"local"===f.viewingMode?1:0,commonUniformStore:c._commonUniformStore,stippleTextureRepository:c._stippleTextureRepository});c._textureRepository=new J.TextureRepository(c._stage.getAll(4),c._shaderTechniqueRepository,
c._rctx);c._textureRepository.events.on("changed",function(a){return c.setNeedsRender(a.requestType)});c._materialRepository=new H(c._textureRepository,c._shaderTechniqueRepository,function(){return c.setNeedsRender()});c._compositingHelper=new G.default(c._rctx,c._shaderTechniqueRepository);c._initializeViewportCamera();c._renderer=new I(c._materialRepository,c._textureRepository,c._shaderTechniqueRepository,c._rctx,c._compositingHelper,function(a){void 0===a&&(a=1);return c.setNeedsRender(a)},c._stage);
c.updateLogicClients.add(c._renderer);c._screenshotManager=new L.ScreenshotManager(c._rctx,function(a,b,P){return c._render(a,b,P)},function(){return c.setNeedsRender()},f.screenshot.renderOverlay,function(a){return c.events.emit("force-camera-for-screenshot",a)});c._renderPassManager=new C.RenderPassManager(c,c._rctx,c._shaderTechniqueRepository);c.renderPlugins.add(c._renderPassManager.slots(),c._renderPassManager);c._registerFrameTask();return c}m(b,g);b.prototype.dispose=function(){this._container.contains(this._canvas)&&
this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this.inherited(arguments)};b.prototype.getCombinedStats=function(){var a=this._rctx.gl,b={};b.scene=this._renderer.getStats();b.renderGeometriesTotal=this._stats.renderGeometriesTotal;b.renderGeometriesVisible=this._stats.renderGeometriesVisible;void 0!==a.getUsedTextureMemory&&(b.textureMemory=a.getUsedTextureMemory());void 0!==a.getUsedRenderbufferMemory&&(b.renderbufferMemory=a.getUsedRenderbufferMemory());
void 0!==a.getUsedVBOMemory&&(b.VBOMemory=a.getUsedVBOMemory());if(void 0!==a.getUsedTextureMemoryStats){var a=a.getUsedTextureMemoryStats(),f;for(f in a)b["texMem type: "+f]=a[f]}return b};b.prototype.setNeedsRender=function(a){void 0===a&&(a=1);1===a?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};Object.defineProperty(b.prototype,"canRender",{get:function(){var a=this._camera;return 0<a.fullWidth&&0<a.fullHeight&&this._renderer.canRender},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"needsUpdate",{get:function(){return this._needsUpdate||!this._idleSuspend},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this.needsUpdate||this._renderer.updating||0<this._textureRepository.loadingCount||this._stage.dirty},enumerable:!0,configurable:!0});b.prototype.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._renderer.edgeView},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"textureRepository",{get:function(){return this._textureRepository},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"compositingHelper",{get:function(){return this._compositingHelper},enumerable:!0,configurable:!0});b.prototype.setRenderParameters=function(a){this.setNeedsRender();void 0!==a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend);void 0!==a.shadowMap&&(this._renderPassManager.shadowCastingEnabled=a.shadowMap);
this._renderer.setRenderParams(a)};b.prototype.getRenderParameters=function(){var a=this._renderer.getRenderParams();a.anisotropicFiltering=this._rctx.parameters.maxMaxAnisotropy;a.idleSuspend=this._idleSuspend;return a};Object.defineProperty(b.prototype,"renderingContext",{get:function(){return this._rctx},enumerable:!0,configurable:!0});b.prototype.has=function(a){return"s3tc"===a?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===a?!!this._rctx.capabilities.shaderTextureLOD:!1};
b.prototype.modify=function(a,b,f){this._renderer.modify(a,a.length,b,b.length,f,f.length)};b.prototype.setCamera=function(a){this._camera.copyFrom(a);this.setNeedsRender()};b.prototype.getCamera=function(){return this._camera};b.prototype.getCanvas=function(){return this._canvas};b.prototype.takeScreenshot=function(a){return this._screenshotManager.takeScreenshot(a)};Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!0,configurable:!0});
Object.defineProperty(b.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!0,configurable:!0});b.prototype.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};b.prototype.hotReloadShaders=function(){return n(this,void 0,void 0,function(){return p(this,function(a){switch(a.label){case 0:return[4,this._shaderTechniqueRepository.hotReload()];case 1:return a.sent(),this.setNeedsRender(),[2]}})})};b.prototype._registerFrameTask=function(){var a=this,b={viewCamera:this._camera,
frameHasSlicePlane:!1};this._frameTask=x.addFrameTask({preRender:function(b){k.begin();var c=!1;a._stage.processDirty();var d=z.Milliseconds(b.time-a._logicUpdateLast);if(d>A.DESIRED_ANIMATION_MS){var e={camera:a._stage.getCamera(),dt:d};a.updateLogicClients.forEach(function(a){a.updateLogic(e)&&(c=!0)});a._logicUpdateLast=b.time}c&&a.setNeedsRender(0)},render:function(){(a.needsUpdate||a._needsRender)&&a.canRender&&(a._needsRender=!1,a._needsUpdate=!1,a._render(null,a._camera,!1))},postRender:function(){a.notifyChange("updating");
k.end()},update:function(){b.viewCamera=a._camera;b.frameHasSlicePlane=a._renderer.hasSlicePlane;a._textureRepository.update();a._screenshotManager.update(b)}})};b.prototype._initializeViewportCamera=function(){var a=this._container.getBoundingClientRect(),b=this.getCamera();b.viewport[2]=a.width;b.viewport[3]=a.height;this.setCamera(b)};b.prototype._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style",
"width: 100%; height:100%; display:block;");var b=k.instrumentContext(M.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,powerPreference:"high-performance"},a.renderContext));this._rctx=new N(b,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||{}});null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,
8));this._loadShaderOnlyExtensions(this._rctx);!a.alpha&&this._rctx.contextAttributes.alpha&&O.error("WebGL context has alpha channel even though no alpha channel was requested");!this._rctx.contextAttributes.alpha&&11<=u("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas)};b.prototype._render=function(a,b,d){this._renderer.setLighting(this._stage.lighting);this._rctx.bindFramebuffer(a);b.setGLViewport(this._rctx);this._renderer.render({fbo:a,camera:b,
disableSlice:d,lightDirection:this._stage.mainLightDirection})};b.prototype._loadShaderOnlyExtensions=function(a){a=a.capabilities;a.standardDerivatives;a.shaderTextureLOD};Object.defineProperty(b.prototype,"componentObjectCollection",{get:function(){w.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=B.createComponentObjectCollection(this._renderPassManager));return this._componentObjectCollection},enumerable:!0,configurable:!0});d([h.property({type:Boolean,readOnly:!0})],
b.prototype,"updating",null);d([e.autoDispose()],b.prototype,"_rctx",void 0);d([e.autoDispose()],b.prototype,"_container",void 0);d([e.autoDispose()],b.prototype,"_canvas",void 0);d([e.autoDispose()],b.prototype,"_stippleTextureRepository",void 0);d([e.autoDispose()],b.prototype,"_textureRepository",void 0);d([e.autoDispose()],b.prototype,"_commonUniformStore",void 0);d([e.autoDispose()],b.prototype,"_compositingHelper",void 0);d([e.autoDispose()],b.prototype,"_renderer",void 0);d([e.autoDispose()],
b.prototype,"_screenshotManager",void 0);d([e.autoDispose()],b.prototype,"componentObjectCollection",null);d([e.autoDispose()],b.prototype,"_componentObjectCollection",void 0);return b=d([h.subclass("esri.views.3d.webgl-engine.parts.RenderView")],b)}(h.declared(e.AutoDisposableMixin(q)));l.RenderView=g});