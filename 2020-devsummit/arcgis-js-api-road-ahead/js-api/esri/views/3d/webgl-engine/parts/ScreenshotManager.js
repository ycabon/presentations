// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec4f64 ../lib/AutoDisposable ../../../support/screenshotUtils ../../../webgl/FramebufferObject".split(" "),function(l,n,p,r,t,u,v,q,w,x,m,y){Object.defineProperty(n,"__esModule",{value:!0});l=function(l){function f(b,
c,a,d,e,f){void 0===d&&(d=null);void 0===f&&(f=!0);var g=l.call(this)||this;g._rctx=b;g._renderScene=c;g._requestRenderScene=a;g._renderOverlay=d;g.forceCameraHook=e;g.supersample=f;g._screenshotQueue=[];return g}r(f,l);f.prototype.dispose=function(){this._rctx=null};f.prototype.takeScreenshot=function(b){var c=this;this._requestRenderScene();var a=v.createResolver(function(){c._screenshotQueue=c._screenshotQueue.filter(function(b){return b.resolver!==a})});this._screenshotQueue.push({settings:b,
resolver:a});return a.promise};f.prototype.update=function(b){if(0!==this._screenshotQueue.length){for(var c=0,a=this._screenshotQueue;c<a.length;c++){var d=a[c];if(this.isDisposed)d.resolver.reject();else{var e=p({},d.settings,{pixelRatio:d.settings.pixelRatio*b.viewCamera.pixelRatio}),f=this._ensureScreenshotEncodeCanvas(),g=this._renderScreenshot(b,e),e=m.encodeResult(g,e,f,{flipY:!0,premultipliedAlpha:!0});d.resolver(e)}}this._screenshotQueue=[]}};f.prototype._renderScreenshotOverlay=function(b,
c,a){if(!u.isNone(this._renderOverlay)){b.width=c.width;b.height=c.height;var d=b.getContext("2d"),e=a.pixelRatio;d.save();d.translate(0,c.height);d.scale(1,-1);a.region&&d.translate(-a.region.x,-a.region.y);d.scale(e,e);this._renderOverlay(b,c);d.restore()}};f.prototype._readbackScreenshot=function(b){return b.resample?this._readbackScreenshotResampled(b):this._readbackScreenshotImmediate(b)};f.prototype._readbackScreenshotResampled=function(b){var c=b.framebufferWidth,a=b.framebufferHeight,d=b.region,
e=b.resample,f=this._ensureScreenshotEncodeCanvas(),g=m.createEmptyImageData(c,a,f);this._rctx.gl.readPixels(0,0,c,a,6408,5121,new Uint8Array(g.data.buffer));this._renderScreenshotOverlay(f,g,p({},b,{region:null}));b=m.createEmptyImageData(d.width,d.height,f);return m.resampleHermite(g,b,!0,e.region.x,a-(e.region.y+e.region.height),e.region.width,e.region.height)};f.prototype._readbackScreenshotImmediate=function(b){var c=b.framebufferHeight,a=b.region,d=this._ensureScreenshotEncodeCanvas(),e=m.createEmptyImageData(a.width,
a.height,d);this._rctx.gl.readPixels(a.x,c-(a.y+a.height),a.width,a.height,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(d,e,b);return e};f.prototype._renderScreenshot=function(b,c){var a=null,d=b.viewCamera,e=c.framebufferWidth,f=c.framebufferHeight,g=!1;b=b.frameHasSlicePlane&&c.disableSlice;var h=c.ignorePadding&&d.pixelRatio!==c.pixelRatio;if(b=e!==d.fullWidth||f!==d.fullHeight||b||h){h=d.clone();if(c.ignorePadding){for(var a=w.vec4f64.clone(h.padding),k=0;4>k;k++)a[k]=
Math.round(a[k]/h.pixelRatio*c.pixelRatio);h.padding=a}h.fullWidth=e;h.fullHeight=f;h.pixelRatio=c.pixelRatio;a=d.fovX-h.fovX;e=d.fovY-h.fovY;0>a&&a<e?h.fovX=d.fovX:0>e&&e<a&&(h.fovY=d.fovY);this.forceCameraHook(h);g=!0;a=new y(this._rctx,{width:h.fullWidth,height:h.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(a,h,c.disableSlice)}c=this._readbackScreenshot(c);if(b&&!this._rctx.contextAttributes.alpha)for(k=3;k<c.data.length;k+=4)c.data[k]=255;a&&a.dispose();this._rctx.bindFramebuffer(null);
g&&this.forceCameraHook(d);return c};f.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return f=t([q.subclass("esri.views.3d.webgl-engine.parts.ScreenshotManager")],f)}(q.declared(x.AutoDisposable));n.ScreenshotManager=l});