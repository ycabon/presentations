// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/decorateHelper ../core/tsSupport/declareExtendsHelper ../core/tsSupport/generatorHelper ../core/tsSupport/awaiterHelper ../core/tsSupport/assignHelper ../core/Accessor ../core/Collection ../core/Handles ../core/Logger ../core/maybe ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/ToolViewManagerManipulatorState".split(" "),function(D,E,h,t,u,
v,w,l,x,y,z,g,n,p,f,A,B,k,C){var q=z.getLogger("esri.views.ToolViewManager");return function(r){function d(a){var b=r.call(this,a)||this;b._handles=new y;b._creatingTool=null;b._manipulatorState=new C.default;b.tools=k.newToolCollection();b.cursor=null;b._forEachTool=function(a){if(!g.isSome(b._creatingTool)||!a(b._creatingTool))for(var c=0,e=b.tools.items;c<e.length&&!a(e[c]);c++);};return b}t(d,r);d.prototype.initialize=function(){var a=this;this._handles.add([this.view.on(B.eventTypes,function(b){a._handleInputEvent(b)},
A.ViewEventPriorities.TOOL),this.tools.on("before-add",function(b){var c=b.item;null==c||a.tools.includes(c)?b.preventDefault():null==c.created||c.created||(q.error("tools","Tool can not be added to view before it has been created"),b.preventDefault())}),this.tools.on("before-remove",function(b){a._manipulatorState.clearPointers(b.item,a._forEachTool)}),this.tools.on("change",function(){a._refreshToolWatchers()})])};d.prototype.destroy=function(){this._forEachTool(function(a){return a.destroy()});
this._handles.destroy();this._handles=null};Object.defineProperty(d.prototype,"activeTool",{set:function(a){var b=this;g.isSome(a)&&!this.view.ready?q.error("#activeTool\x3d","cannot set active tool while view is not ready"):(k.swap(this,a,function(c){b._set("activeTool",c);b._removeIncompleteTools(a);b._forEachTool(function(a){var c=g.isNone(b.activeTool)||a===b.activeTool;a.setEditableFlag&&a.setEditableFlag(1,c);c=k.areToolManipulatorsEditable(a);!g.isNone(b.activeTool)&&c||b._manipulatorState.clearPointers(a,
b._forEachTool,!c)});b._updateCursor()}),this._creatingTool!==a&&this._rejectCreatingTool())},enumerable:!0,configurable:!0});d.prototype.createTool=function(a,b,c){return v(this,void 0,void 0,function(){var d,e,f,h=this;return u(this,function(m){switch(m.label){case 0:return[4,this.view.whenReady()];case 1:return m.sent(),d=k.evaluateToolConstructorArguments(b),e=new a(w({},d,{view:this.view})),f=n.onAbort(c,function(){return h.activeTool=null}),this._rejectCreatingTool("Tool creation was interrupted by another tool being created"),
this._creatingTool=e,e.attach(),this._refreshToolWatchers(),k.setActive(e,!0),[4,e.when()];case 2:return m.sent(),g.isSome(f)&&f.remove(),this._creatingTool=null,this.tools.add(e),e instanceof l&&null!=e.completed&&p.whenOnce(e,"completed").then(function(){k.setActive(e,!1)}),[2,e]}})})};d.prototype.attach=function(){var a=this;this._forEachTool(function(b){return b.attach()});"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",function(){a.forEachManipulator(function(b){if(null!=
b.onViewChange)b.onViewChange()})}),this.view.elevationProvider.on("elevation-change",function(b){a.forEachManipulator(function(a){if(null!=a.onElevationChange)a.onElevationChange(b)})})],"manipulators"):this._handles.add(this.view.watch("extent",function(){a.forEachManipulator(function(a){if(null!=a.onViewChange)a.onViewChange()})}))};d.prototype.detach=function(){this.activeTool=null;this._forEachTool(function(a){a.detach();a.destroy()});this.tools.removeAll();this._handles.remove("manipulators")};
d.prototype.forEachManipulator=function(a){this._forEachTool(function(b){b.manipulators&&b.manipulators.forEach(function(c){return a(c.manipulator,b)})})};d.prototype._handleInputEvent=function(a){var b=this;g.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(a):this._forEachTool(function(b){!1!==b.visible&&b.handleInputEvent&&b.handleInputEvent(a)});"key-down"===a.type&&"Escape"===a.key&&this.activeTool&&(a.stopPropagation(),this.activeTool=null);this._manipulatorState.handleInputEvent(a,
{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:function(a){b.activeTool=a},creatingTool:this._creatingTool,view:this.view});this._manipulatorState.handleHoverEvent(a,this._forEachTool);this._updateCursor()};d.prototype._refreshToolWatchers=function(){var a=this;this._handles.remove("tools");this._forEachTool(function(b){if(b instanceof l){var c=p.watch(b,["cursor","visible","editable"],function(){k.areToolManipulatorsEditable(b)||a._manipulatorState.clearPointers(b,a._forEachTool);
a._updateCursor()});a._handles.add(c,"tools")}b.manipulators&&a._handles.add(b.manipulators.on("change",function(c){c.removed.forEach(function(c){a._manipulatorState.clearPointers(b,a._forEachTool,!0,c.id)});a._manipulatorState.updateHoveredStateFromKnownPointers(a._forEachTool);a._updateCursor()}),"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()};d.prototype._updateCursor=function(){var a=null;this._forEachTool(function(b){return null!=
b.cursor&&!1!==b.visible?(a=b.cursor,!0):!1});a||(a=this._manipulatorState.cursor);this._get("cursor")!==a&&this._set("cursor",a)};d.prototype._rejectCreatingTool=function(a){var b=this._creatingTool;g.isNone(b)||(this._manipulatorState.clearPointers(b,this._forEachTool),b.rejectCreation&&b.rejectCreation(n.createAbortError(a)),b.destroy(),this._creatingTool=null,this._refreshToolWatchers())};d.prototype._removeIncompleteTools=function(a){var b=this;this.tools.filter(function(b){return(g.isNone(a)||
b!==a)&&null!=b.completed&&!b.completed}).forEach(function(a){b.tools.remove(a)})};h([f.property({constructOnly:!0,nonNullable:!0})],d.prototype,"view",void 0);h([f.property({value:null})],d.prototype,"activeTool",null);h([f.property({readOnly:!0,type:x})],d.prototype,"tools",void 0);h([f.property({readOnly:!0})],d.prototype,"cursor",void 0);return d=h([f.subclass("esri.views.ToolViewManager")],d)}(f.declared(l))});