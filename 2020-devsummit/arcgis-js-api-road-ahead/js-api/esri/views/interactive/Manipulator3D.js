// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/decorateHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/assignHelper ../../core/Accessor ../../core/compilerUtils ../../core/Evented ../../core/maybe ../../core/screenUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../../core/libs/gl-matrix-2/mat3 ../../core/libs/gl-matrix-2/mat3f64 ../../core/libs/gl-matrix-2/mat4 ../../core/libs/gl-matrix-2/mat4f64 ../../core/libs/gl-matrix-2/vec2 ../../core/libs/gl-matrix-2/vec2f32 ../../core/libs/gl-matrix-2/vec3 ../../core/libs/gl-matrix-2/vec3f64 ../../geometry/support/aaBoundingRect ../../layers/graphics/dehydratedFeatures ../3d/support/ElevationProvider ../3d/support/geometryUtils ../3d/support/projectionUtils ../3d/support/stack ../3d/webgl-engine/lib/Intersector ../3d/webgl-engine/lib/intersectorUtils ../3d/webgl-engine/lib/Layer ../3d/webgl-engine/lib/Object3D".split(" "),
function(r,C,d,Q,fa,R,D,S,k,q,c,T,E,U,x,y,t,V,m,n,W,z,X,p,Y,u,Z,aa,ba,ca){function F(c){return 0!==c[12]||0!==c[13]||0!==c[14]}Object.defineProperty(C,"__esModule",{value:!0});r=function(r){function b(a){a=r.call(this,a)||this;a.hideOnGrab=!1;a.moveOnDrag=!0;a.snapToPointer=!0;a.collisionType={type:"point"};a.collisionPriority=0;a.renderObjects=[];a.autoScaleRenderObjects=!0;a._radius=10;a._worldSized=!1;a._focusMultiplier=2;a._touchMultiplier=2.5;a.interactive=!0;a.selectable=!1;a.cursor=null;a.dragging=
!1;a._areAnyEngineObjectsVisible=!1;a.events=new S({target:a});a._position=n.vec3f64.create();a._modelTransform=y.mat4f64.create();a._dragOffset=null;a._dirtyScreenPoint=q.createScreenPoint();a._dirtyScreenPointArray=q.createScreenPointArray();a._dirtyRenderScreenPointArray=q.createRenderScreenPointArray3();a._dirtyOriginScreenPointArray=q.createScreenPointArray();a._dirtyScreenPixelSize=1;a._screenPositionDirty=!0;a._engineResourcesAddedToStage=!1;a._engineResources=null;a._attached=!1;a._engineLayerId=
null;a._materialIdReferences=null;a._hitResult={onSurface:!1,surfaceType:"ground"};return a}Q(b,r);b.prototype.initialize=function(){var a=this;this._intersector=new Z.Intersector(this.view.viewingMode);this._mapPoint=z.makeDehydratedPoint(0,0,0,this.view.spatialReference);this.events.on("drag",function(b){return a.drag(b)})};b.prototype.destroy=function(){this._removeResourcesFromStage();this._engineResources=null;this._set("view",null);this._camera=null};Object.defineProperty(b.prototype,"alignment",
{get:function(){return this._get("alignment")},set:function(a){this._set("alignment",a);this.constructed&&this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"visible",{set:function(a){a!==this._get("visible")&&(this._set("visible",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"radius",{get:function(){return this._radius},set:function(a){a!==this._radius&&(this._radius=a,this._updateEngineObject())},enumerable:!0,
configurable:!0});Object.defineProperty(b.prototype,"worldSized",{get:function(){return this._worldSized},set:function(a){a!==this._worldSized&&(this._worldSized=a,this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focusMultiplier",{get:function(){return this._focusMultiplier},set:function(a){this._focusMultiplier=a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"touchMultiplier",{get:function(){return this._touchMultiplier},set:function(a){this._touchMultiplier=
a},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"modelTransform",{get:function(){return this._modelTransform},set:function(a){F(a)&&(this._screenPositionDirty=!0);x.mat4.copy(this._modelTransform,a);this._updateEngineObject()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"position",{get:function(){return this._position},set:function(a){this.view.renderCoordsHelper.fromRenderCoords(a,this._mapPoint,this._mapPoint.spatialReference);this._refreshMapPoint()},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"mapPoint",{get:function(){return this._mapPoint},set:function(a){z.clonePoint(a,this._mapPoint);this._refreshMapPoint()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"grabbing",{set:function(a){a!==this._get("grabbing")&&(this._set("grabbing",a),this._updateEngineObject());a||(this._dragOffset=null)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hovering",{set:function(a){a!==this._get("hovering")&&
(this._set("hovering",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"selected",{set:function(a){a!==this._get("selected")&&(this._set("selected",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{set:function(a){a!==this._get("state")&&(this._set("state",a),this._updateEngineObject())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"areAnyEngineObjectsVisible",{get:function(){return this._areAnyEngineObjectsVisible},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"surfaceType",{get:function(){return this._hitResult.onSurface?this._hitResult.surfaceType:null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"focused",{get:function(){return this._focused},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_focused",{get:function(){return this._get("hovering")||this._get("grabbing")},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"screenPoint",
{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPoint},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_screenPointArray",{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_renderScreenPointArray",{get:function(){this._updateScreenSpaceProperties();return this._dirtyRenderScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"_originScreenPointArray",{get:function(){this._updateScreenSpaceProperties();return this._dirtyOriginScreenPointArray},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"_screenPixelSize",{get:function(){this._updateScreenSpaceProperties();return this._dirtyScreenPixelSize},enumerable:!0,configurable:!0});b.prototype._updateScreenSpaceProperties=function(){if(this._screenPositionDirty){this._screenPositionDirty=!1;this._dirtyScreenPixelSize=this._camera.computeScreenPixelSizeAt(this._position);
var a=F(this._modelTransform),b;a?(b=this._calculateModelTransformOffset(da),b=m.vec3.add(b,b,this._position)):b=this._position;this._camera.projectPoint(b,this._dirtyRenderScreenPointArray);this._camera.renderToScreen(this._dirtyRenderScreenPointArray,this._dirtyScreenPointArray);q.screenPointArrayToObject(this._dirtyScreenPointArray,this._dirtyScreenPoint);a?(this._camera.projectPoint(this._position,G),this._camera.renderToScreen(G,this._dirtyOriginScreenPointArray)):t.vec2.copy(this._dirtyOriginScreenPointArray,
this._dirtyScreenPointArray)}};b.prototype.intersectionDistance=function(a,b){if(!this._get("visible"))return null;var l=q.screenPointObjectToArray(a,H),c=this._getCollisionRadius(b);b=-1*this._get("collisionPriority");switch(this.collisionType.type){case "point":if(t.vec2.squaredDistance(this._screenPointArray,l)<c*c)return this._renderScreenPointArray[2]+b;break;case "line":var h=this.collisionType.paths;a=this._getWorldToScreenObjectScale();a=this._calculateObjectTransform(a,v);for(var c=c*this._screenPixelSize,
l=p.ray.fromScreen(this._camera,l,A),f=0,g=h;f<g.length;f++)if(h=g[f],0!==h.length)for(var e=m.vec3.transformMat4(I,h[0],a),d=1;d<h.length;d++){var k=m.vec3.transformMat4(J,h[d],a),n=p.lineSegment.closestRayDistance2(p.lineSegment.fromPoints(e,k,K),l);if(null!=n&&n<c*c)return a=m.vec3.add(u.sv3d.get(),e,k),m.vec3.scale(a,a,.5),c=q.castRenderScreenPointArray(u.sv3d.get()),this._camera.projectPoint(a,c),c[2]+b;m.vec3.copy(e,k)}break;case "disc":e=this.collisionType.direction;a=this._getWorldToScreenObjectScale();
a=this._calculateObjectTransform(a,v);c*=this._screenPixelSize;l=p.ray.fromScreen(this._camera,l,A);d=E.mat3.fromMat4(L,a);d=m.vec3.transformMat3(M,e,d);e=this._calculateModelTransformPosition(N);p.plane.fromPositionAndNormal(e,d,w);f=B;if(p.plane.intersectRay(w,l,f)&&m.vec3.squaredDistance(f,e)<c*c)return this._renderScreenPointArray[2]+b;break;case "ribbon":a=this.collisionType;h=a.paths;e=a.direction;a=this._getWorldToScreenObjectScale();a=this._calculateObjectTransform(a,v);c*=this._camera.computeScreenPixelSizeAt(this._position);
l=p.ray.fromScreen(this._camera,l,A);d=E.mat3.fromMat4(L,a);d=m.vec3.transformMat3(M,e,d);e=this._calculateModelTransformPosition(N);p.plane.fromPositionAndNormal(e,d,w);f=B;if(!p.plane.intersectRay(w,l,f))break;l=0;for(g=h;l<g.length;l++)if(h=g[l],0!==h.length)for(e=m.vec3.transformMat4(I,h[0],a),d=1;d<h.length;d++){k=m.vec3.transformMat4(J,h[d],a);n=p.lineSegment.distance2(p.lineSegment.fromPoints(e,k,K),f);if(null!=n&&n<c*c)return a=m.vec3.add(u.sv3d.get(),e,k),m.vec3.scale(a,a,.5),c=q.castRenderScreenPointArray(u.sv3d.get()),
this._camera.projectPoint(a,c),c[2]+b;m.vec3.copy(e,k)}break;default:D.neverReached(this.collisionType)}return null};b.prototype.drag=function(a){if(this.moveOnDrag){a=q.screenPointObjectToArray(a.screenPoint,H);k.isNone(this._dragOffset)&&this.grabbing&&!this.snapToPointer&&(this._dragOffset=t.vec2.subtract(V.vec2f32.create(),a,this._originScreenPointArray));k.isSome(this._dragOffset)&&t.vec2.subtract(a,a,this._dragOffset);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector,
"on-the-ground"===this.alignment?O:null);a=this._intersector.results.min;var b=B;a.getIntersectionPoint(b)?(this.position=b,this._hitResult.onSurface=!0,this._hitResult.surfaceType="TerrainRenderer"===a.intersector?"ground":"feature"):this._hitResult.onSurface=!1}};b.prototype.attach=function(a){void 0===a&&(a={manipulator3D:{}});if(this.view._stage){a=a.manipulator3D;this._engineLayerId=a.engineLayerId;if(k.isNone(this._engineLayerId)){var b=new ba("manipulator-3d",{isPickable:!1});this.view._stage.add(0,
b);this.view._stage.addToViewContent([b.id]);this._engineLayerId=b.id;a.engineLayerId=b.id}a.engineLayerReferences=(a.engineLayerReferences||0)+1;this._materialIdReferences=a.materialIdReferences;k.isNone(this._materialIdReferences)&&(this._materialIdReferences=new Map,a.materialIdReferences=this._materialIdReferences);this._camera=this.view.state.camera;this._attached=!0;this._updateEngineObject();Y.canProject(this._mapPoint.spatialReference,this.view.spatialReference)||(this.mapPoint=z.makeDehydratedPoint(0,
0,0,this.view.spatialReference))}};b.prototype.detach=function(a){void 0===a&&(a={manipulator3D:{}});a=a.manipulator3D;a.engineLayerReferences--;var b=0===a.engineLayerReferences;b&&(a.engineLayerId=null);this._removeResourcesFromStage(b);this._camera=this._materialIdReferences=this._engineLayerId=this._engineResources=null;this._attached=!1};b.prototype.onViewChange=function(){this._camera=this.view.state.camera;this._screenPositionDirty=!0;this._updateEngineObject()};b.prototype.onElevationChange=
function(a){this.view.renderCoordsHelper.fromRenderCoords(this.position,P,a.spatialReference)&&W.containsPoint(a.extent,P)&&this._refreshMapPoint(!0)};b.prototype._refreshMapPoint=function(a){void 0===a&&(a=!1);switch(this.alignment){case "none":break;case "on-the-ground":var b=X.getElevationAtPoint(this.view.elevationProvider,this.mapPoint,"ground");if(b===this._mapPoint.z&&a)return;this._mapPoint.z=b;break;default:D.neverReached(this.alignment)}this._screenPositionDirty=!0;this._hitResult.onSurface=
!1;this.view.renderCoordsHelper.toRenderCoords(this._mapPoint,this._position);this._updateEngineObject()};b.prototype._updateEngineObject=function(){this._areAnyEngineObjectsVisible=!1;if(this._attached)if(!1===this._get("visible"))this._removeResourcesFromStage();else{var a=this._getWorldToScreenObjectScale(),b=v;!0===this._get("autoScaleRenderObjects")&&(a*=this._getFocusedSize(this._radius,this._focused));this._calculateObjectTransform(a,b);for(var a=this._ensureEngineResources().objectsByState,
c=(this._focused?2:1)|(this._get("selected")?8:4),d=this._get("hideOnGrab")&&this._get("grabbing"),h=0;h<a.length;h++){var f=a[h],g=f.stateMask,f=f.objects;if(d)for(var g=0,e=f;g<e.length;g++)f=e[g],f.hide();else if(e=0===(g&15)||(c&g)===(g&15),g=0===(g&65520)||(this._get("state")&g)===(g&65520),e&&g)for(g=0,e=f;g<e.length;g++)f=e[g],f.unhide(),f.objectTransformation=b,this._areAnyEngineObjectsVisible=!0;else for(g=0,e=f;g<e.length;g++)f=e[g],f.hide()}}};b.prototype._ensureEngineResources=function(){if(k.isNone(this._engineResources)){var a=
this.view._stage.getContent(0,k.expect(this._engineLayerId)),b=[],c=new Set;this.renderObjects.forEach(function(a){a=a.material;c.has(a)||(b.push(a),c.add(a))});var d=function(a,b){var c=b.geometry,d=b.material,l=b.transform;Array.isArray(c)?c.forEach(function(b){return a.addGeometry(b,d,l)}):a.addGeometry(c,d,l)},h=new Map;this.renderObjects.forEach(function(a){var b=new ca({idHint:"manipulator"});d(b,a);a=a.stateMask||0;var c=h.get(a)||[];c.push(b);h.set(a,c)});var f=[];h.forEach(function(a,b){f.push({stateMask:b,
objects:a})});this._engineResources={objectsByState:f,layer:a,materials:b}}this._addResourcesToStage();return this._engineResources};b.prototype._addResourcesToStage=function(){var a=this;if(!this._engineResourcesAddedToStage&&!k.isNone(this._engineResources)){var b=this._engineResources,c=b.objectsByState,d=b.layer;b.materials.forEach(function(b){var c=k.expect(a._materialIdReferences),d=c.get(b.id)||0;0===d&&a.view._stage.add(3,b);c.set(b.id,d+1)});c.forEach(function(b){b.objects.forEach(function(b){d.addObject(b);
a.view._stage.add(1,b)})});this._engineResourcesAddedToStage=!0}};b.prototype._removeResourcesFromStage=function(a){var b=this;void 0===a&&(a=!1);if(this._engineResourcesAddedToStage&&!k.isNone(this._engineResources)){var c=this._engineResources,d=c.layer,h=c.materials;c.objectsByState.forEach(function(a){a.objects.forEach(function(a){d.removeObject(a);b.view._stage.remove(1,a.id)})});h.forEach(function(a){var c=k.expect(b._materialIdReferences),d=c.get(a.id);1===d?(b.view._stage.remove(3,a.id),c.delete(a.id)):
c.set(a.id,d-1)});a&&this.view._stage.remove(0,d.id);this._engineResourcesAddedToStage=!1}};b.prototype._getCollisionRadius=function(a){return this._getFocusedSize(this._radius,!0)*("touch"===a?this._touchMultiplier:1)};b.prototype._getFocusedSize=function(a,b){return a*(b?this._focusMultiplier:1)};b.prototype._getWorldToScreenObjectScale=function(){return this._worldSized?1:this._screenPixelSize};b.prototype._calculateModelTransformPosition=function(a){var b=this._getWorldToScreenObjectScale(),b=
this._calculateObjectTransform(b,ea);return m.vec3.set(a,b[12],b[13],b[14])};b.prototype._calculateModelTransformOffset=function(a){var b=this._calculateModelTransformPosition(a);return m.vec3.subtract(a,b,this._position)};b.prototype._calculateObjectTransform=function(a,b){x.mat4.set(b,a,0,0,0,0,a,0,0,0,0,a,0,0,0,0,1);x.mat4.multiply(b,b,this._modelTransform);b[12]+=this._position[0];b[13]+=this._position[1];b[14]+=this._position[2];b[15]=1;return b};d([c.property({constructOnly:!0,nonNullable:!0})],
b.prototype,"view",void 0);d([c.property({value:"none",nonNullable:!0})],b.prototype,"alignment",null);d([c.property()],b.prototype,"hideOnGrab",void 0);d([c.property()],b.prototype,"moveOnDrag",void 0);d([c.property()],b.prototype,"snapToPointer",void 0);d([c.property()],b.prototype,"collisionType",void 0);d([c.property({type:T.Integer})],b.prototype,"collisionPriority",void 0);d([c.property({constructOnly:!0})],b.prototype,"renderObjects",void 0);d([c.property()],b.prototype,"autoScaleRenderObjects",
void 0);d([c.property({value:!0})],b.prototype,"visible",null);d([c.property()],b.prototype,"radius",null);d([c.property()],b.prototype,"worldSized",null);d([c.property()],b.prototype,"focusMultiplier",null);d([c.property()],b.prototype,"touchMultiplier",null);d([c.property()],b.prototype,"interactive",void 0);d([c.property()],b.prototype,"selectable",void 0);d([c.property()],b.prototype,"cursor",void 0);d([c.property({value:!1})],b.prototype,"grabbing",null);d([c.property()],b.prototype,"dragging",
void 0);d([c.property({value:!1})],b.prototype,"hovering",null);d([c.property({value:!1})],b.prototype,"selected",null);d([c.property({value:0})],b.prototype,"state",null);d([c.property({dependsOn:["hovering","grabbing"]})],b.prototype,"focused",null);return b=d([c.subclass("esri.views.interactive.Manipulator3D")],b)}(c.declared(R));C.Manipulator3D=r;var O={include:new Set};O.include.add(aa.TERRAIN_ID);var H=q.createScreenPointArray(),G=q.createRenderScreenPointArray3(),K=p.lineSegment.create(),A=
p.ray.create(),L=U.mat3f64.create(),ea=y.mat4f64.create(),v=y.mat4f64.create(),w=p.plane.create(),I=n.vec3f64.create(),J=n.vec3f64.create(),B=n.vec3f64.create(),M=n.vec3f64.create(),N=n.vec3f64.create(),da=n.vec3f64.create(),P=n.vec3f64.create()});