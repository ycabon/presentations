// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/SetUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/fieldUtils ../../layers/support/timeUtils ../../support/arcadeOnDemand ../../tasks/support/Query ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils".split(" "),
function(K,f,B,e,L,x,p,q,C,u,v,D,E,d,h,F,G,H,I,J,w){Object.defineProperty(f,"__esModule",{value:!0});var y=C.getLogger("esri.views.layers.FeatureLayerView");f.FeatureLayerView=function(f){return function(f){function b(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];a=f.apply(this,a)||this;a._updatingRequiredFieldsPromise=null;a.effect=null;a.filter=null;a.layer=null;a.requiredFields=null;a.view=null;return a}B(b,f);b.prototype.initialize=function(){var a=this;E.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo timeExtent".split(" "),
function(){return a._handleRequiredFieldsChange()},!0)};Object.defineProperty(b.prototype,"availableFields",{get:function(){var a=this.layer,c=this.layer.fields,b=this.requiredFields;return"outFields"in a&&a.outFields?h.fixFields(c,h.unpackFieldNames(c,a.outFields).concat(b)):h.fixFields(c,b)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(a){y.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!0,configurable:!0});b.prototype.highlight=function(a,c){void 0===c&&(c={});return this.inherited(arguments,[a,c])};b.prototype.createQuery=function(){var a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},a=u.isSome(this.filter)?this.filter.createQuery(a):new H(a);this.timeExtent&&(a.timeExtent=a.timeExtent?a.timeExtent.intersection(this.timeExtent):
this.timeExtent.clone());return a};b.prototype.queryFeatures=function(a,c){return this.inherited(arguments,[a,c])};b.prototype.queryObjectIds=function(a,c){return this.inherited(arguments,[a,c])};b.prototype.queryFeatureCount=function(a,c){return this.inherited(arguments,[a,c])};b.prototype.queryExtent=function(a,c){return this.inherited(arguments,[a,c])};b.prototype._loadArcadeModules=function(a){if(a.get("expressionInfos.length"))return G.loadArcade()};b.prototype._handleRequiredFieldsChange=function(){var a=
this,c=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",c);c.then(function(){a._updatingRequiredFieldsPromise===c&&a._set("_updatingRequiredFieldsPromise",null)})};b.prototype._updateRequiredFields=function(){return p(this,void 0,void 0,function(){var a,c,b,r,k,d,e,f,g,t,l,n,m,A;return x(this,function(z){switch(z.label){case 0:if(!this.layer||!this.view)return[2];a="3d"===this.view.type;c=this;r=b=c.layer;k=r.fields;d=r.objectIdField;e=r.renderer;f=r.displayField;g=new Set;
return[4,v.eachAlways([e?e.collectRequiredFields(g,k):null,h.collectLabelingFields(g,b),a?h.collectElevationFields(g,b):null,u.isSome(this.filter)?h.collectFilterFields(g,b,this.filter):null,this.effect?h.collectFilterFields(g,b,this.effect.filter):null])];case 1:t=z.sent();b.timeInfo&&this.timeExtent&&h.collectFields(g,b.fields,[b.timeInfo.startField,b.timeInfo.endField]);l=0;for(n=t;l<n.length;l++)m=n[l],m.error&&y.error(m.error);h.collectField(g,k,d);a&&f&&h.collectField(g,k,f);A=D.valuesOfSet(g).sort();
this._set("requiredFields",A);return[2]}})})};b.prototype.validateFetchPopupFeatures=function(a){var b=this.layer;if(!this.layer.popupEnabled)return new q("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:b});if(!w.getFetchPopupTemplate(this.layer,a))return new q("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:b})};b.prototype.fetchClientPopupFeatures=function(a){return p(this,void 0,void 0,function(){var b,e,d,k,f,p,q,g,t,l,n,m;return x(this,
function(c){switch(c.label){case 0:b=u.isSome(a)?a.clientGraphics:null;if(!b||0===b.length)return[2,v.resolve([])];e=[];d=[];k=this.layer;f=w.getFetchPopupTemplate(k,a);return u.isSome(f)?[4,this._loadArcadeModules(f)]:[2,v.resolve([])];case 1:return q=(p=c.sent())&&p.arcadeUtils.hasGeometryOperations(f),[4,this.createPopupQuery(a)];case 2:g=c.sent();t=h.unpackFieldNames(k.fields,g.outFields);l=0;for(n=b;l<n.length;l++)m=n[l],q||!h.featureHasFields(t,m)?d.push(m):e.push(m);if("stream"===k.type||0===
d.length)return[2,v.resolve(e)];g.objectIds=d.map(function(a){return a.attributes[k.objectIdField]});return[2,k.queryFeatures(g).then(function(a){return e.concat(a.features)}).catch(function(){return d})]}})})};b.prototype.createPopupQuery=function(a){return p(this,void 0,void 0,function(){var b,d,e;return x(this,function(c){switch(c.label){case 0:return b=this.layer,d=b.createQuery(),d.returnGeometry=!0,d.returnZ=!0,d.returnM=!0,e=d,[4,w.getRequiredFields(this.layer,w.getFetchPopupTemplate(this.layer,
a))];case 1:return e.outFields=c.sent(),d.outSpatialReference=this.view.spatialReference,[2,d]}})})};e([d.property()],b.prototype,"_updatingRequiredFieldsPromise",void 0);e([d.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],b.prototype,"availableFields",null);e([d.property({type:I})],b.prototype,"effect",void 0);e([d.property({type:J})],b.prototype,"filter",void 0);e([d.property(F.combinedViewLayerTimeExtentProperty)],b.prototype,"timeExtent",void 0);e([d.property()],b.prototype,
"layer",void 0);e([d.property({type:Number})],b.prototype,"maximumNumberOfFeatures",null);e([d.property({readOnly:!0,type:Boolean})],b.prototype,"maximumNumberOfFeaturesExceeded",null);e([d.property({readOnly:!0})],b.prototype,"requiredFields",void 0);e([d.property()],b.prototype,"view",void 0);return b=e([d.subclass("esri.views.layers.FeatureLayerView")],b)}(d.declared(f))}});