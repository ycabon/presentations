// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/HandleOwner ../../core/maybe ../../core/scheduling ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/SceneView ../../views/3d/support/earthUtils ./daylightUtils".split(" "),function(t,u,l,d,m,n,p,f,c,q,r,e){var h={spring:new Date("2014-03-20T12:00:00"),summer:new Date("2014-06-21T12:00:00"),fall:new Date("2014-09-23T12:00:00"),winter:new Date("2014-12-21T12:00:00")};
return function(k){function a(b){b=k.call(this,b)||this;b.view=null;b.lightingUpdateInterval=200;b._cachedLightingDateUTC=new Date(0);b._cachedDisplayUTCOffset=0;b._enableShadowsOnFirstInteraction=!0;b._lastLightingUpdate=0;b._nextLightingUpdate=null;b.playSpeedMultiplier=1;b.currentSeason="summer";b.dayPlaying=!1;return b}l(a,k);a.prototype.initialize=function(){var b=this;this.handles.add(f.init(this,"view",function(){b.view&&b.view.when(function(){return b._updateLighting(null)})}));this.handles.add(f.watch(this,
"view.environment.lighting.date",function(a){b._scheduleUpdateLighting(a)}));var a=function(a){var g=b.get("view.environment.lighting");if(g){if(a)a=a.timezoneOffset;else{if(null!=g.displayUTCOffset)return;a=g._calculateTimezoneOffset(g.positionTimezoneInfo)}g.displayUTCOffset=a;b._scheduleUpdateLighting(null)}};this.handles.add(f.on(this,"view.environment.lighting","timezone-will-change",a,a.bind(this,null)));this.handles.add(f.init(this,"view.stationary",function(){(b.dayPlaying||b.yearPlaying)&&
b._updateSunriseAndSunset()}))};a.prototype.destroy=function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null);this.view=null};Object.defineProperty(a.prototype,"isSupported",{get:function(){return!this.view||"3d"===this.view.type},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"utcOffset",{get:function(){return this._cachedDisplayUTCOffset},set:function(b){b!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=b,this._updateLighting(null))},
enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"localDate",{get:function(){return e.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(b){b.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=e.localDateToDateTime(this._lightingDateDisplay,b))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"timeSliderPosition",{get:function(){return e.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(b){Math.abs(b-this.timeSliderPosition)>1/
60&&(this._lightingDateDisplay=e.sliderPosToDateTime(this._lightingDateDisplay,b),this.yearPlaying=this.dayPlaying=!1,this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"_lightingDateDisplay",{get:function(){return e.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(b){b=e.dateAddHours(b,-this._cachedDisplayUTCOffset);b.getTime()!==this.view.environment.lighting.date.getTime()&&
(this.view.environment.lighting.date=b,this._updateLighting(null))},enumerable:!0,configurable:!0});a.prototype._timezoneFromCamera=function(b){b=b.camera.position;b=r.positionToTimezone([b.longitude,b.latitude]);return n.isSome(b)?Math.round(b.hours+b.minutes/60+b.seconds/3600):0};Object.defineProperty(a.prototype,"directShadowsAvailable",{get:function(){return void 0!==this.view._stage.renderView.getRenderParameters().shadowMap},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"dayPlaying",{get:function(){return this._get("dayPlaying")},set:function(b){this.dayPlaying!==b&&(this._set("dayPlaying",b),b&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"yearPlaying",{get:function(){return this._get("yearPlaying")},set:function(b){this.yearPlaying!==b&&(this._set("yearPlaying",
b),b&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1)))},enumerable:!0,configurable:!0});a.prototype._updateLighting=function(b){this._lastLightingUpdate=Date.now();if(this.get("view.environment")){b=b||this.view.environment.lighting.date;var a=this.view.environment.lighting.displayUTCOffset,a=null!==a?a:this._timezoneFromCamera(this.view);this._cachedLightingDateUTC.getTime()!==
b.getTime()&&(this._cachedLightingDateUTC=new Date(b.getTime()));this._cachedDisplayUTCOffset!==a&&(this._cachedDisplayUTCOffset=a)}};a.prototype._scheduleUpdateLighting=function(b){var a=this;if(!this._nextLightingUpdate){var c=Date.now()-this._lastLightingUpdate,c=this.lightingUpdateInterval-c;0>=c?p.schedule(function(){return a._updateLighting(b)}):this._nextLightingUpdate=setTimeout(function(){a._updateLighting(null);a._nextLightingUpdate=null},c)}};a.prototype._play=function(){var b=this,a=this.view;
if(a.environment&&(this.dayPlaying||this.yearPlaying)){var c=(new Date).getTime()-this._lastTime;if(this.dayPlaying){if(this._lastTime=(new Date).getTime(),c*=e.calculatePlaySpeed(this._sunrise,this._sunset,a.environment.lighting.date)*this.playSpeedMultiplier/100,0<c){var d=new Date(a.environment.lighting.date.getTime()+c),f=((d.getUTCHours()+a.environment.lighting.displayUTCOffset)%24+24)%24,h=((a.environment.lighting.date.getUTCHours()+a.environment.lighting.displayUTCOffset)%24+24)%24;f<h&&(d=
new Date(a.environment.lighting.date.getTime()+c-864E5));a.environment.lighting.date=d}}else 1E3<c&&(this._lastTime=(new Date).getTime(),c=(a.environment.lighting.date.getUTCMonth()+1)%12,d=new Date(a.environment.lighting.date.getTime()),d.setUTCMonth(c),a.environment.lighting.date=d);requestAnimationFrame(function(){return b._play()})}};a.prototype._updateSunriseAndSunset=function(){var b=e.getSunriseAndSunsetTimes(this.view.environment.lighting.date,this.view.camera.position.latitude,this.view.camera.position.longitude,
this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(b.sunrise);this._sunset=new Date(b.sunset)};a.prototype.enforceSeasonDate=function(){var b=this.get("view.environment.lighting.date"),a=h[this.currentSeason];b.getTime()!==a.valueOf()&&this.set("view.environment.lighting.date",a)};a.prototype.changeSeason=function(a){this.yearPlaying=this.dayPlaying=!1;a=a.target.value;this.currentSeason!==a&&(this.currentSeason=a,this.localDate=h[this.currentSeason])};d([c.property({type:q})],
a.prototype,"view",void 0);d([c.property({dependsOn:["view.type"]})],a.prototype,"isSupported",null);d([c.property()],a.prototype,"lightingUpdateInterval",void 0);d([c.property()],a.prototype,"_cachedLightingDateUTC",void 0);d([c.property()],a.prototype,"_cachedDisplayUTCOffset",void 0);d([c.property()],a.prototype,"_enableShadowsOnFirstInteraction",void 0);d([c.property({dependsOn:["_cachedDisplayUTCOffset"]})],a.prototype,"utcOffset",null);d([c.property({dependsOn:["_lightingDateDisplay"]})],a.prototype,
"localDate",null);d([c.property({dependsOn:["_lightingDateDisplay"]})],a.prototype,"timeSliderPosition",null);d([c.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],a.prototype,"_lightingDateDisplay",null);d([c.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],a.prototype,"directShadowsEnabled",void 0);d([c.property({dependsOn:["view"],readOnly:!0})],a.prototype,"directShadowsAvailable",null);d([c.property()],a.prototype,"dayPlaying",null);d([c.property()],
a.prototype,"yearPlaying",null);d([c.property()],a.prototype,"playSpeedMultiplier",void 0);d([c.property()],a.prototype,"currentSeason",void 0);d([c.property()],a.prototype,"_lastTime",void 0);d([c.property()],a.prototype,"_sunrise",void 0);d([c.property()],a.prototype,"_sunset",void 0);return a=d([c.subclass("esri.widgets.Daylight.DaylightViewModel")],a)}(c.declared(m.HandleOwner))});