// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../Graphic ../../symbols ../../core/Handles ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/Point ../../geometry/Polyline ../../geometry/projection ../../geometry/SpatialReference ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../views/2d/draw/Draw ../../views/2d/interactive/dragUtils/dragHandlers ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase".split(" "),
function(G,H,v,l,p,n,w,x,y,g,q,r,z,h,t,c,u,A,B,C,D){function E(h,b,c,a){var F=new n.SimpleMarkerSymbol({style:"circle",color:a.handleColor,size:a.handleWidth,outline:{type:"simple-line",width:0}});a=new n.SimpleMarkerSymbol({style:"circle",color:a.handleColor,size:1.5*a.handleWidth,outline:{type:"simple-line",width:0}});h=new p({geometry:h,symbol:F});return new C.GraphicManipulator({view:b,layer:c,graphic:h,focusedSymbol:a})}return function(n){function b(a){a=n.call(this,a)||this;a._drawActive=!1;
a._handles=new w;a._polylineLayer=new u({listMode:"hide"});a._manipulatorLayer=new u({listMode:"hide"});a._vertices=[];a.deferCreation=!0;return a}v(b,n);m=b;b.prototype.initialize=function(){var a=this,b=this.view;this._draw=new A({view:b});b.map.addMany([this._polylineLayer,this._manipulatorLayer]);b.focus();this._handles.add([this.watch("viewModel.unit",function(){0<a._vertices.length&&a._updatePolylines()})]);y.init(this,"view.spatialReference",function(b){m.isProjectionEngineRequired({spatialReference:b})&&
a._loadProjectionEngine()})};b.prototype.destroy=function(){this.detach();this._handles.removeAll();this._polylineLayer.removeAll();var a=this.viewModel,b=a.view.map;b.remove(this._polylineLayer);b.remove(this._manipulatorLayer);a.measurement=null;this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null);this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=
null)};Object.defineProperty(b.prototype,"editable",{set:function(a){this._set("editable",a);a||this._draw.reset()},enumerable:!0,configurable:!0});b.prototype.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()};b.prototype.onShow=function(){this._polylineLayer.visible=!0};b.prototype.onHide=function(){this._polylineLayer.visible=!1};b.prototype.reset=function(){this._vertices=[];this._polylineLayer.removeAll();this.viewModel.measurement=null;this._draw.reset();this._drawActive=
!1;this._updateSketch([])};b.updateViewModelAndCreateGraphics=function(a,b){var f=b.geodesicDistanceThreshold,k=b.palette,d=b.view.spatialReference;a=new z({paths:[a],spatialReference:d});if(d.isGeographic)if(c.isSupported(d))f=c.geodesicLengths([a],"meters")[0],d=c.geodesicDensify(a,1E5);else var f=h.project(a,t.WGS84),e=c.geodesicDensify(f,1E5),f=c.geodesicLengths([f],"meters")[0],d=h.project(e,d);else d.isWebMercator?(f=q.geodesicLength(a,"meters"),d=q.geodesicDensify(a,1E5,"meters")):(e=q.planarLength(a,
"meters"),e>=f?(f=h.project(a,t.WGS84),e=c.geodesicDensify(f,1E5),f=c.geodesicLengths([f],"meters")[0],d=h.project(e,d)):(f=e,d=a));b.measurement={geometry:d,length:f};f=k.pathSecondaryColor;e=k.pathWidth;return[new p({geometry:d,symbol:{type:"simple-line",cap:"butt",join:"round",color:k.pathPrimaryColor,width:e}}),new p({geometry:d,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:f,width:e-2}}),new p({geometry:a.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,
0,0,.5],haloSize:2,text:b.measurementLabel,font:{size:14,family:"sans-serif"}}})]};b.isProjectionEngineRequired=function(a){if(!a)return!1;a=a.spatialReference;if(!a)return!1;var b=a.isGeographic,f=a.isWebMercator,k=a.isWGS84;return b&&!k&&!c.isSupported(a)||!b&&!f};b.isProjectionEngineSupported=function(){return h.isSupported()};b.prototype.onInputEvent=function(a){"pointer-move"===a.type&&this._updateCursor()};b.prototype._loadProjectionEngine=function(){return m.isProjectionEngineSupported()&&
!h.isLoaded()?h.load():x.resolve()};b.prototype._startSketch=function(){var a=this;this._drawActive=!0;var b=this._draw.create("polyline",{mode:"click"});b.on("vertex-add vertex-update vertex-remove cursor-update undo redo".split(" "),function(b){return a._updateSketch(b.vertices)});b.on("draw-complete",function(){a._stopSketch()})};b.prototype._stopSketch=function(){this.manipulators.forEach(function(a){a.manipulator.interactive=!0});this._drawActive=!1;this.complete()};b.prototype._updateSketch=
function(a){var b=this;if(!m.isProjectionEngineRequired(this.view)||h.isLoaded())if(2>a.length)this._vertices=[],this.manipulators.removeAll(),this._polylineLayer.removeAll();else{this.create();for(var f=this.view.spatialReference;this._vertices.length>a.length;){var k=this._vertices.pop().manipulatorId;this.manipulators.remove(k)}for(var k=function(e){var c=a[e],k=c[0],c=c[1],g=new r({x:k,y:c,spatialReference:f}),h=E(g,d.view,d._manipulatorLayer,d.viewModel.palette),g=d.manipulators.add(h);B.createGraphicManipulatorDragHandler2D(d.view,
h,function(){var a=h.graphic.geometry;b._vertices[e].coord=[a.x,a.y];b._updatePolylines()});d._vertices.push({manipulatorId:g,coord:[k,c]})},d=this,e=this._vertices.length;e<a.length;e++)k(e);var k=this._vertices.length-1,e=this._vertices[k],c=a[k],g=c[0],c=c[1];if(e.coord[0]!==g||e.coord[1]!==c)e.coord=[g,c],g=new r({x:g,y:c,spatialReference:f}),this.manipulators.findById(e.manipulatorId).graphic.geometry=g;var l=this._drawActive?this._vertices[k].manipulatorId:null;this.manipulators.forEach(function(a){a.manipulator.interactive=
null==l||a.id!==l});this._updatePolylines()}};b.prototype._updateCursor=function(){this.cursor=this._drawActive?"crosshair":null};b.prototype._updatePolylines=function(){this._polylineLayer.removeAll();var a=this.viewModel,b=this._vertices.map(function(a){return a.coord});(a=m.updateViewModelAndCreateGraphics(b,a))&&this._polylineLayer.addMany(a)};var m;l([g.property({constructOnly:!0})],b.prototype,"view",void 0);l([g.property({constructOnly:!0})],b.prototype,"viewModel",void 0);l([g.property()],
b.prototype,"cursor",void 0);l([g.property({value:!0})],b.prototype,"editable",null);return b=m=l([g.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],b)}(g.declared(D.InteractiveToolBase))});