// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/assignHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/arrayUtils ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/GraphicsLayer ../../layers/graphics/editingSupport ./CreateWorkflow ./UpdateWorkflow ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(L,M,r,e,t,f,g,l,u,v,w,x,y,z,m,d,A,B,C,D,E,F,G,H){function h(d,c,a){I.error(new v(d,c,a))}function J(d){return d&&B.isEditableLayer(d.layer)}function K(d,c){return d&&l.find(d,function(a){return a.layer===c})}var I=y.getLogger("esri.widgets.Editor.EditorViewModel"),q=["create","update"];return function(p){function c(a){var b=p.call(this,a)||this;b._sketchGraphicsLayer=new A({listMode:"hide"});b.activeWorkflow=null;b.activityQueue=[];b.failures=[];b.featureFormViewModel=new E;b.featureTemplatesViewModel=
new F;b.layerInfos=null;b.sketchViewModel=new G({layer:b._sketchGraphicsLayer});b.spinnerViewModel=new H;b._create=function(a){return g(b,void 0,void 0,function(){return f(this,function(b){switch(b.label){case 0:return[4,this._queueOperation(function(){return a.layer.applyEdits({addFeatures:[a]})})];case 1:return b.sent(),[2]}})})};b._update=function(a){return g(b,void 0,void 0,function(){var b=this;return f(this,function(c){switch(c.label){case 0:return[4,this._queueOperation(function(){return a.layer.applyEdits({updateFeatures:[a]})})];
case 1:return c.sent(),this.view.updating?[4,z.create(function(a){return m.whenFalseOnce(b,"view.updating",a)})]:[3,3];case 2:c.sent(),c.label=3;case 3:return[2]}})})};return b}r(c,p);c.prototype.initialize=function(){var a=this;this.handles.add([m.on(this,"activeWorkflow","cancel",function(){return a.emit("workflow-cancel")}),m.on(this,"activeWorkflow","commit",function(){return a.emit("workflow-commit")}),m.on(this,"view.allLayerViews","change",function(){return a.notifyChange("editableItems")}),
m.watch(this,"editableItems",function(){var b=a.activeWorkflow;if(b){var c=b.stepId;"create"===b.type?(a.refreshCreationTemplates(),"awaiting-feature-creation-info"!==c||a.canCreate||a._cancelWorkflow()):"update"===b.type&&("awaiting-feature-to-update"===c&&!a.canUpdate||"awaiting-update-feature-candidate"===c&&!b.data.candidates.some(function(b){var c=a.editableItems.find(function(a){return a.layer===b.layer});return c&&-1<c.supports.indexOf("update")}))&&a._cancelWorkflow()}})])};c.prototype.destroy=
function(){this.view=null;this._cancelWorkflow()};Object.defineProperty(c.prototype,"allowedWorkflows",{get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||(a=q.slice());this._set("allowedWorkflows",a)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"canCreate",{get:function(){return this.editableItems.some(function(a){return-1<a.supports.indexOf("create")})},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"canUpdate",{get:function(){return this.editableItems.some(function(a){return-1<
a.supports.indexOf("update")})},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"editableItems",{get:function(){var a=this,b=this.get("view.allLayerViews");if(!b)return new u;this.handles.remove("layer-view-property-watchers");var c=function(){return a.notifyChange("editableItems")};return b.filter(J).map(function(b){a.handles.add(m.watch(b,["suspended","suspendInfo"],c),"layer-view-property-watchers");var d=b.layer,k=b.suspendInfo;b=[];var e=a.allowedWorkflows,n=d.capabilities.operations,
f=K(a.layerInfos,d),e=e.filter(function(a){return f?!1!==f.enabled&&("create"===a&&!1!==f.addEnabled||"update"===a&&!1!==f.updateEnabled):!0}),k=k.layerInvisible||k.layerNotLoaded||k.outsideScaleRange||k.viewNotReady;!k&&l.find(e,function(a){return"create"===a})&&n.supportsAdd&&b.push("create");!k&&l.find(e,function(a){return"update"===a})&&n.supportsUpdate&&b.push("update");!k&&!1!==(f&&f.deleteEnabled)&&n.supportsDelete&&b.push("delete");return{layer:d,supports:b}}).reverse()},enumerable:!0,configurable:!0});
Object.defineProperty(c.prototype,"state",{get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";var a=this.activeWorkflow;return a?a.stepId:"ready"},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"syncing",{get:function(){return 0<this.activityQueue.length},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"view",{set:function(a){this.sketchViewModel.view=a;this.spinnerViewModel.view=a;this._set("view",a)},enumerable:!0,configurable:!0});
c.prototype.startCreateWorkflowAtFeatureTypeSelection=function(){return g(this,void 0,void 0,function(){var a;return f(this,function(b){switch(b.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Create workflow is unsupported or disabled."),[2]);case 1:return b.sent(),a=this._createCreateWorkflow(),[4,a.start()];case 2:return b.sent(),this._set("activeWorkflow",a),[2]}})})};c.prototype.startCreateWorkflowAtFeatureCreation=function(a){return g(this,void 0,
void 0,function(){var b;return f(this,function(c){switch(c.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return c.sent(),b=this._createCreateWorkflow("awaiting-feature-to-create"),b.data.creationInfo=a,[4,b.start()];case 2:return c.sent(),this._set("activeWorkflow",b),[2]}})})};c.prototype.startCreateWorkflowAtFeatureEdit=function(a){return g(this,void 0,void 0,function(){var b;return f(this,
function(c){switch(c.label){case 0:return this.canCreate?[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return c.sent(),b=this._createCreateWorkflow("editing-new-feature"),b.data.edits.feature=a,[4,b.start()];case 2:return c.sent(),this._set("activeWorkflow",b),[2]}})})};c.prototype.startUpdateWorkflowAtFeatureSelection=function(){return g(this,void 0,void 0,function(){var a;return f(this,function(b){switch(b.label){case 0:return this.canUpdate?
[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return b.sent(),a=this._createUpdateWorkflow(),[4,a.start()];case 2:return b.sent(),this._set("activeWorkflow",a),[2]}})})};c.prototype.startUpdateWorkflowAtMultipleFeatureSelection=function(a){return g(this,void 0,void 0,function(){var b;return f(this,function(c){switch(c.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Update workflow is unsupported or disabled."),
[2]);case 1:return c.sent(),b=this._createUpdateWorkflow("awaiting-update-feature-candidate"),b.data.candidates=a,[4,b.start()];case 2:return c.sent(),this._set("activeWorkflow",b),[2]}})})};c.prototype.startUpdateWorkflowAtFeatureEdit=function(a){return g(this,void 0,void 0,function(){var b;return f(this,function(c){switch(c.label){case 0:return this.canUpdate?[4,this._cancelWorkflow()]:(h("editing:unsupported-workflow","Update workflow is unsupported or disabled."),[2]);case 1:return c.sent(),b=
this._createUpdateWorkflow("editing-existing-feature"),b.data.edits.feature=a,[4,b.start()];case 2:return c.sent(),this._set("activeWorkflow",b),[2]}})})};c.prototype.deleteFeatureFromWorkflow=function(){return g(this,void 0,void 0,function(){var a;return f(this,function(b){switch(b.label){case 0:return a=this.activeWorkflow,a&&"create"!==a.type?[4,this._delete(a.data.edits.feature)]:(h("editing:unsupported-workflow","Deleting requires an active update workflow."),[2]);case 1:return b.sent(),[4,a.reset()];
case 2:return b.sent(),[2]}})})};c.prototype.cancelWorkflow=function(a){return g(this,void 0,void 0,function(){return f(this,function(b){return[2,this._cancelWorkflow(t({warn:!0},a))]})})};c.prototype.refreshCreationTemplates=function(){this.featureTemplatesViewModel.layers=this.editableItems.filter(function(a){return-1<a.supports.indexOf("create")}).map(function(a){return a.layer}).toArray()};c.prototype._cancelWorkflow=function(a){return g(this,void 0,void 0,function(){var b;return f(this,function(c){switch(c.label){case 0:return b=
this.activeWorkflow,b?[4,b.cancel(a)]:(a&&a.warn&&h("editing:no-active-workflow","There is no active workflow to cancel."),[2]);case 1:return c.sent(),this._set("activeWorkflow",null),[2]}})})};c.prototype._createCreateWorkflow=function(a){return C.create(this,a,this._create)};c.prototype._createUpdateWorkflow=function(a){return D.create(this,a,this._update)};c.prototype._delete=function(a){return g(this,void 0,void 0,function(){return f(this,function(b){switch(b.label){case 0:return[4,this._queueOperation(function(){return a.layer.applyEdits({deleteFeatures:[a]})})];
case 1:return b.sent(),[2]}})})};c.prototype._queueOperation=function(a){var b=this;this.activityQueue.push(a);this.notifyChange("syncing");var c=function(a,b){a=b.indexOf(a);-1<a&&b.splice(a,1)};return a().then(function(a){var b=a.deleteFeatureResults,c=a.updateFeatureResults;if(a=l.find(a.addFeatureResults,function(a){return!!a.error})||l.find(c,function(a){return!!a.error})||l.find(b,function(a){return!!a.error}))throw a.error;}).catch(function(d){h("editing:operation-error","An error occurred.",
{error:d});var e={error:d,retry:function(){c(e,b.failures);return b._queueOperation(a)},cancel:function(){c(e,b.failures)}};b._set("failures",b.failures.concat([e]))}).then(function(){c(a,b.activityQueue);b.notifyChange("syncing")})};e([d.property({readOnly:!0})],c.prototype,"activeWorkflow",void 0);e([d.property({readOnly:!0})],c.prototype,"activityQueue",void 0);e([d.property({value:q.slice()})],c.prototype,"allowedWorkflows",null);e([d.property({readOnly:!0,dependsOn:["editableItems"]})],c.prototype,
"canCreate",null);e([d.property({readOnly:!0,dependsOn:["editableItems"]})],c.prototype,"canUpdate",null);e([d.property({dependsOn:["allowedWorkflows","layerInfos","view.allLayerViews","view.ready"],readOnly:!0})],c.prototype,"editableItems",null);e([d.property({readOnly:!0})],c.prototype,"failures",void 0);e([d.property()],c.prototype,"featureFormViewModel",void 0);e([d.property()],c.prototype,"featureTemplatesViewModel",void 0);e([d.property()],c.prototype,"layerInfos",void 0);e([d.property()],
c.prototype,"sketchViewModel",void 0);e([d.property()],c.prototype,"spinnerViewModel",void 0);e([d.property({dependsOn:["editableItems","activeWorkflow.stepId","view.ready"]})],c.prototype,"state",null);e([d.property({readOnly:!0})],c.prototype,"syncing",null);e([d.property()],c.prototype,"view",null);return c=e([d.subclass("esri.widgets.Editor.EditorViewModel")],c)}(d.declared(x.HandleOwnerMixin(w.EventedAccessor)))});