// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/declareExtendsHelper ../../core/arrayUtils ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(F,G,h,x,k,y,z,n,A,q,B,C,D,E,r){return function(w){function c(b){b=w.call(this,b)||this;b.type="update";return b}
y(c,w);l=c;c.create=function(b,e,a){b=new D({edits:new C,viewModel:b});a=new l({data:b,afterCommit:a});a._set("steps",this._createWorkflowSteps(a,e));return a};c.prototype.highlight=function(b){var e=this.data.viewModel.view,e=b&&z.find(e.allLayerViews.items,function(a){return a.layer===b.layer});B.highlightsSupported(e)&&this.handles.add(e.highlight(b),"candidate-highlight")};c.prototype.unhighlight=function(){this.handles.remove("candidate-highlight")};c._createWorkflowSteps=function(b,e){void 0===
e&&(e="awaiting-feature-to-update");var a=b.data,m=b.handles,c={"awaiting-feature-to-update":function(){return{id:"awaiting-feature-to-update",setUp:function(){return k(this,void 0,void 0,function(){var b,f,c,g,e;return h(this,function(d){b=a.viewModel;f=b.spinnerViewModel;c=b.view;g=null;m.add({remove:function(){g&&(g.abort(),g=null)}},this.id);a.edits.feature=null;e=c.on("immediate-click",function(b){b.stopPropagation();f.location=b.mapPoint;f.visible=!0;g&&g.abort();var d=a.viewModel.editableItems;
g=n.createAbortController();n.create(function(a,f){n.onAbort(g.signal,function(){return f(n.createAbortError())});a(r.fetchCandidates(d,c,b))}).then(function(b){a.viewModel.spinnerViewModel.visible=!1;n.throwIfAborted(g);a.candidates=b.reduce(function(a,b){return b.error?a:a.concat(b.value)},[]);0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature")):a.viewModel.activeWorkflow.next())})});m.add(e,this.id);return[2]})})},
tearDown:function(){return k(this,void 0,void 0,function(){return h(this,function(a){m.remove(this.id);return[2]})})}}},"awaiting-update-feature-candidate":function(){return{id:"awaiting-update-feature-candidate",setUp:function(){return k(this,void 0,void 0,function(){var d;return h(this,function(f){d=a.edits;d.feature=null;m.add(A.watch(d,"feature",function(a){b.unhighlight();b.highlight(a)}),this.id);return[2]})})},tearDown:function(){return k(this,void 0,void 0,function(){return h(this,function(a){b.unhighlight();
m.remove(this.id);return[2]})})}}},"editing-existing-feature":function(){return{id:"editing-existing-feature",setUp:function(){return k(this,void 0,void 0,function(){var d,f,c,e=this;return h(this,function(g){d=a.edits.feature;f=a.viewModel;a.editableItem=f.editableItems.find(function(a){return a.layer===d.layer});c=n.createAbortController();m.add({remove:function(){return c.abort()}},this.id);return[2,r.fetchFullFeature(d,f.view,c).then(function(d){return k(e,void 0,void 0,function(){var e,g,k,l,
q,p,t,u,v;return h(this,function(h){switch(h.label){case 0:if(n.isAborted(c))return[2];a.edits.updateGeometry(d.geometry);a.edits.updateAttributes(d.attributes);a.edits.trackChanges();e=d.layer;k=(g=r.findLayerInfo(f.layerInfos,e))&&g.fieldConfig;f.featureFormViewModel.set({feature:d,fieldConfig:k});l=[f.featureFormViewModel.on("value-change",function(){a.edits.updateAttributes(f.featureFormViewModel.getValues());d.attributes=a.edits.feature.attributes})];q=e.capabilities.editing.supportsGeometryUpdate;
if(!q)return[3,2];p=r.getVisualVariableAttributes(d);return[4,r.setUpGeometryUpdate(d,p,f.sketchViewModel,f.view,function(b){var d=b.geometry;b=b.attributes;if(p.rotation){var c=p.rotation.field;f.featureFormViewModel.setValue(c,b[c])}p.size&&(c=p.size.field,f.featureFormViewModel.setValue(c,b[c]));a.edits.updateAttributes(b);a.edits.updateGeometry(d)})];case 1:return t=h.sent(),u=t.interactive,v=t.visual,l.push(u,v),m.add(u,b._handleKeys.beforeCommit),m.add(v,b._handleKeys.afterCommit),[3,3];case 2:b.highlight(d),
h.label=3;case 3:return m.add(l,this.id),[2]}})})})]})})},tearDown:function(){return k(this,void 0,void 0,function(){return h(this,function(d){a.editableItem=null;a.viewModel.featureFormViewModel.set({feature:null,fieldConfig:null});m.remove(this.id);b.unhighlight();return[2]})})}}}},l=!1;return["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature"].filter(function(a){return l?!0:l=a===e}).map(function(a){return c[a]()})};var l;return c=l=x([q.subclass("esri.widgets.Editor.UpdateWorkflow")],
c)}(q.declared(E))});