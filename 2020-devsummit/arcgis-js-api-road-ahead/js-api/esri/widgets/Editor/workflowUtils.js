// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../core/tsSupport/assignHelper ../../core/arrayUtils ../../core/compilerUtils ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/utils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolUtils ../../views/support/drapedUtils".split(" "),
function(N,h,m,n,z,A,B,C,p,D,q,E,F,G,H,v,I){function J(a,d){var c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,e=a.field,g=(a=d.fields&&d.fields.filter(function(a){return a.name===e}))&&1===a.length?a[0].type:"double",b=0,f=0;return{field:e,getValue:function(a){f=b-c*a;return u((f+360)%360,g)},initValue:function(a){b=null!=a?a:f;f=0},isUpdatingInteractively:!1}}function K(a,d){var c=a.field,e=(d=d.fields&&d.fields.filter(function(a){return a.name===c}))&&1===d.length?d[0].type:
"double",g=0,b=0,f=F.meterIn[a.valueUnit],r;r="area"===a.valueRepresentation?function(){return Math.pow(b*f/2,2)*Math.PI}:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?function(){return b*f/2}:function(){return b*f};return{field:c,getValue:function(a){b=g*a;return u(r(),e)},initValue:function(a){g=null!=a?a:b;b=0},isUpdatingInteractively:!1}}function u(a,d){switch(d){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}
function L(a,d,c){return n(this,void 0,void 0,function(){var e,g;return m(this,function(b){switch(b.label){case 0:return 0===a.length?[2,[]]:[4,d.hitTest(c)];case 1:e=b.sent();if(0===e.results.length)return[2,[]];g=new Map;e.results.forEach(function(a){a=a.graphic;var f=a.layer;g.has(f)||g.set(f,[]);g.get(f).push(a)});return[2,p.eachAlways(a.items.filter(function(a){var f=a.layer;return-1<a.supports.indexOf("update")&&g.has(f)}).map(function(a){a=a.layer;var b=a.displayField,c=[a.objectIdField];q.hasField(a.fields,
b)&&c.push(b);b=g.get(a);if(b.some(function(a){return c.some(function(b){return!(b in a.attributes)})})){var f=a.createQuery();f.outFields=c;f.returnGeometry=!1;f.objectIds=b.map(function(a){return a.getObjectId()});return a.queryFeatures(f).then(function(a){return a.features})}return p.resolve(b)}))]}})})}function M(a,d,c){return n(this,void 0,void 0,function(){var e,g;return m(this,function(b){switch(b.label){case 0:return 0===a.length?[2,[]]:[4,d.hitTest(c)];case 1:e=b.sent();if(0===e.results.length)return[2,
[]];g=new Set;e.results.forEach(function(a){return g.add(a.graphic.layer)});return[2,p.eachAlways(a.items.filter(function(a){var b=a.layer;return-1<a.supports.indexOf("update")&&g.has(b)}).map(function(a){a=a.layer;var b=a.displayField,e=[a.objectIdField];q.hasField(a.fields,b)&&e.push(b);b=a.createQuery();b.outFields=e;b.returnGeometry=!1;e=E.calculateTolerance({renderer:a.renderer,event:c});b.geometry=I.createQueryGeometry(c.mapPoint,e,d);return a.queryFeatures(b).then(function(a){return a.features})}))]}})})}
Object.defineProperty(h,"__esModule",{value:!0});h.getVisualVariableAttributes=function(a){var d=a.layer,c;a:switch(d.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":c=!0;break a;default:c=!1}var e=(a=c&&H.getVisualVariableValues(d.renderer,a))?a.map(function(a){return a.variable}):[];c=e.filter(function(a){return"rotation"===a.type&&(!a.axis||"heading"===a.axis)});a=c[0];c=1===c.length&&a.field&&!a.valueExpression;var g=e.filter(function(a){return"size"===
a.type}),e=g[0],g=1===g.length&&"real-world-size"===G.getTransformationType(e)&&e.field&&!e.useSymbolValue&&!e.valueExpression;return{rotation:c&&J(a,d),size:g&&K(e,d)}};h.setUpFeatureAdd=function(a,d,c,e,g){var b=this,f=d.layer;a.layer.elevationInfo=f.elevationInfo;a.create(f.geometryType,{hasZ:f.capabilities.data.supportsZ});var h=a.on("create",function(c){var h=c.state,k=c.graphic,l=c.cancelled;return n(b,void 0,void 0,function(){var b,c;return m(this,function(m){switch(m.label){case 0:if("complete"===
h&&!0===l)return g(),[2];if("complete"!==h)return[3,2];b=k.clone();b.attributes=z({},d.template.prototype.attributes);b.layer=f;a.layer.remove(k);c=b;return[4,v.getDisplayedSymbol(b,{ignoreGraphicSymbol:!0})];case 1:c.symbol=m.sent(),e(b),m.label=2;case 2:return[2]}})})});c.map.add(a.layer);return{remove:function(){h.remove();c.map.remove(a.layer);a.cancel()}}};h.findLayerInfo=function(a,d){return a&&A.find(a,function(a){return a.layer===d})};h.fetchCandidates=function(a,d,c){return n(this,void 0,
void 0,function(){return m(this,function(e){switch(d.type){case "3d":return[2,L(a,d,c)];case "2d":return[2,M(a,d,c)];default:return B.neverReached(d),[2,null]}})})};h.fetchFullFeature=function(a,d,c){var e=a.layer,g=e.createQuery();g.objectIds=[a.getAttribute(e.objectIdField)];g.outFields=["*"];g.outSpatialReference=d.spatialReference;g.returnM=e.capabilities.data.supportsM;g.returnZ=e.capabilities.data.supportsZ;return e.queryFeatures(g,c).then(function(a){return a.features[0]})};h.setUpGeometryUpdate=
function(a,d,c,e,g){return n(this,void 0,void 0,function(){var b,f,h,p,w,k,l,t,x,q,y,u=this;return m(this,function(r){switch(r.label){case 0:return f=b=a.clone(),[4,v.getDisplayedSymbol(b,{ignoreGraphicSymbol:!0})];case 1:return f.symbol=r.sent(),c.layer.add(b),b.sourceLayer=a.layer,h=function(){var b=a.layer;if("graphics"===b.type)return{remove:function(){}};var c=a.attributes[b.objectIdField],d=e.whenLayerView(b);d.then(function(a){return a.setVisibility(c,!1)});return{remove:function(){d.then(function(a){return a.setVisibility(c,
!0)})}}},p=h(),w=a.layer,k=d.size,l=d.rotation,t={multipleSelectionEnabled:!1},"point"===w.geometryType&&(t.enableRotation=!!l,t.enableScaling=!!k),c.layer.elevationInfo=w.elevationInfo,c.update(b,t),x=(!!k||!!l)&&a.watch("attributes",function(a){return n(u,void 0,void 0,function(){var c,e,d,g,f;return m(this,function(h){switch(h.label){case 0:c=!1;for(e in a)d=a[e],d!==b.attributes[e]&&(b.setAttribute(e,d),c=!0,k&&!k.isUpdatingInteractively&&k.field===e&&k.initValue(d),l&&!l.isUpdatingInteractively&&
l.field===e&&l.initValue(d));return c?[4,v.getDisplayedSymbol(b,{ignoreGraphicSymbol:!0})]:[3,2];case 1:g=h.sent(),f=D.diff(b.symbol,g),C.isSome(f)&&(b.symbol=g),h.label=2;case 2:return[2]}})})}),l&&l.initValue(a.attributes[l.field]||0),k&&k.initValue(a.attributes[k.field]||0),q=c.on("update",function(a){var e=a.graphics[0],d=a.cancelled,f=a.toolEventInfo;if("complete"===a.state&&!0===d)c.update(e,t);else{if(l&&f){a=l.field;var d=l.getValue,h=l.initValue;"rotate-stop"===f.type?(l.isUpdatingInteractively=
!1,h()):null!=f.angle&&(l.isUpdatingInteractively=!0,b.attributes[a]=d(f.angle/Math.PI*180))}k&&f&&(a=k.field,d=k.getValue,h=k.initValue,"scale-stop"===f.type?(k.isUpdatingInteractively=!1,h()):null!=f.xScale&&(k.isUpdatingInteractively=!0,b.attributes[a]=d(f.xScale)));g(e.clone())}}),e.map.add(c.layer),y=function(){},[2,{interactive:{remove:function(){q.remove();c.cancel();x&&x.remove();this.remove=y}},visual:{remove:function(){p.remove();e.map.remove(c.layer);c.layer.removeAll();this.remove=y}}}]}})})}});