// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/tsSupport/generatorHelper ../../../core/tsSupport/awaiterHelper ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../tasks/support/AttachmentQuery ../../../tasks/support/Query".split(" "),
function(D,E,v,f,h,l,w,x,m,y,r,n,z,A,k,e,B,t){function p(e,a,b){C.error(new n(e,a,b))}var C=A.getLogger("esri.widgets.FeatureTable.support.FeatureStore");return function(u){function a(b){b=u.call(this,b)||this;b._loaded=!1;b._loadError=!1;b._loading=!1;b._editOperationQueue=[];b._queryOperationQueue=[];b.attachmentsEnabled=!1;b.count=0;b.failures=new r;b.itemCache=new r;b.relatedRecordsEnabled=!1;return b}v(a,u);a.prototype.initialize=function(){var b=this;this.watch("where",function(){return b._reset()})};
a.prototype.destroy=function(){this.layer=null;this.itemCache&&this.itemCache.destroy();this.failures&&this.failures.destroy();this._set("itemCache",null)};Object.defineProperty(a.prototype,"layer",{get:function(){return this._get("layer")||null},set:function(b){this._reset();this._set("layer",b);this.notifyChange("state")},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"orderByFields",{get:function(){return this._get("orderByFields")||[]},set:function(b){y.equals(b,this.orderByFields)||
(this._reset(),this._set("orderByFields",b))},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"querying",{get:function(){return 0<this._queryOperationQueue.length},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"state",{get:function(){var b=this._loaded,c=this._loading;return this._loadError?"error":!this.layer||this.get("layer.loadError")?"disabled":c?"loading":"loaded"===this.get("layer.loadStatus")&&b?"loaded":"ready"},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,
"syncing",{get:function(){return 0<this._editOperationQueue.length},enumerable:!0,configurable:!0});Object.defineProperty(a.prototype,"where",{get:function(){return this._get("where")||"1\x3d1"},set:function(b){this._set("where",b)},enumerable:!0,configurable:!0});a.prototype.load=function(){return l(this,void 0,void 0,function(){var b,c;return h(this,function(a){switch(a.label){case 0:this._reset();b=this.layer;if(!b)return[2,k.resolve()];this._loading=!0;this.notifyChange("state");a.label=1;case 1:return a.trys.push([1,
4,,5]),[4,b.when()];case 2:return a.sent(),[4,this._setCount()];case 3:return a.sent(),this._loading=!1,this._loaded=!0,this.notifyChange("state"),[3,5];case 4:throw c=a.sent(),this._reset(),this._loadError=!0,this.notifyChange("state"),p("store:load-error","An error ocurred.",{error:c}),c;case 5:return[2]}})})};a.prototype.query=function(b){return l(this,void 0,void 0,function(){var c,a,g,e;return h(this,function(d){switch(d.label){case 0:c=this;a=c.layer;g=c.state;if(!a||"loaded"!==g)return[2,k.resolve([])];
this.notifyChange("querying");return[4,this._query(b)];case 1:return e=d.sent(),this.notifyChange("state"),[2,e]}})})};a.prototype.update=function(b){return l(this,void 0,void 0,function(){return h(this,function(a){return[2,this._update(b)]})})};a.prototype.reset=function(){this._reset()};a.prototype.getItemByObjectId=function(b){var a=this.layer.objectIdField;return this.itemCache.find(function(c){return c.feature.attributes[a]===b})};a.prototype.getItemAt=function(b){return this.itemCache.getItemAt(b)};
a.prototype._reset=function(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=!1;this._set("count",0);this.notifyChange("querying");this.notifyChange("syncing");this.notifyChange("state")};a.prototype._getIdsFromFeatures=function(b){var a=this;return b.map(function(b){return b.attributes[a.layer.objectIdField]})};a.prototype._toFeatureData=function(b,a){var c=this.layer.objectIdField;return b.map(function(b){var d=
b.attributes[c];return{feature:b,attachments:a?a[d]:null,relatedRecords:null}})};a.prototype._update=function(b){var a=this,d=this.layer;if(!d.capabilities.operations.supportsUpdate)return k.reject(new n("store:update-error","Update is not supported."));var g=b.name,e=b.value,f=this.getItemByObjectId(b.objectId).feature;if(!f)return k.reject(new n("store:update-error","Feature with provided 'objectId' not found."));var q=z.clone(f.attributes);q[g]=e;b=new w({attributes:q});var h=d.applyEdits({updateFeatures:[b]}).then(function(b){var c=
b.updateFeatureResults;!m.find(c,function(b){return!!b.error})&&-1<a._editOperationQueue.indexOf(function(){return h})&&c&&c.length&&(f.attributes=q);return b});return this._queueEditOperation(function(){return h})};a.prototype._query=function(b){var a=this;if(!0===b.refresh)return this.itemCache.removeAll(),this._setCount().then(function(){return a._queryFeatureData(b)});if(this._hasAllLocalItems(b))return k.resolve(this._getLocalItems(b));this.itemCache.removeAll();return this._queryFeatureData(b)};
a.prototype._queryFeatureData=function(b){return l(this,void 0,void 0,function(){var a=this;return h(this,function(c){return[2,this._queueQueryOperation(function(){return l(a,void 0,void 0,function(){var a,c,d;return h(this,function(g){switch(g.label){case 0:return[4,this._queryFeatures(b)];case 1:return a=g.sent().features,c=this._getIdsFromFeatures(a),[4,this._queryAttachments(c)];case 2:return d=g.sent(),[2,this._toFeatureData(a,d)||[]]}})})})]})})};a.prototype._setCount=function(){var b=this;
return this._queryCount().then(function(a){b._set("count",a)})};a.prototype._queryCount=function(){return this.layer.queryFeatureCount(new t({returnGeometry:!1,where:this.where}))};a.prototype._queryFeatures=function(b){var a=this.layer,d=a.capabilities,g=d.query.supportsOrderBy;if(!d.operations.supportsQuery)return k.reject(new n("store:query-error","Layer does not support query operation."));d=this.orderByFields;b=new t({returnGeometry:!1,outFields:["*"],start:b.start,num:b.num,where:this.where});
g&&(b.orderByFields=d);return a.queryFeatures(b)};a.prototype._queryAttachments=function(b){var a=this.layer,d=this.where,g=a.capabilities,e=g.data.supportsAttachment,g=g.operations.supportsQueryAttachments;return this.attachmentsEnabled?e&&g?a.queryAttachments(new B({objectIds:b,where:d})):(p("store:query-error","Attachments are not supported."),k.resolve(null)):k.resolve(null)};a.prototype._queueQueryOperation=function(b){var a=this;this._queryOperationQueue.push(b);this.notifyChange("querying");
return b().then(function(c){return-1<a._queryOperationQueue.indexOf(b)?(a.itemCache.addMany(c),c):[]}).catch(function(c){p("store:query-error","An error ocurred.",{error:c});var d={error:c,retry:function(){a.failures.remove(d);a._queueQueryOperation(b)},cancel:function(){return a.failures.remove(d)}};a.failures.add(d);return[]}).then(function(c){m.remove(a._queryOperationQueue,b);a.notifyChange("querying");return c})};a.prototype._queueEditOperation=function(b){var a=this;this._editOperationQueue.push(b);
this.notifyChange("syncing");return b().then(function(a){if(a=m.find(a.updateFeatureResults,function(a){return!!a.error}))throw a.error;}).catch(function(c){p("store:edit-error","An error ocurred.",{error:c});var d={error:c,retry:function(){a.failures.remove(d);a._queueEditOperation(b)},cancel:function(){return a.failures.remove(d)}};a.failures.add(d)}).then(function(){m.remove(a._editOperationQueue,b);a.notifyChange("syncing")})};a.prototype._hasAllLocalItems=function(a){var b=this.count,d=a.start,
e=a.num,b=d+e>b?b-d:e;return this._getLocalItems(a).length===b};a.prototype._getLocalItems=function(a){return this._getOrderedItems(a.start,a.num)};a.prototype._getOrderedItems=function(a,c){return this.itemCache.slice(a,a+c).items};f([e.property()],a.prototype,"attachmentsEnabled",void 0);f([e.property({readOnly:!0})],a.prototype,"count",void 0);f([e.property({readOnly:!0})],a.prototype,"failures",void 0);f([e.property({readOnly:!0})],a.prototype,"itemCache",void 0);f([e.property()],a.prototype,
"layer",null);f([e.property()],a.prototype,"orderByFields",null);f([e.property({readOnly:!0})],a.prototype,"querying",null);f([e.property()],a.prototype,"relatedRecordsEnabled",void 0);f([e.property({readOnly:!0,dependsOn:["layer","layer.loadError","layer.loadStatus"]})],a.prototype,"state",null);f([e.property({readOnly:!0})],a.prototype,"syncing",null);f([e.property()],a.prototype,"where",null);return a=f([e.subclass("esri.widgets.FeatureTable.support.FeatureStore")],a)}(e.declared(x))});