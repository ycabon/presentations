// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/Accessor ../../core/Collection ../../core/Handles ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/2d/layers/support/clusterUtils ./support/ActiveLayerInfo".split(" "),function(x,y,q,h,r,t,u,k,e,l,n){var m=t.ofType(n),v="esri.layers.CSVLayer esri.layers.FeatureLayer esri.layers.HeatmapLayer esri.layers.MapImageLayer esri.layers.PointCloudLayer esri.layers.TileLayer esri.layers.StreamLayer esri.layers.SceneLayer esri.layers.GeoRSSLayer esri.layers.GeoJSONLayer esri.layers.GroupLayer esri.layers.ImageryLayer esri.layers.WMSLayer esri.layers.WMTSLayer esri.layers.TileImageryLayer".split(" "),
w=["view.basemapView.baseLayerViews","view.groundView.layerViews","view.layerViews","view.basemapView.referenceLayerViews"];return function(p){function b(a){a=p.call(this,a)||this;a._handles=new u;a._layerViewByLayerId={};a._layerInfosByLayerViewId={};a._activeLayerInfosByLayerViewId={};a.activeLayerInfos=new m;a.basemapLegendVisible=!1;a.groundLegendVisible=!1;a.respectLayerVisibility=!0;a.layerInfos=[];a.view=null;return a}q(b,p);b.prototype.initialize=function(){this._handles.add(k.init(this,"view",
this._viewHandles),"view")};b.prototype.destroy=function(){this._destroyViewActiveLayerInfos();this._handles.destroy();this.view=this._handles=null};Object.defineProperty(b.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0});b.prototype._viewHandles=function(){this._handles.remove("state");this.view&&this._handles.add(k.init(this,"state",this._stateHandles),"state")};b.prototype._stateHandles=function(){this._resetAll();"ready"===this.state&&
this._watchPropertiesAndAllLayerViews()};b.prototype._resetAll=function(){this._handles.remove(["all-layer-views","legend-properties"]);this._destroyViewActiveLayerInfos();this.activeLayerInfos.removeAll()};b.prototype._destroyViewActiveLayerInfos=function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)};b.prototype._destroyViewActiveLayerInfo=function(a){this._handles.remove(a);var c=this._activeLayerInfosByLayerViewId[a];delete this._activeLayerInfosByLayerViewId[a];
c&&c.parent&&c.parent.children.remove(c)};b.prototype._watchPropertiesAndAllLayerViews=function(){var a=this.view.allLayerViews;a.length&&this._refresh();this._handles.add(a.on("change",this._allLayerViewsChangeHandle.bind(this)),"all-layer-views");this._handles.add(k.watch(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),"legend-properties")};b.prototype._allLayerViewsChangeHandle=function(a){var c=this;a.removed.forEach(function(a){return c._destroyViewActiveLayerInfo(a.uid)});
this._refresh()};b.prototype._propertiesChangeHandle=function(){this._destroyViewActiveLayerInfos();this._refresh()};b.prototype._refresh=function(){this._layerInfosByLayerViewId={};this.activeLayerInfos.removeAll();this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this);this._sortActiveLayerInfos(this.activeLayerInfos)};b.prototype._sortActiveLayerInfos=function(a){var c=this;if(!(2>a.length)){var g=
[];a.forEach(function(b){if(!b.parent){var d=b.layer.parent;(d=(d=d&&"uid"in d&&c._layerViewByLayerId[d.uid])&&c._activeLayerInfosByLayerViewId[d.uid])&&-1!==a.indexOf(d)&&(g.push(b),b.parent=d,d.children.add(b),c._sortActiveLayerInfos(d.children))}});a.removeMany(g);var b={};this.view.allLayerViews.forEach(function(a,c){return b[a.layer.uid]=c});a.sort(function(a,c){return(b[c.layer.uid]||0)-(b[a.layer.uid]||0)})}};b.prototype._generateLayerViews=function(){var a=[];w.filter(this._filterLayerViews,
this).map(this.get,this).filter(function(a){return null!=a}).forEach(this._collectLayerViews("layerViews",a));return a};b.prototype._filterLayerViews=function(a){var c=!this.groundLegendVisible&&"view.groundView.layerViews"===a;return!(!this.basemapLegendVisible&&("view.basemapView.baseLayerViews"===a||"view.basemapView.referenceLayerViews"===a))&&!c};b.prototype._collectLayerViews=function(a,c){var b=function(g){g&&g.forEach(function(g){c.push(g);b(g[a])});return c};return b};b.prototype._filterLayerViewsByLayerInfos=
function(a){var c=this,b=this.layerInfos;return b&&b.length?b.some(function(b){return c._hasLayerInfo(b,a)}):!0};b.prototype._hasLayerInfo=function(a,c){var b=this._isLayerUIDMatching(a.layer,c.layer.uid);b&&(this._layerInfosByLayerViewId[c.uid]=a);return b};b.prototype._isLayerUIDMatching=function(a,c){return a&&(a.uid===c||this._hasLayerUID(a.layers,c))};b.prototype._hasLayerUID=function(a,c){var b=this;return a&&a.some(function(a){return b._isLayerUIDMatching(a,c)})};b.prototype._isLayerViewSupported=
function(a){return-1<v.indexOf(a.layer.declaredClass)?(this._layerViewByLayerId[a.layer.uid]=a,!0):!1};b.prototype._generateActiveLayerInfo=function(a){var c=this;this._isLayerActive(a)?this._buildActiveLayerInfo(a):(this._handles.remove(a.uid),this._handles.add(k.watch(a,"suspended, layer.legendEnabled",function(){return c._layerActiveHandle(a)}),a.uid))};b.prototype._layerActiveHandle=function(a){this._isLayerActive(a)&&(this._handles.remove(a.uid),this._buildActiveLayerInfo(a))};b.prototype._isLayerActive=
function(a){return this.respectLayerVisibility?!a.suspended&&a.get("layer.legendEnabled"):!0};b.prototype._buildActiveLayerInfo=function(a){var c=this,b=a.layer,e=a.uid,f=this._layerInfosByLayerViewId[e],d=this._activeLayerInfosByLayerViewId[e];d||(d=new n({layer:b,title:f&&void 0!==f.title?f.title:b.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,sublayerIds:f&&f.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[e]=d);d.parent||(f=(f=b.parent)&&this._layerViewByLayerId[f.uid],
d.parent=f&&this._activeLayerInfosByLayerViewId[f.uid]);if(!this._handles.has(e)){var f=k.watch(b,"title",function(b){return c._titleHandle(b,d,a)}),h=k.watch(b,"renderer?, opacity",function(){return c._constructLegendElements(d,a)}),l=k.whenTrue(this.view,"stationary",function(){return c._scaleHandle(d,a)}),m=k.watch(a,"_effectiveRenderer",function(){return c._constructLegendElements(d,a)}),f=[f,h,l,m];this.respectLayerVisibility&&(h=k.watch(a,"suspended",function(b){return c._suspendedHandle(b,
d,a)}),b=k.watch(b,"legendEnabled",function(b){return c._legendEnabledHandle(b,d,a)}),f.push(h,b));this._handles.add(f,e)}d.isScaleDriven||this._constructLegendElements(d,a);this._addActiveLayerInfo(d,a)};b.prototype._titleHandle=function(a,b,g){b.title=a;this._constructLegendElements(b,g)};b.prototype._legendEnabledHandle=function(a,b,g){a?this._addActiveLayerInfo(b,g):this._removeActiveLayerInfo(b)};b.prototype._suspendedHandle=function(a,b,g){a?this._removeActiveLayerInfo(b):this._addActiveLayerInfo(b,
g)};b.prototype._scaleHandle=function(a,b){a.isScaleDriven&&this._constructLegendElements(a,b)};b.prototype._addActiveLayerInfo=function(a,b){this._isLayerActive(b)&&-1===this.activeLayerInfos.indexOf(a)&&((b=a.parent)?(-1===b.children.indexOf(a)&&b.children.push(a),this._sortActiveLayerInfos(b.children)):(this.activeLayerInfos.add(a),this._sortActiveLayerInfos(this.activeLayerInfos)))};b.prototype._removeActiveLayerInfo=function(a){var b=a.parent;b?b.children.remove(a):this.activeLayerInfos.remove(a)};
b.prototype._constructLegendElements=function(a,b){var c=b.layer;c.featureCollections?a.buildLegendElementsForFeatureCollections(c.featureCollections):c.renderer?a.buildLegendElementsForRenderer(c.renderer):c.url&&a.buildLegendElementsForTools();if(c.featureReduction&&"cluster"===c.featureReduction.type){b=b._effectiveRenderer;var e=(c=c.renderer.clone())&&"visualVariables"in c&&c.visualVariables||[];if(!(b&&"visualVariables"in b&&b.visualVariables))return null;b=l.findSizeVV(b.visualVariables);l.getActiveSizeStops(this.view,
b)&&(c.visualVariables=e.concat([b]),a.buildLegendElementsForRenderer(c))}};h([e.property({type:m})],b.prototype,"activeLayerInfos",void 0);h([e.property()],b.prototype,"basemapLegendVisible",void 0);h([e.property()],b.prototype,"groundLegendVisible",void 0);h([e.property()],b.prototype,"respectLayerVisibility",void 0);h([e.property()],b.prototype,"layerInfos",void 0);h([e.property({dependsOn:["view.ready"],readOnly:!0})],b.prototype,"state",null);h([e.property()],b.prototype,"view",void 0);return b=
h([e.subclass("esri.widgets.Legend.LegendViewModel")],b)}(e.declared(r))});