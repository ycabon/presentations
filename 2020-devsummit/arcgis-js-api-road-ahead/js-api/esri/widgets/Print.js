// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/i18n!./Print/nls/Print ../core/Collection ../core/events ../core/Logger ../core/urlUtils ../core/watchUtils ../core/accessorSupport/decorators ../tasks/support/PrintTemplate ./Widget ./Print/FileLink ./Print/PrintViewModel ./Print/TemplateOptions ./support/widget".split(" "),function(I,J,A,h,e,B,C,D,p,k,g,E,F,v,w,x,b){var y=B.ofType(v),m=D.getLogger("esri.widgets.Print");return function(z){function d(a){a=
z.call(this,a)||this;a._activeTabFocusRequested=!1;a._advancedOptionsVisibleForLayout=!1;a._advancedOptionsVisibleForMapOnly=!1;a._awaitingServerResponse=!1;a._exportedFileNameMap={};a._layoutTabSelected=!0;a._pendingExportScroll=!1;a._rootNode=null;a.allowedFormats=null;a.allowedLayouts=null;a.exportedLinks=new y;a.iconClass="esri-icon-printer";a.label=e.widgetLabel;a.templateOptions=new x;a.printServiceUrl=null;a.view=null;a.viewModel=new w;a._focusOnTabChange=a._focusOnTabChange.bind(a);return a}
A(d,z);d.prototype.postInitialize=function(){var a=this;this.own([k.init(this,"viewModel.templatesInfo",function(b){var c=a.templateOptions,f=c.format,c=c.layout;if(b){var e=c===b.layout.defaultValue||c&&"MAP_ONLY"===c.toUpperCase()||b.layout.choiceList&&-1<b.layout.choiceList.indexOf(c),G=f===b.format.defaultValue||b.format.choiceList&&-1<b.format.choiceList.indexOf(f);e||(c&&m.warn("User sets an invalid layout, resetting it to the default valid one..."),a.templateOptions.layout=b.layout.defaultValue);
G||(f&&m.warn("User sets an invalid format, resetting it to the default valid one..."),a.templateOptions.format=b.format.defaultValue);c&&"MAP_ONLY"===c.toUpperCase()&&(a._layoutTabSelected=!1)}}),k.init(this,"templateOptions.format",function(b){var c=a.viewModel.templatesInfo;if(c&&b){var f=!1;c.format.choiceList&&c.format.choiceList.forEach(function(c){c.toUpperCase()===b.toUpperCase()&&(a.templateOptions.format=c,f=!0)});f||(a.templateOptions.format=c.format.defaultValue,m.warn("User sets an invalid format, resetting it to the default valid one..."));
a.scheduleRender()}}),k.init(this,"templateOptions.layout",function(b){var c=a.viewModel.templatesInfo;if(c&&b){a._layoutTabSelected="MAP_ONLY"!==b.toUpperCase();var f=!a._layoutTabSelected;f||c.layout.choiceList&&c.layout.choiceList.forEach(function(c){c.toUpperCase()===b.toUpperCase()&&(a.templateOptions.layout=c,f=!0)});f||(a.templateOptions.layout=c.layout.defaultValue,m.warn("User sets an invalid layout, resetting it to the default valid one..."));a.scheduleRender()}}),k.init(this,"templateOptions.dpi",
function(b){0>=b?a.templateOptions.dpi=1:a.scheduleRender()}),k.init(this,"viewModel.view.scale",function(b){var c=a.templateOptions,f=c.scale;c.scaleEnabled&&f||(a.templateOptions.scale=b)}),k.whenOnce(this,"printServiceUrl",function(){var b=setTimeout(function(){a._awaitingServerResponse=!0;a.scheduleRender()},500);a.viewModel.load().then(function(){return clearTimeout(b)})})]);var b=this.templateOptions,f=b.height;this.templateOptions.width=b.width||800;this.templateOptions.height=f||1100};d.prototype.render=
function(){var a,c=this.templateOptions,f=c.attributionEnabled,d=c.author,H=c.copyright,g=c.dpi,h=c.format,t=c.height,k=c.layout,m=c.legendEnabled,q=c.scaleEnabled,p=c.scale,u=c.width,c="ready"!==this.get("viewModel.state"),r=this.renderTitleOrFileNameSection(),l=this.get("viewModel.templatesInfo.format.choiceList")||[],l=0<l.length?l.map(function(a){return b.tsx("option",{key:a,selected:a===h,value:a},a.toUpperCase())}):b.tsx("option",{key:"format-default-option"},e.formatDefaultOption),l=b.tsx("div",
{class:"esri-print__form-section-container"},b.tsx("label",null,e.fileFormatTitle,b.tsx("select",{class:"esri-select",onchange:this._updateFromOption,"data-target-property":"format",bind:this},l))),n=this.get("viewModel.templatesInfo.layout.choiceList")||[],n=0<n.length?n.map(function(a){return b.tsx("option",{key:a,selected:a===k,value:a},e[a]||a)}):b.tsx("option",{key:"layout-default-option"},e.layoutDefaultOption),n=b.tsx("div",{class:"esri-print__form-section-container"},b.tsx("label",null,e.layoutTitle,
b.tsx("select",{class:"esri-select",onchange:this._updateFromOption,"data-target-property":"layout",bind:this},n))),g=b.tsx("div",{class:"esri-print__form-section-container"},b.tsx("label",null,e.dpi,b.tsx("input",{type:"number",class:this.classes("esri-print__input-text","esri-input"),"data-input-name":"dpi",oninput:this._updateInputValue,value:""+g,min:"1",tabIndex:0,bind:this}))),q=b.tsx("div",{class:this.classes("esri-print__scale-info-container","esri-print__form-section-container")},b.tsx("label",
null,b.tsx("input",{"data-option-name":"scaleEnabled",checked:q,type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),e.scale),b.tsx("div",{class:"esri-print__scale-input-container"},b.tsx("input",{"aria-label":e.scaleLabel,"aria-valuenow":""+p,role:"spinbutton",type:"number",class:this.classes("esri-print__input-text","esri-input","esri-print__scale-input"),tabIndex:0,"data-input-name":"scale",oninput:this._updateInputValue,disabled:!q,value:""+p,bind:this}),b.tsx("button",{role:"button",
"aria-label":e.reset,class:this.classes("esri-widget--button","esri-print__refresh-button","esri-icon-refresh"),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),d=this._advancedOptionsVisibleForLayout?b.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForLayout",class:"esri-print__advanced-options-container"},q,b.tsx("div",{class:this.classes("esri-print__author-info-container","esri-print__form-section-container")},b.tsx("label",null,e.author,b.tsx("input",{type:"text",value:d,class:this.classes("esri-print__input-text",
"esri-input"),tabIndex:0,"data-input-name":"author",oninput:this._updateInputValue,bind:this}))),b.tsx("div",{class:this.classes("esri-print__copyright-info-container","esri-print__form-section-container")},b.tsx("label",null,e.copyright,b.tsx("input",{type:"text",class:this.classes("esri-print__input-text","esri-input"),tabIndex:0,value:H,"data-input-name":"copyright",oninput:this._updateInputValue,bind:this}))),g,b.tsx("div",{class:this.classes("esri-print__legend-info-container","esri-print__form-section-container")},
b.tsx("label",null,b.tsx("input",{type:"checkbox","data-option-name":"legendEnabled",tabIndex:0,checked:m,onchange:this._toggleInputValue,bind:this}),e.legend))):null,f=this._advancedOptionsVisibleForMapOnly?b.tsx("div",{"aria-labelledby":this.id+"__advancedOptionsForMapOnly",class:"esri-print__advanced-options-container"},q,g,b.tsx("div",{class:"esri-print__form-section-container"},b.tsx("label",null,b.tsx("input",{"data-option-name":"attributionEnabled",type:"checkbox",onchange:this._toggleInputValue,
tabIndex:0,checked:f,bind:this}),e.attribution))):null,t=this._layoutTabSelected?b.tsx("section",{key:"esri-print__layoutContent",id:this.id+"__layoutContent","aria-labelledby":this.id+"__layoutTab",class:"esri-print__layout-section",role:"tabpanel","aria-selected":this._layoutTabSelected},b.tsx("div",{class:"esri-print__panel-container"},r,n,this._layoutTabSelected?l:null),b.tsx("div",{class:this.classes("esri-print__panel-container","esri-print__advanced-options-section")},b.tsx("button",{"aria-label":e.advancedOptions,
"aria-expanded":this._advancedOptionsVisibleForLayout?"true":"false",role:"button",class:"esri-print__advanced-options-button",onclick:this._showAdvancedOptions,bind:this},b.tsx("div",{class:"esri-print__advanced-options-button-container"},b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-right-triangle-arrow","esri-print__advanced-options-button-icon--closed")}),b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-left-triangle-arrow","esri-print__advanced-options-button-icon--closed-rtl")}),
b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-down-arrow","esri-print__advanced-options-button-icon--opened")}),b.tsx("span",{class:"esri-print__advanced-options-button-title"},e.advancedOptions))),d)):b.tsx("section",{key:"esri-print__mapOnlyContent",id:this.id+"__mapOnlyContent","aria-selected":!this._layoutTabSelected,"aria-labelledby":this.id+"__mapOnlyTab",class:"esri-print__map-only-section",role:"tabpanel"},b.tsx("div",{class:"esri-print__panel-container"},r,this._layoutTabSelected?
null:l,b.tsx("div",{class:this.classes("esri-print__size-container","esri-print__form-section-container")},b.tsx("div",{class:"esri-print__width-container"},b.tsx("label",null,e.width,b.tsx("input",{type:"text",class:this.classes("esri-print__input-text","esri-input"),"data-input-name":"width",onchange:this._updateInputValue,value:""+u,tabIndex:0,bind:this}))),b.tsx("div",{class:"esri-print__height-container"},b.tsx("label",null,e.height,b.tsx("input",{type:"text",class:this.classes("esri-print__input-text",
"esri-input"),"data-input-name":"height",onchange:this._updateInputValue,value:""+t,tabIndex:0,bind:this}))),b.tsx("button",{role:"button","aria-label":e.swap,class:this.classes("esri-widget--button","esri-print__swap-button","esri-icon-swap"),onclick:this._switchInput,tabIndex:0,bind:this})),b.tsx("div",{class:this.classes("esri-print__panel-container","esri-print__advanced-options-section")},b.tsx("button",{"aria-label":e.advancedOptions,"aria-expanded":this._advancedOptionsVisibleForMapOnly?"true":
"false",role:"button",class:"esri-print__advanced-options-button",onclick:this._showAdvancedOptions,bind:this},b.tsx("div",{class:"esri-print__advanced-options-button-container"},b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-right-triangle-arrow","esri-print__advanced-options-button-icon--closed")}),b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-left-triangle-arrow","esri-print__advanced-options-button-icon--closed-rtl")}),b.tsx("span",{"aria-hidden":"true",class:this.classes("esri-icon-down-arrow",
"esri-print__advanced-options-button-icon--opened")}),b.tsx("span",{class:"esri-print__advanced-options-button-title"},e.advancedOptions))),f))),f=this.exportedLinks.toArray(),u=this._renderExportedLink(f),r=(a={},a["esri-button--disabled"]=c||!k&&!h,a);a=null!=this.get("view")&&"2d"!==this.get("view.type");d=b.tsx("div",{class:"esri-print__panel--error"},a?e.sceneViewError:e.serviceError);c=b.tsx("div",null,b.tsx("ul",{class:"esri-print__layout-tab-list",role:"tablist",onclick:this._toggleLayoutPanel,
onkeydown:this._handleLayoutPanelKeyDown,bind:this},b.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__layoutTab","data-tab-id":"layoutTab",class:"esri-print__layout-tab",role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected},e.layoutTab),b.tsx("li",{afterCreate:this._focusOnTabChange,afterUpdate:this._focusOnTabChange,id:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab",class:"esri-print__layout-tab",role:"tab",tabIndex:0,"aria-selected":""+
!this._layoutTabSelected},e.mapOnlyTab)),t,b.tsx("button",{"aria-label":e.exportDescription,role:"button",class:this.classes("esri-print__export-button","esri-button",r),disabled:c,tabIndex:0,onclick:this._handlePrintMap,bind:this},e.export),b.tsx("div",{class:"esri-print__export-panel-container",afterUpdate:this._scrollExportIntoView,onclick:this._removeLink,bind:this},b.tsx("h3",{class:this.classes("esri-print__export-title","esri-widget__heading")},e.exportText),0<f.length?null:b.tsx("div",null,
b.tsx("div",null,e.exportHint)),u));c=b.tsx("div",null,b.tsx("div",{class:"esri-print__container"},b.tsx("header",{class:"esri-print__header-title"},e.export),this.error||!this.printServiceUrl||a||!this.view?d:c));c="initializing"===this.get("viewModel.state")?this._renderLoader():c;return b.tsx("div",{afterCreate:b.storeNode,bind:this,class:"esri-print esri-widget esri-widget--panel","data-node-ref":"_rootNode"},c)};d.prototype.renderTitleOrFileNameSection=function(){var a=this.templateOptions,c,
f,d;this._layoutTabSelected?(c=e.title,f=e.titlePlaceHolder,a=a.title,d="title"):(c=e.fileName,f=e.fileNamePlaceHolder,a=a.fileName,d="fileName");return b.tsx("div",{class:"esri-print__form-section-container",key:d},b.tsx("label",null,c,b.tsx("input",{type:"text",tabIndex:0,placeholder:f,class:this.classes("esri-print__input-text","esri-input"),value:a,"data-input-name":d,oninput:this._updateInputValue,bind:this})))};d.prototype._focusOnTabChange=function(a){if(this._activeTabFocusRequested){var b=
a.getAttribute("data-tab-id");if("layoutTab"===b&&this._layoutTabSelected||"mapOnlyTab"===b&&!this._layoutTabSelected)a.focus(),this._activeTabFocusRequested=!1}};d.prototype._renderLoader=function(){var a,c=(a={},a["esri-print__loader"]=this._awaitingServerResponse,a);return b.tsx("div",{class:this.classes(c),key:"loader"})};d.prototype._createFileLink=function(a,b){b=b||e.untitled;a=a.format.toLowerCase();a=-1<a.indexOf("png")?"png":a;var c=b+a;void 0!==this._exportedFileNameMap[c]?this._exportedFileNameMap[c]++:
this._exportedFileNameMap[c]=0;return new v({name:b,extension:a,count:this._exportedFileNameMap[c]})};d.prototype._toPrintTemplate=function(a){var b=a.dpi,f=a.height,d=a.legendEnabled,e=a.width;a=new E({attributionVisible:a.attributionEnabled,layoutOptions:{authorText:a.author||"",copyrightText:a.copyright||"",titleText:a.title||""},forceFeatureAttributes:a.forceFeatureAttributes,format:a.format,layout:a.layout,outScale:a.scale});e&&(a.exportOptions.width=e);f&&(a.exportOptions.height=f);b&&(a.exportOptions.dpi=
b);d||(a.layoutOptions.legendLayers=[]);return a};d.prototype._resetToCurrentScale=function(){this.templateOptions.scale=this.viewModel.view.scale};d.prototype._updateInputValue=function(a){a=a.target;var b=a.getAttribute("data-input-name");this.templateOptions[b]=a.value};d.prototype._handlePrintMap=function(){var a=this;this._pendingExportScroll=!0;var b=this.templateOptions,f=this._toPrintTemplate(b),d=this._createFileLink(f,this._layoutTabSelected?f.layoutOptions.titleText:b.fileName);this.exportedLinks.add(d);
this.viewModel.print(f).then(function(a){d.set({url:a&&a.url,state:"ready"})}).catch(function(){d.set({state:"error"})}).then(function(){return a.scheduleRender()})};d.prototype._updateFromOption=function(a){var b=a.target;a=b.selectedOptions?b.selectedOptions.item(0).value:b.options[b.selectedIndex].value;b=b.getAttribute("data-target-property");this.templateOptions[b]=a};d.prototype._switchInput=function(){var a;a=[this.templateOptions.height,this.templateOptions.width];this.templateOptions.width=
a[0];this.templateOptions.height=a[1]};d.prototype._showAdvancedOptions=function(){this._layoutTabSelected?this._advancedOptionsVisibleForLayout=!this._advancedOptionsVisibleForLayout:this._advancedOptionsVisibleForMapOnly=!this._advancedOptionsVisibleForMapOnly};d.prototype._scrollExportIntoView=function(){if(this._pendingExportScroll){this._pendingExportScroll=!1;var a=this._rootNode,b=this._rootNode,b=b.scrollHeight-b.clientHeight;0<b&&(a.scrollTop=b)}};d.prototype._toggleInputValue=function(a){a=
a.target;var b=a.getAttribute("data-option-name");this.templateOptions[b]=a.checked;"scaleEnabled"===b&&(this.viewModel.scaleEnabled=this.templateOptions.scaleEnabled,this.templateOptions[b]||this._resetToCurrentScale())};d.prototype._removeLink=function(a){(a=a.target["data-item"])&&"error"===a.state&&this.exportedLinks.remove(a)};d.prototype._renderExportedLink=function(a){var c=this;return a.map(function(a){var d,f,g,h=(d={},d["esri-widget__anchor--disabled"]="pending"===a.state||"error"===a.state,
d);(d=""===a.url?null:a.url)&&(d=p.addProxy(d));var k=p.hasSameOrigin(a.url,location.href),k=(f={},f["esri-icon-loading-indicator"]="pending"===a.state,f["esri-rotating"]="pending"===a.state,f["esri-icon-download"]=k&&"ready"===a.state,f["esri-icon-launch-link-external"]=!k&&"ready"===a.state,f["esri-icon-error"]="error"===a.state,f["esri-print__exported-file--error"]="error"===a.state,f);f=(g={},g["esri-print__exported-file--error"]="error"===a.state,g);return b.tsx("div",{"aria-label":"pending"===
a.state?e.pending:"ready"===a.state?e.ready:e.error,key:a.formattedName,class:"esri-print__exported-file"},b.tsx("a",{"aria-label":a.formattedName+". "+e.linkReady,download:a.formattedName,href:d,rel:"noreferrer",tabIndex:0,target:"_blank",class:c.classes("esri-widget__anchor esri-print__exported-file-link",h)},b.tsx("span",{"data-item":a,class:c.classes(k)}),b.tsx("span",{"data-item":a,class:c.classes("esri-print__exported-file-link-title",f)},a.formattedName)))})};d.prototype._toggleLayoutPanel=
function(a){this._toggleTab(a.target.getAttribute("data-tab-id"))};d.prototype._toggleTab=function(a){(this._layoutTabSelected="layoutTab"===a)?(a=this.get("viewModel.templatesInfo.layout.choiceList"),this.templateOptions.layout=a&&a[0]):this.templateOptions.layout="MAP_ONLY";this._activeTabFocusRequested=!0};d.prototype._handleLayoutPanelKeyDown=function(a){var b=C.eventKey(a),d=a.target.getAttribute("data-tab-id");if("Enter"===b||" "===b)this._toggleTab(d),a.preventDefault(),a.stopPropagation();
else if("ArrowLeft"===b||"ArrowRight"===b)this._toggleTab("layoutTab"===d?"mapOnlyTab":"layoutTab"),a.preventDefault(),a.stopPropagation()};h([g.aliasOf("viewModel.allowedFormats")],d.prototype,"allowedFormats",void 0);h([g.aliasOf("viewModel.allowedLayouts")],d.prototype,"allowedLayouts",void 0);h([g.property({type:y}),b.renderable()],d.prototype,"exportedLinks",void 0);h([g.property()],d.prototype,"iconClass",void 0);h([g.property()],d.prototype,"label",void 0);h([b.renderable(),g.property({type:x})],
d.prototype,"templateOptions",void 0);h([g.aliasOf("viewModel.error")],d.prototype,"error",void 0);h([g.aliasOf("viewModel.printServiceUrl")],d.prototype,"printServiceUrl",void 0);h([g.aliasOf("viewModel.view"),b.renderable()],d.prototype,"view",void 0);h([g.property({type:w}),b.renderable(["viewModel.templatesInfo","viewModel.state"])],d.prototype,"viewModel",void 0);return d=h([g.subclass("esri.widgets.Print")],d)}(g.declared(F))});