// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper dojo/i18n!./nls/Search ../../Graphic ../../PopupTemplate ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/geolocationUtils ../../core/Handles ../../core/has ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/Point ../../geometry/SpatialReference ../../portal/Portal ../../renderers/smartMapping/symbology/location ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ../../views/support/layerViewUtils ./LayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/GoTo".split(" "),
function(K,ea,L,f,r,p,t,C,z,M,N,l,O,u,P,Q,R,v,g,w,c,D,S,E,F,T,U,V,W,X,Y,x,G,Z,B,aa,ba){function h(c,b){return c.hasOwnProperty(b)&&null!=c[b]&&""!==c[b]}var m=R.getLogger("esri.widgets.Search.SearchViewModel"),q=N.ofType({key:function(c){return c.layer?"layer":"locator"},base:Z,typeMap:{layer:x,locator:G}}),I=S.WGS84,ca=/<(?:.|\s)*?>/g;return function(H){function b(a){a=H.call(this,a)||this;a._handles=new P;a._gotoController=null;a._searching=null;a._loadingDefaultSources=null;a.allPlaceholder=t.allPlaceholder;
a.autoNavigate=!0;a.autoSelect=!0;a.defaultSources=new q;a.defaultSymbol=new T({url:K.toUrl(Q("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24});a.includeDefaultSources=!0;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.minSuggestCharacters=1;a.popupEnabled=!0;a.popupTemplate=new z({title:t.searchResult,content:"{Match_addr}"});a.portal=E.getDefault();a.resultGraphicEnabled=!0;a.resultGraphic=null;a.results=null;
a.selectedSuggestion=null;a.searchAllEnabled=!0;a.selectedResult=null;a.sources=new q;a.suggestionDelay=150;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;return a}L(b,H);b.prototype.initialize=function(){var a=this;this._handles.add(w.on(this,["defaultSources","sources"],"change",function(){return a.notifyChange("allSources")}))};b.prototype.destroy=function(){this._abortGoTo();this.clearGraphics();this._loadingDefaultSources=null;this._clearLoadingDefaultSources();this._handles.destroy();
this._handles=null};Object.defineProperty(b.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"activeSourceIndex",{get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(a){void 0===a?this._clearOverride("activeSourceIndex"):this._override("activeSourceIndex",a)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"allSources",{get:function(){var a=
this.sources,d=this.defaultSources,e=this.includeDefaultSources,a="function"===typeof e?e.call(null,{sources:a,defaultSources:d}):e?d.concat(a):a,d=this._get("allSources")||new q;d.removeAll();d.addMany(a.filter(Boolean));return d},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||u.supported()},set:function(a){if(void 0===a)this._clearOverride("locationEnabled");else{var d=u.supported();if(a&&!d){var e=new l("locationEnabled:geolocation-unsupported",
"Geolocation API is unsupported.",{geolocation:navigator.geolocation});m.error(e)}this._override("locationEnabled",a&&d)}},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"placeholder",{get:function(){var a=this.activeSourceIndex,d=this.allPlaceholder,d=void 0===d?t.allPlaceholder:d;return-1===a?d:(a=this.allSources.getItemAt(a))?a.placeholder:""},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",
a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",null);""===a&&this._clear()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._searching?"searching":this._loadingDefaultSources?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!0,configurable:!0});b.prototype.load=function(){return p(this,void 0,void 0,function(){var a=this;return r(this,function(d){this._handles.add([w.init(this,
["portal","includeDefaultSources"],function(){return a._loadPortal()}),w.init(this,["view","portal","includeDefaultSources"],function(){return a._loadDefaultSources()})]);return[2]})})};b.prototype.clear=function(){this.searchTerm=""};b.prototype.clearGraphics=function(){this._removeHighlight();this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};b.prototype.search=function(a,d){var e=this;this.emit("search-start");this.clearGraphics();var b=
this._createSuggestionForSearch(a);this._searching=a=this._whenViewAndPortalLoaded().then(function(){return e._getResultsFromSources(b,d).then(function(a){var d={activeSourceIndex:e.activeSourceIndex,searchTerm:b.text,numResults:0,numErrors:0,errors:[],results:[]};e._formatResponse(d,a,b);a=e._getFirstResult(d.results);var k=(b.location&&a?a.name:b.text).replace(ca,"");e._set("searchTerm",k);(b.key&&"number"===typeof b.sourceIndex||b.location)&&e._set("selectedSuggestion",b);e._set("results",d.results);
e.emit("search-complete",d);return e._selectFirstResult(a).then(function(){return d})})}).then(function(a){e._clearSearching();return a},function(a){e._clearSearching();throw a;});this.notifyChange("state");return a};b.prototype.searchNearby=function(a){var d=this;if(!this.locationEnabled){var b=new l("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});m.error(b);return g.reject(b)}this._searching=b=u.getCurrentPosition().then(function(b){return u.positionToPoint({position:b,
view:d.view},a)}).then(function(b){return d.search(b,a)});this.notifyChange("state");b.catch(function(){}).then(function(){return d._clearSearching()});return b};b.prototype.select=function(a){var d=this;this.clearGraphics();if(!a){var b=new l("select:missing-parameter","Cannot select without a searchResult.",{searchResult:a});m.error(b);return g.reject(b)}var k=this.view,J=h(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),c=this.allSources.getItemAt(J);if(!c)return b=new l("select:missing-source",
"Cannot select without a source.",{source:c}),m.error(b),g.reject(b);var b=c instanceof x?this._getLayerSourcePopupTemplate(c):c.popupTemplate,f=c.resultSymbol||this._getDefaultSymbol(a),da=h(c,"resultGraphicEnabled")?c.resultGraphicEnabled:this.resultGraphicEnabled,r=h(c,"autoNavigate")?c.autoNavigate:this.autoNavigate,p=h(c,"popupEnabled")?c.popupEnabled:this.popupEnabled,t=p?b||this.popupTemplate:null,n=a.feature;if(!n)return b=new l("select:missing-feature","Cannot select without a feature.",
{feature:n}),m.error(b),g.reject(b);var u=n.attributes,q=n.geometry,w=n.layer,z=n.sourceLayer,A=B.getPointFromGeometry(q),b={layerViewQuery:this._getLayerView(n),elevationQuery:k&&v.isSome(A)?B.getPointWithElevation(A,k).catch(function(){return A}):g.resolve(A)};return g.eachAlways(b).then(function(b){var e=b.layerViewQuery.value,y=b.elevationQuery.value;f instanceof X&&(f.text=a.name);b=k&&r?d._getGoToTarget(a,c):null;return(v.isSome(b)?d._goToSearchResult(b):g.resolve()).then(function(){var b=e?
n:new C({geometry:q,symbol:f,attributes:u,layer:w,sourceLayer:z,popupTemplate:t}),g=p&&d.get("view.popup");(g=g&&b.getEffectivePopupTemplate(g.defaultPopupTemplateEnabled))&&k.popup.open({features:[b],location:y});e&&Y.highlightsSupported(e)&&!g&&d._highlightFeature({graphic:b,layerView:e});!e&&da&&k&&k.graphics.push(b);d._set("selectedResult",a);d._set("resultGraphic",b);d.emit("select-result",{result:a,source:c,sourceIndex:J});return a})})};b.prototype.suggest=function(a,b,e){var d=this,c=a||this.searchTerm;
this.emit("suggest-start",{searchTerm:c});return this._suggestTimer(b,e).then(function(){return d._suggestImmediate(c,e).then(function(a){d._set("suggestions",a.results);d.emit("suggest-complete",a);return a})})};b.prototype._loadPortal=function(){var a=this.portal;this.includeDefaultSources&&a&&!a.loaded&&a.load()};b.prototype._clearLoadingDefaultSources=function(){this._loadingDefaultSources=null;this.notifyChange("state")};b.prototype._clearSearching=function(){this._searching=null;this.notifyChange("state")};
b.prototype._convertHelperServices=function(){var a=this.get("portal.helperServices.geocode");return a?a.map(function(a){if(!1!==a.placefinding&&(a=G.fromJSON(a),aa.isArcGISWorldGeocoder(a.get("locator.url"))&&a.set({singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],placeholder:t.placeholder,defaultZoomScale:2500}),a.singleLineFieldName))return a}).filter(Boolean):[]};b.prototype._convertApplicationProperties=function(){var a=this,b=this.get("view.map.applicationProperties.viewing.search"),
e=this.get("view.map");if(!e||!b)return[];var k=b.hintText;return b.enabled?b.layers.map(function(b){var d=e.findLayerById(b.id);if(d){b=a._getLayerJSON(b);var c=x.fromJSON(b);c.placeholder=k;a._getLayer(d,b).then(function(a){c.layer=a});return c}}).filter(Boolean):[]};b.prototype._getSubLayer=function(a,b){return a&&a.allSublayers?(a=a.allSublayers.find(function(a){return a.id===b.subLayer}))?a.createFeatureLayer():g.reject():g.reject()};b.prototype._getLayer=function(a,b){var d=this;if("feature"===
a.type||"scene"===a.type)return g.resolve(a);if("map-image"===a.type)return a.load().then(function(){return d._getSubLayer(a,b).catch(function(){var b=new l("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:a});m.error(b);return null})})};b.prototype._getLayerJSON=function(a){return"function"===typeof a.toJSON?a.toJSON():a};b.prototype._updateDefaultSources=function(){var a=this.defaultSources,b=this.includeDefaultSources;a.removeAll();b&&a.addMany(this._convertApplicationProperties().concat(this._convertHelperServices()));
this.notifyChange("allSources")};b.prototype._abortGoTo=function(){this._gotoController&&this._gotoController.abort();this._gotoController=null};b.prototype._clear=function(){this._abortGoTo();this._set("results",null);this._set("suggestions",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};b.prototype._closePopup=function(){var a=this.get("view.popup"),b=this.resultGraphic;if(a&&b){var e=a.selectedFeature;e&&e===b&&a.close()}};b.prototype._suggestTimer=
function(a,b){return g.after(null!=a?a:this.suggestionDelay,null,b&&b.signal)};b.prototype._createLocationForSearch=function(a){return a instanceof C?B.getPointFromGeometry(a.geometry):a instanceof D?a:Array.isArray(a)&&2===a.length?new D({longitude:a[0],latitude:a[1]}):null};b.prototype._createSuggestionForSearch=function(a){if(a&&h(a,"key")&&h(a,"text")&&h(a,"sourceIndex"))return a;var b=this._createLocationForSearch(a),e="string"===typeof a?a:this.searchTerm,k=this.selectedSuggestion,c=this.selectedResult,
f=(a=!a&&k&&c)&&k.location;return a&&k.key===c.key&&k.sourceIndex===c.sourceIndex||f?k:{location:v.unwrap(b),text:b?"":e,sourceIndex:null,key:null}};b.prototype._getFirstResult=function(a){var b=null;a&&a.some(function(a){a=a.results[0];var d=!!a;d&&(b=a);return d});return b};b.prototype._selectFirstResult=function(a){return this.autoSelect&&a?this.select(a):g.resolve()};b.prototype._suggestImmediate=function(a,b){var d=this;return this._whenViewAndPortalLoaded().then(function(){return d._getSuggestionsFromSources(a,
b)}).then(function(b){var e={activeSourceIndex:d.activeSourceIndex,searchTerm:a,numResults:0,numErrors:0,errors:[],results:[]};d._formatResponse(e,b);return e})};b.prototype._formatSourceResponse=function(a,b,e){var d=b&&b.value||[];b=b&&b.error;var c=this.allSources.getItemAt(e);b?(a.errors.push({sourceIndex:e,source:c,error:b}),a.numErrors++):(a.results.push({sourceIndex:e,source:c,results:d}),a.numResults+=d.length)};b.prototype._formatResponse=function(a,b,e){var d=this;if(b)if(-1===a.activeSourceIndex){var c=
e&&h(e,"sourceIndex")&&-1!==e.sourceIndex?e.sourceIndex:void 0;b.forEach(function(b,e){d._formatSourceResponse(a,b,void 0!==c?c:e)})}else this._formatSourceResponse(a,b[0],a.activeSourceIndex)};b.prototype._getResultsFromSources=function(a,b){var d=this,c=this.allSources,f=!a.location&&h(a,"sourceIndex")?a.sourceIndex:this.activeSourceIndex,y=[];if(!c.length)return c=new l("search:no-sources-defined","At least one source is required.",{allSources:c}),m.error(c),g.reject(c);-1===f?c.forEach(function(c,
e){y.push(d._getResultsFromSource(a,e,b))}):y.push(this._getResultsFromSource(a,f,b));return g.eachAlways(y)};b.prototype._getSuggestionsFromSources=function(a,b){var d=this,c=this.allSources,f=this.activeSourceIndex,h=[];if(!c.length)return c=new l("suggest:no-sources-defined","At least one source is required.",{allSources:c}),m.error(c),g.reject(c);-1===f?c.forEach(function(c,e){h.push(d._getSuggestionsFromSource(a,e,b))}):h.push(this._getSuggestionsFromSource(a,f,b));return g.eachAlways(h)};b.prototype._getResultsFromSource=
function(a,b,c){var d=this.allSources.getItemAt(b),e=a.location,e=void 0===e?null:e,f=this.get("view.spatialReference")||I,g=h(d,"maxResults")?d.maxResults:this.maxResults,l=d instanceof x&&h(d,"exactMatch")?d.exactMatch:!1;return d.getResults({view:this.view,sourceIndex:b,location:e,suggestResult:a,spatialReference:f,exactMatch:l,maxResults:g},c)};b.prototype._getSuggestionsFromSource=function(a,b,c){var d=this.allSources.getItemAt(b),e=h(d,"suggestionsEnabled")?d.suggestionsEnabled:this.suggestionsEnabled,
f=a.length,l=h(d,"minSuggestCharacters")?d.minSuggestCharacters:this.minSuggestCharacters;return e&&a.trim()&&f>=l?(e=this.get("view.spatialReference")||I,f=h(d,"maxSuggestions")?d.maxSuggestions:this.maxSuggestions,d.getSuggestions({view:this.view,sourceIndex:b,suggestTerm:a,spatialReference:e,maxSuggestions:f},c)):g.resolve()};b.prototype.createDefaultSymbol=function(a,b){if("point"===b)return new W({color:a.color,size:a.size,outline:{color:a.outline.color,width:a.outline.width}});if("polyline"===
b)return new V({color:a.color,width:a.width});if("polygon"===b)return new U({color:a.color,outline:{color:a.outline.color,width:a.outline.width}})};b.prototype._getLayerSourcePopupTemplate=function(a){var b=a.layer;if(b)return h(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};b.prototype._getSourceIndexOfResult=function(a){var b=null;this.results.some(function(d){return d.results.some(function(c){return c===a?(b=d.sourceIndex,!0):!1})});return b};b.prototype._getGoToTarget=function(a,b){var d=
a.extent;a=a.feature;return b instanceof x?a||d:d||a};b.prototype._goToSearchResult=function(a){return p(this,void 0,void 0,function(){var b,c,f;return r(this,function(d){switch(d.label){case 0:return b=!!a,this._abortGoTo(),this._gotoController=c=g.createAbortController(),f={target:{target:a},options:{animate:b,signal:c.signal}},[4,this.callGoTo(f)];case 1:return d.sent(),this._gotoController=null,[2]}})})};b.prototype._whenViewAndPortalLoaded=function(){var a=this.includeDefaultSources,b=this.portal,
c=this.view,c=c?c.when():g.resolve(),a=b&&a?b.when():g.resolve();return g.eachAlways([c,a]).then(function(){})};b.prototype._loadDefaultSources=function(){return p(this,void 0,void 0,function(){var a,b,c=this;return r(this,function(d){switch(d.label){case 0:return this._loadingDefaultSources=b=(a=this.includeDefaultSources)?this._whenViewAndPortalLoaded():g.resolve(),this.notifyChange("state"),[4,b.catch(function(){}).then(function(){c._loadingDefaultSources===b&&(c._clearLoadingDefaultSources(),
c._updateDefaultSources())})];case 1:return d.sent(),[2]}})})};b.prototype._getDefaultSymbol=function(a){var b=this.get("view.map.basemap.id");a=v.get(a,"feature","geometry","type");return v.isSome(a)&&(b=(b=F.getSchemes({basemap:b,geometryType:a})||F.getSchemes({basemap:"topo",geometryType:a}))&&b.primaryScheme)?(b.color&&h(b,"opacity")&&(b.color.a=b.opacity),this.createDefaultSymbol(b,a)):this.defaultSymbol};b.prototype._removeHighlight=function(){this._handles.remove("highlight")};b.prototype._getLayerView=
function(a){return p(this,void 0,void 0,function(){var b,c;return r(this,function(d){switch(d.label){case 0:b=this.view;if(!a||!b)return[2,g.resolve(null)];c=a.layer;return[4,b.when()];case 1:return d.sent(),[2,b.whenLayerView(c)]}})})};b.prototype._highlightFeature=function(a){var b=a.graphic,c=b.attributes,f=b.layer.objectIdField;a=a.layerView.highlight(c&&c[f]||b);this._handles.add(a,"highlight")};b.ALL_INDEX=-1;f([c.property({readOnly:!0,dependsOn:["activeSourceIndex","allSources.length"],value:null})],
b.prototype,"activeSource",null);f([c.property({dependsOn:["allSources.length","searchAllEnabled"]})],b.prototype,"activeSourceIndex",null);f([c.property()],b.prototype,"allPlaceholder",void 0);f([c.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],b.prototype,"allSources",null);f([c.property()],b.prototype,"autoNavigate",void 0);f([c.property()],b.prototype,"autoSelect",void 0);f([c.property({readOnly:!0})],b.prototype,"defaultSources",void 0);
f([c.property()],b.prototype,"defaultSymbol",void 0);f([c.property()],b.prototype,"includeDefaultSources",void 0);f([c.property()],b.prototype,"locationEnabled",null);f([c.property()],b.prototype,"maxInputLength",void 0);f([c.property()],b.prototype,"maxResults",void 0);f([c.property()],b.prototype,"maxSuggestions",void 0);f([c.property()],b.prototype,"minSuggestCharacters",void 0);f([c.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],
b.prototype,"placeholder",null);f([c.property()],b.prototype,"popupEnabled",void 0);f([c.property({type:z})],b.prototype,"popupTemplate",void 0);f([c.property({type:E})],b.prototype,"portal",void 0);f([c.property()],b.prototype,"resultGraphicEnabled",void 0);f([c.property({readOnly:!0})],b.prototype,"resultGraphic",void 0);f([c.property({readOnly:!0})],b.prototype,"results",void 0);f([c.property({readOnly:!0})],b.prototype,"selectedSuggestion",void 0);f([c.property()],b.prototype,"searchAllEnabled",
void 0);f([c.property({readOnly:!0})],b.prototype,"selectedResult",void 0);f([c.property()],b.prototype,"searchTerm",null);f([c.property({type:q})],b.prototype,"sources",void 0);f([c.property({readOnly:!0,dependsOn:["allSources.length"]})],b.prototype,"state",null);f([c.property()],b.prototype,"suggestionDelay",void 0);f([c.property({readOnly:!0})],b.prototype,"suggestions",void 0);f([c.property()],b.prototype,"suggestionsEnabled",void 0);f([c.property()],b.prototype,"view",void 0);f([c.property()],
b.prototype,"clear",null);return b=f([c.subclass("esri.widgets.Search.SearchViewModel")],b)}(c.declared(ba.GoToMixin(O.EventedMixin(M))))});