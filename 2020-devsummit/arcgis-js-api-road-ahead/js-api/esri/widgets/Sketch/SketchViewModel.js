// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.16/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/assignHelper ../../core/tsSupport/declareExtendsHelper ../../core/tsSupport/decorateHelper ../../core/tsSupport/generatorHelper ../../core/tsSupport/awaiterHelper ../../geometry ../../Graphic ../../symbols ../../core/Collection ../../core/compilerUtils ../../core/Error ../../core/Evented ../../core/Handles ../../core/Logger ../../core/maybe ../../core/screenUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/coordsUtils ../../layers/GraphicsLayer ../../support/elevationInfoUtils ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../views/DOMContainer ../../views/3d/interactive/editingTools/isSupportedGraphicUtils ../../views/3d/interactive/editingTools/graphicMove3D/isSupportedGraphic ../../views/3d/interactive/editingTools/graphicReshape3D/isSupportedGraphic ../../views/3d/interactive/editingTools/graphicTransform3D/isSupportedGraphic ../../views/draw/Draw ../../views/draw/support/createUtils ../../views/draw/support/layerUtils ../../views/input/InputManager ./support/OperationHandle @dojo/framework/shim/Promise".split(" "),
function(G,ka,v,W,q,A,B,J,w,E,X,Y,Z,aa,P,ba,y,F,K,l,Q,ca,da,N,O,H,ea,R,fa,S,ga,ha,u,T,t,I){function L(l,e){var a=l.history.undo.pop().updates,b=[];e.forEach(function(c,d){d=a[d];var h={};null!=d&&(y.isSome(d.geometry)&&(h.geometry=c.geometry,c.geometry=d.geometry),y.isSome(d.symbol)&&(h.symbol=c.symbol,c.symbol=d.symbol),b.push(h))});l.history.redo.push({updates:b})}function M(l,e){var a=l.history.redo.pop().updates,b=[];e.forEach(function(c,d){d=a[d];var h={};null!=d&&(y.isSome(d.geometry)&&(h.geometry=
c.geometry,c.geometry=d.geometry),y.isSome(d.symbol)&&(h.symbol=c.symbol,c.symbol=d.symbol),b.push(h))});l.history.undo.push({updates:b})}function D(l){return{updates:l.map(function(e){return{geometry:e.geometry}})}}function V(l){return{updates:l.map(function(e){return{symbol:e.symbol}})}}function C(l){return"requireError"in l&&"aborted"===l.requireError}var ia=ba.getLogger("esri.widgets.Sketch.SketchViewModel"),ja=["Backspace","Delete"];return function(U){function e(a){a=U.call(this,a)||this;a._activeFillGraphic=
null;a._activeLineGraphic=null;a._centerIndicatorGraphic=null;a._centerSymbol=new H({style:"cross",size:6,color:[255,255,255]});a._defaultSegmentOffset=48;a._handles=new P;a._internalGraphicsLayer=new ca({listMode:"hide"});a._lineGraphic=null;a._operationHandle=null;a._vertexGraphics=[];a._viewHandles=new P;a._doUnnormalization=!1;a.activeFillSymbol=new N({style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}});a.activeLineSymbol=new O({color:[12,207,255,1],width:2,style:"dash"});a.activePointSymbol=
new H({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}});a.activeVertexSymbol=new H({style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}});a.createGraphic=null;a.defaultCreateOptions={mode:"hybrid"};a.defaultUpdateOptions={enableMidpoints:!0,enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,tool:"transform",enableZ:!0};a.layer=null;a.pointSymbol=new H({style:"circle",
size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});a.polygonSymbol=new N({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}});a.polylineSymbol=new O({color:[130,130,130,1],width:2});a.updateGraphics=new X;a.updateOnGraphicClick=!0;a.updatePointSymbol=new H({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}});a.updatePolygonSymbol=new N({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}});a.updatePolylineSymbol=new O({color:[12,207,255],width:2});
a.vertexSymbol=new H({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});return a}W(e,U);e.prototype.initialize=function(){var a=this;this._handles.add([K.watch(this,"layer",function(){a.cancel();a._internalGraphicsLayer.elevationInfo=y.isSome(a.layer)?a.layer.elevationInfo:null}),K.on(this,"view.map.layers","change",function(b){0<=b.removed.indexOf(a.layer)&&a.cancel()}),K.on(this,"layer.graphics","change",function(b){if(y.isSome(a._operationHandle)){var c=0;for(b=b.removed;c<
b.length;c++){var d=b[c];a.updateGraphics.includes(d)&&(1<a.updateGraphics.length?a._operationHandle.removeFromSelection(d):a._operationHandle.cancel())}}}),K.init(this,"layer.elevationInfo",function(){a.cancel();a._internalGraphicsLayer.elevationInfo=y.isSome(a.layer)?a.layer.elevationInfo:null},!0)])};e.prototype.destroy=function(){this.cancel();this._handles.removeAll();this._handles=null;this._viewHandles.removeAll();this._viewHandles=null;this._removeDefaultLayer();this._draw&&this._draw.destroy();
this._set("view",null);this.emit("destroy")};Object.defineProperty(e.prototype,"_defaultUpdateTool",{get:function(){return"3d"===this.view.type?"move":"transform"},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"_draw",{get:function(){return"ready"===this.state||"active"===this.state?new ha({view:this.view}):null},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"activeTool",{get:function(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:
null},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"activeComponent",{get:function(){return this._operationHandle?this._operationHandle.activeComponent:null},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"state",{get:function(){var a=!(!this.get("view.ready")||!this.layer),b=this._operationHandle;return a&&b?"active":a?"ready":"disabled"},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"view",{get:function(){return this._get("view")},set:function(a){var b=
this,c=this._get("view");if(c){var d=c.map;c.container&&(c.cursor=null);d&&d.remove(this._internalGraphicsLayer);this._viewHandles.removeAll();this.cancel()}this._doUnnormalization=null!=a&&"3d"===a.type&&"global"===a.viewingMode;this._handles.remove("view-ready");a&&this._handles.add(K.when(a,"ready",function(c){b._viewHandles.removeAll();c&&b._viewHandles.add(b._generateViewHandles(a))},!0),"view-ready");this._set("view",a)},enumerable:!0,configurable:!0});e.prototype.cancel=function(){this._moduleLoaderAbortController&&
(this._moduleLoaderAbortController.abort(),this._moduleLoaderAbortController=null);this._operationHandle&&this._operationHandle.cancel()};e.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete()};e.prototype.delete=function(){var a=this.updateGraphics;if("active"===this.state&&a.length){var b=this.activeTool,c=this.layer,a=a.toArray();c.removeMany(a);this.cancel();this._emitDeleteEvent({graphics:a,tool:b})}};e.prototype.create=function(a,b){var c=this;if("disabled"===
this.state)this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel.");else if(this.cancel(),a){var d=this._setupCreateOperation(a,b);y.isNone(d)||(T.addUniqueLayer(this.view,this._internalGraphicsLayer),d.on("complete",function(){if(d===c._operationHandle){var b=c.createGraphic,g=c._operationHandle.cancelled;c._operationHandle.destroy();c._operationHandle=
null;c._set("createGraphic",null);c.view&&c.view.map&&c.view.map.remove(c._internalGraphicsLayer);d.cancelled||c.layer.add(b);c.emit("create",{graphic:b,state:"complete",cancelled:g,tool:a,toolEventInfo:null,type:"create"})}}),this._operationHandle=d,this.view.ready&&ea.isDOMContainer(this.view)&&this.view.focus())}else this._logError("sketch:missing-parameter","Missing parameter 'tool'.")};e.prototype.update=function(a,b){return B(this,void 0,void 0,function(){var c,d,h,g,f,e,k,p=this;return A(this,
function(n){switch(n.label){case 0:c=this;d=c.layer;h=c.state;g=c.view;if("disabled"===h)return d||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),g||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),[2];this.cancel();f=Array.isArray(a)?a:[a];return f&&f.length?(e=f.some(function(a){return a.layer!==d?(p._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),
!0):y.isNone(a.geometry)?(p._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):"2d"!==g.type||g.spatialReference.equals(a.geometry.spatialReference)?!1:(p._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with a spatial reference different from the supplied MapView."),!0)}))?[2]:[4,this._setupUpdateOperation(f,b)]:(this._logError("sketch:missing-parameter","Missing parameter 'graphics'."),
[2]);case 1:k=n.sent();if(y.isNone(k)||C(k))return[2];T.addUniqueLayer(this.view,this._internalGraphicsLayer);this.emit("update",{graphics:f,state:"start",cancelled:!1,tool:k.tool,toolEventInfo:null,type:"update"});this._setUpdateOperationHandle(k);return[2]}})})};e.prototype.undo=function(){this.canUndo()&&this._operationHandle.undo()};e.prototype.redo=function(){this.canRedo()&&this._operationHandle.redo()};e.prototype.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())};
e.prototype.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())};e.prototype.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()};Object.defineProperty(e.prototype,"snapToScene",{set:function(a){this._operationHandle&&this._operationHandle.setSnapToScene&&this._operationHandle.setSnapToScene(a);this._set("snapToScene",a)},enumerable:!0,configurable:!0});e.prototype._getFirstHit=function(a){return B(this,
void 0,void 0,function(){var b;return A(this,function(c){switch(c.label){case 0:return[4,this.view.hitTest(a)];case 1:return b=c.sent(),0<b.results.length?[2,{screenPoint:a,results:[b.results[0]]}]:[2,{screenPoint:a,results:[]}]}})})};e.prototype._generateViewHandles=function(a){var b=this;return[a.on("immediate-click",function(a){var c=b._operationHandle,h=b.defaultUpdateOptions,g=b.layer,f=b.state,e=b.updateGraphics,k=b.updateOnGraphicClick,c="active"===f&&"create"===c.type;"disabled"!==f&&!c&&
k&&b._getFirstHit(F.createScreenPointFromEvent(a)).then(function(c){c=c.results;c.length?c.some(function(a){if(a.graphic){a=a.graphic;if(-1<e.indexOf(a))return!0;if(a.layer===g)return b.update([a],v({},h)),!0}return!1})&&a.stopPropagation():"active"===f&&b.cancel()})},t.ViewEventPriorities.WIDGET)]};e.prototype._setupCreateOperation=function(a,b){if(!a)return null;b=v({hasZ:"3d"===this.view.type,defaultZ:0},this.defaultCreateOptions,b);var c;switch(a){case "point":c=this._setupCreatePointOperation(a,
b);break;case "multipoint":c=this._setupCreateMultipointOperation(a,null);break;case "polygon":case "polyline":c=this._setupCreatePolyOperation(a,b);break;case "rectangle":c=this._setupCreateRectangleOperation(a,b);break;case "circle":c=this._setupCreateCircleOperation(a,b)}return c};e.prototype._setupCreatePointOperation=function(a,b){var c=this,d={elevationInfo:this.layer.elevationInfo,hasZ:b.hasZ,defaultZ:b.defaultZ};b=this._draw.create(a,d);b.snapToScene=this._getDefaultSnapToScene(d.elevationInfo);
var d=[b.on("cursor-update",function(a){y.isSome(a.coordinates)?c._displayCrosshairCursor():c._displayDefaultCursor()}),b.on("draw-complete",function(a){a=c.createPointFromVertex(a.coordinates);a=new w(a,c.pointSymbol);c._set("createGraphic",a);g&&g.complete()})],h=[this.view.on("key-down",function(a){"Escape"===a.key&&g&&g.cancel()},t.ViewEventPriorities.WIDGET)],g=this._operationHandleForCreateAction(b,d.concat(h),a);return g};e.prototype._setupCreateMultipointOperation=function(a,b){var c=this;
b=this._draw.create(a,b);var d=null,h=[],g=this._operationHandleForCreateAction(b,h,a);h.push(b.on("vertex-add",function(b){var h=b.type,k=b.vertexIndex,f=b.vertices,g=f[k];d=b;c._drawMultipointGraphic(f,!0);c.emit("create",{graphic:c.createGraphic,state:1===f.length?"start":"active",cancelled:!1,tool:a,toolEventInfo:{added:g,vertices:[{coordinates:g,componentIndex:0,vertexIndex:k}],type:h},type:"create"})}),b.on("vertex-remove",function(b){var h=b.type,k=b.vertexIndex,f=b.vertices,g=f[k];d=b;c._drawMultipointGraphic(f,
!0);c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{removed:g,vertices:[{coordinates:g,componentIndex:0,vertexIndex:k}],type:h},type:"create"})}),b.on("vertex-update",function(b){var h=b.type,k=b.vertexIndex,f=b.vertices,g=f[k];d=b;c._drawMultipointGraphic(f,!0);c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{type:h,updated:g,vertices:[{coordinates:g,componentIndex:0,vertexIndex:k}]},type:"create"})}),b.on("cursor-update",
function(a){d=a}),b.on("draw-complete",function(a){a=a.vertices.slice(0);(a=u.createMultipoint(a,c.view.spatialReference))&&c.createGraphic&&(c.createGraphic.geometry=a);g&&g.complete()}),b.on("undo",function(a){a=a.vertices;var b=d&&"cursor-update"!==d.type;c._resetCreateOperationGraphics();a.length&&c._drawMultipointGraphic(a,b)}),b.on("redo",function(a){a=a.vertices;var b=d&&"cursor-update"!==d.type;c._resetCreateOperationGraphics();a.length&&c._drawMultipointGraphic(a,b)}));h.push(this.view.on("pointer-move",
function(){return c._displayCrosshairCursor()},t.ViewEventPriorities.WIDGET),this.view.on("key-down",function(a){return c._getCommonUpdateOperationKeyDownHandlers(g,a)},t.ViewEventPriorities.WIDGET));return g};e.prototype._snapToScene3D=function(a,b){a=this.view.toMap(a,{exclude:[this._internalGraphicsLayer]});y.isSome(a)&&"3d"===this.view.type&&(a.z=da.getZForElevationMode(a,this.view,b));return a};e.prototype._getDefaultSnapToScene=function(a){var b=this;if("2d"===this.view.type)return null;var c=
null;return(c=y.isSome(this.snapToScene)?this.snapToScene:y.isSome(a)?"absolute-height"===a.mode:!0)?function(a,c){return b._snapToScene3D(a,c)}:null};e.prototype._setupCreatePolyOperation=function(a,b){var c=this;b=v({},b,{elevationInfo:this.layer.elevationInfo});var d=null;"polyline"===a?d=this._draw.create(a,b):"polygon"===a&&(d=this._draw.create(a,b));var h=new J.Point,g=null,f=!1;d.snapToScene=this._getDefaultSnapToScene(b.elevationInfo);b=[d.on("vertex-add",function(b){var d=b.type,k=b.vertexIndex,
h=b.vertices,m=h[k];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c.emit("create",{graphic:c.createGraphic,state:1===h.length?"start":"active",cancelled:!1,tool:a,toolEventInfo:{added:m,vertices:[{coordinates:m,componentIndex:0,vertexIndex:k}],type:d},type:"create"})}),d.on("vertex-remove",function(b){var d=b.type,k=b.vertexIndex,h=b.vertices,m=h[k];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,
tool:a,toolEventInfo:{removed:m,vertices:[{coordinates:m,componentIndex:0,vertexIndex:k}],type:d},type:"create"})}),d.on("vertex-update",function(b){var d=b.type,k=b.vertexIndex,h=b.vertices,m=h[k];c._snap(a,h,f);g=b;c._drawVertexGraphics(a,h,{userClicked:!0});c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{type:d,updated:m,vertices:[{coordinates:m,componentIndex:0,vertexIndex:k}]},type:"create"})}),d.on("cursor-update",function(b){var d=b.type,k=b.vertices;
b.mapPoint&&(c._snap(a,k,f),g=b,h=b.mapPoint,c._drawVertexGraphics(a,k,{userClicked:!1}),1<k.length&&c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{coordinates:k[k.length-1],type:d},type:"create"}))}),d.on("draw-complete",function(b){b=b.vertices.slice(0);var d=null;"polyline"===a?d=u.createPolyline([b],c.view.spatialReference,c._doUnnormalization):"polygon"===a&&(d=u.createPolygon([b],c.view.spatialReference,c._doUnnormalization,!0));d&&(c.createGraphic.geometry=
d);n&&n.complete()}),d.on("undo",function(b){b=b.vertices;var d=g&&"cursor-update"!==g.type;c._resetCreateOperationGraphics();c._snap(a,b,f);b.length&&c._drawVertexGraphics(a,b,{userClicked:d})}),d.on("redo",function(b){b=b.vertices;var d=g&&"cursor-update"!==g.type;c._resetCreateOperationGraphics();c._snap(a,b,f);b.length&&c._drawVertexGraphics(a,b,{userClicked:d})})];var e=[this.view.on("pointer-move",function(a){c.view.toMap(F.createScreenPoint(a.x,a.y))?c._displayCrosshairCursor():c._displayDefaultCursor()},
t.ViewEventPriorities.WIDGET),this.view.on("key-down",function(b){var k=d.vertices.slice(0),h=g&&"cursor-update"!==g.type;"Control"===b.key?"2d"!==c.view.type||f||(f=!0,c._snap(a,k,!h),c._drawVertexGraphics(a,k,{userClicked:h})):"z"===b.key&&n&&n.canUndo()?(b.stopPropagation(),n.undo()):"r"===b.key&&n&&n.canRedo()?(b.stopPropagation(),n.redo()):"Escape"===b.key&&n&&n.cancel()},t.ViewEventPriorities.WIDGET),this.view.on("key-up",function(b){var k=d.vertices.slice(0),m=g&&"cursor-update"!==g.type;"Control"===
b.key&&f&&(m||(k.pop(),k.push([h.x,h.y]),c._drawVertexGraphics(a,k,{userClicked:m})),f=!1)},t.ViewEventPriorities.WIDGET)];if("polygon"===a){var k=function(a,b,d){if(!a||!a.layer||!a.visible)return!1;a=c.view.toScreen(a.geometry);return c._isWithinScreenDistance(a,b,d)},p=!1;e.push(this.view.on("pointer-move",function(){p=!1},t.ViewEventPriorities.WIDGET),this.view.on("pointer-down",function(a){var b;b=2>=c._vertexGraphics.length?void 0:k(c._vertexGraphics[0],a,c._getVertexIntersectDistance());b?
(p=!0,a.stopPropagation()):c._vertexGraphics.some(function(b){return k(b,a,c._getVertexIntersectDistance())})&&a.stopPropagation()},t.ViewEventPriorities.WIDGET),this.view.on("pointer-up",function(a){p&&(a.stopPropagation(),d.complete())}))}var n=this._operationHandleForCreateAction(d,b.concat(e),a);return n};e.prototype._setupCreateCircleOperation=function(a,b){var c=this;b=v({},b,{elevationInfo:this.layer.elevationInfo});var d=this._draw.create(a,b),h=!1,g=!0;d.snapToScene=this._getDefaultSnapToScene(b.elevationInfo);
b=[d.on("vertex-add",function(b){var k=b.type,f=b.vertexIndex;b=b.vertices;var m=b[f];c._drawSegmentGraphic(a,b,{centered:g,constrained:h},d.viewAlignedCoordinateSystem);c.emit("create",{graphic:c.createGraphic,state:1===b.length?"start":"active",cancelled:!1,tool:a,toolEventInfo:{added:m,vertices:[{coordinates:m,componentIndex:0,vertexIndex:f}],type:k},type:"create"})}),d.on("cursor-update",function(b){var k=b.type;b=b.vertices;c._drawSegmentGraphic(a,b,{centered:g,constrained:h},d.viewAlignedCoordinateSystem);
2===b.length&&c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{coordinates:b[b.length-1],type:k},type:"create"})}),d.on("draw-complete",function(a){a=a.vertices.slice(0);var b=null;1===a.length?(a.push(d.viewAlignedCoordinateSystem.makeMapPoint(a[0][0]+c._defaultSegmentOffset*c.view.resolution,a[0][1])),b=u.createCircle(a,d.viewAlignedCoordinateSystem,!0)):b=h?u.createEllipse(a,d.viewAlignedCoordinateSystem,g):u.createCircle(a,d.viewAlignedCoordinateSystem,
g);c.createGraphic?c.createGraphic.geometry=b:(c._removeCreateGraphic(),c._set("createGraphic",new w(b,c.polygonSymbol)));e&&e.complete()})];var f=[this.view.on("pointer-move",function(a){y.isSome(d.getCoordsFromScreenPoint(F.createScreenPoint(a.x,a.y)))?c._displayCrosshairCursor():c._displayDefaultCursor()},t.ViewEventPriorities.WIDGET),this.view.on("key-down",function(b){"Control"===b.key?h||(h=!0,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Alt"===
b.key?g&&(g=!1,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Escape"===b.key&&e&&e.cancel()},t.ViewEventPriorities.WIDGET),this.view.on("key-up",function(b){"Control"===b.key?(h=!1,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Alt"===b.key&&(g=!0,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem))},t.ViewEventPriorities.WIDGET)],e=this._operationHandleForCreateAction(d,
b.concat(f),a);return e};e.prototype._setupCreateRectangleOperation=function(a,b){var c=this;b=v({},b,{elevationInfo:this.layer.elevationInfo});var d=this._draw.create(a,b),h=!1,g=!1;d.snapToScene=this._getDefaultSnapToScene(b.elevationInfo);b=[d.on("vertex-add",function(b){var k=b.type,f=b.vertexIndex;b=b.vertices;var e=b[f];d.snapToScene=null;null!=d.defaultZ&&2<b[0].length&&(d.defaultZ=b[0][2]);c._drawSegmentGraphic(a,b,{centered:g,constrained:h},d.viewAlignedCoordinateSystem);c.emit("create",
{graphic:c.createGraphic,state:1===b.length?"start":"active",cancelled:!1,tool:a,toolEventInfo:{added:e,vertices:[{coordinates:e,componentIndex:0,vertexIndex:f}],type:k},type:"create"})}),d.on("cursor-update",function(b){var k=b.type;b=b.vertices;c._drawSegmentGraphic(a,b,{centered:g,constrained:h},d.viewAlignedCoordinateSystem);2===b.length&&c.emit("create",{graphic:c.createGraphic,state:"active",cancelled:!1,tool:a,toolEventInfo:{coordinates:b[b.length-1],type:k},type:"create"})}),d.on("draw-complete",
function(a){a=a.vertices.slice(0);var b=null;1===a.length&&(g=h=!1);b=h?u.createSquare(a,d.viewAlignedCoordinateSystem,g):u.createRectangle(a,d.viewAlignedCoordinateSystem,g);c.createGraphic?c.createGraphic.geometry=b:(c._removeCreateGraphic(),c._set("createGraphic",new w(b,c.polygonSymbol)));e&&e.complete()})];var f=[this.view.on("pointer-move",function(a){y.isSome(d.getCoordsFromScreenPoint(F.createScreenPoint(a.x,a.y)))?c._displayCrosshairCursor():c._displayDefaultCursor()},t.ViewEventPriorities.WIDGET),
this.view.on("key-down",function(b){"Control"===b.key?h||(h=!0,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Alt"===b.key?g||(g=!0,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Escape"===b.key&&e&&e.cancel()},t.ViewEventPriorities.WIDGET),this.view.on("key-up",function(b){"Control"===b.key?(h=!1,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem)):"Alt"===b.key&&
(g=!1,c._drawSegmentGraphic(a,d.vertices,{centered:g,constrained:h},d.viewAlignedCoordinateSystem))},t.ViewEventPriorities.WIDGET)],e=this._operationHandleForCreateAction(d,b.concat(f),a);return e};e.prototype._setupUpdateOperation=function(a,b){return B(this,void 0,void 0,function(){var c,d,h,g,f,e,k,p,n,m,x,l;return A(this,function(z){c=this;d=c._defaultUpdateTool;h=c.defaultUpdateOptions;g=c.layer;f=c.view;e=v({},h,b);k=e.tool||d;p=0;for(n=a;p<n.length;p++)m=n[p],g.remove(m),g.add(m);if("3d"===
f.type){if(0===a.length)return[2,null];switch(k){case "move":return[2,this._setupMove3DOperation(a,e,f,k)];case "reshape":if(1<a.length){this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics.");break}x=S.isSupportedGraphic(a[0]);if(0===x)return[2,this._setupReshape3DOperation(a[0],e,f)];this._logError("sketch:reshape","Reshape operation not supported for provided graphic(s) ("+R.isSupportedGraphicResultMessage(x)+").");break;case "transform":return 1===a.length&&
0===ga.isSupportedGraphic(a[0])?[2,this._setupPointTransform3DOperation(a[0],e,f)]:[2,this._setupMove3DOperation(a,e,f,k)]}return[2,null]}if("move"===k)return[2,this._setupMoveOperation(a,e,f)];if(1<a.length)return"reshape"===k?(this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),[2,null]):[2,this._setupTransformOrReshapeOperation(a,k,e,f)];if(1===a.length){m=a[0];l=y.get(m.geometry,"type");if("point"===l||"multipoint"===l)return[2,this._setupMoveOperation(a,
e,f)];if("transform"===k||"reshape"===k)return[2,this._setupTransformOrReshapeOperation(a,k,e,f)]}return[2,null]})})};e.prototype._setupMove3DOperation=function(a,b,c,d,h){void 0===h&&(h=!1);return B(this,void 0,void 0,function(){var g,e,l,k,p,n,m,x,z=this;return A(this,function(f){switch(f.label){case 0:g=0;for(e=a;g<e.length;g++)if(l=e[g],k=fa.isSupportedGraphic(l),0!==k)return this._logError("sketch:move","Move operation not supported for provided graphic(s) ("+R.isSupportedGraphicResultMessage(k)+
")."),[2,null];return[4,this._requireModule(new Promise(function(a,b){G(["../../views/3d/interactive/editingTools"],a,b)}))];case 1:p=f.sent();if(C(p))return[2,p];n=new p.module.GraphicMove3DTool({view:c,enableZ:b.enableZ});this.view.tools.add(n);n.graphics.addMany(a);h||this.updateGraphics.addMany(a);m=[];x=new I.OperationHandle({activeComponent:n,tool:d,type:"update",onEnd:function(){m.forEach(function(a){return a.remove()});m.length=0;z.view.tools.remove(n);n.destroyed||n.destroy()},undo:function(){L(x,
z.updateGraphics.toArray());z._emitUndoEvent({graphics:z.updateGraphics.toArray(),tool:d})},redo:function(){M(x,z.updateGraphics.toArray());z._emitRedoEvent({graphics:z.updateGraphics.toArray(),tool:d})},addToSelection:function(a){z.updateGraphics.push(a);n.graphics.push(a);z.emit("update",{graphics:z.updateGraphics.toArray(),state:"active",cancelled:!1,tool:z.activeTool,toolEventInfo:{added:[a],type:"selection-change"},type:"update"})},removeFromSelection:function(a){var b=z.updateGraphics.indexOf(a);
x.history.undo.forEach(function(a){return a.updates.splice(b,1)});x.history.redo.forEach(function(a){return a.updates.splice(b,1)});z.updateGraphics.remove(a);0===z.updateGraphics.length?x.complete():n.graphics.remove(a)},toggleTool:function(){return B(z,void 0,void 0,function(){var a,h;return A(this,function(k){switch(k.label){case 0:if(1!==this.updateGraphics.length||!1===b.toggleToolOnClick||"transform"!==d)return[2];a=this.updateGraphics.getItemAt(0);return 0!==S.isSupportedGraphic(a)?[2]:[4,
this._setupReshape3DOperation(a,b,c,!0)];case 1:h=k.sent();if(C(h))return[2];x.onEnd();x.destroy();this._setUpdateOperationHandle(h);return[2]}})})}});m.push.apply(m,this._getHandlesForComponent(x,b).concat([this.view.on("immediate-click",function(a){return z._getCommonUpdateOperationClickHandlers(x,a)},t.ViewEventPriorities.WIDGET),this.view.on("key-down",function(a){return z._getCommonUpdateOperationKeyDownHandlers(x,a)},t.ViewEventPriorities.WIDGET)]));return[2,x]}})})};e.prototype._setupPointTransform3DOperation=
function(a,b,c){return B(this,void 0,void 0,function(){var d,h,e,f,l,k,p,n,m=this;return A(this,function(g){switch(g.label){case 0:return d="transform",h=b.enableRotation,e=b.enableScaling,f=b.enableZ,[4,this._requireModule(new Promise(function(a,b){G(["../../views/3d/interactive/editingTools"],a,b)}))];case 1:l=g.sent();if(C(l))return[2,l];k=new l.module.GraphicTransform3DTool({graphic:a,view:c,enableRotation:h,enableScaling:e,enableZ:f,snapToScene:this.snapToScene});this.view.tools.add(k);this.updateGraphics.add(a);
p=[];n=new I.OperationHandle({activeComponent:k,tool:d,type:"update",onEnd:function(){p.forEach(function(a){return a.remove()});p.length=0;m.view.tools.remove(k);k.destroyed||k.destroy()},undo:function(){L(n,m.updateGraphics.toArray());m._emitUndoEvent({graphics:m.updateGraphics.toArray(),tool:d})},redo:function(){M(n,m.updateGraphics.toArray());m._emitRedoEvent({graphics:m.updateGraphics.toArray(),tool:d})},addToSelection:function(a){return B(m,void 0,void 0,function(){var d;return A(this,function(h){switch(h.label){case 0:return this.updateGraphics.add(a),
[4,this._setupMove3DOperation(this.updateGraphics.toArray(),b,c,"transform",!0)];case 1:d=h.sent();if(C(d))return[2];n.onEnd();n.destroy();this._setUpdateOperationHandle(d);return[2]}})})},setSnapToScene:function(a){k.snapToScene=a}});p.push.apply(p,this._getHandlesForComponent(n,b).concat([this.view.on("immediate-click",function(a){return m._getCommonUpdateOperationClickHandlers(n,a)},t.ViewEventPriorities.WIDGET),this.view.on("key-down",function(a){return m._getCommonUpdateOperationKeyDownHandlers(n,
a)},t.ViewEventPriorities.WIDGET)]));return[2,n]}})})};e.prototype._setupMoveOperation=function(a,b,c){return B(this,void 0,void 0,function(){var d,h,e,f,l,k,p=this;return A(this,function(g){switch(g.label){case 0:return d=[],h="move",a.forEach(function(a){d.push(new w(a.geometry,a.symbol,a.attributes));a.symbol=p._getUpdateSymbol(a.geometry)}),this.updateGraphics.addMany(a),[4,this._getGraphicMover(a,b,c)];case 1:e=g.sent();if(C(e))return[2,e];f=new I.OperationHandle({activeComponent:e,tool:h,type:"update",
onEnd:function(){k.forEach(function(a){return a.remove()});l.forEach(function(a){return a.remove()});k=[];l=[];e.destroy();p._internalGraphicsLayer&&p._internalGraphicsLayer.removeMany(p.updateGraphics.toArray());p.updateGraphics.forEach(function(a,b){a.symbol=d[b].symbol})},undo:function(){L(f,p.updateGraphics.toArray());p._emitUndoEvent({graphics:p.updateGraphics.toArray(),tool:h})},redo:function(){M(f,p.updateGraphics.toArray());p._emitRedoEvent({graphics:p.updateGraphics.toArray(),tool:h})},addToSelection:function(a){d.push(new w(a.geometry,
a.symbol,a.attributes));a.symbol=p._getUpdateSymbol(a.geometry);p.updateGraphics.push(a);e.graphics=p.updateGraphics.toArray();p.emit("update",{graphics:p.updateGraphics.toArray(),state:"active",cancelled:!1,tool:p.activeTool,toolEventInfo:{added:[a],type:"selection-change"},type:"update"})},removeFromSelection:function(a){var b=p.updateGraphics.indexOf(a);f.history.undo.forEach(function(a){return a.updates.splice(b,1)});f.history.redo.forEach(function(a){return a.updates.splice(b,1)});var c=d.splice(b,
1)[0];a.symbol=c.symbol;p.updateGraphics.remove(a);0===p.updateGraphics.length?f.complete():e.graphics=p.updateGraphics.toArray()}});l=[c.on("immediate-click",function(a){return p._getCommonUpdateOperationClickHandlers(f,a,b)},t.ViewEventPriorities.WIDGET),c.on("key-down",function(a){p._getCommonUpdateOperationKeyDownHandlers(f,a);"Control"!==a.key||a.repeat||(e.enableMoveAllGraphics=!e.enableMoveAllGraphics)},t.ViewEventPriorities.WIDGET),c.on("key-up",function(a){"Control"===a.key&&(e.enableMoveAllGraphics=
!e.enableMoveAllGraphics)},t.ViewEventPriorities.WIDGET)];k=this._getHandlesForComponent(f,b);return[2,f]}})})};e.prototype._setupReshape3DOperation=function(a,b,c,d){void 0===d&&(d=!1);return B(this,void 0,void 0,function(){var h,e,f,l,k,p=this;return A(this,function(g){switch(g.label){case 0:return h="reshape",[4,this._requireModule(new Promise(function(a,b){G(["../../views/3d/interactive/editingTools"],a,b)}))];case 1:e=g.sent();if(C(e))return[2,e];f=new e.module.GraphicReshape3DTool({view:c,graphic:a,
enableZ:b.enableZ});c.tools.add(f);d||this.updateGraphics.add(a);l=[];k=new I.OperationHandle({activeComponent:f,tool:h,type:"update",onEnd:function(){l.forEach(function(a){return a.remove()});l.length=0;c.tools.remove(f);f.destroyed||f.destroy()},undo:function(){L(k,p.updateGraphics.toArray());p._emitUndoEvent({graphics:p.updateGraphics.toArray(),tool:h})},redo:function(){M(k,p.updateGraphics.toArray());p._emitRedoEvent({graphics:p.updateGraphics.toArray(),tool:h})},addToSelection:function(a){return B(p,
void 0,void 0,function(){var d;return A(this,function(h){switch(h.label){case 0:return this.updateGraphics.add(a),[4,this._setupMove3DOperation(this.updateGraphics.toArray(),b,c,"transform",!0)];case 1:d=h.sent();if(C(d))return[2];k.onEnd();k.destroy();this._setUpdateOperationHandle(d);return[2]}})})},toggleTool:function(){return B(p,void 0,void 0,function(){var a;return A(this,function(d){switch(d.label){case 0:return!1===b.toggleToolOnClick?[2]:[4,this._setupMove3DOperation(this.updateGraphics.toArray(),
b,c,"transform",!0)];case 1:a=d.sent();if(C(a))return[2];k.onEnd();k.destroy();this._setUpdateOperationHandle(a);return[2]}})})}});l.push.apply(l,this._getHandlesForComponent(k,b).concat([c.on("immediate-click",function(a){return p._getCommonUpdateOperationClickHandlers(k,a)},t.ViewEventPriorities.WIDGET),c.on("key-down",function(a){return p._getCommonUpdateOperationKeyDownHandlers(k,a)},t.ViewEventPriorities.WIDGET)]));return[2,k]}})})};e.prototype._setupTransformOrReshapeOperation=function(a,b,
c,d){return B(this,void 0,void 0,function(){var h,e,f,l,k,p,n,m,x,q,r=this;return A(this,function(g){switch(g.label){case 0:return h=c.multipleSelectionEnabled,e=void 0===h?!0:h,f=c.toggleToolOnClick,l=void 0===f?!0:f,k=[],a.forEach(function(a){k.push(new w(a.geometry,a.symbol,a.attributes));a.symbol=r._getUpdateSymbol(a.geometry)}),this.updateGraphics.addMany(a),"transform"!==b?[3,2]:[4,this._getBox(a,c,d)];case 1:return n=g.sent(),[3,4];case 2:return[4,this._getReshape(a,c,d)];case 3:n=g.sent(),
g.label=4;case 4:p=n;if(C(p))return[2,p];m=new I.OperationHandle({activeComponent:p,type:"update",onEnd:function(){q.forEach(function(a){return a.remove()});x.forEach(function(a){return a.remove()});q=[];x=[];m.activeComponent&&!m.activeComponent.destroyed&&m.activeComponent.destroy();r._internalGraphicsLayer.removeMany(r.updateGraphics.toArray());r.updateGraphics.forEach(function(a,b){k[b]&&k[b].symbol&&(a.symbol=k[b].symbol)})},undo:function(){L(m,r.updateGraphics.toArray());m.refreshComponent();
r._emitUndoEvent({graphics:r.updateGraphics.toArray(),tool:m.tool})},redo:function(){M(m,r.updateGraphics.toArray());m.refreshComponent();r._emitRedoEvent({graphics:r.updateGraphics.toArray(),tool:m.tool})},addToSelection:function(a){var b=m.activeComponent;k.push(new w(a.geometry,a.symbol,a.attributes));a.symbol=r._getUpdateSymbol(a.geometry);r.updateGraphics.add(a);b.graphics=r.updateGraphics.toArray();b.refresh();m.resetHistory();r.emit("update",{graphics:r.updateGraphics.toArray(),state:"active",
cancelled:!1,tool:r.activeTool,toolEventInfo:{added:[a],type:"selection-change"},type:"update"})},removeFromSelection:function(a){var b=m.activeComponent,c=r.updateGraphics.indexOf(a);m.history.undo.forEach(function(a){return a.updates.splice(c,1)});m.history.redo.forEach(function(a){return a.updates.splice(c,1)});var d=k.splice(c,1)[0];a.symbol=d.symbol;r.updateGraphics.remove(a);0===r.updateGraphics.length?m.complete():b.graphics=r.updateGraphics.toArray()},toggleTool:function(){return B(r,void 0,
void 0,function(){var b;return A(this,function(h){switch(h.label){case 0:if(1<this.updateGraphics.length)return[2];b=null;return"transform"!==m.tool?[3,2]:[4,this._getReshape(a,c,d)];case 1:return b=h.sent(),[3,4];case 2:return"reshape"!==m.tool?[3,4]:[4,this._getBox(a,c,d)];case 3:b=h.sent(),h.label=4;case 4:if(C(b))return[2];m.activeComponent.destroy();m.activeComponent=b;m.activeComponent&&(q.forEach(function(a){return a.remove()}),q=this._getHandlesForComponent(m,c));return[2]}})})}});x=[d.on("immediate-click",
function(a){r._getFirstHit(F.createScreenPointFromEvent(a)).then(function(b){if(m)if(b=b.results,b.length){var c=m.activeComponent,d=a.native&&a.native.shiftKey;b.some(function(a){if(a.graphic){a=a.graphic;if(e&&d&&c&&"box"===c.type&&!c.isUIGraphic(a))return m.addToSelection(a),!0;if(c&&"box"===c.type&&c.isUIGraphic(a))return!1!==l&&1===r.updateGraphics.length&&(a=r.updateGraphics.getItemAt(0).geometry,"extent"===y.get(a,"type")?r._logError("sketch:reshape-extent","Reshape operation does not support graphics with geometry of type 'extent'."):
m.toggleTool()),!0;if(c&&"reshape"===c.type){if(a===c.graphic)return!1!==l&&m.toggleTool(),!0;if(c.isUIGraphic(a)||a.layer===r._internalGraphicsLayer)return!0}else a.layer===r.layer&&m.complete()}return!1})&&a.stopPropagation()}else m.complete()})},t.ViewEventPriorities.WIDGET),d.on("key-down",function(a){r._getCommonUpdateOperationKeyDownHandlers(m,a);"Control"===a.key&&!a.repeat&&m&&(a=m.activeComponent)&&"box"===a.type&&(a.preserveAspectRatio=!a.preserveAspectRatio)},t.ViewEventPriorities.WIDGET),
d.on("key-up",function(a){"Control"===a.key&&m&&(a=m.activeComponent)&&"box"===a.type&&(a.preserveAspectRatio=!a.preserveAspectRatio)},t.ViewEventPriorities.WIDGET)];q=this._getHandlesForComponent(m,c);return[2,m]}})})};e.prototype._getGraphicMover=function(a,b,c){return B(this,void 0,void 0,function(){var d,h,e,f=this;return A(this,function(g){switch(g.label){case 0:return d=b.enableMoveAllGraphics,h=void 0===d?!0:d,[4,this._requireModule(new Promise(function(a,b){G(["../../views/draw/support/GraphicMover"],
a,b)}))];case 1:return e=g.sent(),C(e)?[2,e]:[2,new e.module({enableMoveAllGraphics:h,graphics:a,view:c,callbacks:{onGraphicMoveStart:function(a){var b=a.dx,c=a.dy;a=a.graphic;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:a,type:"move-start"},type:"update"})},onGraphicMove:function(a){var b=a.dx,c=a.dy;a=a.graphic;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,
toolEventInfo:{dx:b,dy:c,mover:a,type:"move"},type:"update"})},onGraphicMoveStop:function(a){var b=a.dx,c=a.dy;a=a.graphic;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:a,type:"move-stop"},type:"update"})},onGraphicPointerOver:function(){return f._displayDefaultCursor()},onGraphicPointerOut:function(){return f._displayDefaultCursor()}}})]}})})};e.prototype._getBox=function(a,b,c){return B(this,void 0,void 0,
function(){var d,h,e,f,l,k,p,n=this;return A(this,function(g){switch(g.label){case 0:return d=b.enableRotation,h=void 0===d?!0:d,e=b.enableScaling,f=void 0===e?!0:e,l=b.preserveAspectRatio,k=void 0===l?!1:l,[4,this._requireModule(new Promise(function(a,b){G(["../../views/draw/support/Box"],a,b)}))];case 1:return p=g.sent(),C(p)?[2,p]:[2,new p.module({graphics:a,enableRotation:h,enableScaling:f,preserveAspectRatio:k,layer:this._internalGraphicsLayer,view:c,callbacks:{onMoveStart:function(a){return n.emit("update",
{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onMove:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onMoveStop:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onScaleStart:function(a){return n.emit("update",
{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onScale:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onScaleStop:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onRotateStart:function(a){return n.emit("update",
{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onRotate:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})},onRotateStop:function(a){return n.emit("update",{graphics:n.updateGraphics.toArray(),state:"active",cancelled:!1,tool:n.activeTool,toolEventInfo:v({},a),type:"update"})}}})]}})})};e.prototype._getReshape=function(a,
b,c){return B(this,void 0,void 0,function(){var d,h,e,f=this;return A(this,function(g){switch(g.label){case 0:return d=b.enableMidpoints,h=void 0===d?!0:d,[4,this._requireModule(new Promise(function(a,b){G(["../../views/draw/support/Reshape"],a,b)}))];case 1:return e=g.sent(),C(e)?[2,e]:[2,new e.module({enableMidpoints:h,graphic:a[0],layer:this._internalGraphicsLayer,view:c,callbacks:{onReshapeStart:function(a){return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,
tool:f.activeTool,toolEventInfo:v({},a),type:"update"})},onReshape:function(a){return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:v({},a),type:"update"})},onReshapeStop:function(a){var b=a.mover;a=a.type;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{mover:b,type:a},type:"update"})},onMoveStart:function(a){var b=a.dx,c=a.dy,d=a.mover;a=a.type;return f.emit("update",
{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:d,type:a},type:"update"})},onMove:function(a){var b=a.dx,c=a.dy,d=a.mover;a=a.type;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:d,type:a},type:"update"})},onMoveStop:function(a){var b=a.dx,c=a.dy,d=a.mover;a=a.type;return f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,
tool:f.activeTool,toolEventInfo:{dx:b,dy:c,mover:d,type:a},type:"update"})},onVertexAdd:function(a){var b=a.type,c=a.vertices;a=a.added.map(function(a){return Q.geometryToCoordinates(a.geometry)});f.emit("update",{graphics:f.updateGraphics.toArray(),state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{added:a,vertices:c,type:b},type:"update"})},onVertexRemove:function(a){var b=a.type,c=a.vertices;a=a.removed.map(function(a){return Q.geometryToCoordinates(a.geometry)});f.emit("update",{graphics:f.updateGraphics.toArray(),
state:"active",cancelled:!1,tool:f.activeTool,toolEventInfo:{removed:a,vertices:c,type:b},type:"update"})}}})]}})})};e.prototype._getHandlesForComponent=function(a,b){var c=this,d=a.activeComponent;switch(d.type){case "graphic-mover":return[d.on("graphic-move-start",function(b){return a.addToHistory(D(b.allGraphics))})];case "box":return[d.on("move-start",function(b){return a.addToHistory(D(b.graphics))}),d.on("rotate-start",function(b){return a.addToHistory(D(b.graphics))}),d.on("scale-start",function(b){return a.addToHistory(D(b.graphics))})];
case "reshape":return[d.on("move-start",function(b){return a.addToHistory(D([b.mover]))}),d.on("reshape-start",function(b){return a.addToHistory(D([b.graphic]))}),d.on("vertex-add",function(b){return a.addToHistory(D([b.oldGraphic]))}),d.on("vertex-remove",function(b){return a.addToHistory(D([b.oldGraphic]))})];case "move-3d":return[d.on("graphic-move-start",function(b){a.addToHistory(D(b.allGraphics));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,
toolEventInfo:{dx:0,dy:0,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move-start"},type:"update"})}),d.on("graphic-move",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{dx:a.dx,dy:a.dy,mover:0<a.allGraphics.length?a.allGraphics[0]:null,type:"move"},type:"update"})}),d.on("graphic-move-stop",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{dx:0,
dy:0,mover:0<a.allGraphics.length?a.allGraphics[0]:null,type:"move-stop"},type:"update"})}),d.on("immediate-click",function(d){d.shiftKey?c._toggleSelection([d.graphic],a,b):a.toggleTool()})];case "transform-3d":return[d.on("graphic-translate-start",function(b){a.addToHistory(D([b.graphic]));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move-start"},type:"update"})}),d.on("graphic-translate-stop",
function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:a.graphic,dx:a.dxScreen,dy:a.dyScreen,type:"move-stop"},type:"update"})}),d.on("graphic-rotate-start",function(b){a.addToHistory(V([b.graphic]));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate-start"},type:"update"})}),d.on("graphic-rotate-stop",function(a){c.emit("update",
{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:a.graphic,angle:a.angle,type:"rotate-stop"},type:"update"})}),d.on("graphic-scale-start",function(b){a.addToHistory(V([b.graphic]));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.scale,yScale:b.scale,type:"scale-start"},type:"update"})}),d.on("graphic-scale-stop",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),
state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:a.graphic,xScale:a.scale,yScale:a.scale,type:"scale-stop"},type:"update"})}),d.on("graphic-translate",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:a.graphic,dx:a.dxScreen,dy:a.dyScreen,type:"move"},type:"update"})}),d.on("graphic-rotate",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,
toolEventInfo:{mover:a.graphic,angle:a.angle,type:"rotate"},type:"update"})}),d.on("graphic-scale",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:{mover:a.graphic,xScale:a.scale,yScale:a.scale,type:"scale"},type:"update"})})];case "reshape-3d":return[d.on("reshape",function(b){"reshape-start"===b.type&&a.addToHistory(D([b.mover]));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,
toolEventInfo:b,type:"update"})}),d.on("move",function(b){"move-start"===b.type&&a.addToHistory(D([b.mover]));c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:b,type:"update"})}),d.on("vertex-add",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",cancelled:!1,tool:c.activeTool,toolEventInfo:a,type:"update"})}),d.on("vertex-remove",function(a){c.emit("update",{graphics:c.updateGraphics.toArray(),state:"active",
cancelled:!1,tool:c.activeTool,toolEventInfo:a,type:"update"})}),d.on("immediate-click",function(){return a.toggleTool()})];case "draw":return null;default:Y.neverReached(d)}};e.prototype._setUpdateOperationHandle=function(a){var b=this;this._operationHandle=a;var c=this.view,d=c.map,e=c.popup,g=!0;e&&(g=e.autoOpenEnabled,e.autoOpenEnabled=!1);a.on("complete",function(){if(a===b._operationHandle){var c=b.updateGraphics.toArray(),h=b._operationHandle.tool;b._operationHandle.destroy();b._operationHandle=
null;b._internalGraphicsLayer.removeMany(b.updateGraphics.toArray());b.updateGraphics.removeAll();d&&d.remove(b._internalGraphicsLayer);e&&(e.autoOpenEnabled=g);b.emit("update",{graphics:c,state:"complete",cancelled:a.cancelled,tool:h,toolEventInfo:null,type:"update"})}})};e.prototype._getCommonUpdateOperationClickHandlers=function(a,b,c){var d=this,e=F.createScreenPointFromEvent(b);this._getFirstHit(e).then(function(e){e=e.results;e.length?b.native.shiftKey&&d._toggleSelection(e.map(function(a){return a.graphic}),
a,c)?b.stopPropagation():e.some(function(a){return a.graphic&&-1<d.updateGraphics.indexOf(a.graphic)})?b.stopPropagation():a.complete():a.complete()})};e.prototype._toggleSelection=function(a,b,c){var d=this,e=c?!!c.multipleSelectionEnabled:!0;return a.some(function(a){return null==a?!1:e&&a.layer===d.layer?(-1===d.updateGraphics.indexOf(a)?b.addToSelection(a):b.removeFromSelection(a),!0):!1})};e.prototype._getCommonUpdateOperationKeyDownHandlers=function(a,b){if(a){var c=b.key;"z"===c&&a.canUndo()?
(b.stopPropagation(),a.undo()):"r"===c&&a.canRedo()?(b.stopPropagation(),a.redo()):"Escape"===c?a.cancel():0<=ja.indexOf(c)&&this._onDeleteKey()}};e.prototype._onDeleteKey=function(){if(this._operationHandle&&"update"===this._operationHandle.type){var a=this.activeComponent;a&&"reshape"!==a.type&&"reshape-3d"!==a.type&&(a=this.updateGraphics.toArray(),this.layer.removeMany(a),this._emitDeleteEvent({graphics:a,tool:this.activeTool}))}};e.prototype._getCreateSymbol=function(a,b){void 0===b&&(b=!1);
b="3d"!==this.view.type&&b;switch(a.type){case "point":case "multipoint":return b?this.activePointSymbol:this.pointSymbol;case "polyline":return b?this.activeLineSymbol:this.polylineSymbol;case "polygon":return b?this.activeFillSymbol:this.polygonSymbol}return null};e.prototype._getUpdateSymbol=function(a){if(y.isNone(a))return null;switch(a.type){case "point":case "multipoint":return this.updatePointSymbol;case "polyline":return this.updatePolylineSymbol;case "polygon":case "extent":return this.updatePolygonSymbol}return null};
e.prototype._drawMultipointGraphic=function(a,b){var c=null;!b&&1<a.length?(c=a.slice(0),c.pop(),c=u.createMultipoint(c,this.view.spatialReference)):c=u.createMultipoint(a,this.view.spatialReference);this.createGraphic?this.createGraphic.geometry=c:this._set("createGraphic",new w(c,this.pointSymbol));b&&1===a.length&&this._internalGraphicsLayer.add(this.createGraphic)};e.prototype._drawVertexGraphics=function(a,b,c){c=!(!c||!c.userClicked);var d="polygon"===a,e=d?this.polygonSymbol:this.polylineSymbol;
if(1===b.length){this._removeLineGraphic();this._removeActiveLineGraphic();var g=this.createPointFromVertex(b[0]),d=d?u.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):u.createPolyline([b],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length?this._vertexGraphics[0].geometry=g:this._vertexGraphics.push(new w(g,this.activeVertexSymbol));this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new w(d,e));c&&this._internalGraphicsLayer.add(this._vertexGraphics[0])}else if(2===
b.length){a=this.createPointFromVertex(b[1]);var f=this.vertexSymbol,e=u.createPolyline([b],this.view.spatialReference,this._doUnnormalization),d=d?u.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):u.createPolyline([b],this.view.spatialReference,this._doUnnormalization);this._vertexGraphics.length||(g=this.createPointFromVertex(b[0]),b=new w(g,f),this._vertexGraphics.push(b));1===this._vertexGraphics.length?(b=this._vertexGraphics[0],a=new w(a,f),this._removeLineGraphic(),
this._removeActiveFillGraphic(),this._vertexGraphics.push(a),this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b)):this._vertexGraphics[1].geometry=a;this._showActiveLineGraphic(e);b=this._vertexGraphics[0];c&&(this._activeLineGraphic.symbol=this.polylineSymbol,b.symbol=this.vertexSymbol,this._internalGraphicsLayer.add(this._vertexGraphics[1]));this.createGraphic?this.createGraphic.geometry=d:this._set("createGraphic",new w(d,this.polygonSymbol));this._internalGraphicsLayer.remove(b);
this._internalGraphicsLayer.add(b)}else if(2<b.length){d=d?u.createPolygon([b],this.view.spatialReference,this._doUnnormalization,!0):u.createPolyline([b],this.view.spatialReference,this._doUnnormalization);"polygon"===a&&this._showFillGraphic(d);a=b.map(function(a){return a.slice()});f=a.pop();g=[a[a.length-1],f];f=u.createPolyline([a],this.view.spatialReference,this._doUnnormalization);g=u.createPolyline([g],this.view.spatialReference,this._doUnnormalization);this._showLineGraphic(f);this._showActiveLineGraphic(g);
for(f=0;f<a.length;f++)(g=this._vertexGraphics[f])?g.symbol=c||f!==this._vertexGraphics.length-1?this.vertexSymbol:this.activeVertexSymbol:(g=this.createPointFromVertex(b[f]),this._showVertexGraphic(g));c?(this._activeLineGraphic.symbol=this.polylineSymbol,f=b.length-1,g=this.createPointFromVertex(b[f]),this._showVertexGraphic(g)):this._activeLineGraphic.symbol=this.activeLineSymbol;this.createGraphic?this.createGraphic.geometry=d:(this._removeCreateGraphic(),this._set("createGraphic",new w(d,e)));
c=0;for(d=this._vertexGraphics;c<d.length;c++)b=d[c],this._internalGraphicsLayer.remove(b),this._internalGraphicsLayer.add(b)}};e.prototype._drawSegmentGraphic=function(a,b,c,d){if(b.length){var e=!(!c||!c.centered);c=!(!c||!c.constrained);var g=null;1===b.length?this._removeCenterIndicatorGraphic():("rectangle"===a?g=c?u.createSquare(b,d,e):u.createRectangle(b,d,e):"circle"===a&&(g=c?u.createEllipse(b,d,e):u.createCircle(b,d,e)),g.extent&&g.extent.center&&this._showCenterIndicatorGraphic(g.extent.center));
g?this.createGraphic?this.createGraphic.geometry=g:(this._removeCreateGraphic(),this._set("createGraphic",new w(g,this.polygonSymbol)),this._internalGraphicsLayer.add(this.createGraphic)):this._removeCreateGraphic()}};e.prototype._showCenterIndicatorGraphic=function(a){this._centerIndicatorGraphic?this._centerIndicatorGraphic.geometry=a:(this._centerIndicatorGraphic=new w(a,this._centerSymbol),this._internalGraphicsLayer.add(this._centerIndicatorGraphic))};e.prototype._removeCenterIndicatorGraphic=
function(){this._centerIndicatorGraphic&&(this._internalGraphicsLayer.remove(this._centerIndicatorGraphic),this._centerIndicatorGraphic.destroy(),this._centerIndicatorGraphic=null)};e.prototype._showActiveLineGraphic=function(a){this._activeLineGraphic?this._activeLineGraphic.geometry=a:(this._activeLineGraphic=new w(a,this.activeLineSymbol),this._internalGraphicsLayer.graphics.add(this._activeLineGraphic,0))};e.prototype._showFillGraphic=function(a){this._activeFillGraphic?this._activeFillGraphic.geometry=
a:(this._activeFillGraphic=new w(a,this._getCreateSymbol(a,!0)),this._internalGraphicsLayer.add(this._activeFillGraphic))};e.prototype._showLineGraphic=function(a){this._lineGraphic?this._lineGraphic.geometry=a:(this._lineGraphic=new w(a,this.polylineSymbol),this._internalGraphicsLayer.graphics.add(this._lineGraphic,0))};e.prototype._showVertexGraphic=function(a,b){a=new w(a,b?this.activeVertexSymbol:this.vertexSymbol);this._vertexGraphics.push(a);this._internalGraphicsLayer.add(a)};e.prototype._resetCreateOperationGraphics=
function(){this._removeActiveFillGraphic();this._removeLineGraphic();this._removeActiveLineGraphic();this._removeVertexGraphics()};e.prototype._removeCreateGraphic=function(){this.createGraphic&&(this._internalGraphicsLayer.remove(this.createGraphic),this._set("createGraphic",null))};e.prototype._removeCreateOperationGraphics=function(){this._removeCenterIndicatorGraphic();this._removeActiveLineGraphic();this._removeActiveFillGraphic();this._removeLineGraphic();this._removeVertexGraphics()};e.prototype._removeActiveLineGraphic=
function(){this._activeLineGraphic&&(this._internalGraphicsLayer.remove(this._activeLineGraphic),this._activeLineGraphic.destroy(),this._activeLineGraphic=null)};e.prototype._removeActiveFillGraphic=function(){this._activeFillGraphic&&(this._internalGraphicsLayer.remove(this._activeFillGraphic),this._activeFillGraphic.destroy(),this._activeFillGraphic=null)};e.prototype._removeLineGraphic=function(){this._lineGraphic&&(this._internalGraphicsLayer.remove(this._lineGraphic),this._lineGraphic.destroy(),
this._lineGraphic=null)};e.prototype._removeVertexGraphics=function(){this._vertexGraphics.length&&(this._internalGraphicsLayer.removeMany(this._vertexGraphics),this._vertexGraphics.forEach(function(a){return a.destroy()}),this._vertexGraphics=[])};e.prototype._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer.destroy(),this._internalGraphicsLayer=null)};e.prototype._operationHandleForCreateAction=function(a,
b,c){var d=this;return new I.OperationHandle({activeComponent:this._draw,tool:c,type:"create",onEnd:function(){b.forEach(function(a){return a.remove()});b.length=0;d._removeCreateOperationGraphics();d._internalGraphicsLayer&&d._internalGraphicsLayer.remove(d.createGraphic);d._displayDefaultCursor()},undo:function(){a.undo();d._emitUndoEvent({graphics:[d.createGraphic],tool:c})},redo:function(){a.redo();d._emitRedoEvent({graphics:[d.createGraphic],tool:c})},canUndo:function(){return a&&a.canUndo()},
canRedo:function(){return a&&a.canRedo()},setSnapToScene:function(b){a.snapToScene=b?function(a,b){return d._snapToScene3D(a,b)}:null}})};e.prototype._snap=function(a,b,c){c&&this._snapLastVertexToAxis(b);"polygon"===a&&this._snapLastPolygonVertexToFirst(b)};e.prototype._snapLastPolygonVertexToFirst=function(a){if(!(2>=a.length)){var b=a[0];a=a[a.length-1];var c=this.view.toScreen(new J.Point(b[0],b[1],this.view.spatialReference)),d=this.view.toScreen(new J.Point(a[0],a[1],this.view.spatialReference));
this._isWithinScreenDistance(c,d,this._getVertexIntersectDistance())&&(a[0]=b[0],a[1]=b[1])}};e.prototype._getVertexIntersectDistance=function(){return this.vertexSymbol&&"simple-marker"===this.vertexSymbol.type?F.pt2px(this.vertexSymbol.size)/2+3:3};e.prototype._isWithinScreenDistance=function(a,b,c){var d=a.x-b.x;a=a.y-b.y;return Math.sqrt(d*d+a*a)<=c};e.prototype._snapLastVertexToAxis=function(a){if(!(2>a.length)){var b=a.pop(),c=a[a.length-1],d=u.createViewAlignedCoordinateSystem(this.view,c),
c=d.mapToLocal(c),b=d.mapToLocal(b),e=Math.abs(b.x-c.x),g=Math.abs(b.y-c.y),d=d.localToMap(u.makeSurfacePoint(e>g?b.x:c.x,e>g?c.y:b.y));a.push(d)}};e.prototype._displayCrosshairCursor=function(){this.view&&this.view.container&&"crosshair"!==this.view.cursor&&(this.view.cursor="crosshair")};e.prototype._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)};e.prototype._logError=function(a,b,c){ia.error(new Z(a,b,c))};e.prototype._requireModule=
function(a){return B(this,void 0,void 0,function(){var b,c;return A(this,function(d){switch(d.label){case 0:return this._moduleLoaderAbortController=b=new AbortController,[4,a];case 1:return c=d.sent(),this._moduleLoaderAbortController!==b||b.signal.aborted?[2,{requireError:"aborted"}]:[2,{module:c}]}})})};e.prototype._emitUndoEvent=function(a){this.emit("undo",v({},a,{type:"undo"}))};e.prototype._emitRedoEvent=function(a){this.emit("redo",v({},a,{type:"redo"}))};e.prototype._emitDeleteEvent=function(a){this.emit("delete",
v({},a,{type:"delete"}))};e.prototype.createPointFromVertex=function(a){return 2<a.length?new J.Point(a[0],a[1],a[2],this.view.spatialReference):new J.Point(a[0],a[1],this.view.spatialReference)};q([l.property({dependsOn:["state"],readOnly:!0})],e.prototype,"_draw",null);q([l.property()],e.prototype,"_operationHandle",void 0);q([l.property({dependsOn:["_operationHandle","_operationHandle.tool"],readOnly:!0})],e.prototype,"activeTool",null);q([l.property()],e.prototype,"activeFillSymbol",void 0);q([l.property()],
e.prototype,"activeLineSymbol",void 0);q([l.property()],e.prototype,"activePointSymbol",void 0);q([l.property()],e.prototype,"activeVertexSymbol",void 0);q([l.property({readOnly:!0})],e.prototype,"createGraphic",void 0);q([l.property()],e.prototype,"defaultCreateOptions",void 0);q([l.property()],e.prototype,"defaultUpdateOptions",void 0);q([l.property()],e.prototype,"layer",void 0);q([l.property({types:E.symbolTypes})],e.prototype,"pointSymbol",void 0);q([l.property({types:E.symbolTypes})],e.prototype,
"polygonSymbol",void 0);q([l.property({types:E.symbolTypes})],e.prototype,"polylineSymbol",void 0);q([l.property({dependsOn:["view.ready","layer","_operationHandle"],readOnly:!0})],e.prototype,"state",null);q([l.property({readOnly:!0})],e.prototype,"updateGraphics",void 0);q([l.property()],e.prototype,"updateOnGraphicClick",void 0);q([l.property({types:E.symbolTypes})],e.prototype,"updatePointSymbol",void 0);q([l.property({types:E.symbolTypes})],e.prototype,"updatePolygonSymbol",void 0);q([l.property({types:E.symbolTypes})],
e.prototype,"updatePolylineSymbol",void 0);q([l.property({types:E.symbolTypes})],e.prototype,"vertexSymbol",void 0);q([l.property({value:null})],e.prototype,"view",null);q([l.property()],e.prototype,"cancel",null);q([l.property()],e.prototype,"complete",null);q([l.property()],e.prototype,"delete",null);q([l.property()],e.prototype,"create",null);q([l.property()],e.prototype,"update",null);q([l.property()],e.prototype,"undo",null);q([l.property()],e.prototype,"redo",null);q([l.property()],e.prototype,
"canUndo",null);q([l.property()],e.prototype,"canRedo",null);q([l.property()],e.prototype,"toggleUpdateTool",null);q([l.property({value:null})],e.prototype,"snapToScene",null);return e=q([l.subclass("esri.widgets.Sketch.SketchViewModel")],e)}(l.declared(aa.EventedAccessor))});