import { bu as e$1, ai as i$2, bz as M$1, bA as t$1, bB as a$1, E as n$2, o as t$2, bC as l$3, bD as K, bE as oe, bF as W, bG as ee, bH as ye, r as r$4, bI as ae, t as t$3, n as n$3, aU as a$2, bJ as m$1, aZ as z, w as g, s as s$2, bK as y, bL as d$4, bM as e$2, F as A$1, bd as e$3, b as e$4 } from './_virtual_index-634cbc09.js';
import { r as r$3 } from './quickselect-eae177f3.js';
import { d as d$3, t as t$4 } from './FeatureSetReader-261c974c.js';
import { N, O as O$1, K as K$1, c as c$2, J } from './definitions-12783a0f.js';
import { G } from './Utils-3e0360c1.js';
import { n as n$4, l as l$4, r as r$5 } from './visualVariablesUtils-de638f89.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
class l$2{constructor(e,t){this.key=new e$1(0,0,0,0),this.bounds=i$2(),this.objectIds=new Set,this.key.set(t);const s=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=s.resolution,this.scale=s.scale,this.level=s.level,this.needsClear=!0;}get id(){return this.key.id}get extent(){return M$1.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return {originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}get bbox(){const e=this.bounds;return {minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}clone(){return new l$2(this.tileInfoView,this.key)}createChildTiles(){const t=this.key.getChildKeys(),i=t$1.acquire();for(let e=0;e<t.length;e++)i[e]=new l$2(this.tileInfoView,t[e]);return i}getQuantizationParameters(){return a$1.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function i$1(t,n){if(!(this instanceof i$1))return new i$1(t,n);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),n&&("function"==typeof n?this.toBBox=n:this._initFormat(n)),this.clear();}function n$1(t,i,n){if(!n)return i.indexOf(t);for(var h=0;h<i.length;h++)if(n(t,i[h]))return h;return -1}function h$2(t,i){a(t,0,t.children.length,i,t);}function a(t,i,n,h,a){a||(a=x(null)),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(var e,o=i;o<n;o++)e=t.children[o],r$2(a,t.leaf?h(e):e);return a}function r$2(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function e(t,i){return t.minX-i.minX}function o(t,i){return t.minY-i.minY}function s$1(t){return (t.maxX-t.minX)*(t.maxY-t.minY)}function l$1(t){return t.maxX-t.minX+(t.maxY-t.minY)}function m(t,i){return (Math.max(i.maxX,t.maxX)-Math.min(i.minX,t.minX))*(Math.max(i.maxY,t.maxY)-Math.min(i.minY,t.minY))}function c$1(t,i){var n=Math.max(t.minX,i.minX),h=Math.max(t.minY,i.minY),a=Math.min(t.maxX,i.maxX),r=Math.min(t.maxY,i.maxY);return Math.max(0,a-n)*Math.max(0,r-h)}function u$2(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function f(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function x(t){return {children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d$2(i,n,h,a,r){for(var e,o=[n,h];o.length;)(h=o.pop())-(n=o.pop())<=a||(e=n+Math.ceil((h-n)/a/2)*a,r$3(i,e,n,h,r),o.push(n,e,e,h));}i$1.prototype={all:function(){return this._all(this.data,[])},search:function(t){var i=this.data,n=[],h=this.toBBox;if(!f(t,i))return n;for(var a,r,e,o,s=[];i;){for(a=0,r=i.children.length;a<r;a++)e=i.children[a],f(t,o=i.leaf?h(e):e)&&(i.leaf?n.push(e):u$2(t,o)?this._all(e,n):s.push(e));i=s.pop();}return n},collides:function(t){var i=this.data,n=this.toBBox;if(!f(t,i))return !1;for(var h,a,r,e,o=[];i;){for(h=0,a=i.children.length;h<a;h++)if(r=i.children[h],f(t,e=i.leaf?n(r):r)){if(i.leaf||u$2(t,e))return !0;o.push(r);}i=o.pop();}return !1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var i=0,n=t.length;i<n;i++)this.insert(t[i]);return this}var h=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===h.height)this._splitRoot(this.data,h);else {if(this.data.height<h.height){var a=this.data;this.data=h,h=a;}this._insert(h,this.data.height-h.height-1,!0);}else this.data=h;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=x([]),this},remove:function(t,i){if(!t)return this;for(var h,a,r,e,o=this.data,s=this.toBBox(t),l=[],m=[];o||l.length;){if(o||(o=l.pop(),a=l[l.length-1],h=m.pop(),e=!0),o.leaf&&-1!==(r=n$1(t,o.children,i)))return o.children.splice(r,1),l.push(o),this._condense(l),this;e||o.leaf||!u$2(o,s)?a?(h++,o=a.children[h],e=!1):o=null:(l.push(o),m.push(h),h=0,a=o,o=o.children[0]);}return this},toBBox:function(t){return t},compareMinX:e,compareMinY:o,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,i){for(var n=[];t;)t.leaf?i.push.apply(i,t.children):n.push.apply(n,t.children),t=n.pop();return i},_build:function(t,i,n,a){var r,e=n-i+1,o=this._maxEntries;if(e<=o)return h$2(r=x(t.slice(i,n+1)),this.toBBox),r;a||(a=Math.ceil(Math.log(e)/Math.log(o)),o=Math.ceil(e/Math.pow(o,a-1))),(r=x([])).leaf=!1,r.height=a;var s,l,m,c,u=Math.ceil(e/o),f=u*Math.ceil(Math.sqrt(o));for(d$2(t,i,n,f,this.compareMinX),s=i;s<=n;s+=f)for(d$2(t,s,m=Math.min(s+f-1,n),u,this.compareMinY),l=s;l<=m;l+=u)c=Math.min(l+u-1,m),r.children.push(this._build(t,l,c,a-1));return h$2(r,this.toBBox),r},_chooseSubtree:function(t,i,n,h){for(var a,r,e,o,l,c,u,f;h.push(i),!i.leaf&&h.length-1!==n;){for(u=f=1/0,a=0,r=i.children.length;a<r;a++)l=s$1(e=i.children[a]),(c=m(t,e)-l)<f?(f=c,u=l<u?l:u,o=e):c===f&&l<u&&(u=l,o=e);i=o||i.children[0];}return i},_insert:function(t,i,n){var h=this.toBBox,a=n?t:h(t),e=[],o=this._chooseSubtree(a,this.data,i,e);for(o.children.push(t),r$2(o,a);i>=0&&e[i].children.length>this._maxEntries;)this._split(e,i),i--;this._adjustParentBBoxes(a,e,i);},_split:function(t,i){var n=t[i],a=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,a);var e=this._chooseSplitIndex(n,r,a),o=x(n.children.splice(e,n.children.length-e));o.height=n.height,o.leaf=n.leaf,h$2(n,this.toBBox),h$2(o,this.toBBox),i?t[i-1].children.push(o):this._splitRoot(n,o);},_splitRoot:function(t,i){this.data=x([t,i]),this.data.height=t.height+1,this.data.leaf=!1,h$2(this.data,this.toBBox);},_chooseSplitIndex:function(t,i,n){var h,r,e,o,l,m,u,f;for(m=u=1/0,h=i;h<=n-i;h++)o=c$1(r=a(t,0,h,this.toBBox),e=a(t,h,n,this.toBBox)),l=s$1(r)+s$1(e),o<m?(m=o,f=h,u=l<u?l:u):o===m&&l<u&&(u=l,f=h);return f},_chooseSplitAxis:function(t,i,n){var h=t.leaf?this.compareMinX:e,a=t.leaf?this.compareMinY:o;this._allDistMargin(t,i,n,h)<this._allDistMargin(t,i,n,a)&&t.children.sort(h);},_allDistMargin:function(t,i,n,h){t.children.sort(h);var e,o,s=this.toBBox,m=a(t,0,i,s),c=a(t,n-i,n,s),u=l$1(m)+l$1(c);for(e=i;e<n-i;e++)o=t.children[e],r$2(m,t.leaf?s(o):o),u+=l$1(m);for(e=n-i-1;e>=i;e--)o=t.children[e],r$2(c,t.leaf?s(o):o),u+=l$1(c);return u},_adjustParentBBoxes:function(t,i,n){for(var h=n;h>=0;h--)r$2(i[h],t);},_condense:function(t){for(var i,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(i=t[n-1].children).splice(i.indexOf(t[n]),1):this.clear():h$2(t[n],this.toBBox);},_initFormat:function(t){var i=["return a"," - b",";"];this.compareMinX=new Function("a","b",i.join(t[0])),this.compareMinY=new Function("a","b",i.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};");}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const h$1={added:[],removed:[]},r$1=new Set,d$1=new e$1(0,0,0,0);class l extends n$2{constructor(t){super(),this._tiles=new Map,this._index=i$1(9,t$2("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=t;}destroy(){this.clear();}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear();}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}findByKey(e){return this._tiles.get(e.id)}minLOD(){return Math.min(...this.tiles.map((e=>e.level)))}intersections(e,t){const s="string"==typeof e?this.get(e):e;if(!s)return [];const i=t*s.resolution,n=s.bounds[0]-i,o=s.bounds[1]-i,h=s.bounds[2]+i,r=s.bounds[3]+i,d=[];for(const l of this._index.search({minX:n,minY:o,maxX:h,maxY:r})){const e=l.bounds.slice();e[0]=Math.max(e[0],n),e[1]=Math.max(e[1],o),e[2]=Math.min(e[2],h),e[3]=Math.min(e[3],r),e[2]-e[0]>0&&e[3]-e[1]>0&&d.push({bounds:e,tile:l});}return d}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const t={added:[],removed:[]};for(const s of e.added)if(!this.has(s)){const e=new l$2(this.tileScheme,s);this._tiles.set(s,e),this._index.insert(e),t.added.push(e);}for(const s of e.removed)if(this.has(s)){const e=this.get(s);this._tiles.delete(s),this._index.remove(e),t.removed.push(e);}this.tiles.length=0,this._tiles.forEach((e=>this.tiles.push(e))),(t.added.length||t.removed.length)&&this.emit("update",t);}setViewState(e){const t=this.tileScheme.getTileCoverage(e,0);if(!t)return;const{spans:s,lodInfo:o}=t,{level:l}=o;if(s.length>0)for(const{row:i,colFrom:a,colTo:m}of s)for(let e=a;e<=m;e++){const t=d$1.set(l,i,o.normalizeCol(e),o.getWorldForColumn(e)).id;if(r$1.add(t),!this.has(t)){const e=new l$2(this.tileScheme,t);this._tiles.set(t,e),this._index.insert(e),this.tiles.push(e),h$1.added.push(e);}}for(let i=this.tiles.length-1;i>=0;i--){const e=this.tiles[i];r$1.has(e.id)||(this._tiles.delete(e.id),this.tiles.splice(i,1),this._index.remove(e),h$1.removed.push(e));}(h$1.added.length||h$1.removed.length)&&this.emit("update",h$1),l$3.pool.release(t),r$1.clear(),h$1.added.length=0,h$1.removed.length=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function h({coords:t,lengths:e}){let r=0;for(const s of e){for(let e=1;e<s;e++)t[2*(r+e)]+=t[2*(r+e)-2],t[2*(r+e)+1]+=t[2*(r+e)-1];r+=s;}}class c extends d$3{constructor(t,e,r){super(t),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=r,this._features=e;}static fromFeatures(t,e,s){const i=K([],t,e,!1,!1,s);for(let r=0;r<i.length;r++)i[r].displayId=t[r].displayId;return c.fromOptimizedFeatures(i,e)}static fromFeatureSet(t,e){const r=oe(t,e);return c.fromOptimizedFeatureSet(r)}static fromOptimizedFeatureSet(t){const{features:e,geometryType:r}=t,s=c.fromOptimizedFeatures(e,r);s._exceededTransferLimit=t.exceededTransferLimit,s._transform=t.transform;for(const i of t.fields)"esriFieldTypeDate"===i.type&&s._dateFields.add(i.name);return s}static fromOptimizedFeatures(t,e,r){const s=d$3.createInstance(),i=new c(s,t,e);return i._transform=r,i}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return !!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return !1}get hasM(){return !1}getApproximateSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let t="";for(const e in this._current.attributes)t+=this._current.attributes[e];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t;}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t;}getGroupId(){return this._current.groupId}setGroupId(t){this._current.groupId=t;}copy(){const t=new c(this.instance,this._features,this.geometryType);return this.copyInto(t),t}next(){for(;++this._featureIndex<this._features.length&&!this._passesFilter()&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return W(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const t=this.readGeometry();return ee(t,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const t=this.readCentroid();return t?{x:t.coords[0]*this._sx+this._tx,y:t.coords[1]*this._sy+this._ty}:null}readGeometryArea(){return ye(this._current.geometry,2)}readUnquantizedGeometry(){const t=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!t)return t;const e=t.clone();return h(e),e}readHydratedGeometry(){const e=this._current.geometry;if(!e)return null;const r=e.clone();return r$4(this._transform)&&ae(r,r,this.hasZ,this.hasM,this._transform),r}getXHydrate(){const t=this._current.geometry.coords[0],r=this.getQuantizationTransform();return t$3(r)?t:t*r.scale[0]+r.translate[0]}getYHydrate(){const t=this._current.geometry.coords[1],r=this.getQuantizationTransform();return t$3(r)?t:r.translate[1]-t*r.scale[1]}getX(){return this._current.geometry.coords[0]*this._sx+this._tx}getY(){return this._current.geometry.coords[1]*this._sy+this._ty}readGeometry(){if(!this._current.hasGeometry)return null;const t=this._current.geometry.clone();if(t.isPoint)return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sy+this._ty,t;let e=0;for(const r of t.lengths)t.coords[2*e]=t.coords[2*e]*this._sx+this._tx,t.coords[2*e+1]=t.coords[2*e+1]*this._sy+this._ty,e+=r;return t}readCentroid(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){const t=this._computeCentroid();if(!t)return null;t.coords[0]=(t.coords[0]-this._tx)/this._sx,t.coords[1]=(t.coords[1]-this._ty)/this._sy,this._current.centroid=t;}const t=this._current.centroid.clone();return t.coords[0]=t.coords[0]*this._sx+this._tx,t.coords[1]=t.coords[1]*this._sx+this._ty,t}_readAttribute(t,e){const r=this._current.attributes[t];if(void 0!==r)return null!=r&&e&&this._dateFields.has(t)?new Date(r):r;const s=this.readAttributes(),i=t.toLocaleLowerCase().trim();for(const n in s)if(n.toLocaleLowerCase().trim()===i){const t=this._current.attributes[n];return null!=t&&e&&this._dateFields.has(n)?new Date(t):t}}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._dateFields=this._dateFields;}_readAttributes(){return this._current.attributes}_passesFilter(){if(!this._hasFilter)return !0;let t=0,e=0;switch(this.geometryType){case"esriGeometryPoint":{const r=this._current.geometry;if(!r)return !1;[t,e]=r.coords;break}case"esriGeometryPolygon":{const r=this.readCentroid();if(!r)return !1;[t,e]=r.coords,t-=this._tx,e-=this._ty;break}default:return !1}return t>=this._xmin&&t<=this._xmax&&e>=this._ymin&&e<=this._ymax}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const w=n$3.getLogger("esri.views.layers.2d.features.support.AttributeStore"),A=n$4(l$4,w),k=2147483647,D=2147483648,E=254,F=255,U=0,R=1,C=t=>(t&D)>>>31,M=t=>t&k,B=t=>C(t)===R?E:F;function v(t){return C(t)===R}const j={sharedArrayBuffer:t$2("esri-shared-array-buffer"),atomics:t$2("esri-atomics")};function I(t,e){return i=>e(t(i))}class P{constructor(t,e,i,s){this.size=0,this.texelSize=4;const{pixelType:r,layout:a,textureOnly:o}=s;this.textureOnly=o||!1,this.pixelType=r,this._ctype=e,this.layout=a,this._resetRange(),this._shared=t,this.size=i,o||(this.data=this._initData(r,i,t,e));}get buffer(){return A$1(this.data,(t=>t.buffer))}unsetComponentAllTexels(t,e){const i=e$3(this.data);for(let s=0;s<this.size*this.size;s++)i[s*this.texelSize+t]&=~e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1;}setComponentAllTexels(t,e){const i=e$3(this.data);for(let s=0;s<this.size*this.size;s++)i[s*this.texelSize+t]|=255&e;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1;}setComponent(t,e,i){const s=e$3(this.data);for(const r of i)s[r*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r);}setComponentTexel(t,e,i){e$3(this.data)[i*this.texelSize+t]|=e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i);}unsetComponentTexel(t,e,i){e$3(this.data)[i*this.texelSize+t]&=~e,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i);}getData(t,e){const i=M(t);return e$3(this.data)[i*this.texelSize+e]}setData(t,e,i){const s=M(t),r=1<<e;0!=(this.layout&r)?(this.data[s*this.texelSize+e]=i,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)):w.error("mapview-attributes-store","Tried to set a value for a texel's readonly component");}lock(){5121===this.pixelType&&this._shared&&j.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1);}unlock(){5121===this.pixelType&&this._shared&&j.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0);}expand(t){if(this.size=t,!this.textureOnly){const e=this._initData(this.pixelType,t,this._shared,this._ctype),i=e$3(this.data);e.set(i),this.data=e;}}toMessage(){const t=this.dirtyStart,e=this.dirtyEnd,i=this.texelSize;if(t>e)return null;this._resetRange();const s=!(this._shared||"local"===this._ctype),r=this.pixelType,a=this.layout,n=e$3(this.data);if(!n.slice){if(!s)return {start:t,end:e,data:null,pixelType:r,layout:a};return {start:t,end:e,data:new(G(this.pixelType))(Array.prototype.slice.call(this.data,t*i,(e+1)*i)),pixelType:r,layout:a}}return {start:t,end:e,data:s&&n.slice(t*i,(e+1)*i)||null,pixelType:r,layout:a}}_initData(t,e,i,s){const r=i&&"local"!==s?SharedArrayBuffer:ArrayBuffer,a=G(t),o=new a(new r(e*e*4*a.BYTES_PER_ELEMENT));for(let n=0;n<o.length;n+=4)o[n+1]=255;return o}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0;}}class O{constructor(t,e){this._client=t,this.config=e,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(N),this._targetType=0,this._abortController=a$2(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const i=e.supportsTextureFloat?5126:5121;A(`Creating AttributeStore ${j.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:i,layout:15},{pixelType:i,layout:15}],this._blocks=this._blockDescriptors.map((()=>null));}destroy(){this._abortController.abort();}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(i,s){this.config=s;const r=s.schema.processors[0].storage,a=m$1(this._schema,r);if((i.targets.feature||i.targets.aggregate)&&(i.storage.data=!0),a&&(t$2("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",a),i.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!t$3(r))){switch(r.target){case"feature":this._targetType=U;break;case"aggregate":this._targetType=R;}for(const t of r.mapping)this._bindAttribute(t);}}onTileData(t,i){if(t$3(i.addOrUpdate))return;const s=i.addOrUpdate.getCursor();for(;s.next();){const t=s.getDisplayId();this.setAttributeData(t,s);}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=a$2();}async setHighlight(t,e){const i=1,s=this._getBlock(0),r=e.map((t=>M(t)));s.lock(),s.unsetComponentAllTexels(0,i),s.setComponent(0,i,r),s.unlock(),this._idsToHighlight.clear();for(const a of t)this._idsToHighlight.add(a);await this.sendUpdates();}async updateFilters(e,i){const{config:s,service:r,spatialReference:a}=i,{filters:o}=s,n=o.map(((t,e)=>this._updateFilter(t,e,r,a)));(await Promise.all(n)).some((t=>t))&&(e.storage.filters=!0,t$2("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"));}setData(t,e,i,s){const r=M(t);this._ensureSizeForTexel(r),this._getBlock(e).setData(t,i,s);}getData(t,e,i){return this._getBlock(e).getData(t,i)}getHighlightFlag(t){return this._idsToHighlight.has(t)?O$1:0}unsetAttributeData(t){const e=M(t);this._getBlock(0).setData(e,0,0);}setAttributeData(t,e){const i=M(t);if(this._ensureSizeForTexel(i),this._getBlock(0).setData(i,0,this.getFilterFlags(e)),this._targetType!==C(t))return;const s=this._attributeComputeMap,r=this.config.supportsTextureFloat?1:2,a=4;s.size&&s.forEach(((t,s)=>{const o=s*r%a,n=Math.floor(s*r/a),l=this._getBlock(n+K$1),h=t(e);if(this.config.supportsTextureFloat)l.setData(i,o,h);else if(h===c$2)l.setData(i,o,255),l.setData(i,o+1,255);else {const t=e$4(Math.round(h),-32767,32766)+32768,e=255&t,s=(65280&t)>>8;l.setData(i,o,e),l.setData(i,o+1,s);}}));}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=z(),this._nextUpdate.promise;const t={blocks:this._blocks.map((t=>r$4(t)?t.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const e=()=>{if(this._currUpdate=null,this._nextUpdate){const t=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>t.resolve()));}},i=this._client.update(t,this._signal).then(e).catch(e);return this._client.render(this._signal),i})).catch((t=>g(t)?(this._createResourcesPromise=null,this._createResources()):(w.error(new s$2("mapview-attribute-store","Encountered an error during client update",t)),Promise.resolve()))),this._currUpdate}_ensureSizeForTexel(t){for(;t>=this._size*this._size;)if(this._expand())return}_bindAttribute(t){function e(){return t.normalizationField?e=>{const i=e.readAttribute(t.normalizationField);if(!i)return null;return e.readAttribute(t.field)/i}:e=>e.readAttribute(t.field)}function i(){return t.normalizationField&&w.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),e=>e.getComputedNumericAtIndex(t.fieldIndex)}let s;if(null!=t.fieldIndex)s=i();else {if(!t.field)return;s=e();}if(t.valueRepresentation){s=I(s,(e=>r$5(e,t.valueRepresentation)));}const r=t=>null===t||isNaN(t)||t===1/0?c$2:t;this._attributeComputeMap.set(t.binding,I(s,r));}_createResources(){if(r$4(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(J),A("Initializing AttributeStore");const t={shared:j.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:y(this._blocks,(t=>({textureOnly:t.textureOnly,buffer:t.buffer,pixelType:t.pixelType})))},r=this._client.initialize(t,this._signal).catch((t=>{g(t)?this._createResourcesPromise=null:w.error(new s$2("mapview-attribute-store","Encountered an error during client initialization",t));}));return this._createResourcesPromise=r,r.then((()=>t$3(this._createResourcesPromise)?this._createResources():void 0)),r}_getBlock(t){const e=this._blocks[t];if(r$4(e))return e;A(`Initializing AttributeBlock at index ${t}`);const s=j.sharedArrayBuffer,r=this._client.type,a=new P(s,r,this._size,this._blockDescriptors[t]);return this._blocks[t]=a,this._createResourcesPromise=null,a}_expand(){if(this._size<this.config.maxTextureSize){const t=this._size<<=1;return A("Expanding block size to",t,this._blocks),d$4(this._blocks,(e=>e.expand(t))),this._createResourcesPromise=null,this._size=t,0}return w.error(new s$2("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}async _updateFilter(t,s,r,a){const o=this._filters[s],n=r$4(o)&&o.hash;if(!o&&!t)return !1;if(n===JSON.stringify(t))return !1;if(t$3(t)){const t=1<<s+1,e=this._getBlock(0);return this._filters[s]=null,e.setComponentAllTexels(0,t),this.sendUpdates(),!0}const l=await this._getFilter(s,r);return await l.update(t,a),!0}async _getFilter(t,e){const s=this._filters[t];if(r$4(s))return s;const{default:r}=await import('./FeatureFilter-cf4db136.js'),a=new r({geometryType:e.geometryType,hasM:!1,hasZ:!1,timeInfo:e.timeInfo,fieldsIndex:new e$2(e.fields)});return this._filters[t]=a,a}isVisible(t){return !!(2&this._getBlock(0).getData(t,0))}getFilterFlags(t){let i=0;const s=B(t.getDisplayId());for(let a=0;a<this._filters.length;a++){const r=!!(s&1<<a),o=this._filters[a];i|=(!r||t$3(o)||o.check(t)?1:0)<<a;}let r=0;if(this._idsToHighlight.size){const e=t.getObjectId();r=this.getHighlightFlag(e);}return i<<1|r}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
const t=2147483648;function u$1(e,r){return ((r?t:0)|e)>>>0}class d{constructor(){this._freeIds=[],this._idCounter=1;}createId(e=!1){return u$1(this._getFreeId(),e)}releaseId(e){this._freeIds.push(e);}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.20/esri/copyright.txt for details.
*/
function s(t,e,s){if(!(t.length>e))for(;t.length<=e;)t.push(s);}const i=2147483647,n=2147483648,r=(t,e)=>((e?n:0)|t)>>>0;class u{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new d,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[];}createBitset(){const e=this._bitsets.length;return this._bitsets.push(t$4.create(this._allocatedSize,i)),e+1}getBitset(t){return this._bitsets[t-1]}_expand(){this._allocatedSize<<=1;for(const t of this._bitsets)t.resize(this._allocatedSize);}_ensureNumeric(t,e){this._numerics[t]||(this._numerics[t]=[]);s(this._numerics[t],e,0);}_ensureInstanceId(t){s(this._instanceIds,t,0);}_ensureString(t,e){this._strings[t]||(this._strings[t]=[]);s(this._strings[t],e,null);}createDisplayId(t=!1){const e=this._idGenerator.createId();return e>this._allocatedSize&&this._expand(),r(e,t)}releaseDisplayId(t){for(const e of this._bitsets)e.unset(t);return this._idGenerator.releaseId(t&i)}getComputedNumeric(t,e){return this.getComputedNumericAtIndex(t&i,0)}setComputedNumeric(t,e,s){return this.setComputedNumericAtIndex(t&i,s,0)}getComputedString(t,e){return this.getComputedStringAtIndex(t&i,0)}setComputedString(t,e,s){return this.setComputedStringAtIndex(t&i,0,s)}getComputedNumericAtIndex(t,e){const s=t&i;return this._ensureNumeric(e,s),this._numerics[e][s]}setComputedNumericAtIndex(t,e,s){const n=t&i;this._ensureNumeric(e,n),this._numerics[e][n]=s;}getInstanceId(t){const e=t&i;return this._ensureInstanceId(e),this._instanceIds[e]}setInstanceId(t,e){const s=t&i;this._ensureInstanceId(s),this._instanceIds[s]=e;}getComputedStringAtIndex(t,e){const s=t&i;return this._ensureString(e,s),this._strings[e][s]}setComputedStringAtIndex(t,e,s){const n=t&i;this._ensureString(e,n),this._strings[e][n]=s;}getXMin(t){return this._bounds[4*(t&i)]}getYMin(t){return this._bounds[4*(t&i)+1]}getXMax(t){return this._bounds[4*(t&i)+2]}getYMax(t){return this._bounds[4*(t&i)+3]}setBounds(t,e){const n=e.readHydratedGeometry();if(!n||!n.coords.length)return !1;let r=1/0,u=1/0,h=-1/0,o=-1/0;n.forEachVertex(((t,e)=>{r=Math.min(r,t),u=Math.min(u,e),h=Math.max(h,t),o=Math.max(o,e);}));const d=t&i;return s(this._bounds,4*d+4,0),this._bounds[4*d]=r,this._bounds[4*d+1]=u,this._bounds[4*d+2]=h,this._bounds[4*d+3]=o,!0}}

export { M, O, c, i$1 as i, l, u, v };
