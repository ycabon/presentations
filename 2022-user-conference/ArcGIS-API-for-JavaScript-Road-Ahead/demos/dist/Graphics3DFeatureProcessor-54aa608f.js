import { B as e, C as d, D as n, E as f, d as b, w, q as x, r, pC as i, eI as d$1, t, c0 as w$1, Z as s, fv as A, b4 as h, fx as h$1, fy as a, dX as l$1, lI as y, bz as j, gb as e$1, gc as i$1, kF as C, kG as E, d1 as m, pD as T, k1 as u, g, jZ as a$1, j_ as s$2, b3 as l$3, a as n$2, bh as f$2, bG as e$2, mi as g$1, k4 as M$1, k2 as z, k3 as r$1 } from './_virtual_index-9b831d4a.js';
import { f as f$1, F as Fe } from './Graphics3DScaleVisibility-2c856a9f.js';
import { d as d$2, l as l$2, s as s$1 } from './Graphics3DObjectStates-f844df23.js';
import { n as n$1 } from './attributeUtils-cf3c0bd5.js';
import { o } from './floorFilterUtils-776aae8e.js';
import { Y } from './QueryEngine-12d30a72.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const c=Y;let l=class extends f{constructor(e){super(e),this._dataQueryEngineInstance=null;}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return "polygon";default:return}}get defaultQueryJSON(){return new b({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}destroy(){this.clear();}clear(){return !!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,r,t){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,r),t)}async executeQueryForCount(e,r){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),r)}async executeQueryForExtent(e,r){const{count:t,extent:s}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),r);return {count:t,extent:w.fromJSON(s)}}async executeQueryForIds(e,r){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),r)}async executeQueryForLatestObservations(e,r){const t=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),r),s=x.fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}async executeQuery(e,r){const t=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),r),s=x.fromJSON(t);return s.features.forEach((e=>{e.layer=this.layer,e.sourceLayer=this.layer;})),s}_ensureQueryJSON(e,r$1){let s=this.defaultQueryJSON;return r(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),s=e.toJSON()),r(r$1)&&(s={...s,sceneFilter:{...r$1,geometry:r$1.geometry.toJSON()}}),s}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,r=this.layer.objectIdField,t=i.toJSON(this._queryGeometryType),s=this.layer.fields.map((e=>e.toJSON())),a=this.layerView.view.resourceController.scheduler,n=this.priority,o=this.spatialReference.toJSON(),i$1=this.layerView.processor.featureStore,{hasZ:u,hasM:l}=this.layerView;return this._dataQueryEngineInstance=new c({hasZ:u,hasM:l,geometryType:t,fields:s,timeInfo:e,spatialReference:o,objectIdField:r,featureStore:i$1,scheduler:a,priority:n}),this._dataQueryEngineInstance}};e([d({constructOnly:!0})],l.prototype,"layerView",void 0),e([d({constructOnly:!0})],l.prototype,"priority",void 0),e([d({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],l.prototype,"spatialReference",void 0),e([d({readOnly:!0,aliasOf:"layerView.layer"})],l.prototype,"layer",void 0),e([d({readOnly:!0})],l.prototype,"_queryGeometryType",null),e([d({readOnly:!0})],l.prototype,"defaultQueryJSON",null),l=e([n("esri.views.3d.layers.graphics.QueryEngine")],l);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let F=class extends d$1{constructor(e){super(e),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updateVisibility=async e=>{if(t(this._compositedFeatureFilter)&&t(this._sceneFilter)||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),e);try{const t=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,e);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((e=>t.has(e)));}),e)}catch(t){return w$1(t),s.getLogger(this.declaredClass).warn(`FeatureFilter query failed: ${t}`,{error:t}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0);}),e)}};}initialize(){const e=A.FILTER_VISIBILITY;this._queryEngine=new l({priority:e,layerView:this._layerView}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this.updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),h);}destroy(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=h$1(this._updateTask),this._frameTask=a(this._frameTask),this._queryEngine=l$1(this._queryEngine),this._set("context",null);}get updating(){return this.running||this.updatingHandles.updating||r(this._updateTask)&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return t(this._compositedFeatureFilter)&&t(this._sceneFilter)}get _featureFilter(){return "filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return "layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return o(this._layerView)}get _timeExtent(){return "timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_timeExtent:t$1,_floorFilter:r$1}=this;if(t(t$1)&&t(r$1))return e;const i=r(e)?e.clone():new y;if(r(t$1)&&(i.timeExtent=r(i.timeExtent)?i.timeExtent.intersection(t$1):t$1),r(r$1)){const e=t(i.where)||""===i.where;i.where=e?r$1:`(${i.where}) AND (${r$1})`;}return i}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0;}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility();}runTask(e){this._updateRequested&&(this._updateTask=h$1(this._updateTask),this._updateTask=j(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e);}};e([d({constructOnly:!0})],F.prototype,"context",void 0),e([d()],F.prototype,"updating",null),e([d()],F.prototype,"running",null),e([d()],F.prototype,"defaultVisibility",null),e([d()],F.prototype,"_featureFilter",null),e([d()],F.prototype,"_sceneFilter",null),e([d()],F.prototype,"_floorFilter",null),e([d()],F.prototype,"_timeExtent",null),e([d()],F.prototype,"_compositedFeatureFilter",null),e([d()],F.prototype,"_layerView",null),e([d()],F.prototype,"_updateTask",void 0),e([d()],F.prototype,"_updateRequested",void 0),F=e([n("esri.views.3d.layers.support.FeatureVisibilityFilter")],F);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let P=class extends d$1{constructor(e){super(e),this.type="graphics-3d",this.elevationFeatureExpressionEnabled=!1,this.dataExtent=null,this.drapeSourceType=e$1.Features,this.preferredUpdatePolicy=i$1.ASYNC,this.suspendResumeExtent=null;}normalizeCtorArgs(e){const{owner:t,updateClippingExtent:i,dataExtent:s,elevationFeatureExpressionEnabled:r,preferredUpdatePolicy:n}=e;return {owner:t,updateClippingExtent:i,dataExtent:s,frustumVisibility:e.frustumVisibilityEnabled?new d$2:null,scaleVisibility:e.scaleVisibilityEnabled?new f$1:null,filterVisibility:(e.filterVisibilityEnabled||e.timeExtentEnabled)&&"multipatch"!==e.owner.layer.geometryType?new F({context:{layerView:t,getFeatureCount:()=>this.graphics3DGraphics?.size??0,setAllFeaturesVisibility:e=>this.graphicsCore?.setAllFeaturesVisibility(e),clearFeaturesVisibility:()=>this.graphicsCore?.clearFeaturesVisibility(),updateFeatureVisibilities:e=>this.graphicsCore?.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(C.FILTER,e(this.graphicsCore.getObjectId(t)),E.GRAPHIC)))}}):null,elevationAlignment:e.elevationAlignmentEnabled?new l$2:null,elevationFeatureExpressionEnabled:r,preferredUpdatePolicy:n}}initialize(){const e=new Fe({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.scaleVisibility.layerMinMaxScaleChangeHandler())),this.elevationAlignment&&this.updatingHandles.add((()=>this.layer.elevationInfo),((e,t)=>{m(e,t)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange());})),this.updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this.updatingHandles.add((()=>this.layer.labelingInfo),((e,t)=>{m(e,t)&&this.graphicsCore.updateLabelingInfo();})),this.updatingHandles.add((()=>this.preferredUpdatePolicy),(e=>this.graphicsCore.preferredUpdatePolicy=e)),r(this.frustumVisibility)&&this.frustumVisibility.setup(this);const t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t);const s=this.owner;if(this.elevationAlignment){const e=s.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,e);}this._set("objectStates",new s$1(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",s.view.deconflictor.addGraphicsOwner(this.graphicsCore)),this._set("initializePromise",this._initializeAsync());}async _initializeAsync(){await T(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates}));const e=this.owner;this.updatingHandles.add((()=>this.layer.renderer),(e=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(e)))),this.updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await T(this.graphicsCore.updateLabelingInfo());}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",l$1(this.frustumVisibility)),this._set("scaleVisibility",l$1(this.scaleVisibility)),this._set("filterVisibility",l$1(this.filterVisibility)),this._set("elevationAlignment",l$1(this.elevationAlignment)),this._set("objectStates",l$1(this.objectStates)),this._set("graphicsCore",l$1(this.graphicsCore)),this._set("owner",null);}get layer(){return this.owner.layer}get suspendResumeExtentMode(){return "suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility?.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return t(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibility?.suspended&&(e.outsideScaleRange=!0),r(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return !!(this.graphicsCore?.updating||r(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles?.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return "filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return "featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.resourceController.memoryController.memoryFactor,t=this.graphicsCore?.displayFeatureLimit;if(1===e)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e),s=Math.ceil(t.maximumTotalNumberOfFeatures*e),r=Math.ceil(t.minimumTotalNumberOfFeatures*e);return {...t,maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:r}}get usedMemory(){return this.graphicsCore?.usedMemory??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return {core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:t(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(u.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,i){if(e instanceof b){const{set:t,handle:s}=this.objectStates.acquireSet(u.Highlight,i);return this.owner.queryObjectIds(e).then((e=>this.objectStates.setObjectIds(t,e))),s}if("number"==typeof e||"string"==typeof e)return this.highlight([e],i);if(e instanceof g)return this.highlight([e],i);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof g){const t=e;if(null==n$1(this.layer.fieldsIndex,t[0].attributes,i)){const e=t.map((e=>e.uid)),{set:i,handle:s}=this.objectStates.acquireSet(u.Highlight,null);return this.objectStates.setUids(i,e),s}e=t.map((e=>n$1(this.layer.fieldsIndex,e.attributes,i)));}if("number"==typeof e[0]||"string"==typeof e[0]){const t=e,{set:s,handle:r}=this.objectStates.acquireSet(u.Highlight,i);return this.objectStates.setObjectIds(s,t),r}}return H}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e);}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e);}getRenderingInfo(e,t,i){const s=a$1(e,{renderer:t,arcade:i});if(r(s)&&s.color){const e=s.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255;}return s}getRenderingInfoAsync(e,t,i,s){return s$2(e,{renderer:t,arcade:i,...s})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t);}refreshFilter(){r(this.filterVisibility)&&this.filterVisibility.reapply();}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics());}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(l$3((()=>this.suspendResumeExtentMode),(()=>{switch(this.handles.remove(U),this.suspendResumeExtentMode){case"computed":this.handles.add([l$3((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),h),l$3((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],U);break;case"data":this.handles.add([f$2((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),h),l$3((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(e$2(this.dataExtent))))],U);break;default:n$2(this.suspendResumeExtentMode);}}),h));}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null);}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!g$1(e,i))return;e=M$1(e,i);}return z(e,t,r$1,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){r(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e);}};e([d()],P.prototype,"type",void 0),e([d({constructOnly:!0})],P.prototype,"owner",void 0),e([d()],P.prototype,"layer",null),e([d({constructOnly:!0})],P.prototype,"updateClippingExtent",void 0),e([d({constructOnly:!0})],P.prototype,"elevationFeatureExpressionEnabled",void 0),e([d({constructOnly:!0})],P.prototype,"graphicsCore",void 0),e([d({constructOnly:!0})],P.prototype,"scaleVisibility",void 0),e([d({constructOnly:!0})],P.prototype,"filterVisibility",void 0),e([d({constructOnly:!0})],P.prototype,"elevationAlignment",void 0),e([d({constructOnly:!0})],P.prototype,"frustumVisibility",void 0),e([d({readOnly:!0})],P.prototype,"deconfliction",void 0),e([d({readOnly:!0})],P.prototype,"labeling",void 0),e([d({readOnly:!0})],P.prototype,"objectStates",void 0),e([d()],P.prototype,"initializePromise",void 0),e([d()],P.prototype,"suspendResumeExtentMode",null),e([d()],P.prototype,"dataExtent",void 0),e([d()],P.prototype,"scaleVisibilitySuspended",null),e([d()],P.prototype,"suspended",null),e([d()],P.prototype,"legendEnabled",null),e([d()],P.prototype,"suspendInfo",null),e([d()],P.prototype,"updating",null),e([d()],P.prototype,"updatingRemaining",null),e([d()],P.prototype,"featureStore",null),e([d()],P.prototype,"view",null),e([d()],P.prototype,"loadedGraphics",null),e([d()],P.prototype,"fullOpacity",null),e([d()],P.prototype,"filter",null),e([d()],P.prototype,"slicePlaneEnabled",null),e([d()],P.prototype,"drapeSourceType",void 0),e([d()],P.prototype,"updatePolicy",null),e([d()],P.prototype,"preferredUpdatePolicy",void 0),e([d()],P.prototype,"displayFeatureLimit",null),P=e([n("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],P);const M=P,U="suspendResumeExtentMode",H={remove(){},pause(){},resume(){}};

export { F, M, l };
