import { ku as n, bE as u$1, k_ as a$1, k$ as y, l0 as h, kC as G, l1 as R, l2 as b, B as e$1, C as d$2, D as n$1, E as f, by as t$1, aZ as n$2, b3 as l$2, fv as A, gc as i, r as r$1, l3 as _$1, h5 as U, b4 as h$1, ix as u$2, k1 as u$3, dW as n$3 } from './_virtual_index-9b831d4a.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const _=.05;class a{constructor(){this._extents=new n({allocator:t=>t||u$1()}),this._tmpExtent=u$1(),this._dirty=!1;}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear();}add(t){this._contains(t)||(this._removeContained(t),a$1(this._extents.pushNew(),t),this._dirty=!0);}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(t){return this._mergeTight(t),t.hasProgressed}_mergeTight(t=G){const e=this._extents,o=new Set;let i=0;for(;i!==e.length;){e.sort(((t,e)=>t[0]-e[0])),i=e.length,o.clear();for(let i=0;i<e.length;++i){if(t.done)return;const h$1=e.getItemAt(i);for(let t=i+1;t<e.length;++t){const r=e.getItemAt(t);if(r[0]>=h$1[2])break;o.add(r);}o.forEach((i=>{if(h$1===i)return;if(i[2]<=h$1[0])return void o.delete(i);const a=y(h$1),c=y(i),g=this._tmpExtent;h(h$1,i,g);const m=a+c;(y(g)-m)/m<_&&(a$1(h$1,g),o.delete(i),e.remove(i),t.madeProgress());})),o.add(h$1);}}this._dirty=!1;}_contains(t){return this._extents.some((e=>R(e,t)))}_removeContained(t){this._extents.filterInPlace((e=>!R(t,e)));}get test(){const t=this;return {containsPoint:e=>t._extents.some((t=>b(t,e)))}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let d$1=class extends f{constructor(){super(...arguments),this.dirtyExtents=new a,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new t$1,this.updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new n$2;}setup(e,t,i,s){this.graphicsCoreOwner=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=s;const r=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add([s.on("elevation-change",(e=>this._elevationChanged(e))),l$2((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),r.registerTask(A.ELEVATION_ALIGNMENT,this)]);}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null;}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating");}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this.updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"));}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating");}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this._markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating");}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i$1=this.graphicsCore.effectiveUpdatePolicy===i.ASYNC;for(const s of this.dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(s);if(this.dirtyGraphicsSet.delete(s),r$1(a)&&(a.alignWithElevation(this.elevationProvider,t,i$1),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const s=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);r$1(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e);})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-s)+.9*this.averageExtentUpdateSize,e.madeProgress();}}_markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)));}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.graphicsCoreOwner.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0);}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating");}};e$1([d$2({readOnly:!0})],d$1.prototype,"updating",null),e$1([d$2({readOnly:!0})],d$1.prototype,"updatingRemaining",null),d$1=e$1([n$1("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],d$1);const l$1=d$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const l=1.2;let u=class extends f{constructor(){super(...arguments),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this._handles=new t$1,this._graphicsCoreOwner=null,this.updating=!0;}setup(e){this._graphicsCoreOwner=e,this._extentIntersection=new _$1({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,s=t.basemapTerrain,o=t.resourceController.scheduler;this._handles.add([t.on("resize",(()=>this._viewChange())),l$2((()=>t.state.camera),(()=>this._viewChange()),U),o.registerTask(A.FRUSTUM_VISIBILITY,this),s.on("elevation-bounds-change",(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([l$2((()=>[s.baseOpacity,s.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),h$1)]);}destroy(){this._graphicsCoreOwner=null,this._extent=null,this._extentIntersection=null,this._handles&&(this._handles.destroy(),this._handles=null);}_setDirty(){this.updating||this._set("updating",!0);}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty();}_viewChange(){this._setDirty();}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0;}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0;}_updateIsVisibleBelowSurface(){const e=this._graphicsCoreOwner.view,t=e.basemapTerrain,s="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this._isVisibleBelowSurface=s||!t.opaque||i;}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this._graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*u$2(e.spatialReference).radius;else {const{min:s,max:i}=e.basemapTerrain.elevationBounds;t=s-Math.max(1,(i-s)*(l-1));}this._extentIntersection.update(this._extent,e.spatialReference,t);}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this._extent)return void this._set("suspended",!1);this._updateExtentIntersection();const e=this._graphicsCoreOwner.view.frustum,t=u$2(this._graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t));}};e$1([d$2({readOnly:!0})],u.prototype,"suspended",void 0),e$1([d$2({readOnly:!0})],u.prototype,"updating",void 0),u=e$1([n$1("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],u);const d=u;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var t;!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT";}(t||(t={}));class r{constructor(){this.items=[];}addObject(e,r){this.items.push({type:t.Object,objectStateId:r,object:e});}addRenderGeometry(e,r,o){this.items.push({type:t.RenderGeometry,objectStateId:r,renderGeometry:e,owner:o});}addExternal(e,r){this.items.push({type:t.External,objectStateId:r,remove:e});}remove(e){for(let t=this.items.length-1;t>=0;--t){const r=this.items[t];r.objectStateId===e&&(this._removeObjectStateItem(r),this.items.splice(t,1));}}removeObject(e){for(let r=this.items.length-1;r>=0;--r){const o=this.items[r];o.type===t.Object&&o.object===e&&(this._removeObjectStateItem(o),this.items.splice(r,1));}}removeRenderGeometry(e){for(let r=this.items.length-1;r>=0;--r){const o=this.items[r];o.type===t.RenderGeometry&&o.renderGeometry===e&&(this._removeObjectStateItem(o),this.items.splice(r,1));}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e);})),this.items=[];}_removeObjectStateItem(r){switch(r.type){case t.Object:r.objectStateId.channel===u$3.Highlight?r.object.removeHighlight(r.objectStateId):r.objectStateId.channel===u$3.MaskOccludee&&r.object.removeOcclude(r.objectStateId);break;case t.RenderGeometry:r.owner.removeRenderGeometryObjectState(r.renderGeometry,r.objectStateId);break;case t.External:r.remove(r.objectStateId);}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e{constructor(e,i){this.stateType=e,this.objectIdField=i,this.objectStateSet=new r,this.ids=new Set,this.paused=!1;}hasGraphic(t){if(this.objectIdField){const e=t.graphic.attributes[this.objectIdField];return this.ids.has(e)}return this.ids.has(t.graphic.uid)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s{constructor(t){this._graphicsCore=t,this._stateSets=new Array;}destroy(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll())),this._stateSets=null;}acquireSet(s,a){const i=new e(s,a);this._stateSets.push(i);const h=n$3((()=>this.releaseSet(i)));return {set:i,handle:h}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;-1!==e&&this._stateSets.splice(e,1);}_addObjectStateSet(t,e){t.addObjectStateSet(e.stateType,e.objectStateSet);}_removeObjectStateSet(t,e){t.removeObjectState(e.objectStateSet);}setUid(t,e){t.ids.add(e);const s=this._graphicsCore.graphics3DGraphics.get(e);s&&this._addObjectStateSet(s,t);}setUids(t,e){e.forEach((e=>this.setUid(t,e)));}setObjectIds(t,e){e.forEach((e=>t.ids.add(e))),this._initializeSet(t);}addGraphic(t){this._stateSets.forEach((e=>{!e.paused&&e.hasGraphic(t)&&this._addObjectStateSet(t,e);}));}removeGraphic(t){this._stateSets.forEach((e=>{e.hasGraphic(t)&&this._removeObjectStateSet(t,e);}));}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll()));}_initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach((e=>{e&&t.hasGraphic(e)&&this._addObjectStateSet(e,t);})):t.ids.forEach((s=>{const a=e.get(s);a&&this._addObjectStateSet(a,t);}));}get test(){return {states:this._stateSets}}}

export { d, l$1 as l, s };
