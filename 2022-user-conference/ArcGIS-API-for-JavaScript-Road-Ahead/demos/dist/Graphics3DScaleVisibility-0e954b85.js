import { kY as h, kZ as c$2, k_ as b$3, k$ as u$5, l0 as S$2, l1 as a$1, l2 as c$3, l3 as f, l4 as e$2, l5 as c$4, l6 as i, t as t$2, u as e$3, y as y$1, z as n, A as m$1, b1 as n$1, l7 as O, m as r$1, jb as pn, bL as t$3, l8 as s$3, l9 as p, la as e$4, lb as b$4, aB as f$1, es as s$4, fX as C$1, lc as h$1, B as has, ld as G, bC as t$4, jQ as x$1, jR as t$5, eW as L$1, le as r$2, d8 as i$2, $ as s$5, gV as A, lf as B, fP as r$3, lg as c$5, lh as D, aK as n$2, gL as a$2, li as o, w, gg as y$2, lj as l$3, gJ as i$3, lk as d$2, ll as S$3, lm as y$3, ln as C$2, lo as E$1, lp as n$3, lq as j, kJ as d$3, kK as u$6, eq as n$4, b7 as l$4, bl as f$2, gD as a$3, eX as w$1, lr as F, gf as I, gi as h$2, E as s$6, ja as l$5, a6 as E$2, ls as n$5, lt as t$6, lu as A$1, lv as q, i_ as p$1, kH as j$1, aO as o$1, gm as jn, g0 as u$7, bn as g$1, bk as w$2, lw as e$5, dm as m$2, lx as d$4, ly as T, fD as E$3, lz as Bn, aC as j$2, lA as M, lB as r$4, lC as b$5, lD as m$3, gz as An, kR as f$3, lE as f$4, lF as e$6, jn as A$2, kO as i$4, L as e$7, eb as b$6, lG as C$3, lH as e$8, lI as v$1, bI as u$8, lJ as e$9, lK as S$4, gY as xn, lL as a$4, lM as y$4, lN as h$3, lO as R$1, lP as b$7, lQ as N, hH as U, b8 as h$4, jg as u$a, kS as u$b, eY as d$5, lR as vn, lS as c$6 } from './_virtual_index-1ea2035a.js';
import { s as s$7, u as u$9 } from './rendererConversion-e2907b4c.js';
import { i as i$1 } from './optimizedFeatureQueryEngineAdapter-fcb7e44b.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const a=h.fromSimpleMarkerSymbol(c$2),c$1=b$3.fromSimpleLineSymbol(u$5),S$1=S$2.fromSimpleFillSymbol(a$1),u$4=new c$3({symbolLayers:[new f({material:{color:e$2},edges:new c$4({size:"1px",color:i})})]});function b$2(r){if(t$2(r))return null;switch(r.type){case"mesh":return u$4;case"point":case"multipoint":return a;case"polyline":return c$1;case"polygon":case"extent":return S$1}return null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let l$2=class extends m$1{constructor(t){super(t),this.events=new n$1,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.viewSpatialReference=null,this.featureAdapter={getAttribute:(t,e)=>"graphic"in t?t.graphic.attributes[e]:i$1.getAttribute(t,e),getAttributes:t=>"graphic"in t?t.graphic.attributes:i$1.getAttributes(t),getObjectId:t=>"graphic"in t?O(t.graphic,this.objectIdField):i$1.getObjectId(t),getGeometry:t=>"graphic"in t?t.getAsOptimizedGeometry(this.hasZ,this.hasM):i$1.getGeometry(t),getCentroid:(t,e)=>{if("graphic"in t){let r=null;r$1(t.centroid)?r=t.centroid:"point"===t.graphic.geometry.type&&pn(t.graphic.geometry,u$3,this.viewSpatialReference)&&(r=u$3);const i=new Array(2+(e.hasZ?1:0)+(e.hasM?1:0));return t$2(r)?(i[0]=0,i[1]=0,i[2]=0,i[3]=0):(i[0]=r.x,i[1]=r.y,e.hasZ&&(i[2]=r.hasZ?r.z:0),e.hasM&&(i[e.hasZ?3:2]=r.hasM?r.m:0)),new t$3([],i)}return i$1.getCentroid(t,e)},cloneWithGeometry:(t,e)=>"graphic"in t?new s$3(e,this.featureAdapter.getAttributes(t),null,this.featureAdapter.getObjectId(t)):i$1.cloneWithGeometry(t,e)};}forEachInBounds(t,e){this.getSpatialIndex().forEachInBounds(t,e);}forEachBounds(t,e,r){const s=this.getSpatialIndex();for(const i of t){const t=this.featureAdapter.getObjectId(i);r$1(s.getBounds(t,r))&&e(r);}}};e$3([y$1({constructOnly:!0})],l$2.prototype,"getSpatialIndex",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"toArray",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"forEach",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"hasZ",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"hasM",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"objectIdField",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"viewSpatialReference",void 0),e$3([y$1({constructOnly:!0})],l$2.prototype,"featureSpatialReference",void 0),l$2=e$3([n("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],l$2);const u$3={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e$1{constructor(e){this.schedule=e,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$2 extends p{constructor(r,t,a){super(r,t,a),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=e$4(this.symbol,t));}async doLoad(t){const a=this._calloutSymbolLayer?b$4(this._calloutSymbolLayer.load()):null;try{await super.doLoad(t),f$1(t);}catch(o){throw this._calloutSymbolLayer?.abortLoad(),o}a&&await a;}destroy(){super.destroy(),this._calloutSymbolLayer=s$4(this._calloutSymbolLayer);}createGraphics3DGraphic(r,t){const e=super.createGraphics3DGraphic(r,t);if(r$1(this._calloutSymbolLayer)&&r$1(e)){const t=this._createCalloutGraphic(r);r$1(t)&&e.addAuxiliaryGraphic(t);}return e}globalPropertyChanged(r,t){return !!super.globalPropertyChanged(r,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(r,t,(r=>this._getCalloutGraphicLayer(r))))}updateGeometry(r,t){const a=super.updateGeometry(r,t);if(a&&this._calloutSymbolLayer){const a=this._getCalloutGraphicLayer(r);if(a)return this._calloutSymbolLayer.updateGeometry(a,t)}return a}_createCalloutGraphic(r){const t=r.renderingInfo,a={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return r.renderingInfo=a,this._calloutSymbolLayer.createGraphics3DGraphic(r)}_getCalloutGraphicLayer(r){for(const t of r._auxiliaryGraphics)if(t.graphics3DSymbolLayer===this._calloutSymbolLayer)return t}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function t$1(t,i,e){let p$1;if("point-3d"===t.type)p$1=s$2;else p$1=p;return new p$1(t,i,e)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$1{constructor(t){this._graphicsCore=t,this._idToState=new Map,this._states=new Set;const i=t.owner.layer&&t.owner.layer.objectIdField;i?(this._getGraphicId=t=>O(t,i),this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicByObjectId(t)):(this._getGraphicId=t=>t.uid,this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicById(t));}destroy(){this._idToState.clear(),this._states.forEach(((t,i)=>this.remove(i)));}add(t){const e={remove:()=>this.remove(t)};if(this._states.has(t))return e;const s=this._getGraphicId(t.graphic),a=this._getGraphics3DGraphicById(s);this._states.has(t)||this._states.add(t);return this._ensureStateList(s).push(t),t.displaying=!!r$1(a)&&a.isVisible(),t.isDraped=!!r$1(a)&&a.isDraped,t.tracking=!0,r$1(a)&&t.emit("changed",{}),e}remove(i){if(this._states.has(i)){if(this._idToState.size){const e=this._getGraphicId(i.graphic),s=this._idToState.get(e);s&&(C$1(s,i),0===s.length&&this._idToState.delete(e));}this._states.delete(i),i.tracking=!1,i.displaying=!1;}}addGraphic(t){this._forEachState(t,(i=>{i.displaying=t.isVisible(),i.isDraped=t.isDraped,i.emit("changed",{});}));}removeGraphic(t){this._forEachState(t,(t=>{t.displaying=!1,t.isDraped=!1;}));}updateGraphicGeometry(t){this._forEachState(t,(t=>{t.emit("changed",{});}));}updateGraphicVisibility(t){this._forEachState(t,(i=>{i.displaying=t.isVisible();}));}allGraphicsDeleted(){this._states.forEach((t=>{t.displaying=!1;}));}_ensureStateList(t){const i=this._idToState.get(t);if(i)return i;const e=new Array;return this._idToState.set(t,e),e}_forEachState(t,i){if(0===this._states.size||0===this._idToState.size)return;const e=this._getGraphicId(t.graphic),s=this._idToState.get(e);null!=s&&s.forEach(i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let d$1=class extends m$1{constructor(t){super(t),this._index=new h$1(9,has("esri-csp-restrictions")?t=>({minX:t.extent[0],minY:t.extent[1],maxX:t.extent[2],maxY:t.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1;}setup(t){this._addMany(t);}destroy(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null;}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear());}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(t,e,i){!t$2(e)&&e.equals(this.spatialReference)&&(u$2.minX=t[0],u$2.minY=t[1],u$2.maxX=t[2],u$2.maxY=t[3],this.update(),this._index.search(u$2,(t=>i(t.graphic.uid))));}add(t){this._missing.add(t),this.updating=!0;}remove(t){if(this._missing.delete(t))return void(this.updating=this._missing.size>0);this._index.remove(t);const e=O(t.graphic,this._get("objectIdField"));null!=e&&this._boundsByFeature.delete(e);}_addMany(t){if(0===t.length)return;const e=this._get("objectIdField");for(const s of t){s.computeExtent(this.spatialReference);const t=O(s.graphic,e);null!=t&&this._boundsByFeature.set(t,s.extent);}this._index.load(t);}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1;}forEachInBounds(t,e){u$2.minX=t[0],u$2.minY=t[1],u$2.maxX=t[2],u$2.maxY=t[3],this.update(),this._index.search(u$2,(t=>{e(t);}));}getBounds(t,e){this.update();const s=this._boundsByFeature.get(t);return s?G(e,s):null}};e$3([y$1({constructOnly:!0})],d$1.prototype,"spatialReference",void 0),e$3([y$1({constructOnly:!0})],d$1.prototype,"hasZ",void 0),e$3([y$1({constructOnly:!0})],d$1.prototype,"hasM",void 0),e$3([y$1({constructOnly:!0})],d$1.prototype,"objectIdField",void 0),e$3([y$1()],d$1.prototype,"updating",void 0),e$3([y$1({readOnly:!0})],d$1.prototype,"updatingRemaining",null),d$1=e$3([n("esri.views.3d.layers.graphics.SpatialIndex2D")],d$1);const u$2={minX:0,minY:0,maxX:0,maxY:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const v=1;let b$1=class extends(n$1.EventedMixin(m$1)){constructor(e){super(e),this._elevationOffset=0,this._layerHandes=new t$4;}get spatialReference(){return this.view?.spatialReference}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=x$1(this.view.state.viewingMode),this._intersector.options.store=t$5.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))]);}dispose(){this._layerHandes.destroy();}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=L$1(this.layer.spatialReference),o=r$2(e.unit);this._elevationOffset=i$2(e.offset,0)*o/t;}else this._elevationOffset=0;}getElevation(e,t,o,r){if(R[0]=e,R[1]=t,R[2]=o,!this._renderCoordsHelper.toRenderCoords(R,r,R))return s$5.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,i=this._zmin+n,a=this._zmax+n;this._renderCoordsHelper.setAltitude(H,a,R),this._renderCoordsHelper.setAltitude(L,i,R);const c=e=>e.metadata&&e.metadata.isElevationSource;return this._intersector.reset(H,L,null),this._intersector.intersect(this._intersectLayers,null,v,null,c),this._intersector.results.min.getIntersectionPoint(R)?this._renderCoordsHelper.getAltitude(R):null}_objectChanged(e){const t=this.spatialReference;if(!e.metadata?.isElevationSource||t$2(t))return;A(x);const{lastValidElevationBB:o}=e.metadata;o.isEmpty()||this._expandExtent(t,o.min,o.max,x);const{min:r,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,s,x),B(x,C),this._zmin=Math.min(this._zmin,x[2]),this._zmax=Math.max(this._zmax,x[5]),E.extent=C,E.spatialReference=t,this.emit("elevation-change",E),r$3(o.min,r),r$3(o.max,s);}_computeLayerExtent(e,t){return A(x),r$1(e)&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,x))),x}_expandExtent(e,t,o,r){for(let s=0;s<8;++s)R[0]=1&s?t[0]:o[0],R[1]=2&s?t[1]:o[1],R[2]=4&s?t[2]:o[2],this._renderCoordsHelper.fromRenderCoords(R,R,e),c$5(r,R);return r}};e$3([y$1({constructOnly:!0})],b$1.prototype,"layer",void 0),e$3([y$1({constructOnly:!0})],b$1.prototype,"stageLayer",void 0),e$3([y$1({constructOnly:!0})],b$1.prototype,"view",void 0),e$3([y$1()],b$1.prototype,"spatialReference",null),b$1=e$3([n("esri.views.3d.layers.support.StageLayerElevationProvider")],b$1);const x=A(),C=D(),E={spatialReference:null,extent:C,context:"scene"},R=n$2(),H=n$2(),L=n$2();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var Ue;const Oe=n$2(),je=a$2(),Le="esri.views.3d.layers.graphics.Graphics3DCore",Ve=s$5.getLogger(Le);let Fe=Ue=class extends m$1{constructor(e){super(e),this._propertiesPool=new o({computedExtent:w},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.symbolCreationContext=new e$1(((e,i)=>this._frameTask.schedule(e,i))),this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._handles=new t$4,this._frameTask=y$2,this._suspendSymbolCleanup=!1,this._viewSpatialReference=null,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._loadingSymbols=0,this._pendingUpdatesPool=new l$3({allocator:e=>e||new ke,deallocator:e=>(e.clear(),e)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new l$3,this.preferredUpdatePolicy=i$3.SYNC,this.forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=void 0,this._startCreateGraphics=!1;}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new d$1({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return r$1(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?i$3.ASYNC:i$2(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return !!(this._graphicsWaitingForSymbol.size>0||this.running||this._elevationAlignment?.updating||r$1(this._scaleVisibility)&&this._scaleVisibility.updating||r$1(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating}get suspendedOrOutsideOfView(){return this.owner.suspended||this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,i=e?e.graphics3D.minTotalNumberOfFeatures:0,t=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,s=this.averageSymbolComplexity,a=Math.max(1,r$1(s)?s.primitivesPerFeature:1),n=r$1(s)&&s.drawCallsPerFeature>0?t/s.drawCallsPerFeature*.3:t,o=Math.ceil(r/a),l=Math.max(i,Math.min(t,o,n)),d=this._get("displayFeatureLimit");return d&&d.minimumTotalNumberOfFeatures===i&&d.maximumTotalNumberOfFeatures===t&&d.maximumTotalNumberOfPrimitives===r&&d.averageSymbolComplexity===s&&d.maximumNumberOfFeatures===l?d:{minimumTotalNumberOfFeatures:i,maximumTotalNumberOfFeatures:t,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:s,maximumNumberOfFeatures:l}}get averageSymbolComplexity(){const e=d$2(this._symbolComplexities),i=this._get("averageSymbolComplexity");return 0===e.numComplexities||r$1(i)&&(e.estimated&&(i.primitivesPerFeature>=e.primitivesPerFeature||i.primitivesPerCoordinate>=e.primitivesPerCoordinate||i.drawCallsPerFeature>=e.drawCallsPerFeature)||i.primitivesPerFeature===e.primitivesPerFeature&&i.primitivesPerCoordinate===e.primitivesPerCoordinate&&i.drawCallsPerFeature===e.drawCallsPerFeature)?i:e}get usedMemory(){const e=r$1(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,i=this._getSymbolComplexitiesUsed().reduce(((e,i)=>e+i.memory.resourceBytes),0);return this._usedMemory+e+i}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics)return (this._pendingAdds+this._pendingRemoves)/this._numberOfGraphics>20?0:this._usedMemory/this._numberOfGraphics;if(r$1(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return Math.max(0,(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic)}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}_getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const i=this._symbolConversionCache.get(e.id);if(r$1(i))return i;const t=S$3(e,{geometryType:this.layer?.geometryType,retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=t.symbol||null;return t$2(r)&&t.error&&Ve.error(t.error.message),this._symbolConversionCache.set(e.id,r),r}_getSymbolComplexitiesUsedOrRenderer(e){if(t$2(e))return [];const i=e.getSymbols(),t="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(t||i&&i.length))return [];const r=[],s=this._getSymbolComplexityUsedOrRenderer(t);r$1(s)&&r.push(s);for(const a of i){const e=this._getSymbolComplexityUsedOrRenderer(a);r$1(e)&&r.push(e);}return r}_getSymbolComplexityUsedOrRenderer(e){if(t$2(e))return null;const i=this._symbols.get(e.id);if(r$1(i))return i.complexity;const t=this._getConvertedSymbol(e);return r$1(t)?y$3(t):null}_getSymbolComplexitiesUsed(){const e=[];return this._symbols.forEach((i=>{r$1(i)&&e.push(i.complexity);})),e}get _objectIdField(){return this.layer.objectIdField}initialize(){this._viewSpatialReference=this.owner.view.spatialReference,this._featureStore=new l$2({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e),toArray:()=>Array.from(this.graphics3DGraphics.values())});const e=(e,i,t)=>this.spatialIndex.queryGraphicUIDsInExtent(e,i,t),{componentFactories:i}=this;if(r$1(i.elevationAlignment)){const t=i.elevationAlignment(this,e);this._elevationAlignment=t;}if(r$1(i.scaleVisibility)){const t=i.scaleVisibility(this,e);this._scaleVisibility=t;}if(r$1(i.filterVisibility)){const e=i.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities((i=>i.setVisibilityFlag(C$2.FILTER,e(O(i.graphic,this._objectIdField)),E$1.GRAPHIC))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities((i=>i.setVisibilityFlag(C$2.FILTER,e,E$1.GRAPHIC))),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(C$2.FILTER)))});this._filterVisibility=e;}if(r$1(i.deconflictor)){const e=i.deconflictor(this);this._deconflictor=e;}if(r$1(i.labeler)&&r$1(this._scaleVisibility)){const e=i.labeler(this,this._scaleVisibility);this._labeler=e;}if(r$1(i.objectStates)){const e=i.objectStates(this);this._objectStates=e;}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync();}async _initializeAsync(){const e=this._initializeAbortController.signal,i=this.owner.view;this._viewElevationProvider=new n$3(this._viewSpatialReference,i),this._initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this._sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),r$1(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new j(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const t=d$3(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await u$6(t,this._viewSpatialReference,e,Ve),f$1(e),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=i.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this._handles.add(n$4((()=>i.basemapTerrain.overlayManager.unregisterDrapeSource(e))));}this._handles.add([l$4((()=>this.suspendedOrOutsideOfView),(()=>this._frameTask.reschedule((()=>this._updateLayerVisibility())))),l$4((()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view.screenSizePerspectiveEnabled]),(()=>{const e=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols());})),l$4((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),l$4((()=>this.owner.view.state?.pixelRatio),(()=>this._pixelRatioChange())),l$4((()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._physicalBasedRenderingChange(e))),l$4((()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods),(e=>this._skipHighSymbolLoDsChange(e))),f$2((()=>i.basemapTerrain?.tilingScheme),(e=>{if(!e.spatialReference.equals(this.symbolCreationContext.overlaySR)&&r$1(i.basemapTerrain.spatialReference)&&(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics"))this.recreateAllGraphics();else {const e=()=>this.owner?.loadedGraphics;this._handles.add([a$3(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange();}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange();}})],"loaded-graphics");}}),{initial:!0}),l$4((()=>this.effectiveUpdatePolicy),(e=>{r$1(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===i$3.ASYNC,e===i$3.SYNC&&this.runTask(F);}),w$1)]),this._frameTask=i.resourceController.scheduler.registerTask(I.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add(l$4((()=>this.layer.featureReduction),(()=>this._deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity"),this.rendererChange(this.owner.renderer).catch((()=>{})),this._initializeAbortController=null;}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null);}destroy(){this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._elevationAlignment=s$4(this._elevationAlignment),this._scaleVisibility=s$4(this._scaleVisibility),this._filterVisibility=s$4(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=s$4(this._objectStates),this.clear(),this._featureStore=s$4(this._featureStore),this._updatingPendingLoadedGraphicsChange=h$2(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=s$4(this._graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=s$4(this._handles),this._frameTask.remove(),this._frameTask=y$2,this._viewSpatialReference=null,this._set("owner",null);for(const e in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new s$6("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=h$2(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=s$4(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=s$4(this._spatialIndex);}clear(){this._objectStates?.allGraphicsDeleted(),r$1(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(s$4),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed");}_initializeStage(e,i){this.stage=e._stage,this.stageLayer=new l$5({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},i),this.stage.add(this.stageLayer);const t=this.stageLayer.events;t.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),t.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),t.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),t.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),t.on("vertexAttrsUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)));}notifyGraphicGeometryChanged(e){if(t$2(this._graphicStateTracking)||t$2(e))return;const i=this.graphics3DGraphics.get(e);i&&this._graphicStateTracking.updateGraphicGeometry(i);}notifyGraphicVisibilityChanged(e){if(t$2(this._graphicStateTracking)||t$2(e))return;const i=this.graphics3DGraphics.get(e);i&&this._graphicStateTracking.updateGraphicVisibility(i);}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,i=this._numberOfGraphics>e*ze,t=!this.suspendedOrOutsideOfView&&!i;t!==this._visible&&(this._visible=t,t?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility());}_updateStageLayerVisibility(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0);}getGraphics3DGraphicById(e){return this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,i=this.owner.layer&&this.owner.layer.objectIdField){return O(e,i)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;const i=new Map;return this.graphics3DGraphics.forEach((t=>{if(!t)return;const r=t.graphic,s=this._getGraphicObjectID(r,e);r$1(s)&&i.set(s,t);})),i}get labelsEnabled(){return !(!this._labeler||!this._labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const i=this._deconflictor&&this._deconflictor.labelingInfoChange(e),t=this._labeler&&this._labeler.labelingInfoChange(e);await E$2([i,t]);}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange();}get symbolUpdateType(){if(this._pendingUpdates.size>0)return "unknown";let e=0,i=0;return n$5(this._symbols,((t,r)=>{if(r$1(t)){const s=t.getFastUpdateStatus();if(s.loading>0)return !0;this._graphicsBySymbol.has(r)&&(i+=s.fast,e+=s.slow);}return !1}))?"unknown":i>=0&&0===e?"fast":e>=0&&0===i?"slow":"mixed"}runTask(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining");}setObjectIdVisibility(e,i){i?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);const t=this._findGraphics3DGraphicByObjectId(e);r$1(t)&&this._updateUserVisibility(t);}_findGraphics3DGraphicByObjectId(e){return t$6(this.graphics3DGraphics,(i=>this._getGraphicObjectID(i.graphic)===e))}_updateUserVisibility(e){if(t$2(e))return !1;const i=e.graphic,t=this._getGraphicObjectID(i),r=i.visible&&!this.owner.suspended&&(t$2(t)||!this._objectIdInvisibleSet.has(t));return e.setVisibilityFlag(C$2.USER_SETTING,r,E$1.GRAPHIC)}_whenGraphics3DGraphic(e){const i=this.graphics3DGraphics.get(e.uid);if(i)return Promise.resolve(i);const t=this._whenGraphics3DGraphicRequests[e.uid];if(t)return t.promise;const r=A$1();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,i){const t=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,a=(e,i,s)=>xn(e,r,i,e,t,i,s),n=(e,i,r)=>xn(e,s,i,e,t,i,r),o=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:r$1(i)&&i.useViewElevation,minDemResolution:r$1(i)&&i.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,l=await e.getProjectedBoundingBox(a,n,o,q(i,"signal"));if(!l)return null;const c=l.boundingBox;if(l.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){p$1(c,Oe);const i=i$2(e.getElevation(Oe[0],Oe[1],0,t,"ground"),0);c[2]=Math.min(c[2],i),c[5]=Math.max(c[5],i);}}return {boundingBox:c,screenSpaceObjects:l.screenSpaceObjects}}async whenGraphicBounds(e,i){await j$1((()=>this.owner?.loadedGraphics));const t=this.owner.layer&&this.owner.layer.objectIdField,s=this.owner.loadedGraphics.find((i=>i===e||t&&i.attributes&&e.attributes&&i.attributes[t]===e.attributes[t]));if(!s)throw new s$6("internal:graphic-not-part-of-view","Graphic is not part of this view");const a=await this._whenGraphics3DGraphic(s);return this._boundsForGraphics3DGraphic(a,i)}computeAttachmentOrigin(e,i){const t=this.graphics3DGraphics.get(e.uid);if(!t)return null;const r=t.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;o$1(We,0,0,0);let s=0;if(r.render.num>0){if(!jn(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Me,i))return null;u$7(We,We,Me),s++;}if(r.draped.num>0){const[e,t]=r.draped.origin,a=i$2(this._viewElevationProvider.getElevation(e,t,"ground"),0);if(o$1(Me,e,t,a),!jn(Me,this._viewElevationProvider.spatialReference,Me,i))return null;u$7(We,We,Me),s++;}return s>1&&g$1(We,We,1/s),new w$2({x:We[0],y:We[1],z:We[2],spatialReference:i})}getSymbolLayerSize(e,i){const t=this._symbols.get(e.id);if(t$2(t))throw new s$6("internal:symbol-not-part-of-view","Symbol is not part of this view");const s=e.symbolLayers.indexOf(i);if(-1===s)throw new s$6("internal:missing-symbol-layer","Symbol layer is not in symbol");const a=t.getSymbolLayerSize(s);if(null==a)throw new s$6("internal:missing-size","Symbol layer has no valid size");return a}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed));}graphicUpdateHandler(e){const i=e.graphic.uid,t=this.graphics3DGraphics.get(i);if(!t$2(t)||!t$2(this._graphicsWithoutSymbol.get(i)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(t);break;case"geometry":this._graphicUpdateGeometryHandler(t,e);break;case"symbol":this._graphicUpdateSymbolHandler(t,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(t,e);}}_graphicUpdateGeometryHandler(e,i){const t=i.graphic.geometry;if(t$2(t))return void this._recreateGraphic(i.graphic);if(t$2(e)){const e=i.graphic.symbol&&i.graphic.symbol.id;if(e){const i=this._symbols.get(e);if(r$1(i)&&i.loadStatus===e$5.LOADING)return}return void this._recreateGraphic(i.graphic)}const r=e.graphics3DSymbol;!t$2(i.newValue)&&r.updateGeometry(e,i.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(t);}_graphicUpdateSymbolHandler(e,i){const t=i.graphic,r=r$1(e)?e.graphics3DSymbol:r$1(i.oldValue)?this._symbols.get(i.oldValue.id):null;if(t$2(r)||t$2(i.newValue))return void this._recreateGraphic(t);const s=r.symbol,a=this._getConvertedSymbol(i.newValue);if(r$1(a)&&(a.type!==s.type||"web-style"===a.type)||"web-style"===s.type)return void this._recreateGraphic(t);const n=this._graphicsBySymbol.get(s.id);if(n&&1!==n.size)return void this._recreateGraphic(t);const o=m$2(s,a);if(t$2(o))return void this._updateSymbolMapping(s.id,a);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!d$4(l.diff))return void this._recreateGraphic(t);const d=this._getRenderingInfo(t);if(t$2(d))return void this._recreateGraphic(t);const p=r.extentPadding;for(const h of l.symbolStatePatches)h();if(p!==r.extentPadding&&this._recomputeExtentPadding(),r$1(e))for(const h of l.graphics3DGraphicPatches)h(e,d);this._updateSymbolMapping(s.id,a);}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty());}_graphicUpdateTransformHandler(e,i){}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===i$3.SYNC&&this._cleanupSymbols();}_recreateGraphic(e){this.recreateGraphics([e]);}_beginGraphicUpdate(e){const i=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,i),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating"),i}_endGraphicUpdate(e){e&&(this._graphicsWaitingForSymbol.delete(e.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")));}_recomputeExtentPadding(){let e=0;this._symbols.forEach((i=>{r$1(i)&&(e=Math.max(e,i.extentPadding));})),this._set("extentPadding",e);}_expandComputedExtent(e){const i=je,t=e.spatialReference;T(e,i);const r=this._viewSpatialReference,s=Ue.tmpVec;if(E$3(t,r)||Bn(i[0],i[1],0,t,s,r)&&(i[0]=s[0],i[1]=s[1],Bn(i[3],i[4],0,t,s,r),i[3]=s[0],i[4]=s[1]),!(isFinite(i[0])&&isFinite(i[3])&&isFinite(i[1])&&isFinite(i[4])))return;const a=this.computedExtent;let n=null;const o=isFinite(i[2])&&isFinite(i[5]),l=o&&(!a||null==a.zmin||i[2]<a.zmin),h=o&&(!a||null==a.zmax||i[5]>a.zmax);if(a){(i[0]<a.xmin||i[1]<a.ymin||i[3]>a.xmax||i[4]>a.ymax||l||h)&&(n=this._propertiesPool.get("computedExtent"),n.xmin=Math.min(i[0],a.xmin),n.ymin=Math.min(i[1],a.ymin),n.xmax=Math.max(i[3],a.xmax),n.ymax=Math.max(i[4],a.ymax),n.spatialReference=r);}else n=this._propertiesPool.get("computedExtent"),n.xmin=i[0],n.ymin=i[1],n.xmax=i[3],n.ymax=i[4],n.spatialReference=r;n&&(l&&(n.zmin=i[2]),h&&(n.zmax=i[5]),this._set("computedExtent",n));}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null);}async elevationInfoChange(){this._abortElevationInfoChange();const e=new AbortController;this._elevationInfoChangeAbortController=e;const i=d$3(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await u$6(i,this._viewSpatialReference,e.signal,Ve),f$1(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("elevationInfo",i)?i.forEach((e=>{const i=e.graphic,t=e.labelGraphics;for(const r of t){r.graphics3DSymbolLayer.updateGraphicElevationContext(i,r);}})):this._recreateSymbol(t);})),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange();}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new b$1({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider));}_clearSymbolsAndGraphics(){this.clear(),r$1(this._filterVisibility)&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null);}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics();}recreateAllGraphics(){this._recreateAllGraphics(!1);}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0);}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:i,view:t}=this.owner,r=t.basemapTerrain.tilingScheme&&i&&i.length?i.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r));}_recreateSymbol(e){const i=this._graphicsBySymbol.get(e),t=[];i&&(i.forEach(((e,i)=>{const r=e.usedMemory;this._conditionalRemove(e,i),this._spatialIndex?.remove(e),t.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(i,r),this._updateLayerVisibility(),this._featureStore.events.emit("changed");})),this._graphicsBySymbol.set(e,new Map));const r=this._symbols.get(e);s$4(r),this._symbols.delete(e),this.add(t);}_recreateGraphicsForSymbol(e){const i=this._graphicsBySymbol.get(e);if(i){const e=[];i.forEach((i=>e.push(i.graphic))),this.recreateGraphics(e);}}_conditionalRemove(e,i){this._graphicsDrapedUids.delete(i),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),r$1(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(e);}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===i$3.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):Ve.error("#add()","Cannot add graphics before terrain surface has been initialized"));}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===i$3.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const i of e)if(r$1(i.geometry)&&"mesh"===i.geometry.type&&!i.geometry.loaded)return i$3.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const i of e)this._addGraphic(i,this._getRenderingInfo(i,Ve),i$3.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty();}_addDelayed(e){for(const i of e){const e=i.uid;let t=this._pendingUpdates.get(e);t?t.add?t.state!==Te.NEW&&t.abortController.abort():this._pendingAdds++:(t=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(e,t)),t.add=i;}this.notifyChange("running"),this.notifyChange("updatingRemaining");}remove(e){this.effectiveUpdatePolicy===i$3.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating");}_removeImmediate(e){for(const i of e)this._removeGraphic(i);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty();}_removeDelayed(e){for(const i of e){const e=i.uid,t=this._pendingUpdates.get(e);if(t)t.add&&(t.remove?t.add=null:this._pendingUpdates.delete(e),t.state===Te.LOADING&&t.abortController.abort(),this._pendingAdds--);else {const t=this._pendingUpdatesPool.pushNew();t.remove=i,this._pendingUpdates.set(e,t),this._pendingRemoves++;}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining");}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&Ve.warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0;}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update();else {for(const[i,t]of this._pendingUpdates){if(e.done)break;t.add&&t.state===Te.NEW&&this._processPendingUpdateNew(t);let r=this.effectiveUpdatePolicy;if(!t.remove||t.add&&t.state!==Te.READY||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(t.remove),t.remove=null,r=i$3.SYNC),t.add)switch(t.state){case Te.READY:this._addGraphic(t.add,t.renderingInfo,r),t.add=null,this._pendingAdds--,e.madeProgress();break;case Te.REJECTED:t.add=null,this._pendingAdds--;case Te.LOADING:}null==t.remove&&null==t.add&&this._pendingUpdates.delete(i);}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"));}}_processPendingUpdateNew(e){if(!e.add)return void(e.state=Te.READY);const i=e.add.geometry;r$1(i)&&"mesh"===i.type&&!i.loaded?this._processPendingUpdateNewMesh(e,i):this._processPendingUpdateNewRenderingInfo(e);}async _processPendingUpdateNewMesh(e,i){e.state=Te.LOADING,e.abortController=new AbortController;const t=e.abortController.signal;try{await i.load({signal:t});}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e);}_processPendingUpdateNewError(e,i){e.abortController=null,j$2(i)?e.state=Te.NEW:e.state=Te.REJECTED;}async _processPendingUpdateNewRenderingInfo(e){if(t$2(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,Ve),void(e.state=Te.READY);e.state=Te.LOADING,e.abortController=new AbortController;let i=null;try{i=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal});}catch(t){return e.abortController=null,void(j$2(t)?e.state=Te.NEW:e.state=Te.REJECTED)}t$2(i)||t$2(i.symbol)?(Ve&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=i,e.state=Te.READY;}_addGraphic(e,i,t){if(this._graphicsWithoutSymbol.set(e.uid,e),t$2(i)||t$2(i.symbol)||!M(e))return;has("enable-feature:objectAndLayerId-rendering")&&this.setUidToIdOnAdd&&this.stage.renderView._objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.layer.uid,this.layer.popupEnabled);const r=i.symbol,s=this.getOrCreateGraphics3DSymbol(r,i.renderer);if(t$2(s))return;this._expandComputedExtent(e.geometry);const a=this._beginGraphicUpdate(e),n=new r$4(e,i,this.layer);let o=!1;const l=e=>{e===s.symbol.id&&(o=!0);};this._whenSymbolRemoved.push(l);const d=()=>{if(--this._loadingSymbols,this.destroyed)return;this._whenSymbolRemoved.removeUnordered(l);if(this._graphicsWaitingForSymbol.get(e.uid)!==a||o||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else {const i=this._createGraphics3DGraphic(s,n);this._spatialIndex&&r$1(i)&&this._spatialIndex.add(i),--s.referenced,this._endGraphicUpdate(e);}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty();},p=i=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),o||(j$2(i)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)));};++this._loadingSymbols,t===i$3.ASYNC?s.load((()=>this._frameTask.schedule(d)),(e=>this._frameTask.schedule((()=>p(e))))):s.load(d,p);}_removeGraphic(e){const i=e.uid,t=this.graphics3DGraphics.get(i);if(t){t.graphics3DSymbol.onRemoveGraphic(t);const e=t.usedMemory,r=t.isElevationSource;this._conditionalRemove(t,i),this._spatialIndex?.remove(t);const s=t.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(s).delete(i),this._graphicsWithoutSymbol.delete(i),this._removeGraphics3DGraphic(i,e,r),t.destroy(),this._featureStore.events.emit("changed");}else this._graphicsWithoutSymbol.delete(i),this._graphicsWaitingForSymbol.delete(i),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"));}_hasLabelingContext(e){if(e instanceof b$5||e instanceof m$3){const i=this.symbolCreationContext.layer;return !!i.labelingInfo&&i.labelingInfo.some((i=>i.symbol===e))}return !1}_hasValidSymbolCreationContext(e){return !(e instanceof b$5&&!this._hasLabelingContext(e))||(Ve.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e,i){const t=e.geometry;if(t$2(t))return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!An(t.spatialReference,this._viewSpatialReference))return i&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&r$1(e.symbol))return i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?f$3(e,this.layer):e;let s;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||r$1(this.currentRenderer)))s=this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand);else {s={symbol:r.symbol||b$2(r.geometry)};}return t$2(s)||t$2(s.symbol)?(i&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,i.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,i){const t=e.geometry;if(t$2(t))return Ve&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&r$1(e.symbol))return Ve&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?f$3(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,this.currentRenderer,this._arcadeOnDemand,i)}_createGraphics3DSymbol(e,i){if(!this._hasValidSymbolCreationContext(e))return null;const t=this._getConvertedSymbol(e);if(!t)return null;let r;if(r$1(i)&&"backgroundFillSymbol"in i&&i.backgroundFillSymbol){const e=S$3(i.backgroundFillSymbol,{ignoreDrivers:!0});r$1(e.symbol)&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers);}const s=t$1(t,this.symbolCreationContext,r);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity");}),(()=>{})),s}getOrCreateGraphics3DSymbol(e,i){let t=this._symbols.get(e.id);return void 0===t&&(t=e instanceof f$4?new e$6(e,(e=>this._frameTask.schedule(e)),(e=>this._createGraphics3DSymbol(e,i))):this._createGraphics3DSymbol(e,i),this._symbols.set(e.id,t)),r$1(t)&&++t.referenced,t}trackGraphicState(e){return t$2(this._graphicStateTracking)&&(this._graphicStateTracking=new s$1(this)),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility();}_removeGraphics3DGraphic(e,i,t=!1){this._usedMemory-=i,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,t&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility();}_createGraphics3DGraphic(e,i){const t=i.graphic;if(this._graphicsWithoutSymbol.delete(t.uid),!this._symbols.has(e.symbol.id))return this.add([t]),null;if(this.graphics3DGraphics.has(t.uid))return null;const r=e.createGraphics3DGraphic(i);if(t$2(r))return null;this._addGraphics3DGraphic(r);const s=e.symbol.id;this._graphicsBySymbol.has(s)||this._graphicsBySymbol.set(s,new Map),this._graphicsBySymbol.get(s).set(t.uid,r);if(r.isDraped&&this._graphicsDrapedUids.add(t.uid),r.centroid=null,r$1(t.geometry)&&"point"!==t.geometry.type&&(r.centroid=A$2(t.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),r$1(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(r),r$1(this._filterVisibility)){const{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(C$2.FILTER,e,E$1.GRAPHIC),e||this._filterVisibility.reapply();}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),r$1(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(r);const a=this._whenGraphics3DGraphicRequests[t.uid];return a&&(delete this._whenGraphics3DGraphicRequests[t.uid],a.resolve(r)),r}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null);}async rendererChange(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),t$2(e)&&this._currentRendererChange(null,!1),s$7(e))if(r$1(e)&&e.arcadeRequired){const i=new AbortController;this._rendererChangeAbortController=i;const{arcadeUtils:t}=await this._ensureArcade();f$1(i);const r=t.hasGeometryOperations(e);r&&(await t.enableGeometryOperations(),f$1(i)),this.effectiveUpdatePolicy===i$3.ASYNC?await this._frameTask.schedule((()=>this._currentRendererChange(e,r)),i.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null;}else if(this.effectiveUpdatePolicy===i$3.ASYNC){const i=new AbortController;this._rendererChangeAbortController=i,await this._frameTask.schedule((()=>this._currentRendererChange(e,!1)),i.signal),this._rendererChangeAbortController=null;}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1);}async _ensureArcade(){return t$2(this._arcadeOnDemand)?(this._arcadeOnDemand=await i$4(),this._arcadeOnDemand):this._arcadeOnDemand}_currentRendererChange(e,i){this.currentRenderer=e,this.rendererHasGeometryOperations=i,this.symbolCreationContext.arcade=e$7(this._arcadeOnDemand);const t=this.symbolCreationContext.renderer;if(e===t)return;if(this._symbolConversionCache.clear(),t$2(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=m$2(t,e);this._updateUnchangedSymbolMappings(r,e,t),this.symbolCreationContext.renderer=e,t$2(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,t)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"));}_diffHasSymbolChange(e){for(const i in e.diff)switch(i){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete e.diff[i];break;default:return !0}return !1}_applySymbolSetDiff(e,i,t){e=e||[],i=i||[];const r=[];for(const s of i){const i=this._graphicsBySymbol.get(s.id);i&&i.forEach(((a,n)=>{const o=a.graphic,l=this.layer instanceof b$6?this.layer:null,h=e$7(this._arcadeOnDemand);if(s===t.defaultSymbol&&t.getSymbol(f$3(o,l),{arcade:h})===t.defaultSymbol)return;const d=a.usedMemory;e.length||t.defaultSymbol?r.push(o):this._graphicsWithoutSymbol.set(n,o);const c=this.graphics3DGraphics.get(n);this._conditionalRemove(c,n),a.destroy(),i.delete(n),this._removeGraphics3DGraphic(n,d),this._updateLayerVisibility();})),this._whenSymbolRemoved.forAll((e=>e(s.id)));}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach((e=>r.push(e))),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty();}_applyUniqueValueRendererDiff(e,i,t){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const a=s?s.added.map((e=>e.symbol)):[],n=s?s.removed.map((e=>e.symbol)):[];if(s)for(let e=0;e<s.changed.length;e++)a.push(s.changed[e].newValue.symbol),n.push(s.changed[e].oldValue.symbol);return r?(t.defaultSymbol&&n.push(t.defaultSymbol),i.defaultSymbol&&a.push(i.defaultSymbol)):t.defaultSymbol&&a.length&&n.push(i.defaultSymbol),this._applySymbolSetDiff(a,n,i),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return !1}_calculateUnchangedSymbolMapping(e,i,t){if("unique-value"!==i?.type||"unique-value"!==t?.type||r$1(e)&&"partial"!==e.type)return [];const r=e=>r$1(e)?e.id:null,s=e&&e.diff,a=s&&s.defaultSymbol,n=s&&s.uniqueValueInfos;let o;if(n)o=n.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else {o=[];for(const e of t.uniqueValueInfos){const t=r(e.symbol),s=i.uniqueValueInfos.find((i=>i.value===e.value));s&&t!==r(s.symbol)&&o.push({oldId:t,newId:r(s.symbol)});}}return !a&&t.defaultSymbol&&o.push({oldId:r(t.defaultSymbol),newId:r(i.defaultSymbol)}),o}_updateSymbolMapping(e,i){const t=r$1(i)&&i?"string"==typeof i?i:i.id:null;if(!e||e===t)return;const r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),void 0!==r&&this._graphicsBySymbol.set(t,r);const s=this._symbols.get(e);if(void 0!==s&&(this._symbols.delete(e),this._symbols.set(t,s),r$1(s))){const e="string"==typeof i?null:i;r$1(e)?s.symbol=e:s.symbol.id=t;}}_updateUnchangedSymbolMappings(e,i,t){const r=this._calculateUnchangedSymbolMapping(e,i,t);for(const{oldId:s,newId:a}of r)this._updateSymbolMapping(s,a);}_applyRendererDiff(e,t,r){if(this._diffHasSymbolChange(e))return !1;if(t instanceof C$3&&r instanceof C$3&&this._applyUniqueValueRendererDiff(e,t,r)&&0===Object.keys(e.diff).length)return !0;for(const[i]of this._graphicsBySymbol){const r=this._symbols.get(i);if(r$1(r))switch(r.applyRendererDiff(e,t)){case e$8.Recreate_Symbol:this._recreateSymbol(i);break;case e$8.Recreate_Graphics:this._recreateGraphicsForSymbol(i);case e$8.Fast_Update:}}return !0}opacityChange(){this.forEachGraphics3DSymbol(((e,i)=>e.globalPropertyChanged("opacity",i))),this._updateStageLayerVisibility();}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(((e,i)=>e.globalPropertyChanged("slicePlaneEnabled",i))),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange());}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",i)||this._recreateSymbol(t);}));}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol(((e,i,t)=>this._recreateSymbol(t)));}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,i,t)=>{e.globalPropertyChanged("pixelRatio",i)||this._recreateSymbol(t);}));}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=v$1((()=>{this._updatingPendingLoadedGraphicsChange=null;}));}setClippingExtent(e,i){const t=this.symbolCreationContext.clippingExtent,r=u$8();return e$9(e,r,i)?this.symbolCreationContext.clippingExtent=G(a$2(),r):this.symbolCreationContext.clippingExtent=null,!S$4(this.symbolCreationContext.clippingExtent,t)}modifyGraphics3DGraphicVisibilities(e){let i=!1;this.graphics3DGraphics.forEach((t=>{e(t)&&(i=!0);})),i&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty());}forEachGraphics3DSymbol(e){for(const[i,t]of this._symbols){if(t$2(t))return;e(t,this._graphicsBySymbol.get(i)||Ne,i);}}updateAllGraphicsVisibility(){r$1(this._filterVisibility)&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const i=this._updateUserVisibility(e),t=r$1(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(e);return i||t}));}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(C$2.USER_SETTING,!1,E$1.GRAPHIC)));}_validateRenderer(e){const i=u$9(e,{geometryType:this.layer?.geometryType});if(i){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;Ve.warn(e,i.message);}}_volatileGraphicsUpdated(){this._labeler?.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating");}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach(((i,t)=>{if(t$2(i)||i.referenced>0)return;const r=this._graphicsBySymbol.get(t);r&&0!==r.size||(this._graphicsBySymbol.delete(t),this._symbols.delete(t),s$4(i),e=!0);})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"));}get test(){return {snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this._graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:e=>{this.forcedUpdatePolicy=e;}}}get performanceInfo(){return {visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}};var Te;Fe.tmpVec=n$2(),e$3([y$1({readOnly:!0})],Fe.prototype,"computedExtent",void 0),e$3([y$1()],Fe.prototype,"currentRenderer",void 0),e$3([y$1()],Fe.prototype,"rendererHasGeometryOperations",void 0),e$3([y$1()],Fe.prototype,"_frameTask",void 0),e$3([y$1()],Fe.prototype,"_rendererChangeAbortController",void 0),e$3([y$1()],Fe.prototype,"_elevationInfoChangeAbortController",void 0),e$3([y$1()],Fe.prototype,"_initializeAbortController",void 0),e$3([y$1()],Fe.prototype,"_elevationAlignment",void 0),e$3([y$1()],Fe.prototype,"_scaleVisibility",void 0),e$3([y$1()],Fe.prototype,"_filterVisibility",void 0),e$3([y$1()],Fe.prototype,"_initializePromise",void 0),e$3([y$1()],Fe.prototype,"_spatialIndex",void 0),e$3([y$1({readOnly:!0})],Fe.prototype,"extentPadding",void 0),e$3([y$1()],Fe.prototype,"_updatingPendingLoadedGraphicsChange",void 0),e$3([y$1()],Fe.prototype,"_featureStore",void 0),e$3([y$1()],Fe.prototype,"_deconflictor",void 0),e$3([y$1()],Fe.prototype,"_labeler",void 0),e$3([y$1()],Fe.prototype,"_objectStates",void 0),e$3([y$1()],Fe.prototype,"_loadingSymbols",void 0),e$3([y$1()],Fe.prototype,"preferredUpdatePolicy",void 0),e$3([y$1()],Fe.prototype,"forcedUpdatePolicy",void 0),e$3([y$1({readOnly:!0})],Fe.prototype,"effectiveUpdatePolicy",null),e$3([y$1({constructOnly:!0})],Fe.prototype,"elevationFeatureExpressionEnabled",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"owner",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"layer",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"graphicSymbolSupported",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"getRenderingInfoWithoutRenderer",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"componentFactories",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"setUidToIdOnAdd",void 0),e$3([y$1()],Fe.prototype,"featureStore",null),e$3([y$1()],Fe.prototype,"initializePromise",null),e$3([y$1()],Fe.prototype,"scaleVisibility",null),e$3([y$1()],Fe.prototype,"elevationAlignment",null),e$3([y$1()],Fe.prototype,"objectStates",null),e$3([y$1()],Fe.prototype,"filterVisibility",null),e$3([y$1({readOnly:!0})],Fe.prototype,"updating",null),e$3([y$1({readOnly:!0})],Fe.prototype,"running",null),e$3([y$1({readOnly:!0})],Fe.prototype,"suspendedOrOutsideOfView",null),e$3([y$1({readOnly:!0,dependsOn:[]})],Fe.prototype,"updatingRemaining",null),e$3([y$1({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],Fe.prototype,"displayFeatureLimit",null),e$3([y$1({readOnly:!0,dependsOn:[]})],Fe.prototype,"averageSymbolComplexity",null),e$3([y$1({constructOnly:!0})],Fe.prototype,"hasZ",void 0),e$3([y$1({constructOnly:!0})],Fe.prototype,"hasM",void 0),e$3([y$1()],Fe.prototype,"_objectIdField",null),Fe=Ue=e$3([n(Le)],Fe),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED";}(Te||(Te={}));class ke{constructor(){this.add=null,this.renderingInfo=null,this.state=Te.NEW,this.remove=null;}clear(){this.add=null,this.renderingInfo=null,this.state=Te.NEW,this.abortController=null,this.remove=null;}}const ze=10,We=n$2(),Me=n$2(),Ne=new Map;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const l$1=.05;class _$1{constructor(){this._extents=new l$3({allocator:t=>t||u$8()}),this._tmpExtent=u$8(),this._dirty=!1;}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear();}add(t){this._contains(t)||(this._removeContained(t),a$4(this._extents.pushNew(),t),this._dirty=!0);}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(t){return this._mergeTight(t),t.hasProgressed}_mergeTight(t=F){const e=this._extents,o=new Set;let i=0;for(;i!==e.length;){e.sort(((t,e)=>t[0]-e[0])),i=e.length,o.clear();for(let i=0;i<e.length;++i){if(t.done)return;const h=e.getItemAt(i);if(h){for(let t=i+1;t<e.length;++t){const r=e.getItemAt(t);if(null==r||r[0]>=h[2])break;o.add(r);}o.forEach((i=>{if(h===i)return;if(i[2]<=h[0])return void o.delete(i);const _=y$4(h),a=y$4(i),c=this._tmpExtent;h$3(h,i,c);const g=_+a;(y$4(c)-g)/g<l$1&&(a$4(h,c),o.delete(i),e.remove(i),t.madeProgress());})),o.add(h);}}}this._dirty=!1;}_contains(t){return this._extents.some((e=>R$1(e,t)))}_removeContained(t){this._extents.filterInPlace((e=>!R$1(t,e)));}get test(){const t=this;return {containsPoint:e=>t._extents.some((t=>b$7(t,e)))}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let c=class extends m$1{constructor(e){super(e),this._dirtyExtents=new _$1,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._handles=new t$4,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new n$1;}initialize(){const e=this.elevationProvider,t=this.graphicsCoreOwner.view.resourceController.scheduler;this._handles.add([e.on("elevation-change",(e=>this._elevationChanged(e))),l$4((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),t.registerTask(I.ELEVATION_ALIGNMENT,this)]);}destroy(){this._dirtyGraphicsSet.clear(),this._handles.destroy(),this._handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null;}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating");}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"));}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating");}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run((()=>this._dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating");}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===i$3.ASYNC;for(const r of this._dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),r$1(a)&&(a.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){const t=this._dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);r$1(t)&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e);})),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress();}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this._dirtyGraphicsSet.add(t)));}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0);}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange("updating");}};e$3([y$1()],c.prototype,"graphicsCoreOwner",void 0),e$3([y$1()],c.prototype,"graphicsCore",void 0),e$3([y$1()],c.prototype,"queryGraphicUIDsInExtent",void 0),e$3([y$1()],c.prototype,"elevationProvider",void 0),e$3([y$1({readOnly:!0})],c.prototype,"updating",null),e$3([y$1({readOnly:!0})],c.prototype,"updatingRemaining",null),c=e$3([n("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],c);const l=c;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const u$1=1.2;let d=class extends m$1{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this._handles=new t$4,this.graphicsCoreOwner=null,this.updating=!0;}initialize(){const{graphicsCoreOwner:e}=this;this._extentIntersection=new N({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,s=t.basemapTerrain,i=t.resourceController.scheduler;this._handles.add([t.on("resize",(()=>this._viewChange())),l$4((()=>t.state.camera),(()=>this._viewChange()),U),i.registerTask(I.FRUSTUM_VISIBILITY,this),l$4((()=>s.visibleElevationBounds),(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([l$4((()=>[s.baseOpacity,s.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),h$4)]);}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null,this._handles=s$4(this._handles);}_setDirty(){this.updating||this._set("updating",!0);}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty();}_viewChange(){this._setDirty();}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0;}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0;}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,s="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this._isVisibleBelowSurface=s||!t.opaque||i;}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*u$a(e.spatialReference).radius;else {const{min:s,max:i}=e.basemapTerrain.visibleElevationBounds;t=s-Math.max(1,(i-s)*(u$1-1));}this._extentIntersection.update(this._extent,e.spatialReference,t);}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this._extent)return void this._set("suspended",!1);this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,t=u$a(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t));}};e$3([y$1({readOnly:!0})],d.prototype,"suspended",void 0),e$3([y$1({constructOnly:!0})],d.prototype,"graphicsCoreOwner",void 0),e$3([y$1({readOnly:!0})],d.prototype,"updating",void 0),d=e$3([n("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],d);const _=d;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var t;!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT";}(t||(t={}));class r{constructor(){this._items=[];}addObject(e,r){this._items.push({type:t.Object,objectStateId:r,object:e});}addRenderGeometry(e,r,o){this._items.push({type:t.RenderGeometry,objectStateId:r,renderGeometry:e,owner:o});}addExternal(e,r){this._items.push({type:t.External,objectStateId:r,remove:e});}remove(e){for(let t=this._items.length-1;t>=0;--t){const r=this._items[t];r.objectStateId===e&&(this._removeObjectStateItem(r),this._items.splice(t,1));}}removeObject(e){for(let r=this._items.length-1;r>=0;--r){const o=this._items[r];o.type===t.Object&&o.object===e&&(this._removeObjectStateItem(o),this._items.splice(r,1));}}removeRenderGeometry(e){for(let r=this._items.length-1;r>=0;--r){const o=this._items[r];o.type===t.RenderGeometry&&o.renderGeometry===e&&(this._removeObjectStateItem(o),this._items.splice(r,1));}}removeAll(){this._items.forEach((e=>{this._removeObjectStateItem(e);})),this._items=[];}_removeObjectStateItem(r){switch(r.type){case t.Object:r.objectStateId.channel===u$b.Highlight?r.object.removeHighlight(r.objectStateId):r.objectStateId.channel===u$b.MaskOccludee&&r.object.removeOcclude(r.objectStateId);break;case t.RenderGeometry:r.owner.removeRenderGeometryObjectState(r.renderGeometry,r.objectStateId);break;case t.External:r.remove(r.objectStateId);}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e{constructor(e,i){this.stateType=e,this.objectIdField=i,this.objectStateSet=new r,this.ids=new Set,this.paused=!1;}hasGraphic(t){if(this.objectIdField){const e=t.graphic.attributes[this.objectIdField];return this.ids.has(e)}return this.ids.has(t.graphic.uid)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s{constructor(t){this._graphicsCore=t,this._stateSets=new Array;}destroy(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll())),this._stateSets=null;}acquireSet(s,a){const i=new e(s,a);this._stateSets.push(i);const h=n$4((()=>this.releaseSet(i)));return {set:i,handle:h}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;-1!==e&&this._stateSets.splice(e,1);}_addObjectStateSet(t,e){t.addObjectStateSet(e.stateType,e.objectStateSet);}_removeObjectStateSet(t,e){t.removeObjectState(e.objectStateSet);}setUid(t,e){t.ids.add(e);const s=this._graphicsCore.graphics3DGraphics.get(e);s&&this._addObjectStateSet(s,t);}setUids(t,e){e.forEach((e=>this.setUid(t,e)));}setObjectIds(t,e){e.forEach((e=>t.ids.add(e))),this._initializeSet(t);}addGraphic(t){this._stateSets.forEach((e=>{!e.paused&&e.hasGraphic(t)&&this._addObjectStateSet(t,e);}));}removeGraphic(t){this._stateSets.forEach((e=>{e.hasGraphic(t)&&this._removeObjectStateSet(t,e);}));}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll()));}_initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach((e=>{e&&t.hasGraphic(e)&&this._addObjectStateSet(e,t);})):t.ids.forEach((s=>{const a=e.get(s);a&&this._addObjectStateSet(a,t);}));}get test(){return {states:this._stateSets}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const y=s$5.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");let g=class extends d$5{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0;}initialize(){this.updateScaleRangeActive();const e=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(e.registerTask(I.SCALE_VISIBILITY,this)),this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.layerMinMaxScaleChangeHandler()));}destroy(){this.updatingHandles.removeAll(),this.handles.removeAll(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null;}get updating(){return this._dirty||this.updatingHandles.updating}_setDirty(){this._dirty=!0;}setExtent(e){const i=this.graphicsCoreOwner.view.spatialReference,t=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(i===t)this._extent=e;else {const r=u$8();vn(e,i,r,t)?this._extent=r:this._extent=null;}this._setDirty();}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,i=e.effectiveScaleRange;let t=this.layerScaleEnabled&&u(i.minScale,i.maxScale);e.labelingInfo&&!t&&(t=e.labelingInfo.some((e=>e&&u(e.minScale,e.maxScale))));const r=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.handles.has(b)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),b),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),b)):!t&&this.handles.has(b)&&this.handles.remove(b),r}get running(){return !(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(){const e=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this._layerScaleRangeVisibilityQuery){this._layerScaleRangeVisibilityQuery=!0;const i=this.layer.effectiveScaleRange;e.queryVisibleScaleRange(this._extent,i.minScale,i.maxScale,(e=>this._finishUpdate(e)));}}else this._finishUpdate(!0);}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._dirty=!1;}_visibleAtLayerScale(e){const i=this.layer.effectiveScaleRange;return !this.layerScaleEnabled||c$6(e,i.minScale||0,i.maxScale||0)}_visibleAtLabelScale(e,i){return c$6(e,i.minScale||0,i.maxScale||0)}_graphicScale(e){let i;if(r$1(e.centroid)?i=e.centroid:r$1(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(i=e.graphic.geometry),i){return this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(i):1}return null}_graphicVisible(e){if(!this.layerScaleEnabled)return !0;const i=this._graphicScale(e);return this._visibleAtLayerScale(i)}updateVisibility(e){if(this._scaleRangeActive){const i=this._graphicVisible(e);return e.setVisibilityFlag(C$2.SCALE_RANGE,i,E$1.GRAPHIC)}return !1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return !1;if(!e.labelGraphics||0===e.labelGraphics.length)return !1;const i=this._graphicScale(e),t=this._updateLabelScaleVisibility(e,i);return t&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),t}_updateLabelScaleVisibility(e,i){if(!e.labelGraphics||0===e.labelGraphics.length)return !1;const t=e.labelGraphics[0]._labelClass;if(t&&null!=t.minScale&&null!=t.maxScale){const r=this._visibleAtLabelScale(i,t);if(e.setVisibilityFlag(C$2.SCALE_RANGE,r,E$1.LABEL))return !0}return !1}_scaleUpdateHandler(e){if(this._setDirty(),this.graphicsCoreOwner.suspended)return;const i=e.extent,t=e.scale,s=this._visibleAtLayerScale(t);let l=!1;const c=this.graphicsCoreOwner.view.spatialReference,p=e.spatialReference;if(t$2(p))return void y.error("scaleUpdate: Internal error, no SpatialReference given for tiles");const d=!p.equals(c);if(d){if(!vn(i,p,m,c))return void y.error("scaleUpdate: Internal error, cannot project AABR from "+p+" to wkid "+c)}const g=d?m:i;this.queryGraphicUIDsInExtent(g,c,(e=>{const n=this.graphicsCore.getGraphics3DGraphicById(e);if(t$2(n))return;const c=n.centroid;r$1(c)&&(i[0]>c.x||i[1]>c.y||i[2]<c.x||i[3]<c.y)||(n.setVisibilityFlag(C$2.SCALE_RANGE,s,E$1.GRAPHIC)&&(l=!0),this._updateLabelScaleVisibility(n,t)&&(l=!0));})),l&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty());}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(C$2.SCALE_RANGE))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty();}};function u(e,i){return e>0||i>0}e$3([y$1()],g.prototype,"graphicsCoreOwner",void 0),e$3([y$1()],g.prototype,"layer",void 0),e$3([y$1()],g.prototype,"queryGraphicUIDsInExtent",void 0),e$3([y$1()],g.prototype,"graphicsCore",void 0),e$3([y$1()],g.prototype,"basemapTerrain",void 0),e$3([y$1({constructOnly:!0})],g.prototype,"layerScaleEnabled",void 0),e$3([y$1({readOnly:!0})],g.prototype,"suspended",void 0),e$3([y$1({readOnly:!0})],g.prototype,"updating",null),e$3([y$1()],g.prototype,"_dirty",void 0),g=e$3([n("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],g);const b="terrain-events",m=u$8(),S=g;

export { Fe as F, S, _, _$1 as a, l, s };
