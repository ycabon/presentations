import { B as e$e, C as d$f, D as n$d, i1 as g$b, de as n$e, i2 as j$7, as as f$d, i3 as o$5, t as t$9, i4 as N$4, c6 as l$b, r as r$a, i5 as h$b, i6 as c$8, i7 as b$h, i8 as u$b, i9 as S$e, ia as a$a, ib as a$b, ic as f$e, id as e$f, ie as c$9, ig as i$7, E as f$f, aH as n$f, ih as O$6, g5 as Pn, bl as t$a, ii as s$9, fE as n$g, aA as o$6, h1 as qn, ay as n$h, fR as Un, e8 as r$b, hD as q$7, hE as w$8, fP as a$c, fi as O$8, eT as u$c, ij as S$f, fQ as B$5, fU as p$9, aK as c$a, ik as V$5, al as e$h, ar as j$9, ew as h$c, eM as r$c, eO as e$i, aw as u$e, il as u$f, a as n$i, im as d$h, Z as s$b, gZ as l$c, av as r$d, gQ as l$d, b8 as n$k, es as l$e, bS as t$e, cG as f$g, io as l$g, ip as i$a, c0 as e$n, iq as A$8, ir as H$3, bi as u$i, is as J$3, dm as E$d, it as zn, bj as v$b, cb as te$1, iu as r$e, iv as w$9, a$ as g$f, fz as l$h, iw as c$c, ix as f$i, iy as l$i, iz as M$6, iA as G$3, w as w$a, s as s$d, h$ as m$9, eK as e$o, ge as h$g, iB as g$g, fG as M$7, iC as R$7, dv as z$5, du as e$p, dw as _$d, fd as e$q, iD as c$e, aT as o$c, aF as r$g, g8 as s$e, g9 as u$k, fI as i$b, fB as c$f, gd as r$h, gM as m$a, gp as b$i, gY as l$k, g1 as a$g, aV as m$b, iE as d$l, n as nt$1, F as has, bg as It, iF as b$j, bG as w$b, dc as d$m, cq as i$c, iG as j$a, fD as p$d, gk as Hn, hC as E$f, eP as a$h, aI as r$i, g4 as f$k, eL as n$m, c2 as e$s, eY as G$4, aJ as o$h, f3 as r$k, gX as t$j, gS as _$e, eA as v$f, iH as dn, dt as P$a, fH as x$a, iI as o$j, e1 as An, iJ as h$i, fT as e$w, iK as u$l, co as p$f, iL as g$i, iM as c$l, iN as F$9, iO as t$l, a_ as s$i, gA as n$p, eS as j$c, iP as c$m, f2 as a$l, iQ as t$m, fh as g$j, eX as j$e, iR as _$g, dk as o$l, b6 as s$j, eW as v$h, iS as q$9, fg as l$q, iT as N$5, iU as u$n, eJ as e$B, ga as u$o, hA as ne$3, gL as q$a, cP as E$i, hK as C$a, cQ as $$3, iV as D$4, c4 as m$h, f5 as l$r, aG as r$p, iW as d$q, df as l$s, eQ as F$a, iX as h$n, iY as O$c, be as t$n, ep as L$7, h3 as r$q, iZ as o$q, eu as v$j, gP as n$r, i_ as a$q, aP as l$t, b2 as f$p, fw as a$s, d$ as w$d, hy as G$7, et as A$a, ex as a$t, a5 as E$j, hw as n$s, i$ as t$o, j0 as A$b, e6 as Bn, b1 as b$m, cC as m$i, j1 as d$r, j2 as T$8, j3 as gn, j4 as M$8, j5 as b$n, j6 as m$j, j7 as f$q, j8 as f$r, h2 as a$u, j9 as b$o, ja as $$4, jb as v$k, jc as k$a, h7 as a$v, jd as y$b, je as h$o, jf as R$c, jg as b$p, eg as x$e, eR as H$4, jh as p$i, hj as s$k, gx as U$8, aQ as h$p, ji as c$q, ey as d$s, d as b$q, g as g$l, j as j$g, jj as M$9 } from './_virtual_index-fc1e0009.js';
import { k as j$8, p as d$g, U as U$5, t as t$b, q as t$c, s as s$a, X as X$2, T as T$4, h as h$d, u as d$i, v as B$6, x as x$8, w as c$b, y as u$g, z as a$d, C as p$a, A as A$7, D as p$c, G as g$c, H as f$h, L as g$e, M as u$j, N as f$j, Q as ge$2, S as S$g, V as v$c, O as O$9, E as E$e, W as e$r, o as o$d, Y as t$h, K as K$3, Z as d$n, b as T$7, a as a$i, _ as s$g, $ as r$j, a0 as L$6, a1 as a$k, B as B$7, R as R$8, P as P$9, c as O$a, I as I$8, F as F$7, a2 as r$m, J as J$4, a3 as e$x, a4 as i$f, a5 as t$k, a6 as U$6, a7 as I$9, a8 as G$6, a9 as r$o, aa as V$7, m as m$g, g as i$j, f as f$n, ab as d$p, ac as f$o, ad as x$d, ae as j$f, af as i$l, ag as a$r, l as l$u, e as e$D, ah as z$6, ai as r$r } from './NativeLineMaterial-112c4c16.js';
import { o as o$r, t as t$p } from './rendererConversion-430ada08.js';
import { i as i$8 } from './optimizedFeatureQueryEngineAdapter-86078776.js';
import { e as e$g, o as o$b, r as r$l } from './mat4f64-2ebd3575.js';
import { O as O$7 } from './VertexAttribute-f7d7a686.js';
import { k as k$7, w as w$c, R as R$a, j as j$d } from './sphere-e237f03d.js';
import { u as u$d, W as W$3, d as a$e, l as l$f, _ as _$c, j as a$f, n as n$l, p as c$g, o as o$f, c as c$h, A as A$9, f as l$l, E as E$g, C as C$9, q as o$p, e as _$h, h as h$m, g as a$o, S as S$h, i as i$k } from './requestImageUtils-e94ee0cc.js';
import { c as o$7, y as u$h, k as e$j, o as o$8, b as e$k, a9 as i$9, n as n$j, t as t$d, f as e$l, g as o$9, E as E$b, h as e$m, F as s$c, G as d$j, p as E$c, w as h$e, I as t$f, J as h$f, M as p$b, ai as y$a, ak as d$k, q as o$a, s as g$d, L as L$5, $ as o$e, Z as a$j, A as v$d, d as e$t, C as n$n, m as m$c, z as e$u, D as t$i, O as e$v, P as o$g, Q as f$l, a0 as s$h, a1 as m$d, a2 as l$m, a3 as P$8, a4 as i$d, R as h$h, a6 as v$e, aJ as U$7, aK as p$g, aL as v$i, e as e$y, W as o$m, X as o$n, Y as e$z, aM as o$o, x as r$n, az as c$n, av as i$g, ac as a$m, v as c$o, aN as c$p, ay as m$f, aA as i$i, aO as O$b, K as h$l, al as e$C, H as x$b, aj as g$k } from './BooleanPassUniform-699c1722.js';
import { T as T$5 } from './InterleavedLayout-255af609.js';
import { I as I$7, R as R$5, D as D$3, F as F$8 } from './enums-fb707d37.js';
import { x as x$9 } from './earcut-da8a3e33.js';
import { T as T$6, i as i$e, b as b$k, l as l$o, u as u$m, h as h$j, c as c$j, d as d$o, x as x$c, a as a$p } from './BufferView-1591d5ec.js';
import { t as t$g, r as r$f } from './vec33-5a0f7743.js';
import { l as l$j, c as c$d } from './triangulationUtils-65aae98b.js';
import { R as R$6, n as n$o, o as o$i, k as k$9, B as B$8, J as J$5, m as m$e, a as a$n, e as e$A, i as i$h } from './objectResourceUtils-081a9311.js';
import { s as s$f } from './callExpressionWithFeature-1f700441.js';
import { g as g$h, c as c$i } from './MeshComponent-c613ec7b.js';
import { R as R$9, v as v$g, j as j$b, V as V$6, k as k$8 } from './projection-04d5ffcd.js';
import { l as l$n, h as h$k } from './geometryDataUtils-91cc75cc.js';
import { o as o$k } from './glUtil-2dc26fa6.js';
import { G as G$5, k as k$b } from './Octree-f88421d0.js';
import { a as p$e, l as l$p, p as p$h, _ as _$f, q as q$8, b as b$l, Z as Z$1, W as W$4, O as O$d, P as P$b, A as A$c } from './plane-13bf43c0.js';
import { c as c$k, f as f$m, R as R$b, E as E$h } from './VertexArrayObject-6f9baa1d.js';
import { n as n$q } from './vec3f32-3c06790e.js';
import { v as v$l, l as l$v } from './lineSegment-ed293740.js';
import { projectGeometry as a$w } from './geometryServiceUtils-6c87aaff.js';
import { u as u$p } from './LayerView-9aad410e.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const n$c=n=>{let c=class extends n{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1;}postscript(e){super.postscript(e),g$b(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo());}async _validateHeightModelInfo(){const e=new AbortController,o=e.signal;this.handles.add(n$e((()=>e.abort()))),await j$7((()=>this.view.defaultsFromMap?.heightModelInfoReady),o),f$d(o);const i=o$5(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(i)throw i}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!e||!e.minScale||!e.maxScale||e.minScale>=e.maxScale)}getSuspendInfo(){const e=super.getSuspendInfo(),s=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return s&&s.minScale&&s.maxScale&&s.minScale<s.maxScale&&(e.outsideScaleRange=!0),e}};return e$e([d$f()],c.prototype,"view",void 0),e$e([d$f()],c.prototype,"slicePlaneEnabled",void 0),c=e$e([n$d("esri.views.3d.layers.LayerView3D")],c),c};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function i$6(e,o){if(!e||e.symbol)return null;const r=o&&o.renderer;return e&&r$a(r)&&r.getObservationRenderer?r.getObservationRenderer(e):r}function n$b(e,o){if(r$a(e.symbol))return e.symbol;const r=i$6(e,o);return r$a(r)&&"dot-density"!==r.type?r.getSymbol(e,o):null}function a$9(e,t){const a=i$6(e,t),l=n$b(e,t);if(t$9(l))return null;const s={renderer:a,symbol:l};if(t$9(a)||!("visualVariables"in a)||!a.visualVariables)return s;const u=N$4(a,e,t),c=["proportional","proportional","proportional"];for(const{variable:o,value:r}of u)switch(o.type){case"color":s.color=r.toRgba();break;case"size":if("outline"===o.target)s.outlineSize=r;else {const e=o.axis,t=o.useSymbolValue?"symbol-value":r;switch(e){case"width":c[0]=t;break;case"depth":c[1]=t;break;case"height":c[2]=t;break;case"width-and-depth":c[0]=c[1]=t;break;default:c[0]=c[1]=c[2]=t;}}break;case"opacity":s.opacity=r;break;case"rotation":switch(o.axis){case"tilt":s.tilt=r;break;case"roll":s.roll=r;break;default:s.heading=r;}}return "proportional"===c[0]&&"proportional"===c[1]&&"proportional"===c[2]||(s.size=c),s}async function l$a(e,o){if(r$a(e.symbol))return e.symbol;const r=i$6(e,o);return r$a(r)&&r.getSymbolAsync(e,o)}async function s$8(t,o){const n=i$6(t,o),a=await l$a(t,o);if(!a)return null;const s={renderer:n,symbol:a};if(!n||!("visualVariables"in n)||!n.visualVariables)return s;const u=N$4(n,t,o),c=["proportional","proportional","proportional"];for(const{variable:r,value:i}of u)if("color"===r.type)s.color=l$b.toUnitRGBA(i);else if("size"===r.type)if("outline"===r.target)s.outlineSize=i;else {const e=r.axis,t=r.useSymbolValue?"symbol-value":i;"width"===e?c[0]=t:"depth"===e?c[1]=t:"height"===e?c[2]=t:c[0]=c[1]="width-and-depth"===e?t:c[2]=t;}else "opacity"===r.type?s.opacity=i:"rotation"===r.type&&"tilt"===r.axis?s.tilt=i:"rotation"===r.type&&"roll"===r.axis?s.roll=i:"rotation"===r.type&&(s.heading=i);return (isFinite(c[0])||isFinite(c[1])||isFinite(c[2]))&&(s.size=c),s}function u$a(e,t=0){const o=e[t];return "number"==typeof o&&isFinite(o)?o:null}function c$7(e){for(let t=0;t<3;t++){const o=e[t];if("number"==typeof o)return isFinite(o)?o:0}return 0}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const a$8=h$b.fromSimpleMarkerSymbol(c$8),c$6=b$h.fromSimpleLineSymbol(u$b),S$d=S$e.fromSimpleFillSymbol(a$a),u$9=new a$b({symbolLayers:[new f$e({material:{color:e$f},edges:new c$9({size:"1px",color:i$7})})]});function b$g(r){if(t$9(r))return null;switch(r.type){case"mesh":return u$9;case"point":case"multipoint":return a$8;case"polyline":return c$6;case"polygon":case"extent":return S$d}return null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class n$a{constructor(e,t){this.spatialReference=e,this._view=t;}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var E$a,C$8;!function(E){E[E.GRAPHIC=0]="GRAPHIC",E[E.LABEL=1]="LABEL",E[E._COUNT=2]="_COUNT";}(E$a||(E$a={})),function(E){E[E.USER_SETTING=0]="USER_SETTING",E[E.SCALE_RANGE=1]="SCALE_RANGE",E[E.FILTER=2]="FILTER",E[E.DECONFLICTION=3]="DECONFLICTION",E[E._COUNT=4]="_COUNT";}(C$8||(C$8={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let l$9=class extends f$f{constructor(t){super(t),this.events=new n$f,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.viewSpatialReference=null,this.featureAdapter={getAttribute:(t,e)=>"graphic"in t?t.graphic.attributes[e]:i$8.getAttribute(t,e),getAttributes:t=>"graphic"in t?t.graphic.attributes:i$8.getAttributes(t),getObjectId:t=>"graphic"in t?O$6(t.graphic,this.objectIdField):i$8.getObjectId(t),getGeometry:t=>"graphic"in t?t.getAsOptimizedGeometry(this.hasZ,this.hasM):i$8.getGeometry(t),getCentroid:(t,e)=>{if("graphic"in t){let r=null;r$a(t.centroid)?r=t.centroid:"point"===t.graphic.geometry.type&&Pn(t.graphic.geometry,u$8,this.viewSpatialReference)&&(r=u$8);const i=new Array(2+(e.hasZ?1:0)+(e.hasM?1:0));return t$9(r)?(i[0]=0,i[1]=0,i[2]=0,i[3]=0):(i[0]=r.x,i[1]=r.y,e.hasZ&&(i[2]=r.hasZ?r.z:0),e.hasM&&(i[e.hasZ?3:2]=r.hasM?r.m:0)),new t$a([],i)}return i$8.getCentroid(t,e)},cloneWithGeometry:(t,e)=>"graphic"in t?new s$9(e,this.featureAdapter.getAttributes(t),null,this.featureAdapter.getObjectId(t)):i$8.cloneWithGeometry(t,e)};}forEachInBounds(t,e){this.getSpatialIndex().forEachInBounds(t,e);}forEachBounds(t,e,r){const s=this.getSpatialIndex();for(const i of t){const t=this.featureAdapter.getObjectId(i);r$a(s.getBounds(t,r))&&e(r);}}};e$e([d$f({constructOnly:!0})],l$9.prototype,"getSpatialIndex",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"toArray",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"forEach",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"hasZ",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"hasM",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"objectIdField",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"viewSpatialReference",void 0),e$e([d$f({constructOnly:!0})],l$9.prototype,"featureSpatialReference",void 0),l$9=e$e([n$d("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],l$9);const u$8={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class r$9{constructor(r,s,t){this.graphic=r,this.renderingInfo=s,this.layer=t;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e$d{constructor(e){this.schedule=e,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function p$8(t,e,o,a){const r=t.stageObject,n=r.geometryRecords;let s=0;for(const i of n){const{update:t,averageGeometrySampledElevation:n}=O$5(i,e,o,a);s+=n,t&&r.geometryVertexAttrsUpdated(i);}return s/n.length}function d$e(t,o,r,s){const l=t.stageObject,f=o.centerPointInElevationSR;let u=0;if(l.metadata.usesVerticalDistanceToGround)d$g(f,r,o,s,M$5),U$5(l,M$5.verticalDistanceToGround),u=M$5.sampledElevation;else {d$g(f,r,o,s,M$5);"absolute-height"!==o.mode&&(u=M$5.sampledElevation);}const p=n$g(g$a,l.transformation),d=o$6(E$9,p[12],p[13],p[14]);t$b.TESTS_DISABLE_OPTIMIZATIONS?(T$3[0]=f.x,T$3[1]=f.y,T$3[2]=M$5.z,qn(f.spatialReference,T$3,p,s.spatialReference)&&(l.transformation=p)):s.setAltitudeOfTransformation(M$5.z,p);const I=S$c/s.unitInMeters;return (Math.abs(p[12]-d[0])>=I||Math.abs(p[13]-d[1])>=I||Math.abs(p[14]-d[2])>=I)&&(l.transformation=p),u}const g$a=e$g();function I$6(e,o,r,s){const l=e.graphics3DSymbolLayer.lodRenderer;if(t$9(l))return 0;const c=o.centerPointInElevationSR;d$g(c,r,o,s,M$5);const f="absolute-height"!==o.mode?M$5.sampledElevation:0,u=l.instanceData,p=e.instanceIndex,d=A$6;u.getGlobalTransform(p,d);const g=o$6(E$9,d[12],d[13],d[14]);t$b.TESTS_DISABLE_OPTIMIZATIONS?(T$3[0]=c.x,T$3[1]=c.y,T$3[2]=M$5.z,qn(c.spatialReference,T$3,d,s.spatialReference)&&u.setGlobalTransform(p,d)):s.setAltitudeOfTransformation(M$5.z,d);const I=S$c/s.unitInMeters;return (t$b.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-g[0])>=I||Math.abs(d[13]-g[1])>=I||Math.abs(d[14]-g[2])>=I)&&u.setGlobalTransform(p,d),f}function b$f(t,e,o,a){const r=t.stageObject,n=r.geometryRecords;if(0===n.length)return 0;let s=0,i=null,l=0,c=!1;for(const m of n){const t=m.geometry.vertexAttributes.get(O$7.POSITION);if(t!==i){const{update:r,averageGeometrySampledElevation:n}=O$5(m,e,o,a);l=n,i=t,c=r;}c&&r.geometryVertexAttrsUpdated(m),s+=l;}return s/n.length}const S$c=.01,T$3=n$h(),h$a=n$h(),v$a=n$h(),A$6=e$g(),E$9=n$h(),M$5=new j$8;function O$5(t,e,o,a){let r=!1;const n=o.spatialReference,l=t.geometry,c=t.getShaderTransformation(),p=e.requiresSampledElevationInfo;h$a[0]=c[12],h$a[1]=c[13],h$a[2]=c[14],l.invalidateBoundingInfo();const d=l.getMutableAttribute(O$7.POSITION),g=d.data,I=l.vertexAttributes.get(O$7.MAPPOS).data,b=d.size,A=g.length/b,E=new t$c(I,n);let O=0,y=0;for(let f=0;f<A;f++){if(v$a[0]=g[O],v$a[1]=g[O+1],v$a[2]=g[O+2],d$g(E,o,e,a,M$5),p&&(y+=M$5.sampledElevation),t$b.TESTS_DISABLE_OPTIMIZATIONS)g[O]=E.array[E.offset],g[O+1]=E.array[E.offset+1],g[O+2]=M$5.z,Un(g,n,O,g,a.spatialReference,O,1),g[O]-=h$a[0],g[O+1]-=h$a[1],g[O+2]-=h$a[2],r=!0;else {T$3[0]=g[O]+h$a[0],T$3[1]=g[O+1]+h$a[1],T$3[2]=g[O+2]+h$a[2],a.setAltitude(T$3,M$5.z),g[O]=T$3[0]-h$a[0],g[O+1]=T$3[1]-h$a[1],g[O+2]=T$3[2]-h$a[2];const t=S$c/a.unitInMeters;(Math.abs(v$a[0]-g[O])>=t||Math.abs(v$a[1]-g[O+1])>=t||Math.abs(v$a[2]-g[O+2])>=t)&&(r=!0);}O+=b,E.offset+=3;}return y/=A,{update:r,averageGeometrySampledElevation:y}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var A$5;!function(A){A[A.INVISIBLE=0]="INVISIBLE",A[A.TRANSPARENT=1]="TRANSPARENT",A[A.OPAQUE=2]="OPAQUE";}(A$5||(A$5={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class _$b{constructor(e,t,s,i,a,r,n,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=s,this._uniqueMaterials=i,this._sharedResource=a,this.elevationAligner=r,this.elevationContext=n,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=t;}get isElevationSource(){return !(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject);}destroy(){const t=this._stage;this._stageLayer&&(t.removeMany(this._uniqueMaterials),t.removeMany(this._uniqueGeometries)),t.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const s=this._stage.renderView.ensureEdgeView();s.hasObject(this.stageObject)&&s.removeObject(this.stageObject),this.stageObject.dispose(),r$a(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null;}layerOpacityChanged(e,s){if(t$9(this._edgeState))return;const i=v$9(this._edgeState.baseMaterial);let a=!1;for(const t of this._edgeState.edgeMaterials)t.objectTransparency!==i&&(t.objectTransparency=i,a=!0);a&&this._resetEdgeObject(s);this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e]);}slicePlaneEnabledChanged(e,s){if(t$9(this._edgeState))return;this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!s),this._edgeState.properties.hasSlicePlane=e;}setVisibility(t){if(null!=this._stage&&this._visible!==t&&(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),r$a(this._edgeState))){const e=this._stage.renderView.ensureEdgeView();e.hasObject(this.stageObject)?e.updateObjectVisibility(this.stageObject,t):t&&this._addOrUpdateEdgeObject(e,!1);}}get visible(){return this._visible}alignWithElevation(t,s,i,a){null!=this.elevationAligner&&(r$a(i)&&s$a(this.elevationContext.featureExpressionInfoContext,i),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,t,s),this._resetEdgeObject(a));}getCenterObjectSpace(e=n$h()){return r$b(e,k$7(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=a$c()){const t=this.stageObject.boundingVolumeObjectSpace;return q$7(e,t.min),w$8(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++;}else for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(y$9)&&(O$8(y$9,y$9,this.stageObject.transformation),u$c(e.render.origin,e.render.origin,y$9),e.render.num++);}async getProjectedBoundingBox(e,t,i,r,n){const o=this.getBoundingBoxObjectSpace(n),c=E$8,h=S$f(o)?1:c.length;for(let s=0;s<h;s++){const e=c[s];S$b[0]=o[e[0]],S$b[1]=o[e[1]],S$b[2]=o[e[2]],O$8(S$b,S$b,this.stageObject.transformation),f$c[3*s+0]=S$b[0],f$c[3*s+1]=S$b[1],f$c[3*s+2]=S$b[2];}if(!e(f$c,0,h))return null;B$5(o);let u=null;this.calculateRelativeScreenBounds&&(u=this.calculateRelativeScreenBounds());for(let s=0;s<3*h;s+=3){for(let e=0;e<3;e++)o[e]=Math.min(o[e],f$c[s+e]),o[e+3]=Math.max(o[e+3],f$c[s+e]);u&&i.push({location:f$c.slice(s,s+3),screenSpaceBoundingRect:u});}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){p$9(o,y$9);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=c$a(t.service.getElevation(y$9[0],y$9[1],e),0);else try{const a=X$2(o,t.service.spatialReference,t);i=c$a(await t.service.queryElevation(y$9[0],y$9[1],r,a,e),0);}catch(O){}V$5(o,0,0,-this.alignedSampledElevation+i);}return o}addObjectState(e,t){e===u$d.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===u$d.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee());}removeObjectState(e){e.removeObject(this.stageObject);}_resetEdgeObject(e){if(t$9(this._edgeState))return;const s=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(s,e):s.removeObject(this.stageObject);}_addOrUpdateEdgeObject(e,s){const i=this._edgeState;if(t$9(i))return;const a=v$9(i.baseMaterial);for(const t of i.edgeMaterials)t.objectTransparency=a;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!s).then((()=>this._stageLayer?.sync()));}}function v$9(e){return e.isVisible?e.parameters.transparent?A$5.TRANSPARENT:A$5.OPAQUE:A$5.INVISIBLE}const f$c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],S$b=n$h(),y$9=n$h(),E$8=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var e$c;!function(e){e[e.Recreate_Symbol=0]="Recreate_Symbol",e[e.Recreate_Graphics=1]="Recreate_Graphics",e[e.Fast_Update=2]="Fast_Update";}(e$c||(e$c={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class a$7{constructor(t){this.schedule=t,this._loadStatus=e$b.LOADING,this.logger=null;}destroy(){this.abortLoad();}get loadStatus(){return this._loadStatus}load(r,s){return this._loadStatus===e$b.LOADED?(r&&r(),e$h(this._loader)):this._loadStatus===e$b.FAILED?(s&&s(this._loadError),e$h(this._loader)):(t$9(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=e$b.LOADED;}),(t=>{throw this._loadError=t,this._abortController=null,this._loadStatus=e$b.FAILED,!j$9(t)&&this.logger&&t.message&&this.logger.warn(t.message),t}))),this._loader.then(r,s).catch((()=>{})),this._loader)}abortLoad(){r$a(this._abortController)?this._abortController=h$c(this._abortController):this._loadStatus===e$b.LOADING&&(this._loadStatus=e$b.FAILED),this._loader=null;}}var e$b;!function(t){t[t.LOADING=0]="LOADING",t[t.LOADED=1]="LOADED",t[t.FAILED=2]="FAILED";}(e$b||(e$b={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function n$9(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return !0}return !1}function t$8(n,t){const r=(n,a,r=!1)=>({levels:n.map((n=>{const c=a(n.tesselation);return r&&T$4.cgToGIS(c),{components:[{geometry:c,material:t}],faceCount:c.indexCount/3,minScreenSpaceRadius:n.minScreenSpaceRadius}}))});switch(n){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(n=>T$4.createPolySphereGeometry(.5,n,!0)));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>T$4.createBoxGeometry(1)));case"cone":return r(a$6,(n=>T$4.createConeGeometry(1,.5,n,!1)),!0);case"inverted-cone":return r(a$6,(n=>T$4.createConeGeometry(1,.5,n,!0)),!0);case"cylinder":return r(a$6,(n=>T$4.createCylinderGeometry(1,.5,n,[0,0,1],[0,0,.5])));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>T$4.createTetrahedronGeometry(1)),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],(()=>T$4.createDiamondGeometry(1)),!0);default:return}}const a$6=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function t$7(t){return "fill"===t.type}function e$a(t){return "extrude"===t.type}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function a$5(e){return e&&e.enabled&&(e$a(e)||t$7(e))&&r$a(e.edges)}function u$7(e){return e&&e.enabled&&e.edges||null}function f$b(e,n){return p$7(u$7(e),n)}function p$7(i,c){if(t$9(i))return null;const l=r$a(i.color)?e$i(l$b.toUnitRGBA(i.color)):r$c(0,0,0,0),a=u$e(i.size),u=u$e(i.extensionLength);switch(i.type){case"solid":return m$8({color:l,size:a,extensionLength:u,...c});case"sketch":return h$9({color:l,size:a,extensionLength:u,...c});default:return}}function m$8(e){return {...g$9,...e,type:"solid"}}function h$9(e){return {...d$d,...e,type:"sketch"}}const g$9={color:r$c(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:A$5.OPAQUE,hasSlicePlane:!1},d$d={color:r$c(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:A$5.OPAQUE,hasSlicePlane:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function r$8(r){const e=[];return r.levels.forEach((o=>{o.components.forEach((o=>{e.push(o.material);}));})),u$f(e)}function e$9(r){const e=new Array;return r.levels.forEach((o=>{o.components.forEach((o=>{o.textures&&e.push(...o.textures);}));})),u$f(e)}function n$8(r){const e=[];return r.components.forEach((o=>{e.push(o.geometry);})),u$f(e)}function t$6(r){const e=[];return r.levels.forEach((o=>{o.components.forEach((o=>{e.push(o.geometry);}));})),u$f(e)}function c$5(o){return n$8(o).reduce(((o,r)=>o+r.indexCount/3),0)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const b$e={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function P$7(e){if("web-style"===e.type)return b$e;return d$c(e.symbolLayers.toArray().map((r=>m$7(e,r))))}function d$c(e){let t=0,a=0,s=0,i=!1,o=0;const u={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const b of e)t$9(b)||(t+=b.primitivesPerFeature,a+=b.primitivesPerCoordinate,s+=b.drawCallsPerFeature,u.bytesPerFeature+=b.memory.bytesPerFeature,u.bytesPerFeatureLabel+=b.memory.bytesPerFeatureLabel,u.bytesPerCoordinate+=b.memory.bytesPerCoordinate,u.draped.bytesPerFeature+=b.memory.bytesPerFeature,u.draped.bytesPerFeatureLabel+=b.memory.bytesPerFeatureLabel,u.draped.bytesPerCoordinate+=b.memory.bytesPerCoordinate,i=i||b.estimated,++o);return {primitivesPerFeature:t,primitivesPerCoordinate:a,drawCallsPerFeature:s,estimated:i,memory:u,numComplexities:o}}function y$8(e){const r=d$c(e);return r.numComplexities>0&&(r.primitivesPerFeature/=r.numComplexities,r.primitivesPerCoordinate/=r.numComplexities,r.drawCallsPerFeature/=r.numComplexities,r.memory.bytesPerFeature/=r.numComplexities,r.memory.bytesPerFeatureLabel/=r.numComplexities,r.memory.bytesPerCoordinate/=r.numComplexities,r.memory.draped.bytesPerFeature/=r.numComplexities,r.memory.draped.bytesPerFeatureLabel/=r.numComplexities,r.memory.draped.bytesPerCoordinate/=r.numComplexities),r}const n$7={};function m$7(r,s){const o=l$8(r,s),u=a$5(s)?2:0;switch(s.type){case"extrude":return {primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:u,estimated:!1,memory:o};case"fill":return "mesh-3d"===r.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:u,estimated:!1,memory:o}:r$a(s.outline)&&s.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:o}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:o};case"water":return {primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:o};case"line":return {primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:o};case"object":if(s.resource&&s.resource.href)return {primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:o};return {...F$6(s.resource&&s.resource.primitive||d$h),memory:o};case"path":{const r=3,t=3,a=10;let i=0,u=0;switch(s.profile){case"circle":i=a;break;case"quad":i=4;break;default:return void n$i(s.profile)}switch(s.join){case"round":u=r;break;case"miter":case"bevel":u=1;break;default:return void n$i(s.join)}const b=2*i,P=i*u*2;let d=-2*P-b;switch(s.cap){case"none":break;case"butt":case"square":d+=2*(i-1);break;case"round":d+=2*(i*(t-1)*2+i);break;default:return}return {primitivesPerFeature:d,primitivesPerCoordinate:P+b,drawCallsPerFeature:0,estimated:!1,memory:o}}case"text":case"icon":return {primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:o};default:return}}function l$8(r,a){const s="point-3d"===r.type;switch(a.type){case"extrude":return a.edges&&a.edges.size>0?C$7.EXTRUDE_EDGES:C$7.EXTRUDE;case"fill":return r$a(a.outline)&&a.outline.size>0?C$7.FILL_OUTLINE:C$7.FILL;case"water":return C$7.FILL;case"line":return "round"===a.join?C$7.LINE_ROUND:C$7.LINE_MITER;case"path":switch(a.join){case"round":switch(a.profile){case"circle":return C$7.PATH_ROUND_CIRCLE;case"quad":return C$7.PATH_ROUND_QUAD;default:return void n$i(a.profile)}case"miter":case"bevel":switch(a.profile){case"circle":return C$7.PATH_MITER_CIRCLE;case"quad":return C$7.PATH_MITER_QUAD;default:return void n$i(a.profile)}default:return void n$i(a.join)}case"object":return s?C$7.OBJECT_POINT:C$7.OBJECT_POLYGON;case"icon":case"text":return s?C$7.ICON_POINT:C$7.ICON_POLYGON;default:return}}function F$6(e){let r=n$7[e];if(r)return r;const t=t$8(e,null);return r={primitivesPerFeature:n$8(t.levels[0]).reduce(((e,r)=>e+r.indices.get(O$7.POSITION).length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},n$7[e]=r,r}const C$7={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const f$a=s$b.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class y$7 extends a$7{constructor(e,t,i,o){super(i.schedule),this._context=i,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=f$a,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._renderPriority=o.renderPriority,this._renderPriorityStep=o.renderPriorityStep,this._elevationContext=new h$d,this.complexity=this.computeComplexity(),this._ignoreDrivers=o.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=g$8(this._context.renderer)),this._updateElevationContext();}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this._ignoreDrivers)return !1;const t=this._drivenProperties,i=g$8(e);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,o){const r=e.projectionSuccess,n="polygons"in e?e.polygons:null,s=`${o} geometry failed to be created`;let a=null;r?!t.length||1===t.length&&!t[0].length?a=`${s} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&(a=`${s} (filled rings should use clockwise winding - try reversing the order of vertices)`):a=`${s} (${i} should be defined as a 2D array)`:a=`${s} (failed to project geometry to view spatial reference)`,a&&f$a.warnOncePerTick(a);}_validateGeometry(e,t=null,o=null){if(r$a(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+o+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return f$a.warn("point coordinate is not a valid number, graphic skipped"),!1}return !0}_defaultElevationInfoNoZ(){return m$6}_defaultElevationInfoZ(){return _$a}_updateElevationContext(){r$a(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset();}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext();}setGraphicElevationContext(e,t){const i=e$h(e.geometry),n=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:n.unit,t.mode=this.getGeometryElevationMode(i,n),t.offsetMeters=c$a(this._elevationContext.meterUnitOffset,c$a(n.offset,0));const s=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;s&&(t.mode="relative-to-ground",t.offsetMeters=0);const a=s?d$i:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(a,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return !1}onRemoveGraphic(e){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;const e=this._context.layer.opacity;return e??1}_getCombinedOpacity(e,t=x$7){let o=1;return this.draped||(o*=this._getLayerOpacity()),this._drivenProperties.opacity||(r$a(e)?o*=e.a:t.hasIntrinsicColor||(o=0)),o}_getCombinedOpacityAndColor(t,o=x$7){const r=this._getCombinedOpacity(t,o);if(this._drivenProperties.color)return B$6(null,r);const s=r$a(t)?l$b.toUnitRGB(t):l$c;return B$6(s,r)}_getVertexOpacityAndColor(e,t=null){const o=this._drivenProperties.color?e.color:null,r=this._drivenProperties.opacity?e.opacity:null,n=B$6(o,r);return r$a(t)&&(n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return m$7(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;this._updateElevationContext();return this.layerElevationInfoChanged(t,i,e)!==x$8.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return !1}}updateGraphics3DGraphicElevationInfo(e,t,o){let r=x$8.UPDATE;return e.forEach((e=>{const n=t(e);if(r$a(n)){const t=e.graphic;this.setGraphicElevationContext(t,n.elevationContext),n.needsElevationUpdates=o(n.elevationContext.mode);}else r=x$8.RECREATE;})),r}applyRendererDiff(e,t){return e$c.Recreate_Symbol}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?v$8(t.size.field,e):0,o=t.color?v$8(t.color.field,e):0,r=t.opacity?v$8(t.opacity.field,e):0;return r$c(i,o,r,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&f$a.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>({size:this._fastUpdates?.visualVariables?.size?.field??null,color:this._fastUpdates?.visualVariables?.color?.field??null,opacity:this._fastUpdates?.visualVariables?.opacity?.field??null,rotation:this._fastUpdates?.visualVariables?.rotation?.field??null});return {drivenProperties:this._drivenProperties,getVisVarFields:e}}}function v$8(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}function g$8(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const o=e.stops[i].color;o&&(t.opacity=!0,o.a<1&&(t.opacityAlwaysOpaque=!1));}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0;}})),t}const m$6={mode:"on-the-ground",offset:0,unit:"meters"},_$a={mode:"absolute-height",offset:0,unit:"meters"},x$7={hasIntrinsicColor:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function S$a(o){const r=new o$7;r.include(c$b),r.include(u$g,o),r.include(u$h,o),r.attributes.add(O$7.UV0,"vec2");const{vertex:S,fragment:u}=r;return S.uniforms.add([new e$j("viewport",((e,i)=>i.camera.fullViewport)),new o$8("lineSize",((e,i)=>Math.ceil(e.size)*i.camera.pixelRatio)),new e$k("pixelToNDC",((e,o)=>r$d(m$5,2/o.camera.fullViewport[2],2/o.camera.fullViewport[3]))),new o$8("borderSize",((i,o)=>r$a(i.borderColor)?o.camera.pixelRatio:0)),new e$k("screenOffset",((e,o)=>r$d(m$5,e.screenOffset[0]*o.camera.pixelRatio,e.screenOffset[1]*o.camera.pixelRatio)))]),r.varyings.add("coverageSampling","vec4"),r.varyings.add("lineSizes","vec2"),o.hasMultipassGeometry&&r.varyings.add("depth","float"),o.hasScreenSizePerspective&&i$9(S),S.code.add(n$j`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${o.occlusionTestEnabled?n$j`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${o.hasScreenSizePerspective?n$j`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:n$j`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${o.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${o.depthHudEnabled?o.depthHudAlignStartEnabled?n$j`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:n$j`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${o.hasScreenSizePerspective?n$j`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:n$j`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),u.uniforms.add([new e$j("uColor",(e=>v$7(e.color))),new e$j("borderColor",(e=>v$7(e.borderColor)))]),o.hasMultipassGeometry&&(u.include(a$d,o),u.uniforms.add(new e$k("inverseViewport",((e,i)=>i.inverseViewport)))),u.code.add(n$j`
    void main() {
      ${o.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${o.depthHudEnabled?n$j`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:n$j`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),r}function v$7(i){return r$a(i)?i:l$d}const m$5=n$k(),u$6=Object.freeze(Object.defineProperty({__proto__:null,build:S$a},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class h$8 extends e$l{initializeConfiguration(i,t){t.spherical=i.viewingMode===l$e.Global;}initializeProgram(e){return new o$9(e.rctx,h$8.shader.get().build(this.configuration),E$b)}setPipelineState(e){const i=e?I$7.ALWAYS:I$7.LESS;return this.configuration.depthHudEnabled?W$3({depthTest:{func:i},depthWrite:a$e}):W$3({blending:l$f(R$5.ONE,R$5.SRC_ALPHA,R$5.ONE_MINUS_SRC_ALPHA,R$5.ONE_MINUS_SRC_ALPHA),depthTest:{func:i},colorWrite:_$c})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}}h$8.shader=new t$d(u$6,(()=>import('./LineCallout.glsl-f6145fc9.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class i$5 extends s$c{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=p$a.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1;}}e$e([e$m({count:p$a.COUNT})],i$5.prototype,"screenCenterOffsetUnitsEnabled",void 0),e$e([e$m()],i$5.prototype,"spherical",void 0),e$e([e$m()],i$5.prototype,"occlusionTestEnabled",void 0),e$e([e$m()],i$5.prototype,"hasVerticalOffset",void 0),e$e([e$m()],i$5.prototype,"hasScreenSizePerspective",void 0),e$e([e$m()],i$5.prototype,"depthHudEnabled",void 0),e$e([e$m()],i$5.prototype,"depthHudAlignStartEnabled",void 0),e$e([e$m()],i$5.prototype,"hasSlicePlane",void 0),e$e([e$m()],i$5.prototype,"hasMultipassGeometry",void 0),e$e([e$m({constValue:!0})],i$5.prototype,"hasSliceInVertexProgram",void 0),e$e([e$m({constValue:!1})],i$5.prototype,"isDraped",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class g$7 extends d$j{constructor(e){super(e,new S$9),this._configuration=new i$5,this._uniqueMaterialIdentifier=g$7.uniqueMaterialIdentifier(this.parameters);}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getConfiguration(t,r){const i=r?.slot!==E$c.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=r$a(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=r$a(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?p$a.Screen:p$a.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(e,t){if(t===h$e.Color)switch(e){case E$c.LINE_CALLOUTS:case E$c.LINE_CALLOUTS_HUD_DEPTH:return !0}return !1}createGLMaterial(e){return new O$4(e)}createBufferWriter(){return new b$d}validateParameters(e){const t=g$7.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t);}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class O$4 extends t$f{beginSlot(e){return this.ensureTechnique(h$8,e)}}class S$9 extends h$f{constructor(){super(...arguments),this.screenOffset=f$g,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1;}}const L$4=T$5().vec3f(O$7.POSITION).vec3f(O$7.NORMAL).vec2f(O$7.UV0).vec4f(O$7.AUXPOS1),I$5=[t$e(0,0),t$e(1,0),t$e(0,1),t$e(1,0),t$e(1,1),t$e(0,1)];class b$d{constructor(){this.vertexBufferLayout=L$4;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(O$7.POSITION).length}write(e,t,r,i){p$b(t.indices.get(O$7.POSITION),t.vertexAttributes.get(O$7.POSITION).data,e.transformation,r.position,i,6),y$a(t.indices.get(O$7.NORMAL),t.vertexAttributes.get(O$7.NORMAL).data,e.invTranspTransformation,r.normal,i,6),d$k(t.indices.get(O$7.AUXPOS1),t.vertexAttributes.get(O$7.AUXPOS1).data,r.auxpos1,i,6);for(let s=0;s<I$5.length;++s)r.uv0.setVec(i+s,I$5[s]);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class b$c extends y$7{constructor(e,t){super(e,null,t,U$4),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1);}async doLoad(){this._material=new g$7(this._materialParameters),this._context.stage.add(this._material);}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.screenOffset=e.screenOffset||f$g,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const r=this.symbol,a=r.callout,n=r$a(a.color)?l$b.toUnitRGBA(a.color):[0,0,0,0];n[3]*=this._getLayerOpacity();const s=u$e(a.size||0);let o=null;if(r.verticalOffset){const{screenLength:e,minWorldLength:a,maxWorldLength:n}=r.verticalOffset;o={screenLength:u$e(e),minWorldLength:a||0,maxWorldLength:r$a(n)?n:1/0};}const l=r$a(a.border)&&r$a(a.border.color)?l$b.toUnitRGBA(a.border.color):null,c="object"===r.symbolLayers.getItemAt(0).type,m=!c,d=c?0:void 0,h="label-3d"===r.type;return {color:n,size:s,verticalOffset:o,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:l,occlusionTest:m,shaderPolygonOffset:d,depthHUDAlignStart:h,hasSlicePlane:this._context.slicePlaneEnabled,renderOccluded:o$a.Occlude,__tagStrict:"NoParameters"}}_defaultElevationInfoNoZ(){return E$7}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,a=this.setGraphicElevationContext(i,new h$d,t.elevationOffset||0),s=t.symbol,o="on-the-ground"===this._elevationContext.mode&&("cim"===s.type||!s.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==s.type&&o)return null;if("point-3d"===s.type&&s.symbolLayers.every((e=>"text"===e.type&&!l$g(e))))return null;const l=A$7(i.geometry);return t$9(l)?null:this._createAs3DShape(l,a,t,i.uid)}layerOpacityChanged(){return t$9(this._material)||this._material.setParameters(this._materialParameters),!0}layerElevationInfoChanged(e,r,i){const a=this._elevationContext.mode,n=p$c(b$c.elevationModeChangeTypes,i,a);return n!==x$8.UPDATE||e.forEach((e=>{const i=r(e);r$a(i)&&this.updateGraphicElevationContext(e.graphic,i);})),n}slicePlaneEnabledChanged(){return t$9(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}setGraphicElevationContext(e,t,r=0){const i=super.setGraphicElevationContext(e,t);return i.addOffsetRenderUnits(r),i}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=g$c(t.elevationContext.mode);}computeComplexity(){return {primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:b$e.memory}}_createVertexData(e){const{translation:t,centerOffset:r}=e,i=t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},a=r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return [[O$7.POSITION,i],[O$7.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[O$7.AUXPOS1,a]]}_getOrCreateMaterial(e){const i=this._perInstanceMaterialParameters(e),a=g$7.uniqueMaterialIdentifier(i);if(r$a(this._material)&&a===this._material.uniqueMaterialIdentifier)return {material:this._material,isUnique:!1};if(e.materialCollection){let t=e.materialCollection.get(a);return t$9(t)&&(t=new g$7(i),e.materialCollection.add(a,t)),{material:t,isUnique:!1}}return {material:new g$7(i),isUnique:!0}}_createAs3DShape(e,t,r,i){const a=[new g$d(this._createVertexData(r),P$6,a$f.Point)],n=this._getOrCreateMaterial(r),o=f$h(this._context,e,a,[n.material],t,this._context.layer.uid,i);if(null===o)return null;const l=new _$b(this,o.object,a,n.isUnique?[n.material]:null,null,d$e,t);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=o.sampledElevation,l.needsElevationUpdates=g$c(t.mode),g$e(l,e,this._context.elevationProvider),l}}b$c.elevationModeChangeTypes={definedChanged:x$8.UPDATE,staysOnTheGround:x$8.UPDATE,onTheGroundChanged:x$8.RECREATE};const C$6=new Uint16Array([0]),P$6=[[O$7.POSITION,C$6],[O$7.NORMAL,C$6],[O$7.AUXPOS1,C$6]],E$7={mode:"relative-to-ground",offset:0},U$4={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const t$5=s$b.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function e$8(o,l){if(!i$a(o))return t$5.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${o.type}' does not support callouts`),null;if(!o.callout)return null;const e=a$4[o.callout.type];return e?new e(o,l):(t$5.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${o.callout.type}`),null)}const a$4={line:b$c};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const S$8=new e$n(Array,(e=>A$8(e,H$3)),null,10,5),B$4=u$i();class V$4{constructor(e,i,r,s,a){this.graphic=e,this.graphics3DSymbol=i,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=z$4(E$a._COUNT,C$8._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=a?u$j(a,e,s):null;for(const o of r)r$a(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource);}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,i){this._layer=i,this._stage=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e,i),t.setVisibility(this.isVisible());}));}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null;}get destroyed(){return null==this.graphics}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0;}addLabelGraphic(e,i,t){this._labelGraphics.push(e),e.initialize(i,t),e.setVisibility(this.isVisible(E$a.LABEL));}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()));}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((i=>{"draped"===i.type&&(e=!0);})),e}isVisible(e=E$a.GRAPHIC,i){for(let t=0;t<=e;t++){const e=this._visibilityFlags[t];for(let t=0;t<e.length;++t)if(!1===e[t]&&t!==i)return !1}return !0}hasVisibilityFlag(e,i){return null!=this._visibilityFlags[i][e]}setVisibilityFlag(e,i,t){const r=this.isVisible(t);this._visibilityFlags[t][e]=i;const s=this.isVisible(t);if(r===s)return !1;if(t===E$a.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else {this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(E$a.LABEL);this._forEachLabelGraphic((i=>i.setVisibility(e)));}return !0}clearVisibilityFlag(e,i=E$a.GRAPHIC){return this.setVisibilityFlag(e,void 0,i)}computeExtent(e){if(!this._extent){const i=this.graphic.geometry;if(t$9(i))return !1;this._extent=u$i(),J$3(i,this._extent);const t=i.spatialReference;if(!E$d(t,e)&&!zn(this._extent,t,this._extent,e))return this._extent=null,!1}return !0}getAsOptimizedGeometry(e,i){return r$a(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,i),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,i,t){let r=e.geometry;return "mesh"!==r.type&&"extent"!==r.type||(r=v$b.fromExtent("mesh"===r.type?r.extent:r)),te$1(r,i,t)}get usedMemory(){let e=r$e(this.graphic.attributes);return this._forEachSymbolLayerGraphic((i=>{const t=i.graphics3DSymbolLayer.complexity;if(t$9(t))return;const s="draped"===i.type?t.memory.draped:t.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=w$9(this.graphic.geometry)*s.bytesPerCoordinate);})),e}computeAttachmentOrigin(){const e={render:{origin:n$h(),num:0},draped:{origin:n$k(),num:0}};for(const i of this.graphics)t$9(i)||i.computeAttachmentOrigin(e);return e.render.num&&g$f(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&l$h(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(i,t,s,a,o){return o||(o={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),o.boundingBox?B$5(o.boundingBox):o.boundingBox=B$5(),o.requiresDrapedElevation=!1,await c$c(this.graphics,(async e=>{if(t$9(e))return;const h="draped"===e.type?t:i,n=S$8.acquire(),c=await e.getProjectedBoundingBox(h,s,o.screenSpaceObjects,a,n);isFinite(c[2])&&isFinite(c[5])||(o.requiresDrapedElevation=!0),c&&f$i(o.boundingBox,n),S$8.release(n);})),l$i(o.boundingBox)||M$6(G$3(o.boundingBox,B$4))?o:null}needsElevationUpdates(){for(const e of this.graphics)if(r$a(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return !0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return !0;return !1}alignWithElevation(e,i,t){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,i,this._featureExpressionFeature,t);}));}addObjectStateSet(e,i){this._forEachSymbolLayerGraphic((t=>t.addObjectState(e,i)));}removeObjectState(e){this._forEachSymbolLayerGraphic((i=>i.removeObjectState(e)));}_forEachGraphicList(e,i){e.forEach((e=>e&&i(e)));}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.graphics,e),this._forEachGraphicList(this._auxiliaryGraphics,e);}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelGraphics,e);}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e);}}function z$4(e,i){const t=new Array(e);for(let r=0;r<t.length;r++)t[r]=new Array(i);return t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function c$4(i){const o=[[O$7.POSITION,i.indices]],e=[[O$7.POSITION,{size:3,data:i.attributeData.position,exclusive:!0}]];return r$a(i.attributeData.color)&&(e.push([O$7.COLOR,{size:4,data:i.attributeData.color,exclusive:!0}]),o.push([O$7.COLOR,new Uint32Array(i.indices.length)])),r$a(i.attributeData.uvMapSpace)&&(e.push([O$7.UVMAPSPACE,{size:4,data:i.attributeData.uvMapSpace,exclusive:!0}]),o.push([O$7.UVMAPSPACE,i.indices])),r$a(i.attributeData.boundingRect)&&(e.push([O$7.BOUNDINGRECT,{size:9,data:i.attributeData.boundingRect,exclusive:!0}]),o.push([O$7.BOUNDINGRECT,i.indices])),r$a(i.attributeData.mapPosition)&&(e.push([O$7.MAPPOS,{size:3,data:i.attributeData.mapPosition,exclusive:!0}]),o.push([O$7.MAPPOS,i.indices])),new g$d(e,o)}function l$7(i){const o=[[O$7.POSITION,i.indices],[O$7.UV0,i.indices]],e=[[O$7.POSITION,{size:3,data:i.attributeData.position,exclusive:!0}],[O$7.UV0,{size:2,data:i.attributeData.uv0,exclusive:!0}]];return r$a(i.attributeData.mapPosition)&&(e.push([O$7.MAPPOS,{size:3,data:i.attributeData.mapPosition,exclusive:!0}]),o.push([O$7.MAPPOS,i.indices])),new g$d(e,o)}function m$4(t){switch(t.type){case"extent":if(t instanceof w$a)return v$b.fromExtent(t);break;case"polygon":return t}return null}function d$b(t,i,s,a){const r=l$j(t.rings,t.hasZ,c$d.CCW_IS_HOLE),u=new Float64Array(r.position.length),p=f$j(r.position,t.spatialReference,0,u,0,r.position,0,r.position.length/3,i,s,a),c=null!=p;return {position:r.position,mapPosition:u,polygons:b$b(r.polygons,r.position,u),outlines:g$6(r.outlines,r.position,u),projectionSuccess:c,sampledElevation:p}}function f$9(t,n){const a=l$j(t.rings,!1,c$d.CCW_IS_HOLE),r=Un(a.position,t.spatialReference,0,a.position,n,0,a.position.length/3);for(let i=2;i<a.position.length;i+=3)a.position[i]=ge$2;return {position:a.position,polygons:b$b(a.polygons,a.position),outlines:g$6(a.outlines,a.position),projectionSuccess:r}}function g$6(t,i,o){const e=new Array;for(const{index:n,count:s}of t){if(s<=1)continue;const t=3*n,a=t+3*s;e.push({index:n,count:s,position:i.subarray(t,a),mapPosition:o?o.subarray(t,a):void 0});}return e}function b$b(t,i,o){const e=new Array;for(const{index:n,count:s,holeIndices:a,pathLengths:r}of t){if(s<=1)continue;const t=3*n,u=t+3*s,p=a.map((t=>t-n));e.push({index:n,count:s,holeIndices:p,pathLengths:r,position:i.subarray(t,u),mapPosition:o?o.subarray(t,u):void 0});}return e}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const q$6=["polygon","extent"];class J$2 extends y$7{constructor(e,t,r,s){super(e,t,r,s),this.ensureDrapedStatus(!1);}async doLoad(){if(!this._drivenProperties.size){const t=S$g(this._getSymbolSize());if(t)throw new s$d("graphics3dextrudesymbollayer:invalid-size",t)}const r=m$9(this.symbolLayer,"material","color"),s=this._getCombinedOpacityAndColor(r),n=e$o(s),i=s[3],a=i<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:n,ambient:n,opacity:i,transparent:a,cullFace:a?n$l.None:n$l.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new R$6(o),this._bottomMaterial=new R$6({...o,cullFace:n$l.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial);}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial));}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,q$6,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t,new h$d);return this._createAs3DShape(t,e.renderingInfo,r,s,t.uid)}layerOpacityChanged(e,s){const n=m$9(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(n),a=i<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:i,transparent:a}),this._bottomMaterial.setParameters({opacity:i,transparent:a});const o=this._getLayerOpacity();return e.forEach((e=>{const t=s(e);r$a(t)&&t.layerOpacityChanged(o,this._context.isAsync);})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v$c)}slicePlaneEnabledChanged(e,t){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach((e=>{const s=t(e);r$a(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync);})),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return !0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?u$a(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?e$c.Recreate_Symbol:e$c.Recreate_Graphics}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,h,m,p){const d=m$4(e.geometry);if(t$9(d))return null;const u=d$b(d,this._context.elevationProvider,this._context.renderCoordsHelper,m);if(this._logGeometryCreationWarnings(u,d.rings,"rings","ExtrudeSymbol3DLayer"),0===d.rings.length||!d.rings.some((e=>e.length>0)))return null;const f=A$7(d);if(t$9(f))return null;const g=new Array,j=new Array,M=new Array,O=a$c(),B=e$g(),I=n$h(),R=this._context.renderCoordsHelper.viewingMode===l$e.Global;R||this._context.renderCoordsHelper.worldUpAtPosition(null,I),qn(d.spatialReference,[f.x,f.y,0],B,this._context.renderCoordsHelper.spatialReference);const z=e$g();h$g(z,B);const k=e$q();g$g(k,z);const{polygons:N,mapPosition:F,position:V}=u,H=V.length/3,Z=new Float64Array(3*H*6),W=new Float64Array(3*H*6),q=new Float64Array(3*H*6),J=new Float64Array(1*H*6);let X=0;for(let r=0;r<N.length;++r){const e=N[r],s=e.count;if(this._context.clippingExtent&&(B$5(O),M$7(O,e.mapPosition),!R$7(O,this._context.clippingExtent)))continue;const i=x$9(e.mapPosition,e.holeIndices,3);if(0===i.length)continue;const a=3*s*2+i.length,o=new Uint32Array(a),c=new Uint32Array(i.length),m=6*s,p=3*Z.BYTES_PER_ELEMENT,d=new T$6(Z.buffer,X*p,p,(X+m)*p),u=3*W.BYTES_PER_ELEMENT,f=new T$6(W.buffer,X*u,u,(X+m)*u),y=new Float64Array(q.buffer,3*X*q.BYTES_PER_ELEMENT,3*m),_=new Float64Array(J.buffer,1*X*J.BYTES_PER_ELEMENT,1*m),b=this._getExtrusionSize(t);Q$1(V,F,i,e,d.typedBuffer,y,f.typedBuffer,_,0,o,c,b,I,R),t$g(d,d,z),r$f(f,f,k),X+=6*s;const A=K$2(o,o.length-c.length,{positions:d.typedBuffer,elevation:y,normals:f.typedBuffer,heights:_},h);g.push(A),j.push(this._material),M.push(o$b);const L=K$2(c,0,{positions:d.typedBuffer,elevation:y,normals:f.typedBuffer,heights:_},h);g.push(L),j.push(this._bottomMaterial),M.push(o$b);}if(0===g.length)return null;const $=new O$9({geometries:g,materials:j,transformations:M,metadata:{layerUid:this._context.layer.uid,graphicUid:p,isElevationSource:!0}});$.transformation=B;const ee=f$b(this.symbolLayer,{opacity:this._getLayerOpacity()}),te=r$a(ee)?{baseMaterial:this._material,edgeMaterials:[ee],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,re=new _$b(this,$,g,null,null,ce$2,m,te);return re.alignedSampledElevation=u.sampledElevation,re.needsElevationUpdates=v$c(m.mode),re}}function K$2(e,t,r,s){const n=new Uint32Array(e.length),i=[[O$7.POSITION,{size:3,data:r.positions,exclusive:!0}],[O$7.NORMAL,{size:3,data:r.normals,exclusive:!0}],[O$7.COLOR,{size:4,data:s,exclusive:!0}],[O$7.SIZE,{size:1,data:r.heights,exclusive:!0}]],a=[[O$7.POSITION,e],[O$7.NORMAL,e],[O$7.COLOR,n]];return r.elevation&&(i.push([O$7.MAPPOS,{size:3,data:r.elevation}]),a.push([O$7.MAPPOS,e])),new g$d(i,a,a$f.Triangle,t)}function Q$1(e,t,r,s,n,i,a,o,l,c,h,m,p,d){const u=r.length/3;let f=0,g=2*s.count;X$1(e,t,s.index,s.count,r,0,u,n,i,a,o,l,c,h,g,m,p,d),l+=2*s.count,g=0,te(n,i,o,a,f,s.pathLengths[0],s.count,l,c,g,m),l+=4*s.pathLengths[0],g+=2*s.pathLengths[0],f+=s.pathLengths[0];for(let y=1;y<s.pathLengths.length;++y)te(n,i,o,a,f,s.pathLengths[y],s.count,l,c,g,m),l+=4*s.pathLengths[y],g+=2*s.pathLengths[y],f+=s.pathLengths[y];}function X$1(e,t,r,s,n,i,a,o,l,c,p,d,u,f,g,y,_,b){r$b(me$4,_);const E=y>0?1:-1;let x=3*r,P=d,S=3*P,v=d+s,w=3*v;for(let h=0;h<s;++h)b&&(me$4[0]=e[x+0],me$4[1]=e[x+1],me$4[2]=e[x+2],z$5(me$4,me$4)),o[S+0]=e[x+0],o[S+1]=e[x+1],o[S+2]=e[x+2],l[S+0]=t[x+0],l[S+1]=t[x+1],l[S+2]=t[x+2],c[S+0]=-E*me$4[0],c[S+1]=-E*me$4[1],c[S+2]=-E*me$4[2],p[P]=0,o[w+0]=e[x+0]+y*me$4[0],o[w+1]=e[x+1]+y*me$4[1],o[w+2]=e[x+2]+y*me$4[2],l[w+0]=t[x+0],l[w+1]=t[x+1],l[w+2]=t[x+2],c[w+0]=E*me$4[0],c[w+1]=E*me$4[1],c[w+2]=E*me$4[2],p[v]=y,S+=3,w+=3,x+=3,P+=1,v+=1;x=3*i,S=0,w=3*g;const j=y<0?ue$4:de$3,A=y<0?de$3:ue$4;for(let h=0;h<a;++h)f[S+0]=n[x+j[0]],f[S+1]=n[x+j[1]],f[S+2]=n[x+j[2]],u[w+0]=n[x+A[0]]+s,u[w+1]=n[x+A[1]]+s,u[w+2]=n[x+A[2]]+s,S+=3,w+=3,x+=3;}function $$2(e,t,r,s,n,i,a){s[i]=s[a],a*=3,e[(i*=3)+0]=e[a+0],e[i+1]=e[a+1],e[i+2]=e[a+2],t[i+0]=t[a+0],t[i+1]=t[a+1],t[i+2]=t[a+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2];}const ee=n$h();function te(e,t,r,s,n,i,a,o,l,c,h){let m=n,p=n+1,d=n+a,u=n+a+1,f=o,g=o+1,y=o+2*i,_=o+2*i+1;h<0&&(m=n+a+1,u=n),c*=3;for(let b=0;b<i;++b)b===i-1&&(h>0?(p=n,u=n+a):(p=n,m=n+a)),oe$2(e,m,p,d,ee),$$2(e,t,s,r,ee,f,m),$$2(e,t,s,r,ee,g,p),$$2(e,t,s,r,ee,y,d),$$2(e,t,s,r,ee,_,u),l[c++]=f,l[c++]=y,l[c++]=_,l[c++]=f,l[c++]=_,l[c++]=g,m++,p++,d++,u++,f+=2,g+=2,y+=2,_+=2;}const re=n$h(),se$2=n$h(),ne$2=n$h(),ie=n$h(),ae$2=n$h();function oe$2(e,t,r,s,n){t*=3,r*=3,s*=3,o$6(re,e[t++],e[t++],e[t++]),o$6(se$2,e[r++],e[r++],e[r++]),o$6(ne$2,e[s++],e[s++],e[s++]),e$p(ie,se$2,re),e$p(ae$2,ne$2,re),_$d(n,ae$2,ie),z$5(n,n);}const le$2=n$h();function ce$2(e,t,s,n){const i=e.stageObject,a=i.geometryRecords,l=a.length,h="absolute-height"!==t.mode;let m=0;const d=i.transformation,u=h$g(e$g(),d);for(let o=0;o<l;o+=2){const e=a[o].geometry,l=e.getMutableAttribute(O$7.POSITION).data,c=e.vertexAttributes.get(O$7.SIZE).data,g=e.vertexAttributes.get(O$7.MAPPOS).data,y=new t$c(g),_=l.length/3;let b=0,E=!1,x=0;const P=s.spatialReference;for(let i=0;i<_;i++){le$2[0]=l[b],le$2[1]=l[b+1],le$2[2]=l[b+2],d$g(y,s,t,n,pe$3),h&&(x+=pe$3.sampledElevation),t$b.TESTS_DISABLE_OPTIMIZATIONS?(o$6(he$3,y.array[y.offset+0],y.array[y.offset+1],pe$3.z+c[b/3]),r$a(P)&&n.toRenderCoords(he$3,P,he$3),O$8(he$3,he$3,u)):(o$6(he$3,l[b+0],l[b+1],l[b+2]),O$8(he$3,he$3,d),n.setAltitude(he$3,pe$3.z+c[b/3]),O$8(he$3,he$3,u)),l[b]=he$3[0],l[b+1]=he$3[1],l[b+2]=he$3[2];const e=fe$3/n.unitInMeters;(Math.abs(le$2[0]-l[b])>=e||Math.abs(le$2[1]-l[b+1])>=e||Math.abs(le$2[2]-l[b+2])>=e)&&(E=!0),y.offset+=3,b+=3;}E&&(e.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(a[o]),a[o+1].geometry.invalidateBoundingInfo(),i.geometryVertexAttrsUpdated(a[o+1])),m+=x/_;}return m/l}const he$3=n$h(),me$4=n$h(),pe$3=new j$8,de$3=[0,2,1],ue$4=[0,1,2],fe$3=.01;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class u$5{constructor(e,t,r,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=r,this._drapeSourceRenderer=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1;}initialize(e){this.stage=e;}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,E$e.Geometry.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,E$e.State.VISIBILITIES);}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,E$e.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null;}getCenterObjectSpace(e=n$h()){return o$6(e,0,0,0)}getBoundingBoxObjectSpace(e=a$c()){return B$5(e)}addObjectState(e,t){e===u$d.Highlight&&(this.renderGeometries.forEach((e=>{const r=e.addHighlight();t.addRenderGeometry(e,r,this);})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,E$e.State.HIGHLIGHTS));}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t);}));}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,E$e.State.HIGHLIGHTS);}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(S$7)&&(e.draped.origin[0]+=S$7[0],e.draped.origin[1]+=S$7[1],e.draped.num++);}async getProjectedBoundingBox(t,r,i,n,a){B$5(a);for(let e=0;e<this.renderGeometries.length;e++){const r=this.renderGeometries[e];this._getRenderGeometryProjectedBoundingRect(r,t,l$6,i),c$e(a,l$6);}if(r){let t;p$9(a,S$7);const i=X$2(a,r.service.spatialReference,r);try{t=await r.service.queryElevation(S$7[0],S$7[1],n,i,"ground");}catch(h){}r$a(t)&&(a[2]=Math.min(a[2],t),a[5]=Math.max(a[5],t));}return a}_getRenderGeometryProjectedBoundingRect(e,t,r,i){if(this.boundingBox)A$8(p$6,this.boundingBox);else {const t=e.boundingSphere,r=t[3];p$6[0]=t[0]-r,p$6[1]=t[1]-r,p$6[2]=t[2]-r,p$6[3]=t[0]+r,p$6[4]=t[1]+r,p$6[5]=t[2]+r;}return t(p$6,0,2),this.calculateRelativeScreenBounds&&i.push({location:p$9(p$6),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),G$3(p$6,r)}}const l$6=u$i(),p$6=a$c(),S$7=n$h();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$7{constructor(t,e,i,n=2048){this.text=t,this._alignment=e,this._parameters=i,this._maxSize=n,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/);}get displayWidth(){return Math.ceil(this._ensureTextWidth()+2*this._backgroundHorizontalPadding)}get displayHeight(){const t=this._lineSpacing*(this._lines.length-1),e=this._lineHeight;return Math.ceil(t+e+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _heightMetrics(){return this._ensureHeightMetrics()}get _lineSpacing(){return (this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._heightMetrics.lineHeight}get _linePadding(){return this._lineHeight*d$a}get _baselinePosition(){return this._heightMetrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._heightMetrics.paddingBottom)}get _hasBackground(){return !!this._parameters.backgroundStyle}get renderPixelRatio(){if(t$9(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=t;}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case h$7.Left:return this._backgroundHorizontalPadding;case h$7.Center:return (this.displayWidth-this._lineWidths[t])/2;case h$7.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[t]}}render(t,e=0,i=0){t.save();const s=e/=this.renderPixelRatio,r=i/=this.renderPixelRatio,h=this._haloSize,o=this._firstLineYOffset;e+=h,i+=o+this._baselinePosition;const a=this._haloSize>0;a&&this._renderHalo(t,s,r,h,o),this._setFontProperties(t,this._renderedFontSize);for(let n=0;n<this._lines.length;++n){const s=this._lines[n],r=this._getLineXOffset(n);a&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,s,e+r,i),this._renderLineDecoration(t,e+r,i,this._textWidths[n])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,s,e+this._getLineXOffset(n),i),this._renderLineDecoration(t,e+r,i,this._textWidths[n]),i+=this._lineSpacing;}if(t$b.TEXT_SHOW_BASELINE){t.strokeStyle=_$9,t.setLineDash([2,2]),t.lineWidth=1;let e=r+o;for(let i=0;i<this._lines.length;++i){const i=e+this._baselinePosition;this._drawLine(t,[s,i],[s+this.displayWidth,i]),e+=this._lineSpacing;}}if(t$b.TEXT_SHOW_BORDER&&(t.strokeStyle=_$9,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,r],[this.displayWidth,this.displayHeight])),this._hasBackground){const e=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,r,e),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill();}t.restore();}_renderLineDecoration(t,e,i,n,s=!1){if("none"===this._parameters.definition.font.decoration||0===n)return;const r=1,h=Math.max(this._parameters.definition.size/16,r);switch(this._parameters.definition.font.decoration){case"underline":i+=2*h;break;case"line-through":i-=.33*this._baselinePosition;}const o=s?this._haloSize:0;t.strokeStyle=s?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(h+2*o),t.beginPath(),t.moveTo(this._toRenderUnit(e-o),this._toRenderUnit(i)),t.lineTo(this._toRenderUnit(e+n+o),this._toRenderUnit(i)),t.stroke();}_roundedRect(e,i,n,s){i=this._toRenderUnit(i),n=this._toRenderUnit(n);const r=this.renderedWidth,h=this.renderedHeight;0!==s?(s=o$c(s,0,Math.floor(h/2)),e.beginPath(),e.moveTo(i,n+s),e.arcTo(i,n,i+s,n,s),e.lineTo(i+r-s,n),e.arcTo(i+r,n,i+r,n+s,s),e.lineTo(i+r,n+h-s),e.arcTo(i+r,n+h,i+r-s,n+h,s),e.lineTo(i+s,n+h),e.arcTo(i,n+h,i,n+h-s,s),e.closePath()):e.rect(i,n,r,h);}_renderHalo(t,e,i,n,s){const r=this.renderedWidth,h=this.renderedHeight,d=o$4(a$3,Math.max(r,l$5),Math.max(h,l$5)),_=d.getContext("2d");_.clearRect(0,0,r,h),this._setFontProperties(_,this._renderedFontSize),_.fillStyle=this._parameters.haloStyle,_.strokeStyle=this._parameters.haloStyle;const g=this._renderedHaloSize<3;_.lineJoin=g?"miter":"round",g?this._renderHaloEmulated(_,n,s):this._renderHaloNative(_,n,s);let c=s+this._baselinePosition;for(let o=0;o<this._lines.length;++o){const t=this._getLineXOffset(o);this._renderLineDecoration(_,n+t,c,this._textWidths[o],!0),c+=this._lineSpacing;}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(d,0,0,r,h,this._toRenderUnit(e),this._toRenderUnit(i),r,h),t.globalAlpha=1;}_renderHaloEmulated(t,e,i){i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],h=this._getLineXOffset(n);for(const[n,o]of r$7)this._fillText(t,s,e+h+this._haloSize*n,i+this._haloSize*o);i+=this._lineSpacing;}}_renderHaloNative(t,e,i){const n=2*this._haloSize;i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const r=this._lines[s],h=this._getLineXOffset(s),o=5,a=.1;for(let s=0;s<o;s++){const d=1-(o-1)*a+s*a;t.lineWidth=this._toRenderUnit(d*n),this._strokeText(t,r,e+h,i);}i+=this._lineSpacing;}}_setFontProperties(t,e){t.font=this._parameters.fontString(e),t.textAlign="left",t.textBaseline="alphabetic";}_ensureTextWidth(){if(r$a(this._displayWidth))return this._displayWidth;const t=o$4(a$3,l$5,l$5).getContext("2d");this._setFontProperties(t,this._fontSize);let e=2*this._haloSize;const n=this._parameters.definition.font;"italic"!==n.style&&"oblique"!==n.style&&"bold"!==n.weight&&"bolder"!==n.weight||(e+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0;for(const i of this._lines){const n=t.measureText(i).width,r=n+e;this._textWidths.push(n),this._lineWidths.push(r),s=Math.max(s,r);}return this._displayWidth=s,this._displayWidth}_ensureHeightMetrics(){if(t$9(this._heightMetricsCached)){const t=o$4(a$3,l$5,l$5).getContext("2d");this._setFontProperties(t,this._fontSize);const e=t.measureText(this.text+g$5),i=this._hasBackground?t.measureText(this._lines[0]):e,n=1===this._lines.length?i:this._hasBackground?t.measureText(this._lines[this._lines.length-1]):e,s=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;this._heightMetricsCached={paddingTop:e.actualBoundingBoxAscent-i.actualBoundingBoxAscent,paddingBottom:e.actualBoundingBoxDescent-n.actualBoundingBoxDescent,lineHeight:s,baselinePosition:e.actualBoundingBoxAscent};}return this._heightMetricsCached}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,e,i,n){t.fillText(e,this._toRenderUnit(i),this._toRenderUnit(n));}_strokeText(t,e,i,n){t.strokeText(e,this._toRenderUnit(i),this._toRenderUnit(n));}_drawLine(t,e,i){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(e[0])+.5,this._toRoundedRenderUnit(e[1])+.5),t.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.stroke();}_drawBox(t,e,i){const n=this._toRenderUnit(e[0]),s=this._toRenderUnit(e[1]),r=this._toRenderUnit(i[0]),h=this._toRenderUnit(i[1]),o=Math.floor(n)+.5,a=Math.ceil(n+r)-.5,d=Math.floor(s)+.5,l=Math.ceil(s+h)-.5;t.beginPath(),t.moveTo(o,d),t.lineTo(a,d),t.lineTo(a,l),t.lineTo(o,l),t.lineTo(o,d),t.stroke();}}const r$7=[];{const t=16;for(let e=0;e<360;e+=360/t)r$7.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);}var h$7;function o$4(t,e,i){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=i,t.canvas}!function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right";}(h$7||(h$7={}));const a$3={canvas:null},d$a=.2,l$5=512,_$9="rgb(255, 0, 255, 0.5)",g$5=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const r$6=Object.freeze({left:0,center:.5,right:1}),o$3=Object.freeze({"bottom-left":r$g(0,0),bottom:r$g(.5,0),"bottom-right":r$g(1,0),left:r$g(0,.5),center:r$g(.5,.5),right:r$g(1,.5),"top-left":r$g(0,1),top:r$g(.5,1),"top-right":r$g(1,1)});function c$3(t){switch(t){case"left":return h$7.Left;case"right":return h$7.Right;default:return h$7.Center}}function i$4(t,e){switch(e){case"bottom":return "left"===t?"bottom-left":"right"===t?"bottom-right":"bottom";case"center":return t;case"top":return "left"===t?"top-left":"right"===t?"top-right":"top"}}function f$8(t){return "middle"===t?"center":t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var S$6,y$6,h$6;function x$6(e){return null!=e}function b$a(e){return "number"==typeof e}function C$5(e){return "string"==typeof e}function g$4(e){return null==e||C$5(e)}function M$4(e,o){e&&e.push(o);}function V$3(e,o,t,i=e$g()){const n=e||0,r=o||0,s=t||0;return 0!==n&&m$a(i,i,-n/180*Math.PI),0!==r&&b$i(i,i,r/180*Math.PI),0!==s&&l$k(i,i,s/180*Math.PI),i}function D$2(e,o,t,i,n){const r=e.minSize,s=e.maxSize;if(e.expression)return M$4(n,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=i.symbolSize[t];return o.minSize[t]=e,o.maxSize[t]=e,o.offset[t]=o.minSize[t],o.factor[t]=0,o.type[t]=S$6.DefinedSize,!0}if(x$6(e.field))return x$6(e.stops)?2===e.stops.length&&b$a(e.stops[0].size)&&b$a(e.stops[1].size)?(T$2(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,o,t),o.type[t]=S$6.DefinedSize,!0):(M$4(n,"Could not convert size info: stops only supported with 2 elements"),!1):b$a(r)&&b$a(s)&&x$6(e.minDataValue)&&x$6(e.maxDataValue)?(T$2(r,s,e.minDataValue,e.maxDataValue,o,t),o.type[t]=S$6.DefinedSize,!0):null!=m$b[e.valueUnit]?(o.minSize[t]=-1/0,o.maxSize[t]=1/0,o.offset[t]=0,o.factor[t]=1/m$b[e.valueUnit],o.type[t]=S$6.DefinedSize,!0):"unknown"===e.valueUnit?(M$4(n,"Could not convert size info: proportional size not supported"),!1):(M$4(n,"Could not convert size info: scale-dependent size not supported"),!1);if(!x$6(e.field)){if(e.stops&&e.stops[0]&&b$a(e.stops[0].size))return o.minSize[t]=e.stops[0].size,o.maxSize[t]=e.stops[0].size,o.offset[t]=o.minSize[t],o.factor[t]=0,o.type[t]=S$6.DefinedSize,!0;if(b$a(r))return o.minSize[t]=r,o.maxSize[t]=r,o.offset[t]=r,o.factor[t]=0,o.type[t]=S$6.DefinedSize,!0}return M$4(n,"Could not convert size info: unsupported variant of sizeInfo"),!1}function T$2(e,o,t,i,n,r){const s=Math.abs(i-t)>0?(o-e)/(i-t):0;n.minSize[r]=s>0?e:o,n.maxSize[r]=s>0?o:e,n.offset[r]=e-t*s,n.factor[r]=s;}function U$3(e,o,t,i){if(e.normalizationField||e.valueRepresentation)return M$4(i,"Could not convert size info: unsupported property"),null;if(!g$4(e.field))return M$4(i,"Could not convert size info: field is not a string"),null;if(o.size){if(e.field)if(o.size.field){if(e.field!==o.size.field)return M$4(i,"Could not convert size info: multiple fields in use"),null}else o.size.field=e.field;}else o.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[S$6.Undefined,S$6.Undefined,S$6.Undefined]};let n;switch(e.axis){case"width":return n=D$2(e,o.size,0,t,i),n?o:null;case"height":return n=D$2(e,o.size,2,t,i),n?o:null;case"depth":return n=D$2(e,o.size,1,t,i),n?o:null;case"width-and-depth":return n=D$2(e,o.size,0,t,i),n&&D$2(e,o.size,1,t,i),n?o:null;case null:case void 0:case"all":return n=D$2(e,o.size,0,t,i),n=n&&D$2(e,o.size,1,t,i),n=n&&D$2(e,o.size,2,t,i),n?o:null;default:return M$4(i,`Could not convert size info: unknown axis "${e.axis}""`),null}}function E$6(e,o,t){for(let n=0;n<3;++n){let t=o.unitInMeters;e.type[n]===S$6.DefinedSize&&(t*=o.modelSize[n],e.type[n]=S$6.DefinedScale),e.minSize[n]=e.minSize[n]/t,e.maxSize[n]=e.maxSize[n]/t,e.offset[n]=e.offset[n]/t,e.factor[n]=e.factor[n]/t;}let i;if(e.type[0]!==S$6.Undefined)i=0;else if(e.type[1]!==S$6.Undefined)i=1;else {if(e.type[2]===S$6.Undefined)return M$4(t,"No size axis contains a valid size or scale"),!1;i=2;}for(let n=0;n<3;++n)e.type[n]===S$6.Undefined&&(e.minSize[n]=e.minSize[i],e.maxSize[n]=e.maxSize[i],e.offset[n]=e.offset[i],e.factor[n]=e.factor[i],e.type[n]=e.type[i]);return !0}function O$3(e,o,t){e[4*o+0]=t.r/255,e[4*o+1]=t.g/255,e[4*o+2]=t.b/255,e[4*o+3]=t.a;}function j$6(e,o,t){if(e.normalizationField)return M$4(t,"Could not convert color info: unsupported property"),null;if(C$5(e.field)){if(!e.stops)return M$4(t,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return M$4(t,"Could not convert color info: too many color stops"),null;o.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const t=i[Math.min(e,i.length-1)];o.color.values[e]=t.value,O$3(o.color.colors,e,t.color);}}}else {if(!(e.stops&&e.stops.length>=0))return M$4(t,"Could not convert color info: no field and no colors/stops"),null;{const t=e.stops&&e.stops.length>=0&&e.stops[0].color;o.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)o.color.values[e]=1/0,O$3(o.color.colors,e,t);}}return o}function k$6(e,o,t){if(e.normalizationField)return M$4(t,"Could not convert opacity info: unsupported property"),null;if(C$5(e.field)){if(!e.stops)return M$4(t,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return M$4(t,"Could not convert opacity info: too many opacity stops"),null;o.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const i=e.stops;for(let e=0;e<8;++e){const t=i[Math.min(e,i.length-1)];o.opacity.values[e]=t.value,o.opacity.opacityValues[e]=t.opacity;}}}else {if(!(e.stops&&e.stops.length>=0))return M$4(t,"Could not convert opacity info: no field and no opacities/stops"),null;{const t=e.stops&&e.stops.length>=0&&e.stops[0].opacity;o.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)o.opacity.values[e]=1/0,o.opacity.opacityValues[e]=t;}}return o}function w$7(e,o,t){const i=2===t&&"arithmetic"===e.rotationType;o.offset[t]=i?90:0,o.factor[t]=i?-1:1,o.type[t]=1;}function F$5(e,o,t){if(!C$5(e.field))return M$4(t,"Could not convert rotation info: field is not a string"),null;if(o.rotation){if(e.field)if(o.rotation.field){if(e.field!==o.rotation.field)return M$4(t,"Could not convert rotation info: multiple fields in use"),null}else o.rotation.field=e.field;}else o.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return w$7(e,o.rotation,0),o;case"roll":return w$7(e,o.rotation,1),o;case null:case void 0:case"heading":return w$7(e,o.rotation,2),o;default:return M$4(t,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function A$4(e,o,t){if(!e)return null;const i=!o.supportedTypes||!!o.supportedTypes.size,n=!o.supportedTypes||!!o.supportedTypes.color,r=!o.supportedTypes||!!o.supportedTypes.rotation,s=!!o.supportedTypes&&!!o.supportedTypes.opacity,l=e.reduce(((e,l)=>{if(!e)return e;if(l.valueExpression)return M$4(t,"Could not convert visual variables: arcade expressions not supported"),null;switch(l.type){case"size":return i?U$3(l,e,o,t):e;case"color":return n?j$6(l,e,t):e;case"opacity":return s?k$6(l,e,t):null;case"rotation":return r?F$5(l,e,t):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return !(e.length>0&&l)||l.size||l.color||l.opacity||l.rotation?l&&l.size&&!E$6(l.size,o,t)?null:l:null}function I$4(e){return e&&null!=e.size}function P$5(e,o){if(!e)return {enabled:!1};if(t$b.TESTS_DISABLE_FAST_UPDATES)return {enabled:!1};const t=A$4(e.visualVariables,o);return t?{enabled:!0,visualVariables:t,materialParameters:q$5(t,o),requiresShaderTransformation:I$4(t)}:{enabled:!1}}function R$4(e,o,t){if(!o||!e.enabled)return !1;const i=e.visualVariables,n=A$4(o.visualVariables,t);return !!n&&(!!(_$8(i.size,n.size,"size")&&_$8(i.color,n.color,"color")&&_$8(i.rotation,n.rotation,"rotation")&&_$8(i.opacity,n.opacity,"opacity"))&&(e.visualVariables=n,e.materialParameters=q$5(n,t),e.requiresShaderTransformation=I$4(n),!0))}function _$8(e,o,t){if(!!e!=!!o)return !1;if(e&&e.field!==o.field)return !1;if(e&&"rotation"===t){const t=e,i=o;for(let e=0;e<3;e++)if(t.type[e]!==i.type[e]||t.offset[e]!==i.offset[e]||t.factor[e]!==i.factor[e])return !1}return !0}function q$5(e,n){const r={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},s=I$4(e);return e&&e.size?(r.vvSizeEnabled=!0,r.vvSizeMinSize=e.size.minSize,r.vvSizeMaxSize=e.size.maxSize,r.vvSizeOffset=e.size.offset,r.vvSizeFactor=e.size.factor):e&&s&&(r.vvSizeValue=n.transformation.scale),e&&s&&(r.vvSymbolAnchor=n.transformation.anchor,r.vvSymbolRotationMatrix=e$q(),r$h($$1),V$3(n.transformation.rotation[2],n.transformation.rotation[0],n.transformation.rotation[1],$$1),a$g(r.vvSymbolRotationMatrix,$$1)),e&&e.color&&(r.vvColorEnabled=!0,r.vvColorValues=e.color.values,r.vvColorColors=e.color.colors),e&&e.opacity&&(r.vvOpacityEnabled=!0,r.vvOpacityValues=e.opacity.values,r.vvOpacityOpacities=e.opacity.opacityValues),r}!function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale";}(S$6||(S$6={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle";}(y$6||(y$6={})),function(o){const t=e$g(),i=n$h();function u(o,u,f){if(!o.vvSizeEnabled)return f;n$g(t,f);const c=o.vvSymbolRotationMatrix;s$e($$1,c[0],c[1],c[2],0,c[3],c[4],c[5],0,c[6],c[7],c[8],0,0,0,0,1),u$k(t,t,$$1);for(let t=0;t<3;++t){const n=o.vvSizeOffset[t]+u[0]*o.vvSizeFactor[t];i[t]=o$c(n,o.vvSizeMinSize[t],o.vvSizeMaxSize[t]);}return i$b(t,t,i),c$f(t,t,o.vvSymbolAnchor),t}function f(o,t,i){if(!t.vvSizeEnabled)return o$6(o,1,1,1);for(let n=0;n<3;++n){const r=t.vvSizeOffset[n]+i[0]*t.vvSizeFactor[n];o[n]=o$c(r,t.vvSizeMinSize[n],t.vvSizeMaxSize[n]);}return o}o.evaluateModelTransform=u,o.evaluateModelTransformScale=f;}(h$6||(h$6={}));const $$1=e$g(),B$3=h$6.evaluateModelTransform,L$3=h$6.evaluateModelTransformScale;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const se$1=e$g(),ae$1=r$i(0,0,1),oe$1=16,ne$1=1.5,le$1=a$i,ce$1=[le$1/2,le$1/2,1-le$1/2,1-le$1/2],he$2=[e$r*le$1,e$r*le$1];class me$3 extends y$7{constructor(e,t,r,i){super(e,t,r,i),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};}getCachedSize(){return {size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),r=this._getPrimitive();if(r$a(r))this._prepareResourcesPrimitive(t,r);else {const r=d$l(this.symbol,this.symbolLayer),i=nt$1(r);i&&"application/json"===i.mediaType?await this._prepareResourcesCIM(t,JSON.parse(i.data),e):await this._prepareResourcesHref(t,r,e);}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=S$g(this._getIconSize());if(e)throw new s$d("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?u$e(e.size):oe$1);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let r=""===t?null:this._cimSymbolTextures.get(t);if(!r){const i={scaleFactor:this._cimScaleFactorOrFunction},s=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",i,null,null);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",s.anchorPosition);const a={width:s.imageData.width,height:s.imageData.height,powerOfTwoResizeMode:c$g.PAD};r=new L$5(s.imageData,a),this._cimSymbolTextures.set(t,r),this._context.stage.add(r);}return r}_computeSize(e,t){const r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(ue$3(t)){const{screenLength:r,minWorldLength:s,maxWorldLength:a}=t.verticalOffset;e.verticalOffset={screenLength:u$e(r),minWorldLength:s||0,maxWorldLength:r$a(a)?a:1/0};}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const r=this._getOutlineSize();if(de$2(t)&&0===r)throw new Error("Nothing to render");this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const i=this._context.sharedResources.textures.fromData(t,(()=>o$d(t)));this._texture=i.texture,this._releaseTexture=i,e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=ce$1,e.textureId=this._texture.id;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/le$1,this._createMaterialAndAddToStage(e,this._context.stage);}async _prepareResourcesHref(e,i,s){if(!has("esri-canvas-svg-support")&&It(i)){throw new s$d("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)")}this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const a=this._getIconSize(),o=a*this._context.graphicsCoreOwner.view.state.pixelRatio,n=await b$j(this._context.sharedResources.textures.fromUrl(i,o,{signal:s}));if(!1===n.ok){w$b(n.error);throw new s$d("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${i})`)}this._releaseTexture=n.value;const l=n.value.texture,h=l.params;this._size=this._computeSize(h,a),e.textureId=l.id,this._createMaterialAndAddToStage(e,this._context.stage);}async _prepareResourcesCIM(e,t,r){const i=new d$m({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await import('./CIMSymbolRasterizer-9bfbc2a6.js')).CIMSymbolRasterizer;f$d(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0));}const s=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let a,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(i,s,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,r=await i$c(t,this._context.layer.spatialReference,s);o=(e,t,i)=>{const s=s$f(r,e,{$view:i},"esriGeometryPoint",t);return null!==s?s:1};}else a=Number(e.scaleExpression);}this._cimScaleFactorOrFunction=a||o||1;const n=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];f$d(r);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=n.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1;}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||j$a}_getOutlineSize(){let e=0;const t=this.symbolLayer;if(r$a(t.outline)&&null!=t.outline.size)return Math.max(u$e(t.outline.size),0);return e=de$2(this._getPrimitive())?ne$1:0,Math.max(e,0)}_getOutlineColor(){const t=this._getLayerOpacity(),r=this.symbolLayer,a=m$9(r,"outline","color");if(r$a(a)){const r=l$b.toUnitRGB(a),i=a.a*t;return [r[0],r[1],r[2],i]}return [0,0,0,0]}_getFillColor(){if(de$2(this._getPrimitive()))return t$h;const e=t$9(this._getPrimitive()),t=m$9(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return "relative"===e?r$g((t.x||0)+.5,.5-(t.y||0)):e in o$3?o$3[e]:o$3.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=P$5(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let r=r$a(e.textureId)?this._cimSymbolMaterials.get(e.textureId):null;return r||(r=new K$3(e),this._cimSymbolMaterials.set(c$a(e.textureId,0),r),t.add(r)),r}return this._material=new K$3(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped});})),this.layerOpacityChanged());}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture=p$d(this._releaseTexture);}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const r=e.size[t];r&&"symbol-value"!==r&&"proportional"!==r&&(e.size[t]=u$e(r));}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return +e.size[0]/t;if(isFinite(+e.size[2]))return +e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let r,i;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),s={textureId:e.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(s,this._context.stage),r=[e.params.width,e.params.height];}else r=this._size,i=e$h(this._material);const s=d$n(t.geometry);if(t$9(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const o=e.renderingInfo,n=this._getVertexOpacityAndColor(o);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=r[0]>r[1]?r[0]:r[1];c=this._getScaleFactor(o,e);}c*=this._symbolTextureRatio;const h=[r[0]*c,r[1]*c],m=this.setGraphicElevationContext(t,new h$d);return this.ensureDrapedStatus("on-the-ground"===m.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,s,i,n,h,e.layer.uid):this._createAs3DShape(t,s,i,n,h,m,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((r=>{r.setParameters({color:e}),r.setParameters({outlineColor:t});})),!0}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,s=p$c(me$3.elevationModeChangeTypes,r,i);if(s!==x$8.UPDATE)return s;const a=g$c(i)||"absolute-height"===i;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});})),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !!this._getPrimitive()}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return e$c.Recreate_Symbol;if(!R$4(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return e$c.Recreate_Symbol;r$a(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters);}return e$c.Fast_Update}_defaultElevationInfoNoZ(){return _e$3}_createAs3DShape(e,t,r,i,s,a,o){const n=this.getFastUpdateAttrValues(e),l=n?e=>B$3(this._fastUpdates.materialParameters,n,e):null,c=[T$4.createPointGeometry(ae$1,null,i,s,pe$2,null,n)],h=f$h(this._context,t,c,[r],a,this._context.layer.uid,o,l);if(null===h)return null;const m=new _$b(this,h.object,c,null,null,d$e,a);return m.alignedSampledElevation=h.sampledElevation,m.needsElevationUpdates=g$c(a.mode)||"absolute-height"===a.mode,m.getScreenSize=this._createScreenSizeGetter(s,l),m.calculateRelativeScreenBounds=e=>r.calculateRelativeScreenBounds(m.getScreenSize(),1,e),g$e(m,t,this._context.elevationProvider),m}_createAsOverlay(e,t,r,s,a,o){r.renderPriority=this._renderPriority;const n=n$m();Hn(t,n,this._context.overlaySR),n[2]=ge$2;const l=this._context.clippingExtent;if(r$a(l)&&!E$f(l,n))return null;const c=this.getFastUpdateAttrValues(e),h=c?e=>B$3(this._fastUpdates.materialParameters,c,e):null,m=T$4.createPointGeometry(ae$1,n,s,a,null,null,c),u=new T$7(m,r,{layerUid:o,graphicUid:e.uid,calculateShaderTransformation:h});n[3]=0,a$h(u.boundingSphere,n);const d=new u$5(this,[u],null,this._context.drapeSourceRenderer);return d.getScreenSize=this._createScreenSizeGetter(a,h),d.calculateRelativeScreenBounds=e=>r.calculateRelativeScreenBounds(d.getScreenSize(),1,e),d}_createScreenSizeGetter(e,t){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const i=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return (e=n$k())=>{const a=t(se$1);return e[0]=a[0]*i+r,e[1]=a[5]*s+r,e}}{const t=e[0]/this._symbolTextureRatio+r,i=e[1]/this._symbolTextureRatio+r;return (e=n$k())=>(e[0]=t,e[1]=i,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=r$i(e,e,e),r=e$s(1),i=e*r;return {modelSize:t,symbolSize:r$i(i,i,i),unitInMeters:r,transformation:{anchor:f$k,scale:l$c,rotation:f$k}}}_getGraphicHash(e){let t="";for(const r of this._cimRequiredFields)t+=r+e.attributes[r];return t}_forEachMaterial(e){r$a(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e);}test(){return {...super.test(),material:this._material}}}function ue$3(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}function de$2(e){return !t$9(e)&&("cross"===e||"x"===e)}me$3.PRIMITIVE_SIZE=he$2,me$3.elevationModeChangeTypes={definedChanged:x$8.UPDATE,staysOnTheGround:x$8.NONE,onTheGroundChanged:x$8.RECREATE};const _e$3={mode:"relative-to-ground",offset:0},pe$2=r$c(0,0,0,1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const n$6=64,o$2=n$6/2,i$3=o$2/5;function e$7(t,n){return r$a(n)?m$3(t,f$7(n.style)):null}function m$3(r,e){return r.fromData(e,(()=>o$d(e,n$6,o$2,i$3)))}function f$7(r){return "diamond"===r?"kite":r}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function b$9(b){const x=new o$7,P=b.hasMultipassTerrain&&(b.output===h$e.Color||b.output===h$e.Alpha);x.include(s$g,b),b.output===h$e.Depth&&x.include(o$e,b);const{vertex:S,fragment:j}=x;return j.include(a$j),v$d(x,b),x.attributes.add(O$7.POSITION,"vec3"),x.attributes.add(O$7.UV0,"vec2"),x.attributes.add(O$7.AUXPOS1,"vec3"),x.varyings.add("vColor","vec4"),x.varyings.add("vpos","vec3"),x.varyings.add("vUV","vec2"),x.varyings.add("vSize","float"),x.varyings.add("linearDepth","float"),P&&x.varyings.add("depth","float"),S.code.add(n$j`#define PERPENDICULAR(v) vec2(v.y, -v.x)
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}`),S.uniforms.add([new e$k("nearFar",((e,r)=>r.camera.nearFar)),new e$j("viewport",((e,r)=>r.camera.fullViewport))]),S.code.add(n$j`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),S.code.add(n$j`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
}`),b.draped||(S.uniforms.add(new e$t("inverseProjectionMatrix",((e,r)=>r.camera.inverseProjectionMatrix))),S.code.add(n$j`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),S.code.add(n$j`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),S.uniforms.add(new o$8("perScreenPixelRatio",((e,r)=>r.camera.perScreenPixelRatio))),S.code.add(n$j`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${b.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += PERPENDICULAR(diff) / 2.0;\n                }\n              ":""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),S.uniforms.add(new o$8("pixelRatio",((e,r)=>r.camera.pixelRatio))),S.code.add(n$j`
    void main(void) {
      float coverage = 1.0;

      // Check for special value of uv0.y which is used by the Renderer when graphics
      // are removed before the VBO is recompacted. If this is the case, then we just
      // project outside of clip space.
      if (uv0.y == 0.0) {
        // Project out of clip space
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      }
      else {
        float lineSize = getSize();
        float lineWidth = max(lineSize, 1.0) * pixelRatio;

        vec4 pos  = view * vec4(position.xyz, 1.0);
        vec4 prev = view * vec4(auxpos1.xyz, 1.0);
        clip(pos, prev);

        vec4 posScreen = projectAndScale(pos);
        vec4 prevScreen = projectAndScale(prev);

        vec2 segment = posScreen.xy - prevScreen.xy;

        // normalize vector along line segment
        float segmentLen = length(segment);
        segment = (segmentLen > 0.001) ? segment / segmentLen : vec2(0.0, 0.0);

        // displace according to position in the texture
        vec2 displacementDirU = PERPENDICULAR(segment);
        vec2 displacementDirV = segment;

        float displacementLen = ${n$j.float(n$6/i$3)} * lineWidth;

        vec4 displacedPosScreen = posScreen;
        displacedPosScreen.xy += uv0.x * displacementDirU * displacementLen + uv0.y * displacementDirV * displacementLen;
  `),b.draped||S.code.add(n$j`vec3 posRight = inverseProject(posScreen + vec4(displacementDirU.xy, 0.0, 0.0) * lineWidth);
vec3 posLeft = pos.xyz + (pos.xyz - posRight);
pos = toFront(displacedPosScreen, posLeft, posRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`),S.code.add(n$j`
        ${P?"depth = pos.z;":""}
        linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1] and cancel out perspective correct interpolation
        vUV = (uv0 + 1.0) / 2.0;
        vUV *= displacedPosScreen.w;

        vSize = displacementLen;

        vColor = getColor();
        vColor.a *= coverage;

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),P&&x.include(n$n,b),x.include(u$h,b),j.uniforms.add([new e$j("intrinsicColor",(e=>e.color)),new m$c("tex",(e=>e.texture))]),j.include(e$u),j.code.add(n$j`
  void main() {
    discardBySlice(vpos);
    ${P?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    // Offset texture coordinate s.t. we sample texel centers
    float texelSize = ${n$j.float(1/n$6)};
    vec2 samplePos = vUV * gl_FragCoord.w + vec2(0.5, -0.5) * texelSize;

    // Evaluate sdf
    float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
    float distance = sdf * vSize;

    // Grow by a halfpixel to make sure the line is fully covered by the cross marker
    // (otherwise there will be a halo if they are different colours)
    distance -= 0.5;

    finalColor.a *= clamp(0.5 - distance, 0.0, 1.0);

    if (finalColor.a < ${n$j.float(t$i)}) {
      discard;
    }

    ${b.output===h$e.Alpha?n$j`gl_FragColor = vec4(finalColor.a);`:""}
    ${b.output===h$e.Color?n$j`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${b.output===h$e.Color&&b.transparencyPassType===o$f.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${b.output===h$e.Highlight?n$j`gl_FragColor = vec4(1.0);`:""}
    ${b.output===h$e.Depth?n$j`outputDepth(linearDepth);`:""}
  }
  `),x}const x$5=Object.freeze(Object.defineProperty({__proto__:null,build:b$9},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const R$3=new Map([[O$7.POSITION,0],[O$7.UV0,2],[O$7.AUXPOS1,3],[O$7.SIZE,6],[O$7.SIZEFEATUREATTRIBUTE,6],[O$7.COLOR,5],[O$7.COLORFEATUREATTRIBUTE,5],[O$7.OPACITYFEATUREATTRIBUTE,7]]);class b$8 extends e$l{initializeProgram(e){return new o$9(e.rctx,b$8.shader.get().build(this.configuration),R$3)}_makePipelineState(t,i){const o=this.configuration,a=t===o$f.NONE;return W$3({blending:o.output===h$e.Color||o.output===h$e.Alpha?a?c$h:A$9(t):null,depthTest:{func:l$l(t)},depthWrite:a?o.writeDepth&&a$e:E$g(t),colorWrite:_$c,stencilWrite:o.hasOccludees?e$v:null,stencilTest:o.hasOccludees?i?o$g:f$l:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=W$3({blending:c$h,depthTest:s$h,depthWrite:null,colorWrite:_$c,stencilWrite:null,stencilTest:m$d}),this._occluderPipelineOpaque=W$3({blending:c$h,depthTest:s$h,depthWrite:null,colorWrite:_$c,stencilWrite:l$m,stencilTest:P$8}),this._occluderPipelineMaskWrite=W$3({blending:null,depthTest:i$d,depthWrite:null,colorWrite:null,stencilWrite:e$v,stencilTest:o$g})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===E$c.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===E$c.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}b$8.shader=new t$d(x$5,(()=>import('./LineMarker.glsl-c5e397d2.js')));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$6 extends s$c{constructor(){super(...arguments),this.output=h$e.Color,this.transparencyPassType=o$f.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.draped=!1,this.hasCap=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1;}}e$e([e$m({count:h$e.COUNT})],s$6.prototype,"output",void 0),e$e([e$m({count:o$f.COUNT})],s$6.prototype,"transparencyPassType",void 0),e$e([e$m()],s$6.prototype,"occluder",void 0),e$e([e$m()],s$6.prototype,"hasSlicePlane",void 0),e$e([e$m()],s$6.prototype,"writeDepth",void 0),e$e([e$m()],s$6.prototype,"draped",void 0),e$e([e$m()],s$6.prototype,"hasCap",void 0),e$e([e$m()],s$6.prototype,"vvSize",void 0),e$e([e$m()],s$6.prototype,"vvColor",void 0),e$e([e$m()],s$6.prototype,"vvOpacity",void 0),e$e([e$m()],s$6.prototype,"hasOccludees",void 0),e$e([e$m()],s$6.prototype,"hasMultipassTerrain",void 0),e$e([e$m()],s$6.prototype,"cullAboveGround",void 0),e$e([e$m({constValue:!0})],s$6.prototype,"hasVvInstancing",void 0),e$e([e$m({constValue:!0})],s$6.prototype,"hasSliceTranslatedView",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class A$3 extends d$j{constructor(e){super(e,new f$6),this._vertexAttributeLocations=R$3,this._configuration=new s$6,this.layout=this.createLayout();}dispose(){}getConfiguration(e,t){return this._configuration.output=e,this._configuration.draped=t.slot===E$c.DRAPED_MATERIAL,this._configuration.hasCap=this.parameters.cap!==r$j.BUTT,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===o$a.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=T$5().vec3f(O$7.POSITION).vec2f(O$7.UV0).vec3f(O$7.AUXPOS1);return this.parameters.vvSizeEnabled?e.f32(O$7.SIZEFEATUREATTRIBUTE):e.f32(O$7.SIZE),this.parameters.vvColorEnabled?e.f32(O$7.COLORFEATUREATTRIBUTE):e.vec4f(O$7.COLOR),this.parameters.vvOpacityEnabled&&e.f32(O$7.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new v$6(this.layout,this.parameters)}requiresSlot(e,t){if(t===h$e.Color||t===h$e.Alpha||t===h$e.Highlight||t===h$e.Depth){if(e===E$c.DRAPED_MATERIAL)return !0;if(this.parameters.renderOccluded===o$a.OccludeAndTransparentStencil)return e===E$c.OPAQUE_MATERIAL||e===E$c.OCCLUDER_MATERIAL||e===E$c.TRANSPARENT_OCCLUDER_MATERIAL;if(t===h$e.Color||t===h$e.Alpha){return e===(this.parameters.writeDepth?E$c.TRANSPARENT_MATERIAL:E$c.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return e===E$c.OPAQUE_MATERIAL}return !1}createGLMaterial(e){return new T$1(e)}}class T$1 extends h$h{_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(b$8,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees});}beginSlot(e){return this._output!==h$e.Color&&this._output!==h$e.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class f$6 extends v$e{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=r$j.BUTT,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1;}}class v$6{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return "begin-end"===this._parameters.placement?12:6}write(a,s,i,n){const o=s.vertexAttributes.get(O$7.POSITION).data,u=o.length/3;let c=1,l=0;this._parameters.vvSizeEnabled?l=s.vertexAttributes.get(O$7.SIZEFEATUREATTRIBUTE).data[0]:s.vertexAttributes.has(O$7.SIZE)&&(c=s.vertexAttributes.get(O$7.SIZE).data[0]);let p=[1,1,1,1],d=0;this._parameters.vvColorEnabled?d=s.vertexAttributes.get(O$7.COLORFEATUREATTRIBUTE).data[0]:s.vertexAttributes.has(O$7.COLOR)&&(p=s.vertexAttributes.get(O$7.COLOR).data);let m=0;this._parameters.vvOpacityEnabled&&(m=s.vertexAttributes.get(O$7.OPACITYFEATUREATTRIBUTE).data[0]);const E=a.transformation,A=new Float32Array(i.buffer);let T=n*(this.vertexBufferLayout.stride/4);const f=(e,t,r,a)=>{if(A[T++]=e[0],A[T++]=e[1],A[T++]=e[2],A[T++]=r[0],A[T++]=r[1],A[T++]=t[0],A[T++]=t[1],A[T++]=t[2],this._parameters.vvSizeEnabled?A[T++]=l:A[T++]=c,this._parameters.vvColorEnabled)A[T++]=d;else {const e=Math.min(4*a,p.length-4);A[T++]=p[e+0],A[T++]=p[e+1],A[T++]=p[e+2],A[T++]=p[e+3];}this._parameters.vvOpacityEnabled&&(A[T++]=m);};let v;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING";}(v||(v={}));const O=(a,s)=>{const i=o$6(_$7,o[3*a],o[3*a+1],o[3*a+2]),n=b$7;let c=a+s;do{o$6(n,o[3*c],o[3*c+1],o[3*c+2]),c+=s;}while(G$4(i,n)&&c>=0&&c<u);E&&(O$8(i,i,E),O$8(n,n,E)),f(i,n,[-1,-1],a),f(i,n,[1,-1],a),f(i,n,[1,1],a),f(i,n,[-1,-1],a),f(i,n,[1,1],a),f(i,n,[-1,1],a);},R=this._parameters.placement;"begin"!==R&&"begin-end"!==R||O(0,v.ASCENDING),"end"!==R&&"begin-end"!==R||O(u-1,v.DESCENDING);}}const _$7=n$h(),b$7=n$h();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const q$4=["polyline","polygon","extent"];class K$1 extends y$7{constructor(e,t,r,a){super(e,t,r,a),this._uniformSize=1;}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=P$5(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const t=null!=this.symbolLayer.size?this.symbolLayer.size:e$s(1);if(t<0)throw new s$d("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t;}this._markerTexture=e$7(this._context.sharedResources.textures,this.symbolLayer.marker);}_getMaterialParameters(e,t=!1){const r=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(r[3]=0);const a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:r,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:L$6(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:a$k(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...a,...this._fastUpdates.materialParameters}:a}get _materialColor(){return o$h(this.symbolLayer.material,(e=>e.color))}get _markerColor(){return o$h(this.symbolLayer.marker,(e=>e.color))}get _lineMaterial(){return t$9(this._lineMaterialCached)&&(this._lineMaterialCached=new B$7(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return t$9(this._ringMaterialCached)&&(this._ringMaterialCached=new B$7(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return t$9(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new B$7({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return t$9(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new B$7({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return t$9(this._markerMaterialCached)&&r$a(this.symbolLayer.marker)&&r$a(this._markerTexture)&&(this._markerMaterialCached=new A$3({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=p$d(this._markerTexture);}_getDrivenSize(e){return this._drivenProperties.size&&e.size?u$e(c$7(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?v$8(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const t=r$c(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?v$8(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?v$8(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,q$4,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new h$d);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return e$c.Recreate_Symbol;if(!R$4(this._fastUpdates,t,this._vvConvertOptions))return e$c.Recreate_Symbol;this._forEachMaterial((e=>e.setParameters(this._fastUpdates.materialParameters)));}return e$c.Fast_Update}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff,r={};"complete"===t.size?.type&&(r.width=this._computeMaterialWidth(t.size.newValue),delete t.size),"complete"===t.cap?.type&&(r.cap=L$6(c$a(t.cap.newValue,"butt")),delete t.cap);const a=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,a),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e.setParameters(r)))));}layerOpacityChanged(){return this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t))),!0}_forEachMaterial(e){r$a(this._lineMaterialCached)&&e(this._lineMaterialCached),r$a(this._ringMaterialCached)&&e(this._ringMaterialCached),r$a(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),r$a(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),r$a(this._markerMaterialCached)&&e(this._markerMaterialCached,!0);}_updateMaterialLayerOpacity(e,t=!1){const r=e.parameters.color,a=m$9(this.symbolLayer,"material","color"),i=this._patternHidesLine&&!t?0:this._getCombinedOpacity(a),s=r$c(r[0],r[1],r[2],i);e.setParameters({color:s});}layerElevationInfoChanged(e,t,r){const a=this._elevationContext.mode,i=p$c(K$1.elevationModeChangeTypes,r,a);if(i!==x$8.UPDATE)return i;const s=g$c(a);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>s))}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t.setParameters(e))),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof w$a)return v$b.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,r){const i=e.graphic,s=this._getGeometryAsPolygonOrPolyline(i.geometry),o="polygon"===s.type?s.rings:s.paths,n=new Array,l=new Array,h=new Array,p=a$c(),d=R$8(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),m="polygon"===s.type?"rings":"paths";this._logGeometryCreationWarnings(d,o,m,"LineSymbol3DLayer");for(let _=0;_<d.lines.length;_++){const{position:t,mapPosition:r}=d.lines[_];if(r$a(this._context.clippingExtent)&&(B$5(p),M$7(p,r),!R$7(p,this._context.clippingExtent)))continue;const i=this._createGeometry(e,t,r,s.type,J$1.ELEVATED);n.push(i),l.push("polygon"===s.type?this._ringMaterial:this._lineMaterial),h.push(o$b),t$b.LINE_WIREFRAMES&&(n.push(i.cloneShallow()),l.push("polygon"===s.type?this._wireframeRingMaterial:this._wireframeLineMaterial),h.push(o$b));const o=this._markerMaterial;r$a(o)&&(n.push(i.cloneShallow()),l.push(o),h.push(o$b));}if(0===n.length)return null;const f=new O$9({geometries:n,materials:l,transformations:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),M=new _$b(this,f,n,null,null,b$f,t);return M.alignedSampledElevation=d.sampledElevation,M.needsElevationUpdates=g$c(t.mode),M}_createGeometry(e,t,r,a,i){const s="polygon"===a?P$9.REMOVE:P$9.KEEP,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return O$a({overlayInfo:i===J$1.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:s,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:r,size:n?null:this._getDrivenSize(e.renderingInfo),color:o?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const r=e.graphic,i=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===i.type?i.rings:i.paths,o="polygon"===i.type?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;const l=t$b.LINE_WIREFRAMES?"polygon"===i.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,h=this._markerMaterial;r$a(l)&&(l.renderPriority=this._renderPriority-.001),r$a(h)&&(h.renderPriority=this._renderPriority-.002);const c=new Array,p=a$c(),d=B$5(),m=I$8(i,this._context.overlaySR),M="polygon"===i.type?"rings":"paths";this._logGeometryCreationWarnings(m,s,M,"LineSymbol3DLayer");for(const _ of m.lines){if(B$5(p),M$7(p,_.position),!R$7(p,this._context.clippingExtent))continue;f$i(d,p);const s=this._createGeometry(e,_.position,null,i.type,J$1.DRAPED),m=e=>{const a=new T$7(s,e,{layerUid:t,graphicUid:r.uid});return c.push(a),a};if(r$a(h)){const e=m(h),t=e$h(this.symbolLayer.marker).placement;"begin"!==t&&"begin-end"!==t||M$7(p,_.position,0,1),"end"!==t&&"begin-end"!==t||M$7(p,_.position,_.position.length-3,1),this._updateBoundingSphere(e,p);}const M=m(o);if(this._updateBoundingSphere(M,p),t$b.LINE_WIREFRAMES){const e=m(l);this._updateBoundingSphere(e,p);}}return new u$5(this,c,d,this._context.drapeSourceRenderer)}_updateBoundingSphere(e,t){r$k(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])));}get _patternHidesLine(){const e=this.symbolLayer.pattern;return r$a(e)&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=c$a(e,e$s(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?u$e(1):1:u$e(e)}_prepareMaterialPatch(e,a,i){const s=a.material;if(t$9(s))return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if("collection"===s.type)return;const o="complete"===s.type?o$h(s.newValue,(e=>e.color)):"complete"===s.diff.color.type?s.diff.color.newValue:null,n=this._getCombinedOpacityAndColor(o);i.useMaterialColor&&this._patchMaterialColor(t$j(n),this._markerMaterialCached,e),this._patternHidesLine&&(n[3]=0),this._patchMaterialColor(n,this._lineMaterialCached,e),delete a.material;}_prepareMarkerPatch(e,t){const i=t.marker;if(t$9(i)||"partial"!==i.type||r$a(i.diff.style)||r$a(i.diff.placement)||r$a(i.diff.color)&&"complete"!==i.diff.color.type)return {changed:!1,useMaterialColor:t$9(this._markerColor)};const s=i.diff.color;if(t$9(s))return delete t.marker,{changed:!1,useMaterialColor:t$9(this._markerColor)};const o=e$h(s.newValue);return t$9(o)?(delete t.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(o),this._markerMaterialCached,e),delete t.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(e,t,a){t$9(t)||a.symbolLayerStatePatches.push((()=>t.setParameters({color:e})));}}var J$1;K$1.elevationModeChangeTypes={definedChanged:x$8.RECREATE,staysOnTheGround:x$8.NONE,onTheGroundChanged:x$8.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED";}(J$1||(J$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const ue$2=["mesh"];class me$2 extends y$7{constructor(e,t,r,a){super(e,t,r,a),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1);}async doLoad(){t$b.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new F$7({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new F$7({color:[0,1,1,1]}));}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear();}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,ue$2,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(t,new h$d),a=e.renderingInfo;return this._createAs3DShape(t,a,r,t.uid)}layerOpacityChanged(e,r){const a=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameters({layerOpacity:a});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent});})),e.forEach((e=>{const o=r(e);r$a(o)&&o.layerOpacityChanged(a,this._context.isAsync);})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v$c)}slicePlaneEnabledChanged(e,r){return this._materials.forEach((e=>{e.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});})),e.forEach((e=>{const a=r(e);r$a(a)&&a.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync);})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameters({usePBR:e}))),!0}pixelRatioChanged(){return !0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(t){return t$9(t)?"-":t instanceof l$b?t.toHex():t.contentHash}_materialPropertiesDefault(e,t){const r=this._requiresSymbolVertexColors(),a=!!e.vertexAttributes.color,o=!!e.vertexAttributes.tangent;return {hasSymbolVertexColors:r,hasVertexColors:a,hasVertexTangents:o,uid:`vc:${a},vt:${o},vct${t},svc:${r}`}}_materialProperties(e,t,r){const a=this._materialPropertiesDefault(e,r);if(!t.material)return a;const{color:o,colorTexture:s,normalTexture:n,doubleSided:i,alphaCutoff:l,alphaMode:c}=t.material,u=this._colorOrTextureUid(o),m=this._colorOrTextureUid(s),h=this._colorOrTextureUid(n);if(a.color=o,a.colorTexture=s,a.normalTexture=n,a.uid=`${a.uid},cmuid:${u},ctmuid:${m},ntmuid:${h},ds:${i},ac:${l},am:${c}`,t.material instanceof c$i){const{metallic:e,roughness:r,metallicRoughnessTexture:o,emissiveColor:s,emissiveTexture:n,occlusionTexture:i}=t.material,l=this._colorOrTextureUid(o),c=this._colorOrTextureUid(s),u=this._colorOrTextureUid(n),m=this._colorOrTextureUid(i);a.metallic=e,a.roughness=r,a.metallicRoughnessTexture=o,a.emissiveColor=s,a.emissiveTexture=n,a.occlusionTexture=i,a.uid=`${a.uid},mrm:${e},mrr:${r},mrt:${l},emuid:${c},etmuid:${u},otmuid:${m}`;}return a}_setInternalColorValueParameters(t,r){r.diffuse=l$b.toUnitRGB(t),r.opacity=t.a;}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const r=this._getInternalTexture(e,C$9.Opaque);return r$a(r)?r.id:null}_getInternalTexture(e,t){const r=this._getLoadableTextureResource(e);if(!r)return null;const a=`${e.contentHash}/${t}`;let o=this._textures.get(a);return o||(o=new L$5(r,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:t!==C$9.Opaque}),this._textures.set(a,o),this._context.stage.add(o),this._context.stage.loadImmediate(o)),o}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return {s:t,t}}return {s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return D$3.CLAMP_TO_EDGE;case"mirror":return D$3.MIRRORED_REPEAT;default:return D$3.REPEAT}}_setInternalMaterialParameters(r,a){if(r$a(r.color)&&this._setInternalColorValueParameters(r.color,a),r$a(r.colorTexture)){const e=this._getInternalTexture(r.colorTexture,a.textureAlphaMode);r$a(e)?(a.textureId=e.id,a.textureAlphaPremultiplied=!!e.params.preMultiplyAlpha):a.textureId=void 0;}r$a(r.normalTexture)&&(a.normalTextureId=this._getInternalTextureId(r.normalTexture)),r$a(r.emissiveColor)&&(a.emissiveFactor=l$b.toUnitRGB(r.emissiveColor)),r$a(r.emissiveTexture)&&(a.emissiveTextureId=this._getInternalTextureId(r.emissiveTexture)),r$a(r.occlusionTexture)&&(a.occlusionTextureId=this._getInternalTextureId(r.occlusionTexture)),r$a(r.metallicRoughnessTexture)&&(a.metallicRoughnessTextureId=this._getInternalTextureId(r.metallicRoughnessTexture));}_setExternalMaterialParameters(r){const a=this._drivenProperties.color;let o=r$a(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(a)r.externalColor=_$e;else {const a=r$a(this.symbolLayer.material)?this.symbolLayer.material.color:null;r$a(a)?r.externalColor=l$b.toUnitRGBA(a):(o=null,r.externalColor=_$e);}o&&(r.colorMixMode=o),r.castShadows=!!this.symbolLayer.castShadows;}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(t$9(t))return !1;for(let r=3;r<t.length;r+=4)if(255!==t[r])return !0;return !1}_getOrCreateMaterial(e,r){const a=r.material?.color,o=r.material?.colorTexture,s=r.material?.alphaMode,n="blend"===s,i=!("opaque"===s)&&(this._hasTransparentVertexColors(e)||r$a(a)&&a.a<1||r$a(o)&&o.transparent||n),l=this._materialProperties(e,r,i),c=this._materials.get(l.uid);if(c)return c.material;const u={material:null,isComponentTransparent:i,alphaMode:r.material?r.material.alphaMode:"opaque"},m=null==l.metallicRoughnessTexture&&null==l.metallic&&null==l.roughness,h={usePBR:this._usePBR(),isSchematic:m,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:f$k,diffuse:l$c,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:n$l.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};m||(h.mrrFactors=[null!=l.metallic?l.metallic:1,null!=l.roughness?l.roughness:1,.5]),r.material&&(h.doubleSided=r.material.doubleSided,h.cullFace=r.material.doubleSided?n$l.None:n$l.Back,h.textureAlphaCutoff=r.material.alphaCutoff),this._setExternalMaterialParameters(h),this._setMaterialTransparentParameter(h,u),this._setInternalMaterialParameters(l,h);const p=new R$6(h);return u.material=p,this._materials.set(l.uid,u),this._context.stage.add(p),p}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?C$9.MaskBlend:C$9.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?C$9.Opaque:"mask"===t.alphaMode?C$9.Mask:C$9.Blend;}_addDebugNormals(e,t,r,a){const o=t.length,s=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),i=[],l=[],c=[],u=[];for(let m=0;m<o;m++){const e=t[m],r=e.vertexAttributes.get(O$7.POSITION),a=e.vertexAttributes.get(O$7.NORMAL),o=e.indices.get(O$7.POSITION),s=e.indices.get(O$7.NORMAL),h=r.data,d=a.data;for(let t=0;t<o.length;t++){const e=3*o[t],r=3*s[t];for(let t=0;t<3;t++)i.push(h[e+t]);for(let t=0;t<3;t++)i.push(h[e+t]+d[r+t]*n);if(l.push(l.length),l.push(l.length),t%3==0){this._calculateFaceNormal(h,o,t,ge$1),this._getFaceVertices(h,o,t,pe$1,fe$2,de$1),u$c(pe$1,pe$1,fe$2),u$c(pe$1,pe$1,de$1),g$f(pe$1,pe$1,1/3);for(let e=0;e<3;e++)c.push(pe$1[e]);for(let e=0;e<3;e++)c.push(pe$1[e]+ge$1[e]*n);u.push(u.length),u.push(u.length);}}}const h=new g$d([[O$7.POSITION,{data:i,size:3,exclusive:!0}]],[[O$7.POSITION,new Uint32Array(l)]],a$f.Line);t.push(h),r.push(this._debugVertexNormalMaterial),a.push(r$l(a[0]));const d=new g$d([[O$7.POSITION,{data:c,size:3,exclusive:!0}]],[[O$7.POSITION,new Uint32Array(u)]],a$f.Line);t.push(d),r.push(this._debugFaceNormalMaterial),a.push(r$l(a[0]));}_createAs3DShape(e,r,a,o){const s=e.geometry;if("mesh"!==s.type)return null;const n=this._createGeometryInfo(s,r);if(!n)return null;const{geometries:i,materials:l,transformations:c,objectTransformation:u}=n;t$b.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(s,i,l,c);const m=new O$9({geometries:i,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:o}});m.transformation=u;const h=this._createEdgeMaterial(),p=r$a(h)?{baseMaterial:l[0],edgeMaterials:[h],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,f=new _$b(this,m,i,null,null,d$e,a,p);return f.needsElevationUpdates=v$c(a.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(m),f.alignedSampledElevation=d$e(f,f.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),f}_getCenterPointInElevationSR(e){const r=v$f(0,0,0,r$a(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return dn([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,r),r}_createComponentNormals(e,t,r,a){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,r,a);case"flat":return this._createComponentNormalsFlat(e,a);case"smooth":return this._createComponentNormalsSmooth(e,a);default:return}}_createComponentNormalsSource(e,t,a,o){if(t$9(t))return this._createComponentNormalsFlat(e,o);let s=!1;if(!a.trustSourceNormals)for(let r=0;r<o.length;r+=3){this._calculateFaceNormal(e,o,r,ge$1);for(let e=0;e<3;e++){const a=3*o[r+e];pe$1[0]=t[a+0],pe$1[1]=t[a+1],pe$1[2]=t[a+2],P$a(ge$1,pe$1)<0&&(t[a+0]=-t[a+0],t[a+1]=-t[a+1],t[a+2]=-t[a+2],s=!0);}}return {normals:t,indices:o,didFlipNormals:s}}_createComponentNormalsFlat(e,t){const r=new Float32Array(t.length),a=new Uint32Array(3*t.length);for(let o=0;o<t.length;o+=3){const s=this._calculateFaceNormal(e,t,o,ge$1);for(let e=0;e<3;e++)r[o+e]=s[e],a[o+e]=o/3;}return {normals:r,indices:a,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const r={};for(let s=0;s<t.length;s+=3){const a=this._calculateFaceNormal(e,t,s,ge$1);for(let e=0;e<3;e++){const o=t[s+e];let n=r[o];n||(n={normal:n$h(),count:0},r[o]=n),u$c(n.normal,n.normal,a),n.count++;}}const a=new Float32Array(3*t.length),o=new Uint32Array(3*t.length);for(let s=0;s<t.length;s++){const e=r[t[s]];1!==e.count&&(z$5(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)a[3*s+t]=e.normal[t];o[s]=s;}return {normals:a,indices:o,didFlipNormals:!1}}_getFaceVertices(e,t,r,a,o,s){const n=3*t[r+0],i=3*t[r+1],l=3*t[r+2];a[0]=e[n+0],a[1]=e[n+1],a[2]=e[n+2],o[0]=e[i+0],o[1]=e[i+1],o[2]=e[i+2],s[0]=e[l+0],s[1]=e[l+1],s[2]=e[l+2];}_calculateFaceNormal(e,t,r,a){return this._getFaceVertices(e,t,r,pe$1,fe$2,de$1),e$p(fe$2,fe$2,pe$1),e$p(de$1,de$1,pe$1),_$d(pe$1,fe$2,de$1),z$5(a,pe$1),a}_getOrCreateComponents(e){return c$a(e.components,be$1)}_createPositionBuffer(e,r){let a=e.vertexAttributes.position;const o=r.reprojection===ve.ECEF?r.transformBeforeProject:null;if(r$a(o)&&(a=R$9(a,new Float64Array(a.length),o)),r.reprojection===ve.NONE)return r.needsBufferCopy?new Float64Array(a):a;const s=r$a(o)?a:new Float64Array(a.length);return Un(a,e.spatialReference,0,s,this._context.renderCoordsHelper.spatialReference,0,a.length/3),s}_createNormalBuffer(e,a,o){let s=e.vertexAttributes.normal;if(t$9(s))return null;const n=o.reprojection===ve.ECEF?o.transformBeforeProject:null;r$a(n)&&(s=v$g(s,new Float32Array(s.length),n));if("local"===this._context.graphicsCoreOwner.view.viewingMode||o.reprojection===ve.NONE)return o.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const i=e.vertexAttributes.position,l=r$a(n)?s:new Float32Array(s.length);return j$b(s,i,a,e.spatialReference,l)}_createTangentBuffer(e,a,o){let s=e.vertexAttributes.tangent;if(t$9(s))return null;const n=o.reprojection===ve.ECEF?o.transformBeforeProject:null;r$a(n)&&(s=V$6(s,new Float32Array(s.length),n));if("local"===this._context.graphicsCoreOwner.view.viewingMode||o.reprojection===ve.NONE)return o.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const i=e.vertexAttributes.position,l=r$a(n)?s:new Float32Array(s.length);return k$8(s,i,a,e.spatialReference,l)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),r=n$o(m$9(this.symbolLayer,"material","colorMixMode")),a=new Uint8Array(4);return o$i(t,r,a),a}return null}_createBuffers(e,r){const a=e.vertexAttributes&&e.vertexAttributes.position;if(!a)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const o=e.vertexAttributes.normal,s=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(r$a(o)&&o.length!==a.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(r$a(n)&&n.length/4!=a.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(r$a(s)&&s.length/2!=a.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const i=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,i),c=this._createColorBuffer(e),u=this._createSymbolColorBuffer(r),m=this._createNormalBuffer(e,l,i),p=this._createTangentBuffer(e,l,i);return {positionBuffer:l,normalBuffer:m,tangentBuffer:p,uvBuffer:s,colorBuffer:c,symbolColorBuffer:u,objectTransformation:i.reprojection===ve.NONE&&r$a(i.objectTransformation)?i.objectTransformation:this._transformOriginLocal(e,l,m,p),geometryTransformation:i.reprojection===ve.NONE&&r$a(i.geometryTransformation)?i.geometryTransformation:e$g()}}_computeReprojectionInfo(e){const r=r$a(e.transform),a=r&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===l$e.Local?ve.NONE:ve.ECEF;if(r){if(a===ve.NONE){const t=e$g();qn(e.spatialReference,e.transform.origin,t,this._context.renderCoordsHelper.spatialReference);return {reprojection:a,objectTransformation:t,geometryTransformation:r$l(e.transform.localMatrix),needsBufferCopy:!1}}const t=x$a(e$g(),e.transform.origin);return u$k(t,t,e.transform.localMatrix),{reprojection:a,transformBeforeProject:t,needsBufferCopy:!0}}return {reprojection:a,needsBufferCopy:!0}}_transformOriginLocal(e,r,a,o){const i=this._context.renderCoordsHelper.spatialReference,l=e.anchor;he$1[0]=l.x,he$1[1]=l.y,he$1[2]=l.z;const c=e$g();qn(e.spatialReference,he$1,c,i);const m=T$6.fromTypedArray(r);if(h$g(xe,c),t$g(m,m,xe),r$a(a)||r$a(o)){if(a$g(_e$2,c),o$j(_e$2,_e$2),r$a(a)){const e=i$e.fromTypedArray(a);r$f(e,e,_e$2);}if(r$a(o)){const e=i$e.fromTypedArray(o,4*o.BYTES_PER_ELEMENT);r$f(e,e,_e$2);}}return c}_validateFaces(e,t){const r=e.vertexAttributes.position.length/3,a=t.faces;if(a){let e=-1;for(let t=0;t<a.length;t++){const r=a[t];r>e&&(e=r);}if(r<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return !0}_getOrCreateFaces(e,t){return t.faces?t.faces:l$n(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return !1;const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return !1;const a=this._context.elevationProvider.spatialReference;let o;const s=r.length/3;return r$a(a)&&!e.spatialReference.equals(a)?(o=new Float64Array(r.length),Un(e.vertexAttributes.position,e.spatialReference,0,o,a,0,s)):o=r,B$5(ye$2),M$7(ye$2,o,0,s),!R$7(ye$2,this._context.clippingExtent)}_createGeometryInfo(e,a){if(!An(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const o=this._createBuffers(e,a);if(t$9(o))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:i,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:u,objectTransformation:m,geometryTransformation:h}=o,p=this._getOrCreateComponents(e),f=[],d=[],g=[];let x=!1;for(const r of p){if(!this._validateFaces(e,r))return null;const a=this._getOrCreateFaces(e,r);if(0===a.length)continue;const o=this._createComponentNormals(s,c,r,a);o.didFlipNormals&&(x=!0);const m=[[O$7.POSITION,{size:3,data:s,exclusive:!0}],[O$7.NORMAL,{size:3,data:o.normals,exclusive:!0}]],p=[[O$7.POSITION,a],[O$7.NORMAL,o.indices]];r$a(i)&&(m.push([O$7.COLOR,{size:4,data:i,exclusive:!0}]),p.push([O$7.COLOR,a])),r$a(l)&&(m.push([O$7.SYMBOLCOLOR,{size:4,data:l,exclusive:!0}]),p.push([O$7.SYMBOLCOLOR,new Uint16Array(a.length)])),r$a(n)&&(m.push([O$7.UV0,{size:2,data:n,exclusive:!0}]),p.push([O$7.UV0,a])),r$a(u)&&(m.push([O$7.TANGENT,{size:4,data:u,exclusive:!0}]),p.push([O$7.TANGENT,a]));const _=new g$d(m,p);f.push(_),d.push(h),g.push(this._getOrCreateMaterial(e,r));}return x&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:f,transformations:d,materials:g,objectTransformation:m}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return f$b(this.symbolLayer,e)}}const he$1=n$h(),pe$1=n$h(),fe$2=n$h(),de$1=n$h(),ge$1=n$h(),xe=e$g(),_e$2=e$q(),ye$2=a$c(),be$1=[new g$h];var ve;!function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF";}(ve||(ve={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class f$5{constructor(e,t,i,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=n,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1;}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e);}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this));}alignWithElevation(t,i,n){if(this.elevationAligner){s$a(this.elevationContext.featureExpressionInfoContext,n);const s=this.elevationAligner(this,this.elevationContext,t,i);r$a(s)&&(this.alignedSampledElevation=s);}}getCenterObjectSpace(e=n$h()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,I$3),O$8(e,this._lodRenderer.baseBoundingSphere.center,I$3)}getBoundingBoxObjectSpace(e=a$c()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,I$3);const t=this._lodRenderer.baseBoundingBox;B$5(e);for(let s=0;s<8;++s)o$6(x$4,0==(1&s)?t[0]:t[3],0==(2&s)?t[1]:t[4],0==(4&s)?t[2]:t[5]),O$8(x$4,x$4,I$3),h$i(e,x$4);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,I$3),e.render.origin[0]+=I$3[12],e.render.origin[1]+=I$3[13],e.render.origin[2]+=I$3[14],e.render.num++;}async getProjectedBoundingBox(t,n,s,r,o){const d=this.getBoundingBoxObjectSpace(o),m=v$5,u=S$f(d)?1:m.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,I$3);for(let e=0;e<u;e++){const t=m[e];x$4[0]=d[t[0]],x$4[1]=d[t[1]],x$4[2]=d[t[2]],O$8(x$4,x$4,I$3),p$5[3*e+0]=x$4[0],p$5[3*e+1]=x$4[1],p$5[3*e+2]=x$4[2];}if(!t(p$5,0,u))return null;B$5(d);let f=null;this.calculateRelativeScreenBounds&&(f=this.calculateRelativeScreenBounds());for(let e=0;e<3*u;e+=3){for(let t=0;t<3;t++)d[t]=Math.min(d[t],p$5[e+t]),d[t+3]=Math.max(d[t+3],p$5[e+t]);f&&s.push({location:p$5.slice(e,e+3),screenSpaceBoundingRect:f});}if(n&&(p$9(d,b$6),"absolute-height"!==this.elevationContext.mode)){let t;const i=X$2(d,n.service.spatialReference,n);try{t=await n.service.queryElevation(b$6[0],b$6[1],r,i,"ground");}catch(_){}r$a(t)&&V$5(d,0,0,-this.alignedSampledElevation+t);}return d}addObjectState(e,t){if(e===u$d.Highlight){const i=new r$m(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e);}),i);}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)));}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0);}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0);}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const p$5=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],x$4=n$h(),b$6=n$h(),v$5=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],I$3=e$g();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function t$4(e){const t=[];return e.stageResources.geometries.forEach(((s,n)=>{const o=e.stageResources.materials[n],r=e.stageResources.textures;t.push({material:o,geometry:s,textures:r});})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function s$5(e){return {levels:e.map((e=>t$4(e)))}}function n$5(t,s=r$5){const n=c$5(t);return Math.sqrt(n/(s*Math.PI))}function o$1(e){e.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=n$5(e));}));}const r$5=.05;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var E$5;function F$4(t){let e=T$5().mat4f64(O$7.LOCALTRANSFORM).mat4f64(O$7.GLOBALTRANSFORM).vec4f64(O$7.BOUNDINGSPHERE).vec3f64(O$7.MODELORIGIN).mat3f(O$7.MODEL).mat3f(O$7.MODELNORMAL).vec2f(O$7.MODELSCALEFACTORS);return t.includes("color")&&(e=e.vec4f(O$7.COLOR)),t.includes("featureAttribute")&&(e=e.vec4f(O$7.FEATUREATTRIBUTE)),e=e.u8(O$7.STATE).u8(O$7.LODLEVEL).alignTo(8),e}!function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE";}(E$5||(E$5={}));class O$2{constructor(t){this.localTransform=t.getField(O$7.LOCALTRANSFORM,b$k),this.globalTransform=t.getField(O$7.GLOBALTRANSFORM,b$k),this.modelOrigin=t.getField(O$7.MODELORIGIN,T$6),this.model=t.getField(O$7.MODEL,l$o),this.modelNormal=t.getField(O$7.MODELNORMAL,l$o),this.modelScaleFactors=t.getField(O$7.MODELSCALEFACTORS,u$m),this.boundingSphere=t.getField(O$7.BOUNDINGSPHERE,h$j),this.color=t.getField(O$7.COLOR,c$j),this.featureAttribute=t.getField(O$7.FEATUREATTRIBUTE,c$j),this.state=t.getField(O$7.STATE,d$o),this.lodLevel=t.getField(O$7.LODLEVEL,d$o);}}class S$5 extends n$f{constructor(t,e){super(),this._capacity=0,this._size=0,this._next=0,this._layout=F$4(t),this._shaderTransformation=e;}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,E$5.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const e=this._view.state;e$w(t>=0&&t<this._capacity&&e.get(t)&E$5.ALLOCATED,"invalid instance handle"),this._getStateFlag(t,E$5.ACTIVE)?this._setStateFlags(t,E$5.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t});}freeInstance(t){const e=this._view.state;e$w(t>=0&&t<this._capacity&&e.get(t)&E$5.ALLOCATED,"invalid instance handle"),e.set(t,0),this._size--;}setLocalTransform(t,e,s=!0){this._view.localTransform.setMat(t,e),s&&this.updateModelTransform(t);}getLocalTransform(t,e){this._view.localTransform.getMat(t,e);}setGlobalTransform(t,e,s=!0){this._view.globalTransform.setMat(t,e),s&&this.updateModelTransform(t);}getGlobalTransform(t,e){this._view.globalTransform.getMat(t,e);}updateModelTransform(t){const a=this._view,o=M$3,h=I$2;a.localTransform.getMat(t,b$5),a.globalTransform.getMat(t,w$6);const l=u$k(w$6,w$6,b$5);o$6(o,l[12],l[13],l[14]),a.modelOrigin.setVec(t,o),a$g(h,l),a.model.setMat(t,h);const c=p$e(M$3,l);c.sort(),a.modelScaleFactors.set(t,0,c[1]),a.modelScaleFactors.set(t,1,c[2]),u$l(h,h),o$j(h,h),a.modelNormal.setMat(t,h),this._setStateFlags(t,E$5.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t});}getModelTransform(t,e){const s=this._view;s.model.getMat(t,I$2),s.modelOrigin.getVec(t,M$3),e[0]=I$2[0],e[1]=I$2[1],e[2]=I$2[2],e[3]=0,e[4]=I$2[3],e[5]=I$2[4],e[6]=I$2[5],e[7]=0,e[8]=I$2[6],e[9]=I$2[7],e[10]=I$2[8],e[11]=0,e[12]=M$3[0],e[13]=M$3[1],e[14]=M$3[2],e[15]=1;}applyShaderTransformation(t,e){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e);}getCombinedModelTransform(t,e){return this.getModelTransform(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedLocalTransform(t,e){return this._view.localTransform.getMat(t,e),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,e),e}getCombinedMaxScaleFactor(t){let e=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(M$3,this,t);e*=Math.max(s[0],s[1],s[2]);}return e}getCombinedMedianScaleFactor(t){let e=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const s=this._shaderTransformation.scaleFactor(M$3,this,t);s.sort(),e*=s[1];}return e}getModel(t,e){this._view.model.getMat(t,e);}setFeatureAttribute(t,e){this._view.featureAttribute.setVec(t,e);}getFeatureAttribute(t,e){this._view.featureAttribute.getVec(t,e);}setColor(t,e){this._view.color.setVec(t,e);}getColor(t,e){this._view.color.getVec(t,e);}setVisible(t,e){e!==this.getVisible(t)&&(this._setStateFlag(t,E$5.VISIBLE,e),this.emit("instance-visibility-changed",{index:t}));}getVisible(t){return this._getStateFlag(t,E$5.VISIBLE)}setHighlight(t,e){e!==this.getHighlight(t)&&(this._setStateFlag(t,E$5.HIGHLIGHT,e),this.emit("instance-highlight-changed",{index:t}));}getHighlight(t){return this._getStateFlag(t,E$5.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let e=0;for(let s=0;s<this._capacity;++s){this.getState(s)&t&&++e;}return e}_setStateFlags(t,e){const s=this._view.state;e=s.get(t)|e,s.set(t,e);}_clearStateFlags(t,e){const s=this._view.state;e=s.get(t)&~e,s.set(t,e);}_setStateFlag(t,e,s){s?this._setStateFlags(t,e):this._clearStateFlags(t,e);}_getStateFlag(t,e){return !!(this._view.state.get(t)&e)}_grow(){const t=Math.max(v$4,Math.floor(this._capacity*p$4)),e=this._layout.createBuffer(t);if(this._buffer){const t=new Uint8Array(this._buffer.buffer);new Uint8Array(e.buffer).set(t);}this._capacity=t,this._buffer=e,this._view=new O$2(this._buffer);}_findSlot(){const t=this._view.state;let e=this._next;for(;t.get(e)&E$5.ALLOCATED;)e=(e+1)%this._capacity;return this._next=(e+1)%this._capacity,e}}const v$4=1024,p$4=2,M$3=n$h(),I$2=e$q(),b$5=e$g(),w$6=e$g();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class n$4 extends G$5{constructor(e,r){super((t=>w$c(this._instanceData.view.boundingSphere.getVec(t,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=R$a(),this._tmpMat4=e$g(),this._instanceData=e,this._boundingSphere=r;}addInstance(t){const s=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);O$8(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*l$p(i),s.setVec(t,this._tmpSphere),this.add([t]);}removeInstance(t){this.remove([t]);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class t$3{constructor(t,s){this.thresholdScale=1,this._camera=new J$4,this._worldSpaceRadius=t,this._thresholds=s.map((e=>e));}updateCamera(e){this._camera.copyFrom(e);}selectLevel(e,t){const s=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/s,a=this._thresholds;let h=-1;for(let o=0;o<a.length;++o)r>=a[o]*this.thresholdScale&&(h=o);return h}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class m$2{constructor(s,o){const i=s.renderContext.rctx,{geometry:m,material:u}=o;this._materialRepository=s.materialRep,u.setParameters({instancedDoublePrecision:!0});const f=u.createBufferWriter(),d=f.vertexBufferLayout,p=f.elementCount(m),c=f.allocate(p);f.write({},m,c,0),this.geometry=m,this.material=u,this.glMaterials=new e$x(u,this._materialRepository),this.vertexBufferLayout=d,this.vbo=c$k.createVertex(i,F$8.STATIC_DRAW,c.buffer),this.vao=new f$m(i,E$b,{geometry:o$k(d)},{geometry:this.vbo}),this.vertexCount=p;}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose();}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(r,e,t,a,n,l,m,u){const f=this.geometry.id;this.material.intersect(this.geometry,null,r.transform.transform,r,t,a,((t,a,d,p,c)=>{if(t>=0){if(null!=e&&!e(r.rayBegin,r.rayEnd,t))return;const p={layerUid:l.layerUid,graphicUid:l.graphicUid(n),geometryId:f,triangleNr:d,baseBoundingSphere:m,numLodLevels:u};if((null==r.results.min.drapedLayerOrder||c>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||t<r.results.min.dist)&&r.results.min.set(i$f.LOD,p,t,a,r.transform.transform,c),r.options.store!==t$k.MIN&&(null==r.results.max.drapedLayerOrder||c>=r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||t>r.results.max.dist)&&r.results.max.set(i$f.LOD,p,t,a,r.transform.transform,c),r.options.store===t$k.ALL){const e=U$6(r.results.min.ray);e.set(i$f.LOD,p,t,a,r.transform.transform,c),r.results.all.push(e);}}}));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class h$5{constructor(n,o){this.minScreenSpaceRadius=n,this.components=o;}static async create(n,o,i){const r=await Promise.allSettled(o.components.map((o=>n.schedule((()=>new m$2(n,o)),i)))),s=r.map((n=>"fulfilled"===n.status?n.value:null)).filter((n=>n));if(p$f(i)||s.length!==r.length){s.forEach((n=>n.destroy())),f$d(i);for(const n of r)if("rejected"===n.status)throw n.reason}return new h$5(o.minScreenSpaceRadius,s)}destroy(){this.components.forEach((n=>n.destroy()));}intersect(n,o,t,e,i,r,s){this.components.forEach((c=>c.intersect(n,o,t,e,i,r,this.boundingSphere,s)));}get boundingBox(){if(t$9(this._boundingBox)){const n=B$5();this.components.forEach((t=>{r$a(t.boundingInfo)&&(h$i(n,t.boundingInfo.bbMin),h$i(n,t.boundingInfo.bbMax));})),this._boundingBox=n;}return this._boundingBox}get boundingSphere(){if(t$9(this._boundingSphere)){const n=this.boundingBox,o=n$h();p$9(n,o),this._boundingSphere={center:o,radius:.5*g$i(n)};}return this._boundingSphere}get triangleCount(){return this.components.reduce(((n,o)=>n+o.triangleCount),0)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class r$4{constructor(r,i,s){this._elementSize=i,this._buffer=c$k.createVertex(r,F$8.STATIC_DRAW),this.resize(s);}destroy(){this._buffer.dispose();}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return {cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,r,i=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,i*this.elementSize).set(s);}transferAll(){this._buffer.setData(this._array);}transferRange(e,t){const r=e*this._elementSize,i=t*this._elementSize;this._buffer.setSubData(this._array,r,r,i);}resize(e){const t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class h$4{constructor(s){this.modelOriginHi=s.getField(O$7.MODELORIGINHI,i$e),this.modelOriginLo=s.getField(O$7.MODELORIGINLO,i$e),this.model=s.getField(O$7.MODEL,l$o),this.modelNormal=s.getField(O$7.MODELNORMAL,l$o),this.color=s.getField(O$7.INSTANCECOLOR,c$j),this.featureAttribute=s.getField(O$7.INSTANCEFEATUREATTRIBUTE,c$j);}}class n$3{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1;}destroy(){this._buffer&&this._buffer.destroy();}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null;}startUpdateCylce(){this._captureFirstIndex=!0;}beginUpdate(){e$w(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex;}endUpdate(){e$w(this._updating,"not updating"),this.size<c$2*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1;}allocateHead(){e$w(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),e$w(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){e$w(this._updating,"not updating"),e$w(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex);}_grow(){const t=Math.max(_$6,Math.floor(this._capacity*d$9));this._resize(t);}_shrink(){const t=Math.max(_$6,Math.floor(this._capacity*f$4));this._resize(t);}_resize(t){if(e$w(this._updating,"not updating"),t===this._capacity)return;const i=new r$4(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const t=this.size,e=this._compactInstances(i);e$w(e===t,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=e,this._prevHeadIndex=0;}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new h$4(this._instanceBufferLayout.createView(this._buffer.array));}_compactInstances(t){const i=this._headIndex,e=this._tailIndex;return e<i?(this._buffer.copyRange(e,i,t),i-e):e>i?(this._buffer.copyRange(e,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-e),i+(this._capacity-e)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity;}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity;}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity));}}const _$6=1024,d$9=2,c$2=.3,f$4=.5;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let U$2=e=>{const t=e.baseBoundingSphere.radius,a=e.levels.map((e=>e.minScreenSpaceRadius));return new t$3(t,a)};class j$5{constructor(e,t,a,s){this.type=i$f.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new J$4,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[E$c.OPAQUE_MATERIAL,E$c.TRANSPARENT_MATERIAL],this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=a,this._instanceBufferLayout=B$8({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=o$k(this._instanceBufferLayout,1),this._instanceData=new S$5(this._optionalFields,s),this._instanceData.on("instance-added",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index);})),this._instanceData.on("instance-visibility-changed",(e=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index);})),this._instanceData.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1;}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e;}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu;})),this._highlightRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu;})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,a)=>{const s=this._defaultRenderInstanceData[a],n=this._highlightRenderInstanceData[a],i=s.size+n.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r});})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,s){this._context=e;const n=e.renderContext.rctx,i=await Promise.allSettled(this._symbol.levels.map((t=>(this._defaultRenderInstanceData.push(new n$3(n,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new n$3(n,this._instanceBufferLayout)),h$5.create(e,t,s))))),r=i.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(p$f(s)||r.length!==i.length){r.forEach((e=>e.destroy())),f$d(s);for(const e of i)if("rejected"===e.status)throw e.reason}this._levels=r,this._levelSelector=U$2(this);}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()));}get needsTransparentPass(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(E$c.TRANSPARENT_MATERIAL,h$e.Color)))))}get needsHighlight(){return this._highlightRenderInstanceData.some((e=>e.size>0))}prepareRender(e){if(t$b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle();}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(e.bindParameters.contentCamera,t),this._needsUpdates&&this._context.requestRender();}render(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return;e.rctx.bindVAO();e.output!==h$e.Highlight&&e.output!==h$e.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData);e.output!==h$e.ShadowExludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData);}intersect(e,t,a,s){if(!this.baseMaterial.isVisible())return;const i=n$h();e$p(i,s,a);const l=n=>{this._instanceData.getCombinedModelTransform(n,N$3),e.transform.set(N$3),O$8(H$2,a,e.transform.inverse),O$8(q$3,s,e.transform.inverse);const i=this._instanceData.getState(n),o=this._instanceData.getLodLevel(n),l=this._levels.length;e$w(i&E$5.ACTIVE,"invalid instance state"),e$w(o>=0&&o<l,"invaid lod level"),this._levels[o].intersect(e,t,H$2,q$3,n,this._metadata,l);};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(l):this._octree.forEachAlongRay(a,i,l);}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree();}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this._needsUpdates&&this._context.requestRender();}get _needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get _octree(){return this._octreeCached||(this._octreeCached=this._buildOctree()),this._octreeCached}_invalidateOctree(){this._octreeCached&&(this._octreeCached.destroy(),this._octreeCached=null);}_buildOctree(){const e=new n$4(this._instanceData,this.baseBoundingSphere),t=this._instanceData,a=t.view?t.view.state:null;for(let s=0;s<this._instanceData.capacity;++s){a.get(s)&E$5.ACTIVE&&e.addInstance(s);}return e}_queryDepthRangeOctree(e){const t=e.eye,a=e.viewForward,s=this._octree.findClosest(a,G$5.DepthOrder.FRONT_TO_BACK,e.frustum),r=this._octree.findClosest(a,G$5.DepthOrder.BACK_TO_FRONT,e.frustum);if(null!=s&&null!=r){this._instanceData.view.boundingSphere.getVec(s,F$3),e$p(F$3,F$3,t);const o=P$a(F$3,a)-F$3[3];this._instanceData.view.boundingSphere.getVec(r,F$3),e$p(F$3,F$3,t);const l=P$a(F$3,a)+F$3[3];return {near:Math.max(e.near,o),far:Math.min(e.far,l)}}return {near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce();})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce();})),this._needsUpdates&&this._context.requestRender();}_updateInstances(e,t){const a=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate();})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate();}));const n=this._instanceData,i=this._instanceData.view,r=n.size,o=n.capacity;let l=this._instanceIndex;t=Math.min(r,t);for(let c=0;c<t;++c){0===l&&this._startUpdateCycle();const e=i.state.get(l);let r=0;if(!(e&E$5.ALLOCATED)){l=(l+1)%o,t++;continue}const c=i.lodLevel.get(l);if(e&E$5.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[c].freeTail(),e&E$5.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[c].freeTail(),e&E$5.REMOVE)n.freeInstance(l);else if(e&E$5.VISIBLE){let t=0;a&&(i.modelOrigin.getVec(l,w$5),t=s.selectLevel(w$5,n.getCombinedMedianScaleFactor(l))),r=e&~(E$5.ACTIVE|E$5.TRANSFORM_CHANGED),t>=0&&(e&E$5.HIGHLIGHT?(M$2(this._highlightRenderInstanceData[t],i,l),r|=E$5.HIGHLIGHT_ACTIVE):(M$2(this._defaultRenderInstanceData[t],i,l),r|=E$5.DEFAULT_ACTIVE)),i.state.set(l,r),i.lodLevel.set(l,t);}else r=e&~(E$5.ACTIVE|E$5.TRANSFORM_CHANGED),i.state.set(l,r);if(this._octreeCached){const t=!!(e&E$5.ACTIVE),a=!!(r&E$5.ACTIVE);!t&&a?this._octreeCached.addInstance(l):t&&!a?this._octreeCached.removeInstance(l):t&&a&&e&E$5.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l));}l=(l+1)%o;}this._instanceIndex=l,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate();})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate();}));}_renderComponents(e,t){this.levels.forEach(((a,s)=>{a.components.forEach((a=>{this._renderComponent(e,t[s],a,s);}));}));}_renderComponent(t,a,s,n){if(0===a.size)return;const{bindParameters:i,rctx:r,output:o}=t,l=s.glMaterials.load(r,i.slot,o);if(t$9(l))return;const c=l.beginSlot(i),d=r.bindTechnique(c,s.material.parameters,i);r.bindVAO(s.vao),c.ensureAttributeLocations(s.vao),d.bindDraw(P$4,i,s.material.parameters),t$b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===h$e.Color&&(d.setUniform4fv("externalColor",B$2[Math.min(n,B$2.length-1)]),d.setUniform1i("colorMixMode",U$7.replace));const _=r.capabilities.instancing,f=a.capacity,p=a.headIndex,g=a.tailIndex,I=a.firstIndex,D=this._glInstanceBufferLayout,v=(e,t)=>{R$b(r,E$b,a.buffer,D,e),_.drawArraysInstanced(c.primitiveType,0,s.vertexCount,t-e),E$h(r,E$b,a.buffer,D);};s.material.parameters.transparent&&null!=I?p>g?(e$w(I>=g&&I<=p,"invalid firstIndex"),v(I,p),v(g,I)):p<g&&(I<=p?(e$w(I>=0&&I<=p,"invalid firstIndex"),v(I,p),v(g,f),v(0,I)):(e$w(I>=g&&I<=f,"invalid firstIndex"),v(I,f),v(0,p),v(g,I))):p>g?v(g,p):p<g&&(v(0,p),v(g,f)),r.bindVAO(null);}}function M$2(e,t,a){const s=e.allocateHead();V$2(t,a,e.view,s);}function V$2(e,t,a,s){p$g(e.modelOrigin,t,a.modelOriginHi,a.modelOriginLo,s),a.model.copyFrom(s,e.model,t),a.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&a.color&&a.color.copyFrom(s,e.color,t),e.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(s,e.featureAttribute,t);}const w$5=n$h(),F$3=n$m(),N$3=e$g(),H$2=n$h(),q$3=n$h(),B$2=[r$c(1,0,1,1),r$c(0,0,1,1),r$c(0,1,0,1),r$c(1,1,0,1),r$c(1,0,0,1)],P$4=new k$9;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class me$1 extends y$7{constructor(e,t,s,r){super(e,t,s,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=s.physicalBasedRenderingEnabled;}getCachedSize(){const[e,s,r]=r$a(this._resources)?this._resources.symbolSize:[1,1,1];return {width:e,depth:s,height:r}}async doLoad(e){if(!this._drivenProperties.size){if(S$g(this.symbolLayer))throw new Error}const t=this.symbolLayer;if(this._isPrimitive){const s=t.resource?t.resource.primitive:d$h;this._resources=await this._createResourcesForPrimitive(s,e);}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity();}get extentPadding(){return r$a(this._resources)?this._resources.extentPadding:0}get _isPrimitive(){return !(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return m$9(this._resources,"lodRenderer")}_setMaterialTransparencyParams(e,t=m$9(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),a=r<1||this.needsDrivenTransparentPass;return e.transparent=a,e.opacity=r,e.cullFace=a?n$l.None:n$l.Back,e}async _createResourcesForPrimitive(s,a){if(!n$9(s))throw new Error(`Unknown object symbol primitive: ${s}`);const i=this.symbolLayer,n=a$c(c$l(s)),c=e$o(F$9(n)),l=e$o(t$l(c,i)),h=s$i(l),d=!1,m=!1,u={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:l$c,diffuse:l$c,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},y=u.usePBR;this._setMaterialTransparencyParams(u);const f=this.symbol;if("point-3d"===f.type&&f.verticalOffset){const{screenLength:e,minWorldLength:s,maxWorldLength:r}=f.verticalOffset;u.verticalOffset={screenLength:u$e(e),minWorldLength:s||0,maxWorldLength:r$a(r)?r:1/0},u.castShadows=!1;}if(this._context.screenSizePerspectiveEnabled&&(u.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)u.externalColor=_$e;else {const s=r$a(i.material)&&i.material.color,r=r$a(s)?l$b.toUnitRGBA(s):_$e;u.externalColor=r;}this._fastUpdates=P$5(this._context.renderer,this._fastVisualVariableConvertOptions(n,l,c,n$p)),u.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(u,this._fastUpdates.materialParameters),u.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(u.instanced.push("color"),this._optionalFields.push("color"));const _=new R$6(u),P=t$8(s,_);if(!P)throw new Error(`Unknown object symbol primitive: ${s}`);const R=r$8(P).map((e=>({opacity:1,transparent:e.parameters.transparent}))),v=await this._createStageResources(P,y);return {lodResources:P,lodRenderer:await this._createLodRenderer(P,a),stageResources:v,symbolSize:l,extentPadding:h,isEsriSymbolResource:d,isWosr:m,originalMaterialParameters:R,physicalBasedRenderingEnabled:y,resourceBoundingBox:n,resourceSize:c,pivotOffset:n$p}}async _createResourcesForUrl(e,a){const i=["transformation"],n={materialParamsMixin:{instanced:i,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=P$5(this._context.renderer,this._fastVisualVariableConvertOptions(n$p,n$p,n$p,n$p)),this._fastUpdates.enabled?(Object.assign(n.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const c=this.symbol;if("point-3d"===c.type&&c.verticalOffset){const{screenLength:e,minWorldLength:s,maxWorldLength:r}=c.verticalOffset;n.materialParamsMixin.verticalOffset={screenLength:u$e(e),minWorldLength:s||0,maxWorldLength:r$a(r)?r:1/0},n.materialParamsMixin.castShadows=!1;}n.signal=a,n.usePBR=this._context.physicalBasedRenderingEnabled;const l=n.usePBR,h=await J$5(e,n),d=h.isEsriSymbolResource,m=h.isWosr;this._addDisposeResource((()=>h.remove()));const u=s$5(h.lods);o$1(u),u.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),u.levels[0].minScreenSpaceRadius=Math.min(2,u.levels[0].minScreenSpaceRadius);const y=this._context,f=this.symbolLayer.material,_=this._getExternalColorParameters(f),g=m$9(this.symbolLayer,"material","color"),P=this._getCombinedOpacity(g,{hasIntrinsicColor:!0}),R=this.needsDrivenTransparentPass,v=r$8(u),x=r$8(u).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));v.forEach((e=>{const t=e.parameters;e.setParameters(_);const s=t.opacity*P,r=s<1||R||t.transparent;e.setParameters({opacity:s,transparent:r}),y.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:y.sharedResources.screenSizePerspectiveSettings});}));const S=h.referenceBoundingBox,L=e$o(F$9(S)),C=e$o(u.levels[0].pivotOffset),w=e$o(t$l(L,this.symbolLayer)),U=s$i(w);R$4(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(S,w,L,C))&&v.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const j=await this._createStageResources(u,l);return {lodResources:u,lodRenderer:await this._createLodRenderer(u,a),stageResources:j,symbolSize:w,extentPadding:U,isEsriSymbolResource:d,isWosr:m,originalMaterialParameters:x,physicalBasedRenderingEnabled:l,resourceBoundingBox:S,resourceSize:L,pivotOffset:C}}_addDisposeResource(e){this._disposeResourceHandles.push(e);}async _createStageResources(e,t){const s=this._context.stage,r=r$8(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(r),this._addDisposeResource((()=>s.removeMany(r)));const a=e$9(e);s.addMany(a),this._addDisposeResource((()=>s.removeMany(a))),await s.load(a);const i=t$6(e);return s.addMany(i),this._addDisposeResource((()=>s.removeMany(i))),{materials:r,textures:a,geometries:i}}async _createLodRenderer(e,t){const s=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},a=this._fastUpdates.enabled?{applyTransform:(e,t,s)=>{e.getFeatureAttribute(t,_e$1),n$g(s,B$3(this._fastUpdates.materialParameters,_e$1,s));},scaleFactor:(e,t,s)=>(t.getFeatureAttribute(s,_e$1),L$3(e,this._fastUpdates.materialParameters,_e$1))}:null,i=new j$5(e,this._optionalFields,r,a);return i.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource((()=>{s.removeRenderPlugin(i);})),await s.addRenderPlugin(i.slots,i,t),i}_getExternalColorParameters(s){const r={};return this._drivenProperties.color?r.externalColor=_$e:r$a(s)&&r$a(s.color)?r.externalColor=l$b.toUnitRGBA(s.color):(r.externalColor=_$e,r.colorMixMode="ignore"),r}destroy(){super.destroy(),this._cleanupResources();}_cleanupResources(){this._disposeResourceHandles.forEach((e=>e())),this._disposeResourceHandles.length=0,this._resources=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const s=d$n(t.geometry);if(t$9(s))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new h$d),i=e.renderingInfo;return this._createAs3DShape(t,s,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex);}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(t$9(this._resources))return !0;const e=this._drivenProperties.opacity,t=!this._isPrimitive,r=this._resources.stageResources.materials,i=this._resources.originalMaterialParameters;for(let a=0;a<r.length;a++){const o=r[a],n=m$9(this.symbolLayer,"material","color"),c=i[a],l=this._getCombinedOpacity(n,{hasIntrinsicColor:t})*c.opacity,h=l<1||e||c.transparent;o.setParameters({opacity:l,transparent:h}),this._isPrimitive&&o.setParameters({cullFace:h?n$l.None:n$l.Back});}return !0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v$c)}slicePlaneEnabledChanged(){if(t$9(this._resources))return !0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return !0}physicalBasedRenderingChanged(){if(t$9(this._resources))return !0;const{stageResources:e,isWosr:t}=this._resources;for(const s of e.materials)this._isPrimitive?s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||s.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return !1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return !0}applyRendererDiff(e,t){if(t$9(this._resources))return e$c.Recreate_Symbol;const{stageResources:{materials:s},lodRenderer:r,resourceBoundingBox:i,symbolSize:o,resourceSize:n,pivotOffset:c}=this._resources;for(const a in e.diff){if("visualVariables"!==a)return e$c.Recreate_Symbol;if(!R$4(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,o,n,c)))return e$c.Recreate_Symbol;for(const e of s)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged();}return e$c.Fast_Update}computeComplexity(){if(t$9(this._resources))return super.computeComplexity();return {primitivesPerFeature:n$8(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get(O$7.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:l$8(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return r$a(this._resources)}_createAs3DShape(e,s,r,i,o){if(!this._hasLodRenderer()||t$9(this._resources))return null;const n=this.getFastUpdateAttrValues(e),c=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?B$6(r.color,r.opacity):null,l=this._context.clippingExtent;if(Hn(s,ue$1,this._context.elevationProvider.spatialReference),r$a(l)&&!E$f(l,ue$1))return null;const h=this._requiresTerrainElevation(i),d=this._computeGlobalTransform(s,i,fe$1,be),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,ye$1),m=this._resources.lodRenderer.instanceData,u=m.addInstance();this._instanceIndexToGraphicUid.set(u,o),m.setLocalTransform(u,p,!1),m.setGlobalTransform(u,d),n&&m.setFeatureAttribute(u,n),c&&m.setColor(u,c);const y=new f$5(this,u,I$6,i);return h&&(y.alignedSampledElevation=be.sampledElevation),y.needsElevationUpdates=v$c(i.mode),g$e(y,s,this._context.elevationProvider),y}_computeGlobalTransform(e,t,s,r){return d$g(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),ue$1[0]=e.x,ue$1[1]=e.y,ue$1[2]=r.z,qn(e.spatialReference,ue$1,s,this._context.renderCoordsHelper.spatialReference),s}_computeLocalTransform(e,t,s,r){return r$h(r),this._applyObjectRotation(s,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,s,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=I$9(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===a[0]&&1===a[1]&&1===a[2]||i$b(s,s,a);}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t);}updateGeometry(e,t){if(t$9(this._resources))return !0;const s=t&&d$n(t);if(t$9(s))return !1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(s,e.elevationContext,fe$1,be),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=be.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,fe$1,!0),g$e(e,s,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(t$9(this._resources))return;const s=(e,t,s)=>c$a(null!=e&&"complete"===e.type?e.newValue:t,s),r=s(t.heading,this.symbolLayer.heading,0),o=s(t.tilt,this.symbolLayer.tilt,0),n=s(t.roll,this.symbolLayer.roll,0),c=s(t.width,this.symbolLayer.width,void 0),l=s(t.height,this.symbolLayer.height,void 0),h=s(t.depth,this.symbolLayer.depth,void 0),d=s(t.anchor,this.symbolLayer.anchor,void 0),p=s(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const m={heading:r,tilt:o,roll:n,anchor:d,anchorPosition:p},u=this._resources;this.loadStatus===e$b.LOADED&&e.symbolLayerStatePatches.push((()=>{u.symbolSize=e$o(t$l(u.resourceSize,{width:c,height:l,depth:h,isPrimitive:this.symbolLayer.isPrimitive}));})),e.graphics3DGraphicPatches.push(((e,t)=>{const s=this._computeLocalTransform(u,m,t,ye$1),r=e.instanceIndex;u.lodRenderer.instanceData.setLocalTransform(r,s,!0);}));}_preparePatchColor(s,r){if(!r.material||"partial"!==r.material.type)return;const i=r.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const o=i.color.newValue,n=r$a(o)?l$b.toUnitRGBA(o):_$e;delete i.color;const c=this._resources;t$9(c)||s.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(c.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this._setMaterialTransparencyParams({},o)):t=this._setMaterialTransparencyParams({externalColor:n},o);for(const s of c.stageResources.materials)s.setParameters(t);}));}_requiresTerrainElevation(e){return "absolute-height"!==e.mode}_applyObjectRotation(e,t,s){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return G$6(e.heading,e.tilt,e.roll,s)}_computeAnchor(e,s,r){const a=n$h();switch(r.anchor){case"center":r$b(a,p$9(e)),j$c(a,a);break;case"top":{const t=p$9(e);o$6(a,-t[0],-t[1],-e[5]);break}case"bottom":{const t=p$9(e);o$6(a,-t[0],-t[1],-e[2]);break}case"relative":{const t=p$9(e),s=F$9(e),i=r.anchorPosition,o=i?r$i(i.x,i.y,i.z):f$k;c$m(a,s,o),u$c(a,a,t),j$c(a,a);break}default:r$a(s)?j$c(a,s):r$b(a,f$k);}return a}_applyAnchor(e,t,s){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&c$f(s,s,r);}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,s,r,a){const i=r$a(e)?e$o(F$9(e)):l$c,o=r$a(e)?this._computeAnchor(e,a,this.symbolLayer):f$k,n=this._context.renderCoordsHelper.unitInMeters,c=I$9(r$a(s)?s:void 0,s,r,n),l=r$i(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return {modelSize:i,symbolSize:r$a(s)?s:l$c,unitInMeters:n,transformation:{anchor:o,scale:c,rotation:l}}}}const ue$1=n$h(),ye$1=e$g(),fe$1=e$g(),_e$1=n$m(),be=new j$8;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function n$2(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}function a$2(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function r$3(t,n,a,r,s){return t[0]=n,t[1]=a,t[2]=r,t[3]=s,t}function s$4(t,n){if(t===n){const a=n[1];t[1]=n[2],t[2]=a;}else t[0]=n[0],t[1]=n[2],t[2]=n[1],t[3]=n[3];return t}function u$4(t,n){const a=n[0],r=n[1],s=n[2],u=n[3];let o=a*u-s*r;return o?(o=1/o,t[0]=u*o,t[1]=-r*o,t[2]=-s*o,t[3]=a*o,t):null}function o(t,n){const a=n[0];return t[0]=n[3],t[1]=-n[1],t[2]=-n[2],t[3]=a,t}function e$6(t){return t[0]*t[3]-t[2]*t[1]}function c$1(t,n,a){const r=n[0],s=n[1],u=n[2],o=n[3],e=a[0],c=a[1],i=a[2],f=a[3];return t[0]=r*e+u*c,t[1]=s*e+o*c,t[2]=r*i+u*f,t[3]=s*i+o*f,t}function i$2(t,n,a){const r=n[0],s=n[1],u=n[2],o=n[3],e=Math.sin(a),c=Math.cos(a);return t[0]=r*c+u*e,t[1]=s*c+o*e,t[2]=r*-e+u*c,t[3]=s*-e+o*c,t}function f$3(t,n,a){const r=n[0],s=n[1],u=n[2],o=n[3],e=a[0],c=a[1];return t[0]=r*e,t[1]=s*e,t[2]=u*c,t[3]=o*c,t}function l$4(t,n){const a=Math.sin(n),r=Math.cos(n);return t[0]=r,t[1]=a,t[2]=-a,t[3]=r,t}function h$3(t,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=n[1],t}function M$1(t){return "mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function b$4(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function m$1(t,n,a,r){return t[2]=r[2]/r[0],a[0]=r[0],a[1]=r[1],a[3]=r[3]-t[2]*a[1],[t,n,a]}function d$8(t,n,a){return t[0]=n[0]+a[0],t[1]=n[1]+a[1],t[2]=n[2]+a[2],t[3]=n[3]+a[3],t}function p$3(t,n,a){return t[0]=n[0]-a[0],t[1]=n[1]-a[1],t[2]=n[2]-a[2],t[3]=n[3]-a[3],t}function y$5(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]}function x$3(n,a){const r=n[0],s=n[1],u=n[2],o=n[3],e=a[0],c=a[1],i=a[2],f=a[3],l=a$l();return Math.abs(r-e)<=l*Math.max(1,Math.abs(r),Math.abs(e))&&Math.abs(s-c)<=l*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(u-i)<=l*Math.max(1,Math.abs(u),Math.abs(i))&&Math.abs(o-f)<=l*Math.max(1,Math.abs(o),Math.abs(f))}function g$3(t,n,a){return t[0]=n[0]*a,t[1]=n[1]*a,t[2]=n[2]*a,t[3]=n[3]*a,t}function j$4(t,n,a,r){return t[0]=n[0]+a[0]*r,t[1]=n[1]+a[1]*r,t[2]=n[2]+a[2]*r,t[3]=n[3]+a[3]*r,t}const S$4=c$1,q$2=p$3;Object.freeze(Object.defineProperty({__proto__:null,copy:n$2,identity:a$2,set:r$3,transpose:s$4,invert:u$4,adjoint:o,determinant:e$6,multiply:c$1,rotate:i$2,scale:f$3,fromRotation:l$4,fromScaling:h$3,str:M$1,frob:b$4,LDU:m$1,add:d$8,subtract:p$3,exactEquals:y$5,equals:x$3,multiplyScalar:g$3,multiplyScalarAndAdd:j$4,mul:S$4,sub:q$2},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e$5 extends g$d{constructor(t,e,r,i,n,s){super(t,e),this.path=r,this.geometrySR=i,this.upVectorAlignment=n,this.stencilWidth=s;}}function r$2(t){return "upVectorAlignment"in t}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function e$4(){return [1,0,0,1]}function r$1(e){return [e[0],e[1],e[2],e[3]]}function t$2(e,r,t,n){return [e,r,t,n]}function n$1(e,r){return new Float64Array(e,r,4)}Object.freeze(Object.defineProperty({__proto__:null,create:e$4,clone:r$1,fromValues:t$2,createView:n$1},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function k$5(){return {up:n$h(),right:n$h()}}function E$4(t,e,i){O$8(t.up,e.up,i),O$8(t.right,e.right,i);}function w$4(t,e,i){r$d(t,P$a(i,e.right),P$a(i,e.up));}class G$2{constructor(){this.pos=n$h(),this.posES=n$h(),this.posGS=n$h(),this.vRight=n$h(),this.vLeft=n$h(),this.frame=k$5(),this.rotationFrame=k$5(),this.rotationRight=n$k(),this.rotationAngle=0,this.miterStretch=e$4();}setFrameFromUpVector(t){r$b(this.frame.up,t),u$c(at,this.vLeft,this.vRight),z$5(at,at),g$f(nt,this.frame.up,P$a(at,this.frame.up)),e$p(pt,at,nt),z$5(pt,pt),_$d(this.frame.right,pt,this.frame.up);}computeRotationAxisAndAngleFromUpVector(){r$b(this.rotationFrame.up,this.frame.up),r$b(this.rotationFrame.right,this.frame.right),r$d(this.rotationRight,1,0),g$f(nt,this.frame.up,P$a(this.frame.up,this.vLeft)),e$p(nt,this.vLeft,nt),j$c(nt,nt),z$5(nt,nt),g$f(at,this.frame.up,P$a(this.frame.up,this.vRight)),e$p(at,this.vRight,at),z$5(at,at),_$d(lt,this.rotationFrame.up,this.vLeft);const s=Math.sign(P$a(lt,this.vRight));if(this.rotationAngle=s*(Math.PI-l$q(P$a(nt,at))),Math.abs(this.rotationAngle)>0){const t=N$5(Math.cos(.5*this.rotationAngle));r$3(this.miterStretch,t-1+1,0,0,1);}const r=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*r));}}class j$3{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null;}addVertex(t,e){return this.vertices.push(t$m(t)),this.vertexNormals.push(t$m(e)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,e=null){return this.poles.push({position:t$m(t),normal:e?t$m(e):null}),this.poles.length-1}addSegment(t,e=null,i=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),e&&(this.uvIndices.push(e.v0),this.uvIndices.push(e.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1));}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(t,e){for(const i of this.vertices)i[0]+=t,i[1]+=e;for(const i of this.poles)i.position[0]+=t,i.position[1]+=e;}static circle(t=20){const e=.5,i=new j$3,s={v0:0,v1:0};i.addPole(r$g(0,0));for(let h=0;h<t;++h){const s=2*h*Math.PI/t,r=Math.cos(s),o=Math.sin(s),n=r$g(r*e,o*e),a=r$g(r,o);i.addVertex(n,a),i.addUV(h/t);}i.addUV(1);for(let h=0;h<t-1;++h){const t={v0:h,v1:h+1},e=t;i.addSegment(t,e,s);}const r={v0:t-1,v1:0},o={v0:t-1,v1:t};return i.addSegment(r,o,s),i}static rect(){const t=1,e=1,i=new j$3,s=r$g(.5*-t,.5*-e),r=r$g(.5*t,.5*-e),o=r$g(.5*t,.5*e),h=r$g(.5*-t,.5*e),n=r$g(0,-1),a=r$g(1,0),l=r$g(0,1),u=r$g(-1,0);i.addUV(0),i.addUV(1),i.addPole(r$g(0,.5*e),l),i.addPole(r$g(0,.5*e)),i.addPole(r$g(0,.5*-e)),i.addPole(r$g(0,.5*-e),n);const p={v0:0,v1:1};return i.addVertex(s,n),i.addVertex(r,n),i.addSegment({v0:0,v1:1},p,{v0:3,v1:3}),i.addVertex(r,a),i.addVertex(o,a),i.addSegment({v0:2,v1:3},p,{v0:2,v1:1}),i.addVertex(o,l),i.addVertex(h,l),i.addSegment({v0:4,v1:5},p,{v0:0,v1:0}),i.addVertex(h,u),i.addVertex(s,u),i.addSegment({v0:6,v1:7},p,{v0:1,v1:2}),i}}class z$3{constructor(t){this.vertices=[],this.offset=n$h(),this.xform=e$g(),this.vertices=t;const e=Math.floor((t.length-1)/2);r$b(this.offset,this.vertices[e].pos);for(const i of this.vertices)e$p(i.pos,i.pos,this.offset);c$f(this.xform,this.xform,this.offset),this.updatePathVertexInformation();}updatePathVertexInformation(){const t=this.vertices.length;let e=this.vertices[0];e.index=0,o$6(e.vLeft,0,0,0),e.vLeftLength=0,e$p(e.vRight,this.vertices[1].pos,e.pos),e.vRightLength=s$i(e.vRight),z$5(e.vRight,e.vRight);let i=e;for(let s=1;s<t;++s)e=this.vertices[s],e.index=s,r$b(e.vLeft,i.vRight),e.vLeftLength=i.vRightLength,s<t-1?(e$p(e.vRight,this.vertices[s+1].pos,e.pos),e.vRightLength=s$i(e.vRight),z$5(e.vRight,e.vRight)):(r$b(e.vRight,e.vLeft),e.vRightLength=e.vLeftLength),i=e;}}function J(t,e){let i=null;const s=t.vertices.length,r=.99619469809,o=n$h(),h=n$h(),n=n$h(),a=n$h(),l=n$h(),u=n$h(),p=p$h();let f=t.vertices[0];r$b(h,e),o$6(o,0,1,0),T$4.makeOrthoBasisDirUpFallback(f.vRight,h,o,o,n,h,r),r$b(f.frame.up,h),r$b(f.frame.right,n),i=f;for(let c=1;c<s;++c){f=t.vertices[c],u$c(l,f.vLeft,f.vRight);let e=s$i(l);e>0?(e=1/Math.sqrt(e),l[0]=l[0]*e,l[1]=l[1]*e,l[2]=l[2]*e):(l[0]=f.vRight[0],l[1]=f.vRight[1],l[2]=f.vRight[2]),u$c(u,i.pos,i.frame.up),_$f(f.pos,l,p);q$8(p,j$d(u,f.vLeft),a)?(e$p(a,a,f.pos),z$5(h,a),_$d(n,l,h),z$5(n,n)):T$4.makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,o,n,h,r),r$b(f.frame.up,h),r$b(f.frame.right,n),i=f;}}class X{numProfilesPerJoin(){return 1}extrude(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],!1);}}class q$1{constructor(t=.8*Math.PI,e=1){this.cutoffAngle=t,this.numBendSubdivisions=e;}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,e,i){const s=ft;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let r=0;r<this.numBendSubdivisions+1;++r){g$j(ct,.5*-t.rotationAngle+r*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),E$4(s,t.frame,ct);for(let r=0;r<e.vertices.length;++r){j$e(e.vertices[r],t.rotationRight)*t.rotationAngle>=0?i(t.index,s,e.vertices[r],e.vertexNormals[r],!1):(_$g(rt,e.vertices[r],t.miterStretch),i(t.index,t.frame,rt,e.vertexNormals[r],!0));}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let s=0;s<e.vertices.length;++s){const r=j$e(e.vertices[s],t.rotationRight)*t.rotationAngle>=0;_$g(rt,e.vertices[s],t.miterStretch),i(t.index,t.frame,rt,e.vertexNormals[s],!r);}}}const K={generateUV:!1};class Q{rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],0,0);}}class W$2 extends Q{constructor(){super();}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class Y$3 extends Q{constructor(t,e=0,i=!1){super(),this.profile=t,this.profilePlaneOffset=e,this.flip=i;}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,e,i){for(let s=0;s<e.vertices.length;++s)i(t.index,t.frame,e.vertices[s],e.vertexNormals[s],this.profilePlaneOffset,0);}rebuildCapGeometry(t,e){const i=ot;r$d(i,0,0);const s=this.flip?1:-1;for(let r=0;r<this.profile.vertices.length;++r)e(t.index,t.frame,this.profile.vertices[r],i,this.profilePlaneOffset,s);}buildTopology(t,e){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const t=this.profile.vertexIndices[2*s+0],r=this.profile.vertexIndices[2*s+1],o=this.vertexBufferStart+t,h=this.vertexBufferStart+r;this.flip?e(h,o,i):e(i,o,h);}}}class Z extends Q{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions;}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let e=0;e<this.profile.numSegments;++e){const i=this.profile.vertexIndices[2*e+0],s=this.profile.vertexIndices[2*e+1];this.profile.poleIndices[i]===this.profile.poleIndices[s]?t+=1:t+=2;}return 3*t}rebuildCapGeometry(t,e){const i=t.frame,s=.5*this.sign,r=rt,o=ot;r$d(o,0,0);for(let h=0;h<this.profile.poles.length;++h){const r=this.profile.poles[h];r.normal?e(t.index,i,r.position,r.normal,s,0):e(t.index,i,r.position,o,s,this.sign);}if(this.breakNormals)for(let h=0;h<this.profile.vertices.length;++h)e(t.index,i,this.profile.vertices[h],this.profile.vertexNormals[h],0,0);for(let h=0;h<this.numSegments-1;++h){const n=(1-(h+1)/this.numSegments)*Math.PI*.5,a=Math.sin(n),l=Math.cos(n);for(let h=0;h<this.profile.vertices.length;++h){const n=this.profile.poles[this.profile.poleIndices[h]];o$l(r,this.profile.vertices[h],n.position),l$h(r,r,a),n.normal?(s$j(r,r,n.position),e(t.index,i,r,n.normal,s*l,0)):(v$h(o,r),l$h(o,o,a),s$j(r,r,n.position),e(t.index,i,r,o,s*l,this.sign*l));}}}buildTopology(t,e){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let r=0;r<this.profile.numSegments;++r){const t=this.profile.vertexIndices[2*r+0],o=this.profile.vertexIndices[2*r+1],h=this.vertexBufferStart+this.profile.poleIndices[t],n=this.vertexBufferStart+this.profile.poleIndices[o];let a=i+t,l=i+o;for(let i=0;i<this.numSegments-1;++i){const r=s+i*this.profile.vertices.length+t,h=s+i*this.profile.vertices.length+o;this.flip?(e(r,l,a),e(l,r,h)):(e(a,l,r),e(h,r,l)),a=r,l=h;}this.flip?(e(h,l,a),h!==n&&e(h,n,l)):(e(a,l,h),h!==n&&e(l,n,h));}}}class ${constructor(t,e,i,s,r,o=K){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=e,this.path=t,this.extruder=i,this.startCap=s,this.endCap=r;const h=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*h+2,this.numVerticesTotal=e.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const n=this.startCap.getNumVertices();this.numVerticesTotal+=n,this.numNormalsTotal+=n,this.endCap.vertexBufferStart=this.numVerticesTotal;const a=this.endCap.getNumVertices();this.numVerticesTotal+=a,this.numNormalsTotal+=a,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology();}emitVertex(t,e,i,s,r){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,r){const e=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[0]*e.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=e.rotationRight[1]*e.maxStretchDistance;}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount;}emitCapVertex(t,e,i,s,r,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=e.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=e.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=e.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=e.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=e.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=e.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=r,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount;}emitTriangle(t,e,i){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=e,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=e,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount;}_rebuildGeometry(){const t=(t,e,i,s,r)=>this.emitVertex(t,e,i,s,r),e=(t,e,i,s,r,o)=>this.emitCapVertex(t,e,i,s,r,o);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,e);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,e),this.startCap.rebuildCapGeometry(this.path.vertices[0],e),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],e),this.profile.hasUV()&&this.options.generateUV)for(let i=0;i<this.profile.uvs.length;++i)this.uvData[2*i+0]=this.profile.uvs[i],this.uvData[2*i+1]=0;}buildTopology(){const t=(t,e,i)=>this.emitTriangle(t,e,i);this._triangleCount=0;const e=this.profile.vertices.length,i=this.profile.numSegments,s=this.numExtrusionProfiles-1;let r=3*(2*(i*s));this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1),r+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(r),this.normalIndices=new Uint32Array(r),this.pathVertexIndices=new Uint32Array(r),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(r));for(let o=0;o<i;++o){const i=this.profile.vertexIndices[2*o],r=this.profile.vertexIndices[2*o+1];for(let o=0;o<s;++o){const s=o*e+i,h=(o+1)*e+r,n=o*e+r;t(s,(o+1)*e+i,h),t(s,h,n);}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t);}onPathChanged(){this._rebuildGeometry();}}class tt{constructor(t){this.builder=t;}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged();}}class et extends tt{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255;}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1);}bake(t){this.size=t;for(let e=0;e<this.builder.numVerticesTotal;++e){let i=this.builder.pathVertexData[e];const s=0===i||i===this.builder.path.vertices.length-1;i*=3;const r=st;o$6(r,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const o=4*e,h=nt,l=rt,u=at,d=lt,v=ut;let m=0,g=0;if(o$6(d,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),o$6(v,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),r$d(l,this.builder.profileVertexAndNormalData[o]*t[0],this.builder.profileVertexAndNormalData[o+1]*t[1]),s)_$d(u,v,d),m=this.builder.profileRightAxisData[o+3]*t[0],g=this.builder.profileUpAxisData[o+3];else {const t=ot,e=ht;r$d(t,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const i=q$9(t);v$h(t,t);const s=j$e(l,t);if(Math.abs(s)>i){r$d(e,-t[1],t[0]);const r=j$e(l,e);l$h(t,t,i*Math.sign(s)),l$h(e,e,r),s$j(l,t,e);}o$6(u,0,0,0);}o$6(h,d[0]*l[0]+v[0]*l[1],d[1]*l[0]+v[1]*l[1],d[2]*l[0]+v[2]*l[1]),this.vertexAttributePosition[3*e+0]=r[0]+h[0]+u[0]*m,this.vertexAttributePosition[3*e+1]=r[1]+h[1]+u[1]*m,this.vertexAttributePosition[3*e+2]=r[2]+h[2]+u[2]*m;const V=rt;r$d(V,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*e+0]=d[0]*V[0]+v[0]*V[1]+u[0]*g,this.vertexAttributeNormal[3*e+1]=d[1]*V[0]+v[1]*V[1]+u[1]*g,this.vertexAttributeNormal[3*e+2]=d[2]*V[0]+v[2]*V[1]+u[2]*g;}}createGeometryData(){const t=[[O$7.POSITION,this.builder.vertexIndices],[O$7.NORMAL,this.builder.normalIndices]],e=[[O$7.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[O$7.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;t.push([O$7.COLOR,new Uint32Array(i)]),e.push([O$7.COLOR,{size:4,data:this.vertexAttributeColor}]);}return {vertexAttributes:e,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size);}intersect(t,e,i){const s=this.builder.vertexIndices,r={size:3,data:this.vertexAttributePosition},o=s.length/3;v$i(t,e,0,o,s,r,void 0,void 0,i);}}class it extends tt{constructor(t,e,i,s){super(t),this.sizeAttributeValue=e,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new et(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let r=0;r<this.builder.path.vertices.length;++r){this.vvData[4*r+0]=e,this.vvData[4*r+1]=i,this.vvData[4*r+2]=s;const t=0===r||r===this.builder.path.vertices.length-1;this.vvData[4*r+3]=t?1:0;}}createGeometryData(){return {vertexAttributes:[[O$7.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[O$7.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[O$7.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[O$7.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[O$7.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[O$7.POSITION,this.builder.pathVertexIndices],[O$7.PROFILERIGHT,this.builder.vertexIndices],[O$7.PROFILEUP,this.builder.vertexIndices],[O$7.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[O$7.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const st=n$h(),rt=n$k(),ot=n$k(),ht=n$k(),nt=n$h(),at=n$h(),lt=n$h(),ut=n$h(),pt=n$h(),ft=k$5(),ct=e$g();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const f$2=8;function n(e,c){e.attributes.add(O$7.FEATUREVALUE,"vec4");const n=e.vertex;n.code.add(n$j`bool isCapVertex() {
return featureValue.w == 1.0;
}`),n.uniforms.add(new e$k("size",(e=>e.size))),c.vvSize?(n.uniforms.add(new e$y("vvSizeMinSize",(e=>e.vvSizeMinSize))),n.uniforms.add(new e$y("vvSizeMaxSize",(e=>e.vvSizeMaxSize))),n.uniforms.add(new e$y("vvSizeOffset",(e=>e.vvSizeOffset))),n.uniforms.add(new e$y("vvSizeFactor",(e=>e.vvSizeFactor))),n.code.add(n$j`vec2 getSize() {
return size * clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):n.code.add(n$j`vec2 getSize(){
return size;
}`),c.vvOpacity?(n.constants.add("vvOpacityNumber","int",f$2),n.uniforms.add([new o$m("vvOpacityValues",(e=>e.vvOpacityValues),f$2),new o$m("vvOpacityOpacities",(e=>e.vvOpacityOpacities),f$2)]),n.code.add(n$j`vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):n.code.add(n$j`vec4 applyOpacity(vec4 color){
return color;
}`),c.vvColor?(n.constants.add("vvColorNumber","int",o$n),n.uniforms.add([new o$m("vvColorValues",(e=>e.vvColorValues),o$n),new e$z("vvColorColors",(e=>e.vvColorColors),o$n)]),n.code.add(n$j`vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):n.code.add(n$j`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(o$o),e.attributes.add(O$7.PROFILERIGHT,"vec4"),e.attributes.add(O$7.PROFILEUP,"vec4"),e.attributes.add(O$7.PROFILEVERTEXANDNORMAL,"vec4"),n.code.add(n$j`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),n.code.add(n$j`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),n.code.add(n$j`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),n.code.add(n$j`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`);}class p$2 extends v$e{constructor(){super(...arguments),this.size=r$g(1,1);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function L$2(L){const S=new o$7;v$d(S,L);const{vertex:C,fragment:M}=S;switch(S.varyings.add("vpos","vec3"),S.include(n,L),L.output!==h$e.Color&&L.output!==h$e.Alpha||(S.include(r$n,L),S.include(c$n,L),S.include(i$g,L),S.varyings.add("vnormal","vec3"),S.varyings.add("vcolor","vec4"),L.hasMultipassTerrain&&S.varyings.add("depth","float"),C.code.add(n$j`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${L.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${L.output===h$e.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),S.include(n$n,L),L.output){case h$e.Alpha:S.include(u$h,L),M.uniforms.add(new o$8("opacity",(e=>e.opacity))),M.code.add(n$j`
      void main() {
        discardBySlice(vpos);
        ${L.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `);break;case h$e.Color:S.include(u$h,L),S.include(m$e,L),S.include(a$n,L),S.include(c$n,L),S.include(e$A,L),c$o(M,L),M.uniforms.add([C.uniforms.get("localOrigin"),new e$y("ambient",(e=>e.ambient)),new e$y("diffuse",(e=>e.diffuse)),new e$y("specular",(e=>e.specular)),new o$8("opacity",(e=>e.opacity)),new o$8("lightingGlobalFactor",((e,i)=>i.lighting.globalFactor)),new e$y("lightingMainIntensity",((e,i)=>i.lighting.mainLight.intensity))]),M.constants.add("ambientBoostFactor","float",c$p),M.include(e$u),M.code.add(n$j`
        void main() {
          discardBySlice(vpos);
          ${L.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${L.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":L.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          gl_FragColor = vec4(shadedColor, combinedOpacity);
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
          ${L.transparencyPassType===o$f.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
        }
      `);break;case h$e.Depth:case h$e.Shadow:case h$e.ShadowHighlight:case h$e.ShadowExludeHighlight:S.include(r$n,L),C.uniforms.add(new e$k("nearFar",((e,i)=>i.camera.nearFar))),S.varyings.add("depth","float"),C.code.add(n$j`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),S.include(u$h,L),S.include(o$e,L),M.code.add(n$j`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case h$e.Normal:S.include(r$n,L),S.include(r$o,L),C.uniforms.add(new e$t("viewNormal",((e,i)=>i.camera.viewInverseTransposeMatrix))),S.varyings.add("vnormal","vec3"),C.code.add(n$j`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),S.include(u$h,L),M.code.add(n$j`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case h$e.Highlight:S.include(r$n,L),S.include(r$o,L),S.varyings.add("vnormal","vec3"),C.code.add(n$j`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),S.include(u$h,L),S.include(a$m),M.code.add(n$j`void main() {
discardBySlice(vpos);
outputHighlight();
}`);}return S}const S$3=Object.freeze(Object.defineProperty({__proto__:null,build:L$2},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const R$2=new Map([[O$7.POSITION,0],[O$7.PROFILERIGHT,1],[O$7.PROFILEUP,2],[O$7.PROFILEVERTEXANDNORMAL,3],[O$7.FEATUREVALUE,4]]);class C$4 extends p$2{constructor(){super(...arguments),this.ambient=r$i(.2,.2,.2),this.diffuse=r$i(.8,.8,.8),this.specular=r$i(0,0,0),this.opacity=1;}}class E$3 extends e$l{initializeConfiguration(e,o){o.spherical=e.viewingMode===l$e.Global,o.doublePrecisionRequiresObfuscation=i$i(e.rctx);}initializeProgram(e){return new o$9(e.rctx,E$3.shader.get().build(this.configuration),R$2)}initializePipeline(){const e=this.configuration.transparencyPassType,o=this.configuration,t=e===o$f.NONE,i=e===o$f.FrontFace;return W$3({blending:o.output!==h$e.Color&&o.output!==h$e.Alpha||!o.transparent?null:t?c$h:A$9(e),culling:o.hasSlicePlane&&!o.transparent&&!(o.doubleSidedMode===i$h.None)&&o$p,depthTest:{func:l$l(e)},depthWrite:t||i?a$e:null,colorWrite:_$c,stencilWrite:o.hasOccludees?e$v:null,stencilTest:o.hasOccludees?f$l:null,polygonOffset:t||i?null:_$h})}}E$3.shader=new t$d(S$3,(()=>import('./Path.glsl-2b7a7658.js')));class L$1 extends s$c{constructor(){super(...arguments),this.output=h$e.Color,this.doubleSidedMode=i$h.None,this.transparencyPassType=o$f.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1;}}e$e([e$m({count:h$e.COUNT})],L$1.prototype,"output",void 0),e$e([e$m({count:i$h.COUNT})],L$1.prototype,"doubleSidedMode",void 0),e$e([e$m({count:o$f.COUNT})],L$1.prototype,"transparencyPassType",void 0),e$e([e$m()],L$1.prototype,"spherical",void 0),e$e([e$m()],L$1.prototype,"receiveShadows",void 0),e$e([e$m()],L$1.prototype,"receiveAmbientOcclusion",void 0),e$e([e$m()],L$1.prototype,"vvSize",void 0),e$e([e$m()],L$1.prototype,"vvColor",void 0),e$e([e$m()],L$1.prototype,"vvOpacity",void 0),e$e([e$m()],L$1.prototype,"hasSlicePlane",void 0),e$e([e$m()],L$1.prototype,"transparent",void 0),e$e([e$m()],L$1.prototype,"hasOccludees",void 0),e$e([e$m()],L$1.prototype,"hasMultipassTerrain",void 0),e$e([e$m()],L$1.prototype,"cullAboveGround",void 0),e$e([e$m()],L$1.prototype,"doublePrecisionRequiresObfuscation",void 0),e$e([e$m({constValue:m$f.Disabled})],L$1.prototype,"pbrMode",void 0),e$e([e$m({constValue:!0})],L$1.prototype,"hasVvInstancing",void 0),e$e([e$m({constValue:!1})],L$1.prototype,"useCustomDTRExponentForWater",void 0),e$e([e$m({constValue:!1})],L$1.prototype,"useFillLights",void 0);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class A$2 extends d$j{constructor(e){super(e,new _$5),this.supportsEdges=!0,this._vertexAttributeLocations=R$2,this._configuration=new L$1,this.vertexBufferLayout=A$2.getVertexBufferLayout(this.parameters);}getConfiguration(e,t){return this._configuration.output=e,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==h$e.Color&&e!==h$e.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?i$h.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?i$h.WindingOrder:i$h.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.ready&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==h$e.Shadow&&e!==h$e.ShadowExludeHighlight&&e!==h$e.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(i,a,s,o,n,h,u){const l=i;if(!r$2(l))return;const d=l.path,p=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const t=this.parameters.vvSizeOffset,r=this.parameters.vvSizeFactor,i=this.parameters.vvSizeMinSize,a=this.parameters.vvSizeMaxSize,s=d.sizeAttributeValue;p[0]*=o$c(t[0]+s*r[0],i[0],a[0]),p[1]*=o$c(t[2]+s*r[2],i[2],a[2]);}const m=Math.max(p[0],p[1]),f=i.boundingInfo;if(t$9(f))return void this._intersectTriangles(d,p,n,h,u);const b=u$n(f.bbMin[0]-m,f.bbMin[1]-m,f.bbMin[2]-m,f.bbMax[0]+m,f.bbMax[1]+m,f.bbMax[2]+m),v=[h[0]-n[0],h[1]-n[1],h[2]-n[2]],S=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),g=[S/v[0],S/v[1],S/v[2]];O$b(b,n,g,o.tolerance)&&this._intersectTriangles(d,p,n,h,u);}_intersectTriangles(e,t,r,i,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(r,i,a);}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return null;const i=r.get(O$7.POSITION);return h$k(i,null,!1,t)}createBufferWriter(){return new w$3(this.vertexBufferLayout)}requiresSlot(e,t){switch(t){case h$e.Shadow:case h$e.ShadowHighlight:case h$e.ShadowExludeHighlight:if(!this.parameters.castShadows)return !1;case h$e.Color:case h$e.Alpha:case h$e.Depth:case h$e.Normal:case h$e.Highlight:return e===(this.parameters.transparent?E$c.TRANSPARENT_MATERIAL:E$c.OPAQUE_MATERIAL)||e===E$c.DRAPED_MATERIAL;default:return !1}}createGLMaterial(e){return new O$1(e)}static getVertexBufferLayout(e){let t=T$5().vec3f(O$7.POSITION).vec4f(O$7.PROFILERIGHT).vec4f(O$7.PROFILEUP).vec4f(O$7.PROFILEVERTEXANDNORMAL);return (e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f(O$7.FEATUREVALUE)),t}}class O$1 extends t$f{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees});}_updateShadowState(e){(t$9(this.technique)||e.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMap.enabled});}beginSlot(e){return this._output!==h$e.Color&&this._output!==h$e.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(E$3,e)}}class _$5 extends C$4{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1;}}class w$3{constructor(e){this.vertexBufferLayout=e;}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(O$7.POSITION).length}write(e,t,r,a){const s=e=>{if(t.vertexAttributes.has(e)){const s=t.vertexAttributes.get(e),o=t.indices.get(e);e$w(4===s.size);const n=r.getField(e,c$j);if(!n)throw new Error("unable to acquire view for "+e);d$k(o,s.data,n,a);}};s(O$7.PROFILERIGHT),s(O$7.PROFILEUP),s(O$7.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(O$7.FEATUREVALUE)&&s(O$7.FEATUREVALUE),h$l(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,a);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const se=["polyline"];class ae extends y$7{constructor(e,t,r,i){super(e,t,r,i),this._intrinsicSize=r$g(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1);}async doLoad(){const t=r$a(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,r=r$a(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=P$5(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const a=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const l=this.symbolLayer.profile||"circle";switch(l){case"circle":default:this._profile=j$3.circle(_e);break;case"quad":this._profile=j$3.rect();}let c=[0,0];"center"!==a&&(c={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[a],this._profile.translate(c[0],c[1]));switch(this.symbolLayer.join||"simple"){case"round":this._extruder=new q$1(0,ge);break;case"bevel":this._extruder=new q$1(0,1);break;case"miter":this._extruder=new q$1(.8*Math.PI,1);break;default:this._extruder=new X;}const p=this.symbolLayer.cap||"butt";switch(p){case"none":this._startCap=new W$2,this._endCap=new W$2;break;case"butt":default:this._startCap=new Y$3(this._profile,0),this._endCap=new Y$3(this._profile,0,!0);break;case"square":this._startCap=new Y$3(this._profile,-.5),this._endCap=new Y$3(this._profile,.5,!0);break;case"round":{const e="quad"===l;this._startCap=new Z({profile:this._profile,flip:!1,breakNormals:e,subdivisions:ye}),this._endCap=new Z({profile:this._profile,flip:!0,breakNormals:e,subdivisions:ye});break}}const m=m$9(this.symbolLayer,"material","color"),f=this._getCombinedOpacityAndColor(m),d=e$o(f),u=f[3],g=u<1||this.needsDrivenTransparentPass,y={diffuse:d,ambient:d,opacity:u,transparent:g,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:g||"none"===p?n$l.None:n$l.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(r$d(this._intrinsicSize,t,r),!V$7(this._intrinsicSize[0])||!V$7(this._intrinsicSize[1])))throw new s$d("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||l$h(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled){const e={...y,...this._fastUpdates.materialParameters,size:e$B(this._intrinsicSize)};this._material=new A$2(e);}else y.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new R$6(y);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material);}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,se,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new h$d),i=e.renderingInfo;return this._createAs3DShape(t,i,r,t.uid)}layerOpacityChanged(){const e=m$9(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:t,transparent:r}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,v$c)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return !0}applyRendererDiff(e,t){for(const r in e.diff){if("visualVariables"!==r)return e$c.Recreate_Symbol;if(!R$4(this._fastUpdates,t,this._vvConvertOptions))return e$c.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters);}return e$c.Fast_Update}getVertexData(e){let t=0;const r=e.paths,s=[],a=e.spatialReference,o=this._context.elevationProvider.spatialReference,n=this._context.renderCoordsHelper.spatialReference;for(const i of r)t+=i.length;const l=new Float64Array(3*t),h=new Float64Array(3*t),c=new Float64Array(3*t);let p=0;for(const i of r){s.push({index:p,numVertices:i.length});for(const t of i)l[p++]=t[0],l[p++]=t[1],l[p++]=e.hasZ?t[2]:0;}let m=!0;return r$a(o)&&!a.equals(o)?m=Un(l,a,0,h,o,0,t):this._copyVertices(l,0,h,0,t),r$a(o)&&!o.equals(n)?Un(h,o,0,c,n,0,t):this._copyVertices(h,0,c,0,t),{pathVertexDataInfos:s,vertexDataGS:l,vertexDataES:h,vertexDataRS:c,projectionSuccess:m,terrainElevation:0}}_copyVertices(e,t,r,i,s){t*=3,i*=3;for(let a=0;a<s;++a)r[i++]=e[t++],r[i++]=e[t++],r[i++]=e[t++];}_createAs3DShape(e,t,r,s){const a=e.geometry,o=new Array,n=new Array,l=new Array,h=a.spatialReference,p=a$c(),m=this._context.renderCoordsHelper;pe.spatialReference=h;const f=this.getVertexData(a);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let s=0;s<f.pathVertexDataInfos.length;++s){const a=f.pathVertexDataInfos[s],d=a.index,u=a.numVertices;if(u<2)continue;if(r$a(this._context.clippingExtent)&&(B$5(p),M$7(p,f.vertexDataES,3*d,u),!R$7(p,this._context.clippingExtent)))continue;const g=[];for(let e=d;e<d+3*u;){const t=e++,i=e++,s=e++,a=new G$2;o$6(a.posGS,f.vertexDataGS[t],f.vertexDataGS[i],f.vertexDataGS[s]),o$6(a.posES,f.vertexDataES[t],f.vertexDataES[i],f.vertexDataES[s]);const o=m$g(a.posES,this._context.elevationProvider,r,m);o$6(me,f.vertexDataRS[t],f.vertexDataRS[i],f.vertexDataRS[s]),m.setAltitude(me,o),o$6(a.pos,me[0],me[1],me[2]),g.push(a);}const y=new z$3(g);oe(y,this.upVectorAlignment,this._context.renderCoordsHelper);const _=new $(y,this._profile,this._extruder,this._startCap,this._endCap);let b=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,r=t.size?v$8(t.size.field,e):0,i=t.color?v$8(t.color.field,e):0,s=t.opacity?v$8(t.opacity.field,e):0;b=new it(_,r,i,s);}else {const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=ne(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=ne(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let r=null;this._drivenProperties.color&&(r=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(r=r?[r[0],r[1],r[2],t.opacity]:[1,1,1,t.opacity]);const i=new et(_);i.bake(e),r&&i.bakeVertexColors(r),b=i;}const{vertexAttributes:v,indices:x}=b.createGeometryData(),w=new e$5(v,x,b,h,this.upVectorAlignment,this.stencilWidth);o.push(w),n.push(this._material),l.push(b.xform);}if(o.length>0){const e={layerUid:this._context.layer.uid,graphicUid:s},t=new O$9({geometries:o,materials:n,transformations:l,metadata:e}),i=new _$b(this,t,o,null,null,he,r);return i.alignedSampledElevation=f.terrainElevation,i.needsElevationUpdates=v$c(r.mode),i}}else 0!==a.paths.length&&a.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function oe(e,i,s){switch(i){case"world":for(const t of e.vertices)u$c(fe,t.pos,e.offset),s.worldUpAtPosition(fe,me),t.setFrameFromUpVector(me),t.computeRotationAxisAndAngleFromUpVector();break;case"path":u$c(fe,e.vertices[0].pos,e.offset),s.worldUpAtPosition(fe,me),J(e,me);for(const i of e.vertices){const e=Math.sign(P$a(i.frame.right,i.vRight));_$d(i.rotationFrame.up,i.vRight,i.vLeft),g$f(i.rotationFrame.up,i.rotationFrame.up,e),z$5(i.rotationFrame.up,i.rotationFrame.up);const s=P$a(i.rotationFrame.up,i.frame.up),o=P$a(i.rotationFrame.up,i.frame.right);if(g$f(fe,i.frame.up,-o),g$f(de,i.frame.right,s),u$c(fe,fe,de),z$5(i.rotationFrame.right,fe),w$4(i.rotationRight,i.frame,i.rotationFrame.right),j$c(fe,i.vLeft),i.rotationAngle=-e*(Math.PI-l$q(P$a(fe,i.vRight))),Math.abs(i.rotationAngle)>0){const e=N$5(Math.cos(.5*i.rotationAngle));r$3(i.miterStretch,1+(e-1)*i.rotationRight[0]*i.rotationRight[0],(e-1)*i.rotationRight[0]*i.rotationRight[1],(e-1)*i.rotationRight[0]*i.rotationRight[1],1+(e-1)*i.rotationRight[1]*i.rotationRight[1]);}const n=Math.PI-i.rotationAngle;i.maxStretchDistance=Math.abs(Math.min(i.vLeftLength,i.vRightLength)*N$5(Math.cos(.5*n)));}}}function ne(e,t,r){switch(e){case"symbol-value":return r;case"proportional":return t;default:return e}}function le(e,t,r,i){let s=0;for(const a of e.vertices)d$g(a.posES,r,t,i,ue),s+=ue.sampledElevation,u$c(me,a.pos,e.offset),i.setAltitude(me,ue.z),e$p(a.pos,me,e.offset);return e.updatePathVertexInformation(),s/e.vertices.length}function he(e,t,r,i){const s=e.stageObject,a=s.geometryRecords;let o=0;ce.spatialReference=i.spatialReference;for(const n of a){const e=n.geometry;if(!r$2(e))continue;const a=e.path,l=a.builder.path,h=e.geometrySR;pe.spatialReference=h,o+=le(l,t,r,i),"world"!==e.upVectorAlignment&&oe(l,e.upVectorAlignment,i),a.onPathChanged(),e.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n);}return o/a.length}const ce=v$f(0,0,0,null),pe=v$f(0,0,0,null),me=n$h(),fe=n$q(),de=n$q(),ue=new j$8,ge=3,ye=3,_e=10;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function T(t,o,r,s,n=1){if(r.isGeographic&&s===l$e.Global){const t=new Float64Array(o.typedBuffer.length),e=3*o.count,s=u$o(r);for(let r=0;r<e;r+=3)ne$3(o.typedBuffer,r,t,r,s);o=T$6.fromTypedArray(t);}r$d(k$4,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let e=0;e<o.count;e++)o.getVec(e,E$2),k$4[0]=Math.min(k$4[0],E$2[0]),k$4[1]=Math.min(k$4[1],E$2[1]);const c=k$4[0]%n,a=k$4[1]%n;P$3[0]=k$4[0]-c,P$3[1]=k$4[1]-a;for(let e=0;e<o.count;e++)o.getVec(e,E$2),t.setValues(e,(E$2[0]-P$3[0])/n,(E$2[1]-P$3[1])/n,P$3[0]/n,P$3[1]/n);}function M(t,o,r,f,i=1){o$6(Y$2,1,0,0),o$6(_$4,0,1,0),o$6(d$7,0,0,1),z$2(y$4,o),O(o,F$2)&&S$2(F$2,Y$2,_$4,d$7,r,y$4),r$d(k$4,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),r$d(A$1,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let e=0;e<o.count;e++){o.getVec(e,E$2);const t=P$a(Y$2,E$2),r=P$a(_$4,E$2);k$4[0]=Math.min(k$4[0],t),k$4[1]=Math.min(k$4[1],r),A$1[0]=Math.max(A$1[0],t),A$1[1]=Math.max(A$1[1],r);}const u=P$a(d$7,y$4);H$1(v$3,k$4[0],k$4[1],u,Y$2,_$4,d$7),H$1(x$2,A$1[0],k$4[1],u,Y$2,_$4,d$7),H$1(G$1,k$4[0],A$1[1],u,Y$2,_$4,d$7),e$p(x$2,x$2,v$3),g$f(x$2,x$2,.5),e$p(G$1,G$1,v$3),g$f(G$1,G$1,.5),u$c(v$3,v$3,x$2),u$c(v$3,v$3,G$1);const I=k$4[0]%i,p=k$4[1]%i;P$3[0]=k$4[0]-I,P$3[1]=k$4[1]-p;for(let e=0;e<o.count;e++){o.getVec(e,E$2),t.setValues(e,(P$a(Y$2,E$2)-P$3[0])/i,(P$a(_$4,E$2)-P$3[1])/i,P$3[0]/i,P$3[1]/i);for(let t=0;t<3;t++)f.set(e,t,v$3[t]),f.set(e,t+3,x$2[t]),f.set(e,t+6,G$1[t]);}}const y$4=n$h(),E$2=n$h(),F$2=p$h(),Y$2=n$h(),_$4=n$h(),d$7=n$h(),k$4=n$k(),A$1=n$k(),P$3=n$k(),v$3=n$h(),x$2=n$h(),G$1=n$h();function O(t,o){const e=t.count-1;return b$l(t,o,0,Math.floor(e/3),Math.floor(e*(2/3)))}function S$2(o,e,r,c,m,p){r$a(m)?(m.basisMatrixAtPosition(p,w$2),o$6(B$1,w$2[0],w$2[1],w$2[2]),o$6(C$3,w$2[4],w$2[5],w$2[6]),o$6(q,w$2[8],w$2[9],w$2[10])):(o$6(B$1,1,0,0),o$6(C$3,0,1,0),o$6(q,0,0,1));const N=Z$1(o);P$a(N,q)<0&&g$f(N,N,-1),r$b(c,N);const l=P$a(N,C$3),h=P$a(N,B$1);Math.abs(l)<Math.abs(h)?(q$a(e,B$1,N,-h),z$5(e,e),_$d(r,e,N),z$5(r,r),g$f(r,r,-1)):(q$a(r,C$3,N,-l),z$5(r,r),_$d(e,r,N),z$5(e,e));}const w$2=e$g(),B$1=n$h(),C$3=n$h(),q=n$h();function z$2(t,o){o$6(D$1,0,0,0);for(let e=0;e<o.count-1;e++)o.getVec(e,E$2),u$c(D$1,D$1,E$2);g$f(t,D$1,1/(o.count-1));}const D$1=n$h();function H$1(t,o,e,r,n,c,a){o$6(t,o*n[0]+e*c[0]+r*a[0],o*n[1]+e*c[1]+r*a[1],o*n[2]+e*c[2]+r*a[2]);}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var a$1;!function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.Cross=2]="Cross",a[a.ForwardDiagonal=3]="ForwardDiagonal",a[a.BackwardDiagonal=4]="BackwardDiagonal",a[a.DiagonalCross=5]="DiagonalCross",a[a.COUNT=6]="COUNT";}(a$1||(a$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const b$3=.70710678118,y$3=b$3,S$1=.08715574274;function j$2(j){const P=new o$7,T=j.hasMultipassTerrain&&(j.output===h$e.Color||j.output===h$e.Alpha);j.draped||P.extensions.add("GL_OES_standard_derivatives");const{vertex:C,fragment:R}=P;v$d(P,j),P.include(r$n,j),P.include(e$C,j),j.draped?C.uniforms.add(new o$8("worldToScreenRatio",((e,o)=>1/o.screenToPCSRatio))):P.attributes.add(O$7.BOUNDINGRECT,"mat3"),P.attributes.add(O$7.POSITION,"vec3"),P.attributes.add(O$7.UVMAPSPACE,"vec4"),P.varyings.add("vpos","vec3"),P.varyings.add("vuv","vec2"),T&&P.varyings.add("depth","float");const D=j.style===a$1.ForwardDiagonal||j.style===a$1.BackwardDiagonal||j.style===a$1.DiagonalCross;D&&C.code.add(n$j`
      const mat2 rotate45 = mat2(${n$j.float(b$3)}, ${n$j.float(-y$3)},
                                 ${n$j.float(y$3)}, ${n$j.float(b$3)});
    `),j.draped||(c$o(C,j),C.uniforms.add(new o$8("worldToScreenPerDistanceRatio",((e,o)=>1/o.camera.perScreenPixelRatio))),C.code.add(n$j`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),C.code.add(n$j`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),C.code.add(n$j`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${n$j.float(S$1)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),C.code.add(n$j`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${D?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${D?" * rotate45":""};

      ${j.draped?"":n$j`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${n$j.float(j.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const $=j.output===h$e.Depth;return $&&(P.include(o$e,j),C.uniforms.add(new e$k("nearFar",((e,o)=>o.camera.nearFar))),P.varyings.add("linearDepth","float")),C.code.add(n$j`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${T?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${$?n$j`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:n$j`transformPosition(proj, view, vpos);`}
    }
  `),P.include(u$h,j),R.include(e$u),j.draped&&R.uniforms.add(new o$8("texelSize",((e,o)=>1/o.camera.pixelRatio))),j.output===h$e.Highlight&&P.include(a$m),T&&P.include(n$n,j),j.output!==h$e.Highlight&&(R.code.add(n$j`
      const float lineWidth = ${n$j.float(j.lineWidth)};
      const float spacing = ${n$j.float(j.patternSpacing)};
      const float spacingINV = ${n$j.float(1/j.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),j.draped||R.code.add(n$j`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),R.uniforms.add(new e$j("uColor",(e=>e.color))),R.code.add(n$j`
    void main() {
      discardBySlice(vpos);
      ${T?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${j.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${j.output!==h$e.Highlight?n$j`color.a *= ${x$1(j)};`:""}

      if (color.a < ${n$j.float(t$i)}) {
        discard;
      }

      ${j.output===h$e.Alpha?n$j`gl_FragColor = vec4(color.a);`:""}

      ${j.output===h$e.Color?n$j`gl_FragColor = color; ${j.transparencyPassType===o$f.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${j.output===h$e.Highlight?n$j`outputHighlight();`:""}
      ${j.output===h$e.Depth?n$j`outputDepth(linearDepth);`:""};
    }
  `),P}function x$1(e){function o(o){return e.draped?n$j`coverage(vuv.${o}, texelSize)`:n$j`sample(vuv.${o})`}switch(e.style){case a$1.ForwardDiagonal:case a$1.Horizontal:return o("y");case a$1.BackwardDiagonal:case a$1.Vertical:return o("x");case a$1.DiagonalCross:case a$1.Cross:return n$j`
        1.0 - (1.0 - ${o("x")}) * (1.0 - ${o("y")})
      `;default:return "0.0"}}const P$2=Object.freeze(Object.defineProperty({__proto__:null,build:j$2},Symbol.toStringTag,{value:"Module"}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class j$1 extends e$l{initializeProgram(e){return new o$9(e.rctx,j$1.shader.get().build(this.configuration),w$1)}_setPipelineState(e,o){const r=this.configuration,i=e===o$f.NONE,s=e===o$f.FrontFace;return W$3({blending:r.output===h$e.Color||r.output===h$e.Alpha?i?c$h:A$9(e):null,culling:h$m(r.cullFace),depthTest:{func:l$l(e)},depthWrite:i?r.writeDepth&&a$e:E$g(e),colorWrite:_$c,stencilWrite:r.hasOccludees?e$v:null,stencilTest:r.hasOccludees?o?o$g:f$l:null,polygonOffset:i||s?r.polygonOffset&&C$2:a$o(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}j$1.shader=new t$d(P$2,(()=>import('./Pattern.glsl-d8524a6b.js')));const C$2={factor:1,units:1};class N$2 extends s$c{constructor(){super(...arguments),this.output=h$e.Color,this.cullFace=n$l.None,this.transparencyPassType=o$f.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1;}}e$e([e$m({count:h$e.COUNT})],N$2.prototype,"output",void 0),e$e([e$m({count:n$l.COUNT})],N$2.prototype,"cullFace",void 0),e$e([e$m({count:a$1.COUNT})],N$2.prototype,"style",void 0),e$e([e$m({count:o$f.COUNT})],N$2.prototype,"transparencyPassType",void 0),e$e([e$m()],N$2.prototype,"hasSlicePlane",void 0),e$e([e$m()],N$2.prototype,"hasVertexColors",void 0),e$e([e$m()],N$2.prototype,"polygonOffset",void 0),e$e([e$m()],N$2.prototype,"writeDepth",void 0),e$e([e$m()],N$2.prototype,"hasOccludees",void 0),e$e([e$m()],N$2.prototype,"patternSpacing",void 0),e$e([e$m()],N$2.prototype,"lineWidth",void 0),e$e([e$m()],N$2.prototype,"enableOffset",void 0),e$e([e$m()],N$2.prototype,"draped",void 0),e$e([e$m()],N$2.prototype,"hasMultipassTerrain",void 0),e$e([e$m()],N$2.prototype,"cullAboveGround",void 0);const w$1=new Map([[O$7.POSITION,0],[O$7.COLOR,3],[O$7.UVMAPSPACE,4],[O$7.BOUNDINGRECT,5]]);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class y$2 extends d$j{constructor(t){super(t,new j),this.supportsEdges=!0,this._vertexAttributeLocations=w$1,this._configuration=new N$2;}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<S$h,this._configuration.hasMultipassTerrain=e.multipassTerrain.enabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration}intersect(t,e,r,i,s,a,o){x$b(t,e,i,s,a,void 0,o);}requiresSlot(t,e){if(e===h$e.Color||e===h$e.Alpha||e===h$e.Highlight||e===h$e.Depth&&this.parameters.writeLinearDepth){if(t===E$c.DRAPED_MATERIAL)return !0;if(e===h$e.Highlight)return t===E$c.OPAQUE_MATERIAL;return t===(this.parameters.writeDepth?E$c.TRANSPARENT_MATERIAL:E$c.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return !1}createGLMaterial(t){return new E$1(t)}createBufferWriter(){const t=T$5().vec3f(O$7.POSITION).vec4u8(O$7.COLOR).vec4f(O$7.UVMAPSPACE);return this.parameters.draped||t.mat3f(O$7.BOUNDINGRECT),new R$1(t)}}class E$1 extends t$f{_updateParameters(t){return this.ensureTechnique(j$1,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees});}beginSlot(t){return this._output!==h$e.Color&&this._output!==h$e.Alpha||this._updateOccludeeState(t),this._updateParameters(t)}}class R$1 extends i$j{write(t,a,o,n){for(const c of this.vertexBufferLayout.fieldNames){const h=a.vertexAttributes.get(c),l=a.indices.get(c);if(h&&l)switch(c){case O$7.POSITION:{e$w(3===h.size);const e=o.getField(c,i$e);e&&p$b(l,h.data,t.transformation,e,n);break}case O$7.COLOR:{e$w(3===h.size||4===h.size);const t=o.getField(c,x$c);t&&g$k(l,h.data,h.size,t,n);break}case O$7.UVMAPSPACE:{e$w(4===h.size);const t=o.getField(c,c$j);t&&d$k(l,h.data,t,n);break}case O$7.BOUNDINGRECT:{e$w(9===h.size);const r=o.getField(c,l$o);r&&this.writeBoundingRect(l,h.data,t.transformation,r,n);break}}}}writeBoundingRect(t,e,r,i,s){const a=r,o=i.typedBuffer,n=i.typedBufferStride,c=t.length;s*=n;for(let h=0;h<c;++h){const r=9*t[h],i=e[r],c=e[r+1],l=e[r+2];o[s]=a[0]*i+a[4]*c+a[8]*l+a[12],o[s+1]=a[1]*i+a[5]*c+a[9]*l+a[13],o[s+2]=a[2]*i+a[6]*c+a[10]*l+a[14];for(let t=3;t<9;++t)o[s+t]=e[r+t];s+=n;}}}class j extends h$f{constructor(){super(...arguments),this.color=r$c(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=n$l.None,this.hasOccludees=!1,this.style=a$1.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function f$1(r,e,t){return g$2(u$3(r),e,t)}function u$3(r){return r&&r.pattern||null}function g$2(t,a,o){return r$a(t)?"none"===t.style||"solid"===t.style?("none"===t.style&&(a.color=r$c(0,0,0,0),a.transparent=!0),new f$n(a)):(a.style=p$1(t.style),a.draped=o.isDraped,new y$2(a)):new f$n(a)}function p$1(r){switch(r){case"horizontal":return a$1.Horizontal;case"vertical":return a$1.Vertical;case"cross":return a$1.Cross;case"forward-diagonal":return a$1.ForwardDiagonal;case"backward-diagonal":return a$1.BackwardDiagonal;case"diagonal-cross":return a$1.DiagonalCross;default:return}}function d$6(r){return r.material instanceof y$2&&!r.material.parameters.draped}function y$1(r,e){if(d$6(r)){const n=r.geometry.vertexAttributes,l=n.get(O$7.POSITION).data,m=n.get(O$7.UVMAPSPACE).data,c=n.get(O$7.BOUNDINGRECT).data;M(c$j.fromTypedArray(m),T$6.fromTypedArray(l),e,a$p.fromTypedArray(c));}}function w(r,e,t,a){const o=p$8(r,e,t,a),i=r.stageObject.geometryRecords;for(let n=0;n<i.length;n++)y$1(i[n],a);return o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const H=["polyline","polygon","extent"];class W$1 extends y$7{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1;}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial();}_ensureFillMaterial(){if(r$a(this._material))return;const e=m$9(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=f$1(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof y$2,this._context.stage.add(this._material);}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(r$a(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const i=t=>{const i=a$k(e.pattern);return new B$7({width:t,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleScaleWithLineWidth:!0,cap:L$6(e.patternCap||"butt")})};this._outlineMaterial=i(u$e(e.size)),this._context.stage.add(this._outlineMaterial);}_isValidOutline(e){return r$a(e)&&e.size&&e.size>0&&r$a(e.color)&&(t$9(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,H,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new h$d);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(r$a(this._material)){const e=this._material.parameters.color,t=m$9(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass});}if(r$a(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]});}return !0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=p$c(W$1.elevationModeChangeTypes,i,r);if(n!==x$8.UPDATE)return n;const o=g$c(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>o))}slicePlaneEnabledChanged(){if(r$a(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),r$a(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e);}return !0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_createAs3DShape(e,t,i){const n=m$4(e.geometry);if(t$9(n))return null;z$1.renderData=d$b(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),z$1.color=t;const o=z$1.renderData.position.length/3;if(this._needsUV&&(z$1.uvMapSpace=new Float32Array(4*o),z$1.boundingRect=new Float64Array(9*o)),z$1.outNum=0,z$1.outGeometries=[],z$1.outTransforms=[],z$1.outMaterials=[],this._createAs3DShapeFill(z$1),this._hasOutline&&this._createAs3DShapeOutline(z$1),this._logGeometryCreationWarnings(z$1.renderData,n.rings,"rings","FillSymbol3DLayer"),0===z$1.outNum)return null;this._needsUV&&M(c$j.fromTypedArray(z$1.uvMapSpace),T$6.fromTypedArray(z$1.renderData.position),this._context.renderCoordsHelper,a$p.fromTypedArray(z$1.boundingRect));const a=new O$9({geometries:z$1.outGeometries,materials:z$1.outMaterials,transformations:z$1.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),s=new _$b(this,a,z$1.outGeometries,null,null,w,i);return s.alignedSampledElevation=z$1.renderData.sampledElevation,s.needsElevationUpdates=g$c(i.mode),s}_createAs3DShapeFill(e){const i=e.renderData.polygons;for(const{position:r,mapPosition:o,holeIndices:l,index:u,count:d}of i){if(r$a(this._context.clippingExtent)&&(B$5(k$3),M$7(k$3,o),!R$7(k$3,this._context.clippingExtent)))continue;const i=x$9(o,l,3);if(0===i.length)continue;const m=new Uint32Array(i),_=c$4({indices:m,attributeData:{position:r,color:e.color,mapPosition:o,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*u*e.uvMapSpace.BYTES_PER_ELEMENT,4*d):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*u*e.boundingRect.BYTES_PER_ELEMENT,9*d):null}});e.outGeometries.push(_),e.outMaterials.push(e$h(this._material)),e.outTransforms.push(o$b),e.outNum++;}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const i=e.renderData.outlines;for(let r=0;r<i.length;++r){const{mapPosition:o,position:a}=i[r];if(r$a(this._context.clippingExtent)&&(B$5(k$3),M$7(k$3,o),!R$7(k$3,this._context.clippingExtent)))continue;const l=O$a({overlayInfo:null,removeDuplicateStartEnd:P$9.REMOVE,attributeData:{position:a,mapPosition:o}}),u=l.vertexAttributes.get(O$7.POSITION);u.data===a&&(u.data=new Float64Array(a)),e.outGeometries.push(l),e.outMaterials.push(e$h(this._outlineMaterial)),e.outTransforms.push(o$b),e.outNum++;}}_createAsOverlay(e,i){const o=m$4(e.geometry);if(t$9(o))return null;e$h(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,r$a(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),Y$1.renderData=f$9(o,this._context.overlaySR),Y$1.color=i;const a=Y$1.renderData.position.length/3;return this._needsUV&&(Y$1.uvMapSpace=new Float32Array(4*a)),Y$1.outNum=0,Y$1.outGeometries=[],Y$1.outBoundingBox=B$5(),Y$1.layerUid=this._context.layer.uid,Y$1.graphicsUid=e.uid,this._createAsOverlayFill(Y$1),this._hasOutline&&this._createAsOverlayOutline(Y$1),this._logGeometryCreationWarnings(Y$1.renderData,o.rings,"rings","FillSymbol3DLayer"),0===Y$1.outNum?null:(this._needsUV&&T(c$j.fromTypedArray(Y$1.uvMapSpace),T$6.fromTypedArray(Y$1.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),Y$1.outNum>0?new u$5(this,Y$1.outGeometries,Y$1.outBoundingBox,this._context.drapeSourceRenderer):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:o,count:s}of t){if(B$5(k$3),M$7(k$3,i),!R$7(k$3,this._context.clippingExtent))continue;const t=x$9(i,r,3);if(0===t.length)continue;f$i(e.outBoundingBox,k$3);const u=new Uint32Array(t),m=c$4({indices:u,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*o*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),_=new T$7(m,e$h(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),y=k$3;r$k(_.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(_),e.outNum++;}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(B$5(k$3),M$7(k$3,r),!R$7(k$3,this._context.clippingExtent))continue;f$i(e.outBoundingBox,k$3);const o=O$a({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:P$9.REMOVE,attributeData:{position:r}}),a=new T$7(o,e$h(this._outlineMaterial),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),s=k$3;r$k(a.boundingSphere,.5*(s[0]+s[3]),.5*(s[1]+s[4]),0,.5*Math.sqrt((s[3]-s[0])*(s[3]-s[0])+(s[4]-s[1])*(s[4]-s[1]))),e.outGeometries.push(a),e.outNum++;}}_getOutlineOpacity(){const e=m$9(this.symbolLayer,"outline","color");return (this.draped?1:this._getLayerOpacity())*(r$a(e)?e.a:0)}_getOutlineColor(){const r=m$9(this.symbolLayer,"outline","color"),n=this._getOutlineOpacity();return B$6(r$a(r)?l$b.toUnitRGB(r):null,n)}test(){return {...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}W$1.elevationModeChangeTypes={definedChanged:x$8.RECREATE,staysOnTheGround:x$8.NONE,onTheGroundChanged:x$8.RECREATE};const k$3=a$c(),z$1={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y$1={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$3{constructor(o){this.definition=o,this.key=JSON.stringify(o),this.haloSize=Math.round(o.halo.size),this.textStyle=this._colorToRGBA(o.color),this.haloStyle=this._colorToRGB(o.halo.color),this.backgroundStyle=0!==o.background.color[3]?this._colorToRGBA(o.background.color):null;}fontString(o){const r=this.definition.font;return `${r.style} ${r.weight} ${o}px ${r.family}, sans-serif`}_colorToRGB(o){return `rgb(${o.slice(0,3).map((o=>Math.floor(255*o))).toString()})`}_colorToRGBA(o){return `rgba(${o.slice(0,3).map((o=>Math.floor(255*o))).toString()},${o[3]})`}static async fromSymbol(a,c=1){const g=m$9(a,"material","color"),f=E$i(g,l$d,l$b.toUnitRGBA),d=E$i(a.size,12,u$e),h=a.lineHeight,m=r$a(a.background)?l$b.toUnitRGBA(a.background.color):l$d,u={family:E$i(a.font,"sans-serif",(o=>o.family)),decoration:E$i(a.font,"none",(o=>o.decoration)),weight:E$i(a.font,"normal",(o=>o.weight)),style:E$i(a.font,"normal",(o=>o.style))},b=a.halo,y=r$a(b)&&r$a(b.color)&&b.size>0?{size:u$e(b.size),color:l$b.toUnitRGBA(b.color)}:{size:0,color:l$d},p=new s$3({color:f,size:d,background:{color:m,padding:r$a(a.background)?[.65*d,.5*d]:[0,0],borderRadius:r$a(a.background)?d*(6/16):0},lineSpacingFactor:h,font:u,halo:y,pixelRatio:c}),S=p.fontString(d);try{await document.fonts.load(S);}catch(R){s$b.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${S}'. Some text symbology may be rendered using the default browser font.`);}return p}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class i$1{constructor(e,t,n){this._renderer=new s$7(e,t,n);}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const r=o$4(d$5,this._renderer.renderedWidth,this._renderer.renderedHeight),i=r.getContext("2d");return i.save(),this._renderer.render(i,0,0),i.restore(),new L$5(r,{wrap:{s:D$3.CLAMP_TO_EDGE,t:D$3.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:c$g.PAD})}}const d$5={canvas:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const C$1=[0,0,1];class U$1 extends y$7{constructor(e,t,r,n){super(e,t,r,n),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1);}async doLoad(){if(!this._drivenProperties.size){const t=S$g(this.symbolLayer.size);if(t)throw new s$d("graphics3dtextsymbollayer:invalid-size",t)}await this._createTextRenderParameters();}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.pixelRatio;this._textRenderParameters=await s$3.fromSymbol(this.symbolLayer,e);}destroy(){super.destroy();}createGraphics3DGraphic(e){const n=e.graphic,s=d$n(n.geometry);if(t$9(s))return this.logger.warn(`unsupported geometry type for text symbol: ${n.geometry.type}`),null;const i=this.symbolLayer.text;if(t$9(i)||""===i)return null;const o=i$a(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(r$a(o)&&!l$g(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const a={...A,verticalOffset:o,horizontalPlacement:this.symbolLayer.horizontalAlignment,verticalPlacement:f$8(this.symbolLayer.verticalAlignment)};return this._createAs3DShape(n,s,i,a)}createLabel(e,r,n,s){const i=e.graphic,o=d$n(i.geometry);if(t$9(o))return this.logger.warn(`unsupported geometry type for label: ${i.geometry.type}`),null;const a=r.text;return !a||/^\s+$/.test(a)?null:this._createAs3DShape(i,o,a,r,n,s)}setGraphicElevationContext(e,t,r=0){const n=super.setGraphicElevationContext(e,t);return n.addOffsetRenderUnits(r),n}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return D(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e);})),x$8.UPDATE}slicePlaneEnabledChanged(e,t){return D(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});})),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=g$c(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode;}_defaultElevationInfoNoZ(){return R}_createAs3DShape(e,l,c,m,f,g){const y=this.setGraphicElevationContext(e,new h$d,m.elevationOffset),v="polyline"===m$9(e.geometry,"type"),b=e.uid;let P=null,O=null;if(t$9(g)){const e=c$3(m.horizontalPlacement);P=new i$1(c,e,this._textRenderParameters);let n=null;O=this._context.sharedResources.textures.fromData(P.key,(()=>e$h(P).create()),(()=>{r$a(n)&&n.release();}));const o=this._context.stage.renderView.textureRepository.acquire(O.texture.id);if(t$9(o)||C$a(o))return O.release(),null;n=o;}const w=G(P,m),_={occlusionTest:!0,screenOffset:m.screenOffset,anchorPosition:w,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:m.centerOffsetUnits,debugDrawLabelBorder:m.debugDrawLabelBorder,drawInSecondSlot:!0};if(r$a(O)&&(_.textureId=O.texture.id),r$a(g)&&(_.textureId=g.id),r$a(m.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:n}=m.verticalOffset;_.verticalOffset={screenLength:u$e(e),minWorldLength:t||0,maxWorldLength:r$a(n)?n:1/0};}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;_.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),_.screenSizePerspectiveAlignment=e;}let U;if(v&&(_.shaderPolygonOffset=1e-4),_.hasSlicePlane=this._context.slicePlaneEnabled,r$a(f)){const e=JSON.stringify(_);U=f.get(e),t$9(U)&&(U=new K$3(_),f.add(e,U));}else U=new K$3(_);const D=[U],R=m.translation,A=r$a(P)?[P.displayWidth,P.displayHeight]:[0,0],T=m.centerOffset,W=C$1,I=[0,0],k=[T$4.createPointGeometry(W,R,null,A,T,I,null)],B=this._context.layer.uid,H=f$h(this._context,l,k,D,y,B,b);if(null===H)return null;const $=new _$b(this,H.object,k,t$9(f)?D:null,O,d$e,y);$.alignedSampledElevation=H.sampledElevation,$.needsElevationUpdates=g$c(y.mode)||"absolute-height"===y.mode;const{displayWidth:V,displayHeight:N}=r$a(P)?P:m;$.getScreenSize=(e=n$k())=>(e[0]=V,e[1]=N,e);const q={labelText:c,elevationOffset:m.elevationOffset};return $.metadata=q,g$e($,l,this._context.elevationProvider),$}}function D(e,t,n){e&&e.forEach((e=>{const s=t(e);r$a(s)&&n(s,e.graphic);}));}function G(e,t){if("baseline"===t.verticalPlacement){const n=r$6[t.horizontalPlacement],s=r$a(e)?e.baselineAnchorY:0;return r$g(n,s)}const n=i$4(t.horizontalPlacement,t.verticalPlacement);return o$3[n]}const R={mode:"relative-to-ground",offset:0},A={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const e$3={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const N$1=["polyline","polygon","extent"];class V$1 extends y$7{constructor(e,t,r,o){super(e,t,r,o);}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null;}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,N$1,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new h$d);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)}ensureMaterial(){if(r$a(this._material))return;const r=new d$p,o=this.symbolLayer.color;r$a(o)&&(r.color=l$b.toUnitRGBA(o));const i=this._getCombinedOpacity(o,{hasIntrinsicColor:!0});r.color=[r.color[0],r.color[1],r.color[2],i],r.transparent=i<1||this.needsDrivenTransparentPass,r.waveDirection=r$a(this.symbolLayer.waveDirection)?V$1.headingVectorFromAngle(this.symbolLayer.waveDirection):r$g(0,0);const a=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=e$3[a];r.waveStrength=n.waveStrength,r.waveTextureRepeat=n.textureRepeat,r.waveVelocity=n.waveVelocity,r.flowStrength=n.perturbationStrength,r.hasSlicePlane=this._context.slicePlaneEnabled,r.isDraped=this.draped,this._material=new f$o(r),this._context.stage.add(this._material);}layerOpacityChanged(){if(t$9(this._material))return !0;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),o=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:o}),!0}layerElevationInfoChanged(e,t,r){const o=this._elevationContext.mode,i=p$c(V$1.elevationModeChangeTypes,r,o);if(i!==x$8.UPDATE)return i;const a=g$c(o);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return r$a(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return !0}pixelRatioChanged(){return !0}_createAs3DShape(e,t,o){const i=m$4(e.geometry);if(t$9(i))return null;z.renderData=d$b(i,this._context.elevationProvider,this._context.renderCoordsHelper,t);const a=z.renderData.position.length/3;if(z.uvCoords=new Float64Array(2*a),z.outNum=0,z.outGeometries=[],z.outTransforms=[],z.outMaterials=[],this._create3DShapeGeometries(z),this._logGeometryCreationWarnings(z.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===z.outNum)return null;this._createUVCoordsFromVertices(z.uvCoords,z.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const n=new O$9({geometries:z.outGeometries,materials:z.outMaterials,transformations:z.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:o}}),s=new _$b(this,n,z.outGeometries,null,null,p$8,t);return s.alignedSampledElevation=z.renderData.sampledElevation,s.needsElevationUpdates=g$c(t.mode),s}_createUVCoordsFromVertices(e,t,r,o){const a=$$3(o);D$4(I$1);for(let i=0;i<r;i++)r$d(W,t[3*i+0],t[3*i+1]),m$h(I$1,W);l$r(I$1,I$1,a);const n=I$1[0]%V$1.unitSizeOfTexture,l=I$1[1]%V$1.unitSizeOfTexture;F$1[0]=I$1[0]-n,F$1[1]=I$1[1]-l;for(let i=0;i<r;i++)e[2*i+0]=(t[3*i+0]*a-F$1[0])/V$1.unitSizeOfTexture,e[2*i+1]=(t[3*i+1]*a-F$1[1])/V$1.unitSizeOfTexture;}_create3DShapeGeometries(e){const r=e.renderData.polygons,i=e.uvCoords;for(const{count:s,index:l,position:u,mapPosition:c,holeIndices:m}of r){if(r$a(this._context.clippingExtent)&&(B$5(k$2),M$7(k$2,c),!R$7(k$2,this._context.clippingExtent)))continue;const r=x$9(c,m,3);if(0===r.length)continue;const h=new Uint32Array(r),d=new Float64Array(i.buffer,2*l*i.BYTES_PER_ELEMENT,2*s),f=l$7({indices:h,attributeData:{position:u,uv0:d,mapPosition:c}});e.outGeometries.push(f),e.outMaterials.push(e$h(this._material)),e.outTransforms.push(o$b),e.outNum++;}}_createAsOverlay(e){const t=m$4(e.geometry);if(t$9(t))return null;e$h(this._material).renderPriority=this._renderPriority,Y.renderData=f$9(t,this._context.overlaySR);const i=Y.renderData.position.length/3;return Y.uvCoords=new Float64Array(2*i),Y.outNum=0,Y.outGeometries=[],Y.outBoundingBox=B$5(),Y.layerUid=this._context.layer.uid,Y.graphicsUid=e.uid,this._createAsOverlayWater(Y),this._logGeometryCreationWarnings(Y.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===Y.outNum?null:(this._createUVCoordsFromVertices(Y.uvCoords,Y.renderData.position,i,this._context.overlaySR),Y.outNum>0?new u$5(this,Y.outGeometries,Y.outBoundingBox,this._context.drapeSourceRenderer):null)}_createAsOverlayWater(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:i,holeIndices:n,index:s,count:l}of r){if(B$5(k$2),M$7(k$2,i),!R$7(k$2,this._context.clippingExtent))continue;f$i(e.outBoundingBox,k$2);const r=x$9(i,n,3);if(0===r.length)continue;const u=new Uint32Array(r),c=new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*l),h=l$7({indices:u,attributeData:{position:i,uv0:c}}),d=new T$7(h,e$h(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),_=k$2;r$k(d.boundingSphere,.5*(_[0]+_[3]),.5*(_[1]+_[4]),0,.5*Math.sqrt((_[3]-_[0])*(_[3]-_[0])+(_[4]-_[1])*(_[4]-_[1]))),e.outGeometries.push(d),e.outNum++;}}static headingVectorFromAngle(e){const t=n$k(),r=r$p(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t}test(){return {...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}V$1.unitSizeOfTexture=100,V$1.elevationModeChangeTypes={definedChanged:x$8.RECREATE,staysOnTheGround:x$8.NONE,onTheGroundChanged:x$8.RECREATE};const F$1=n$k(),I$1=u$i(),W=n$k(),k$2=a$c(),z={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Y={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function c(o,e,t,i){const m=h$2[o.type]&&h$2[o.type][e.type]||l$3[e.type];return m?new m(o,e,t,i):(s$b.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const l$3={icon:me$3,object:me$1,line:K$1,path:ae,fill:W$1,extrude:J$2,text:U$1,water:V$1};const h$2={"mesh-3d":{fill:me$2}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class d$4 extends a$7{constructor(e,t,s){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=s,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0;}set symbol(e){this._symbol=e;for(let s=0;s<e.symbolLayers.length;s++){const r=this.symbolLayers[s];t$9(r)||(r.symbol=e,r.symbolLayer=e.symbolLayers.items[s]);}}get symbol(){return this._symbol}async doLoad(t){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const i=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const n=[];for(let e=0;e<i;e++){const s=r.getItemAt(e);if(!1===s.enabled)continue;p.renderPriority=1-(1+e)/i,p.renderPriorityStep=1/i,p.ignoreDrivers=s._ignoreDrivers;const a=c(this.symbol,s,this._context,p);n.push(d$q(t,(()=>{this.symbolLayers[e]=null,a.destroy();}))),this.symbolLayers[e]=a;}await c$c(this.symbolLayers,(async(e,t)=>{if(r$a(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding);}catch{this.symbolLayers[t]=null;}}));for(const e of n)e?.remove();if(n.length=0,f$d(t),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return r$a(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const r=e.graphic,o=new Array(this.symbolLayers.length);for(let i=0;i<this.symbolLayers.length;i++){const t=this.symbolLayers[i];o[i]=r$a(t)?t.createGraphics3DGraphic(e):null;}const a=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new V$4(r,t||this,o,e.layer,a)}get complexity(){return d$c(this.symbolLayers.map((e=>m$9(e,"complexity"))))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let o=0;o<r;o++){const r=this.symbolLayers[o],a=e=>{const t=e.graphics[o];return t instanceof _$b?t:null};if(r$a(r)&&!r.globalPropertyChanged(e,t,a))return !1}return !0}applyRendererDiff(e,t){return this.loadStatus!==e$b.LOADED?e$c.Recreate_Symbol:this.symbolLayers.reduce(((r,o)=>r!==e$c.Recreate_Symbol&&r$a(o)?Math.min(r,o.applyRendererDiff(e,t)):r),e$c.Fast_Update)}prepareSymbolPatch(e){if(this.loadStatus===e$b.FAILED)return;if("partial"!==e.diff.type)return;const r=e.diff.diff;if(!r.symbolLayers||"partial"!==r.symbolLayers.type)return;const o=r.symbolLayers.diff;this.symbolLayers.forEach(((r,a)=>{if(t$9(r))return;const i=o[a];if(i){const t={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};r.prepareSymbolLayerPatch(t),e.symbolStatePatches.push(...t.symbolLayerStatePatches),t.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,r)=>{const o=e.graphics[a];r$a(o)&&t.graphics3DGraphicPatches.forEach((e=>e(o,r)));}));}}));}updateGeometry(e,s){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(t$9(o))continue;const a=e.graphics[r];if(t$9(a)||!o.updateGeometry(a,s))return !1}return !0}onRemoveGraphic(e){for(let r=0;r<this.symbolLayers.length;r++){const o=this.symbolLayers[r];if(t$9(o))continue;const a=e.graphics[r];r$a(a)&&o.onRemoveGraphic(a);}}getFastUpdateStatus(){let e=0,s=0,r=0;return this.symbolLayers.forEach((o=>{t$9(o)||(o.loadStatus===e$b.LOADING?e++:o.isFastUpdatesEnabled()?r++:s++);})),{loading:e,slow:s,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else {super.destroy();for(const e of this.symbolLayers)r$a(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0;}}get destroyed(){return this._destroyed}}const p={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$2 extends d$4{constructor(r,t,a){super(r,t,a),this.calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this.calloutSymbolLayer=e$8(this.symbol,t));}async doLoad(t){const a=this.calloutSymbolLayer?b$j(this.calloutSymbolLayer.load()):null;try{await super.doLoad(t),f$d(t);}catch(o){throw this.calloutSymbolLayer?.abortLoad(),o}a&&await a;}destroy(){super.destroy(),this.calloutSymbolLayer=l$s(this.calloutSymbolLayer);}createGraphics3DGraphic(r,t){const e=super.createGraphics3DGraphic(r,t);if(r$a(this.calloutSymbolLayer)&&r$a(e)){const t=this._createCalloutGraphic(r);r$a(t)&&e.addAuxiliaryGraphic(t);}return e}globalPropertyChanged(r,t){return !!super.globalPropertyChanged(r,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(r,t,(r=>this._getCalloutGraphicLayer(r))))}updateGeometry(r,t){const a=super.updateGeometry(r,t);if(a&&this.calloutSymbolLayer){const a=this._getCalloutGraphicLayer(r);if(a)return this.calloutSymbolLayer.updateGeometry(a,t)}return a}_createCalloutGraphic(r){const t=r.renderingInfo,a={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return r.renderingInfo=a,this.calloutSymbolLayer.createGraphics3DGraphic(r)}_getCalloutGraphicLayer(r){for(const t of r._auxiliaryGraphics)if(t.graphics3DSymbolLayer===this.calloutSymbolLayer)return t}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function t$1(t,i,e){let p;if("point-3d"===t.type)p=s$2;else p=d$4;return new p(t,i,e)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e$2 extends a$7{constructor(t,s,r){super(s),this.symbol=t,this._convert=r,this.graphics3DSymbol=null,this.referenced=0;}getSymbolLayerSize(s){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(s):null}get symbolLayers(){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(s){const r=await this.symbol.fetchSymbol({signal:s});r.id=this.symbol.id,this.graphics3DSymbol=this._convert(r),r$a(this.graphics3DSymbol)&&await this.graphics3DSymbol.load();}createGraphics3DGraphic(s){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(s,this):null}get complexity(){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:b$e}globalPropertyChanged(s,r){return !!r$a(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(s,r)}applyRendererDiff(r,i){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(r,i):e$c.Recreate_Symbol}prepareSymbolPatch(s){r$a(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(s);}updateGeometry(s,r){return !!r$a(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(s,r)}onRemoveGraphic(){}getFastUpdateStatus(){return r$a(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){r$a(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy();}get destroyed(){return void 0===this.graphics3DSymbol}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s$1{constructor(t){this._graphicsCore=t,this._idToState=new Map,this._states=new Set;const i=t.owner.layer&&t.owner.layer.objectIdField;i?(this._getGraphicId=t=>O$6(t,i),this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicByObjectId(t)):(this._getGraphicId=t=>t.uid,this._getGraphics3DGraphicById=t=>this._graphicsCore.getGraphics3DGraphicById(t));}destroy(){this._idToState.clear(),this._states.forEach(((t,i)=>this.remove(i)));}add(t){const e={remove:()=>this.remove(t)};if(this._states.has(t))return e;const s=this._getGraphicId(t.graphic),a=this._getGraphics3DGraphicById(s);this._states.has(t)||this._states.add(t);return this._ensureStateList(s).push(t),t.displaying=!!r$a(a)&&a.isVisible(),t.isDraped=!!r$a(a)&&a.isDraped,t.tracking=!0,r$a(a)&&t.emit("changed",{}),e}remove(i){if(this._states.has(i)){if(this._idToState.size){const e=this._getGraphicId(i.graphic),s=this._idToState.get(e);s&&(F$a(s,i),0===s.length&&this._idToState.delete(e));}this._states.delete(i),i.tracking=!1,i.displaying=!1;}}addGraphic(t){this._forEachState(t,(i=>{i.displaying=t.isVisible(),i.isDraped=t.isDraped,i.emit("changed",{});}));}removeGraphic(t){this._forEachState(t,(t=>{t.displaying=!1,t.isDraped=!1;}));}updateGraphicGeometry(t){this._forEachState(t,(t=>{t.emit("changed",{});}));}updateGraphicVisibility(t){this._forEachState(t,(i=>{i.displaying=t.isVisible();}));}allGraphicsDeleted(){this._states.forEach((t=>{t.displaying=!1;}));}_ensureStateList(t){const i=this._idToState.get(t);if(i)return i;const e=new Array;return this._idToState.set(t,e),e}_forEachState(t,i){if(0===this._states.size||0===this._idToState.size)return;const e=this._getGraphicId(t.graphic),s=this._idToState.get(e);null!=s&&s.forEach(i);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let d$3=class extends f$f{constructor(t){super(t),this._index=new h$n(9,has("esri-csp-restrictions")?t=>({minX:t.extent[0],minY:t.extent[1],maxX:t.extent[2],maxY:t.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1;}setup(t){this._addMany(t);}destroy(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null;}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear());}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(t,e,i){!t$9(e)&&e.equals(this.spatialReference)&&(u$2.minX=t[0],u$2.minY=t[1],u$2.maxX=t[2],u$2.maxY=t[3],this.update(),this._index.search(u$2,(t=>i(t.graphic.uid))));}add(t){this._missing.add(t),this.updating=!0;}remove(t){if(this._missing.delete(t))return void(this.updating=this._missing.size>0);this._index.remove(t);const e=O$6(t.graphic,this._get("objectIdField"));null!=e&&this._boundsByFeature.delete(e);}_addMany(t){if(0===t.length)return;const e=this._get("objectIdField");for(const s of t){s.computeExtent(this.spatialReference);const t=O$6(s.graphic,e);null!=t&&this._boundsByFeature.set(t,s.extent);}this._index.load(t);}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1;}forEachInBounds(t,e){u$2.minX=t[0],u$2.minY=t[1],u$2.maxX=t[2],u$2.maxY=t[3],this.update(),this._index.search(u$2,(t=>{e(t);}));}getBounds(t,e){this.update();const s=this._boundsByFeature.get(t);return s?O$c(e,s):null}};e$e([d$f({constructOnly:!0})],d$3.prototype,"spatialReference",void 0),e$e([d$f({constructOnly:!0})],d$3.prototype,"hasZ",void 0),e$e([d$f({constructOnly:!0})],d$3.prototype,"hasM",void 0),e$e([d$f({constructOnly:!0})],d$3.prototype,"objectIdField",void 0),e$e([d$f()],d$3.prototype,"updating",void 0),e$e([d$f({readOnly:!0})],d$3.prototype,"updatingRemaining",null),d$3=e$e([n$d("esri.views.3d.layers.graphics.SpatialIndex2D")],d$3);const u$2={minX:0,minY:0,maxX:0,maxY:0};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const g$1=1;let v$2=class extends(n$f.EventedMixin(f$f)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new t$n;}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=x$d(this.view.state.viewingMode),this.intersector.options.store=t$k.MIN;const e=this._computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))]);}dispose(){this._layerHandes.destroy();}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=L$7(this.layer.spatialReference),o=r$q(e.unit);this.elevationOffset=c$a(e.offset,0)*o/t;}else this.elevationOffset=0;}getElevation(e,t,o,r){if(E[0]=e,E[1]=t,E[2]=o,!this.renderCoordsHelper.toRenderCoords(E,r,E))return s$b.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;const i=this.elevationOffset,n=this.zmin+i,a=this.zmax+i;this.renderCoordsHelper.setAltitude(_$3,a,E),this.renderCoordsHelper.setAltitude(B,n,E);const l=e=>e.metadata&&e.metadata.isElevationSource;return this.intersector.reset(_$3,B,null),this.intersector.intersect(this.intersectLayers,null,g$1,null,l),this.intersector.results.min.getIntersectionPoint(E)?this.renderCoordsHelper.getAltitude(E):null}_objectChanged(e){if(!e.metadata?.isElevationSource||!this.spatialReference)return;B$5(b$2),e.metadata.lastValidElevationBB.isEmpty()||this._expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,b$2);const t=e.boundingVolumeWorldSpace.min,o=e.boundingVolumeWorldSpace.max;this._expandExtent(t,o,b$2),G$3(b$2,x),this.zmin=Math.min(this.zmin,b$2[2]),this.zmax=Math.max(this.zmax,b$2[5]),C.extent=x,C.spatialReference=this.spatialReference,this.emit("elevation-change",C),r$b(e.metadata.lastValidElevationBB.min,t),r$b(e.metadata.lastValidElevationBB.max,o);}_computeLayerExtent(e){return B$5(b$2),e.objects.forAll((e=>this._expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,b$2))),b$2}_expandExtent(e,t,o){for(let r=0;r<8;++r)E[0]=1&r?e[0]:t[0],E[1]=2&r?e[1]:t[1],E[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(E,E,this.spatialReference),h$i(o,E);return o}};e$e([d$f({constructOnly:!0})],v$2.prototype,"layer",void 0),e$e([d$f({constructOnly:!0})],v$2.prototype,"stageLayer",void 0),e$e([d$f({constructOnly:!0})],v$2.prototype,"view",void 0),e$e([d$f({readOnly:!0,aliasOf:"view.spatialReference"})],v$2.prototype,"spatialReference",void 0),v$2=e$e([n$d("esri.views.3d.layers.support.StageLayerElevationProvider")],v$2);const b$2=B$5(),x=D$4(),C={spatialReference:null,extent:x,context:"scene"},E=n$h(),_$3=n$h(),B=n$h();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function e$1(l,x,e){if(t$9(l)||t$9(e))return !1;let u=!0;return i[0]=null!=l.xmin?l.xmin:0,i[1]=null!=l.ymin?l.ymin:0,i[2]=null!=l.zmin?l.zmin:0,u=u&&Un(i,l.spatialReference,0,i,e,0,1),x[0]=i[0],x[1]=i[1],i[0]=null!=l.xmax?l.xmax:0,i[1]=null!=l.ymax?l.ymax:0,i[2]=null!=l.zmax?l.zmax:0,u=u&&Un(i,l.spatialReference,0,i,e,0,1),x[2]=i[0],x[3]=i[1],null==l.xmin&&(x[0]=-1/0),null==l.ymin&&(x[1]=-1/0),null==l.xmax&&(x[2]=1/0),null==l.ymax&&(x[3]=1/0),u}const i=n$h();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var Oe;const Ae=n$h(),je=a$c(),Le="esri.views.3d.layers.graphics.Graphics3DCore",Ve=s$b.getLogger(Le);let Fe=Oe=class extends f$f{constructor(e){super(e),this.propertiesPool=new o$q({computedExtent:w$a},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this.graphicStateTracking=null,this.symbolCreationContext=new e$d(((e,t)=>this._frameTask.schedule(e,t))),this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this.graphicsDrapedUids=new Set,this.graphicsBySymbol=new Map,this.symbolConversionCache=new Map,this.symbols=new Map,this.graphicsWithoutSymbol=new Map,this.graphicsWaitingForSymbol=new Map,this.graphicsUpdateId=0,this._handles=new t$n,this._frameTask=v$j,this.suspendSymbolCleanup=!1,this._viewSpatialReference=null,this.arcadeOnDemand=null,this.rendererChangeAbortController=null,this.elevationInfoChangeAbortController=null,this.setupAbortController=null,this.elevationAlignment=null,this.scaleVisibility=null,this.filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this.featureStore=null,this.deconflictor=null,this.labeler=null,this.objectStates=null,this.viewElevationProvider=null,this.stageLayerElevationProvider=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={},this.pendingUpdates=new Map,this.numberOfGraphics=0,this.numberOfGraphicsProvidingElevation=0,this.pendingAdds=0,this.pendingRemoves=0,this._loadingSymbols=0,this.pendingUpdatesPool=new n$r({allocator:e=>e||new ke,deallocator:e=>(e.clear(),e)}),this.symbolWarningLogged=!1,this.geometryWarningLogged=!1,this.objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new n$r,this.preferredUpdatePolicy=i$k.SYNC,this.forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=void 0,this._startCreateGraphics=!1;}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new d$3({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get effectiveUpdatePolicy(){return r$a(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?i$k.ASYNC:c$a(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}get updating(){return !!(this.graphicsWaitingForSymbol.size>0||this.running||this.elevationAlignment?.updating||r$a(this.scaleVisibility)&&this.scaleVisibility.updating||r$a(this.filterVisibility)&&this.filterVisibility.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}get running(){return this.pendingUpdates.size>0||!!this._spatialIndex?.updating}get suspendedOrOutsideOfView(){return this.owner.suspended||this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this.pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this.elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,s=this.averageSymbolComplexity,a=Math.max(1,r$a(s)?s.primitivesPerFeature:1),n=r$a(s)&&s.drawCallsPerFeature>0?i/s.drawCallsPerFeature*.3:i,o=Math.ceil(r/a),l=Math.max(t,Math.min(i,o,n)),d=this._get("displayFeatureLimit");return d&&d.minimumTotalNumberOfFeatures===t&&d.maximumTotalNumberOfFeatures===i&&d.maximumTotalNumberOfPrimitives===r&&d.averageSymbolComplexity===s&&d.maximumNumberOfFeatures===l?d:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:s,maximumNumberOfFeatures:l}}get averageSymbolComplexity(){const e=y$8(this._symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||r$a(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){const e=r$a(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}get usedMemoryPerGraphic(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if(r$a(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}_getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const t=this.symbolConversionCache.get(e.id);if(r$a(t))return t;const i=a$q(e,{retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=i.symbol||null;return t$9(r)&&i.error&&Ve.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}_getSymbolComplexitiesUsedOrRenderer(e){if(t$9(e))return [];const t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return [];const r=[],s=this._getSymbolComplexityUsedOrRenderer(i);r$a(s)&&r.push(s);for(const a of t){const e=this._getSymbolComplexityUsedOrRenderer(a);r$a(e)&&r.push(e);}return r}_getSymbolComplexityUsedOrRenderer(e){if(t$9(e))return null;const t=this.symbols.get(e.id);if(r$a(t))return t.complexity;const i=this._getConvertedSymbol(e);return r$a(i)?P$7(i):null}_getSymbolComplexitiesUsed(){const e=[];return this.symbols.forEach((t=>{r$a(t)&&e.push(t.complexity);})),e}get _objectIdField(){return this.layer.objectIdField}initialize(){this._viewSpatialReference=this.owner.view.spatialReference,this._set("featureStore",new l$9({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e),toArray:()=>Array.from(this.graphics3DGraphics.values())}));}async setup(e){this.setupAbortController=new AbortController;const t=this.setupAbortController.signal;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates);const i=this.owner.view;this.viewElevationProvider=new n$a(this._viewSpatialReference,i),this._initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),r$a(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new j$f(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=i$l(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await a$r(r,this._viewSpatialReference,Ve),f$d(t),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,"drapeSourceType"in this.owner){const{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=i.basemapTerrain.overlayManager.registerGeometryDrapeSource(e),this._handles.add(n$e((()=>i.basemapTerrain.overlayManager.unregisterDrapeSource(e))));}this._handles.add([l$t((()=>this.suspendedOrOutsideOfView),(()=>this._frameTask.reschedule((()=>this._updateLayerVisibility())))),l$t((()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view.screenSizePerspectiveEnabled]),(()=>{const e=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this.labeler?.reset(),this.recreateAllGraphicsAndSymbols());})),l$t((()=>this.owner.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(!!e))),l$t((()=>this.owner.view.state?.pixelRatio),(()=>this._pixelRatioChange())),l$t((()=>this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._physicalBasedRenderingChange(e))),f$p((()=>i.basemapTerrain?.tilingScheme),(e=>{if(!e.spatialReference.equals(this.symbolCreationContext.overlaySR)&&r$a(i.basemapTerrain.spatialReference)&&(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics"))this.recreateAllGraphics();else {const e=()=>this.owner?.loadedGraphics;this._handles.add([a$s(e,"change",(e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange();}),{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange();}})],"loaded-graphics");}}),{initial:!0}),l$t((()=>this.effectiveUpdatePolicy),(e=>{r$a(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===i$k.ASYNC,e===i$k.SYNC&&this.runTask(G$7);}),w$d)]),this._frameTask=i.resourceController.scheduler.registerTask(A$a.GRAPHICS_CORE,this),this.layer&&"featureReduction"in this.layer&&this._handles.add(l$t((()=>this.layer.featureReduction),(()=>this.deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer);}catch{}f$d(t),this.setupAbortController=null;}_abortSetup(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null);}destroy(){this._abortSetup(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange=a$t(this._updatingPendingLoadedGraphicsChange),this.clear(),this.graphicStateTracking=l$s(this.graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=l$s(this._handles),this._frameTask.remove(),this._frameTask=v$j,this._viewSpatialReference=null,this._set("owner",null);for(const e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new s$d("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=a$t(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=l$s(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=l$s(this._spatialIndex),this._set("featureStore",l$s(this.featureStore));}clear(){this.objectStates?.allGraphicsDeleted(),r$a(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this.symbols.forEach(l$s),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed");}_initializeStage(e,t){this.stage=e._stage,this.stageLayer=new l$u({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);const i=this.stageLayer.events;i.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),i.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("vertexAttrsUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)));}notifyGraphicGeometryChanged(e){if(t$9(this.graphicStateTracking)||t$9(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t);}notifyGraphicVisibilityChanged(e){if(t$9(this.graphicStateTracking)||t$9(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t);}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*Me,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility());}_updateStageLayerVisibility(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0);}getGraphics3DGraphicById(e){return this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer&&this.owner.layer.objectIdField){return O$6(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;const t=new Map;return this.graphics3DGraphics.forEach((i=>{if(!i)return;const r=i.graphic,s=this._getGraphicObjectID(r,e);r$a(s)&&t.set(s,i);})),t}get labelsEnabled(){return !(!this.labeler||!this.labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),i=this.labeler&&this.labeler.labelingInfoChange(e);await E$j([t,i]);}updateVisibilityInfo(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange();}get symbolUpdateType(){if(this.pendingUpdates.size>0)return "unknown";let e=0,t=0;return n$s(this.symbols,((i,r)=>{if(r$a(i)){const s=i.getFastUpdateStatus();if(s.loading>0)return !0;this.graphicsBySymbol.has(r)&&(t+=s.fast,e+=s.slow);}return !1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining");}setObjectIdVisibility(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);r$a(i)&&this._updateUserVisibility(i);}_findGraphics3DGraphicByObjectId(e){return t$o(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(t$9(e))return !1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(t$9(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(C$8.USER_SETTING,r,E$a.GRAPHIC)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=A$b();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){const i=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,s=this.owner.view.basemapTerrain.spatialReference,a=(e,t,s)=>Un(e,r,t,e,i,t,s),n=(e,t,r)=>Un(e,s,t,e,i,t,r),o=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:r$a(t)&&t.useViewElevation,minDemResolution:r$a(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,l=await e.getProjectedBoundingBox(a,n,o,m$9(t,"signal"));if(!l)return null;const p=l.boundingBox;if(l.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){p$9(p,Ae);const t=c$a(e.getElevation(Ae[0],Ae[1],0,i,"ground"),0);p[2]=Math.min(p[2],t),p[5]=Math.max(p[5],t);}}return {boundingBox:p,screenSpaceObjects:l.screenSpaceObjects}}async whenGraphicBounds(e,t){await j$7((()=>this.owner?.loadedGraphics));const i=this.owner.layer&&this.owner.layer.objectIdField,s=this.owner.loadedGraphics.find((t=>t===e||i&&t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i]));if(!s)throw new s$d("internal:graphic-not-part-of-view","Graphic is not part of this view");const a=await this._whenGraphics3DGraphic(s);return this._boundsForGraphics3DGraphic(a,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;o$6(We,0,0,0);let s=0;if(r.render.num>0){if(!Bn(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Ne,t))return null;u$c(We,We,Ne),s++;}if(r.draped.num>0){const[e,i]=r.draped.origin,a=c$a(this.viewElevationProvider.getElevation(e,i,"ground"),0);if(o$6(Ne,e,i,a),!Bn(Ne,this.viewElevationProvider.spatialReference,Ne,t))return null;u$c(We,We,Ne),s++;}return s>1&&g$f(We,We,1/s),new b$m({x:We[0],y:We[1],z:We[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this.symbols.get(e.id);if(t$9(i))throw new s$d("internal:symbol-not-part-of-view","Symbol is not part of this view");const s=e.symbolLayers.indexOf(t);if(-1===s)throw new s$d("internal:missing-symbol-layer","Symbol layer is not in symbol");const a=i.getSymbolLayerSize(s);if(null==a)throw new s$d("internal:missing-size","Symbol layer has no valid size");return a}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed));}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!t$9(i)||!t$9(this.graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e);}}_graphicUpdateGeometryHandler(e,t){const i=t.graphic.geometry;if(t$9(i))return void this._recreateGraphic(t.graphic);if(t$9(e)){const e=t.graphic.symbol&&t.graphic.symbol.id;if(e){const t=this.symbols.get(e);if(r$a(t)&&t.loadStatus===e$b.LOADING)return}return void this._recreateGraphic(t.graphic)}const r=e.graphics3DSymbol;!t$9(t.newValue)&&r.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i);}_graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=r$a(e)?e.graphics3DSymbol:r$a(t.oldValue)?this.symbols.get(t.oldValue.id):null;if(t$9(r)||t$9(t.newValue))return void this._recreateGraphic(i);const s=r.symbol,a=this._getConvertedSymbol(t.newValue);if(r$a(a)&&(a.type!==s.type||"web-style"===a.type)||"web-style"===s.type)return void this._recreateGraphic(i);const n=this.graphicsBySymbol.get(s.id);if(n&&1!==n.size)return void this._recreateGraphic(i);const o=m$i(s,a);if(t$9(o))return void this._updateSymbolMapping(s.id,a);const l={diff:o,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!d$r(l.diff))return void this._recreateGraphic(i);const d=this._getRenderingInfo(i);if(t$9(d))return void this._recreateGraphic(i);const c=r.extentPadding;for(const h of l.symbolStatePatches)h();if(c!==r.extentPadding&&this._recomputeExtentPadding(),r$a(e))for(const h of l.graphics3DGraphicPatches)h(e,d);this._updateSymbolMapping(s.id,a);}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty());}_graphicUpdateTransformHandler(e,t){}recreateGraphics(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===i$k.SYNC&&this._cleanupSymbols();}_recreateGraphic(e){this.recreateGraphics([e]);}_beginGraphicUpdate(e){const t=this.graphicsUpdateId;return this.graphicsUpdateId++,this.graphicsWaitingForSymbol.set(e.uid,t),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}_endGraphicUpdate(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")));}_recomputeExtentPadding(){let e=0;this.symbols.forEach((t=>{r$a(t)&&(e=Math.max(e,t.extentPadding));})),this._set("extentPadding",e);}_expandComputedExtent(e){const t=je,i=e.spatialReference;T$8(e,t);const r=this._viewSpatialReference,s=Oe.tmpVec;if(E$d(i,r)||gn(t[0],t[1],0,i,s,r)&&(t[0]=s[0],t[1]=s[1],gn(t[3],t[4],0,i,s,r),t[3]=s[0],t[4]=s[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const a=this.computedExtent;let n=null;const o=isFinite(t[2])&&isFinite(t[5]),l=o&&(!a||null==a.zmin||t[2]<a.zmin),h=o&&(!a||null==a.zmax||t[5]>a.zmax);if(a){(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||l||h)&&(n=this.propertiesPool.get("computedExtent"),n.xmin=Math.min(t[0],a.xmin),n.ymin=Math.min(t[1],a.ymin),n.xmax=Math.max(t[3],a.xmax),n.ymax=Math.max(t[4],a.ymax),n.spatialReference=r);}else n=this.propertiesPool.get("computedExtent"),n.xmin=t[0],n.ymin=t[1],n.xmax=t[3],n.ymax=t[4],n.spatialReference=r;n&&(l&&(n.zmin=t[2]),h&&(n.zmax=t[5]),this._set("computedExtent",n));}_abortElevationInfoChange(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null);}async elevationInfoChange(){this._abortElevationInfoChange();const e=new AbortController;this.elevationInfoChangeAbortController=e;const t=i$l(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await a$r(t,this._viewSpatialReference,Ve),f$d(e),this.elevationInfoChangeAbortController=null,this.labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelGraphics;for(const r of i){r.graphics3DSymbolLayer.updateGraphicElevationContext(t,r);}})):this._recreateSymbol(i);})),this.updateStageLayerElevationProvider(),this.elevationAlignment?.elevationInfoChange();}updateStageLayerElevationProvider(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new v$2({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider));}_clearSymbolsAndGraphics(){this.clear(),r$a(this.filterVisibility)&&this.filterVisibility.clear(),this.labeler?.reset(),this.deconflictor?.clear(),this.elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null);}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics();}recreateAllGraphics(){this._recreateAllGraphics(!1);}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0);}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:i}=this.owner,r=i.basemapTerrain.tilingScheme&&t&&t.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r));}_recreateSymbol(e){const t=this.graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{const r=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),i.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,r),this._updateLayerVisibility(),this.featureStore.events.emit("changed");})),this.graphicsBySymbol.set(e,new Map));const r=this.symbols.get(e);l$s(r),this.symbols.delete(e),this.add(i);}_recreateGraphicsForSymbol(e){const t=this.graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e);}}_conditionalRemove(e,t){this.graphicsDrapedUids.delete(t),this.objectStates?.removeGraphic(e),this.labeler?.removeGraphic(e),this.deconflictor?.removeGraphic(e),r$a(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e);}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===i$k.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):Ve.error("#add()","Cannot add graphics before terrain surface has been initialized"));}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===i$k.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(r$a(t.geometry)&&"mesh"===t.geometry.type&&!t.geometry.loaded)return i$k.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,Ve),i$k.SYNC);this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty();}_addDelayed(e){for(const t of e){const e=t.uid;let i=this.pendingUpdates.get(e);i?i.add?i.state!==Te.NEW&&i.abortController.abort():this.pendingAdds++:(i=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(e,i)),i.add=t;}this.notifyChange("running"),this.notifyChange("updatingRemaining");}remove(e){this.effectiveUpdatePolicy===i$k.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating");}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty();}_removeDelayed(e){for(const t of e){const e=t.uid,i=this.pendingUpdates.get(e);if(i)i.add&&(i.remove?i.add=null:this.pendingUpdates.delete(e),i.state===Te.LOADING&&i.abortController.abort(),this.pendingAdds--);else {const i=this.pendingUpdatesPool.pushNew();i.remove=t,this.pendingUpdates.set(e,i),this.pendingRemoves++;}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining");}_finishPendingUpdates(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&Ve.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0;}_applyPendingUpdates(e){if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update();else {for(const[t,i]of this.pendingUpdates){if(e.done)break;i.add&&i.state===Te.NEW&&this._processPendingUpdateNew(i);let r=this.effectiveUpdatePolicy;if(!i.remove||i.add&&i.state!==Te.READY||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,r=i$k.SYNC),i.add)switch(i.state){case Te.READY:this._addGraphic(i.add,i.renderingInfo,r),i.add=null,this.pendingAdds--,e.madeProgress();break;case Te.REJECTED:i.add=null,this.pendingAdds--;case Te.LOADING:}null==i.remove&&null==i.add&&this.pendingUpdates.delete(t);}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"));}}_processPendingUpdateNew(e){if(!e.add)return void(e.state=Te.READY);const t=e.add.geometry;r$a(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e);}async _processPendingUpdateNewMesh(e,t){e.state=Te.LOADING,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i});}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e);}_processPendingUpdateNewError(e,t){e.abortController=null,j$9(t)?e.state=Te.NEW:e.state=Te.REJECTED;}async _processPendingUpdateNewRenderingInfo(e){if(t$9(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,Ve),void(e.state=Te.READY);e.state=Te.LOADING,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal});}catch(i){return e.abortController=null,void(j$9(i)?e.state=Te.NEW:e.state=Te.REJECTED)}t$9(t)||t$9(t.symbol)?(Ve&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=Te.READY;}_addGraphic(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),t$9(t)||t$9(t.symbol)||!M$8(e))return;const r=t.symbol,s=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(t$9(s))return;this._expandComputedExtent(e.geometry);const a=this._beginGraphicUpdate(e),n=new r$9(e,t,this.layer);let o=!1;const l=e=>{e===s.symbol.id&&(o=!0);};this._whenSymbolRemoved.push(l);const d=()=>{if(--this._loadingSymbols,this.destroyed)return;this._whenSymbolRemoved.removeUnordered(l);if(this.graphicsWaitingForSymbol.get(e.uid)!==a||o||s.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==s.symbol.id)--s.referenced,this._cleanupSymbols();else {const t=this._createGraphics3DGraphic(s,n);this._spatialIndex&&r$a(t)&&this._spatialIndex.add(t),--s.referenced,this._endGraphicUpdate(e);}this.featureStore.events.emit("changed"),this.labeler&&this.owner.view.labeler.setDirty();},c=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),o||(j$9(t)?this.add([e]):s.destroyed||this._endGraphicUpdate(e)));};++this._loadingSymbols,i===i$k.ASYNC?s.load((()=>this._frameTask.schedule(d)),(e=>this._frameTask.schedule((()=>c(e))))):s.load(d,c);}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,r=i.isElevationSource;this._conditionalRemove(i,t),this._spatialIndex?.remove(i);const s=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(s).delete(t),this.graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,r),i.destroy(),this.featureStore.events.emit("changed");}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"));}_hasLabelingContext(e){if(e instanceof b$n||e instanceof m$j){const t=this.symbolCreationContext.layer;return !!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return !1}_hasValidSymbolCreationContext(e){return !(e instanceof b$n&&!this._hasLabelingContext(e))||(Ve.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e,t){const i=e.geometry;if(t$9(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!An(i.spatialReference,this._viewSpatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&r$a(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?f$q(e,this.layer):e;let s;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||r$a(this.currentRenderer)))s=this.owner.getRenderingInfo(r,this.currentRenderer,e$h(this.arcadeOnDemand));else {s={symbol:r.symbol||b$g(r.geometry)};}return t$9(s)||t$9(s.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):s}_getRenderingInfoAsync(e,t){const i=e.geometry;if(t$9(i))return Ve&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&r$a(e.symbol))return Ve&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,Ve.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?f$q(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,e$h(this.currentRenderer),e$h(this.arcadeOnDemand),t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const i=this._getConvertedSymbol(e);if(!i)return null;let r;if(r$a(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=a$q(t.backgroundFillSymbol,{ignoreDrivers:!0});r$a(e.symbol)&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers);}const s=t$1(i,this.symbolCreationContext,r);return s.load((()=>{const e=s.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity");}),(()=>{})),s}getOrCreateGraphics3DSymbol(e,t){let i=this.symbols.get(e.id);return void 0===i&&(i=e instanceof f$r?new e$2(e,(e=>this._frameTask.schedule(e)),(e=>this._createGraphics3DSymbol(e,t))):this._createGraphics3DSymbol(e,t),this.symbols.set(e.id,i)),r$a(i)&&++i.referenced,i}trackGraphicState(e){return t$9(this.graphicStateTracking)&&(this.graphicStateTracking=new s$1(this)),this.graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility();}_removeGraphics3DGraphic(e,t,i=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility();}_createGraphics3DGraphic(e,t){const i=t.graphic;if(this.graphicsWithoutSymbol.delete(i.uid),!this.symbols.has(e.symbol.id))return this.add([i]),null;if(this.graphics3DGraphics.has(i.uid))return null;const r=e.createGraphics3DGraphic(t);if(t$9(r))return null;this._addGraphics3DGraphic(r);const s=e.symbol.id;this.graphicsBySymbol.has(s)||this.graphicsBySymbol.set(s,new Map),this.graphicsBySymbol.get(s).set(i.uid,r);if(r.isDraped&&this.graphicsDrapedUids.add(i.uid),r.centroid=null,r$a(i.geometry)&&"point"!==i.geometry.type&&(r.centroid=A$7(i.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),r$a(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(r),r$a(this.filterVisibility)){const{defaultVisibility:e}=this.filterVisibility;r.setVisibilityFlag(C$8.FILTER,e,E$a.GRAPHIC),e||this.filterVisibility.reapply();}this.deconflictor?.addGraphic(r),this.labeler?.addGraphic(r),this.objectStates?.addGraphic(r),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,r),r.initialize(this.stage,this.stageLayer,this.owner),r$a(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(r);const a=this.whenGraphics3DGraphicRequests[i.uid];return a&&(delete this.whenGraphics3DGraphicRequests[i.uid],a.resolve(r)),r}_abortRendererChange(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null);}async rendererChange(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),t$9(e)&&this._currentRendererChange(null,!1),o$r(e))if(r$a(e)&&e.arcadeRequired){const t=new AbortController;this.rendererChangeAbortController=t;const{arcadeUtils:i}=await this._ensureArcade();f$d(t),i.hasGeometryOperations(e)&&(await i.enableGeometryOperations(),f$d(t)),this.effectiveUpdatePolicy===i$k.ASYNC?await this._frameTask.schedule((()=>this._currentRendererChange(e,!0)),t.signal):this._currentRendererChange(e,!0),this.rendererChangeAbortController=null;}else if(this.effectiveUpdatePolicy===i$k.ASYNC){const t=new AbortController;this.rendererChangeAbortController=t,await this._frameTask.schedule((()=>this._currentRendererChange(e,!1)),t.signal),this.rendererChangeAbortController=null;}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1);}async _ensureArcade(){return t$9(this.arcadeOnDemand)?(this.arcadeOnDemand=await a$u(),this.arcadeOnDemand):this.arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=e$h(this.arcadeOnDemand);const i=this.symbolCreationContext.renderer;if(e===i)return;if(this.symbolConversionCache.clear(),t$9(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=m$i(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,t$9(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"));}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return !0}return !1}_applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const s of t){const t=this.graphicsBySymbol.get(s.id);t&&t.forEach(((a,n)=>{const o=a.graphic,l=this.layer instanceof b$o?this.layer:null,h=e$h(this.arcadeOnDemand);if(s===i.defaultSymbol&&i.getSymbol(f$q(o,l),{arcade:h})===i.defaultSymbol)return;const d=a.usedMemory;e.length||i.defaultSymbol?r.push(o):this.graphicsWithoutSymbol.set(n,o);const p=this.graphics3DGraphics.get(n);this._conditionalRemove(p,n),a.destroy(),t.delete(n),this._removeGraphics3DGraphic(n,d),this._updateLayerVisibility();})),this._whenSymbolRemoved.forAll((e=>e(s.id)));}(e.length||r.length)&&(this.graphicsWithoutSymbol.forEach((e=>r.push(e))),this.graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty();}_applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,s=e.diff.uniqueValueInfos;if(r||s){const a=s?s.added.map((e=>e.symbol)):[],n=s?s.removed.map((e=>e.symbol)):[];if(s)for(let e=0;e<s.changed.length;e++)a.push(s.changed[e].newValue.symbol),n.push(s.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&n.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&n.push(t.defaultSymbol),this._applySymbolSetDiff(a,n,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return !1}_calculateUnchangedSymbolMapping(e,t,i){if("unique-value"!==t?.type||"unique-value"!==i?.type||r$a(e)&&"partial"!==e.type)return [];const r=e=>r$a(e)?e.id:null,s=e&&e.diff,a=s&&s.defaultSymbol,n=s&&s.uniqueValueInfos;let o;if(n)o=n.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else {o=[];for(const e of i.uniqueValueInfos){const i=r(e.symbol),s=t.uniqueValueInfos.find((t=>t.value===e.value));s&&i!==r(s.symbol)&&o.push({oldId:i,newId:r(s.symbol)});}}return !a&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}_updateSymbolMapping(e,t){const i=r$a(t)&&t?"string"==typeof t?t:t.id:null;if(!e||e===i)return;const r=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==r&&this.graphicsBySymbol.set(i,r);const s=this.symbols.get(e);if(void 0!==s&&(this.symbols.delete(e),this.symbols.set(i,s),r$a(s))){const e="string"==typeof t?null:t;r$a(e)?s.symbol=e:s.symbol.id=i;}}_updateUnchangedSymbolMappings(e,t,i){const r=this._calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:s,newId:a}of r)this._updateSymbolMapping(s,a);}_applyRendererDiff(e,i,r){if(this._diffHasSymbolChange(e))return !1;if(i instanceof $$4&&r instanceof $$4&&this._applyUniqueValueRendererDiff(e,i,r)&&0===Object.keys(e.diff).length)return !0;for(const[t]of this.graphicsBySymbol){const r=this.symbols.get(t);if(r$a(r))switch(r.applyRendererDiff(e,i)){case e$c.Recreate_Symbol:this._recreateSymbol(t);break;case e$c.Recreate_Graphics:this._recreateGraphicsForSymbol(t);case e$c.Fast_Update:}}return !0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this._updateStageLayerVisibility();}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange());}_physicalBasedRenderingChange(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i);})));}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i);}));}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=v$k((()=>{this._updatingPendingLoadedGraphicsChange=null;}));}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=u$i();return e$1(e,r,t)?this.symbolCreationContext.clippingExtent=O$c(a$c(),r):this.symbolCreationContext.clippingExtent=null,!k$a(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){let t=!1;this.graphics3DGraphics.forEach((i=>{e(i)&&(t=!0);})),t&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty());}forEachGraphics3DSymbol(e){for(const[t,i]of this.symbols){if(t$9(i))return;e(i,this.graphicsBySymbol.get(t)||ze,t);}}updateAllGraphicsVisibility(){r$a(this.filterVisibility)&&this.filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=r$a(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(e);return t||i}));}setAllFeaturesVisibility(e){this.modifyGraphics3DGraphicVisibilities((t=>t.setVisibilityFlag(C$8.FILTER,e,E$a.GRAPHIC)));}clearFeaturesVisibility(){this.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(C$8.FILTER)));}getObjectId(e){return O$6(e.graphic,this._objectIdField)}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(C$8.USER_SETTING,!1,E$a.GRAPHIC)));}_validateRenderer(e){const t=t$p(e);if(t){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;Ve.warn(e,t.message);}}_volatileGraphicsUpdated(){this.labeler?.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating");}_cleanupSymbols(){if(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)return;let e=!1;this.symbols.forEach(((t,i)=>{if(t$9(t)||t.referenced>0)return;const r=this.graphicsBySymbol.get(i);r&&0!==r.size||(this.graphicsBySymbol.delete(i),this.symbols.delete(i),l$s(t),e=!0);})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"));}get test(){return {snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this.graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}),symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:e=>{this.forcedUpdatePolicy=e;}}}get performanceInfo(){return {visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}};var Te;Fe.tmpVec=n$h(),e$e([d$f({readOnly:!0})],Fe.prototype,"computedExtent",void 0),e$e([d$f()],Fe.prototype,"currentRenderer",void 0),e$e([d$f()],Fe.prototype,"rendererHasGeometryOperations",void 0),e$e([d$f()],Fe.prototype,"_frameTask",void 0),e$e([d$f()],Fe.prototype,"rendererChangeAbortController",void 0),e$e([d$f()],Fe.prototype,"elevationInfoChangeAbortController",void 0),e$e([d$f()],Fe.prototype,"setupAbortController",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"elevationAlignment",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"scaleVisibility",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"filterVisibility",void 0),e$e([d$f()],Fe.prototype,"_spatialIndex",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"extentPadding",void 0),e$e([d$f()],Fe.prototype,"_updatingPendingLoadedGraphicsChange",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"featureStore",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"deconflictor",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"labeler",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"objectStates",void 0),e$e([d$f()],Fe.prototype,"_loadingSymbols",void 0),e$e([d$f()],Fe.prototype,"preferredUpdatePolicy",void 0),e$e([d$f()],Fe.prototype,"forcedUpdatePolicy",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"effectiveUpdatePolicy",null),e$e([d$f({constructOnly:!0})],Fe.prototype,"elevationFeatureExpressionEnabled",void 0),e$e([d$f({constructOnly:!0})],Fe.prototype,"owner",void 0),e$e([d$f({constructOnly:!0})],Fe.prototype,"layer",void 0),e$e([d$f({constructOnly:!0})],Fe.prototype,"graphicSymbolSupported",void 0),e$e([d$f({constructOnly:!0})],Fe.prototype,"getRenderingInfoWithoutRenderer",void 0),e$e([d$f({readOnly:!0})],Fe.prototype,"updating",null),e$e([d$f({readOnly:!0})],Fe.prototype,"running",null),e$e([d$f({readOnly:!0})],Fe.prototype,"suspendedOrOutsideOfView",null),e$e([d$f({readOnly:!0,dependsOn:[]})],Fe.prototype,"updatingRemaining",null),e$e([d$f({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],Fe.prototype,"displayFeatureLimit",null),e$e([d$f({readOnly:!0,dependsOn:[]})],Fe.prototype,"averageSymbolComplexity",null),e$e([d$f({constructOnly:!0})],Fe.prototype,"hasZ",void 0),e$e([d$f({constructOnly:!0})],Fe.prototype,"hasM",void 0),e$e([d$f()],Fe.prototype,"_objectIdField",null),Fe=Oe=e$e([n$d(Le)],Fe),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED";}(Te||(Te={}));class ke{constructor(){this.add=null,this.renderingInfo=null,this.state=Te.NEW,this.remove=null;}clear(){this.add=null,this.renderingInfo=null,this.state=Te.NEW,this.abortController=null,this.remove=null;}}const Me=10,We=n$h(),Ne=n$h(),ze=new Map;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const _$2=.05;class a{constructor(){this._extents=new n$r({allocator:t=>t||u$i()}),this._tmpExtent=u$i(),this._dirty=!1;}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear();}add(t){this._contains(t)||(this._removeContained(t),a$v(this._extents.pushNew(),t),this._dirty=!0);}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(t){return this._mergeTight(t),t.hasProgressed}_mergeTight(t=G$7){const e=this._extents,o=new Set;let i=0;for(;i!==e.length;){e.sort(((t,e)=>t[0]-e[0])),i=e.length,o.clear();for(let i=0;i<e.length;++i){if(t.done)return;const h=e.getItemAt(i);for(let t=i+1;t<e.length;++t){const r=e.getItemAt(t);if(r[0]>=h[2])break;o.add(r);}o.forEach((i=>{if(h===i)return;if(i[2]<=h[0])return void o.delete(i);const a=y$b(h),c=y$b(i),g=this._tmpExtent;h$o(h,i,g);const m=a+c;(y$b(g)-m)/m<_$2&&(a$v(h,g),o.delete(i),e.remove(i),t.madeProgress());})),o.add(h);}}this._dirty=!1;}_contains(t){return this._extents.some((e=>R$c(e,t)))}_removeContained(t){this._extents.filterInPlace((e=>!R$c(t,e)));}get test(){const t=this;return {containsPoint:e=>t._extents.some((t=>b$p(t,e)))}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let d$2=class extends f$f{constructor(){super(...arguments),this.dirtyExtents=new a,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new t$n,this.updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new n$f;}setup(e,t,i,s){this.graphicsCoreOwner=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=s;const r=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add([s.on("elevation-change",(e=>this._elevationChanged(e))),l$t((()=>this.graphicsCoreOwner.suspended),(()=>this._suspendedChange())),r.registerTask(A$a.ELEVATION_ALIGNMENT,this)]);}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null;}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating");}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this.updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"));}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating");}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this._markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating");}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===i$k.ASYNC;for(const s of this.dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(s);if(this.dirtyGraphicsSet.delete(s),r$a(a)&&(a.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const s=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);r$a(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e);})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-s)+.9*this.averageExtentUpdateSize,e.madeProgress();}}_markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)));}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.graphicsCoreOwner.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0);}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating");}};e$e([d$f({readOnly:!0})],d$2.prototype,"updating",null),e$e([d$f({readOnly:!0})],d$2.prototype,"updatingRemaining",null),d$2=e$e([n$d("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],d$2);const l$2=d$2;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function h$1(r,n,t,i){return b$1(r,n,t,k$1(i,n,t,!0))}const g={dir:n$h(),len:0,clip:n$k()};function k$1(r,n,i,s){const f=g;return r?(i&&s&&(f.len=x$e(n,i)),r$b(f.dir,r)):s?(f.len=x$e(n,i),e$p(f.dir,i,n),g$f(f.dir,f.dir,1/f.len)):(e$p(f.dir,i,n),z$5(f.dir,f.dir)),f}function v$1(r,t,i){const e=P$a(Z$1(r),i.dir),c=-W$4(r,t);if(c<0&&e>=0)return !1;if(e>-1e-6&&e<1e-6)return c>0;if((c<0||e<0)&&!(c<0&&e<0))return !0;const u=c/e;return e>0?u<i.clip[1]&&(i.clip[1]=u):u>i.clip[0]&&(i.clip[0]=u),i.clip[0]<=i.clip[1]}function b$1(r,n,t,i){i.clip[0]=0,i.clip[1]=t?i.len:Number.MAX_VALUE;for(let e=0;e<r.length;e++)if(!v$1(r[e],n,i))return !1;return !0}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const F=.5*Math.PI,N=F/Math.PI*180;class _$1{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:n$h(),direction:n$h()};for(let e=0;e<4;e++)this.extent[e]={origin:n$h(),direction:n$h(),cap:{next:null,direction:n$h()}},this.planes[e]=p$h();this.planes[k$b.NEAR]=p$h(),this.planes[k$b.FAR]=p$h(),this.planesWithoutFar=this.planes.slice(0,5);}update(t,e,i,r=!0){const a=this.extent;this._toRenderBoundingExtent(t,e,i),u$c(this.center.origin,a[0].origin,a[2].origin),g$f(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||g$f(this.center.direction,this.center.direction,-1);for(let n=0;n<4;n++){const t=a[n];this.renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);const e=a[3===n?0:n+1];t.cap.next=e.origin,H$4(t.cap.direction,t.origin,e.origin),O$d(t.direction,t.cap.direction,t.origin,this.planes[n]),r||g$f(t.direction,t.direction,-1);}O$d(a[0].cap.direction,a[1].cap.direction,a[0].origin,this.planes[k$b.NEAR]),r?P$b(this.planes[k$b.NEAR],this.planes[k$b.FAR]):(A$c(this.planes[k$b.FAR],this.planes[k$b.NEAR]),P$b(this.planes[k$b.NEAR],this.planes[k$b.NEAR])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=e,this.minGlobalAltitude=.9*u$o(this.maxSpanSpatialReference).radius;}isVisibleInFrustum(t,e,i=!1){if(null==t)return !1;if(this.renderCoordsHelper.viewingMode===l$e.Global){const i=this.maxSpanSpatialReference.isGeographic?N:F*e;if(this.maxSpan>i)return !0;if(t.altitude>=this.minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(0===this.maxSpan){const e=this.extent[0];return !(i||!t.intersectsRay(j$d(e.origin,e.direction)))}for(let n=0;n<this.extent.length;n++){const e=this.extent[n];if(!i&&t.intersectsRay(j$d(e.origin,e.direction)))return !0;if(t.intersectsLineSegment(l$v(e.origin,e.cap.next,V),e.cap.direction))return !0}const r=i?this.planes:this.planesWithoutFar;for(let n=0;n<t.lines.length;n++){const e=t.lines[n];if(h$1(r,e.origin,e.endpoint,e.direction))return !0}return !1}_toRenderBoundingExtentGlobal(t,r,n){const o=5;p$i(t,v),v[2]=n,qn(r,v,I,this.renderCoordsHelper.spatialReference),h$g(U,I),B$5(L);for(const{x0:i,x1:s,y0:c,y1:p}of k)for(let l=0;l<o;l++){const h=l/(o-1);v[0]=s$k(t[i],t[s],h),v[1]=s$k(t[c],t[p],h),v[2]=n,Bn(v,r,v,this.renderCoordsHelper.spatialReference),O$8(v,v,U),h$i(L,v);}o$6(this.extent[0].origin,L[0],L[1],L[2]),o$6(this.extent[1].origin,L[3],L[1],L[2]),o$6(this.extent[2].origin,L[3],L[4],L[2]),o$6(this.extent[3].origin,L[0],L[4],L[2]);for(let e=0;e<4;++e)O$8(this.extent[e].origin,this.extent[e].origin,I);}_toRenderBoundingExtentLocal(t,e,i){zn(t,e,P$1,this.renderCoordsHelper.spatialReference),o$6(this.extent[0].origin,P$1[0],P$1[1],i),o$6(this.extent[1].origin,P$1[2],P$1[1],i),o$6(this.extent[2].origin,P$1[2],P$1[3],i),o$6(this.extent[3].origin,P$1[0],P$1[3],i);}_toRenderBoundingExtent(e,i,r){switch(this.renderCoordsHelper.viewingMode){case l$e.Global:this._toRenderBoundingExtentGlobal(e,i,r);break;case l$e.Local:this._toRenderBoundingExtentLocal(e,i,r);break;default:n$i(this.renderCoordsHelper.viewingMode);}}_isVisibleInFrustumGlobal(t){if(W$4(t.planes[k$b.NEAR],this.center.origin)<0&&P$a(this.center.direction,t.direction)<0)return !0;for(let e=0;e<4;e++){const i=this.extent[e];if(W$4(t.planes[k$b.NEAR],i.origin)<0&&P$a(i.direction,t.direction)<0)return !0}return !1}}const k=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],v=n$h(),I=e$g(),U=e$g(),L=a$c(),P$1=u$i(),V=v$l();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const l$1=1.2;let u$1=class extends f$f{constructor(){super(...arguments),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this._handles=new t$n,this._graphicsCoreOwner=null,this.updating=!0;}setup(e){this._graphicsCoreOwner=e,this._extentIntersection=new _$1({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,s=t.basemapTerrain,o=t.resourceController.scheduler;this._handles.add([t.on("resize",(()=>this._viewChange())),l$t((()=>t.state.camera),(()=>this._viewChange()),U$8),o.registerTask(A$a.FRUSTUM_VISIBILITY,this),s.on("elevation-bounds-change",(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([l$t((()=>[s.baseOpacity,s.wireframe,t.map?.ground?.navigationConstraint?.type]),(()=>this._updateIsVisibleBelowSurface()),h$p)]);}destroy(){this._graphicsCoreOwner=null,this._extent=null,this._extentIntersection=null,this._handles&&(this._handles.destroy(),this._handles=null);}_setDirty(){this.updating||this._set("updating",!0);}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty();}_viewChange(){this._setDirty();}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0;}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0;}_updateIsVisibleBelowSurface(){const e=this._graphicsCoreOwner.view,t=e.basemapTerrain,s="local"===e.viewingMode,i=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this._isVisibleBelowSurface=s||!t.opaque||i;}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const e=this._graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurfaceInternal)t=-.3*u$o(e.spatialReference).radius;else {const{min:s,max:i}=e.basemapTerrain.elevationBounds;t=s-Math.max(1,(i-s)*(l$1-1));}this._extentIntersection.update(this._extent,e.spatialReference,t);}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this._extent)return void this._set("suspended",!1);this._updateExtentIntersection();const e=this._graphicsCoreOwner.view.frustum,t=u$o(this._graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(e,t));}};e$e([d$f({readOnly:!0})],u$1.prototype,"suspended",void 0),e$e([d$f({readOnly:!0})],u$1.prototype,"updating",void 0),u$1=e$e([n$d("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],u$1);const d$1=u$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var t;!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT";}(t||(t={}));class r{constructor(){this.items=[];}addObject(e,r){this.items.push({type:t.Object,objectStateId:r,object:e});}addRenderGeometry(e,r,o){this.items.push({type:t.RenderGeometry,objectStateId:r,renderGeometry:e,owner:o});}addExternal(e,r){this.items.push({type:t.External,objectStateId:r,remove:e});}remove(e){for(let t=this.items.length-1;t>=0;--t){const r=this.items[t];r.objectStateId===e&&(this._removeObjectStateItem(r),this.items.splice(t,1));}}removeObject(e){for(let r=this.items.length-1;r>=0;--r){const o=this.items[r];o.type===t.Object&&o.object===e&&(this._removeObjectStateItem(o),this.items.splice(r,1));}}removeRenderGeometry(e){for(let r=this.items.length-1;r>=0;--r){const o=this.items[r];o.type===t.RenderGeometry&&o.renderGeometry===e&&(this._removeObjectStateItem(o),this.items.splice(r,1));}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e);})),this.items=[];}_removeObjectStateItem(r){switch(r.type){case t.Object:r.objectStateId.channel===u$d.Highlight?r.object.removeHighlight(r.objectStateId):r.objectStateId.channel===u$d.MaskOccludee&&r.object.removeOcclude(r.objectStateId);break;case t.RenderGeometry:r.owner.removeRenderGeometryObjectState(r.renderGeometry,r.objectStateId);break;case t.External:r.remove(r.objectStateId);}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class e{constructor(e,i){this.stateType=e,this.objectIdField=i,this.objectStateSet=new r,this.ids=new Set,this.paused=!1;}hasGraphic(t){if(this.objectIdField){const e=t.graphic.attributes[this.objectIdField];return this.ids.has(e)}return this.ids.has(t.graphic.uid)}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class s{constructor(t){this._graphicsCore=t,this._stateSets=new Array;}destroy(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll())),this._stateSets=null;}acquireSet(s,a){const i=new e(s,a);this._stateSets.push(i);const h=n$e((()=>this.releaseSet(i)));return {set:i,handle:h}}releaseSet(t){t.objectStateSet.removeAll();const e=this._stateSets?this._stateSets.indexOf(t):-1;-1!==e&&this._stateSets.splice(e,1);}_addObjectStateSet(t,e){t.addObjectStateSet(e.stateType,e.objectStateSet);}_removeObjectStateSet(t,e){t.removeObjectState(e.objectStateSet);}setUid(t,e){t.ids.add(e);const s=this._graphicsCore.graphics3DGraphics.get(e);s&&this._addObjectStateSet(s,t);}setUids(t,e){e.forEach((e=>this.setUid(t,e)));}setObjectIds(t,e){e.forEach((e=>t.ids.add(e))),this._initializeSet(t);}addGraphic(t){this._stateSets.forEach((e=>{!e.paused&&e.hasGraphic(t)&&this._addObjectStateSet(t,e);}));}removeGraphic(t){this._stateSets.forEach((e=>{e.hasGraphic(t)&&this._removeObjectStateSet(t,e);}));}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((t=>t.objectStateSet.removeAll()));}_initializeSet(t){const e=this._graphicsCore.graphics3DGraphics;t.objectIdField?e.forEach((e=>{e&&t.hasGraphic(e)&&this._addObjectStateSet(e,t);})):t.ids.forEach((s=>{const a=e.get(s);a&&this._addObjectStateSet(a,t);}));}get test(){return {states:this._stateSets}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const d=s$b.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");let y=class extends f$f{constructor(){super(...arguments),this._scaleRangeActive=!1,this.layerScaleRangeVisibilityQuery=!1,this.handles=new t$n,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.extent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this.updating=!0;}setup(e,i,t,s,r){this.graphicsCoreOwner=e,this.layer=i,this.queryGraphicUIDsInExtent=t,this.graphicsCore=s,this.basemapTerrain=r,this.updateScaleRangeActive();const a=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(a.registerTask(A$a.SCALE_VISIBILITY,this));}destroy(){this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null;}_setDirty(){this.updating||this._set("updating",!0);}setExtent(e){const i=this.graphicsCoreOwner.view.spatialReference,t=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(i===t)this.extent=e;else {const s=u$i();zn(e,i,s,t)?this.extent=s:this.extent=null;}this._setDirty();}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,i=e.effectiveScaleRange;let t=this.layerScaleEnabled&&b(i.minScale,i.maxScale);e.labelingInfo&&!t&&(t=e.labelingInfo.some((e=>e&&b(e.minScale,e.maxScale))));const s=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.handles.has(m)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),m),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),m)):!t&&this.handles.has(m)&&this.handles.remove(m),s}get running(){return !(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(){const e=this.graphicsCoreOwner.view.basemapTerrain;if(this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this.layerScaleRangeVisibilityQuery){this.layerScaleRangeVisibilityQuery=!0;const i=this.layer.effectiveScaleRange;e.queryVisibleScaleRange(this.extent,i.minScale,i.maxScale,(e=>this._finishUpdate(e)));}}else this._finishUpdate(!0);}_finishUpdate(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1);}_visibleAtLayerScale(e){const i=this.layer.effectiveScaleRange;return !this.layerScaleEnabled||c$q(e,i.minScale||0,i.maxScale||0)}_visibleAtLabelScale(e,i){return c$q(e,i.minScale||0,i.maxScale||0)}_graphicScale(e){let i;if(r$a(e.centroid)?i=e.centroid:r$a(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(i=e.graphic.geometry),i){return this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(i):1}return null}_graphicVisible(e){if(!this.layerScaleEnabled)return !0;const i=this._graphicScale(e);return this._visibleAtLayerScale(i)}updateVisibility(e){if(this._scaleRangeActive){const i=this._graphicVisible(e);return e.setVisibilityFlag(C$8.SCALE_RANGE,i,E$a.GRAPHIC)}return !1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return !1;if(!e.labelGraphics||0===e.labelGraphics.length)return !1;const i=this._graphicScale(e),t=this._updateLabelScaleVisibility(e,i);return t&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),t}_updateLabelScaleVisibility(e,i){if(!e.labelGraphics||0===e.labelGraphics.length)return !1;const t=e.labelGraphics[0]._labelClass;if(t&&null!=t.minScale&&null!=t.maxScale){const s=this._visibleAtLabelScale(i,t);if(e.setVisibilityFlag(C$8.SCALE_RANGE,s,E$a.LABEL))return !0}return !1}_scaleUpdateHandler(e){if(this._setDirty(),this.graphicsCoreOwner.suspended)return;const i=e.extent,t=e.scale,s=this._visibleAtLayerScale(t);let l=!1;const n=this.graphicsCoreOwner.view.spatialReference,h=e.spatialReference;if(t$9(h))return void d.error("scaleUpdate: Internal error, no SpatialReference given for tiles");const u=!h.equals(n);if(u){if(!zn(i,h,S,n))return void d.error("scaleUpdate: Internal error, cannot project AABR from "+h+" to wkid "+n)}const g=u?S:i;this.queryGraphicUIDsInExtent(g,h,(e=>{const n=this.graphicsCore.getGraphics3DGraphicById(e);if(t$9(n))return;const c=n.centroid;r$a(c)&&(i[0]>c.x||i[1]>c.y||i[2]<c.x||i[3]<c.y)||(n.setVisibilityFlag(C$8.SCALE_RANGE,s,E$a.GRAPHIC)&&(l=!0),this._updateLabelScaleVisibility(n,t)&&(l=!0));})),l&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty());}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(C$8.SCALE_RANGE))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty();}};function b(e,i){return e>0||i>0}e$e([d$f({constructOnly:!0})],y.prototype,"layerScaleEnabled",void 0),e$e([d$f({readOnly:!0})],y.prototype,"suspended",void 0),e$e([d$f({readOnly:!0})],y.prototype,"updating",void 0),y=e$e([n$d("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],y);const m="terrain-events",S=u$i(),f=y;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let _=class extends d$s{constructor(t){super(t),this.type="graphics-3d",this.graphicsCore=null,this.elevationAlignment=new l$2,this.drapeSourceType=e$D.Features,this._suspendResumeExtent=null;}normalizeCtorArgs(t){const e={...t,scaleVisibility:null,frustumVisibility:null};return delete e.scaleVisibilityEnabled,delete e.frustumVisibilityEnabled,t.scaleVisibilityEnabled&&(e.scaleVisibility=new f),t.frustumVisibilityEnabled&&(e.frustumVisibility=new d$1),e}initialize(){const t=new Fe({owner:this,layer:this.owner.layer,preferredUpdatePolicy:i$k.SYNC,graphicSymbolSupported:!0});this._set("graphicsCore",t);const{layer:e,scaleVisibility:i}=this;if(r$a(i)&&"effectiveScaleRange"in e){const t=e;this.updatingHandles.add((()=>t.effectiveScaleRange),(()=>i.layerMinMaxScaleChangeHandler()));}if("fullOpacity"in this.owner){const t=this.owner;this.updatingHandles.add((()=>t.fullOpacity),(()=>this.graphicsCore.opacityChange()));}if("elevationInfo"in e){const t=e;this.updatingHandles.add((()=>t.elevationInfo),((t,e)=>{m$i(t,e)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange());}));}}async setup(){const t=(t,e,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,e,i);if(this.elevationAlignment.setup(this,t,this.graphicsCore,this.view.elevationProvider),r$a(this.scaleVisibility)&&"effectiveScaleRange"in this.layer){const e=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this,this.layer,t,this.graphicsCore,e);}r$a(this.frustumVisibility)&&this.frustumVisibility.setup(this),this._set("objectStates",new s(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates});}catch(e){if(j$9(e))return;throw e}this.destroyed||(this.handles.add(l$t((()=>this.view.clippingArea),(()=>this._updateClippingExtent()),U$8)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics());}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("elevationAlignment",l$s(this.elevationAlignment)),this._set("scaleVisibility",l$s(this.scaleVisibility)),this._set("frustumVisibility",l$s(this.frustumVisibility)),this._set("objectStates",l$s(this.objectStates)),this._set("graphicsCore",l$s(this.graphicsCore));}get layer(){return this.owner.layer}get view(){return this.owner.view}get scaleVisibilitySuspended(){return !(!r$a(this.scaleVisibility)||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return !(!r$a(this.frustumVisibility)||!this.frustumVisibility.suspended)}get suspended(){return this.owner.suspended??!1}get updating(){return !!(this.graphicsCore?.updating||r$a(this.scaleVisibility)&&this.scaleVisibility.updating||r$a(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(t){this.graphicsCore.notifyGraphicGeometryChanged(t);}notifyGraphicVisibilityChanged(t){this.graphicsCore.notifyGraphicVisibilityChanged(t);}getRenderingInfo(t,e,i){const s=a$9(t,{renderer:e,arcade:i});if(r$a(s)&&s.color){const t=s.color;t[0]=t[0]/255,t[1]=t[1]/255,t[2]=t[2]/255;}return s}getRenderingInfoAsync(t,e,i,s){return s$8(t,{renderer:e,arcade:i,...s})}getHit(t){if(this.owner.loadedGraphics){const e=this.owner.loadedGraphics.find((e=>e.uid===t));if(e){const t=this.layer instanceof b$o?this.layer:null,i=f$q(e,t);return {type:"graphic",graphic:i,layer:i.layer}}}return null}whenGraphicBounds(t,e){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(t,e):Promise.reject()}computeAttachmentOrigin(t,e){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(t,e):null}getSymbolLayerSize(t,e){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(t,e):null}maskOccludee(t){const{set:e,handle:i}=this.objectStates.acquireSet(u$d.MaskOccludee,null);return this.objectStates.setUid(e,t.uid),i}highlight(t){if(t instanceof b$q)return P;if("number"==typeof t)return this.highlight([t]);if(t instanceof g$l)return this.highlight([t]);if(t instanceof j$g&&(t=t.toArray()),Array.isArray(t)&&t.length>0){if(t[0]instanceof g$l){const e=t.map((t=>t.uid)),{set:i,handle:s}=this.objectStates.acquireSet(u$d.Highlight,null);return this.objectStates.setUids(i,e),s}if("number"==typeof t[0]){const e=t,{set:i,handle:s}=this.objectStates.acquireSet(u$d.Highlight,null);return this.objectStates.setObjectIds(i,e),s}}return P}_setupSuspendResumeExtent(){const{scaleVisibility:t,frustumVisibility:e}=this;if(t$9(t)&&t$9(e))return;const i=({computedExtent:i,extentPadding:s})=>{this._suspendResumeExtent=z$6(i,this._suspendResumeExtent,r$r,s),r$a(t)&&t.setExtent(this._suspendResumeExtent),r$a(e)&&e.setExtent(this._suspendResumeExtent);};this.handles.add(l$t((()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding})),(t=>i(t)),w$d));}_updateClippingExtent(){const t=this.view.clippingArea;this.graphicsCore.setClippingExtent(t,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics();}};e$e([d$f()],_.prototype,"type",void 0),e$e([d$f({constructOnly:!0})],_.prototype,"owner",void 0),e$e([d$f()],_.prototype,"layer",null),e$e([d$f()],_.prototype,"view",null),e$e([d$f({constructOnly:!0})],_.prototype,"graphicsCore",void 0),e$e([d$f({constructOnly:!0})],_.prototype,"scaleVisibility",void 0),e$e([d$f({constructOnly:!0})],_.prototype,"frustumVisibility",void 0),e$e([d$f({readOnly:!0})],_.prototype,"elevationAlignment",void 0),e$e([d$f({readOnly:!0})],_.prototype,"objectStates",void 0),e$e([d$f({readOnly:!0})],_.prototype,"scaleVisibilitySuspended",null),e$e([d$f({readOnly:!0})],_.prototype,"frustumVisibilitySuspended",null),e$e([d$f()],_.prototype,"suspended",null),e$e([d$f({readOnly:!0})],_.prototype,"updating",null),e$e([d$f()],_.prototype,"loadedGraphics",null),e$e([d$f()],_.prototype,"fullOpacity",null),e$e([d$f()],_.prototype,"slicePlaneEnabled",null),e$e([d$f()],_.prototype,"drapeSourceType",void 0),e$e([d$f()],_.prototype,"updatePolicy",null),_=e$e([n$d("esri.views.3d.layers.graphics.GraphicsProcessor")],_);const P=n$e();

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function l(l){const s=l.view.spatialReference,i=l.layer.fullExtent,n=r$a(i)&&i.spatialReference;if(t$9(i)||!n)return Promise.resolve(null);if(n.equals(s))return Promise.resolve(i.clone());const a=M$9(i,s);return r$a(a)?Promise.resolve(a):l.view.state.isLocal?a$w(i,s,l.layer.portalItem).then((e=>!l.destroyed&&e?e:void 0)).catch((()=>null)):Promise.resolve(null)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let u=class extends(n$c(u$p)){constructor(){super(...arguments),this.type="graphics-3d",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null;}initialize(){this._set("processor",new _({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.setup()),this.handles.add(this.layer.on("graphic-update",(e=>this.processor.graphicsCore.graphicUpdateHandler(e)))),this.addResolvingPromise(l(this).then((e=>this.fullExtentInLocalViewSpatialReference=e))),this.layer.internal?this.notifyChange("updating"):this.handles.add(f$p((()=>this.view?.basemapTerrain?.ready),(()=>()=>this.notifyChange("updating")),{once:!0}));}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("processor",l$s(this.processor));}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}getSuspendInfo(){const e=super.getSuspendInfo();return e.outsideScaleRange=this.processor?.scaleVisibilitySuspended??!1,e.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,e}async fetchPopupFeatures(e,s){return r$a(s)?s.clientGraphics:null}getHit(e){return this.processor.getHit(e)}whenGraphicBounds(e,s){return this.processor.whenGraphicBounds(e,s)}computeAttachmentOrigin(e,s){return this.processor?.computeAttachmentOrigin(e,s)}getSymbolLayerSize(e,s){return this.processor.getSymbolLayerSize(e,s)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e){return this.processor.highlight(e)}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||i$k.SYNC}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}isUpdating(){return !(!this.processor?.updating&&(this.layer.internal||this.view?.basemapTerrain?.ready))}get performanceInfo(){return {displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:-1,totalNumberOfFeatures:-1,nodes:0,core:null,updating:this.updating,elevationUpdating:this.processor?.elevationAlignment.updating??!1,visibilityFrustum:!this.processor?.frustumVisibilitySuspended??!1}}};e$e([d$f()],u.prototype,"loadedGraphics",null),e$e([d$f({readOnly:!0})],u.prototype,"legendEnabled",null),e$e([d$f()],u.prototype,"layer",void 0),e$e([d$f({readOnly:!0})],u.prototype,"processor",void 0),e$e([d$f({type:Boolean})],u.prototype,"slicePlaneEnabled",void 0),u=e$e([n$d("esri.views.3d.layers.GraphicsLayerView3D")],u);const h=u;

var GraphicsLayerView3D = /*#__PURE__*/Object.freeze({
  __proto__: null,
  'default': h
});

export { GraphicsLayerView3D as G, L$2 as L, S$a as S, b$9 as b, j$2 as j };
