import { s, jX as j, r, bG as e, t, qn as _, bZ as l, B as e$1, C as d, D as n$1 } from './_virtual_index-9b831d4a.js';
import { n } from './LayerView3D-b7813df6.js';
import { c } from './TiledLayerView3D-3780d78b.js';
import { m } from './ImageryTileLayerView-d40568ce.js';
import { u } from './LayerView-e26ca8f9.js';
import { i } from './RefreshableLayerView-18d98912.js';
import { a } from './drapedUtils-7abad8d8.js';
import './popupUtils-c1e7b664.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let g=class extends(m(i(c(n(u))))){constructor(){super(...arguments),this.type="imagery-tile-3d",this.isAlignedMapTile=!0;}initialize(){this.layer.increaseRasterJobHandlerUsage(),null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new s("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const e=j((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const e=this.view.basemapTerrain.tilingScheme,{tileInfo:r}=this.layer,t=["png","png24","png32","jpg","mixed"].includes(r.format)&&e.compatibleWith(r);this.isAlignedMapTile=t;const i=t?r:e.toTileInfo();this.tileInfo=i,this.updatingHandles.add((()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition]),(()=>this.refresh()));}));this.addResolvingPromise(e);}destroy(){this.layer.decreaseRasterJobHandlerUsage(),this.view=null;}get _blankTile(){const e=document.createElement("canvas"),r=e.getContext("2d"),[t,i]=this.tileInfo.size;return e.width=t,e.height=i,r.clearRect(0,0,t,i),r.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return "jpg"===this.layer.tileInfo.format}get hasMixedImageFormats(){return "mixed"===this.layer.tileInfo.format}get dataLevelRange(){const e=this.tileInfo.lods,r=this.layer.tileInfo.lods,t=e[0].scale,i=r[r.length-1].scale;return this.levelRangeFromScaleRange(t,i)}_getfullExtent(){return this.projectFullExtent(this.view.basemapTerrain&&r(this.view.basemapTerrain.spatialReference)?this.view.basemapTerrain.spatialReference:this.view.spatialReference)}async fetchTile(e$1,r,t$1,a){const l=this.tileInfo,n=this._canSymbolizeInWebGL(),o={tileInfo:l,requestRawData:n,signal:e(a.signal),requestAsImageElement:this.isAlignedMapTile},m=await this.layer.fetchTile(e$1,r,t$1,o);if(m instanceof HTMLImageElement)return m;let h=m&&m.pixelBlock;if(t(h))return this._blankTile;if(!n&&(h=await this.layer.applyRenderer(m),t(h)))return this._blankTile;const c=new _([e$1,r,t$1],h,l.size[0],l.size[1]);return n?(c.symbolizerRenderer=this.layer.symbolizer.rendererJSON,c.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e$1)),c.transformGrid=m.transformGrid):c.isRendereredSource=!0,c.interpolation=this.layer.interpolation,c.bandIds=this.layer.bandIds,c}_getSymbolizerOptions(e){const r$1=this.tileInfo.lodAt(e).resolution;return {pixelBlock:null,isGCS:this.view.basemapTerrain&&r(this.view.basemapTerrain.spatialReference)?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:r$1,y:r$1},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(e){this._canSymbolizeInWebGL()&&JSON.stringify(e.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(e.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(e.lij[0])));}createFetchPopupFeaturesQueryGeometry(e,r){return a(e,r,this.view)}refresh(){this.emit("data-changed");}async doRefresh(){this.suspended||this.emit("data-changed");}_canSymbolizeInWebGL(){return l("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL}};e$1([d({readOnly:!0})],g.prototype,"_blankTile",null),e$1([d({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),e$1([d({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),e$1([d({readOnly:!0})],g.prototype,"dataLevelRange",null),g=e$1([n$1("esri.views.3d.layers.ImageryTileLayerView3D")],g);const b=g;

export { b as default };
