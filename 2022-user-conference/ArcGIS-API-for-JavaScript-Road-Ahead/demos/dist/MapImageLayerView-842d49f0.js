import { m as r, q as c, om as i, dn as t, u as e, y as y$1, nO as i$2, Q as v, w, O as k, T, z as n$1, ju as l$1, nT as v$1, P as g, mH as o$1, mZ as r$1, oA as t$1, a as f$2, v as v$2, nK as s, nL as i$3, U, ou as g$1, q5 as i$4, I as x, gD as a$3, E as s$1, ep as y$2, qm as r$2, e1 as $, t as t$2, B as has, qn as r$3, a6 as E, kO as i$5 } from './_virtual_index-1ea2035a.js';
import { c as c$1 } from './ExportImageParameters-4d04def3.js';
import { n } from './floorFilterUtils-776aae8e.js';
import { s as s$2 } from './drapedUtils-fff0739e.js';
import { i as i$1 } from './sublayerUtils-23d5ec90.js';
import { d, s as s$3 } from './popupUtils-4fcb9e6d.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const o=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function l(r$1,i){const{dpi:n,gdbVersion:s,geometry:l,geometryPrecision:f,height:p,layerOption:m,mapExtent:y,maxAllowableOffset:c$1,returnFieldName:u,returnGeometry:d,returnUnformattedValues:g,returnZ:x,spatialReference:b,timeExtent:h,tolerance:E,width:O}=r$1.toJSON(),{dynamicLayers:S,layerDefs:j,layerIds:N}=a$2(r$1),J=i&&r(i.geometry)?i.geometry:null,R={geometryPrecision:f,maxAllowableOffset:c$1,returnFieldName:u,returnGeometry:d,returnUnformattedValues:g,returnZ:x,tolerance:E},$=J&&J.toJSON()||l;if(R.imageDisplay=`${O},${p},${n}`,s&&(R.gdbVersion=s),$&&(delete $.spatialReference,R.geometry=JSON.stringify($),R.geometryType=c($)),b?R.sr=b.wkid||JSON.stringify(b):$&&$.spatialReference?R.sr=o($):y&&y.spatialReference&&(R.sr=o(y)),R.time=h?[h.start,h.end].join(","):null,y){const{xmin:e,ymin:r,xmax:t,ymax:i}=y;R.mapExtent=`${e},${r},${t},${i}`;}return j&&(R.layerDefs=j),S&&!j&&(R.dynamicLayers=S),R.layers="popup"===m?"visible":m,N&&!S&&(R.layers+=`:${N.join(",")}`),R}function a$2(r$1){const{mapExtent:t,floors:o,width:l,sublayers:a,layerIds:p,layerOption:m,gdbVersion:y}=r$1,c=a?.find((e=>null!=e.layer))?.layer?.serviceSublayers,u="popup"===m,d={},g=i({extent:t,width:l,spatialReference:t?.spatialReference}),x=[],b=e=>{const r=0===g,t=0===e.minScale||g<=e.minScale,i=0===e.maxScale||g>=e.maxScale;if(e.visible&&(r||t&&i))if(e.sublayers)e.sublayers.forEach(b);else {if(!1===p?.includes(e.id)||u&&(!e.popupTemplate||!e.popupEnabled))return;x.unshift(e);}};if(a?.forEach(b),a&&!x.length)d.layerIds=[];else {const r$1=i$1(x,c,y),t=x.map((e=>{const r=n(o,e);return e.toExportImageJSON(r)}));if(r$1)d.dynamicLayers=JSON.stringify(t);else {if(a){let e=x.map((({id:e})=>e));p&&(e=e.filter((e=>p.includes(e)))),d.layerIds=e;}else p?.length&&(d.layerIds=p);const r$1=f$1(o,x);if(r(r$1)&&r$1.length){const e={};for(const t of r$1)t.definitionExpression&&(e[t.id]=t.definitionExpression);Object.keys(e).length&&(d.layerDefs=JSON.stringify(e));}}}return d}function f$1(e,t$1){const i=!!e?.length,s=t$1.filter((e=>null!=e.definitionExpression||i&&null!=e.floorInfo));return s.length?s.map((t$1=>{const i=n(e,t$1),s=t(i,t$1.definitionExpression);return {id:t$1.id,definitionExpression:s}})):null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
var m$2;let a$1=m$2=class extends l$1{constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400;}static from(t){return v$1(m$2,t)}};e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"dpi",void 0),e([y$1()],a$1.prototype,"floors",void 0),e([y$1({type:String,json:{write:!0}})],a$1.prototype,"gdbVersion",void 0),e([y$1({types:i$2,json:{read:v,write:!0}})],a$1.prototype,"geometry",void 0),e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"geometryPrecision",void 0),e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"height",void 0),e([y$1({type:[Number],json:{write:!0}})],a$1.prototype,"layerIds",void 0),e([y$1({type:["top","visible","all","popup"],json:{write:!0}})],a$1.prototype,"layerOption",void 0),e([y$1({type:w,json:{write:!0}})],a$1.prototype,"mapExtent",void 0),e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"maxAllowableOffset",void 0),e([y$1({type:Boolean,json:{write:!0}})],a$1.prototype,"returnFieldName",void 0),e([y$1({type:Boolean,json:{write:!0}})],a$1.prototype,"returnGeometry",void 0),e([y$1({type:Boolean,json:{write:!0}})],a$1.prototype,"returnM",void 0),e([y$1({type:Boolean,json:{write:!0}})],a$1.prototype,"returnUnformattedValues",void 0),e([y$1({type:Boolean,json:{write:!0}})],a$1.prototype,"returnZ",void 0),e([y$1({type:k,json:{write:!0}})],a$1.prototype,"spatialReference",void 0),e([y$1()],a$1.prototype,"sublayers",void 0),e([y$1({type:T,json:{write:!0}})],a$1.prototype,"timeExtent",void 0),e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"tolerance",void 0),e([y$1({type:Number,json:{write:!0}})],a$1.prototype,"width",void 0),a$1=m$2=e([n$1("esri.rest.support.IdentifyParameters")],a$1);const u=a$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let m$1=class extends l$1{constructor(r){super(r),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null;}readFeature(r,t){return g.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(r$1,e){if(!r$1)return;const{attributes:t,geometry:s}=r$1;t&&(e.attributes={...t}),r(s)&&(e.geometry=s.toJSON(),e.geometryType=t$1.toJSON(s.type));}};e([y$1({type:String,json:{write:!0}})],m$1.prototype,"displayFieldName",void 0),e([y$1({type:g})],m$1.prototype,"feature",void 0),e([o$1("feature",["attributes","geometry"])],m$1.prototype,"readFeature",null),e([r$1("feature")],m$1.prototype,"writeFeature",null),e([y$1({type:Number,json:{write:!0}})],m$1.prototype,"layerId",void 0),e([y$1({type:String,json:{write:!0}})],m$1.prototype,"layerName",void 0),m$1=e([n$1("esri.rest.support.IdentifyResult")],m$1);const y=m$1;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
async function f(u,i,f){const c=(i=a(i)).geometry?[i.geometry]:[],l$1=f$2(u);return l$1.path+="/identify",v$2(c).then((e=>{const t=l(i,{geometry:e&&e[0]}),u=s({...l$1.query,f:"json",...t}),a=i$3(u,f);return U(l$1.path,a).then(m).then((r=>p(r,i.sublayers)))}))}function m(r){const e=r.data;return e.results=e.results||[],e.exceededTransferLimit=Boolean(e.exceededTransferLimit),e.results=e.results.map((r=>y.fromJSON(r))),e}function a(r){return r=u.from(r)}function p(r,e){if(!e?.length)return r;const t=new Map;function o(r){t.set(r.id,r),r.sublayers&&r.sublayers.forEach(o);}e.forEach(o);for(const s of r.results)s.feature.sourceLayer=t.get(s.layerId);return r}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let _=null;const F=F=>{let I=class extends F{constructor(){super(...arguments),this._featuresResolutions=new WeakMap,this.highlightGraphics=new i$4,this.updateHighlightedFeatures=x((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})));}));}initialize(){this.exportImageParameters=new c$1({layer:this.layer}),this.handles.add([a$3((()=>this.highlightGraphics),"change",(e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e.added).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution);}))]);}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null;}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,r){const{layer:s}=this;if(!e)throw new s$1("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const i=this.layer.capabilities?.operations?.supportsQuery??!0;if(!((this.layer.capabilities?.operations?.supportsIdentify??!0)&&this.layer.version>=10.5)&&!i)throw new s$1("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:s});return i?this._fetchPopupFeaturesUsingQueries(e,r):this._fetchPopupFeaturesUsingIdentify(e,r)}canResume(){return !!super.canResume()&&!this.timeExtent?.isEmpty}async _updateHighlightedFeaturesSymbols(e){for(const t of e){const e="renderer"in t.sourceLayer&&t.sourceLayer.renderer;"geometryType"in t.sourceLayer&&"point"===t.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(t).then((async r=>{let s="width"in r&&"height"in r&&null!=r.width&&null!=r.height?Math.max(r.width,r.height):"size"in r?r.size:null;const i="visualVariables"in e&&e.visualVariables?.find((e=>"size"===e.type));i&&(_||(_=(await import('./_virtual_index-1ea2035a.js').then(function (n) { return n.ze; })).getSize),s=_(i,t,{view:this.view.type,scale:this.view.scale,shape:"simple-marker"===r.type?r.style:null})),this.highlightGraphics.includes(t)&&(t.symbol=new y$2({style:"square",size:s,xoffset:"xoffset"in r?r.xoffset:0,yoffset:"yoffset"in r?r.yoffset:0}),t.visible=!0,this.highlightGraphicUpdated(t,"symbol"));}));}}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;const t=this.highlightGraphics;if(!t.length||!this.layer.capabilities.operations.supportsQuery)return;const s=this._getTargetResolution(e),i=new Map;for(const n of t)if(!this._featuresResolutions.has(n)||this._featuresResolutions.get(n)>s){const e=n.sourceLayer;r$2(i,e,(()=>new Map)).set(n.getObjectId(),n);}const o=Array.from(i,(([e,t])=>{const r=e.createQuery();return r.objectIds=[...t.keys()],r.outFields=[e.objectIdField],r.returnGeometry=!0,r.maxAllowableOffset=s,r.outSpatialReference=this.view.spatialReference,e.queryFeatures(r)})),a=await Promise.all(o);if(!this.destroyed)for(const{features:r}of a)for(const e of r){const t=e.sourceLayer,r=i.get(t).get(e.getObjectId());r&&this.highlightGraphics.includes(r)&&(r.geometry=e.geometry,this.highlightGraphicUpdated(r,"geometry"),this._featuresResolutions.set(r,s));}}_getTargetResolution(e){const t=e*$(this.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t){const r=await this._createIdentifyParameters(e,t);if(t$2(r))return [];const{results:i}=await f(this.layer.parsedUrl,r);return i.map((e=>e.feature))}async _createIdentifyParameters(e,t){const{floors:r$1,spatialReference:s,scale:o}=this.view,a=r(t)?t.event:null,n=await this._collectPopupProviders(this.layer.sublayers,o,t);if(!n.length)return null;await Promise.all(n.map((({sublayer:e})=>e.load().catch((()=>{})))));const l=Math.min(has("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce(((e,t)=>t.renderer?s$2({renderer:t.renderer,event:a}):e),2)),p=this.createFetchPopupFeaturesQueryGeometry(e,l),u$1=r$3(o,s),m=Math.round(p.width/u$1),y=new w({xmin:p.center.x-u$1*m,ymin:p.center.y-u$1*m,xmax:p.center.x+u$1*m,ymax:p.center.y+u$1*m,spatialReference:p.spatialReference});return new u({floors:r$1,gdbVersion:this.layer.gdbVersion,geometry:e,height:m,layerOption:"popup",mapExtent:y,returnGeometry:!0,spatialReference:s,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:l,width:m})}async _fetchPopupFeaturesUsingQueries(e,t){const r$1=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,t),s=r(t)?t.event:null,o=r$1.map((async({sublayer:t,popupTemplate:r$1})=>{await t.load().catch((()=>{}));const o=t.createQuery(),a=s$2({renderer:t.renderer,event:s}),n$1=this.createFetchPopupFeaturesQueryGeometry(e,a);if(o.geometry=n$1,o.outFields=await d(t,r$1),o.timeExtent=this.timeExtent,"floors"in this.view){const e=this.view?.floors?.clone(),r$1=n(e,t);r(r$1)&&(o.where=o.where?`(${o.where}) AND (${r$1})`:r$1);}const l=this._getTargetResolution(n$1.width/a),p=await this._loadArcadeModules(r$1),u="point"===t.geometryType||p&&p.arcadeUtils.hasGeometryOperations(r$1);u||(o.maxAllowableOffset=l);const{features:h}=await t.queryFeatures(o),c=u?0:l;for(const e of h)this._featuresResolutions.set(e,c);return h}));return (await E(o)).reverse().reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter((e=>null!=e))}async _collectPopupProviders(e,t,r$1){const s=[],o=async e=>{const a=0===e.minScale||t<=e.minScale,n=0===e.maxScale||t>=e.maxScale;if(e.visible&&a&&n)if(e.sublayers)e.sublayers.forEach(o);else if(e.popupEnabled){const t=s$3(e,{...r$1,defaultPopupTemplateEnabled:!1});r(t)&&s.unshift({sublayer:e,popupTemplate:t});}},a=e.toArray().reverse().map(o);return await Promise.all(a),s}_loadArcadeModules(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type)))return i$5()}};return e([y$1()],I.prototype,"highlightGraphics",void 0),e([y$1()],I.prototype,"exportImageParameters",void 0),e([y$1({readOnly:!0})],I.prototype,"exportImageVersion",null),e([y$1()],I.prototype,"layer",void 0),e([y$1()],I.prototype,"suspended",void 0),e([y$1(g$1)],I.prototype,"timeExtent",void 0),I=e([n$1("esri.views.layers.MapImageLayerView")],I),I};

export { F };
