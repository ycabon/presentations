import { bB as r, bv as n, b7 as l, b8 as h, bl as f, m as r$1, b6 as r$2, $ as s, E as s$1, qo as n$1, qp as c, ai as E, aq as P, ar as G, ax as L, ay as D, t, ad as E$1, ap as F, aj as a, qq as j$1, aE as r$3, jk as e, bh as c$1, aL as e$1, bW as U, cd as r$4, ce as i, aS as M$1, cf as t$1, aQ as f$1, cg as r$5, aR as h$1, bH as R$1, q9 as mt, e9 as j$2, gD as a$1, pL as y$1, pM as r$6, qr as s$2, aC as j$3, w as w$1, qm as r$7, u as e$2, y as y$2, z as n$3, bI as u, qs as a$2 } from './_virtual_index-1ea2035a.js';
import { o, b as n$2 } from './WGLContainer-be6ebd59.js';
import { I } from './enums-4e1a5b11.js';
import { y } from './LayerView2D-0acb5666.js';
import { u as u$1 } from './LayerView-04d8537b.js';
import './WGLBrushVTLSymbol-5326d98d.js';
import './definitions-a784b44f.js';
import './number-7d0da80b.js';
import './StyleDefinition-98114241.js';
import './enums-3e26cf0d.js';
import './GeometryUtils-07c7843a.js';
import './Utils-7b2ac961.js';
import './ShaderCompiler-4879c29c.js';
import './ProgramTemplate-192f2ab9.js';
import './MaterialKey-8672cbbb.js';
import './alignmentUtils-d4b065e2.js';
import './utils-94e6680e.js';
import './EffectView-de5a8347.js';
import './heatmapTextureUtils-076ceaf2.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const b=e();class V extends r{constructor(s$2){super(),this.elementView=s$2,this.isWrapAround=!1,this.perspectiveTransform=n(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push(l((()=>this.elementView.element.opacity),(e=>this.opacity=e),h),l((()=>[this.elementView.coords]),(()=>{this.requestRender();}),h),f((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&r$1(e.content)&&this._handles.push(r$2(e.content,"play",(()=>this.requestRender())));}),h)),s$2.element.load().catch((t=>{s.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new s$1("element-load-error","Element cannot be displayed",{element:s$2,error:t}));}));}destroy(){this._handles.forEach((e=>e.remove())),this.texture?.dispose(),this.texture=null;}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,r=this.elementView.element.content;if(r$1(r)){const e=r instanceof HTMLImageElement,i=r instanceof HTMLVideoElement,o=e?r.naturalWidth:i?r.videoWidth:r.width,n=e?r.naturalHeight:i?r.videoHeight:r.height;this._updatePerspectiveTransform(o,n),this.texture?i&&!r.paused&&(this.texture.setData(r),this.requestRender(),(n$1(t.gl)||c(o)&&c(n))&&this.texture.generateMipmap()):(this.texture=new E(t,{pixelFormat:P.RGBA,dataType:G.UNSIGNED_BYTE,samplingMode:L.LINEAR,wrapMode:D.CLAMP_TO_EDGE,width:o,height:n,preMultiplyAlpha:!0},r),(n$1(t.gl)||c(o)&&c(n))&&this.texture.generateMipmap(),i&&!r.paused&&this.requestRender());}super.beforeRender(e);}_createTransforms(){return null}updateDrawCoords(e,t$1){const r=this.elementView.coords;if(t(r))return;const[s,i,n,a]=r.rings[0],m=this._vertices,{x:h,y:c}=e,l=0!==t$1;l?m.set([i[0]-h,i[1]-c,s[0]-h,s[1]-c,n[0]-h,n[1]-c,a[0]-h,a[1]-c,a[0]-h,a[1]-c,i[0]+t$1-h,i[1]-c,i[0]+t$1-h,i[1]-c,s[0]+t$1-h,s[1]-c,n[0]+t$1-h,n[1]-c,a[0]+t$1-h,a[1]-c]):m.set([i[0]-h,i[1]-c,s[0]-h,s[1]-c,n[0]-h,n[1]-c,a[0]-h,a[1]-c]),this.isWrapAround=l;}getVAO(e,t$1,r){if(t(this.elementView.coords))return null;const s=this._vertices;if(this._vao)this._geometryVbo.setData(s);else {this._geometryVbo=E$1.createVertex(e,F.DYNAMIC_DRAW,s);const i=E$1.createVertex(e,F.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new a(e,r,t$1,{geometry:this._geometryVbo,tex:i});}return this._vao}_updatePerspectiveTransform(e,t){const r=this._vertices;j$1(b,[0,0,e,0,0,t,e,t],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),r$3(this.perspectiveTransform,b[6]/b[8]*e,b[7]/b[8]*t);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class M extends o{constructor(){super(...arguments),this._localOrigin=c$1(0,0),this._viewStateId=-1,this._dvsMat3=e$1(),this.requiresDedicatedFBO=!1;}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const e of this.children)e.beforeRender(t);}prepareRenderPasses(t){const e=t.registerRenderPass({name:"overlay",brushes:[n$2.overlay],target:()=>this.children,drawPhase:I.MAP});return [...super.prepareRenderPasses(t),e]}_updateMatrices(t){const{state:e}=t,{id:n,size:h,pixelRatio:l,resolution:m,rotation:f,viewpoint:u,displayMat3:M}=e;if(this._viewStateId===n)return;const v=Math.PI/180*f,_=l*h[0],w=l*h[1],{x:y,y:g}=u.targetGeometry,j=U(y,e.spatialReference);this._localOrigin.x=j,this._localOrigin.y=g;const b=m*_,R=m*w,O=r$4(this._dvsMat3);i(O,O,M),M$1(O,O,t$1(_/2,w/2)),f$1(O,O,r$5(_/b,-w/R,1)),h$1(O,O,-v),this._viewStateId=n;}_updateOverlays(e,s){const{state:r}=e,{rotation:o,spatialReference:a,worldScreenWidth:i,size:n,viewpoint:c}=r,p=this._localOrigin;let d=0;if(a.isWrappable){const e=n[0],m=n[1],f=180/Math.PI*o,u=Math.abs(Math.cos(f)),M=Math.abs(Math.sin(f)),v=Math.round(e*u+m*M),[_,w]=R$1(a).valid,y=mt(a),{x:g,y:j}=c.targetGeometry,b=[g,j],R=[0,0];r.toScreen(R,b);const O=[0,0];let P;P=v>i?.5*i:.5*v;const x=Math.floor((g+.5*y)/y),C=_+x*y,D=w+x*y,I=[R[0]+P,0];r.toMap(O,I),O[0]>D&&(d=y),I[0]=R[0]-P,r.toMap(O,I),O[0]<C&&(d=-y);for(const r of s){const e=r.elementView.bounds;if(t(e))continue;const[s,,o]=e;s<_&&o>_?r.updateDrawCoords(p,y):o>w&&s<w?r.updateDrawCoords(p,-y):r.updateDrawCoords(p,d);}}else for(const t of s)t.updateDrawCoords(p,d);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
let j=class extends(y(u$1)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new j$2;}attach(){this.handles.add(a$1((()=>this.layer.source),"refresh",(()=>{for(const e of this._tileStrategy.tiles)this._updateTile(e);this.requestUpdate();}))),this._overlayContainer=new M,this.container.addChild(this._overlayContainer),this._fetchQueue=new y$1({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new r$6({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate();}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear();}supportsSpatialReference(e){return !0}moveStart(){this.requestUpdate();}viewChange(){this.requestUpdate();}moveEnd(){this.requestUpdate();}update(e){this._tileStrategy.update(e);}async hitTest(e,t){const s=[],r=e.normalize(),o=[r.x,r.y];for(const{projectedElement:{normalizedCoords:l,element:n}}of this._elementReferences.values())r$1(l)&&s$2(l.rings,o)&&s.push({type:"media",element:n,layer:this.layer,mapPoint:e});return s.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){}_acquireTile(e){const t=new T(e.clone());return this._updateTile(t),t}_updateTile(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[s,r]=e.setElements(t);this._acquireElements(e,s),this._releaseElements(e,r),this.requestUpdate();}),(e=>{j$3(e)||s.getLogger(this.declaredClass).error(e);})));}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._releaseElements(e,e.elements),this.requestUpdate();}async _queryElements(e,t$1){const s=this.layer.source;if(t(s))return [];this.view.featuresTilingScheme.getTileBounds(w,e,!0);const r=new w$1({xmin:w[0],ymin:w[1],xmax:w[2],ymax:w[3],spatialReference:this.view.spatialReference});return s.queryElements(r,t$1)}_acquireElements(e,t$1){const s=this.layer.source,i=this.view.spatialReference;if(!t(s))for(const o of t$1){r$7(this._elementReferences,o.uid,(()=>{const e=new a$2({element:o,spatialReference:i}),t=new V(e);return this._overlayContainer.addChild(t),this.elements.add(o),{tiles:new Set,projectedElement:e,overlay:t}})).tiles.add(e);}}_releaseElements(e,t){for(const s of t){const t=this._elementReferences.get(s.uid);t.tiles.delete(e),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s));}}};e$2([y$2()],j.prototype,"_fetchQueue",void 0),e$2([y$2()],j.prototype,"layer",void 0),e$2([y$2({readOnly:!0})],j.prototype,"elements",void 0),j=e$2([n$3("esri.views.2d.layers.MediaLayerView2D")],j);const w=u();class T{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0;}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const r of e)s.has(r)?s.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(s)]}}const R=j;

export { R as default };
