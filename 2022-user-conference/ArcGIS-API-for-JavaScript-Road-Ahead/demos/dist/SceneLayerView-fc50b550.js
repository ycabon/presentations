import { Y as y$1, m as r, t, n3 as T, mO as v, u as e, z as n$1, y as y$2, $ as s$1, tA as s$2, A as m, tB as f$2, d8 as i$3, pV as W, pX as j, eY as d$3, fr as rn, gz as An, kH as j$1, oy as en, oz as tn } from './_virtual_index-1ea2035a.js';
import { n } from './FeatureLikeLayerView3D-7a4659f7.js';
import { a as t$1, n as n$2, u as u$2 } from './DefinitionExpressionSceneLayerView-04af8164.js';
import { u as u$1 } from './LayerView-04d8537b.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const o={setAttribute(){},rollback(){},commit(){}};var s;function i$2(e,r){const i=r.attributes[e.objectIdField],a=e.sessions.get(i);if(a)return a;const u=y$1(r.attributes),c=new Set;if(null==i)return o;const f=e.i3sOverrides.createInteractiveEditSession(i),d=new Map,l=(t,e)=>{const n=d.get(t);if(null==n){const n=e.indexOf(i);return d.set(t,n),n}return n};let I=s.EDITING;const b={setAttribute(t$1,o){if(I!==s.EDITING)return;const i=e.fieldsIndex.get(t$1);if(t(i))return;const a=e.attributeStorageInfo.findIndex((t=>t.name===i.name));if(a<0)return;f.set(a,o);const u=e.attributeStorageInfo[a];let d=!1;c.add(t$1),e.forEachNode(((t,n)=>{const s=l(t,n);if(-1===s)return;const i=e.getAttributeData(t.index);if(i){const n=i[u.name];n&&(n[s]=o,e.setAttributeData(t.index,i,r),d=!0);}})),d&&e.clearMemCache();},rollback(){if(I===s.EDITING){for(const t of c)this.setAttribute(t,u[t]);f.rollback(),I=s.ROLLED_BACK,e.sessions.delete(i);}},commit(){I===s.EDITING&&(f.commit(),I=s.COMMITTED,e.sessions.delete(i));}};return e.sessions.set(i,b),b}function a(t,e){const n=[...e.addedFeatures,...e.updatedFeatures,...e.deletedFeatures];for(const r of n)r.objectId&&t.i3sOverrides.updateGeometry(r.objectId);}function u(t,n){const r$1=c$2(t,n);if(0===r$1.size)return;const o=new Map;for(let e=0;e<t.attributeStorageInfo.length;e++)o.set(t.attributeStorageInfo[e].name,e);let s=!1;r$1.forEach(((n,r$1)=>{const i=t.getAttributeData(r$1);let a=!1;n.forEach(((n,r$1)=>{const u=r(i)?i[r$1]:null,c=o.get(r$1);for(const{featureIndex:e,value:o,featureId:i}of n)u&&(u[e]=o,a=!0,s=!0),t.i3sOverrides.updateAttributeValue(i,c,o);})),a&&t.setAttributeData(r$1,i,null);})),s&&t.clearMemCache();}function c$2(t,e){const n$1=e.edits.updateFeatures;if(!n$1||0===n$1.length)return new b;const o=l(e),s=new b,i=new Map;for(let r=0;r<t.attributeStorageInfo.length;r++)i.set(t.attributeStorageInfo[r].name,r);const a=t.fieldsIndex,u=t.objectIdField,c=n$1.filter((t=>{const e=n(a,t.attributes,u);return o.has(e)}));return t.forEachNode(((e,n$1)=>{const o=new Set(n$1);for(const i of c){const c=n(a,i.attributes,u);if(!o.has(c))continue;const d=n$1.indexOf(c);for(const n in i.attributes){const r=t.fieldsIndex.normalizeFieldName(n),o=f$1(s,e.index,r),a=i.attributes[n];o.push({featureIndex:d,featureId:c,value:a});}}})),s}function f$1(t,e,n){const r=d$2(t,e),o=r.get(n);if(o)return o;const s=new Array;return r.set(n,s),s}function d$2(t,e){const n=t.get(e);if(n)return n;const r=new I;return t.set(e,r),r}function l(t){const e=new Set;if(!t.updatedFeatures)return e;for(const n of t.updatedFeatures)null!=n.objectId&&null==n.error&&e.add(n.objectId);return e}!function(t){t[t.EDITING=0]="EDITING",t[t.ROLLED_BACK=1]="ROLLED_BACK",t[t.COMMITTED=2]="COMMITTED";}(s||(s={}));const I=Map,b=Map;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
function i$1(){return {requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:i,layer:{fieldsIndex:t},requiredFields:l}=this;return i.outFields?T(t,[...v(t,i.outFields),...l]):T(t,l)}}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const i=e$1=>{let a=class extends e$1{constructor(){super(...arguments),this._numUpdating=0,this._asyncUpdateState=new Map;}get updating(){return this._numUpdating>0}autoUpdateAsync(t,e){return p$1((e=>this._updateAsync(t,e)),e)}async _updateAsync(t,e){if(!this._startAsyncUpdate(t)){try{const s=await e();this._set(t,s);}catch(a){s$1.getLogger(this.declaredClass).warn(`Async update of "${String(t)}" failed. Async update functions should not throw exceptions.`);}this._endAsyncUpdate(t)&&this._updateAsync(t,e);}}_startAsyncUpdate(t){const e=this._asyncUpdateState.get(t)??c$1.None;return e&c$1.Updating?(this._asyncUpdateState.set(t,e|c$1.Invalidated),!0):(++this._numUpdating,this._asyncUpdateState.set(t,e|c$1.Updating),!1)}_endAsyncUpdate(t){--this._numUpdating;const e=(this._asyncUpdateState.get(t)??c$1.None)&~c$1.Updating;return e&c$1.Invalidated?(this._asyncUpdateState.set(t,e&~c$1.Invalidated),!0):(this._asyncUpdateState.set(t,e),!1)}};return e([y$2({readOnly:!0})],a.prototype,"updating",null),e([y$2()],a.prototype,"_numUpdating",void 0),a=e([n$1("esri.core.AsyncUpdate")],a),a};var c$1;function p$1(t,e){const s=()=>{i&&!c&&t(n);},n=()=>{if(!i||c)return e();i.clear(),c=!0;const t=f$2(i,e);return c=!1,t},r=()=>{i&&(i.destroy(),i=null);};let i=new s$2(s),c=!1;return t(n),{remove:r}}!function(t){t[t.None=0]="None",t[t.Updating=1]="Updating",t[t.Invalidated=2]="Invalidated";}(c$1||(c$1={}));let d$1=class extends(i(m)){};d$1=e([n$1("esri.core.AsyncUpdate")],d$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const p="esri.views.3d.layers.support.SceneLayerViewRequiredFields";let c=class extends(i(d$3)){constructor(e){super(e);}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:s,labelingFields:t,viewFilterFields:o}=this;return T(e,[...i$3(r,[]),...i$3(s,[]),...i$3(t,[]),...i$3(o,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",(()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?y((s=>r.collectRequiredFields(s,e))):null})),this.autoUpdateAsync("labelingFields",(()=>{const{layer:e}=this;return e.labelsVisible?y((r=>W(r,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:r}=this.layerView;return y((s=>j(s,e,r)))}))]);}};async function y(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(s){return s$1.getLogger(p).error(s),null}}e([y$2()],c.prototype,"layerView",void 0),e([y$2()],c.prototype,"layer",void 0),e([y$2()],c.prototype,"requiredFields",null),e([y$2()],c.prototype,"rendererFields",void 0),e([y$2()],c.prototype,"labelingFields",void 0),e([y$2()],c.prototype,"viewFilterFields",void 0),c=e([n$1(p)],c);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const d="esri.views.layers.SceneLayerView",h=s$1.getLogger(d);let f=class extends u$1{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1;}get availableFields(){return []}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return !1}get layerFilter(){return t$1(this._layerFilter)}get _layerFilter(){const e=this.layer.filter;if(t(e)||e.geometries.length<1)return null;const t$1=this._geometryEngine;if(t(t$1)||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return n$2;const o=e.geometries.getItemAt(0).spatialReference,i=e.geometries.toArray().map((e=>{try{e=t$1.simplify(e);}catch(r){return h.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(o))return e;try{return rn(e,o)}catch(r){return h.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter((e=>null!=e)).sort(((e,t)=>e.extent.xmin-t.extent.xmin)),l=new Set,s=new Array,a=new Array;for(let r of i){const e=r.extent.xmin;if(s.length=0,l.forEach((o=>{if(e>=o.extent.xmax)return a.push(o),void l.delete(o);r.extent.ymin<=o.extent.ymax&&r.extent.ymax>=o.extent.ymin&&t$1.intersects(r,o)&&s.push(o);})),s.length>0){s.push(r);try{r=t$1.union(s);}catch(m){h.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}s.pop(),s.forEach((e=>l.delete(e)));}l.add(r);}return l.forEach((e=>a.push(e))),a.length>0?{spatialRelationship:e.spatialRelationship,geometries:a}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(t(e)||e.geometries.length<=1)return !1;const t$1=e.geometries.getItemAt(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(t$1)&&!An(e,t$1)))}get layerFilterUpdating(){return u$2(this._layerFilter)}initialize(){j$1((()=>!this._geometryEngine&&r(this.layer.filter)&&this.layer.filter.geometries.length)).then((async()=>this._geometryEngine=await import('./geometryEngine-d05be472.js'))),this._projectionEngineLoaded=en(),j$1((()=>!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)).then((async()=>{await tn(),this._projectionEngineLoaded=!0;}));}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}};e([y$2()],f.prototype,"layer",void 0),e([y$2()],f.prototype,"availableFields",null),e([y$2()],f.prototype,"maximumNumberOfFeatures",null),e([y$2({readOnly:!0})],f.prototype,"maximumNumberOfFeaturesExceeded",null),e([y$2()],f.prototype,"filter",void 0),e([y$2({readOnly:!0})],f.prototype,"layerFilter",null),e([y$2({readOnly:!0})],f.prototype,"_layerFilter",null),e([y$2()],f.prototype,"_geometryEngine",void 0),e([y$2()],f.prototype,"_projectionEngineLoaded",void 0),e([y$2()],f.prototype,"_filterNeedsProjectionEngine",null),e([y$2()],f.prototype,"layerFilterUpdating",null),f=e([n$1(d)],f);const E=f;

export { E, a, i$1 as b, c, i$2 as i, u };
