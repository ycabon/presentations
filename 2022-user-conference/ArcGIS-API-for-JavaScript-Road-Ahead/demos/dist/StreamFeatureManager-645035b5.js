import { s } from './CircularArray-61b6424e.js';
import { t, m as r, L as e, bb as a$1 } from './_virtual_index-1ea2035a.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const o="__esri_stream_id__",d="__esri_timestamp__",a=1e3;class h{constructor(t,e,s,i,r=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=i,this.store=t,this.objectIdField=e,this.purgeInterval=r,this._useGeneratedIds=this.objectIdField===o;}add(r$1){if(this._useGeneratedIds){const t=this._nextId();r$1.attributes[this.objectIdField]=t,r$1.objectId=t;}else r$1.objectId=r$1.attributes[this.objectIdField];if(this._addOrUpdated.set(r$1.objectId,r$1),this._maxAge=Math.max(this._maxAge,r$1.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return t(this._trackIdLessObservations)&&(this._trackIdLessObservations=new s(1e5)),void this._trackIdLessObservations.enqueue(r$1.objectId);const o=r$1.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(o)){const s$1=r(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:a,r$1=a$1(s$1,0,a);this._trackIdToObservations.set(o,new s(r$1));}const d=this._trackIdToObservations.get(o).enqueue(r$1.objectId);r(d)&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d));}checkForUpdates(){const t=this._getToAdd(),e=this._getToRemove(),s=performance.now();s-this._lastPurge>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const r$1=[];if(r(e))for(const o of e){const t=this.store.removeById(o);r(t)&&r$1.push(t);}if(r(t))for(const i of t)i.attributes[d]=s,this.store.add(i);(t||r$1?.length)&&this.store.update(t,r$1);}_getToAdd(){if(!this._addOrUpdated.size)return null;const t=new Array(this._addOrUpdated.size);let e=0;return this._addOrUpdated.forEach((s=>t[e++]=s)),this._addOrUpdated.clear(),t}_getToRemove(){const t=this._removed;return this._removed.length?(this._removed=[],t):null}_nextId(){const t=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,t}_purge(t){const e=this._purgeOptions;r(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeByAgeReceived(t,e),this._purgeTracks());}_purgeSomeByDisplayCount(t){if(!t.displayCount)return;let e$1=this.store.size;if(e$1>t.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(e$1>t.displayCount&&s.size){const t=e(s.dequeue());this._removed.push(t),e$1--;}if(r(this._trackIdLessObservations)){let s=e$1-t.displayCount;for(;s-- >0;){const t=this._trackIdLessObservations.dequeue();r(t)&&this._removed.push(t);}}}}_purgeByAge(t){if(!t.age||!this._timeInfo?.startTimeField)return;const e=60*t.age*1e3,s=this._maxAge-e;this.store.forEach((t=>{t.attributes[this._timeInfo.startTimeField]<s&&this._removed.push(t.objectId);}));}_purgeByAgeReceived(t,e){if(!e.ageReceived)return;const s=t-60*e.ageReceived*1e3;this.store.forEach((t=>{t.attributes[d]<s&&this._removed.push(t.objectId);}));}_purgeTracks(){this._trackIdToObservations.forEach(((t,e)=>{0===t.size&&this._trackIdToObservations.delete(e);}));}}

export { h };
