import { an as E, dL as H, bI as t, Z as s, s as s$1, dM as D, aE as r, r as r$1, ad as c, ap as F, aU as C, dN as x$1, br as n$1, bx as r$2, b3 as l$1, t as t$1, aj as f, aI as e } from './_virtual_index-9b831d4a.js';
import { W } from './brushes-0ba66925.js';
import { s as s$2 } from './Container-38939417.js';
import { w } from './number-7d0da80b.js';
import { I } from './Utils-0ee32720.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const x=t=>{switch(t.BYTES_PER_ELEMENT){case 1:return C.UNSIGNED_BYTE;case 2:return C.UNSIGNED_SHORT;case 4:return C.UNSIGNED_INT;default:throw new s$1("Cannot get DataType of array")}},g=(e,t,r,s)=>{let o=0;for(let n=1;n<r;n++){const r=e[2*(t+n-1)],s=e[2*(t+n-1)+1];o+=(e[2*(t+n)]-r)*(e[2*(t+n)+1]+s);}return s?o>0:o<0},p=({coords:e,lengths:t},r)=>{const o=[];for(let n=0,i=0;n<t.length;i+=t[n],n+=1){const c=i,a=[];for(;n<t.length-1&&g(e,i+t[n],t[n+1],r);n+=1,i+=t[n])a.push(i+t[n]-c);const f=e.slice(2*c,2*(i+t[n])),h=x$1(f,a,2);for(const e of h)o.push(e+c);}return o};class l{constructor(e,t,r,s=!1){this._cache={},this.vertices=e,this.indices=t,this.primitiveType=r,this.isMapSpace=s;}static fromRect({x:e,y:t,width:r,height:s}){const o=e,n=t,i=o+r,c=n+s;return l.fromScreenExtent({xmin:o,ymin:n,xmax:i,ymax:c})}static fromPath(e){const t$1=H(new t,e.path,!1,!1),r=t$1.coords,s=new Uint32Array(p(t$1,!0)),o=new Uint32Array(r.length/2);for(let n=0;n<o.length;n++)o[n]=w(Math.floor(r[2*n]),Math.floor(r[2*n+1]));return new l({geometry:o},s,E.TRIANGLES)}static fromGeometry(r,s$2){const o=s$2.geometry.type;switch(o){case"polygon":return l.fromPolygon(r,s$2.geometry);case"extent":return l.fromMapExtent(r,s$2.geometry);default:return s.getLogger("esri.views.2d.engine.webgl.Mesh2D").error(new s$1("mapview-bad-type",`Unable to create a mesh from type ${o}`,s$2)),l.fromRect({x:0,y:0,width:1,height:1})}}static fromPolygon(e,t$1){const r$1=D(new t,t$1,!1,!1),s=r$1.coords,i=new Uint32Array(p(r$1,!1)),h=new Uint32Array(s.length/2),u=n$1(),y=n$1();for(let n=0;n<h.length;n++)r(u,s[2*n],s[2*n+1]),e.toScreen(y,u),h[n]=w(Math.floor(y[0]),Math.floor(y[1]));return new l({geometry:h},i,E.TRIANGLES,!0)}static fromScreenExtent({xmin:e,xmax:t,ymin:r,ymax:s}){const o={geometry:new Uint32Array([w(e,r),w(t,r),w(e,s),w(e,s),w(t,r),w(t,s)])},n=new Uint32Array([0,1,2,3,4,5]);return new l(o,n,E.TRIANGLES)}static fromMapExtent(e,t){const[r,s]=e.toScreen([0,0],[t.xmin,t.ymin]),[o,n]=e.toScreen([0,0],[t.xmax,t.ymax]),i={geometry:new Uint32Array([w(r,s),w(o,s),w(r,n),w(r,n),w(o,s),w(o,n)])},c=new Uint32Array([0,1,2,3,4,5]);return new l(i,c,E.TRIANGLES)}destroy(){r$1(this._cache.indexBuffer)&&this._cache.indexBuffer.dispose();for(const e in this._cache.vertexBuffers)r$1(this._cache.vertexBuffers[e])&&this._cache.vertexBuffers[e].dispose();}get elementType(){return x(this.indices)}getIndexBuffer(e,t=F.STATIC_DRAW){return this._cache.indexBuffer||(this._cache.indexBuffer=c.createIndex(e,t,this.indices)),this._cache.indexBuffer}getVertexBuffers(e,t=F.STATIC_DRAW){return this._cache.vertexBuffers||(this._cache.vertexBuffers=Object.keys(this.vertices).reduce(((r,s)=>({...r,[s]:c.createVertex(e,t,this.vertices[s])})),{})),this._cache.vertexBuffers}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
const n=t=>parseFloat(t)/100;class m extends r$2{constructor(t,e){super(),this._clip=e,this._cache={},this.stage=t,this._handle=l$1((()=>e.version),(()=>this._invalidate())),this.ready();}static fromClipArea(t,e){return new m(t,e)}_destroyGL(){r$1(this._cache.mesh)&&(this._cache.mesh.destroy(),this._cache.mesh=null),r$1(this._cache.vao)&&(this._cache.vao.dispose(),this._cache.vao=null);}destroy(){this._destroyGL(),this._handle.remove();}getVAO(t,e,r,i){const[o,h]=e.size;if("geometry"!==this._clip.type&&this._lastWidth===o&&this._lastHeight===h||(this._lastWidth=o,this._lastHeight=h,this._destroyGL()),t$1(this._cache.vao)){const s=this._createMesh(e,this._clip),o=s.getIndexBuffer(t),h=s.getVertexBuffers(t);this._cache.mesh=s,this._cache.vao=new f(t,r,i,h,o);}return this._cache.vao}_createTransforms(){return {dvs:e()}}_invalidate(){this._destroyGL(),this.requestRender();}_createScreenRect(t,e){const[r,s]=t.size,i="string"==typeof e.left?n(e.left)*r:e.left,o="string"==typeof e.right?n(e.right)*r:e.right,h="string"==typeof e.top?n(e.top)*s:e.top,a="string"==typeof e.bottom?n(e.bottom)*s:e.bottom,c=i,m=h;return {x:c,y:m,width:Math.max(r-o-c,0),height:Math.max(s-a-m,0)}}_createMesh(r,s$2){switch(s$2.type){case"rect":return l.fromRect(this._createScreenRect(r,s$2));case"path":return l.fromPath(s$2);case"geometry":return l.fromGeometry(r,s$2);default:return s.getLogger("esri.views.2d.engine.webgl.ClippingInfo").error(new s$1("mapview-bad-type","Unable to create ClippingInfo mesh from clip of type: ${clip.type}")),l.fromRect({x:0,y:0,width:1,height:1})}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
class a extends s$2{constructor(){super(...arguments),this.name=this.constructor.name;}set clips(e){this._clips=e,this.children.forEach((r=>r.clips=e)),this._updateClippingInfo();}_createTransforms(){return {dvs:e()}}doRender(e){const r=this.createRenderParams(e),{painter:s,globalOpacity:t,profiler:i,drawPhase:n}=r,a=n===I.LABEL||n===I.HIGHLIGHT?1:t*this.computedOpacity;i.recordContainerStart(this.name),s.beforeRenderLayer(r,this._clippingInfos?255:0,a),this.updateTransforms(e.state),this.renderChildren(r),s.compositeLayer(r,a),i.recordContainerEnd();}renderChildren(r){t$1(this._renderPasses)&&(this._renderPasses=this.prepareRenderPasses(r.painter));for(const e of this.children)e.beforeRender(r);for(const e of this._renderPasses)try{e.render(r);}catch(s){}for(const e of this.children)e.afterRender(r);}createRenderParams(e){return e.requireFBO=this.requiresDedicatedFBO,e}prepareRenderPasses(e){return [e.registerRenderPass({name:"clip",brushes:[W.clip],target:()=>this._clippingInfos,drawPhase:I.MAP|I.LABEL|I.LABEL_ALPHA|I.DEBUG|I.HIGHLIGHT})]}updateTransforms(e){for(const r of this.children)r.setTransform(e);}onAttach(){super.onAttach(),this._updateClippingInfo();}onDetach(){super.onDetach(),this._updateClippingInfo();}_updateClippingInfo(){if(r$1(this._clippingInfos)&&(this._clippingInfos.forEach((e=>e.destroy())),this._clippingInfos=null),!this.stage)return;const e=this._clips;r$1(e)&&e.length&&(this._clippingInfos=e.items.map((e=>m.fromClipArea(this.stage,e)))),this.requestRender();}}

export { a };
