/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{C as t}from"./CIMResourceManager.js";import{C as e,a as s,T as r}from"./CIMSymbolHelper.js";import{O as o}from"./OverrideHelper.js";import{m as i}from"./utils6.js";import"./fontUtils.js";import"../config.js";import"../core/lang.js";import"./imageUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./Logger.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./BidiEngine.js";import"./screenUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./extentUtils.js";import"../symbols/Font.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./zmUtils.js";import"../geometry/support/jsonUtils.js";import"../geometry/Multipoint.js";import"../geometry/Polyline.js";import"./OptimizedGeometry.js";import"./GeometryUtils.js";import"./enums2.js";import"../geometry.js";import"./typeUtils.js";import"./definitions.js";import"../Color.js";import"./colorUtils.js";import"./HighlightOptions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"../symbols/SimpleFillSymbol.js";import"./enumeration.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/Symbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/MarkerSymbol.js";import"../symbols/TextSymbol.js";import"./defaultsJSON.js";import"./colorUtils2.js";import"./vec4.js";import"./vec4f64.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./messages.js";import"./quantizationUtils.js";class m{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new t}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,s,r,m,a,l,n,c,j){if(!t)return null;const{data:y}=t;if(!y||"CIMSymbolReference"!==y.type||!y.symbol)return null;const{symbol:h}=y;l||(l=i(h));const g=await o.resolveSymbolOverrides(y,s,this._spatialReference,a,l,n,c),u=this._cimResourceManager,d=[];e.fetchResources(g,u,d),e.fetchFonts(g,u,d),d.length>0&&await Promise.all(d);const{width:b,height:S}=r,f=p(l,b,S,m),w=e.getEnvelope(g,f,u);if(!w)return null;let M=1,U=0,v=0;switch(h.type){case"CIMPointSymbol":case"CIMTextSymbol":{let t=1;w.width>b&&(t=b/w.width);let e=1;w.height>S&&(e=S/w.height),"preview"===m&&(w.width<b&&(t=b/w.width),w.height<S&&(e=S/w.height)),M=Math.min(t,e),U=w.x+w.width/2,v=w.y+w.height/2}break;case"CIMLineSymbol":{(j||w.height>S)&&(M=S/w.height),v=w.y+w.height/2;const t=w.x*M+b/2,e=(w.x+w.width)*M+b/2,{paths:s}=f;s[0][0][0]-=t/M,s[0][2][0]-=(e-b)/M}break;case"CIMPolygonSymbol":{U=w.x+w.width/2,v=w.y+w.height/2;const t=w.x*M+b/2,e=(w.x+w.width)*M+b/2,s=w.y*M+S/2,r=(w.y+w.height)*M+S/2,{rings:o}=f;t<0&&(o[0][0][0]-=t,o[0][3][0]-=t,o[0][4][0]-=t),s<0&&(o[0][0][1]+=s,o[0][1][1]+=s,o[0][4][1]+=s),e>b&&(o[0][1][0]-=e-b,o[0][2][0]-=e-b),r>S&&(o[0][2][1]+=r-S,o[0][3][1]+=r-S)}}const C={type:"cim",data:{type:"CIMSymbolReference",symbol:g}};return this.rasterize(C,b,S,U,v,M,l,1,f)}rasterize(t,e,o,m,a,l,n,c=0,j=null){const{data:y}=t;if(!y||"CIMSymbolReference"!==y.type||!y.symbol)return null;const{symbol:h}=y,g=this._canvas,u=1.3333333333333333*(window.devicePixelRatio||1);g.width=e*u,g.height=o*u,n||(n=i(h)),j||(j=p(n,e,o,"legend")),g.width+=2*c,g.height+=2*c;const d=g.getContext("2d",{willReadFrequently:!0}),b=r.createIdentity();return b.translate(-m,-a),b.scale(l*u,-l*u),b.translate(e*u/2+c,o*u/2+c),d.clearRect(0,0,g.width,g.height),new s(d,this._cimResourceManager,b,!0).drawSymbol(h,j),d.getImageData(0,0,g.width,g.height)}}function p(t,e,s,r){const o=-e/2+1,i=e/2-1,m=s/2-1,p=-s/2+1;switch(t){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[i,0]]]};default:return"legend"===r?{rings:[[[o,m],[i,0],[i,p],[o,p],[o,m]]]}:{rings:[[[o,m],[i,m],[i,p],[o,p],[o,m]]]}}}export{m as CIMSymbolRasterizer};
