/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{d as i,m as s}from"./handleUtils.js";import{L as n}from"./Logger.js";import{d as o,r,a}from"./maybe.js";import{mapCollection as l,watch as p,syncAndInitial as m,initial as d,sync as c,when as u}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import{equals as g}from"../core/lang.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{A as y}from"./AnalysisView3D.js";import j,{L as v,l as _}from"../analysis/LengthDimension.js";import{ah as S,ag as M,l as b}from"./unitUtils.js";import{g as w}from"./getDefaultUnitForView.js";import{d as P,r as C}from"./mathUtils.js";import{t as D}from"./quantityUtils.js";import{a as O,k as T,s as x,f as A}from"./mat4.js";import{c as R}from"./mat4f64.js";import{p as U,g as H,v as z,e as V,d as E,z as L,n as k,m as I,B as G,j as F,b as B,c as q,o as N,l as W,s as Q}from"./vec3.js";import{c as Z,Z as $,f as J}from"./vec3f64.js";import{A as K}from"./Axis.js";import{s as Y,y as X,h as tt,G as et,g as it}from"./plane.js";import{m as st}from"./dehydratedPoint.js";import{c as nt}from"./hydratedFeatures.js";import{E as ot,L as rt}from"./Segment.js";import{c as at,e as lt,d as pt}from"./automaticLengthMeasurementUtils.js";import{a as mt}from"./geodesicMeasurementUtils.js";import"../geometry.js";import{ignoreAbortErrors as dt,c as ct}from"../core/promiseUtils.js";import ut from"../Color.js";import{c as ht}from"./Cyclical.js";import{a as gt}from"./screenUtils.js";import{c as ft,Z as yt}from"./vec4f64.js";import{m as jt,e as vt}from"./colorUtils2.js";import{M as _t,c as St,R as Mt,w as bt,a as wt,b as Pt,r as Ct}from"./manipulatorUtils2.js";import{s as Dt,a as Ot,h as Tt}from"./dragEventPipeline3D.js";import{m as xt,R as At,L as Rt}from"./RibbonLineMaterial.js";import{A as Ut}from"./Attribute.js";import{G as Ht}from"./Geometry.js";import{d as zt,c as Vt}from"./GeometryUtil.js";import{R as Et}from"./Material.js";import{V as Lt}from"./VertexAttribute.js";import{I as kt}from"./ImageMaterial.js";import{c as It,r as Gt,E as Ft}from"./InteractiveToolBase.js";import{M as Bt,a as qt}from"./interfaces2.js";import Nt from"../geometry/Point.js";import Wt from"../core/Handles.js";import{m as Qt}from"./memoize.js";import{U as Zt}from"./UpdatingHandles.js";import{g as $t}from"./Factory.js";import{S as Jt}from"./SnappingVisualizer3D.js";import{L as Kt,a as Yt,l as Xt}from"./LineVisualElement.js";import{V as te}from"./VerticesVisualElement.js";import{c as ee}from"./lineStippleUtils.js";import{E as ie,a as se,c as ne}from"./EditGeometryOperations.js";import{a as oe}from"./SceneSnappingManagerPool.js";import{S as re}from"./SnappingContext.js";import{c as ae}from"./SnappingDragPipelineStep.js";import{S as le}from"./SnappingOperation.js";import{b as pe}from"./snappingUtils.js";import{A as me}from"./AnalysisToolBase.js";import{s as de}from"./keybindings.js";import{n as ce}from"./ToolIntersector.js";import{a as ue}from"./screenUtils2.js";import"../intl.js";import{f as he}from"./quantityFormatUtils.js";import{f as ge,c as fe}from"./vec4f32.js";import{O as ye}from"./Object3DVisualElement.js";import{l as je,c as ve}from"./line.js";import{L as _e}from"./ElevationUpdateEvent.js";import{o as Se}from"./locale.js";import{f as Me}from"./messages.js";import be from"../views/analysis/LengthDimensionResult.js";import{c as we,r as Pe,a as Ce}from"./analysisViewUtils.js";import De from"../views/analysis/DimensionAnalysisView.js";import"./metadata.js";import"./utils.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/Error.js";import"../config.js";import"./asyncUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./ensureType.js";import"./shared.js";import"./SimpleObservable.js";import"../core/Promise.js";import"../core/Clonable.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./common.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./mat3f64.js";import"./quatf64.js";import"./vec2f64.js";import"./mathUtils2.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"./date.js";import"./timeZoneUtils.js";import"./datetime.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./colorUtils.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./vec2.js";import"./VisualElement.js";import"./viewUtils.js";import"./elevationInfoUtils.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./projector.js";import"./widgetUtils.js";import"./TextOverlayItem.js";import"../geometry/projection.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./spatialReferenceEllipsoidUtils.js";import"./projectVectorToVector.js";import"./projectPointToVector.js";import"./measurementUtils2.js";import"./SnappingManager.js";import"./normalizedPoint.js";import"./Settings.js";import"./RightAngleSnappingHint.js";import"../layers/support/FeatureFilter.js";import"../TimeExtent.js";import"./timeUtils.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./floorFilterUtils.js";import"./layerUtils2.js";import"./angularMeasurementUtils.js";import"../geometry/support/geodesicUtils.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./_commonjsHelpers.js";import"./hydrated.js";import"./projectVectorToWGS84ComparableLonLat.js";import"./geometry2dUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./vec4.js";import"./compilerUtils.js";import"./mat3.js";import"./computeTranslationToOriginAndRotation.js";import"./lineSegment.js";import"./ElevationProvider.js";import"./ray.js";import"./Camera.js";import"./frustum.js";import"./ViewingMode.js";import"./graphicUtils.js";import"./basicInterfaces.js";import"./ColorMaterial.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./Util.js";import"./StencilUtils.js";import"./BindType.js";import"./interfaces5.js";import"./ShaderTechniqueConfiguration.js";import"./doublePrecisionUtils.js";import"./debugFlags2.js";import"./requestImageUtils.js";import"./enums.js";import"./Texture.js";import"./ContentObject.js";import"./OrderIndependentTransparency.js";import"./DefaultBufferWriter.js";import"./TriangleMaterial.js";import"./OutputHighlight.glsl.js";import"./Intersector2.js";import"./boundedPlane.js";import"./verticalOffsetUtils.js";import"./sphere.js";import"./orientedBoundingBox.js";import"./quat.js";import"./Octree.js";import"./floatRGBA.js";import"./Indices.js";import"./triangle.js";import"./vec3f32.js";import"./DoubleArray.js";import"./GLTextureMaterial.js";import"./DefaultLayouts.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"./vec32.js";import"./interfaces.js";import"./drawUtils.js";import"./ExtendedLineVisualElement.js";import"./EngineVisualElement.js";import"./RenderGeometry.js";import"../views/3d/webgl/ManagedFBO.js";import"./IntegerPassUniform.js";import"./axisAngleDegrees.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./RenderState.js";import"./RenderPlugin.js";import"./NestedMap.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Intersector.js";import"./glUtil.js";import"./VertexElementDescriptor.js";import"./MemCache.js";import"./BufferObject.js";import"./Scheduler.js";import"../core/signal.js";import"./debugFlags.js";import"./LaserlineVisualElement.js";import"./CameraSpace.glsl.js";import"./PointVisualElement.js";import"./ElevationContext.js";import"./HUDMaterial.js";import"./VerticalOffset.glsl.js";import"./RightAngleQuadVisualElement.js";import"./SnappingVisualizer.js";import"./PointSnappingHint.js";import"./dehydratedFeatureComparison.js";import"./InputManager.js";import"./Queue.js";import"./PropertiesPool.js";import"./unitFormatUtils.js";import"./ByteSizeUnit.js";import"./vec2f32.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./OptimizedGeometry.js";import"./edgeUtils.js";import"./earcut.js";import"./SnappingCandidate.js";import"./visualVariableUtils.js";import"./sizeVariableUtils.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./Normals.js";import"./objectResourceUtils.js";import"./devEnvironmentUtils.js";import"./DefaultMaterial_COLOR_GAMMA.js";import"./Version.js";import"./resourceUtils3.js";import"./symbolColorUtils.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./fontUtils.js";import"./GeometryUtils.js";import"./enums2.js";import"./utils6.js";import"./definitions.js";import"./HighlightOptions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"./defaultsJSON.js";import"./OverrideHelper.js";import"../symbols/support/cimSymbolUtils.js";import"./utils9.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./LRUCache.js";import"./line2.js";import"./projectVectorToPoint.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./imageUtils.js";import"../geometry/support/MeshTextureTransform.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"./georeference.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../geometry/support/MeshTransform.js";import"./styleUtils.js";import"./webStyleSymbolUtils.js";import"../symbols/support/jsonUtils.js";import"./Intersector4.js";function Oe(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:s,measureType:n,orientation:o}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:s,measureType:n,orientation:o}}function Te({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:s,orientation:n},o,r=null){if(null==t||null==e)return null;const a=Ue(null!=r?r.directSegment:new ot,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},o),l=null!=r?r.primaryOffsetAxis:Z();Ve(l,{measureType:s,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:a,orientation:n,renderCoordsHelper:o});const p=null!=r?r.dimensionSegment:new ot;return Le({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&s===v.Vertical?(U(p.startRenderSpace,a.startRenderSpace),U(p.endRenderSpace,a.endRenderSpace)):ke(p,{offsetAxis:l,offset:i,relativeToSegment:a,renderCoordsHelper:o}),{directSegment:a,dimensionSegment:p,primaryOffsetAxis:l,spatialReference:o.spatialReference}}function xe(t,e,i,s){return e===Ae.Start?(U(t.startRenderSpace,i.startRenderSpace),U(t.endRenderSpace,s.startRenderSpace)):(U(t.startRenderSpace,i.endRenderSpace),U(t.endRenderSpace,s.endRenderSpace)),t}var Ae;function Re(t,e,i,s){switch(e){case v.Direct:return Ue(t,i,s);case v.Horizontal:case v.Vertical:{const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:o,dimension:r,geometry:a}=i;let l;if(r.measureType===v.Direct){const t=function(t,e){const i=t.directSegment.eval(.5,Y.get()),s=e.worldUpAtPosition(i,Y.get()),n=t.dimensionSegment.eval(.5,Y.get()),o=z(Y.get(),n,i);return!L(o,$)&&E(o,s)>0}(a,s);l=t===n.z>o.z,e===v.Horizontal&&(l=!l)}else l=!function(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:s,endRenderSpace:n}=t.directSegment;return G(s,e)<G(n,i)}(a);const[p,m]=l?[n,o]:[o,n],d=nt(m,He);return e===v.Horizontal?d.z=p.z:(d.x=p.x,d.y=p.y),s.toRenderCoords(p,t.startRenderSpace),s.toRenderCoords(d,t.endRenderSpace),t}}}function Ue(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}!function(t){t[t.Start=0]="Start",t[t.End=1]="End"}(Ae||(Ae={}));const He=st(0,0,0,null),ze=new ot;function Ve(t,e){const{measureType:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:n,directSegment:{startRenderSpace:o,endRenderSpace:r},directSegment:a,renderCoordsHelper:l}=e,p=a.eval(.5,Y.get()),m=l.worldUpAtPosition(p,Y.get()),d=l.worldBasisAtPosition(p,K.Y,Y.get());switch(i){case v.Horizontal:U(t,m);break;case v.Vertical:E(o,m)<E(r,m)?z(t,r,o):z(t,o,r),V(t,t,m),V(t,t,m);break;case v.Direct:{const i=e.orientation??0;if(Le({elevationAlignedStartPoint:s,elevationAlignedEndPoint:n}))O(Ee,-P(i),m),H(t,d,Ee);else{const e=z(Y.get(),r,o),s=V(Y.get(),e,m);V(s,s,e),O(Ee,P(i),e),H(t,s,Ee)}break}}return L(t,$)?U(t,d):k(t,t)}const Ee=R();function Le({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return null!=t&&null!=e&&t.x===e.x&&t.y===e.y}function ke(t,e){const{offsetAxis:i,offset:s,relativeToSegment:{startRenderSpace:n,endRenderSpace:o},relativeToSegment:r,renderCoordsHelper:a}=e,l=s/a.unitInMeters,[p,m]=function(t,e,i,s=0){const n=E(e,i),o=E(t,i),r=Math.abs(n-o)+s;return n>o?[r,s]:[s,r]}(n,o,i,l);return I(t.startRenderSpace,r.startRenderSpace,i,p),I(t.endRenderSpace,r.endRenderSpace,i,m),t}function Ie(t,e,i){const s=e.directSegment.eval(.5,Y.get());return i.worldUpAtPosition(s,t)}function Ge(t,e){const{startRenderSpace:i,endRenderSpace:s}=e.directSegment;return z(t,s,i)}function Fe(t,e,i={invert:!1}){const{startRenderSpace:s,endRenderSpace:n}=e.dimensionSegment;return i.invert?z(t,s,n):z(t,n,s)}function Be(t,e){const i=t.directSegment.eval(.5,Y.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}const qe=Z();function Ne(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(null==e||null==i)return!1;const s=pt(e,i);return null!=s&&D(s,"meters").value>mt}function We(t){return null!=t.geometry}let Qe=class extends e{constructor(t){super(t)}initialize(){const t=l((()=>this.analysisViewData.computations),(({computation:t})=>this._watchComputation(t)));this.addHandles(i(t))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return w(this.view)}_watchComputation(t){return p((()=>Oe(t)),(e=>{const{measureType:i}=e;if(Ne(e)&&i!==v.Direct){const e=Math.round(b(mt,"meters","kilometers"));return n.getLogger(this).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${e} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const s=Te(e,this.view.renderCoordsHelper,t.geometry);t.geometry=s,t.result.length=function(t,e,i){if(null==t)return null;const s=t.dimensionSegment.startRenderSpace,n=t.dimensionSegment.endRenderSpace,o=e===v.Horizontal?at(s,n,t.spatialReference):lt(s,n,t.spatialReference);if(null==o)return null;const r=e===v.Vertical?S(o.value,o.unit,i):M(o.value,o.unit,i);return D(o,r)}(s,i,this._defaultUnit)}),m)}};function Ze(t){return jt(t.accentColor,.5)}t([h({constructOnly:!0})],Qe.prototype,"analysisViewData",void 0),t([h({constructOnly:!0})],Qe.prototype,"view",void 0),t([h()],Qe.prototype,"analysis",null),t([h()],Qe.prototype,"_defaultUnit",null),Qe=t([f("esri.views.3d.analysis.Dimension.support.DimensionController")],Qe);const $e=new ut([127,127,127,.5]);class Je{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find((e=>this.hasOwnProperty(e)&&t===this[e]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const e of _)t(this.manipulatorForMeasureType(e),e)}manipulatorForMeasureType(t){switch(t){case v.Direct:return this.direct;case v.Horizontal:return this.horizontal;case v.Vertical:return this.vertical}}}class Ke extends _t{constructor(t,e){const i=St(ut.toUnitRGBA(Ze(t.effectiveTheme))),s=[new Mt(zt(i,1,32,32),ci)];super({view:t,renderObjects:s,metadata:e.metadata,available:!1,grabCursor:"crosshair",radius:5,collisionPriority:1}),this._themeHandle=p((()=>({color:ut.toUnitRGBA(Ze(t.effectiveTheme))})),(t=>i.setParameters(t)))}destroy(){this._themeHandle.remove(),super.destroy()}}class Ye extends _t{constructor(t,{lineSizePt:e,material:i,metadata:s}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:s}),this._options={calloutColor:ft(),lineSizePt:e,material:i},this._themeHandle=p((()=>ut.toUnitRGBA(Ze(t.effectiveTheme))),(t=>{this._options.calloutColor=t,di(this,Xe({...this._options,metadata:this.metadata}))}),d)}update({lineSizePt:t,material:e}){this._options.lineSizePt=t,this._options.material=e,di(this,Xe({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Xe({calloutColor:t,lineSizePt:e,material:i,metadata:s}){return{calloutLength:.25*xt*.8*gt(e)+18,calloutColor:t,calloutWidth:2,customStateMask:ci,discScale:.3,focusMultiplier:2,material:i,metadata:s}}function ti(t){const{cancel:e,computation:i,settingHeading:s,steps:n,view:o}=t;if(!We(i))return;const{renderCoordsHelper:r}=o,{dimension:a,geometry:l}=i,p=Z(),m=ri(Z(),l,l.directSegment,r),d=ai(Y.get(),{forHeading:s,geometry:l,renderCoordsHelper:r}),c=X(m,d,tt()),u=s?a.orientation??Be(l,o.renderCoordsHelper):a.orientation??0;n.next(Ot(o,c)).next((t=>{"start"===t.action&&U(p,t.renderStart);const e=it(c),i=wt(p,t.renderEnd,m,e);let n=u-C(i);s||(n=function(t){const e=ht.normalize(t)%90;return e<5?t-e:90-e<5?t+(90-e):t}(n)),a.orientation=n})),e.next(Gt(a,["orientation"]))}function ei(t,e,i,s){const n=q(Y.get(),i.endRenderSpace,i.startRenderSpace);V(n,n,s);const o=X(i.startRenderSpace,n,tt()),r=X(i.startRenderSpace,s,tt()),a=e.offset;let l,p=0;const m=new Ft;return m.next(Ot(t,o)).next((i=>{"start"===i.action&&(p=et(r,i.renderStart));const s=(et(r,i.renderEnd)-p)*t.renderCoordsHelper.unitInMeters;e.offset=a+s,l=i})),t=>(m.execute(t),l)}function ii(t,e){const{directSegment:i}=t,{renderCoordsHelper:s}=e,n=Ie(Y.get(),t,s),o=Ge(Y.get(),t),r=V(Y.get(),o,n),{viewForward:a}=e.state.camera;E(r,a)>0&&B(r,r,-1);const l=i.eval(.5,Y.get());return s.headingAtPosition(l,r)}function si(t,e,i,{forHeading:s}){const{dimension:n,geometry:o}=e,{primaryOffsetAxis:r}=o,a=B(ni,r,n.offset>=0?1:-1),l=ai(oi,{forHeading:s,geometry:o,renderCoordsHelper:i});V(l,l,a);const p=Pt(a,l,$,gi);t.modelTransform=p,t.renderLocation=ri(ui,o,o.dimensionSegment,i)}const ni=Z(),oi=Z();function ri(t,e,i,s){const{startRenderSpace:n,endRenderSpace:o}=i,r=function(t,e){const i=Ge(li,t),s=Ie(pi,t,e);return E(i,s)>0}(e,s)?n:o;return U(t,r)}function ai(t,{forHeading:e,geometry:i,renderCoordsHelper:s}){return e?Ie(t,i,s):Fe(t,i,{invert:!0})}const li=Z(),pi=Z();function mi(t){return gt(t)+6}function di(t,e){const i=e.material??new kt({transparent:!0,writeDepth:!1,textureId:e.texture?.id,renderOccluded:Et.Opaque,isDecoration:!0}),s=e.focusMultiplier??Ct.focusMultiplier,n=e.calloutLength??Ct.calloutLength,o=Ct.discRadius*(e.discScale??1),r=o*s,a=(t,e)=>{const i=[0,1,2,2,3,0];return new Ht(e,[[Lt.POSITION,new Ut([n-t,-t,0,n+t,-t,0,n+t,t,0,n-t,t,0],i,3,!0)],[Lt.UV0,new Ut([0,0,1,0,1,1,0,1],i,2,!0)]])},l=e.calloutWidth??Ct.calloutWidth,p=new At({width:l,color:e.calloutColor,renderOccluded:Et.OccludeAndTransparent,isDecoration:!0}),m=Vt(p,[[0,0,0],[n-o,0,0]]),d=Vt(p,[[0,0,0],[n-r,0,0]]),c=e.customStateMask??Bt.None;t.collisionType={type:"disc",direction:[0,0,1],offset:[n,0,0]},t.focusMultiplier=s,t.metadata=e.metadata,t.radius=o,t.renderObjects=[new Mt(a(o,i),qt.Unfocused|c),new Mt(m,qt.Unfocused|c),new Mt(a(r,i),qt.Focused|c),new Mt(d,qt.Focused|c)]}const ci=Bt.Custom1,ui=Z(),hi=Z(),gi=R(),fi=new ot;var yi;function ji(t,e,i){const{constraint:s,elevationAlignedStartPoint:n,elevationAlignedEndPoint:o,unconstrainedGeometry:r,view:a}=i,{dimension:l,previousConstraint:p,preConstraintProperties:m}=t;if(null==n||null==o)return;const d=()=>{"startPoint"in e?l.startPoint=e.startPoint:"endPoint"in e&&(l.endPoint=e.endPoint)};if(null==s)d(),null!=p&&null!=m&&(l.measureType=m.measureType,l.orientation=m.orientation);else switch(l.measureType=v.Direct,s){case yi.Horizontal:if(s!==p&&(l.orientation=0),"startPoint"in e){const t=e.startPoint;null!=t&&(t.z=o.z),l.startPoint=t}else if("endPoint"in e){const t=e.endPoint;null!=t&&(t.z=n.z),l.endPoint=t}break;case yi.Vertical:if(s!==p&&(l.orientation=ii(r,a)),"startPoint"in e){const t=e.startPoint;null!=t&&(t.x=o.x,t.y=o.y),l.startPoint=t}else if("endPoint"in e){const t=e.endPoint;null!=t&&(t.x=n.x,t.y=n.y),l.endPoint=t}break;case yi.Direct:s!==p&&null!=m&&(l.orientation=m.orientation),d()}t.previousConstraint=s,t.unconstrainedGeometry=r}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"}(yi||(yi={}));let vi=class extends e{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new Wt,this._orientationManipulatorTexture=null,this._updatingHandles=new Zt,this._getSnappingContext=Qt((t=>new re({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new ie(new se("point",ne(!0,!1,this.view.spatialReference))),visualizer:new Jt})));const{view:e}=t;this._snappingManagerResult=oe(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:ee(2)}),this._constraintSnappingIndicator=new Kt({view:e,attached:!0,width:1,renderOccluded:Et.OccludeAndTransparent,stipplePattern:ee(5),isDecoration:!0});const i=ut.toUnitRGBA($e);this._stagedStartIndicator=new te({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:i,size:10,outlineSize:0,renderOccluded:Et.OccludeAndTransparent,isDecoration:!0})}initialize(){const{view:t}=this;this._snappingOperation=new le({view:t});const e=!t._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._orientationManipulatorMaterial=new kt({transparent:!0,writeDepth:!1,renderOccluded:Et.Opaque,isDecoration:!0}),this.addHandles(p((()=>{return{accentColor:Ze(t.effectiveTheme),contrastColor:(e=t.effectiveTheme,vt(e.accentColor))};var e}),(({accentColor:i,contrastColor:s})=>{const n=this._orientationManipulatorTexture,o=$t(t.textures,{accentColor:i,contrastColor:s,preMultiplyAlpha:e});this._orientationManipulatorMaterial.setParameters({textureId:o.texture.id}),this._orientationManipulatorTexture=o,n?.release();const r=ut.toUnitRGBA(i);this._unfocusedOffsetManipulatorMaterial.setParameters({color:r}),this._focusedOffsetManipulatorMaterial.setParameters({color:r}),this._thinOffsetManipulatorMaterial.setParameters({color:r}),this._constraintSnappingIndicator.color=r}),d));const s=l((()=>this.analysisViewData.computations),(({computation:t})=>this._createManipulators(t)));this.addHandles(i(s)),this.addHandles([p((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:t,stagedComputation:e})=>{if(null==e||null==t)return;const i=nt(t,new Nt);this._applyPointUpdate(e,{endPoint:i})}),c),p((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((t,e)=>{const{stagedDimension:i,selectedComputation:s,firstGrabbedManipulator:n}=t;if(i===e?.stagedDimension&&n===e?.firstGrabbedManipulator){for(const i of[s,e?.selectedComputation])if(null!=i){const e=this._computationManipulators.get(i);null!=e&&this._updateManipulators(i,e,t)}}else for(const[e,i]of this._computationManipulators)this._updateManipulators(e,i,t)}),m),p((()=>this.analysis.style.lineSize),(t=>{this._updateManipulatorStyle(t)}),d),p((()=>this.view.state.camera),(()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)})),p((()=>{const t=this._stagedComputation;if(!t)return null;const e=t.elevationAlignedStartPoint,i=Z();return null!=e&&this.view.renderCoordsHelper.toRenderCoords(e,i)?i:null}),(t=>{null!=t?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),pe(this,(()=>{const t=this._activeComputation,e=this._stagedComputation;if(null==t||null!=e){const t=this.view.inputManager.latestPointerType??"mouse",e=this._getSnappingContext(t);this._updatingHandles.addPromise(dt(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,e)))}if(null!=t){const{start:e,end:i}=this._computationManipulators.get(t);(e.grabbing||i.grabbing)&&function(t,e,{constraint:i,view:s}){const{unconstrainedGeometry:n}=t;if(null==n)return;const{renderCoordsHelper:o,spatialReference:r}=s,{startRenderSpace:a,endRenderSpace:l}=n.directSegment,p=o.fromRenderCoords(a,new Nt({spatialReference:r})),m=o.fromRenderCoords(l,new Nt({spatialReference:r}));let d;d="start"===e?{startPoint:p}:{endPoint:m},ji(t,d,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:n,view:s})}(t,e.grabbing?"start":"end",{constraint:this._computeConstraint(t),view:this.view})}}))}destroy(){this._snappingOperation=o(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorTexture?.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(null!=this._stagedComputation)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=t?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1)?.computation;return null==t||null==e||e.dimension!==t?null:e}get _constraintHandles(){return[u((()=>this.analysisViewData.selectedComputation),(t=>{t.previousConstraint=this._computeConstraint(t)}),{...m,equals:g}),p((()=>{const t=this._activeComputation;if(null==t)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}}),((t,e)=>{if(null!=t&&null==e){const{measureType:e,orientation:i,computation:s}=t;switch(s.previousConstraint){case yi.Horizontal:s.preConstraintProperties={measureType:v.Horizontal,orientation:0};break;case yi.Vertical:s.preConstraintProperties={measureType:v.Vertical,orientation:0};break;case yi.Direct:s.preConstraintProperties={measureType:v.Direct,orientation:i};break;default:s.preConstraintProperties={measureType:e,orientation:i}}}null==t&&null!=e&&(e.computation.preConstraintProperties=null)}),c)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[p((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:e,activeComputation:i})=>{const s=this._constraintSnappingIndicator;if(this.removeHandles(t),null!=i)if(i===e)s.attached=!0;else{const{start:e,end:n}=this._computationManipulators.get(i),o=()=>{s.attached=e.grabbing||n.grabbing};o(),this.addHandles([e.events.on("grab-changed",o),n.events.on("grab-changed",o)],t)}else s.attached=!1})),p((()=>{const t=this._activeComputation;return null!=t?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:e})=>{const i=this._constraintSnappingIndicator;null!=t&&null!=e&&e!==yi.Direct?(i.visible=!0,i.setGeometryFromSegment(t.directSegment)):i.visible=!1}))]}removeStaged(){return null!=this._stagedDimension&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(null==e){const e=this._onUnstagedClick(t);return this.analysis.dimensions.add(e),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if("touch"===e)return;const i=this._getSnappingContext(e);this._updatingHandles.addPromise(dt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){null!=this.analysisViewData.selectedComputation&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if("mouse"===e){const s=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:s})}const s=new j({startPoint:nt(i,new Nt),endPoint:null,measureType:v.Horizontal});return this._stagedDimension=s,this._resetSnappingState(),s}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(null==i)return;let s=t;if("mouse"===e){const i=this._getSnappingContext(e);s=this._snappingManager.update({point:t,context:i})}const n=nt(s,new Nt);this._applyPointUpdate(i,{endPoint:n}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(t){const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),s=this._setupOffsetManipulator(t),n=this._setupHeadingManipulator(t),o=this._setupRotationManipulator(t),r=this._setupMeasureTypeManipulator(t,v.Direct),a=this._setupMeasureTypeManipulator(t,v.Horizontal),l=this._setupMeasureTypeManipulator(t,v.Vertical),p=new Je({start:e,end:i,offset:s,heading:n,rotation:o,direct:r,horizontal:a,vertical:l});return this._setupComputationToManipulatorsSync(t,p),this._computationManipulators.set(t,p),this.manipulators.addMany(p.values()),{manipulators:p,remove:()=>{this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const t of p.values())this.manipulators.remove(t)}}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([p((()=>t.geometry),(()=>this._updateManipulators(t,e)),{...m,equals:g})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:s}=t,n=new Ke(i,{metadata:s}),o=function(t,{isStart:e,createSnappingPipelineStep:i,dimension:s,onUpdate:n,view:o}){const r=e?"startPoint":"endPoint",a=It(t,((t,e,a,l)=>{const p=Tt(t),{snappingStep:m,cancelSnapping:d}=i(l);a=a.next(p).next(Gt(s,[r,"measureType","orientation"])).next(d),e.next(p).next(Dt(o)).next(...m).next((t=>{const e=nt(t.mapEnd,new Nt);n("startPoint"===r?{startPoint:e}:{endPoint:e})}))}));return[a]}(n,{isStart:e.isStart,createSnappingPipelineStep:t=>ae({snappingContext:this._getSnappingContext(t),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:s,onUpdate:e=>this._applyPointUpdate(t,e),view:i});return this._computationHandles.add(o,t),n}_setupOffsetManipulator(t){const{view:e}=this,i=function(t,e){const i=[J(-.5,0,0),J(.5,0,0)],s=Vt(e.unfocusedMaterial,i.map((t=>B(Z(),t,.5)))),n=s.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new Mt(s,qt.Unfocused|qt.Selected|ci),new Mt(n,qt.Focused|ci)],collisionType:{type:"line",paths:[i]},radius:mi(e.lineSizePt)/2,metadata:e.metadata,available:!1,...bt})}(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[It(t,((t,s,n)=>{if(!We(e)||!t.selected)return;const{geometry:o,dimension:r}=e,a=Tt(t);s.next(a).next(ei(i,r,o.dimensionSegment,o.primaryOffsetAxis)),n.next(a).next(Gt(r,["offset"]))}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=new Ye(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[It(t,((t,s,n)=>{ti({cancel:n,computation:e,settingHeading:!0,steps:s,view:i})}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupRotationManipulator(t){const{view:e}=this,i=new Ye(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[It(t,((t,s,n)=>{ti({cancel:n,computation:e,settingHeading:!1,steps:s,view:i})})),t.events.on("immediate-click",(t=>{!function(t,e,i){const{dimension:s,geometry:n}=e;if(90===s.orientation||270===s.orientation)return s.orientation=0,void t.stopPropagation();if(null==n)return;const{renderCoordsHelper:o}=i,r=Te({...Oe(e),orientation:90},o),a=Te({...Oe(e),orientation:270},o);if(null==r||null==a)return;const l=Be(r,o),p=Be(a,o),m=ii(n,i),d=ht.shortestSignedDiff(m,l),c=ht.shortestSignedDiff(m,p);s.orientation=Math.abs(d)<Math.abs(c)?90:270,t.stopPropagation()}(t,e,i)}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,s=function(t,e){const i=[J(-.5,0,0),J(.5,0,0)],s=Vt(e.thinOffsetManipulatorMaterial,i),n=Vt(e.unfocusedMaterial,i.map((t=>B(Z(),t,.5)))),o=n.instantiate({material:e.focusedMaterial});return new _t({view:t,renderObjects:[new Mt(n,qt.Unfocused|ci),new Mt(o,qt.Focused|ci),new Mt(s,ci)],collisionType:{type:"line",paths:[i]},radius:mi(e.lineSizePt)/2,available:!1,metadata:e.metadata,...bt})}(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),n=function(t,{computation:e,manipulatorMeasureType:i,view:s}){let n=v.Direct,o=0,r=0;return[t.events.on("grab-changed",(a=>{if("start"!==a.action||!We(e))return;const{dimension:l,geometry:p}=e;n=l.measureType,o=l.offset,r=l.orientation;const m=U(Y.get(),t.renderLocation);l.measureType=i,l.offset=function(t,e,i,s){const{directSegment:n}=i,o=Ve(Y.get(),{measureType:e,directSegment:n,renderCoordsHelper:s}),r=ke(ze,{offsetAxis:o,offset:0,relativeToSegment:n,renderCoordsHelper:s}).eval(.5,Y.get()),a=z(Y.get(),t,r);return E(a,o)*s.unitInMeters}(m,i,p,s.renderCoordsHelper),l.orientation=0})),It(t,((t,a,l)=>{if(!We(e))return;const{geometry:p,dimension:m}=e,{renderCoordsHelper:d}=s,c=Re(fi,i,e,d),u=Ve(Y.get(),{measureType:i,directSegment:p.directSegment,renderCoordsHelper:d}),h=Tt(t);a.next(h).next(ei(s,m,c,u)),l.next(h).next((t=>(m.measureType=n,m.offset=o,m.orientation=r,t)))}))]}(s,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(n,t),s}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:s,selectedComputation:n,firstGrabbedManipulator:o}=i,{start:r,end:a,offset:l,heading:p,rotation:m}=e,d=n===t,c=We(t),{dimension:u}=t;for(const t of e.values()){const e=c&&null==s&&(null==o||t===o);t===l?(t.available=e,t.selected=d):t.available=e&&d}if(!c)return;null!=this._computeConstraint(t)?e.forEachMeasureTypeManipulator((t=>t.available=!1)):e.manipulatorForMeasureType(u.measureType).available=!1;for(const t of[p,m])u.measureType===v.Direct&&0!==u.offset||(t.available=!1);Le(t)?m.available=!1:p.available=!1;const{geometry:h}=t;r.renderLocation=h.directSegment.startRenderSpace,a.renderLocation=h.directSegment.endRenderSpace;const{renderCoordsHelper:g}=this.view;!function(t,e,i){const{dimensionSegment:s,primaryOffsetAxis:n}=e,o=Fe(ui,e),r=N(o,$)?T(gi):Pt(o,n,$,gi),a=Math.max(W(o),.1/i.unitInMeters);x(r,r,Q(ui,a,a,a)),t.modelTransform=r,t.renderLocation=s.eval(.5,ui)}(l,h,g),p.available&&function(t,e,i){si(t,e,i,{forHeading:!0})}(p,t,g),m.available&&function(t,e,i){si(t,e,i,{forHeading:!1})}(m,t,g),e.forEachMeasureTypeManipulator(((e,i)=>{e.available&&function(t,e,i,s){const{geometry:n}=e,o=Re(fi,i,e,s),r=Ve(ui,{measureType:i,directSegment:n.directSegment,renderCoordsHelper:s}),a=z(hi,o.endRenderSpace,o.startRenderSpace),l=Pt(a,r,$,gi),p=W(a);x(l,l,Q(hi,p,p,p)),t.modelTransform=l,t.renderLocation=o.eval(.5,hi)}(e,t,i,g)}))}_updateManipulatorStyle(t){const e=function(t){return gt(t)+4}(t),i=mi(t),s={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:t,heading:e,rotation:n}of this._computationManipulators.values())t.radius=i/2,e.update(s),n.update(s);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,s=Oe(t);"startPoint"in e&&(s.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(s.elevationAlignedEndPoint=e.endPoint);const n=Te(s,i.renderCoordsHelper);if(null==n)return;const o=this._computeConstraint({...s,geometry:n});ji(t,e,{...s,constraint:o,unconstrainedGeometry:n,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(null==t.geometry)return;t.geometry.directSegment.eval(.5,_i);const e=this.view.state.camera.computeScreenPixelSizeAt(_i);t.dimension.offset=50*e}_computeConstraint(t){return function(t,e){if(Ne(t))return yi.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(null==i||N(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{camera:s}=e.state,n=Ie(Y.get(),i,e.renderCoordsHelper),o=Ge(Y.get(),i),r=B(Y.get(),n,E(o,n)),a=q(Y.get(),o,r),l=F(a),p=F(r),{startRenderSpace:m,endRenderSpace:d}=i.directSegment,c=Math.max(10*s.computeScreenPixelSizeAt(m),10*s.computeScreenPixelSizeAt(d))**2;return l<c?yi.Vertical:p<c?yi.Horizontal:null}(function(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}(t,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new At({width:1,renderOccluded:Et.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const t=t=>this.analysisViewData.computations.find((({computation:e})=>e.dimension===t))?.computation;return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=Et.Occlude,this.manipulators.forEach((({manipulator:t})=>{for(const{geometry:e}of t.renderObjects)e.material.setParameters({renderOccluded:Et.Occlude})}))},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return null!=i?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};t([h({constructOnly:!0})],vi.prototype,"analysis",void 0),t([h({constructOnly:!0})],vi.prototype,"analysisViewData",void 0),t([h({constructOnly:!0})],vi.prototype,"manipulators",void 0),t([h({constructOnly:!0})],vi.prototype,"parentTool",void 0),t([h({constructOnly:!0,nonNullable:!0})],vi.prototype,"view",void 0),t([h({readOnly:!0})],vi.prototype,"updating",null),t([h()],vi.prototype,"firstGrabbedManipulator",null),t([h()],vi.prototype,"hasGrabbedManipulators",null),t([h()],vi.prototype,"snappingOptions",null),t([h()],vi.prototype,"_stagedDimension",void 0),t([h()],vi.prototype,"_activeComputation",null),t([h()],vi.prototype,"_stagedComputation",null),vi=t([f("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],vi);const _i=Z();var Si;!function(t){t.Ready="ready",t.Creating="creating",t.Created="created"}(Si||(Si={}));let Mi=class extends me{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=2500,this._prevPointerMoveTimeout=null}initialize(){this._intersector=ce(this.view.state.viewingMode),this._lengthDimensionSubTool=new vi({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([i(this._lengthDimensionSubTool),s((()=>this._clearPointerMoveTimeout())),p((()=>this.state),(t=>{t===Si.Created&&this.finishToolCreation()}),m),u((()=>this.firstGrabbedManipulator),(t=>{this.selectedDimension=t.metadata}),m),p((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),m)])}get state(){return this.analysis.dimensions.some((t=>"length"===t.type))?null!=this._activeSubTool?Si.Creating:Si.Created:Si.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(de.cancel===t.key){if(null!=this._activeSubTool&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else de.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){null!=this._activeSubTool&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(null==this._activeSubTool)return;const e=this._intersectScreen(t);null!=e&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),null==this._activeSubTool)return;if(this.hasFocusedManipulators)return;const e=this._intersectScreen(t);null!=e&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){null!=this._activeSubTool&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=ue(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,s=Y.get();return i.getIntersectionPoint(s)?this.view.renderCoordsHelper.fromRenderCoords(s,new Nt({spatialReference:this.view.spatialReference})):null}_removeSelected(){null!=this.selectedDimension&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=r(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach((t=>t.manipulator.state|=ci)),this._prevPointerMoveTimeout=ct.setTimeout((()=>{this.manipulators.forEach((t=>t.manipulator.state&=~ci))}),this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};t([h({constructOnly:!0})],Mi.prototype,"view",void 0),t([h({constructOnly:!0})],Mi.prototype,"analysis",void 0),t([h({readOnly:!0})],Mi.prototype,"state",null),t([h({readOnly:!0})],Mi.prototype,"updating",null),t([h({readOnly:!0})],Mi.prototype,"cursor",null),t([h({constructOnly:!0})],Mi.prototype,"analysisViewData",void 0),t([h()],Mi.prototype,"selectedDimension",null),t([h()],Mi.prototype,"automaticManipulatorSelection",void 0),t([h()],Mi.prototype,"_activeSubTool",void 0),t([h()],Mi.prototype,"_lengthDimensionSubTool",void 0),Mi=t([f("esri.views.3d.analysis.Dimension.DimensionTool")],Mi);class bi extends ye{constructor(t,e){super(t),this._hasExternalMaterial=!1,this._renderOccluded=Et.OccludeAndTransparent,this._width=1,this._color=ge(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=e,this._hasExternalMaterial=null!=e,this.applyProperties(t)}setGeometryFromSegment(t,e){const i=t.endRenderSpace;this.transform=A(wi,i),this._normal=e;const{points:s}=t.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return null!=this._material?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,null!=this._material&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return null!=this._material?this._material.parameters.width:this._width}set width(t){this._width=t,null!=this._material&&this._material.setParameters({width:t})}get color(){return null!=this._material?this._material.parameters.color:this._color}set color(t){this._color=fe(t),null!=this._material&&this._material.setParameters({color:this._color})}get placement(){return null!=this._material?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,null!=this._material&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){return this._material?.parameters.markerPrimitive??this._markerPrimitive}set markerPrimitive(t){this._markerPrimitive=t,null!=this._material&&this._material.setParameters({markerPrimitive:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new _e({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const e of je(this.geometry,this.normal)){const i=ve(this._material,e);t.addGeometry(i)}}forEachExternalMaterial(t){this._hasExternalMaterial||t(this._material)}}const wi=R();class Pi{set visible(t){for(const e of this._visualElements.values())e.attached=t}constructor(t){this.destroyed=!1,this._handles=new Wt,this._messages=null,this._labelSegment=new ot;const{analysis:e,computation:i,view:s,messages:n,isDecoration:o}=t;this.analysis=e,this.computation=i,this.view=s,this._messages=n;const r=t.visible,a={view:s,attached:r,isDecoration:o},{fontSize:l,textColor:m,textBackgroundColor:c}=e.style;this._visualElements=new Ti({marker:new bi(a,t.markerMaterial),dimension:new Kt(a,t.dimensionLineMaterial),startOffset:new Kt(a,t.offsetLineMaterial),endOffset:new Kt(a,t.offsetLineMaterial),dimensionSmall:new Kt(a,t.smallDimensionLineMaterial),startOffsetSmall:new Kt(a,t.smallOffsetLineMaterial),endOffsetSmall:new Kt(a,t.smallOffsetLineMaterial),label:new rt({view:s,attached:r,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:gt(l),textColor:m.clone(),backgroundColor:c.clone(),isDecoration:o})}),this._handles.add([p((()=>i.geometry),(t=>{this.updateCameraDependentElements(s.state.camera,t,e.style),null!=i.geometry&&this._updateLines(i.geometry)}),{...d,equals:g}),p((()=>i.length),(t=>this._updateLabelContent(t)),d)])}destroy(){this.destroyed=!0,this._handles=o(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const e=xe(Ci,Ae.Start,t.directSegment,t.dimensionSegment),i=xe(Di,Ae.End,t.directSegment,t.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),s.dimension.setGeometryFromSegment(t.dimensionSegment),s.startOffset.setGeometryFromSegment(e),s.endOffset.setGeometryFromSegment(i),s.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(e),s.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(t,e,i){const s=this._visualElements;if(null==e){for(const t of s.values())t.visible=!1;return}const n=t.computeScreenPixelSizeAt(e.dimensionSegment.eval(.5,Oi)),o=function(t,e){return F(Fe(qe,t))/e**2}(e,n),r=o<(2*gt(i.lineSize))**2,a=!r;s.marker.visible=a,s.dimension.visible=a,s.startOffset.visible=a,s.endOffset.visible=a,s.dimensionSmall.visible=r,s.startOffsetSmall.visible=r,s.endOffsetSmall.visible=r;const l=5*gt(i.fontSize),{label:p}=s;if(p.visible=o>=l**2,!p.visible)return;const{dimensionSegment:m,primaryOffsetAxis:d}=e,{offset:c}=this.computation.dimension,u=(Math.sign(c)>=0?1:-1)*this._labelOffsetPx(i)*n;!function(t,e,i,s){I(t.startRenderSpace,e.startRenderSpace,i,s),I(t.endRenderSpace,e.endRenderSpace,i,s)}(this._labelSegment,m,d,u),p.updateLabelPosition()}updateLabelStyle(t){const{label:e}=this._visualElements;e.fontSize=gt(t.fontSize),e.textColor=t.textColor,e.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:e}=this.computation;this._updateLabelContent(e)}_updateLabelContent(t){const{label:e}=this._visualElements;null!=t&&null!=this._messages?e.text=he(this._messages,t,t.unit):e.text=""}_labelOffsetPx(t){return 1.5*gt(t.fontSize)+20+gt(t.lineSize/2)}}const Ci=new ot,Di=new ot,Oi=Z();class Ti{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let xi=class extends e{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null}initialize(){const t=this.isDecoration;this._markerMaterial=new _e({width:1,anchor:Rt.Tip,color:yt,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:Et.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:t}),this._dimensionLineMaterial=new At({width:1,color:yt,renderOccluded:Et.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:t}),this._offsetLineMaterial=new At({width:1,color:yt,renderOccluded:Et.OccludeAndTransparent,stipplePattern:ee(5),isDecoration:t}),this._smallDimensionLineMaterial=new At({width:1,color:yt,renderOccluded:Et.OccludeAndTransparent,isDecoration:t}),this._smallOffsetLineMaterial=new At({width:1,color:yt,renderOccluded:Et.OccludeAndTransparent,stipplePattern:ee(5),isDecoration:t});for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(s((()=>{this.view._stage?.remove(t)})));const e=l((()=>this.analysisViewData.computations),(({computation:t})=>this._createVisualization(t)));this._dimensionVisualizations=e,this.addHandles([i(e),p((()=>ut.toUnitRGBA(this.analysis.style.color)),(t=>{for(const e of this._lineMaterials())e.setParameters({color:t})}),m),p((()=>this.analysis.style.lineSize),(t=>{const e=gt(t);this._markerMaterial.setParameters({width:.8*e}),this._dimensionLineMaterial.setParameters({width:e,markerParameters:this._markerMaterial.parameters});const i=Math.max(.25*e,1);this._offsetLineMaterial.setParameters({width:i})}),m),p((()=>({camera:this.view.state.camera,style:Ai(this.analysis)})),(({camera:t,style:e})=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateCameraDependentElements(t,i.computation.geometry,e),i.updateLabelStyle(e)})),p((()=>this.visible),(t=>{for(const{visualization:e}of this._dimensionVisualizations)e.visible=t}))]),this.addHandles([Se((()=>this._updateMessageBundle())),u((()=>!this.loadingMessages),(()=>{for(const{visualization:t}of this._dimensionVisualizations)t.updateUnitsMessages(this._messages)}),c)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map((({visualization:t})=>t)),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:Et.Occlude})}}}_createVisualization(t){const e=new Pi({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Me("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Ai(t){const{fontSize:e,lineSize:i,textColor:s,textBackgroundColor:n}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:n.clone(),textColor:s.clone()}}t([h({constructOnly:!0})],xi.prototype,"analysisViewData",void 0),t([h({constructOnly:!0,nonNullable:!0})],xi.prototype,"view",void 0),t([h({constructOnly:!0})],xi.prototype,"isDecoration",void 0),t([h()],xi.prototype,"analysis",null),t([h()],xi.prototype,"visible",null),t([h()],xi.prototype,"loadingMessages",void 0),xi=t([f("esri.views.3d.analysis.Dimension.DimensionVisualization")],xi);let Ri=class extends e{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new be({dimension:e}),...i}}initialize(){this.addHandles([p((()=>this.dimension.startPoint),(t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t)),m),p((()=>this.dimension.endPoint),(t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t)),m)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};t([h({constructOnly:!0,nonNullable:!0})],Ri.prototype,"result",void 0),t([h({constructOnly:!0,nonNullable:!0})],Ri.prototype,"projectAndAlignPoint",void 0),t([h()],Ri.prototype,"dimension",null),t([h()],Ri.prototype,"length",null),t([h()],Ri.prototype,"geometry",void 0),t([h()],Ri.prototype,"unconstrainedGeometry",void 0),t([h()],Ri.prototype,"elevationAlignedStartPoint",void 0),t([h()],Ri.prototype,"elevationAlignedEndPoint",void 0),t([h()],Ri.prototype,"preConstraintProperties",void 0),t([h()],Ri.prototype,"previousConstraint",void 0),Ri=t([f("esri.views.3d.analysis.LengthDimensionComputation")],Ri);let Ui=class extends(De(y(e))){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(null==t)return null;const{spatialReference:e,elevationProvider:i}=this.view,s=Yt(t,e,i);return null==s&&Xt(this.analysis,t.spatialReference,n.getLogger(this)),s};const t=l((()=>this.analysis.dimensions),(t=>this._createComputation(t)));this.computations=t,this.addHandles([we(this,Mi),i(t)]),this._analysisVisualization=new xi({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new Qe({analysisViewData:this,view:this.view})}destroy(){this._placementTask=a(this._placementTask),this._analysisVisualization=o(this._analysisVisualization),Pe(this)}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map((t=>this._dimensionsToComputations.get(t).result))}get selectedComputation(){const{selectedDimension:t}=this;return null==t?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=a(this._placementTask),this._placementTask=Ce(this,t),this._placementTask.promise}_createComputation(t){const{_dimensionsToComputations:e}=this,i=new Ri({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(t,i),{computation:i,remove:()=>this._removeComputation(i)}}_removeComputation(t){const{dimension:e}=t;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),t.destroy()}};t([h({readOnly:!0})],Ui.prototype,"type",void 0),t([h()],Ui.prototype,"tool",void 0),t([h()],Ui.prototype,"updating",null),t([h({readOnly:!0})],Ui.prototype,"results",null),t([h()],Ui.prototype,"computations",void 0),t([h()],Ui.prototype,"selectedDimension",void 0),t([h()],Ui.prototype,"selectedComputation",null),t([h()],Ui.prototype,"_analysisVisualization",void 0),t([h()],Ui.prototype,"_analysisController",void 0),t([h()],Ui.prototype,"_dimensionsToComputations",void 0),t([h()],Ui.prototype,"_placementTask",void 0),Ui=t([f("esri.views.3d.analysis.DimensionAnalysisView3D")],Ui);const Hi=Ui;export{Hi as default};
