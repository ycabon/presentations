/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Evented.js";import{clone as s}from"../core/lang.js";import{createResolver as i}from"../core/promiseUtils.js";import"./Logger.js";import"../core/Error.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{b as d}from"./uuid.js";const n=d(),o=new Map,a=new Map,l=new Map;async function c(e,t,s=!1){if(!e||!t)return!0;const i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=a.get(i)?.entries();if(r)for(const[e,d]of r)if(d.name===t){const t=!d.stack?.hasForwardEdits();if(!t&&s){const[{deleteForwardEdits:t},{default:s}]=await Promise.all([import("./deleteForwardEdits.js"),import("./DeleteForwardEditsParameters.js")]);return t(i,e,new s({sessionId:n,moment:d.moment}))}return t}return!0}function u(e,t){if(!e)return!1;const s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=a.get(s)?.entries();if(i)for(const[e,s]of i)if(s.name===t)return"edit"===s.lockType;return!1}const h=new t.EventEmitter;function m(e){return h.on("apply-edits",new WeakRef(e))}function p(e){return h.on("update-moment",new WeakRef(e))}function f(e,t,s=null,r=!1){const d=i();return r=null==t||r,h.emit("apply-edits",{serviceUrl:e,layerId:t,gdbVersion:s,mayReceiveServiceEdits:r,result:d.promise}),d}function b(e,t,s=null,i){h.emit("update-moment",{serviceUrl:e,layerId:t,gdbVersion:s,moment:i})}const F="esri.layers.mixins.EditBusLayer",g=Symbol(F);function I(e){return null!=e&&"object"==typeof e&&g in e}function j(e){return null!=e&&"object"==typeof e&&"gdbVersion"in e}function y(e,t,s){const i=new URL(e).host,r=o.get(i),d=e=>!e||e===r;return d(t)&&d(s)||t===s}const M=t=>{var i;let d=class extends t{constructor(...e){super(...e),this[i]=!0,this._applyEditsHandler=e=>{const{serviceUrl:t,layerId:i,gdbVersion:r,mayReceiveServiceEdits:d,result:n}=e,o=t===this.url,a=null!=i&&null!=this.layerId&&i===this.layerId,l=j(this),c=j(this)&&y(t,r,this.gdbVersion);if(!o||l&&!c||!a&&!d)return;const h=n.then((e=>{if(a&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",s(e)),e;const t=e.editedFeatures?.find((({layerId:e})=>e===this.layerId));if(t){const{adds:i,updates:r,deletes:d}=t.editedFeatures,n={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:i?i.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],deletedFeatures:d?d.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],updatedFeatures:r?r.map((({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],editedFeatures:s(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s(e.historicMoment)};return this.emit("edits",n),n}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:s(e.editedFeatures),exceededTransferLimit:!1,historicMoment:s(e.historicMoment)}})).then((e=>("historicMoment"in this&&this.historicMoment!==e.historicMoment&&u(t,r)&&(this.historicMoment=e.historicMoment),e)));this.emit("apply-edits",{result:h})},this._updateMomentHandler=e=>{const{serviceUrl:t,gdbVersion:s,moment:i}=e,r=t===this.url,d=j(this),n=j(this)&&y(t,s,this.gdbVersion),o=j(this)&&!y(t,this.gdbVersion,null);r&&d&&n&&o&&"historicMoment"in this&&this.historicMoment!==i&&(this.historicMoment=i)},this.when().then((()=>{this.addHandles(m(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(p(this._updateMomentHandler))}),(()=>{}))}};return i=g,d=e([r(F)],d),d};export{M as E,u as a,I as b,n as c,p as d,f as e,a as f,l as g,o as h,c as i,b as j,m as o,y as v};
