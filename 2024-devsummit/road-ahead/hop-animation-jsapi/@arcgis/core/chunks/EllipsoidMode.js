/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{D as e}from"./Material.js";import{V as t}from"./VertexAttribute.js";import{D as s,T as r,U as a}from"./enums.js";import{V as i}from"./VertexElementDescriptor.js";import{V as l}from"./VertexArrayObject2.js";import{B as n}from"./BufferObject.js";import{a as o,T as c}from"./Texture.js";import{_ as h}from"./tslib.es6.js";import u from"../core/Accessor.js";import{f as d,r as f}from"./asyncUtils.js";import{L as p}from"./Logger.js";import{s as m}from"./ensureType.js";import{f as y,a as b}from"./maybe.js";import{throwIfAborted as g,isAbortError as _}from"../core/promiseUtils.js";import{watch as x}from"../core/reactiveUtils.js";import{property as C}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as v}from"../core/accessorSupport/decorators/subclass.js";import{f as O}from"./vec2f64.js";import{h as L}from"./hydratedFeatures.js";import w from"../core/Error.js";import{parseWhereClause as T}from"../core/sql.js";import{f as A,c as M}from"./date.js";import{formatNumber as S}from"../intl.js";import{y as P,b as D,isDateField as I,isNumericField as G}from"../layers/support/fieldUtils.js";import{a as j,g as E}from"./labelUtils.js";import{b as R}from"./calloutUtils.js";import{G as V,b as z,l as F,c as U,d as q,T as N,V as B,e as Q,f as k,h as $,i as H,v as Y,j as W,k as K,m as X,n as Z,o as J}from"./ElevationUpdateEvent.js";import{s as ee,l as te}from"./vec3.js";import{Z as se,f as re}from"./vec3f64.js";import{c as ae,p as ie,o as le}from"./aaBoundingBox.js";import{H as ne}from"./HUDMaterial.js";import{W as oe}from"./RibbonLineMaterial.js";import{T as ce,Y as he}from"./Scheduler.js";import{M as ue,a as de}from"./MemCache.js";import{addFrameTask as fe,P as pe}from"../core/scheduling.js";import{n as me}from"./InterleavedLayout.js";import{T as ye}from"./IntegerPassUniform.js";import{O as be,Q as ge}from"./unitUtils.js";new i(t.POSITION,3,s.FLOAT,0,12),new i(t.POSITION,3,s.FLOAT,0,20),new i(t.UV0,2,s.FLOAT,12,20),new i(t.POSITION,3,s.FLOAT,0,32),new i(t.NORMAL,3,s.FLOAT,12,32),new i(t.UV0,2,s.FLOAT,24,32),new i(t.POSITION,3,s.FLOAT,0,16),new i(t.COLOR,4,s.UNSIGNED_BYTE,12,16);const _e=[new i(t.POSITION,2,s.FLOAT,0,8)],xe=[new i(t.POSITION,2,s.FLOAT,0,16),new i(t.UV0,2,s.FLOAT,8,16)];function Ce(t,s=_e,r=e,i=-1,o=1){let c=null;return c=s===xe?new Float32Array([i,i,0,0,o,i,1,0,i,o,0,1,o,o,1,1]):new Float32Array([i,i,o,i,i,o,o,o]),new l(t,r,{geometry:s},{geometry:n.createVertex(t,a.STATIC_DRAW,c)})}function ve(e){const t=new o(4);return t.samplingMode=r.NEAREST,new c(e,t)}const Oe=()=>p.getLogger("esri.layers.support.labelFormatUtils"),Le={type:"simple",evaluate:()=>null},we={getAttribute:(e,t)=>e.field(t)};function Te(e){return e instanceof V?e.graphics3DSymbol:e instanceof z?e:null}const Ae=()=>p.getLogger("esri.views.3d.layers.graphics.labelPlacement");class Me{constructor(e,t,s,r=null){this.graphics3DGraphic=e,this.labelSymbol=t,this.labelClass=s,this.disablePlacement=r}}function Se(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:s,graphics3DGraphic:r}=e,a=Te(r.graphics3DSymbol),i="point-3d"===a?.symbol.type?a.symbol:null,l=Ee[t]||Ie(e);return null!=i&&i.supportsCallout()&&i.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:je(i.verticalOffset),anchor:null,normalizedOffset:null}:!s||!s.hasVisibleVerticalOffset()||null!=i&&i.supportsCallout()&&i.verticalOffset&&!r.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:l&&"above-center"===l.placement?{placement:"above-center",verticalOffset:je(s.verticalOffset),anchor:"bottom",normalizedOffset:[0,l.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Ae().errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null)}(e);if(null==t)return null;const s=function(e,t){if(t.anchor)return t;const s=e.labelClass.labelPlacement,r=Ee[s],a=r||Ie(e);return s&&!r&&Ae().warnOncePerTick(`the requested label placement '${s}' is currently unsupported in SceneView.`),function(e,t){const s=t.graphics3DGraphic.graphic.geometry;if(null==s)return null;if(null!=t.disablePlacement)return t.labelClass.labelPlacement?(Ae().warnOncePerTick(De(e?.placement,t.disablePlacement.logEntityDescription)),Ie(t)):e;const r=s.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return Ae().warnOncePerTick(De(e?.placement,`'${r}' geometries`)),Ie(t);break;case"point":case"mesh":return e}return e}(a,e)}(e,t);if(null==s)return null;const r=s.anchor,a=!!t.hasLabelVerticalOffset,i=t.verticalOffset;return function(e,t,s){const r=s.graphics3DGraphic.graphic.geometry;if(null==r)return null;switch(r.type){case"point":!function(e,t,s){const r=Pe(s);if(null==r)return;const a=s.graphics3DGraphic.layers[0];switch(null!=a?a.getCenterObjectSpace(e.translation):ee(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,s,r){const{graphics3DGraphic:a}=s,i=null!=r?r.getScreenSize():null;if(a.isDraped||null==i)e.hasLabelVerticalOffset||"center"===e.anchor||(Ee[s.labelClass.labelPlacement]&&Ae().warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center");else{const r=function(e,t=Ve){const{graphics3DGraphic:s}=e,r=s.layers[0],a=r?.stageObject.geometries[0].material??null;if(a&&a instanceof ne){const e=a.parameters.anchorPosition;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(s);e.screenOffset[0]=i[0]/2*(t.normalizedOffset[0]-r[0]);const a=i[1]/2*(t.normalizedOffset[1]-r[1]);e.hasLabelVerticalOffset?(e.centerOffset[1]=a,e.centerOffsetUnits="screen"):e.screenOffset[1]=a}}(e,t,s,a);break;case"object":Ge(e,t,a)}}(e,t,s);break;case"polygon":!function(e,t,s){const r=Pe(s);if(null!=r)switch(r.type){case"extrude":{const r=s.graphics3DGraphic.layers[0];null!=r?(r.getBoundingBoxObjectSpace(ze),ie(ze,e.translation),e.translation[2]=le(ze)/2):ee(e.translation,0,0,0),Ge(e,t,r);break}}}(e,t,s);break;case"mesh":Ge(e,t,s.graphics3DGraphic.layers[0])}const a=F-U;return e.screenOffset[0]+=a*t.normalizedOffset[0],e.screenOffset[1]+=a*t.normalizedOffset[1],e}(new q(i,r,a),s,e)}function Pe(e){const t=Te(e.graphics3DGraphic.graphics3DSymbol);return null!=t?t.symbol.symbolLayers.at(0):null}function De(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function Ie(e){const t=e.graphics3DGraphic.graphic.geometry;if(null==t)return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:se,anchor:"center"};case"polygon":{const t=Pe(e);return null!=t&&"extrude"===t.type?Ee["above-center"]:{placement:"center-center",normalizedOffset:se,anchor:"center"}}case"point":case"mesh":return Ee["above-center"];default:return}}function Ge(e,t,s){const r=null!=s?s.getBoundingBoxObjectSpace(ze):ze,a=re(r[3]-r[0],r[4]-r[1],r[5]-r[2]),i=Math.sqrt(a[0]*a[0]+a[1]*a[1]);e.centerOffset[0]=i/2*t.normalizedOffset[0];const l=e.translation[2],n=a[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=l+n;const o=te(a);e.centerOffset[2]=o/2*t.normalizedOffset[2]}function je(e){const{screenLength:t,minWorldLength:s,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:s,maxWorldLength:r}}const Ee={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Re={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Re){const t=Re[e],s=Ee[e];t.forEach((e=>{Ee[e]=s}))}Object.freeze&&(Object.freeze(Ee),Object.keys(Ee).forEach((e=>{Object.freeze(Ee[e]),Object.freeze(Ee[e]?.normalizedOffset)})));const Ve=[0,0],ze=ae();class Fe{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}class Ue{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.addedToTextureAtlas=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class qe{constructor(e,t,s,r,a){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=s,this.textRenderParameters=r,this.labelFunction=a,this.calloutSymbolLayerIndex=0}}class Ne{constructor(e,t,s,r,a,i,l,n){this.layer=t,this.graphics3DCore=s,this.scaleVisibility=r,this.emptySymbolLabelSupported=a,this.elevationInfoOverride=i,this.disablePlacement=l,this.active=n,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new oe(e,{pickable:!0,disableOctree:!0},t.uid)}destroy(){this.stageLayer.destroy()}}let Be=class extends u{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this.addHandles([x((()=>this.view.state?.camera),(()=>this.setDirty())),x((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(ce.LABELER,this)]),this._textTextureAtlas=new N({view:this.view}),this._hudMaterialCollection=new Fe(this.view._stage),this._calloutMaterialCollection=new Fe(this.view._stage)}dispose(){this.removeAllHandles(),this._textTextureAtlas=y(this._textTextureAtlas),this._hudMaterialCollection=y(this._hudMaterialCollection),this._calloutMaterialCollection=y(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear()}destroy(){this.dispose(),He.graphic=null,He.renderingInfo=null,He.layer=null}_activateLabelingContext(e){e.graphics.forEach(((t,s)=>{const r=new Ue(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r),t.setVisibilityFlag(B.LABEL,Q.USER,!0)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(B.LABEL,Q.USER,!1),this.setLabelGraphicVisibility(e,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];s&&(this._textTextureAtlas.addTextTexture(s,t.stageObject),e.addedToTextureAtlas=!0)}}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const s=e.textRenderers[t._labelIndex];null!=s&&(this._textTextureAtlas.removeTextTexture(s,t.stageObject),e.addedToTextureAtlas=!1)}}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),he}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active)if(Qe(t))this._dirty=!0;else if(ke(t.labelClassContexts)){if(null===t.labelClassContexts){this._deactivateLabelingContext(t);continue}this._createLabelClassContext(t),this._dirty=!0}else m(t.labelsToInitialize,((s,r)=>(this._ensureGraphics3DResources(s)&&(this._labels.set(r,s),this.deconflictor.setDirty(),e.madeProgress()),(s.visible&&s.textInitialized||!s.visible&&s.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0);this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;e.layer.when&&await e.layer.when(),g(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const s=e.graphics3DCore,r=s.layer,a=r.labelingInfo?.filter((e=>!!e.symbol));if(!a||0===a.length)return;let i=!1;await d(a,(async(r,a)=>{const l=r.symbol,n=Te(s.getOrCreateGraphics3DSymbol(l));if(null==n)return void p.getLogger(this).error("Failed to create Graphics3DSymbol for label");await n.load(),g(t);let o=null;R(l)&&l.hasVisibleCallout()&&(o=J(l,s.symbolCreationContext),await o.load(),g(t));const c=await f(async function(e,t,s){if(!e||!e.symbol||!t)return Le;const r=e.where,a=j(e);let i;if("arcade"===a.type){const e=await P(a.expression,s,t);if(null==e)return Le;i={type:"arcade",evaluate(t,s){try{const r="attributes"in t?e.repurposeFeature(t):t;r.contextTimeZone=s??null;const a=e.evaluate({$view:{timeZone:s},$feature:r},e.services);if(null!=a)return a.toString()}catch(e){Oe().error(new w("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:e,feature:t,expression:a}))}return null},needsHydrationToEvaluate:()=>null==E(a.expression)}}else i={type:"simple",evaluate:e=>a.expression.replaceAll(/{[^}]*}/g,(s=>{const r=s.slice(1,-1),a=t.get(r);if(!a)return s;let i=null;return"attributes"in e?e&&e.attributes&&(i=e.attributes[a.name]):i=e.field(a.name),null==i?"":function(e,t){if(null==e)return"";const s=t.domain;if(s)if("codedValue"===s.type||"coded-value"===s.type){const t=e;for(const e of s.codedValues)if(e.code===t)return e.name}else if("range"===s.type){const{max:r,min:a}=D(t),i=+e;if(null!=a&&null!=r&&a<=i&&i<=r)return s.name}let r=e;return I(t)?r=A(r,M("short-date")):G(t)&&(r=S(+r)),r||""}(i,a)}))};if(r){let e;try{e=await T(r,t)}catch(e){return Oe().error(new w("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:r,error:e})),Le}const s=i.evaluate;i.evaluate=(t,a)=>{const i="attributes"in t?void 0:we;try{if(e.testFeature(t,i))return s(t,a)}catch(e){Oe().error(new w("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:r,feature:t,error:e}))}return null}}return i}(r,e.layer.fieldsIndex,this.view.spatialReference));if(g(t),!0===c.ok){const s=await this._createTextRenderParameters(n.symbol);g(t),e.labelClassContexts[a]=new qe(r,n,o,s,c.value)}else p.getLogger(this).error(`Label expression failed to evaluate: ${c.error}`),i=!0})),g(t)}async _createLabelClassContext(e){return null==e.labelClassPromise&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(_(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.at(0);return"text"!==t?.type?null:k.fromSymbol(t,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,b(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,s,r,a,i){const l=new $(s,H(s.anchor),Y(s.anchor),e.text,O(e.displayWidth,e.displayHeight));return He.graphic=t,He.renderingInfo=null,He.layer=r,a.createLabel(He,l,this._hudMaterialCollection,this._textTextureAtlas,(()=>{const e=Se(i);return e?e.elevationOffset:null}))}_createLineCalloutGraphic(e,t,s,r,a){He.graphic=e,He.layer=a;const i=r.screenOffset[0];return He.renderingInfo=new W(null,t,r.translation,r.centerOffset,i,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),s.createGraphics3DGraphic(He)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const s=e.labelingContext,r=s.labelClassContexts;if(ke(r)||!s.emptySymbolLabelSupported&&0===t.layers.length)return!1;let a=!1;const i=t.graphic,l=s.layer,n=$e(s.layer);for(let o=0;o<r.length;o++){const c=e.textRenderers[o],h=e.textLabelPlacements[o];if(null==c||null==h)continue;const u=r[o],d=u.graphics3DSymbol,f=d.symbol&&"label-3d"===d.symbol.type?d.symbol:null,p=d.symbolLayers[0];if(!p)continue;p.setElevationInfoOverride(s.elevationInfoOverride);const m=new Me(t,f,u.labelClass),y=this._createTextSymbolGraphic(c,i,h,l,p,m);if(null==y)return!1;y._labelClass=u.labelClass,y._labelIndex=o,t.addLabelGraphic(y,s.stageLayer),t.deconflictionPriority=u.textRenderParameters?.definition.size??0,t.setVisibilityFlag(B.LABEL,Q.USER,n),t.setVisibilityFlag(B.LABEL,Q.SCALE_RANGE,!0),t.setVisibilityFlag(B.LABEL,Q.DECONFLICTION,!1),a=!0;const b=u.graphics3DCalloutSymbolLayer;if(b&&h.hasLabelVerticalOffset){b.setElevationInfoOverride(s.elevationInfoOverride);const e=this._createLineCalloutGraphic(i,f,b,h,l);null!=e&&(u.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,s.stageLayer))}break}return s.scaleVisibility&&a&&s.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const s of e.graphics3DGraphic.labelLayers){if(null==s._labelClass)continue;const e=t[s._labelIndex].graphics3DSymbol.symbolLayers[0];e?.onRemoveGraphic(s)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,s=t.labelClassContexts;if(ke(s))return;const r=e.graphics3DGraphic.graphic;for(let a=0;a<s.length;a++){const i=s[a];if(e.textRenderers[a]=null,e.textLabelPlacements[a]=null,null==i?.textRenderParameters)continue;const l=i.labelFunction;let n;if("arcade"===l.type)try{const e=l.needsHydrationToEvaluate()?L(r,t.layer):r;n=l.evaluate(e)}catch(e){n=null}else n=l.evaluate(r);if(null==n||""===n||/^\s+$/.test(n))continue;const o=i.graphics3DSymbol,c="label-3d"===o.symbol?.type?o.symbol:null;if(!o.symbolLayers[0])continue;const h=Se({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:c,labelClass:i.labelClass,disablePlacement:t.disablePlacement});if(null==h)continue;const u=H(h.anchor),d=K(u);e.textRenderers[a]=new X(n,d,i.textRenderParameters,N.maxSize),e.textLabelPlacements[a]=h}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const s=t.graphic.uid;if(e.graphics.set(s,t),e.active){const r=new Ue(e,t);this._labels.set(s,r),e.labelsToInitialize.set(s,r)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const s=t.graphic.uid,r=this._labels.get(s);e.graphics.delete(s),r&&(this._destroyGraphic(r,s),e.labelsToInitialize.delete(s),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.delete(t),e.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const s of t){const t=e.graphics.get(s);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const s of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const a=e=>e.labelLayers[0];if(s.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,a),s.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[s.calloutSymbolLayerIndex];s.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=$e(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,s)=>{const r=this._labels.get(s);r&&(this._destroyGraphic(r,s),r.visible=!1,e.labelsToInitialize.set(s,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,s){const r=s&&s.emptySymbolLabelSupported||!1,a=s?.elevationInfoOverride||null,i=s?.disablePlacement||null;if(this._findLabelingContext(e))return;const l=e.layer,n=new Ne(this.view._stage,l,e,t,r,a,i,$e(l));return this._labelingContexts.push(n),this.setDirty(),{addGraphic:e=>this._addGraphic(n,e),removeGraphic:e=>this._removeGraphic(n,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>$e(n.layer),labelingInfoChange:e=>this._labelingInfoChange(n,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",n),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",n),visibilityInfoChange:()=>this._visibilityInfoChange(n),reset:()=>this._resetLabels(n),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const s=this._labelingContexts.indexOf(t);this._labelingContexts.splice(s,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),t.destroy(),this.setDirty()}setLabelGraphicVisibility(e,t){const s=e.graphic.uid,r=this._labels.get(s);r&&r.visible!==t&&(t&&!r.addedToTextureAtlas?(this._addLabelTextureToAtlas(r),r.textInitialized||r.labelingContext.labelsToInitialize.set(s,r)):!t&&r.addedToTextureAtlas&&this._removeLabelTextureFromAtlas(r),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>Qe(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(Qe(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function Qe(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function ke(e){return!e||0===e.length}function $e(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}h([C({constructOnly:!0})],Be.prototype,"view",void 0),h([C({constructOnly:!0})],Be.prototype,"deconflictor",void 0),h([C()],Be.prototype,"_textTextureAtlas",void 0),h([C({type:Boolean,readOnly:!0})],Be.prototype,"updating",null),Be=h([v("esri.views.3d.layers.graphics.Labeler")],Be);const He=new Z(null,null,null);var Ye;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(Ye||(Ye={}));const We=(()=>{const e=new Array;return e[Ye.ELEVATION]=10,e[Ye.BASEMAP]=10,e[Ye.I3S_INDEX]=10,e[Ye.I3S_DATA]=10,e[Ye.SYMBOLOGY]=5,e})(),Ke=30;function Xe(e){return new Je({view:e})}const Ze=.1;let Je=class extends u{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new ue,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0,this.addHandles(fe({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(e){null!=e&&(this._additionalCacheMemory=e)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(e,t){return new de(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>.1&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,.1),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){if(!this.view)return;this.view._stage?.renderer?.tick();const e=this.view._stage?.renderer?.usedMemory;let t=(this.view.basemapTerrain?.usedMemory??0)+(e?e.fbos+e.edges+e.plugins:0),s=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if("usedMemory"in(r=e)&&"unloadedMemory"in r&&"ignoresMemoryFactor"in r){const r=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*r,s+=e.unloadedMemory*r}var r}));const r=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(t>a&&r){this._warnMemoryUsage=t;const e=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);p.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(a)} Current: ${e(t)} Projected: ${e(t+s)} Quality: ${r}%`)}this._usedMemory=t/a,this._memoryPredicted=(t+s)/a;const i=a-t;this._cacheStorage.maxSize=Math.max(0,i+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t},disableMemCache:()=>e.disableMemCache()}}};h([C({constructOnly:!0})],Je.prototype,"view",void 0),h([C()],Je.prototype,"maxMemory",null),h([C()],Je.prototype,"additionalCacheMemory",null),h([C({readOnly:!0})],Je.prototype,"memoryFactor",null),h([C({readOnly:!0})],Je.prototype,"updating",null),h([C({readOnly:!0})],Je.prototype,"usedMemory",null),h([C({readOnly:!0})],Je.prototype,"usedCacheMemory",null),h([C()],Je.prototype,"_quality",void 0),h([C()],Je.prototype,"_usedMemory",void 0),h([C()],Je.prototype,"_updating",void 0),h([C()],Je.prototype,"_stableQuality",void 0),h([C()],Je.prototype,"_maxMemory",void 0),h([C()],Je.prototype,"_additionalCacheMemory",void 0),Je=h([v("esri.views.3d.support.MemoryController")],Je);const et={value:.5,readOnly:!0},tt={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};var st,rt;!function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(st||(st={}));class at{constructor(){this._queue=new pe,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),null!=e&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e?.[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class it{constructor(){this._q=new pe}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),null!=e){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.isLeaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function lt(e,t,s){if(null==t?.fullExtent)return!1;const r=t.fullExtent,a=e.extent;if(s){if(a[0]<r.xmin||a[1]<r.ymin||a[2]>r.xmax||a[3]>r.ymax)return!1}else if(r.xmin>a[2]||r.ymin>a[3]||r.xmax<a[0]||r.ymax<a[1])return!1;const i=e.surface.tilingScheme.levels[e.level].scale,l=t.minScale;if(l>0&&i>1.00000001*l)return!1;const n=t.maxScale;return!(n>0&&i<.99999999*n)}function nt(e,t){const s=e.lij,r=t.lij;return s[0]-r[0]||s[1]-r[1]||s[2]-r[2]}function ot(e,t,s=null){null==s||0===s.length?e===st.BACK_TO_FRONT?t.sort(ct):t.sort(ht):t.sort(((t,r)=>function(e,t,s,r){return dt(e,r)===dt(t,r)?ut(e,t,s):e?s:-s}(t,r,e,s)))}function ct(e,t){const s=t.screenDepth-e.screenDepth;if(0!==s)return s;const r=e.lij,a=t.lij;return r[0]-a[0]||r[1]-a[1]||r[2]-a[2]}function ht(e,t){const s=e.screenDepth-t.screenDepth;if(0!==s)return s;const r=e.lij,a=t.lij;return r[0]-a[0]||r[1]-a[1]||r[2]-a[2]}function ut(e,t,s){const r=e.screenDepth,a=t.screenDepth;return r<a?-s:r>a?s:nt(e,t)}function dt(e,t){for(const s of t)if(e.intersectsExtent(s))return!0;return!1}function ft(e,t){const s=e.distanceToPOI-t.distanceToPOI;if(0!==s)return s;const r=e.lij,a=t.lij;return r[0]-a[0]||r[1]-a[1]||r[2]-a[2]}function pt(e,t){const s=e.length;for(let r=0;r<s;++r)e.at(r).updateDistanceToPOI(t);e.sort(ft)}function mt(e,t,s){let r=1,a=0,i=0;for(;e!==t;)if(r*=.5,a*=.5,i*=.5,1&e.lij[2]&&(a+=.5),0==(1&e.lij[1])&&(i+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");s.init(t,a,i,r)}function yt(e){for(let t=0;t<e.length;t++){const s=e[t],r=s.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==s)return!0}}return!1}function bt(e,t){if(!e||!t||e[0]===t[0])return!1;const s=e[0]<t[0],r=s?e:t,a=s?t:e,i=1<<a[0]-r[0];return Math.floor(a[1]/i)===r[1]&&Math.floor(a[2]/i)===r[2]}function gt(e){const s=me().vec3f(t.POSITION);return e.hasNormals&&s.vec2i16(t.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===ye.Default?s.vec2f(t.UV0):e.textureCoordinates===ye.Atlas&&(s.vec2f(t.UV0),s.vec4u16(t.UVREGION,{glNormalized:!0})),e.colors&&s.vec4u8(t.COLOR,{glNormalized:!0}),s}function _t(e){return e&&be(e)?rt.Mars:e&&ge(e)?rt.Moon:rt.Earth}!function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(rt||(rt={}));export{Ye as C,rt as E,at as I,Be as L,xe as P,st as R,et as a,Ze as b,gt as c,$e as d,Ce as e,We as f,_t as g,lt as h,mt as i,nt as j,ve as k,ut as l,Ke as m,Xe as n,it as o,yt as p,pt as q,_e as r,ot as s,bt as t,tt as u};
