/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../request.js";import{v as t,w as r,h as n,x as o,y as a}from"../core/lang.js";import s from"../core/Error.js";import{i}from"./mat4.js";import{c as l}from"./mat4f64.js";import{s as c,g as u,p as f}from"./vec3.js";import{c as p}from"./vec3f64.js";import{canProjectWithoutEngine as d}from"../geometry/projection.js";import{g as h}from"./spatialReferenceEllipsoidUtils.js";import{p as m}from"./projectVectorToVector.js";import{c as y,e as g,k as w,l as S}from"./aaBoundingRect.js";import{g as b}from"./sphere.js";import T from"../rest/support/Query.js";import{r as I}from"./I3SBinaryReader.js";import{r as v}from"./unitUtils.js";import{c as E}from"./computeTranslationToOriginAndRotation.js";import{c as M,a as R}from"./edgeUtils.js";import{p as x,C as j}from"./symbolColorUtils.js";import{O as C,a as N,I as U}from"./orientedBoundingBox.js";import k from"../geometry/SpatialReference.js";function D(e,t,r,n){const o=W(e,t,r),a=l();return E(r,o,a,n),a}const O=1,q=5-O;function W(e,t,r){const n=p(),o=e[3],a=2**(Math.ceil(Math.log(o)*Math.LOG2E/q)*q+O);if(r.isGeographic){const t=a/v(r).radius*180/Math.PI,o=Math.round(e[1]/t),s=Math.max(-90,Math.min(90,o*t)),i=t/Math.cos((Math.abs(s)-t/2)/180*Math.PI),l=Math.round(e[0]/i)*i;n[0]=l,n[1]=s}else{const t=Math.round(e[0]/a),r=Math.round(e[1]/a);n[0]=t*a,n[1]=r*a}const s=e[2]+t,i=Math.round(s/a);return n[2]=i*a,n}function _(e){return e?parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10):void 0}function F(e){if(n("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function L(e,t,r,n){r.traverse(t,(t=>{const r=t.serviceMbsInIndexSR;return(null!=r&&z(e,r))!==B.OUTSIDE&&(n(t),!0)}))}function A(e,t,r){let n=0,o=0;for(let a=0;a<t.length&&n<e.length;a++)e[n]===t[a]&&(r(a)&&(e[o]=e[n],o++),n++);e.length=o}function K(e,t,r){let n=0,a=0;for(;n<r.length;)o(e,r[n])>=0===t&&(r[a]=r[n],a++),n++;r.length=a}const G=y();function P(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return G[0]=(e[0]-t.position[0])/t.rotationScale[0],G[1]=(e[1]-t.position[1])/t.rotationScale[4],G[2]=(e[2]-t.position[0])/t.rotationScale[0],G[3]=(e[3]-t.position[1])/t.rotationScale[4],G}var B;function z(e,t){const r=t[0],n=t[1],o=t[3],a=e[0]-r,s=r-e[2],i=e[1]-n,l=n-e[3],c=Math.max(a,s,0),u=Math.max(i,l,0),f=c*c+u*u;return f>o*o?B.OUTSIDE:f>0?B.INTERSECTS_CENTER_OUTSIDE:-Math.max(a,s,i,l)>o?B.INSIDE:B.INTERSECTS_CENTER_INSIDE}function $(e,t,r){const n=[],o=r?.missingFields,a=r?.originalFields;for(const r of e){const e=r.toLowerCase();let s=!1;for(const o of t)if(e===o.name.toLowerCase()){n.push(o.name),s=!0,a&&a.push(r);break}!s&&o&&o.push(r)}return n}async function V(e,t,r,n,o,a){if(0===t.length)return[];const i=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await async function(e,t,r,n,o){t.sort(((e,t)=>e.attributes[r]-t.attributes[r]));const a=t.map((e=>e.attributes[r])),s=[],i=$(n,e.fields,{originalFields:s}),l=await Q(e,a,i,o);for(let e=0;e<t.length;e++){const r=t[e],n=l[e],o={};if(r.attributes)for(const e in r.attributes)o[e]=r.attributes[e];for(let e=0;e<s.length;e++)o[s[e]]=n[i[e]];r.attributes=o}return t}(e.associatedLayer,t,r,n,a)}catch(t){if(e.associatedLayer.loaded)throw t}if(i){const l=function(e,t,r){const n=new Map,o=[],a=r();for(const r of e){const e=r.attributes[t];for(let t=0;t<a.length;t++){const s=a[t],i=s.featureIds.indexOf(e);if(i>=0){let e=n.get(s.node);e||(e={node:s.node,indices:[],graphics:[]},o.push(e),n.set(s.node,e)),e.indices.push(i),e.graphics.push(r);for(let e=t;e>0;e--)a[e]=a[e-1];a[0]=s;break}}}return o}(t,r,o);if(null==l)throw new s("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const c=e.parsedUrl.path,u=await Promise.all(l.map((t=>function(e,t,r,n,o,a,s,i){return X(e,t,r.resources.attributes,n,o,a,s,i)}(c,i,t.node,t.indices,n,e.apiKey,e.customParameters,a).then((e=>{for(let r=0;r<t.graphics.length;r++){const n=t.graphics[r],o=e[r];if(n.attributes)for(const e in n.attributes)e in o||(o[e]=n.attributes[e]);n.attributes=o}return t.graphics})))));return u.flat()}throw new s("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function Q(e,t,r,n){const o=e.capabilities.query.maxRecordCount;if(null!=o&&t.length>o){const s=a(t,o);return Promise.all(s.map((t=>Q(e,t,r,n)))).then((e=>e.flat()))}const i=new T({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(i,n).then((e=>{if(e&&e.features&&e.features.length===t.length)return e.features.map((e=>e.attributes));throw new s("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}async function X(t,r,n,o,a,s,i,l){const c=[];for(const e of r)if(e&&a.includes(e.name)){const r=`${t}/nodes/${n}/attributes/${e.key}/0`;c.push({url:r,storageInfo:e})}const u=await Promise.allSettled(c.map((t=>e(t.url,{responseType:"array-buffer",query:{...i,token:s},signal:l?.signal}).then((e=>I(t.storageInfo,e.data)))))),f=[];for(const e of o){const t={};for(let r=0;r<u.length;r++){const n=u[r];if("fulfilled"===n.status){const o=n.value;t[c[r].storageInfo.name]=J(o,e)}}f.push(t)}return f}!function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"}(B||(B={}));const Z=-32768,H=-(2**31);function J(e,n){if(!e)return null;const o=e[n];return t(e)?o===Z?null:o:r(e)?o===H?null:o:o!=o?null:o}function Y(e){const t=e.store,r=t.indexCRS||t.geographicCRS,n=void 0===r?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=r?new k(_(r)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function ee(e){const t=e.store,r=t.vertexCRS||t.projectedCRS,n=void 0===r?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new s("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new s("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const o=r?new k(_(r)):e.spatialReference;return o.equals(e.spatialReference)?e.spatialReference:o}function te(e,t){return null==t?"@null":t===h(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function re(e,t,r){if(!d(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}(e,t))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function ne(e,t,r){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new s("layerview:recycle-failed")}function oe(e,t,r){const n=Y(e),o=ee(e);re(n,t,r),re(o,t,r)}function ae(e){if(null==e.store?.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes?.position)throw new s("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t}function se(e,t){oe(e,t.spatialReference,t.viewingMode)}function ie(e){if(null==e.store?.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes?.position)throw new s("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t}function le(e,t){re(e.spatialReference,t.spatialReference,t.viewingMode)}function ce(e){return"mesh-3d"===e.type}function ue(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.getSymbols();if(0===t.length)return!0;for(const e of t){if(!ce(e)||0===e.symbolLayers.length)return!0;for(const t of e.symbolLayers.items)if("fill"!==t.type||null==t.material?.color||"replace"!==t.material.colorMixMode)return!0}return!1}const fe=M({color:[0,0,0,0],opacity:0});class pe{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function de(e){const t=new pe;let r=!1,n=!1;for(const o of e.symbolLayers.items)if("fill"===o.type&&o.enabled){const e=o.material,a=o.edges;if(null!=e&&!r){const n=e.color,a=x(e.colorMixMode);t.material=null!=n?{color:[n.r/255,n.g/255,n.b/255],alpha:n.a,colorMixMode:a}:{color:[1,1,1],alpha:1,colorMixMode:j.Multiply},t.castShadows=o.castShadows,r=!0}null==a||n||(t.edgeMaterial=R(a,{}),n=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:j.Multiply}),t}function he(e,t){return(0|e)+(0|t)|0}function me(e,t,r,n,o,a,s){if(!a||0===a.length||null==t||!e.serviceMbsInIndexSR)return null;const l=D(e.serviceMbsInIndexSR,o,r,t);i(Re,l);let p=null,d=1/0,h=-1/0;if(a.forEach((a=>(a=>{if("replace"!==a.type)return;const i=a.geometry;if(!i?.hasZ)return;g(Te);const l=i.spatialReference||n,y=i.rings.reduce(((e,r)=>r.reduce(((e,r)=>(c(Ee,r[0],r[1],r[2]),m(Ee,l,Ee,t),u(Ee,Ee,Re),w(Te,Ee),Math.min(Ee[2],e))),e)),1/0);(()=>{if(!p)if(p=be,g(Ie),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(ve,r,t,o,s),ve.getCorners(p);for(const e of p)u(e,e,Re),w(Ie,e)}else{const n=e.serviceMbsInIndexSR;if(!n)return;const a=n[3];m(b(n),r,Ee,t),u(Ee,Ee,Re),Ee[2]+=o;for(let e=0;e<8;++e){const t=1&e?a:-a,r=2&e?a:-a,n=4&e?a:-a,o=p[e];f(o,[Ee[0]+t,Ee[1]+r,Ee[2]+n]),w(Ie,o)}}})(),S(Ie,Te)&&(d=Math.min(d,y),h=Math.max(h,y))})(a))),d===1/0)return null;for(let e=0;e<8;++e)y=Me.data,T=3*e,I=p[e],u(Ee,I,l),y[T]=Ee[0],y[T+1]=Ee[1],y[T+2]=Ee[2],T+=24,I[2]=d,u(Ee,I,l),y[T]=Ee[0],y[T+1]=Ee[1],y[T+2]=Ee[2],T+=24,I[2]=h,u(Ee,I,l),y[T]=Ee[0],y[T+1]=Ee[1],y[T+2]=Ee[2];var y,T,I;return N(Me)}function ye(e){return null!=e&&e.halfSizeX>=0}function ge(e){return e[3]>=0}function we(e){null!=e&&(e.halfSize=U)}function Se(e){null!=e&&(e[3]=-1)}const be=[p(),p(),p(),p(),p(),p(),p(),p()],Te=y(),Ie=y(),ve=new C,Ee=p(),Me={data:new Array(72),size:3,exclusive:!0,stride:3},Re=l();export{me as A,W as B,de as C,fe as D,P as E,B as M,we as a,A as b,ne as c,J as d,oe as e,$ as f,Y as g,F as h,Se as i,re as j,ie as k,le as l,he as m,ge as n,K as o,ye as p,X as q,z as r,ee as s,L as t,ue as u,ae as v,V as w,se as x,te as y,D as z};
