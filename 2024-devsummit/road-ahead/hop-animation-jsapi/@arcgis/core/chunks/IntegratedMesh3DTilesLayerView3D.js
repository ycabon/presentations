/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Error.js";import{L as s}from"./Logger.js";import{d as r}from"./maybe.js";import{watch as o,initial as i}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{f as m,i as n}from"./mat3.js";import{c as l,I as j}from"./mat3f64.js";import{v as c,w as u}from"./mat4.js";import{c as d}from"./mat4f64.js";import{h as y,w as g}from"./vec3.js";import{e as h,c as f}from"./vec3f64.js";import{f as b}from"./vec4f64.js";import{S as w}from"./unitUtils.js";import{c as v}from"./computeTranslationToOriginAndRotation.js";import{L as U,l as M}from"./LayerElevationProvider.js";import{p as T}from"./projectVectorToVector.js";import{c as S,o as x,s as C,b as P,n as _,r as E,a as I,C as L,t as O,p as D}from"./BufferView.js";import{a as V,b as R,c as A,d as F,e as B,i as k,w as H,f as G,g as N,h as W,j as z}from"./ILyr3DWasmPerSceneView.js";import{g as q}from"./unitConversionUtils.js";import{V as Q}from"./ViewingMode.js";import{L as J}from"./LayerViewPerformanceInfo.js";import{a as Z}from"./RenderGeometry.js";import{L as K}from"./LayerView3D.js";import{a as X,g as Y,r as $}from"../widgets/Attribution/AttributionViewModel.js";import{A as ee,C as te,T as se}from"./basicInterfaces.js";import{m as re,b as oe}from"./enums.js";import ie from"../Graphic.js";import{T as ae}from"./Intersector3.js";import{I as pe,S as me,c as ne}from"./Intersector2.js";import{E as le}from"./ElevationRange.js";import{a as je}from"./orientedBoundingBox.js";import{c as ce,g as ue}from"./EllipsoidMode.js";import{C as de}from"../views/SceneView.js";import{R as ye}from"./RenderTexture.js";import{T as ge}from"./IntegerPassUniform.js";import{A as he}from"./Attribute.js";import{c as fe}from"./Normals.js";import{T as be}from"./StencilUtils.js";import{V as we}from"./VertexAttribute.js";import{a as ve}from"./DefaultBufferWriter.js";import Ue from"../views/layers/LayerView.js";import"../config.js";import"./asyncUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./ObservableBase.js";import"./tracking.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./ensureType.js";import"./shared.js";import"./SimpleObservable.js";import"./common.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./mathUtils.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"./aaBoundingRect.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./sphere.js";import"./vec4.js";import"./Axis.js";import"./plane.js";import"./quatf64.js";import"./vec2f64.js";import"./mathUtils2.js";import"./ElevationUpdateEvent.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../Color.js";import"./colorUtils.js";import"./screenUtils.js";import"./enumeration.js";import"./materialUtils.js";import"./opacityUtils.js";import"./ElevationContext.js";import"./ElevationProvider.js";import"./hydratedFeatures.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./dehydratedPoint.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./messages.js";import"./graphicUtils.js";import"../geometry/projection.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./aaBoundingBox.js";import"./ContentObject.js";import"./Geometry.js";import"./Indices.js";import"./Util.js";import"./triangle.js";import"./lineSegment.js";import"./doublePrecisionUtils.js";import"./vec2f32.js";import"./InterleavedLayout.js";import"./types.js";import"./Material.js";import"./interfaces5.js";import"./vec2.js";import"./HUDMaterial.js";import"./debugFlags2.js";import"./VerticalOffset.glsl.js";import"./GLTextureMaterial.js";import"./RenderPlugin.js";import"./BindType.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Texture.js";import"./OutputHighlight.glsl.js";import"./OrderIndependentTransparency.js";import"./ShaderTechniqueConfiguration.js";import"./projectBoundingRect.js";import"./dehydratedFeatures.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./OptimizedGeometry.js";import"./edgeUtils.js";import"./earcut.js";import"./_commonjsHelpers.js";import"./DoubleArray.js";import"./vec32.js";import"./SnappingCandidate.js";import"./visualVariableUtils.js";import"./compilerUtils.js";import"./lengthUtils.js";import"./sizeVariableUtils.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./RibbonLineMaterial.js";import"./Octree.js";import"./frustum.js";import"./floatRGBA.js";import"./objectResourceUtils.js";import"./devEnvironmentUtils.js";import"./DefaultMaterial_COLOR_GAMMA.js";import"./Version.js";import"./quat.js";import"./resourceUtils3.js";import"./NestedMap.js";import"./requestImageUtils.js";import"./verticalOffsetUtils.js";import"./symbolColorUtils.js";import"../views/3d/webgl/ManagedFBO.js";import"./CameraSpace.glsl.js";import"./RenderState.js";import"./projectPointToVector.js";import"./CIMSymbolHelper.js";import"./BidiEngine.js";import"./fontUtils.js";import"./GeometryUtils.js";import"./enums2.js";import"./utils6.js";import"./definitions.js";import"./HighlightOptions.js";import"./shapingUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./Rect.js";import"./BoundingBox.js";import"./defaults.js";import"./defaultsJSON.js";import"./OverrideHelper.js";import"./colorUtils2.js";import"../symbols/support/cimSymbolUtils.js";import"./utils9.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./LRUCache.js";import"./MemCache.js";import"./GeometryUtil.js";import"./vec3f32.js";import"./line.js";import"./line2.js";import"./lineStippleUtils.js";import"./projectVectorToPoint.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./imageUtils.js";import"../geometry/support/MeshTextureTransform.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"./meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"./georeference.js";import"./spatialReferenceEllipsoidUtils.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../geometry/support/MeshTransform.js";import"./axisAngleDegrees.js";import"./interfaces.js";import"./DefaultLayouts.js";import"./styleUtils.js";import"./webStyleSymbolUtils.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./glUtil.js";import"./VertexElementDescriptor.js";import"./Camera.js";import"./BufferObject.js";import"./Intersector4.js";import"./Scheduler.js";import"../core/signal.js";import"./debugFlags.js";import"./ColorMaterial.js";import"./TriangleMaterial.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./Intersector.js";import"./heightModelInfoUtils.js";import"../geometry/HeightModelInfo.js";import"./arcgisLayerUrl.js";import"./boundedPlane.js";import"./labelUtils.js";import"../Camera.js";import"../CameraLayout.js";import"./Cyclical.js";import"../Viewpoint.js";import"./domUtils.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"./GraphicsCollection.js";import"./RenderCoordsHelper.js";import"./scaleUtils.js";import"../views/View.js";import"../Map.js";import"../Basemap.js";import"./loadAll.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"../Ground.js";import"./CollectionFlattener.js";import"./editableLayers.js";import"./infoFor3D.js";import"./basemapUtils.js";import"./collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../support/TablesMixin.js";import"../TimeExtent.js";import"./timeUtils.js";import"./UpdatingHandles.js";import"../views/BasemapView.js";import"../views/Magnifier.js";import"./ReactiveMap.js";import"../rest/support/Query.js";import"./DataLayerSource.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"../views/Theme.js";import"./InputManager.js";import"./PropertiesPool.js";import"./ViewEvents.js";import"./IViewEvents.js";import"./interfaces2.js";import"./screenUtils2.js";import"../views/input/Input.js";import"../views/input/gamepad/GamepadSettings.js";import"../views/input/gamepad/GamepadInputDevice.js";import"../views/navigation/Navigation.js";import"../views/navigation/gamepad/GamepadSettings.js";import"./projectionUtils.js";import"../views/BreakpointsOwner.js";import"../views/DOMContainer.js";import"./projector.js";import"./widgetUtils.js";import"../views/GroundView.js";import"./cameraUtils.js";import"./earthUtils.js";import"./spatialReferenceSupport.js";import"../layers/support/ElevationSampler.js";import"./TerrainConst.js";import"./TilingScheme.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"./TileKey.js";import"../views/PopupView.js";import"../views/ViewAnimation.js";import"../views/3d/environment/SunLighting.js";import"../webscene/SunLighting.js";import"../views/3d/environment/VirtualLighting.js";import"../webscene/VirtualLighting.js";import"../webscene/Environment.js";import"./lightingTypes.js";import"../webscene/background/Background.js";import"../webscene/background/ColorBackground.js";import"./projectPointToWGS84ComparableLonLat.js";import"./projectVectorToWGS84ComparableLonLat.js";import"./FramebufferObject.js";import"./ShadowCastVisualizeTechniqueConfiguration.js";import"./WebGLRequirements.js";import"./capabilities.js";import"./ray.js";import"./viewpointUtils.js";import"./ZoomMomentumEstimator.js";import"./FeatureTileDescriptor3D.js";import"./hitTest.js";import"./LayerConstants.js";import"./intersectorUtilsConversions.js";import"./geometryServiceUtils.js";import"./project.js";import"./utils7.js";import"./utils8.js";import"../rest/support/ProjectParameters.js";import"./hitTestSelectUtils.js";import"./terrainUtils.js";import"../views/3d/support/SceneViewPerformanceInfo.js";import"./ByteSizeUnit.js";import"../views/3d/support/LayerPerformanceInfo.js";import"../layers/mixins/RefreshableLayer.js";import"./layerContainerType.js";import"./ElevationQueryTileCache.js";import"./LercDecoder.js";import"./WorkerHandle.js";import"./RenderableTile.js";import"./mat3f32.js";import"./enums3.js";import"./TileStrategy.js";import"./TileKey2.js";import"./QueueProcessor.js";import"./config.js";import"./TiledDisplayObject.js";import"./DisplayObject.js";import"./ElevationSamplerData.js";import"./rasterUtils.js";import"../views/2d/ViewState.js";import"./mat2df64.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./StyleDefinition.js";import"./resources.js";import"./edgeProcessing.js";import"./EdgeWorkerHandle.js";import"./workerHelper.js";import"./testSVGPremultipliedAlpha.js";import"./RenderingContext.js";import"./ProgramCache.js";import"./Program.js";import"./layerViewUtils.js";import"../views/ui/DefaultUI.js";import"../views/ui/UI.js";import"./themeUtils.js";import"../widgets/Attribution.js";import"../widgets/Widget.js";import"./uuid.js";import"./jsxWidgetSupport.js";import"./legacyIcon.js";import"./globalCss.js";import"./accessibleHandler.js";import"./messageBundle.js";import"./jsxFactory.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"./utils18.js";import"../widgets/support/GoTo.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";class Me extends J{constructor(e,t,s,r,o,i,a){super(e,0,0,0,t),this.nodesCached=s,this.vboMB=r,this.textureMB=o,this.vboMBCached=i,this.textureMBCached=a}}const Te={[V.Points]:null,[V.Lines]:null,[V.LineStrip]:null,[V.Triangles]:re.TRIANGLES,[V.TriangleStrip]:re.TRIANGLE_STRIP,[V.NotSet]:null},Se={[R.Opaque]:ee.Opaque,[R.Mask]:ee.Mask,[R.Blend]:ee.Blend},xe={[A.Back]:te.Back,[A.Front]:te.Front,[A.None]:te.None,[A.NotSet]:te.Back},Ce={[F.WrapYBit]:{s:oe.CLAMP_TO_EDGE,t:oe.REPEAT},[F.WrapXBit]:{s:oe.REPEAT,t:oe.CLAMP_TO_EDGE},[F.WrapXy]:{s:oe.REPEAT,t:oe.REPEAT},[F.None]:{s:oe.CLAMP_TO_EDGE,t:oe.CLAMP_TO_EDGE},[F.NotSet]:{s:oe.CLAMP_TO_EDGE,t:oe.CLAMP_TO_EDGE}},Pe={[B.U8]:1,[B.I8]:1,[B.U16]:2,[B.I16]:2,[B.U32]:4,[B.I32]:4,[B.F32]:4,[B.F64]:8,[B.Utf8String]:1,[B.NotSet]:1};class _e{constructor(e){this.layerUid=[],this.type=pe.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,t,s,r){const o=e.results,i=e.options.store===me.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const a=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach((p=>{p.visible&&p.intersectionGeometry&&a.intersect(p,s,r,e.tolerance,null,((a,p,m,n)=>{if(p>=0){if(null!=t&&!t(s,r,p))return;const a=e=>{const t=new ae(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));e.set(this.type,t,p,m)};if(this.isGround&&(null==o.ground.dist||p<o.ground.dist)&&a(o.ground),e.options.isFiltered)return;if((null==o.min.dist||p<o.min.dist)&&a(o.min),(null==o.max.dist||p>o.max.dist)&&a(o.max),i){const t=ne(e.ray);a(t),e.results.all.push(t)}}}))}))}_createTiles3DGraphic(e,t){return new ie({layer:e,sourceLayer:e,attributes:t})}}var Ee;!function(e){e[e.API=1]="API",e[e.VerboseAPI=2]="VerboseAPI",e[e.Error=3]="Error"}(Ee||(Ee={}));class Ie{constructor(){this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function Le(e){return Math.round(e/1048.576)/1e3}let Oe=class extends(K(Ue)){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._wasmLayerId=-1,this.ignoresMemoryFactor=!0,this.unloadedMemory=0,this.drapeTargetType=Z.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(Ee.Error),this._dbg(Ee.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new t("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const e=X(this).then((e=>{this._intersectionHandler=new _e(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(e=>this._slicePlaneEnabledChange(e))),this._elevationProvider=new U({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e,this._suspendedHandle=o((()=>this.suspended),(e=>{const t=Y(this.view);t&&t.setEnabled(this,!e)}),i),this.addHandles([o((()=>this.layer.elevationInfo),(e=>this._elevationInfoChanged(e)))])})).catch((e=>{if($(this),this._wasmLayerId=-1,e===k)throw new t("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===H)throw new t("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})}));this.addResolvingPromise(e)}destroy(){this._dbg(Ee.VerboseAPI,"Tiles3DLayerView3D destroy() called"),$(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((e=>this.freeObject(e))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._updatingHandles=r(this._updatingHandles)}_slicePlaneEnabledChange(e){this.objects.forEach((t=>{const s=this._collection.getMaterial(t);s.commonMaterialParameters.hasSlicePlane=e,s.commonMaterialParameters.cullFace=e?te.None:this._initialCullFace.get(t)}))}_elevationInfoChanged(e){const t=e?.offset??0,s=e?.unit?q(e?.unit):1,r=Y(this.view);r&&r.setLayerOffset(this,t*s)}get _obbs(){return this.objects.map((e=>this._collection.getComponentObb(e)))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let e=0;return this._lyrHandleToObjects.forEach((t=>{e+=t.totalMemory()})),e}get performanceInfo(){let e=0,t=0,s=0,r=0,o=0,i=0;return this._lyrHandleToObjects.forEach((a=>{a.isVisible?(e+=a.texMemoryUsage,t+=a.vboMemoryUsage,o++):(s+=a.texMemoryUsage,r+=a.vboMemoryUsage,i++)})),new Me(this.usedMemory,o,i,Le(t),Le(e),Le(r),Le(s))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===Q.Local){const e=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==e&&32662!==e)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return(this.layer.elevationInfo?.offset??0)*(this.layer.elevationInfo?.unit?q(this.layer.elevationInfo.unit):1)}get elevationRange(){const e=this.fullExtent;return e?.zmin&&e?.zmax?new le(e.zmin,e.zmax):null}getElevationRange(e){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((e,t)=>e.concat(t.components)),new Array)}isUpdating(){const e=Y(this.view);return!(this._wasmLayerId<0||null==e)&&e.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(e){const t=e.meshData;if(null==t.data)throw new Error("meshData.data undefined");if(t.desc=JSON.parse(t.desc),null==t.desc)throw new Error("meshData.desc undefined");const s=h(t.desc.origin);let r=0;const o=new Array,i=new Map,a=new Ie;return this._lyrHandleToObjects.set(e.handle,a),t.desc.prims.forEach((e=>{if(this._dbg(Ee.VerboseAPI,JSON.stringify(e)),null==Te[e.ptype]||null==t.data)return void this._dbg(Ee.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+e.ptype+"). Skipping primitive.");const p=this.view.basemapTerrain.spatialReference;let h,U;if("global"===this.view.viewingMode){const e=d();v(w,s,e,p),h=m(l(),e),U=n(l(),h)}else h=j,U=j;const S=d();c(S,S,s);const x=u(f(),S),C=t.desc?.materials&&null!=e.materialId?t.desc.materials[e.materialId]:null,P=null!=C?C.lightingModel:G.Unlit,_=P!==G.Unlit,{positionView:E,positionAttr:I,normalsView:L,normalsAttr:O,colorAttr:D,texCoord0Attr:V,indicesView:R}=this.getBufferViews(e,t.data.buffer,h,_);if(null==I||null==E||null==R)return;const A={colors:null!=D,textureCoordinates:null!=V?ge.Default:ge.None,hasNormals:null!=L,needsNormals:_},F=I.data.length/I.size,B=(e,t)=>!e||e.data.length/e.size===F||(this._dbg(Ee.Error,`${t} !== numPos. Skipping primitive.`),!1);if(!B(V,"numTexcoord")||!B(D,"numColors")||!B(O,"normals"))return;const k=ce(A),H=f(),N=je(I);if(y(H,N.center,s),N.center=H,h!==j)for(let e=0;e<E.count;e++)E.getVec(e,H),g(H,H,h),E.setVec(e,H);const W=k.createBuffer(I.data.length),z=new Map([[we.POSITION,I]]);null!=V&&z.set(we.UV0,V),null!=D&&z.set(we.COLOR,D),null!=O&&z.set(we.NORMALCOMPRESSED,O),z.forEach(((e,t)=>{null!=e&&ve(t,e,null,null,W,0)}));const q=new Uint32Array([0,R.typedBuffer.length]),Q={vertices:{data:W.buffer,count:W.byteLength/k.stride,layoutParameters:A},positionData:{positions:E.typedBuffer,indices:R.typedBuffer},indices:R.typedBuffer,componentOffsets:q};a.cpuMemoryUsage+=E.count,a.cpuMemoryUsage+=R.count,r+=Q.vertices.count;const J=this.view.renderSpatialReference,Z=f(),K=[1,1,1];M(x,J,K,p)||this._dbg(Ee.Error,"Unsupported coordinate system for IM overlay"),T(x,J,Z,p);const X=this._collection.createObject({toMapSpace:b(Z[0],Z[1],K[0],K[1]),geometry:Q,obb:N,transform:{position:x,rotationScale:U}});C&&this._collection.updateMaterial(X,(e=>{e.baseColor=C.baseColorFactor,e.usePBR=P===G.Pbr,e.hasParametersFromSource=!1,e.baseColorTexture=this._getTexture(C.baseColorTex,t,i),e.usePBR&&(e.mrrFactors=[C.metallicFactor,C.roughnessFactor,0],e.emissiveFactor=C.emissiveFactor??[0,0,0],e.metallicRoughnessTexture=this._getTexture(C.metalTex,t,i),e.emissionTexture=this._getTexture(C.emissiveTex,t,i),e.occlusionTexture=this._getTexture(C.occlusionTex,t,i),e.normalTexture=this._getTexture(C.normalTex,t,i)),e.objectOpacity=0,e.alphaDiscardMode=ee.Mask;const s=[];e.baseColorTexture&&s.push(e.baseColorTexture.loadPromise),e.usePBR&&e.metallicRoughnessTexture&&s.push(e.metallicRoughnessTexture.loadPromise),e.usePBR&&e.emissionTexture&&s.push(e.emissionTexture.loadPromise),e.usePBR&&e.occlusionTexture&&s.push(e.occlusionTexture.loadPromise),e.usePBR&&e.normalTexture&&s.push(e.normalTexture.loadPromise);const r=Promise.all(s);o.push(r),r.then((()=>{e.alphaDiscardMode=Se[C.alphaMode],e.objectOpacity=1,a.texMemoryUsage+=e.baseColorTexture?.glTexture?.usedMemory||0,e.usePBR&&(a.texMemoryUsage+=e.metallicRoughnessTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.emissionTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.occlusionTexture?.glTexture?.usedMemory||0,a.texMemoryUsage+=e.normalTexture?.glTexture?.usedMemory||0)})),e.commonMaterialParameters.doubleSided=C.isDoubleSided,e.commonMaterialParameters.cullFace=C.faceCulling?xe[C.faceCulling]:te.Back,this._initialCullFace.set(X,e.commonMaterialParameters.cullFace),e.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,e.componentParameters.castShadows=de.All,e.textureAlphaCutoff=C.alphaCutoff??.1,e.alphaDiscardMode=Se[C.alphaMode],e.isIntegratedMesh=!0,e.polygonOffsetEnabled=!1,e.hasOccludees=!1,e.ellipsoidMode=ue(this.view.spatialReference)})),a.components.push(X),a.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(X)})),await Promise.all(o),i.forEach((e=>{a.textures.push(e)})),{vertexCount:r,vbMemUsage:a.vboMemoryUsage,ibMemUsage:0,texMemUsage:a.texMemoryUsage}}freeRenderable(e){const t=this._lyrHandleToObjects.get(e);t&&(this.freeObject(t),this._lyrHandleToObjects.delete(e))}freeObject(e){e.components.forEach((t=>{e.textures.forEach((e=>{this._stage.remove(e)})),this._collection.destroyObject(t),this._initialCullFace.delete(t)}))}setRenderableVisibility(e,t){const s=this._lyrHandleToObjects.get(e);s&&(s.isVisible=t,s.components.forEach((e=>{this._collection.setObjectVisibility(e,t),this._elevationProvider.objectChanged(this._collection.getComponentObb(e))})))}_getTexture(e,t,s){let r=null;if(e&&t.desc?.images&&t.data?.buffer){const o=t.desc.images[e?.imageId];if(r=s.get(o),!r&&o){const i=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,a=i>1,p=Ce[e.wrapMode??F.None];let m=o.alpha?4:3;const n=new Uint8Array(t.data.buffer,o.data.byteOffset,o.data.byteCount);let l=null,j=null,c=null;switch(o.format){case N.Raw:o.pixelFormat===W.R8?(l=n.buffer,m=1,j=""):o.pixelFormat===W.Rgb8?(l=n.buffer,m=3,j=""):o.pixelFormat===W.Rgba8&&(l=n.buffer,m=4,j="");break;case N.Dxt1:l=n.buffer,m=3,j=se.DDS_ENCODING;break;case N.Dxt5:l=n.buffer,m=4,j=se.DDS_ENCODING;break;case N.Png:j="image/png",c=document.createElement("img");break;case N.Jpeg:j="image/jpeg",c=document.createElement("img");break;case N.Etc2:j="image/ktx",c=document.createElement("img");break;case N.Astc:this._dbg(Ee.Error,"Astc texture not supported");break;case N.Pvrtc:this._dbg(Ee.Error,"Pvrtc texture not supported")}if(c&&j){const e=new Blob([n],{type:j});c.src=URL.createObjectURL(e),l=c}l&&null!=j&&(r=new be(l,{mipmap:a,maxAnisotropy:i,encoding:j,wrap:p,components:m,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(r),s.set(o,r))}}return r?new ye(this.view._stage.renderView.textureRepository,r.id):null}getBufferViews(e,t,s,r){let o,i,a,p,m,n,l,j;if(e.atrbs.forEach((e=>{const j=e.view,c=void 0,u=j.byteOffset+j.byteCount,d=j.byteCount/Pe[j.type],y=[...Array(d).keys()].map((e=>e));try{switch(e.sem){case z.Position:3!==j.ncomp||j.type!==B.F32?this._dbg(Ee.Error,"[Unsupported Feature] Unsupported view for Position ("+j+")"):(o=new P(t,j.byteOffset,c,u),i=new he(o.typedBuffer,y,3));break;case z.Normal:if(3!==j.ncomp||j.type!==B.F32)this._dbg(Ee.Error,"[Unsupported Feature] Unsupported view for Normal ("+j+")");else if(r){const e=new P(t,j.byteOffset,c,u),r=fe(e.typedBuffer,s);m=new L(r),n=new he(m.typedBuffer,y,2)}break;case z.TexCoord:2!==j.ncomp||j.type!==B.F32?this._dbg(Ee.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+j+")"):void 0===p&&(p=new he(new I(t,j.byteOffset,c,u).typedBuffer,y,2));break;case z.Color:4===j.ncomp?(j.type===B.F32&&(l=new S(t,j.byteOffset,c,u)),j.type===B.U8&&(l=new x(t,j.byteOffset,c,u)),j.type===B.U16&&(l=new C(t,j.byteOffset,c,u))):3===j.ncomp&&(j.type===B.F32&&(l=new P(t,j.byteOffset,c,u)),j.type===B.U8&&(l=new _(t,j.byteOffset,c,u)),j.type===B.U16&&(l=new E(t,j.byteOffset,c,u))),null==l?this._dbg(Ee.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+j+")"):a=new he(l.typedBuffer,y,j.ncomp);break;case z.FeatureIndex:break;default:this._dbg(Ee.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+e.sem+"). Skipping vertex attribute.")}}catch(e){this._dbg(Ee.VerboseAPI,"Error Creating buffer ("+e+"). Skipping vertex attribute.")}})),e.index){const s=e.index.view,r=void 0,o=s.byteOffset+s.byteCount;switch(e.index.view.type){case B.U16:j=new D(t,s.byteOffset,r,o);break;case B.U32:j=new O(t,s.byteOffset,r,o);break;case B.U8:default:this._dbg(Ee.Error,"[Unsupported Feature] index type not supported ("+s.type+").")}}if(null==j&&null!=o){const e=o.count;if(e<65535){const t=new Uint16Array(e);j=new D(t)}else{const t=new Uint32Array(e);j=new O(t)}for(let t=0;t<e;t++)j.set(t,t)}return{positionView:o,positionAttr:i,colorAttr:a,texCoord0Attr:p,indicesView:j,normalsView:m,normalsAttr:n}}_dbg(e,t){this._dbgFlags.has(e)&&(e===Ee.Error?s.getLogger(this).error(t):s.getLogger(this).warn(t))}};e([a()],Oe.prototype,"layer",void 0),e([a()],Oe.prototype,"elevationOffset",null),Oe=e([p("esri.views.3d.layers.Tiles3DLayerView3D")],Oe);const De=Oe;export{De as default};
