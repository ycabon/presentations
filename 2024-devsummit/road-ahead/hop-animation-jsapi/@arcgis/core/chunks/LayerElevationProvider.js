/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{l as e,s as t,g as r}from"./vec3.js";import{c as n,s as i,d as s,P as o,i as a}from"./projectBuffer.js";import{f as l,h as c}from"./unitUtils.js";import{_ as p}from"./tslib.es6.js";import u from"../core/Accessor.js";import m from"../core/Evented.js";import{L as f}from"./Logger.js";import{property as d}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import{j as v}from"./mat4.js";import{c as E}from"./mat4f64.js";import{c as _}from"./vec3f64.js";import{p as R}from"./RenderTexture.js";import{e as x,a as g}from"./aaBoundingRect.js";import{f as j}from"./sphere.js";import{E as y}from"./ElevationRange.js";import{E as C}from"./ElevationUpdateEvent.js";import{n as S,S as b}from"./Intersector2.js";function N(t,r,p,u){if(null==r||null==u)return!1;const m=n(r,i),f=n(u,s);if(m===f&&m!==o.UNKNOWN||l(r,u))return p[0]=1,p[1]=1,p[2]=1,!0;if(m===o.SPHERICAL_ECEF){const r=e(t),n=r/Math.sqrt(t[0]*t[0]+t[1]*t[1]),i=r/c.radius;if(f===o.WEB_MERCATOR)return p[0]=n*i,p[1]=n*i,p[2]=1,!0;if(f===o.WGS84||f===o.CGCS2000){const e=a;return p[0]=e*n*i,p[1]=e*i,p[2]=1,!0}}else if(m===o.PLATE_CARREE){if(f===o.WGS84||f===o.CGCS2000)return p[0]=a,p[1]=a,p[2]=1,!0;if(f===o.WEB_MERCATOR){const e=t[1]/c.radius;return p[0]=1,p[1]=1/Math.cos(e),p[2]=1,!0}}return!1}let w=class extends(m.EventedMixin(u)){constructor(e){super(e),this._tmpEvent=new C,this._renderCoordsHelper=e.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=e.layerElevationSource}initialize(){this._intersector=S(this.view.state.viewingMode),this._intersector.options.store=b.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(e,r,n,i){const s=this._renderCoordsHelper,o=t(L,e,r,n);if(!s.toRenderCoords(o,i,o))return f.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:a,_intersector:l,intersectionHandler:c}=this,p=a.fullExtent,u=null!=p&&Number.isFinite(p.xmin)&&Number.isFinite(p.xmax)&&Number.isFinite(p.ymin)&&Number.isFinite(p.ymax)&&Number.isFinite(p.zmin)&&Number.isFinite(p.zmax)?new y(p.zmin,p.zmax):a.elevationRange;if(null==u)return null;const m=a.elevationOffset,d=u.elevationRangeMin+m,h=u.elevationRangeMax+m,v=s.setAltitude(M,h,o),E=s.setAltitude(O,d,o);return l.reset(v,E,null),c.intersect(l,null,v,E,null,!0),l.results.min.getIntersectionPoint(o)?s.getAltitude(o):null}getSphereElevationBounds(e,t){return R(e,t,H,this._renderSR),this._layerElevationSource.getElevationRange(H)}getRootElevationBounds(){const e=this.layerElevationSource.fullExtent;return e?.hasZ?new y(e.zmin,e.zmax):null}objectsChanged(e){this.spatialReference&&(this._computeLayerExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(e){this.spatialReference&&(this._computeObjectExtent(e,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(e,t){x(t),this._expandExtent(e,t)}_computeLayerExtent(e,t){x(t);for(const r of e)this._expandExtent(r,t)}_expandExtent(e,t){const n=this.spatialReference;if(null==n)return;if(null==e)return;v(A,e.quaternion),A[12]=e.center[0],A[13]=e.center[1],A[14]=e.center[2];const i=e.halfSize;for(let e=0;e<8;++e)L[0]=1&e?i[0]:-i[0],L[1]=2&e?i[1]:-i[1],L[2]=4&e?i[2]:-i[2],r(L,L,A),this._renderCoordsHelper.fromRenderCoords(L,L,n),g(t,L,t)}};p([d({constructOnly:!0})],w.prototype,"layerElevationSource",void 0),p([d({constructOnly:!0})],w.prototype,"intersectionHandler",void 0),p([d({constructOnly:!0})],w.prototype,"view",void 0),p([d()],w.prototype,"spatialReference",null),w=p([h("esri.views.3d.layers.i3s.LayerElevationProvider")],w);const A=E(),H=j(0,0,0,0),L=_(),M=_(),O=_();export{w as L,N as l};
