/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{c as t,f as e}from"./vec3f64.js";import{N as a}from"./interfaces5.js";import{M as r}from"../core/scheduling.js";import{D as i}from"./basicInterfaces.js";import{C as s,a as n}from"./ContentObject.js";import{V as c}from"./VertexAttribute.js";import{C as o}from"../core/lang.js";import{l,d as u,c as h}from"./mathUtils.js";import{s as f,e as m,n as p}from"./vec3.js";import{c as d,u as v,v as O}from"./aaBoundingBox.js";import{V as g}from"./ViewingMode.js";import{a as _}from"./Util.js";class M{constructor(){this.enabled=!0,this._time=r(0)}get time(){return this._time}advance({deltaTime:t,fixedTime:e}){return null!=e?this._time!==e&&(this._time=e,!0):(this._time=r(this._time+t),0!==t)}}class A{constructor(t,e){this.deltaTime=t,this.fixedTime=e}}const F=new Map([[c.POSITION,0],[c.NORMAL,1],[c.NORMALCOMPRESSED,1],[c.UV0,2],[c.COLOR,3],[c.COLORFEATUREATTRIBUTE,3],[c.SIZE,4],[c.TANGENT,4],[c.CENTEROFFSETANDDISTANCE,5],[c.SYMBOLCOLOR,5],[c.FEATUREATTRIBUTE,6],[c.INSTANCEFEATUREATTRIBUTE,6],[c.INSTANCECOLOR,7],[c.OBJECTANDLAYERIDCOLOR,7],[c.INSTANCEOBJECTANDLAYERIDCOLOR,7],[c.INSTANCEMODEL,8],[c.INSTANCEMODELNORMAL,12],[c.INSTANCEMODELORIGINHI,11],[c.INSTANCEMODELORIGINLO,15]]);function C(t,e){return new S(t,D,e)}function T(t,e){const{curvatureDependent:a,scaleStart:r,scaleFallOffRange:i}=D;return new S(t,{curvatureDependent:{min:{curvature:a.min.curvature,tiltAngle:a.min.tiltAngle,scaleFallOffFactor:P.curvatureDependent.min.scaleFallOffFactor},max:{curvature:a.max.curvature,tiltAngle:a.max.tiltAngle,scaleFallOffFactor:P.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:i,minPixelSize:P.minPixelSize},e)}function x(t,e,a){const r=a.parameters;return R.scale=Math.min(r.divisor/(e-r.offset),1),R.factor=function(t){return Math.abs(t*t*t)}(t),R}function b(t,e){return l(t*Math.max(e.scale,e.minScaleFactor),t,e.factor)}function E(t,e,a,r){r.scale=function(t,e,a){const r=x(t,e,a);return r.minScaleFactor=0,b(1,r)}(t,e,a),r.factor=0,r.minScaleFactor=a.minScaleFactor}function N(t,e,a=[0,0]){const r=Math.min(Math.max(e.scale,e.minScaleFactor),1);return a[0]=t[0]*r,a[1]=t[1]*r,a}class S{get minScaleFactor(){return null!=this._fontHeight?Math.min(this._description.minPixelSize/this._fontHeight,1):0}constructor(t,e,a,r={camera:{distance:0,fovY:0},divisor:0,offset:0},i){this._viewingMode=t,this._description=e,this._ellipsoidRadius=a,this.parameters=r,this._fontHeight=i,this._viewingMode===g.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(t){return!(this.parameters&&this.parameters.camera.fovY===t.fovY&&this.parameters.camera.distance===t.distance||(this._calculateParameters(t,this._ellipsoidRadius,this.parameters),0))}overrideFontHeight(t){return t!==this._fontHeight?new S(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,t):this}_calculateParameters(t,e,a){const{scaleStart:r,scaleFallOffRange:i}=this._description,{fovY:s,distance:n}=t,c=this._calculateCurvatureDependentParameters(t,e),o=this._coverageCompensation(t,e,c),{tiltAngle:l,scaleFallOffFactor:u}=c,h=Math.sin(l)*n,f=.5*Math.PI-l-s*(.5-r*o),m=h/Math.cos(f),p=f+s*i*o,d=(m-u*(h/Math.cos(p)))/(1-u);return a.camera.fovY=t.fovY,a.camera.distance=t.distance,a.offset=d,a.divisor=m-d,a}_calculateCurvatureDependentParametersLocal(t,e,a=I){return a.tiltAngle=this._description.curvatureDependent.min.tiltAngle,a.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,a}_calculateCurvatureDependentParametersGlobal(t,e,a=I){const r=this._description.curvatureDependent,i=1+t.distance/e,s=Math.sqrt(i*i-1),[n,c]=[r.min.curvature,r.max.curvature],o=h((s-n)/(c-n),0,1),[u,f]=[r.min,r.max];return a.tiltAngle=l(u.tiltAngle,f.tiltAngle,o),a.scaleFallOffFactor=l(u.scaleFallOffFactor,f.scaleFallOffFactor,o),a}_surfaceCoverageCompensationLocal(t,e,a){return(t.fovY-a.tiltAngle)/t.fovY}_surfaceCoverageCompensationGlobal(t,e,a){const r=e*e,i=a.tiltAngle+.5*Math.PI,{fovY:s,distance:n}=t,c=n*n+r-2*Math.cos(i)*n*e,o=Math.sqrt(c),l=Math.sqrt(c-r);return(Math.acos(l/o)-Math.asin(e/(o/Math.sin(i)))+.5*s)/s}}const D={curvatureDependent:{min:{curvature:u(10),tiltAngle:u(12),scaleFallOffFactor:.5},max:{curvature:u(70),tiltAngle:u(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},P={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14},R={scale:0,factor:0,minScaleFactor:0},I={tiltAngle:0,scaleFallOffFactor:0},L=d();function y(t,e,a,r,i,n){if(t.visible)if(t.boundingInfo){_(t.type===s.Mesh);const c=e.tolerance;j(t.boundingInfo,a,r,c,i,n)}else{const e=t.attributes.get(c.POSITION),s=e.indices;U(a,r,0,s.length/3,s,e,void 0,i,n)}}const V=t();function j(t,e,a,r,i,s){if(null==t)return;const n=H(e,a,V);if(v(L,t.bbMin),O(L,t.bbMax),null!=i&&i.applyToAabb(L),q(L,e,n,r)){const{primitiveIndices:n,position:c}=t,o=n?n.length:c.indices.length/3;if(o>Q){const n=t.getChildren();if(void 0!==n){for(const t of n)j(t,e,a,r,i,s);return}}U(e,a,0,o,c.indices,c,n,i,s)}}const Y=t();function U(t,e,a,r,i,s,n,c,o){if(n)return function(t,e,a,r,i,s,n,c,o){const{data:l,stride:u}=s,h=t[0],f=t[1],m=t[2],p=e[0]-h,d=e[1]-f,v=e[2]-m;for(let t=a;t<r;++t){const e=n[t];let a=3*e,r=u*i[a++],s=l[r++],O=l[r++],g=l[r];r=u*i[a++];let _=l[r++],M=l[r++],A=l[r];r=u*i[a];let F=l[r++],C=l[r++],T=l[r];null!=c&&([s,O,g]=c.applyToVertex(s,O,g,t),[_,M,A]=c.applyToVertex(_,M,A,t),[F,C,T]=c.applyToVertex(F,C,T,t));const x=_-s,b=M-O,E=A-g,N=F-s,S=C-O,D=T-g,P=d*D-S*v,R=v*N-D*p,I=p*S-N*d,L=x*P+b*R+E*I;if(Math.abs(L)<=Number.EPSILON)continue;const y=h-s,V=f-O,j=m-g,U=y*P+V*R+j*I;if(L>0){if(U<0||U>L)continue}else if(U>0||U<L)continue;const w=V*E-b*j,B=j*x-E*y,H=y*b-x*V,q=p*w+d*B+v*H;if(L>0){if(q<0||U+q>L)continue}else if(q>0||U+q<L)continue;const z=(N*w+S*B+D*H)/L;z>=0&&o(z,G(x,b,E,N,S,D,Y),e,!1)}}(t,e,a,r,i,s,n,c,o);const{data:l,stride:u}=s,h=t[0],f=t[1],m=t[2],p=e[0]-h,d=e[1]-f,v=e[2]-m;for(let t=a,e=3*a;t<r;++t){let a=u*i[e++],r=l[a++],s=l[a++],n=l[a];a=u*i[e++];let O=l[a++],g=l[a++],_=l[a];a=u*i[e++];let M=l[a++],A=l[a++],F=l[a];null!=c&&([r,s,n]=c.applyToVertex(r,s,n,t),[O,g,_]=c.applyToVertex(O,g,_,t),[M,A,F]=c.applyToVertex(M,A,F,t));const C=O-r,T=g-s,x=_-n,b=M-r,E=A-s,N=F-n,S=d*N-E*v,D=v*b-N*p,P=p*E-b*d,R=C*S+T*D+x*P;if(Math.abs(R)<=Number.EPSILON)continue;const I=h-r,L=f-s,y=m-n,V=I*S+L*D+y*P;if(R>0){if(V<0||V>R)continue}else if(V>0||V<R)continue;const j=L*x-T*y,U=y*C-x*I,w=I*T-C*L,B=p*j+d*U+v*w;if(R>0){if(B<0||V+B>R)continue}else if(B>0||V+B<R)continue;const H=(b*j+E*U+N*w)/R;H>=0&&o(H,G(C,T,x,b,E,N,Y),t,!1)}}const w=t(),B=t();function G(t,e,a,r,i,s,n){return f(w,t,e,a),f(B,r,i,s),m(n,w,B),p(n,n),n}function H(t,e,a){return f(a,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function q(t,e,a,r){return z(t,e,a,r,1/0)}function z(t,e,a,r,i){const s=(t[0]-r-e[0])*a[0],n=(t[3]+r-e[0])*a[0];let c=Math.min(s,n),o=Math.max(s,n);const l=(t[1]-r-e[1])*a[1],u=(t[4]+r-e[1])*a[1];if(o=Math.min(o,Math.max(l,u)),o<0)return!1;if(c=Math.max(c,Math.min(l,u)),c>o)return!1;const h=(t[2]-r-e[2])*a[2],f=(t[5]+r-e[2])*a[2];return o=Math.min(o,Math.max(h,f)),!(o<0)&&(c=Math.max(c,Math.min(h,f)),!(c>o)&&c<i)}function W(t,e,a,r,i){let s=(a.screenLength||0)*t.pixelRatio;null!=i&&(s=function(t,e,a,r){return b(t,x(e,a,r))}(s,r,e,i));const n=s*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return h(n*e,a.minWorldLength||0,null!=a.maxWorldLength?a.maxWorldLength:1/0)}function k(t,e){const a=e?k(e):{};for(const e in t){let r=t[e];r?.forEach&&(r=Z(r)),null==r&&e in a||(a[e]=r)}return a}function J(t,e){let a=!1;for(const r in e){const i=e[r];void 0!==i&&(Array.isArray(i)?null===t[r]?(t[r]=i.slice(),a=!0):o(t[r],i)&&(a=!0):t[r]!==i&&(a=!0,t[r]=i))}return a}function Z(t){const e=[];return t.forEach((t=>e.push(t))),e}const K={multiply:1,ignore:2,replace:3,tint:4},Q=1e3;class X extends n{constructor(t,a){super(),this.type=s.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._vertexAttributeLocations=F,this._pp0=e(0,0,1),this._pp1=e(0,0,0),this._parameters=k(t,a),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(t){return!1}setParameters(t,e=!0){J(this._parameters,t)&&(this.validateParameters(this._parameters),e&&this.parametersChanged())}validateParameters(t){}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this.parametersChanged())}shouldRender(t){return this.isVisible()&&this.isVisibleForOutput(t.output)&&(!this.parameters.isDecoration||t.bindParameters.decorations===i.ON)&&0!=(this.parameters.renderOccluded&t.renderOccludedMask)}isVisibleForOutput(t){return!0}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){this.repository?.materialChanged(this)}queryRenderOccludedState(t){return this.isVisible()&&this.parameters.renderOccluded===t}intersectDraped(t,e,a,r,i,s){return this._pp0[0]=this._pp1[0]=r[0],this._pp0[1]=this._pp1[1]=r[1],this.intersect(t,e,a,this._pp0,this._pp1,i)}}class $ extends A{constructor(t,e,a){super(e,a),this.camera=t}}var tt;!function(t){t[t.None=0]="None",t[t.Occlude=1]="Occlude",t[t.Transparent=2]="Transparent",t[t.OccludeAndTransparent=4]="OccludeAndTransparent",t[t.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",t[t.Opaque=16]="Opaque"}(tt||(tt={}));class et extends a{constructor(){super(...arguments),this.renderOccluded=tt.Occlude,this.isDecoration=!1}}export{M as A,F as D,X as M,tt as R,$ as U,et as a,b,N as c,K as d,U as e,q as f,C as g,T as h,y as i,z as j,G as k,H as l,E as p,J as u,W as v};
