/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{f as t,P as i}from"../core/lang.js";import{P as n}from"../core/scheduling.js";import{q as e}from"./quickselect.js";class s{constructor(t=9,i){this._compareMinX=o,this._compareMinY=l,this._toBBox=t=>t,this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&("function"==typeof i?this._toBBox=i:this._initFormat(i)),this.clear()}destroy(){this.clear(),f.prune(),p.prune(),g.prune(),M.prune()}all(t){this._all(this._data,t)}search(t,i){let n=this._data;const e=this._toBBox;if(_(t,n))for(f.clear();n;){for(let s=0,h=n.children.length;s<h;s++){const h=n.children[s],a=n.leaf?e(h):h;_(t,a)&&(n.leaf?i(h):u(t,a)?this._all(h,i):f.push(h))}n=f.pop()}}collides(t){let i=this._data;const n=this._toBBox;if(!_(t,i))return!1;for(f.clear();i;){for(let e=0,s=i.children.length;e<s;e++){const s=i.children[e],h=i.leaf?n(s):s;if(_(t,h)){if(i.leaf||u(t,h))return!0;f.push(s)}}i=f.pop()}return!1}load(t){if(!t.length)return this;if(t.length<this._minEntries){for(let i=0,n=t.length;i<n;i++)this.insert(t[i]);return this}let i=this._build(t.slice(0,t.length),0,t.length-1,0);if(this._data.children.length)if(this._data.height===i.height)this._splitRoot(this._data,i);else{if(this._data.height<i.height){const t=this._data;this._data=i,i=t}this._insert(i,this._data.height-i.height-1,!0)}else this._data=i;return this}insert(t){return t&&this._insert(t,this._data.height-1),this}clear(){return this._data=new B([]),this}remove(i){if(!i)return this;let n,e=this._data,s=null,h=0,a=!1;const r=this._toBBox(i);for(g.clear(),M.clear();e||g.length>0;){if(e||(e=g.pop(),s=g.data[g.length-1],h=M.pop()??0,a=!0),e.leaf&&(n=t(e.children,i,e.children.length,e.indexHint),-1!==n))return e.children.splice(n,1),g.push(e),this._condense(g),this;a||e.leaf||!u(e,r)?s?(h++,e=s.children[h],a=!1):e=null:(g.push(e),M.push(h),h=0,s=e,e=e.children[0])}return this}toJSON(){return this._data}fromJSON(t){return this._data=t,this}_all(t,i){let n=t;for(p.clear();n;){if(!0===n.leaf)for(const t of n.children)i(t);else p.pushArray(n.children);n=p.pop()??null}}_build(t,i,n,e){const s=n-i+1;let a=this._maxEntries;if(s<=a){const e=new B(t.slice(i,n+1));return h(e,this._toBBox),e}e||(e=Math.ceil(Math.log(s)/Math.log(a)),a=Math.ceil(s/a**(e-1)));const r=new w([]);r.height=e;const o=Math.ceil(s/a),l=o*Math.ceil(Math.sqrt(a));x(t,i,n,l,this._compareMinX);for(let s=i;s<=n;s+=l){const i=Math.min(s+l-1,n);x(t,s,i,o,this._compareMinY);for(let n=s;n<=i;n+=o){const s=Math.min(n+o-1,i);r.children.push(this._build(t,n,s,e-1))}}return h(r,this._toBBox),r}_chooseSubtree(t,i,n,e){for(;e.push(i),!0!==i.leaf&&e.length-1!==n;){let n,e=1/0,a=1/0;for(let r=0,o=i.children.length;r<o;r++){const o=i.children[r],l=c(o),m=(s=t,h=o,(Math.max(h.maxX,s.maxX)-Math.min(h.minX,s.minX))*(Math.max(h.maxY,s.maxY)-Math.min(h.minY,s.minY))-l);m<a?(a=m,e=l<e?l:e,n=o):m===a&&l<e&&(e=l,n=o)}i=n||i.children[0]}var s,h;return i}_insert(t,i,n){const e=this._toBBox,s=n?t:e(t);g.clear();const h=this._chooseSubtree(s,this._data,i,g);for(h.children.push(t),r(h,s);i>=0&&g.data[i].children.length>this._maxEntries;)this._split(g,i),i--;this._adjustParentBBoxes(s,g,i)}_split(t,i){const n=t.data[i],e=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,e);const a=this._chooseSplitIndex(n,s,e);if(!a)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const r=n.children.splice(a,n.children.length-a),o=n.leaf?new B(r):new w(r);o.height=n.height,h(n,this._toBBox),h(o,this._toBBox),i?t.data[i-1].children.push(o):this._splitRoot(n,o)}_splitRoot(t,i){this._data=new w([t,i]),this._data.height=t.height+1,h(this._data,this._toBBox)}_chooseSplitIndex(t,i,n){let e,s,h;e=s=1/0;for(let r=i;r<=n-i;r++){const i=a(t,0,r,this._toBBox),o=a(t,r,n,this._toBBox),l=d(i,o),m=c(i)+c(o);l<e?(e=l,h=r,s=m<s?m:s):l===e&&m<s&&(s=m,h=r)}return h}_chooseSplitAxis(t,i,n){const e=t.leaf?this._compareMinX:o,s=t.leaf?this._compareMinY:l;this._allDistMargin(t,i,n,e)<this._allDistMargin(t,i,n,s)&&t.children.sort(e)}_allDistMargin(t,i,n,e){t.children.sort(e);const s=this._toBBox,h=a(t,0,i,s),o=a(t,n-i,n,s);let l=m(h)+m(o);for(let e=i;e<n-i;e++){const i=t.children[e];r(h,t.leaf?s(i):i),l+=m(h)}for(let e=n-i-1;e>=i;e--){const i=t.children[e];r(o,t.leaf?s(i):i),l+=m(o)}return l}_adjustParentBBoxes(t,i,n){for(let e=n;e>=0;e--)r(i.data[e],t)}_condense(i){for(let n=i.length-1;n>=0;n--){const e=i.data[n];if(0===e.children.length)if(n>0){const s=i.data[n-1],h=s.children;h.splice(t(h,e,h.length,s.indexHint),1)}else this.clear();else h(e,this._toBBox)}}_initFormat(t){const i=["return a"," - b",";"];this._compareMinX=new Function("a","b",i.join(t[0])),this._compareMinY=new Function("a","b",i.join(t[1])),this._toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}function h(t,i){a(t,0,t.children.length,i,t)}function a(t,i,n,e,s){s||(s=new B([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let h,a=i;a<n;a++)h=t.children[a],r(s,t.leaf?e(h):h);return s}function r(t,i){t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY)}function o(t,i){return t.minX-i.minX}function l(t,i){return t.minY-i.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function m(t){return t.maxX-t.minX+(t.maxY-t.minY)}function d(t,i){const n=Math.max(t.minX,i.minX),e=Math.max(t.minY,i.minY),s=Math.min(t.maxX,i.maxX),h=Math.min(t.maxY,i.maxY);return Math.max(0,s-n)*Math.max(0,h-e)}function u(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function _(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function x(t,i,n,s,h){const a=[i,n];for(;a.length;){const i=a.pop(),n=a.pop();if(i-n<=s)continue;const r=n+Math.ceil((i-n)/s/2)*s;e(t,r,n,i,h),a.push(n,r,r,i)}}const f=new n,p=new n,g=new n,M=new n({deallocator:void 0});class X{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class Y extends X{constructor(){super(...arguments),this.height=1,this.indexHint=new i}}class B extends Y{constructor(t){super(),this.children=t,this.leaf=!0}}class w extends Y{constructor(t){super(),this.children=t,this.leaf=!1}}export{s as P};
