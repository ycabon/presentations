/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{throwIfAborted as e}from"../core/promiseUtils.js";import"./Logger.js";import"../core/lang.js";import"../core/Error.js";import{subclass as s}from"../core/accessorSupport/decorators/subclass.js";import{m as o,i,h as r}from"./vec3.js";import{c as n,a as c}from"./vec3f64.js";import{c as d,f as a,b as m}from"./lineSegment.js";import{b as p,g as u,d as h}from"./sphere.js";import{O as j}from"./Octree.js";import{d as l}from"./edgeProcessing.js";import"./handleUtils.js";import"./maybe.js";import"../config.js";import"./metadata.js";import"./utils.js";import"./tracking.js";import"./ensureType.js";import"./common.js";import"./mathUtils.js";import"./plane.js";import"./Axis.js";import"../core/scheduling.js";import"./mat3f64.js";import"./mat4f64.js";import"./quatf64.js";import"./vec2f64.js";import"./vec4f64.js";import"./mathUtils2.js";import"./mat4.js";import"./vec4.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"./frustum.js";import"./Util.js";import"./deduplicate.js";import"./Indices.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./vec2.js";import"./types.js";import"./VertexAttribute.js";import"./glUtil.js";import"./enums.js";import"./VertexElementDescriptor.js";import"./Normals.js";function g(t,e,s){const n=p(),c=u(n);return o(c,c,t,.5),o(c,c,e,.5),n[3]=i(c,t),r(c,c,s),n}let f=class{constructor(){this._idToComponent=new Map,this._components=new j((t=>t.bounds)),this._edges=new j((t=>t.bounds)),this._tmpLineSegment=d(),this._tmpP1=n(),this._tmpP2=n(),this._tmpP3=n(),this.remoteClient=null}async fetchCandidates(t,s){await Promise.resolve(),e(s),await this._ensureEdgeLocations(t,s);const o=[];return this._edges.forEachNeighbor((e=>(this._addCandidates(t,e,o),o.length<1e3)),t.bounds),{result:{candidates:o}}}async _ensureEdgeLocations(t,e){const s=[];if(this._components.forEachNeighbor((t=>{if(null==t.info){const{id:e,uid:o}=t;s.push({id:e,uid:o})}return!0}),t.bounds),!s.length)return;const o={components:s},i=await this.remoteClient.invoke("fetchAllEdgeLocations",o,e??{});for(const t of i.components)this._setFetchEdgeLocations(t)}async add(t){const e=new b(t.id,t.bounds);return this._idToComponent.set(e.id,e),this._components.add([e]),{result:{}}}async remove(t){const e=this._idToComponent.get(t.id);if(e){const t=[];this._edges.forEachNeighbor((s=>(s.component===e&&t.push(s),!0)),e.bounds),this._edges.remove(t),this._components.remove([e]),this._idToComponent.delete(e.id)}return{result:{}}}_setFetchEdgeLocations(t){const e=this._idToComponent.get(t.id);if(null==e||t.uid!==e.uid)return;const s=l.createView(t.locations),o=new Array(s.count),i=n(),r=n();for(let n=0;n<s.count;n++){s.position0.getVec(n,i),s.position1.getVec(n,r);const c=g(i,r,t.origin),d=new v(e,n,c);o[n]=d}this._edges.add(o);const{objectIds:c,origin:d}=t;e.info={locations:s,objectIds:c,origin:d}}_addCandidates(t,e,s){const{info:o}=e.component,{origin:i,objectIds:n}=o,c=o.locations,d=c.position0.getVec(e.index,this._tmpP1),a=c.position1.getVec(e.index,this._tmpP2);r(d,d,i),r(a,a,i);const m=n[c.componentIndex.get(e.index)];this._addEdgeCandidate(t,m,d,a,s),this._addVertexCandidate(t,m,d,s),this._addVertexCandidate(t,m,a,s)}_addEdgeCandidate(t,e,s,o,r){if(!t.returnEdge)return;const n=u(t.bounds),d=a(s,o,this._tmpLineSegment),p=m(d,n,this._tmpP3);h(t.bounds,p)&&r.push({type:"edge",objectId:e,target:c(p),distance:i(n,p),start:c(s),end:c(o)})}_addVertexCandidate(t,e,s,o){if(!t.returnVertex||!h(t.bounds,s))return;const r=u(t.bounds);o.push({type:"vertex",objectId:e,target:c(s),distance:i(r,s)})}};f=t([s("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],f);const _=f;class b{constructor(t,e){this.id=t,this.bounds=e,this.info=null,this.uid=++b.uid}}b.uid=0;class v{constructor(t,e,s){this.component=t,this.index=e,this.bounds=s}}export{_ as default};
