/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../Color.js";import{m as t}from"./colorUtils2.js";import"../core/lang.js";import{d as r}from"./handleUtils.js";import{o as i,p as o,n as s,c as n,h as a,a as c}from"./vec3.js";import{c as l,f as d}from"./vec3f64.js";import{p}from"./projectVectorToVector.js";import{o as u,a as m}from"./elevationInfoUtils.js";import{E as h,a as f}from"./ExtendedLineVisualElement.js";import{watch as g}from"../core/reactiveUtils.js";import{f as _,b as j}from"./screenUtils.js";import{n as D,s as O,e as R,g as v,b as y}from"./vec2.js";import{c as w}from"./vec2f64.js";import{e as b,c as S}from"./vec4.js";import{f as E}from"./vec4f32.js";import{m as G}from"./dehydratedPoint.js";import{E as x}from"./EngineVisualElement.js";import{R as A,d as C,e as P}from"./RenderGeometry.js";import{c as V}from"./GeometryUtil.js";import{R as H}from"./Material.js";import{V as T}from"./VertexAttribute.js";import{R as z}from"./RibbonLineMaterial.js";import{P as I}from"./PointVisualElement.js";import{R as F}from"./RightAngleQuadVisualElement.js";import{t as L,c as U}from"./normalizedPoint.js";import{d as M}from"./Settings.js";import{L as N,a as q}from"./RightAngleSnappingHint.js";import{L as W}from"./snappingUtils.js";import{S as B}from"./SnappingVisualizer.js";import{v as k}from"./viewUtils.js";class Q extends x{constructor(e){super(e),this._location=l(),this._direction=d(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=E(1,0,1,1),this._renderOccluded=H.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:e=>this._createObject3DResources(e),destroyResources:e=>this._destroyObject3DResources(e),recreateGeometry:(e,t)=>this._recreateObject3DGeometry(e,t),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:e=>this._destroyDrapedResources(e),recreateGeometry:e=>this._recreateDrapedGeometry(e)}}get location(){return this._location}set location(e){i(this._location,e)||(o(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){i(this._direction,e)||(o(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){s(this._direction,n(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){b(e,this._color)||(S(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new z(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:e=>{e(t),r.forEach(e)}}}_destroyObject3DResources(e){e.geometries.length=0}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,r){const[i,o]=this._createGeometries(e);t.addGeometry(i),t.addGeometry(o),r.push(i),r.push(o),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new z(this.materialParameters),t=g((()=>this.view.state.contentPixelRatio),(()=>{this.drapedResources.recreateGeometry()}));return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[]}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map((e=>new A(e)))}_createGeometries(e){return[V(e,[l(),l()]),V(e,[l(),l()])]}_updateMaterial(){const{materialParameters:e}=this;this.object3dResources.resources?.material.setParameters(e),this.drapedResources.resources?.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Y),a(Z,this.location,this.direction),t.projectToScreen(Z,$),D($,O($,$,Y)),this._updateVertexAttributesObject3D(t,e,0,Y,$,1),this._updateVertexAttributesObject3D(t,e,1,Y,$,-1)}_updateVertexAttributesObject3D(e,t,r,i,o,s){const n=t.geometries[r],a=n.getMutableAttribute(T.POSITION)?.data;if(!a)return;const{start:c,end:l}=this._computeStartEnd(o,i,s,this.offset,this.width,this.length);e.unprojectFromScreen(_(c),Z),a[0]=Z[0],a[1]=Z[1],a[2]=Z[2],e.unprojectFromScreen(_(l),Z),a[3]=Z[0],a[4]=Z[1],a[5]=Z[2],t.geometryVertexAttributeUpdated(n,T.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:i,width:o,length:s,offset:n}=this,a=ee;a.spatialReference=t.renderer.spatialReference,a.x=i[0],a.y=i[1];const c=this.view.overlayPixelSizeInMapUnits(a)*r,l=o*c,d=s*c,p=n*c;this._updateVertexAttributesDraped(e[0],l,d,p,-1),this._updateVertexAttributesDraped(e[1],l,d,p,1)}_updateVertexAttributesDraped(e,t,r,i,o){const s=e.getMutableAttribute(T.POSITION)?.data;if(!s)return;const{location:n,direction:a}=this,{start:c,end:l}=this._computeStartEnd(a,n,o,i,t,r);s[0]=c[0],s[1]=c[1],s[2]=C,s[3]=l[0],s[4]=l[1],s[5]=C,e.invalidateBoundingInfo()}_computeStartEnd(e,t,r,i,o,s){const n=R(X,v(X,e[1]*r,e[0]*-r),i+o/2),a=y(J,y(J,y(J,t,R(J,e,s/2)),n),n);return{start:a,end:y(K,a,R(K,e,-s))}}}const Z=l(),X=w(),J=w(),K=w(),Y=j(),$=j(),ee=G(0,0,void 0,null);class te extends B{sortUniqueHints(e){return e.sort(((e,t)=>(t instanceof N?t.length:0)-(e instanceof N?e.length:0)))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:o}=t,s=re(t);return r(new I({view:o,primitive:"circle",geometry:L(e.intersectionPoint,i),elevationInfo:e.isDraped?u:m,size:20,outlineSize:2,color:s.intersectionPointColor,outlineColor:s.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:o}=t,s=re(t),n=ie(e.point,e.domain,t);return r(new I({view:i,primitive:"circle",geometry:L(n,o),elevationInfo:oe(e,t),size:20,outlineSize:2,color:s.pointColor,outlineColor:s.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:o}=t,s=re(t),n=ie(e.lineStart,e.domain,t),a=ie(e.lineEnd,e.domain,t);return r(this._createLineSegmentHint(e.type,n,a,o,oe(e,t),i,s,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:o}=t,s=re(t),{isDraped:n}=e,a=oe(e,t),l=ie(e.lineStart,e.domain,t),d=ie(e.lineEnd,e.domain,t),p=ne(l,o,a,i,n),u=ne(d,o,a,i,n),m=c(u,p,u,.5),h=new Q({view:i,attached:!1,offset:M.parallelLineHintOffset,length:M.parallelLineHintLength,width:M.parallelLineHintWidth,color:s.parallelSignColor,location:m,renderOccluded:n?H.OccludeAndTransparent:H.Opaque,isDraped:n,renderGroup:P.SnappingHint,isDecoration:!0});return h.setDirectionFromPoints(p,m),h.attached=!0,r(h)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:o}=t,s=re(t),n=oe(e,t),{isDraped:a}=e,c=ie(e.previousVertex,e.domain,t),l=ie(e.centerVertex,e.domain,t),d=ie(e.nextVertex,e.domain,t),p=ne(c,o,n,i,a),u=ne(l,o,n,i,a),m=ne(d,o,n,i,a);return r(new F({view:i,attached:!0,color:a?s.rightAngleColorDraped:s.rightAngleColor,renderOccluded:a?H.OccludeAndTransparent:H.Transparent,outlineRenderOccluded:a?H.OccludeAndTransparent:H.Opaque,outlineColor:s.rightAngleOutlineColor,outlineSize:M.rightAngleHintOutlineSize,size:M.rightAngleHintSize,isDraped:a,geometry:{previous:p,center:u,next:m},renderGroup:P.SnappingHint,isDecoration:!0}))}_createLineSegmentHint(e,t,r,i,o,s,n,a=!1,c=!0,l=!0){const d=ne(t,i,o,s,a),p=ne(r,i,o,s,a),u=new h({view:s,extensionType:f.FADED,start:d,end:p,isDraped:a,color:n.lineColor,renderOccluded:a?H.OccludeAndTransparent:H.Opaque,renderGroup:P.SnappingHint,isDecoration:!0});switch(e){case W.TARGET:u.width=M.lineHintWidthTarget,u.fadedExtensions={start:0,end:M.lineHintFadedExtensions};break;case W.REFERENCE_EXTENSION:u.width=M.lineHintWidthReference,u.fadedExtensions={start:0,end:0};break;case W.REFERENCE:u.width=M.lineHintWidthReference,u.fadedExtensions={start:c?M.lineHintFadedExtensions:0,end:l?M.lineHintFadedExtensions:0}}return u.attached=!0,u}}function re(r){const{effectiveTheme:i}=r.view,o=e.toUnitRGBA(i.accentColor),s=[0,0,0,0];return{intersectionPointColor:s,intersectionPointOutlineColor:o,pointColor:s,pointOutlineColor:o,lineColor:o,lineOutlineColor:void 0,parallelSignColor:o,rightAngleColor:o,rightAngleColorDraped:e.toUnitRGBA(t(i.accentColor,.5)),rightAngleOutlineColor:o}}function ie(e,t,r){const i=se(t,r);return null==i?e:U(e[0],e[1],i)}function oe(e,t){return null!=se(e.domain,t)?t.selfSnappingZ.elevationInfo:e.isDraped?u:m}function se(e,{selfSnappingZ:t}){return e===q.SELF&&null!=t?t.value:null}function ne(e,t,r,i,o){const s=l();if(o){const r=i.basemapTerrain.overlayManager.renderer.spatialReference;p(e,t,s,r)}else k(e,t,r,i,s);return s}export{te as S};
