/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{h as t,U as e}from"../core/lang.js";import{t as r,l as i}from"./libtess.js";import"./earcut.js";import{T as n,G as s,j as o}from"./GeometryUtils.js";import{O as a}from"./OptimizedGeometry.js";import{n as c,Q as u,s as l,T as h,U as p,t as d,h as f,m as y,a as m,F as g}from"./definitions.js";import{f as x,h as _,S as v,G as b,i as w}from"./CIMSymbolHelper.js";import{c as S}from"../geometry/Polygon.js";import{v as T,p as P,i as I,j as k,L as M}from"./dataViewUtils.js";import{D as N}from"./enums.js";import{a as E}from"./screenUtils.js";import z from"../Color.js";import D from"../core/Error.js";import{L as F,n as B}from"./Logger.js";import{L as C,C as O,a as V,J as R,b as $}from"./enums2.js";import{L}from"./TurboLine.js";import{_ as U,b as G}from"./tslib.es6.js";import{B as A}from"./BindType.js";import{a as W}from"./Util.js";import{g as Y}from"../config.js";import"./Texture.js";import"./FramebufferObject.js";import{P as H}from"./Program.js";import{q as j}from"./ensureType.js";import{f as X,c as Z,t as q,r as K}from"./mat2d.js";import{c as Q}from"./mat2df32.js";import{a as J,b as tt,s as et,c as rt,d as it}from"./shapingUtils.js";import{c as nt}from"./mathUtils.js";import{F as st}from"./utils6.js";import{t as ot}from"./vec2.js";import at from"../core/Accessor.js";import{R as ct}from"./ReactiveMap.js";import{watch as ut}from"../core/reactiveUtils.js";import{property as lt}from"../core/accessorSupport/decorators/property.js";import{subclass as ht}from"../core/accessorSupport/decorators/subclass.js";import{U as pt}from"./UpdatingHandles.js";function dt(t){return t}function ft(t){return t}function yt(t,e,r,i,n,s,o){$t=0;const a=(i-r)*s,c=n&&n.length,u=c?(n[0]-r)*s:a;let l,h,p,d,f,y=mt(e,r,0,0,u,s,!0);if(y&&y.next!==y.prev){if(c&&(y=function(t,e,r,i,n,s){const o=new Array;for(let n=0,a=i.length;n<a;n++){const c=mt(t,e,0,i[n]*s,n<a-1?i[n+1]*s:r*s,s,!1);c===c.next&&(c.steiner=!0),o.push(St(c))}o.sort(Dt);for(const t of o)n=Tt(t,n);return n}(e,r,i,n,y,s)),a>80*s){l=p=e[0+r*s],h=d=e[1+r*s];for(let t=s;t<u;t+=s){const i=e[t+r*s],n=e[t+1+r*s];l=Math.min(l,i),h=Math.min(h,n),p=Math.max(p,i),d=Math.max(d,n)}f=Math.max(p-l,d-h),f=0!==f?1/f:0}xt(y,t,s,l,h,f,o,0)}}function mt(t,e,r,i,n,s,o){let a;if(o===function(t,e,r,i,n,s){let o=0;for(let r=i,a=n-s;r<n;r+=s)o+=(t[a+e*s]-t[r+e*s])*(t[r+1+e*s]+t[a+1+e*s]),a=r;return o}(t,e,0,i,n,s)>0)for(let r=i;r<n;r+=s)a=bt(r+e*s,t[r+e*s],t[r+1+e*s],a);else for(let r=n-s;r>=i;r-=s)a=bt(r+e*s,t[r+e*s],t[r+1+e*s],a);return a&&zt(a,a.next)&&(wt(a),a=a.next),a}function gt(t,e=t){if(!t)return t;let r,i=t;do{if(r=!1,i.steiner||!zt(i,i.next)&&0!==It(i.prev,i,i.next))i=i.next;else{if(wt(i),i=e=i.prev,i===i.next)break;r=!0}}while(r||i!==e);return e}function xt(t,e,r,i,n,s,o,a){if(!t)return;!a&&s&&(t=Pt(t,i,n,s));let c=t;for(;t.prev!==t.next;){const u=t.prev,l=t.next;if(s?vt(t,i,n,s):_t(t))e.push(u.index/r+o),e.push(t.index/r+o),e.push(l.index/r+o),wt(t),t=l.next,c=l.next;else if((t=l)===c){a?1===a?xt(t=Ft(t,e,r,o),e,r,i,n,s,o,2):2===a&&Bt(t,e,r,i,n,s,o):xt(gt(t),e,r,i,n,s,o,1);break}}}function _t(t){const e=t.prev,r=t,i=t.next;if(It(e,r,i)>=0)return!1;let n=t.next.next;const s=n;let o=0;for(;n!==t.prev&&(0===o||n!==s);){if(o++,Mt(e.x,e.y,r.x,r.y,i.x,i.y,n.x,n.y)&&It(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function vt(t,e,r,i){const n=t.prev,s=t,o=t.next;if(It(n,s,o)>=0)return!1;const a=n.x<s.x?n.x<o.x?n.x:o.x:s.x<o.x?s.x:o.x,c=n.y<s.y?n.y<o.y?n.y:o.y:s.y<o.y?s.y:o.y,u=n.x>s.x?n.x>o.x?n.x:o.x:s.x>o.x?s.x:o.x,l=n.y>s.y?n.y>o.y?n.y:o.y:s.y>o.y?s.y:o.y,h=Et(a,c,e,r,i),p=Et(u,l,e,r,i);let d=t.prevZ,f=t.nextZ;for(;d&&d.z>=h&&f&&f.z<=p;){if(d!==t.prev&&d!==t.next&&Mt(n.x,n.y,s.x,s.y,o.x,o.y,d.x,d.y)&&It(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,f!==t.prev&&f!==t.next&&Mt(n.x,n.y,s.x,s.y,o.x,o.y,f.x,f.y)&&It(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;d&&d.z>=h;){if(d!==t.prev&&d!==t.next&&Mt(n.x,n.y,s.x,s.y,o.x,o.y,d.x,d.y)&&It(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;f&&f.z<=p;){if(f!==t.prev&&f!==t.next&&Mt(n.x,n.y,s.x,s.y,o.x,o.y,f.x,f.y)&&It(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function bt(t,e,r,i){const n=Vt.create(t,e,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function wt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function St(t){let e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function Tt(t,e){const r=function(t,e){let r=e;const i=t.x,n=t.y;let s,o=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){const t=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(t<=i&&t>o){if(o=t,t===i){if(n===r.y)return r;if(n===r.next.y)return r.next}s=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!s)return null;if(i===o)return s.prev;const a=s,c=s.x,u=s.y;let l,h=1/0;for(r=s.next;r!==a;)i>=r.x&&r.x>=c&&i!==r.x&&Mt(n<u?i:o,n,c,u,n<u?o:i,n,r.x,r.y)&&(l=Math.abs(n-r.y)/(i-r.x),(l<h||l===h&&r.x>s.x)&&Nt(r,t)&&(s=r,h=l)),r=r.next;return s}(t,e);if(!r)return e;const i=Ot(r,t);return gt(i,i.next),gt(r,r.next)}function Pt(t,e,r,i){let n;for(;n!==t;n=n.next){if(n=n||t,null===n.z&&(n.z=Et(n.x,n.y,e,r,i)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,Pt(t,e,r,i);n.prevZ=n.prev,n.nextZ=n.next}return t.prevZ.nextZ=null,t.prevZ=null,function(t){let e,r=1;for(;;){let i,n=t;t=null,e=null;let s=0;for(;n;){s++,i=n;let o=0;for(;o<r&&i;o++)i=i.nextZ;let a=r;for(;o>0||a>0&&i;){let r;0===o?(r=i,i=i.nextZ,a--):0!==a&&i?n.z<=i.z?(r=n,n=n.nextZ,o--):(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,o--),e?e.nextZ=r:t=r,r.prevZ=e,e=r}n=i}if(e.nextZ=null,r*=2,s<2)return t}}(t)}function It(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function kt(t,e,r,i){return!!(zt(t,e)&&zt(r,i)||zt(t,i)&&zt(r,e))||It(t,e,r)>0!=It(t,e,i)>0&&It(r,i,t)>0!=It(r,i,e)>0}function Mt(t,e,r,i,n,s,o,a){return(n-o)*(e-a)-(t-o)*(s-a)>=0&&(t-o)*(i-a)-(r-o)*(e-a)>=0&&(r-o)*(s-a)-(n-o)*(i-a)>=0}function Nt(t,e){return It(t.prev,t,t.next)<0?It(t,e,t.next)>=0&&It(t,t.prev,e)>=0:It(t,e,t.prev)<0||It(t,t.next,e)<0}function Et(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function zt(t,e){return t.x===e.x&&t.y===e.y}function Dt(t,e){return t.x-e.x}function Ft(t,e,r,i){let n=t;do{const s=n.prev,o=n.next.next;!zt(s,o)&&kt(s,n,n.next,o)&&Nt(s,o)&&Nt(o,s)&&(e.push(s.index/r+i),e.push(n.index/r+i),e.push(o.index/r+i),wt(n),wt(n.next),n=t=o),n=n.next}while(n!==t);return n}function Bt(t,e,r,i,n,s,o){let a=t;do{let t=a.next.next;for(;t!==a.prev;){if(a.index!==t.index&&Ct(a,t)){let c=Ot(a,t);return a=gt(a,a.next),c=gt(c,c.next),xt(a,e,r,i,n,s,o,0),void xt(c,e,r,i,n,s,o,0)}t=t.next}a=a.next}while(a!==t)}function Ct(t,e){return t.next.index!==e.index&&t.prev.index!==e.index&&!function(t,e){let r=t;do{if(r.index!==t.index&&r.next.index!==t.index&&r.index!==e.index&&r.next.index!==e.index&&kt(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&Nt(t,e)&&Nt(e,t)&&function(t,e){let r=t,i=!1;const n=(t.x+e.x)/2,s=(t.y+e.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&n<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,e)}function Ot(t,e){const r=Vt.create(t.index,t.x,t.y),i=Vt.create(e.index,e.x,e.y),n=t.next,s=e.prev;return t.next=e,e.prev=t,r.next=n,n.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}class Vt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,r){const i=$t<Rt.length?Rt[$t++]:new Vt;return i.index=t,i.x=e,i.y=r,i.prev=null,i.next=null,i.z=null,i.prevZ=null,i.nextZ=null,i.steiner=!1,i}}const Rt=[];let $t=0;for(let t=0;t<8096;t++)Rt.push(new Vt);const Lt=new n(0,0,0,1,0),Ut=new n(0,0,0,1,0);function Gt(t,e,r){let i=0;for(let n=1;n<r;n++){const r=t[2*(e+n-1)],s=t[2*(e+n-1)+1];i+=(t[2*(e+n)]-r)*(t[2*(e+n)+1]+s)}return i}function At(t,e,r,i,n){let s=0;for(let o=r;o<i;o+=3){const r=2*(t[o]-n),i=2*(t[o+1]-n),a=2*(t[o+2]-n);s+=Math.abs((e[r]-e[a])*(e[i+1]-e[r+1])-(e[r]-e[i])*(e[a+1]-e[r+1]))}return s}Lt.setExtent(c),Ut.setExtent(c);class Wt{static executeEffects(t,e,r,i){const n=x(t);let s=new v(e);for(const e of t){const t=_(e);t&&(s=t.execute(s,e,1.3333333333333333,r,i,n))}return s}static applyEffects(t,e,r){if(!t)return e;const i=x(t);let n,s=new v(b.fromJSONCIM(e));for(const e of t){const t=_(e);t&&(s=t.execute(s,e,1,null,r,i))}const o=[];let a=null;for(;n=s.next();)o.push(...S(n)),a=n.geometryType;return 0===o.length||null===a?null:"esriGeometryPolygon"===a?{rings:o}:{paths:o}}}let Yt=null;function Ht(){return Yt}function jt(t){switch(t){case N.BYTE:case N.UNSIGNED_BYTE:return 1;case N.SHORT:case N.UNSIGNED_SHORT:return 2;case N.FLOAT:case N.INT:case N.UNSIGNED_INT:return 4}}class Xt{static fromVertexSpec({attributes:t},e){let r,i,n;const s=[];for(const o in t){const a=t[o];!1!==e?.[o]&&("position"===a.pack?r={...a,name:o,offset:0}:"id"===a.pack?i={...a,name:o,offset:4}:"bitset"===o?n={...a,name:o,offset:7}:s.push({...a,name:o}))}const o=function(t){const e=[],r=[],i=[];for(const n of t){const t=jt(n.type)*n.count;switch(t%2||t%4||4){case 4:e.push(n);continue;case 2:r.push(n);continue;case 1:i.push(n);continue;default:throw new Error("Found unexpected dataType byte count")}}return e.push(...r),e.push(...i),e}(s),a=[];let c=8,u=1;for(const t of o)a.push({...t,offset:c}),c+=jt(t.type)*t.count,t.packAlternating&&(u=Math.max(t.packAlternating.count,u));const l=Uint32Array.BYTES_PER_ELEMENT,h=c%l;return new Xt(r,i,n,a,c+(h?l-h:0),u)}constructor(t,e,r,i,n,s){this.position=t,this.id=e,this.bitset=r,this.standardAttributes=i,this.stride=n,this.packVertexCount=s,i.push(r),this._attributes=[t,e,r,...i]}get attributeLayout(){if(!this._attributeLayout){const t=T(this._attributes),e=this._attributes.map((t=>({name:t.name,count:t.count,offset:t.offset,type:t.type,packPrecisionFactor:t.packPrecisionFactor,normalized:t.normalized??!1})));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}}class Zt{static fromVertexSpec(t,e){const r=Xt.fromVertexSpec(t,e);return new Zt(r)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,r,i,n,s){for(let t=0;t<this._spec.packVertexCount;t++){const o=t*this._spec.stride;this._packPosition(r,i,o),this._packId(e,o);const a=this._spec.bitset;if(s){if(a.packTessellation){const t=a.packTessellation(s,n);this._pack(t,a,o)}for(const t of this._spec.standardAttributes)if(null!=t.packTessellation){const e=t.packTessellation(s,n);this._pack(e,t,o)}else if(t.packAlternating?.packTessellation){const e=t.packAlternating.packTessellation(s,n);for(let r=0;r<this._spec.packVertexCount;r++){const i=e[r];this._pack(i,t,r*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){for(const r of this._spec.standardAttributes)if(r.pack&&"string"!=typeof r.pack){const i=r.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++)this._pack(i,r,t*this._spec.stride)}else if(r.packAlternating?.pack){const i=r.packAlternating.pack(t,e);for(let t=0;t<this._spec.packVertexCount;t++){const e=i[t];this._pack(e,r,t*this._spec.stride)}}}_packPosition(t,e,r){const{offset:i}=this._spec.position,n=this._spec.position.packPrecisionFactor??1,s=I(t*n,e*n);this._dataView.setUint32(r+i,s,!0)}_packId(t,e){const r=t*(this._spec.id.packPrecisionFactor??1),i=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,r|i,!0)}_pack(t,e,r){P(this._dataView,t,e,r)}}class qt{constructor(t,e,r,i){this._instanceId=t,this._evaluator=e,this._viewParams=r,this._optionalAttributes=i,this._evaluator.evaluator=t=>this.vertexSpec.createComputedParams(t)}get _vertexPack(){if(!this._cachedVertexPack){const t=Zt.fromVertexSpec(this.vertexSpec,this._optionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){(function(t){if(!t)return!1;for(const e of t)switch(e.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1})(this._evaluator.inputMeshParams.params.effects?.effectInfos)&&await async function(){Yt=await import("./geometryEngineJSON.js").then((t=>t.g))}()}enqueueRequest(t,e,r){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,r)}write(t,e,r,i,n){this.ensurePacked(e,r,i);const s=this.evaluatedMeshParams.effects;if(!s||0===s.length)return void this._write(t,r,void 0,n);const o=r.readGeometryForDisplay()?.clone();if(!o)return;const a=b.fromOptimizedCIM(o,r.geometryType),c=Ht();a.invertY();const u=t.id||"",l=Wt.executeEffects(s,a,u,c);let h;for(;h=l.next();)h.invertY(),this._write(t,r,h,n)}ensurePacked(t,e,r){if(!this._evaluator.hasDynamicProperties)return;const i=this._evaluator.evaluateMeshParams(t,e,r);this._vertexPack.pack(i,this._viewParams)}_writeVertex(t,e,r,i,n){const s=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,r,i,s,n)}}const Kt=t("featurelayer-fast-triangulation-enabled");class Qt extends qt{async loadDependencies(){await Promise.all([super.loadDependencies(),i()])}_write(t,e,r){const i=r?.asOptimized()??e.readGeometryForDisplay(),n=this._clip(i);n&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,n),t.recordEnd())}_clip(t){return t?function(t,e){if(null==t)return null;if(!function(t,e,r){let i=0;for(let e=0;e<t.lengths.length;e++){const n=t.lengths[e];for(let e=0;e<n;e++){const n=t.coords[2*(e+i)],s=t.coords[2*(e+i)+1];if(n<-128||n>r||s<-128||s>r)return!0}i+=n}return!1}(t,0,c+128))return t;Lt.setPixelMargin(e),Lt.reset(s.Polygon);let r=0;for(let e=0;e<t.lengths.length;e++){const i=t.lengths[e];let n=t.coords[2*(0+r)],s=t.coords[2*(0+r)+1];Lt.moveTo(n,s);for(let e=1;e<i;e++)n=t.coords[2*(e+r)],s=t.coords[2*(e+r)+1],Lt.lineTo(n,s);Lt.close(),r+=i}const i=Lt.result(!1);if(!i)return null;const n=[],o=[];for(const t of i){let e=0;for(const r of t)o.push(r.x),o.push(r.y),e++;n.push(e)}return new a(n,o)}(t,this.hasEffects?256:8):null}_writeGeometry(t,e,i){const n=i.maxLength>100,s=[],o=this.createTesselationParams(e);if(!n&&Kt&&function(t,e){const{coords:r,lengths:i,hasIndeterminateRingOrder:n}=e,s=t;if(n)return!1;let o=0;for(let t=0;t<i.length;){let e=t,n=i[t],a=Gt(r,o,n);const c=[];for(;++e<i.length;){const t=i[e],s=Gt(r,o+n,t);if(!(s>0))break;a+=s,c.push(o+n),n+=t}const u=s.length;yt(s,r,o,o+n,c,2,0);const l=At(s,r,u,s.length,0),h=Math.abs(a);if(Math.abs((l-h)/Math.max(1e-7,h))>1e-5)return s.length=0,!1;t=e,o+=n}return!0}(s,i))return void(s.length&&this._writeVertices(t,e,i.coords,o,s));const a=function(t){const{coords:e,lengths:i}=t,{buffer:n}=r(e,i);return n}(i);this._writeVertices(t,e,a,o)}_writeVertices(t,e,r,i,n){const s=e.getDisplayId(),o=t.vertexCount(),a=this.hasEffects;let c=0;if(n)for(const e of n){const n=r[2*e],o=r[2*e+1];a&&t.recordBounds(n,o,0,0),this._writeVertex(t,s,n,o,i),c++}else for(let e=0;e<r.length;e+=2){const n=Math.round(r[e]),o=Math.round(r[e+1]);a&&t.recordBounds(n,o,0,0),this._writeVertex(t,s,n,o,i),c++}t.indexEnsureSize(c);for(let e=0;e<c;e++)t.indexWrite(e+o)}}const Jt={createComputedParams:t=>t,attributes:{id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1},pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:N.FLOAT,count:1,packTessellation:({inverseArea:t})=>t}}};function te(t,e){return[!!t?.minScale&&e.scaleToZoom(t.minScale)||0,!!t?.maxScale&&e.scaleToZoom(t.maxScale)||100]}function ee(t){return 1<<t}function re(t){let e=0;for(const[r,i]of t)i&&(e|=1<<r);return e}function ie(t){let e;if(!t)return[0,0,0,0];if("string"==typeof t){const r=z.fromString(t);if(!r)return F.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils").errorOnce(new D("mapview:mesh-processing","Unable to parse string into color",{color:t})),[0,0,0,0];e=r.toArray()}else e=t;const[r,i,n,s]=e;return[r*(s/255),i*(s/255),n*(s/255),s]}function ne(t,e){return Math.round(Math.min(Math.sqrt(t*e),255))}function se(t,e){return Math.round(t*e)/e}function oe(t,e){return Math.ceil(t*e)/e}const ae={createComputedParams:t=>t,attributes:{id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1},pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},zoomRange:{type:N.SHORT,count:2,packPrecisionFactor:u,pack:({scaleInfo:t},{tileInfo:e})=>te(t,e)},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ie(t)}}};class ce extends Qt{constructor(){super(...arguments),this.vertexSpec=ae}createTesselationParams(t){return null}}const ue={createComputedParams:t=>t,attributes:{...ae.attributes,tlbr:{count:4,type:N.UNSIGNED_SHORT,pack:({sprite:t})=>{const{rect:e,width:r,height:i}=t,n=e.x+l,s=e.y+l;return[n,s,n+r,s+i]}},inverseRasterizationScale:{count:1,type:N.BYTE,packPrecisionFactor:16,pack:({sprite:t})=>1/t.rasterizationScale}}};class le extends ce{constructor(){super(...arguments),this.vertexSpec=ue}_write(t,e,r){const i=r?.asOptimized()??e.readGeometryForDisplay(),n=this._clip(i);if(!n)return;const s=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,s),this._writeGeometry(t,e,n),t.recordEnd()}}var he;!function(t){t[t.Geographic=0]="Geographic",t[t.Arithmatic=1]="Arithmatic"}(he||(he={}));const pe=3.14159265359/180,de=3.14159265359/128,fe=1,ye=1.1,me=1,ge=24,xe=8,_e=1e-5,ve=1e-30,be=4,we=2,Se=3,Te=0,Pe=3,Ie=4;function ke(t){const{sprite:e,aspectRatio:r,scaleProportionally:i}=t,n=E(t.height),s=n>0?n:e.height;let o=n*r;return o<=0?o=e.width:i&&(o*=e.width/e.height),{width:o,height:s}}function Me(t){const{applyRandomOffset:e,sampleAlphaOnly:r}=t,{width:i,height:n}=ke(t);return re([[2,e],[4,r],[6,i<h],[5,n<h]])}function Ne(t){const{width:e}=ke(t);return Math.round(e<h?e*p:e)}function Ee(t){const{height:e}=ke(t);return Math.round(e<h?e*p:e)}const ze={createComputedParams:t=>t,attributes:{...ue.attributes,bitset:{count:1,type:N.UNSIGNED_BYTE,pack:Me},width:{count:1,type:N.UNSIGNED_SHORT,pack:Ne},height:{count:1,type:N.UNSIGNED_SHORT,pack:Ee},offset:{count:2,type:N.SHORT,pack:({offsetX:t,offsetY:e})=>[E(t),-E(e)]},scale:{count:2,type:N.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:t,scaleY:e})=>[t,e]},angle:{count:1,type:N.UNSIGNED_BYTE,pack:({angle:t})=>o(t)}}};class De{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}}const Fe={createComputedParams:t=>t,attributes:{id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:N.UNSIGNED_BYTE,count:1},zoomRange:{type:N.SHORT,count:2,packPrecisionFactor:u,pack:({scaleInfo:t},{tileInfo:e})=>te(t,e)},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ie(t)},offset:{type:N.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[se(t,16),se(e,16)]},normal:{type:N.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:t,normalY:e})=>[se(t,16),se(e,16)]},halfWidth:{type:N.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({width:t})=>oe(E(.5*t),16)},referenceHalfWidth:{type:N.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({referenceWidth:t})=>oe(E(.5*t),16)}}};class Be{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}}class Ce extends qt{constructor(t,e,r,i){super(t,e,r,i),this.vertexSpec=Fe,this._currentWrite=new Be,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:65535,textured:!1},this._tessParams=new De,this._initializeTessellator()}writeLineVertices(t,e,r){const i=this._getLines(e);null!=i&&this._writeVertices(t,r,i)}_initializeTessellator(){this._lineTessellator=new L(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,r){const i=r??b.fromFeatureSetReaderCIM(e);i&&this._writeGeometry(t,e,i)}_writeGeometry(t,e,r,i){t.recordStart(this.instanceId,this.attributeLayout,i),this.writeLineVertices(t,r,e),t.recordEnd()}_getLines(t){return function(t,e){Ut.setPixelMargin(e);const r=Ut,i=-e,n=c+e;let o=[],a=!1;if(!t.nextPath())return null;let u=!0;for(;u;){t.seekPathStart();const e=[];if(!t.pathSize)return null;r.reset(s.LineString),t.nextPoint();let c=t.x,l=t.y;if(a)r.moveTo(c,l);else{if(c<i||c>n||l<i||l>n){a=!0;continue}e.push({x:c,y:l})}let h=!1;for(;t.nextPoint();)if(c=t.x,l=t.y,a)r.lineTo(c,l);else{if(c<i||c>n||l<i||l>n){h=!0;break}e.push({x:c,y:l})}if(h)a=!0;else{if(a){const t=r.resultWithStarts();if(t)for(const e of t)o.push(e)}else o.push({line:e,start:0});u=t.nextPath(),a=!1}}return o=o.filter((t=>t.line.length>1)),0===o.length?null:o}(t,this.hasEffects?256:16)}_writeVertices(t,e,r){const{_currentWrite:i,_tessellationOptions:n,evaluatedMeshParams:s}=this,{width:o,capType:a,joinType:c,miterLimit:u,hasSizeVV:l}=s,h=E(.5*o);n.halfWidth=h,n.capType=function(t){switch(t){case"butt":case C.Butt:return O.BUTT;case"round":case C.Round:return O.ROUND;case"square":case C.Square:return O.SQUARE}}(a),n.joinType=function(t){switch(t){case"bevel":case V.Bevel:return R.BEVEL;case"miter":case V.Miter:return R.MITER;case"round":case V.Round:return R.ROUND}}(c),n.miterLimit=u;const p=!l;i.out=t,i.id=e.getDisplayId(),i.vertexCount=0,i.indexCount=0,i.vertexFrom=t.vertexCount(),i.vertexBounds=p&&h<d?0:1;for(const{line:t,start:e}of r)n.initialDistance=e%65535,this._lineTessellator.tessellate(t,n,p)}_writeTesselatedVertex(t,e,r,i,n,s,o,a,c,u,l){const{out:h,id:p,vertexBounds:d}=this._currentWrite;return this.hasEffects&&h.recordBounds(t,e,d,d),this._tessParams.extrusionOffsetX=o,this._tessParams.extrusionOffsetY=a,this._tessParams.normalX=c,this._tessParams.normalY=u,this._tessParams.directionX=n,this._tessParams.directionY=s,this._tessParams.distance=l,this._writeVertex(h,p,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,r){const{out:i}=this._currentWrite;i.indexEnsureSize(3),i.indexWrite(t),i.indexWrite(e),i.indexWrite(r),this._currentWrite.indexCount+=3}}const Oe={createComputedParams:t=>t,attributes:{...Fe.attributes,bitset:{type:N.UNSIGNED_BYTE,count:1,pack:t=>0},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ie(t)}}},Ve={createComputedParams:t=>t,attributes:{...Fe.attributes,bitset:{type:N.UNSIGNED_BYTE,count:1,pack:t=>re([[0,!0]])},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:t})=>ie(t)}}};class Re extends Ce{constructor(){super(...arguments),this.vertexSpec=Ve}}class $e extends ce{constructor(t,e,r,i){super(t,e,r,i),this.vertexSpec=Oe,this._lineMeshWriter=this._createOutlineWriter(t,e,r,i)}_createOutlineWriter(t,e,r,i){return new Re(t,e,r,i)}_write(t,e,r){const i=r?.asOptimized()??e.readGeometryForDisplay(),n=this._clip(i);n&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,n),this._lineMeshWriter.writeLineVertices(t,b.fromOptimizedCIM(n,"esriGeometryPolyline"),e),t.recordEnd())}ensurePacked(t,e,r){super.ensurePacked(t,e,r),this._lineMeshWriter.ensurePacked(t,e,r)}enqueueRequest(t,e,r){super.enqueueRequest(t,e,r),this._lineMeshWriter.enqueueRequest(t,e,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const Le=()=>F.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class Ue{constructor(){this._includedModules=new Map}include(t,e){if(this._includedModules.has(t)){const r=this._includedModules.get(t);if(r!==e){Le().error("Trying to include shader module multiple times with different sets of options.");const e=new Set;for(const i of Object.keys(r))r[i]!==t[i]&&e.add(i);for(const i of Object.keys(t))r[i]!==t[i]&&e.add(i);e.forEach((e=>console.error(`  ${e}: current ${r[e]} new ${t[e]}`)))}}else this._includedModules.set(t,e),t(this.builder,e)}}class Ge extends Ue{constructor(){super(...arguments),this.vertex=new Ye,this.fragment=new Ye,this.attributes=new He,this.varyings=new je,this.extensions=new Xe,this.constants=new Ze}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const r=this.extensions.generateSource(t),i=this.attributes.generateSource(t),n=this.varyings.generateSource(t),s="vertex"===t?this.vertex:this.fragment,o=s.uniforms.generateSource(),a=s.code.generateSource(),c="vertex"===t?qe:function(t=!0){return`#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n${t?"out vec4 fragColor;":""}\n`}(e),u=this.constants.generateSource().concat(s.constants.generateSource());return`${e?"#version 300 es":""}\n${r.join("\n")}\n${c}\n${u.join("\n")}\n${o.join("\n")}\n${i.join("\n")}\n${n.join("\n")}\n${a.join("\n")}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const r=t.bind[A.Pass];r&&e.set(t.name,r)})),this.fragment.uniforms.entries.forEach((t=>{const r=t.bind[A.Pass];r&&e.set(t.name,r)}));const r=Array.from(e.values()),i=r.length;return(e,n)=>{for(let s=0;s<i;++s)r[s](t,e,n)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach((t=>{const r=t.bind[A.Draw];r&&e.set(t.name,r)})),this.fragment.uniforms.entries.forEach((t=>{const r=t.bind[A.Draw];r&&e.set(t.name,r)}));const r=Array.from(e.values()),i=r.length;return(e,n,s)=>{for(let o=0;o<i;++o)r[o](t,e,n,s)}}}class Ae{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(t){if(null!=t){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new D(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else Le().error(`Trying to add null Uniform from ${(new Error).stack}.`)}generateSource(){return Array.from(this._entries.values()).map((t=>null!=t.arraySize?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`))}get entries(){return Array.from(this._entries.values())}}class We{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class Ye extends Ue{constructor(){super(...arguments),this.uniforms=new Ae,this.code=new We,this.constants=new Ze}get builder(){return this}}class He{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return"fragment"===t?[]:this._entries.map((t=>`in ${t[1]} ${t[0]};`))}}class je{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&W(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach(((r,i)=>e.push("vertex"===t?`out ${r} ${i};`:`in ${r} ${i};`))),e}}class Xe{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e="vertex"===t?Xe.ALLOWLIST_VERTEX:Xe.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((t=>e.includes(t))).map((t=>`#extension ${t} : enable`))}}Xe.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],Xe.ALLOWLIST_VERTEX=[];class Ze{constructor(){this._entries=new Set}add(t,e,r){let i="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":i=Ze._numberToFloatStr(r);break;case"int":i=Ze._numberToIntStr(r);break;case"bool":i=r.toString();break;case"vec2":i=`vec2(${Ze._numberToFloatStr(r[0])},                            ${Ze._numberToFloatStr(r[1])})`;break;case"vec3":i=`vec3(${Ze._numberToFloatStr(r[0])},                            ${Ze._numberToFloatStr(r[1])},                            ${Ze._numberToFloatStr(r[2])})`;break;case"vec4":i=`vec4(${Ze._numberToFloatStr(r[0])},                            ${Ze._numberToFloatStr(r[1])},                            ${Ze._numberToFloatStr(r[2])},                            ${Ze._numberToFloatStr(r[3])})`;break;case"ivec2":i=`ivec2(${Ze._numberToIntStr(r[0])},                             ${Ze._numberToIntStr(r[1])})`;break;case"ivec3":i=`ivec3(${Ze._numberToIntStr(r[0])},                             ${Ze._numberToIntStr(r[1])},                             ${Ze._numberToIntStr(r[2])})`;break;case"ivec4":i=`ivec4(${Ze._numberToIntStr(r[0])},                             ${Ze._numberToIntStr(r[1])},                             ${Ze._numberToIntStr(r[2])},                             ${Ze._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":i=`${e}(${Array.prototype.map.call(r,(t=>Ze._numberToFloatStr(t))).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${i};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}const qe="precision highp float;\nprecision highp sampler2D;";function Ke(t,e){const r=[];for(r.push(e);r.length;){const e=r.pop();if("object"==typeof e&&!t.has(e.uid)){t.add(e.uid);for(const t of e.children)r.push(t)}}}class Qe{constructor(){this.uid=Qe.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=t.split(" ").map(((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t)).join(""),this._debugName=t,this.isImplicit&&this.children[0]instanceof Qe&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}}function Je(t){return"object"==typeof t?t.clone():t}Qe.NodeCount=0;class tr extends Qe{constructor(){super(...arguments),this.shaderType="primitive-node"}}class er extends Qe{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new er(Je(this.child));return this.cloneInto(t),t}}class rr extends Qe{constructor(t,e,r){super(),this.property=t,this.target=e,this.returnType=r,this.shaderType="property-access-node"}get children(){const t=[this.target];return"string"!=typeof this.property&&t.push(this.property),t}clone(){const t=new rr(this.property,Je(this.target),this.returnType);return this.cloneInto(t),t}}class ir extends Qe{constructor(t,e,r){super(),this.condition=t,this.ifTrue=e,this.ifFalse=r,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=Je(this.ifTrue),e=this.ifFalse?Je(this.ifFalse):null,r=new ir(this.condition,t,e);return this.cloneInto(r),r}}class nr extends Qe{constructor(t,e,r,i){super(),this.captureList=t,this.returnType=e,this.generator=i,this.shaderType="block-node",r&&(this.subgraph=new er(r))}get children(){return Object.keys(this.captureList).map((t=>this.captureList[t])).concat(this.subgraph??[])}clone(){const t={};for(const e in this.captureList)t[e]=Je(this.captureList[e]);const e=new nr(t,this.returnType,this.subgraph?Je(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}}class sr extends Qe{constructor(t,e,r,i,n,s=!1){super(),this.token=t,this._children=e,this.isInfix=r,this.isPropertyAccess=i,this.returnType=n,this.isTernary=s,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new sr(this.token,this._children.map(Je),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}}var or,ar,cr,ur,lr,hr,pr,dr,fr,yr,mr,gr,xr,_r;function vr(t){return new Proxy(t,{get(e,r){if("constructor"===r)return new Proxy(e.constructor,{construct:(t,e,r)=>vr(new t(...e))});if(r in e)return e[r];if("string"==typeof r){const e=function(t){const e=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const r of e)if(r.includes(t))return r.map((t=>Yr[t]));throw new Error("Unable to find type family")}(t.type);return Kr(t,r,e[r.length-1])}}})}function br(t){return new Proxy(t,{construct:(t,e,r)=>vr(new t(...e))})}class wr extends Error{}let Sr=or=class extends tr{constructor(t,e){super(),this.elementType=t,this.size=e,this.children=[],this.type="array"}clone(){const t=new or(this.elementType,this.size);return super.cloneInto(t),t}get(t){if("number"==typeof t){const e=new Rr(t);return e.isImplicit=!0,Kr(this,e,this.elementType.constructor)}return Kr(this,t,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(t,e,r){return function(t,e,r=0,i=t.size){const n=new Rr(r).setMutable().setDebugName("FindIndexIterator"),s=e(t.get(n)).setDebugName("FindIndexPredicate"),o=ii({iter:n},Rr,s,(({out:t,iter:e,subgraph:r})=>`\n${t} = -1;\n\nfor (; ${e} < ${i}; ${e}++) {\n\n${r.body}\n\n  if (${r.varName}) {\n    ${t} = ${e};\n    break;\n  }\n\n}\n`)).setDebugName("FindIndexBlock");return o}(this,t,e,r)}glslFindIndex(t,e,r){return function(t,e,r=0,i=t.size){const n=ii({array:t},Rr,null,(({out:t,array:n})=>`\n${t} = -1;\nfor (int i = ${r}; i < ${i}; i++) {\n  bool condition;\n  ${e({array:n,i:"i",out:"condition"})}\n  if (condition) {\n    ${t} = i;\n    break;\n  }\n}\n`)).setDebugName("GlslFindIndexBlock");return n}(this,t,e,r)}static ofType(t,e){const r={construct:(r,i)=>new or(new t,e)};return new Proxy(or,r)}};Sr.type="array",Sr=or=U([function(t){return new Proxy(t,{construct:(t,e,r)=>{return i=new t(...e),new Proxy(i,{get(t,e){if(e in t)return t[e];if("string"==typeof e){const t=parseInt(e,10);if(!isNaN(t))return Kr(i,`[${t}]`,i.elementType.constructor)}}});var i}})}],Sr);class Tr extends tr{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new Tr;return t.children=this.children.map(Je),super.cloneInto(t),t}}Tr.type="sampler2D";class Pr extends tr{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new Pr(Je(this.children[0]));return super.cloneInto(t),t}multiply(t){return oi(this,"number"==typeof t?Or(t,Pr):t)}divide(t){return ai(this,"number"==typeof t?Or(t,Pr):t)}add(t){return ci(this,"number"==typeof t?Or(t,Pr):t)}subtract(t){return ui(this,"number"==typeof t?Or(t,Pr):t)}}Pr.type="float";let Ir=ar=class extends tr{constructor(t,e){super(),this.type="vec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new ar(Je(this.children[0]),Je(this.children[1]));return super.cloneInto(t),t}get 0(){return Kr(this,"[0]",Pr)}get 1(){return Kr(this,"[1]",Pr)}get 2(){throw new wr}get 3(){throw new wr}multiply(t){return oi(this,"number"==typeof t?Or(t,Pr):t)}divide(t){return ai(this,"number"==typeof t?Or(t,Pr):t)}add(t){return ci(this,"number"==typeof t?Or(t,Pr):t)}subtract(t){return ui(this,"number"==typeof t?Or(t,Pr):t)}};Ir.type="vec2",Ir=ar=U([br],Ir);let kr=cr=class extends tr{constructor(t,e,r){super(),this.type="vec3",this.children=[t,e,r].filter((t=>null!=t))}get 0(){return Kr(this,"[0]",Pr)}get 1(){return Kr(this,"[1]",Pr)}get 2(){return Kr(this,"[2]",Pr)}get 3(){throw new wr}clone(){const t=new cr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]));return super.cloneInto(t),t}multiply(t){return oi(this,"number"==typeof t?Or(t,Pr):t)}divide(t){return ai(this,"number"==typeof t?Or(t,Pr):t)}add(t){return ci(this,"number"==typeof t?Or(t,Pr):t)}subtract(t){return ui(this,"number"==typeof t?Or(t,Pr):t)}};kr.type="vec3",kr=cr=U([br],kr);let Mr=ur=class extends tr{constructor(t,e,r,i){super(),this.type="vec4",this.children=[t,e,r,i].filter((t=>null!=t))}clone(){const t=new ur(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]));return super.cloneInto(t),t}get 0(){return Kr(this,"[0]",Pr)}get 1(){return Kr(this,"[1]",Pr)}get 2(){return Kr(this,"[2]",Pr)}get 3(){return Kr(this,"[3]",Pr)}multiply(t){return oi(this,"number"==typeof t?Or(t,Pr):t)}divide(t){return ai(this,"number"==typeof t?Or(t,Pr):t)}add(t){return ci(this,"number"==typeof t?Or(t,Pr):t)}subtract(t){return ui(this,"number"==typeof t?Or(t,Pr):t)}};Mr.type="vec4",Mr=ur=U([br],Mr);let Nr=lr=class extends tr{constructor(t){super(),this.type="uint",this.children=[t]}clone(){const t=new lr(Je(this.children[0]));return super.cloneInto(t),t}};Nr.type="uint",Nr=lr=U([br],Nr);let Er=hr=class extends tr{constructor(t,e){super(),this.type="uvec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new hr(Je(this.children[0]),Je(this.children[1]));return super.cloneInto(t),t}};Er.type="uvec2",Er=hr=U([br],Er);let zr=pr=class extends tr{constructor(t,e,r){super(),this.type="uvec3",this.children=[t,e,r].filter((t=>null!=t))}clone(){const t=new pr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]));return super.cloneInto(t),t}};zr.type="uvec3",zr=pr=U([br],zr);let Dr=dr=class extends tr{constructor(t,e,r,i){super(),this.type="uvec4",this.children=[t,e,r,i].filter((t=>null!=t))}clone(){const t=new dr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]));return super.cloneInto(t),t}};Dr.type="uvec4",Dr=dr=U([br],Dr);class Fr extends tr{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return gi(this,t)}or(t){return mi(this,t)}clone(){const t=new Fr(Je(this.children[0]));return super.cloneInto(t),t}}Fr.type="bool";let Br=fr=class extends tr{constructor(t,e){super(),this.type="bvec2",this.children=[t,e].filter((t=>null!=t))}all(){return _i(this)}any(){return vi(this)}clone(){const t=new fr(Je(this.children[0]),Je(this.children[1]));return super.cloneInto(t),t}};Br.type="bvec2",Br=fr=U([br],Br);let Cr=yr=class extends tr{constructor(t,e,r){super(),this.type="bvec3",this.children=[t,e,r].filter((t=>null!=t))}all(){return _i(this)}any(){return vi(this)}clone(){const t=new yr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]));return super.cloneInto(t),t}};function Or(t,e){return"number"==typeof t?new e(t):t}Cr.type="bvec3",Cr=yr=U([br],Cr);let Vr=mr=class extends tr{constructor(t,e,r,i){super(),this.type="bvec4",this.children=[t,e,r,i].filter((t=>null!=t))}all(){return _i(this)}any(){return vi(this)}clone(){const t=new mr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]));return super.cloneInto(t),t}};Vr.type="bvec4",Vr=mr=U([br],Vr);class Rr extends tr{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return oi(this,Or(t,Rr))}add(t){return ci(this,Or(t,Rr))}subtract(t){return ui(this,Or(t,Rr))}divide(t){return ai(this,Or(t,Rr))}clone(){const t=new Rr(Je(this.children[0]));return super.cloneInto(t),t}}Rr.type="int";let $r=gr=class extends tr{constructor(t,e){super(),this.type="ivec2",this.children=[t,e].filter((t=>null!=t))}clone(){const t=new gr(Je(this.children[0]),Je(this.children[1]));return super.cloneInto(t),t}};$r.type="ivec2",$r=gr=U([br],$r);let Lr=xr=class extends tr{constructor(t,e,r){super(),this.type="ivec3",this.children=[t,e,r].filter((t=>null!=t))}clone(){const t=new xr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]));return super.cloneInto(t),t}};Lr.type="ivec3",Lr=xr=U([br],Lr);let Ur=_r=class extends tr{constructor(t,e,r,i){super(),this.type="ivec4",this.children=[t,e,r,i].filter((t=>null!=t))}clone(){const t=new _r(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]));return super.cloneInto(t),t}};Ur.type="ivec4",Ur=_r=U([br],Ur);class Gr extends tr{constructor(t,e,r,i){super(),this.type="mat2",this.children=[t,e,r,i]}clone(){const t=new Gr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]));return super.cloneInto(t),t}}Gr.type="mat2";class Ar extends tr{static identity(){return new Ar(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=Di(t),r=wi(t);return new Ar(r,e,0,ri(e),r,0,0,0,1)}constructor(t,e,r,i,n,s,o,a,c){super(),this.type="mat3",this.children=[t,e,r,i,n,s,o,a,c]}add(t){return ci(this,t)}multiply(t){return oi(this,t)}clone(){const t=new Ar(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]),Je(this.children[4]),Je(this.children[5]),Je(this.children[6]),Je(this.children[7]),Je(this.children[8]));return super.cloneInto(t),t}}Ar.type="mat3";class Wr extends tr{static identity(){return new Wr(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,r,i,n,s,o,a,c,u,l,h,p,d,f,y){super(),this.type="mat4",this.children=[t,e,r,i,n,s,o,a,c,u,l,h,p,d,f,y]}static fromColumns(t,e,r,i){return new Wr(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,r.x,r.y,r.z,r.w,i.x,i.y,i.z,i.w)}multiply(t){return oi(this,t)}clone(){const t=new Wr(Je(this.children[0]),Je(this.children[1]),Je(this.children[2]),Je(this.children[3]),Je(this.children[4]),Je(this.children[5]),Je(this.children[6]),Je(this.children[7]),Je(this.children[8]),Je(this.children[9]),Je(this.children[10]),Je(this.children[11]),Je(this.children[12]),Je(this.children[13]),Je(this.children[14]),Je(this.children[15]));return super.cloneInto(t),t}}Wr.type="mat4";const Yr={float:Pr,vec2:Ir,vec3:kr,vec4:Mr,int:Rr,ivec2:$r,ivec3:Lr,ivec4:Ur,uint:Nr,uvec2:Er,uvec3:zr,uvec4:Dr,bool:Fr,bvec2:Br,bvec3:Cr,bvec4:Vr},Hr=(...t)=>new Rr(...t),jr=(...t)=>new Pr(...t),Xr=(...t)=>new Ir(...t),Zr=(...t)=>new Mr(...t),qr=(...t)=>new Ar(...t);function Kr(t,e,r){const i=new r(new rr(e,t,r));return i.isImplicit=!0,i}function Qr(t,e,r,i=null){if(i){const n=new i,s=new i(new sr(t,[e,r],!0,!1,n));return s.isImplicit=!0,s}if("float"===e.type||"int"===e.type){const i=new r.constructor(new sr(t,[e,r],!0,!1,r.constructor));return i.isImplicit=!0,i}if(("mat2"===e.type||"mat3"===e.type||"mat4"===e.type)&&"float"!==r.type){const i=new r.constructor(new sr(t,[e,r],!0,!1,r.constructor));return i.isImplicit=!0,i}const n=new e.constructor(new sr(t,[e,r],!0,!1,e.constructor));return n.isImplicit=!0,n}function Jr(t,e,r=e.constructor){const i=new r(new sr(t,[e],!1,!1,r));return i.isImplicit=!0,i}function ti(t,e,r,i=e.constructor){const n=new i(new sr(t,[e,r],!1,!1,i));return n.isImplicit=!0,n}function ei(t,e,r,i,n=e.constructor){const s=new n(new sr(t,[e,r,i],!1,!1,n));return s.isImplicit=!0,s}function ri(t){return oi(t,jr(-1))}function ii(t,e,r,i){return new e(new nr(t,e,r,i))}function ni(t,e,r){const i="function"==typeof e?e():e,n="function"==typeof r?r():r,s=new i.constructor(new ir(t,i,n));return s.isImplicit=!0,s}function si(...t){const e=t.map((([t,e])=>"function"==typeof e?[t,e()]:[t,e])),r=e[0][1].constructor,i=e.findIndex((t=>!0===t[0]));if(-1===i)throw new Error("A cond must have a fallthrough case with `true`/; ");const n=e.slice(0,i),s=e[i][1],o=new r(n.reduceRight(((t,e)=>ni(e[0],e[1],t)),s));return o.isImplicit=!0,o}function oi(t,e){return Qr("*",t,e)}function ai(t,e){return Qr("/",t,e)}function ci(t,e){return Qr("+",t,e)}function ui(t,e){return Qr("-",t,e)}function li(t,e){return Qr(">>",t,e)}function hi(t,e){return Qr("&",t,e)}function pi(t,e){return Qr("==",t,e,Fr)}function di(t,e){return Qr("<=",t,e,Fr)}function fi(t,e){return Qr(">",t,e,Fr)}function yi(t,e){return Qr(">=",t,e,Fr)}function mi(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>Qr("||",t,e,Fr)),t[0])}function gi(...t){return t.length<=1?t[0]:t.slice(1).reduce(((t,e)=>Qr("&&",t,e,Fr)),t[0])}function xi(t){return Jr("abs",t)}function _i(t){return Jr("all",t,Fr)}function vi(t){return Jr("any",t,Fr)}function bi(t,e,r){return ei("clamp",t,e,r,t.constructor)}function wi(t){return Jr("cos",t)}function Si(t,e){return ti("distance",t,e,Pr)}function Ti(t,e){return ti("dot",t,e,Pr)}function Pi(t){return Jr("floor",t)}function Ii(t){return Jr("fract",t)}function ki(t){return Jr("length",t,Pr)}function Mi(t,e){return ti("max",t,e)}function Ni(t,e){return ti("min",t,e)}function Ei(t,e,r){return ei("mix",t,e,r)}function zi(t,e){return ti("mod",t,e)}function Di(t){return Jr("sin",t)}function Fi(t,e,r){return ei("smoothstep",t,e,r)}function Bi(t,e){return ti("step",t,e,e.constructor)}function Ci(t,e){return ti("texture2D",t,e,Mr)}function Oi(t,e,r){const i=e.split("\n");for(const e of i)if(e.trim().length){{let e="";null!=r&&(e+=`/*id:${r??"000"}*/   `),t.body+=e.padEnd(14)}t.body+=" ".repeat(t.indent)+e+"\n"}}class Vi{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let r="";return"boolean"!=typeof e&&"number"!=typeof e&&e.debugInfo.name&&(r=`${e.debugInfo.name}_`),`${r}v${t.varCount++}`}_write(t,e,r=!1){if("number"==typeof e)return e.toString();if("boolean"==typeof e)return e.toString();let i=t.getEmit(e);if(i)return i;switch(e.shaderType){case"scope-node":i=this._writeScopeNode(t,e);break;case"primitive-node":i=this._writePrimitveNode(t,e,r);break;case"function-node":i=this._writeFunctionNode(t,e);break;case"property-access-node":i=this._writePropertyAccessNode(t,e);break;case"text-node":i=e.text;break;case"block-node":i=this._writeBlockNode(t,e);break;case"condition-node":i=this._writeConditionNode(t,e)}return t.setEmit(e,i),i}_writeScopeNode(t,e){const r=new e.child.constructor;r.setDebugName(e.debugInfo.name);const i=this._write(t,r,!0);return Oi(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2,Oi(t,`${i} = ${this._write(t,e.child)};`),t.indent-=2,Oi(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),i}_writeConditionNode(t,e){const r=new e.ifTrue.constructor,i=this._write(t,r,!0);Oi(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const n=t.createSubgraphContext(),s=this._write(n,e.ifTrue);if(t.body+=n.body,s&&Oi(t,`${i} = ${s};`),t.indent-=2,Oi(t,"}"),e.ifFalse){Oi(t,"else {"),t.indent+=2;const r=t.createSubgraphContext(),n=this._write(r,e.ifFalse);t.body+=r.body,n&&Oi(t,`${i} = ${n};`),t.indent-=2,Oi(t,"}")}return i}_writeBlockNode(t,e){const{captureList:r,generator:i,returnType:n}=e,s={};for(const e in r){if(!r[e])continue;const i=this._write(t,r[e]);s[e]=i}const o=new n,a=this._write(t,o,!0);if(s.out=a,e.subgraph){const r=t.createSubgraphContext(),i=this._write(r,e.subgraph.child),n=r.body;s.subgraph={varName:i,body:n}}const c=i(s);return Oi(t,"{\n"),t.indent+=2,Oi(t,c),t.indent-=2,Oi(t,"}\n"),a}_writePropertyAccessNode(t,e){const r=this._write(t,e.target);return"string"==typeof e.property&&e.property.includes("[")?`${r}${e.property}`:"string"!=typeof e.property?`${r}[${this._write(t,e.property)}]`:`${r}.${e.property}`}_writeFunctionNode(t,e){const r=e.returnType.type;if(e.isInfix){const[i,n]=e.children.map((e=>this._write(t,e))),s=this._createVarName(t,e);return Oi(t,`${r.padEnd(5)} ${s} = ${i} ${e.token} ${n};`,e.uid),s}const i=e.children.map((e=>this._write(t,e))).join(", "),n=this._createVarName(t,e);return Oi(t,`${r.padEnd(5)} ${n} = ${e.token}(${i});`,e.uid),n}_writePrimitveNode(t,e,r=!1){const i=t.getInput(e);if(i)return i.isUsed=!0,i.variableName;const n=1===e.children.length&&e.children[0]?.type===e.type;if(e.isImplicit||n)return this._write(t,e.children[0]);const s=this._createVarName(t,e);if(r)return Oi(t,`${e.type.padEnd(5)} ${s};`,e.uid),s;const o=!e.debugInfo.name&&!e.isMutable;if(o&&"float"===e.type&&"number"==typeof e.children[0])return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(o&&"int"===e.type&&"number"==typeof e.children[0]&&Number.isInteger(e.children[0]))return e.children[0].toString();const a=e.children.map((e=>this._write(t,e))).join(", ");return"array"===e.type?(Oi(t,`${e.type.padEnd(5)} ${s} = [${a}];`,e.uid),s):o?`${e.type}(${a})`:(Oi(t,`${e.type.padEnd(5)} ${s} = ${e.type}(${a});`,e.uid),s)}}class Ri{constructor(t,e,r){this.variableName=t,this.variableInputType=e,this.node=r,this.type="shader-input",this.isUsed=!1}clone(){return new Ri(this.variableName,this.variableInputType,Je(this.node))}}class $i{constructor(t,e,r){this.outVariableName=t,this.outVariableType=e,this.node=r,this.type="shader-output"}clone(){const t=new $i(this.outVariableName,this.outVariableType,Je(this.node));return t.variableName=this.variableName,t}}class Li{static createVertex(t,e,r,i,n,s){const o=[];for(const e in t){const i=t[e],n=r.get(e);n?o.push(new Ri(n,"builtin",i)):o.push(new Ri("a_"+e,"attribute",i))}for(const t of i){const e=t.uniformHydrated;o.push(new Ri(t.uniformName,"uniform",e))}const a=[];for(const t in e){const r=e[t];"glPosition"===t?a.push(new $i("gl_Position","builtin",r)):"glPointSize"===t?a.push(new $i("gl_PointSize","builtin",r)):a.push(new $i("v_"+t,"varying",r))}return new Li(o,a,n,s)}static createFragment(t,e,r,i,n,s){const o=[],a=Array.from(n.rootOutputNodes());for(const e in t){const i=t[e],n=r.get(e);if(n){o.push(new Ri(n,"builtin",i));continue}const s=a.find((t=>t.node===i));s&&o.push(new Ri(s.outVariableName,s.outVariableType,i))}for(const t of i){const e=t.uniformHydrated;o.push(new Ri(t.uniformName,"uniform",e))}const c=[];for(const t in e){const i=e[t],n=r.get(t);if("discard"===t)c.push(new $i(null,"discard",i));else{if(!n)throw new Error(`Member ${t} in shader fragment output shoule be tagged as builtin`);c.push(new $i(n,"builtin",i))}}return new Li(o,c,s)}constructor(t,e,r,i){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const e of t)this._inputShaderTypesByNodeUid.set(e.node.uid,e);this._outputShaderTypes=e,this._transformFeedbackBindings=r,this._transformFeedbackNames=new Set(r.map((t=>"v_"+t.propertyKey))),this._usedInFragmentShader=i}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&"builtin"!==t.outVariableType&&!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();"number"!=typeof e&&"boolean"!=typeof e&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())"number"!=typeof t&&"boolean"!=typeof t&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new Li([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const r="builtin"===e.outVariableType;this.shouldPruneOutputNode(e)||(r?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split("\n").join("\n  "));for(const e of this.rootOutputNodes())"discard"===e.outVariableType?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const r of this.inputs())r.isUsed&&"builtin"!==r.variableInputType&&("array"===r.node.type?t[e].code.add(`${r.variableInputType.padEnd(10)} ${r.node.elementType.type.padEnd(9)} ${r.variableName}[${r.node.size}];`):t[e].code.add(`${r.variableInputType.padEnd(10)} ${r.node.type.padEnd(9)} ${r.variableName};`))}}function Ui(t,e,r){const i=e.length;if(i!==r){const n=new D("Invalid Uniform",`Invalid length, expected ${r} but got ${i}`,{uniformName:t,values:e});F.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram").errorOnce(n)}}class Gi{constructor(t,e,r,i,n,s){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=r,this._locationInfo=i,this._uniformBindings=n,this._transformFeedbackBindings=s}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const e=new Map;for(const[t,r]of this._locations)e.set(t,r);const r=[];for(const t of this._transformFeedbackBindings??[]){const{index:e,propertyKey:i}=t;r[e]=`v_${i}`}this._program=new H(t,this.vertexShader,this.fragmentShader,e,new Map,r)}const r=this._program;t.useProgram(r);for(const i of this._uniformBindings){const{shaderModulePath:n,uniformName:s,uniformType:o,uniformArrayLength:a}=i,c=Y(n,e);if(null==c){if("sampler2D"===o)continue;throw new Error(`Failed to find uniform value for ${n}`)}switch("array"===o?i.uniformArrayElementType:o){case"sampler2D":{const{unit:e,texture:i}=c;if(r.setUniform1i(s,e),"type"in i)t.bindTexture(i,e);else{const r=k(t,i.descriptor,i.data);t.bindTexture(r,e)}break}case"int":if(!a){r.setUniform1i(s,c);break}Ui(i.uniformName,c,a),r.setUniform1iv(s,c);break;case"float":if(!a){r.setUniform1f(s,c);break}Ui(i.uniformName,c,a),r.setUniform1fv(s,c);break;case"vec2":if(!a){r.setUniform2f(s,c[0],c[1]);break}Ui(i.uniformName,c,a),r.setUniform2fv(s,c.flat());break;case"vec3":if(!a){r.setUniform3f(s,c[0],c[1],c[2]);break}Ui(i.uniformName,c,a),r.setUniform3fv(s,c.flat());break;case"vec4":if(!a){r.setUniform4f(s,c[0],c[1],c[2],c[3]);break}Ui(i.uniformName,c,a),r.setUniform4fv(s,c.flat());break;case"mat3":r.setUniformMatrix3fv(s,c.flat());break;case"mat4":r.setUniformMatrix4fv(s,c.flat());break;default:throw new Error(`Unable to set uniform for type ${o}`)}}}}function Ai(t){return new t}function Wi(t,e,r){const i=t.constructor[e]??[];t.constructor.hasOwnProperty(e)||Object.defineProperty(t.constructor,e,{value:i.slice()}),t.constructor[e].push(r)}function Yi(t,e){return(r,i)=>{Wi(r,"locations",{typeCtor:e,propertyKey:i,parameterIndex:null,index:t})}}const Hi=t=>(e,r,i)=>{Wi(e,"inputs",{inputCtor:t,propertyKey:r,parameterIndex:i})},ji=t=>(e,r)=>{Wi(e,"uniforms",{typeCtor:t,propertyKey:r})},Xi=t=>(e,r)=>{Wi(e,"options",{typeCtor:t,propertyKey:r})},Zi=(t,e)=>{Wi(t,"defines",{propertyKey:e})},qi=(t,e)=>(r,i)=>{r.constructor.builtins.push({builtin:t,propertyKey:i,typeCtor:e})};class Ki{}Ki.builtins=[],U([qi("gl_VertexID",Rr)],Ki.prototype,"glVertexID",void 0);class Qi{}class Ji{}Ji.builtins=[],U([qi("gl_FragCoord",Mr)],Ji.prototype,"glFragCoord",void 0),U([qi("gl_PointCoord",Ir)],Ji.prototype,"glPointCoord",void 0);class tn{}U([(t,e)=>{Wi(t,"builtins",{builtin:"gl_FragColor",propertyKey:e})}],tn.prototype,"glFragColor",void 0);class en{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}}class rn{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=e(this._shaderModuleClass.inputs,(t=>"vertex"===t.propertyKey&&0===t.parameterIndex));if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return e(this._shaderModuleClass.inputs,(t=>"vertex"===t.propertyKey&&1===t.parameterIndex))}get fragmentInput(){const t=e(this._shaderModuleClass.inputs,(t=>"fragment"===t.propertyKey));if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){const t=new Map,e=new Set;for(const r of this.locations)e.has(r.index)?F.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${r.propertyKey} to ${r.index}. Index already in use`,{locationsMap:t}):(t.set(r.propertyKey,r.index),e.add(r.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map((([t,e])=>`${t}.${e}`)).join("."),r=B(e);this._locationInfo={hash:r,locations:t}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,r,i){try{const{vertex:n,fragment:s,uniformBindings:o}=this._generateShaders(t,e,r,i);return new Gi(n,s,this.renamedLocationsMap,this.locationInfo,o,this.transformFeedbackBindings)}catch(t){return console.error("Failed to create program",{error:t}),new Gi("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find((e=>e.propertyKey===t));if(e)return{type:"option",className:e.typeCtor};const r=this._uniforms.find((e=>e.propertyKey===t));if(!r)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:r.typeCtor}}getShaderKey(t,e,r,i){const n=Object.keys(r).map((t=>`${t}.${r[t]}`)).join("."),s=Object.keys(i).map((t=>`${t}.${i[t]}`)).join("."),o=Object.keys(e).filter((t=>this.optionPropertyKeys.has(t)&&e[t])).join(".");return`${this.constructor.name}.${t.hash}.${n}.${s}.${o}`}_generateShaders(t,e,r,i){const n=[];this._setDefines(r),this._setOptionalUniforms(n,e),this._setRequiredUniforms(n);const s=this._hydrateVertexInput(i),o=this._injectPackPrecisionFactor(s,t),a=this._hydrateComputeInput(),c=a&&this._injectPackPrecisionFactor(a,t),u=this.vertex(o,c),l=this._hydrateFragmentInput(u),h=this.fragment(l),p=new Set;for(const t in h)Ke(p,h[t]);const d=this._getVertexInputBuiltins(),f=Li.createVertex({...s,...a},u,d,n,this.transformFeedbackBindings,p);(new Vi).write(f);const y=this._getFragmentInputBuiltins(h);y.set("glPointCoord","gl_PointCoord");const m=Li.createFragment(l,h,y,n,f,this.transformFeedbackBindings);(new Vi).write(m);const g=this._createShaderBuilder(f,m),x=g.generate("vertex",!1),_=g.generate("fragment",!1);return this.logShader&&(console.log(x),console.log(_)),{vertex:x,fragment:_,uniformBindings:n}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const r of this._options)e[r.propertyKey]?this[r.propertyKey]=this._hydrateUniformGroup(t,r):this[r.propertyKey]=null}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const r=new(0,e.typeCtor);for(const i of r._uniforms??[]){const n=Ai(i.typeCtor),s=`u_${e.propertyKey}_${i.propertyKey}`,o=n.type,a=[e.propertyKey,i.propertyKey].join(".");if("type"in i.typeCtor&&"array"===i.typeCtor.type){const e=n;t.push({shaderModulePath:a,uniformName:s,uniformType:o,uniformArrayLength:e.size,uniformArrayElementType:e.elementType.type,uniformHydrated:n})}else t.push({shaderModulePath:a,uniformName:s,uniformType:o,uniformHydrated:n});r[i.propertyKey]=n}return r}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,r=e.locations.reduce(((e,r)=>!1===t[r.propertyKey]?e:{...e,[r.propertyKey]:Ai(r.typeCtor)}),{});for(const{propertyKey:t,typeCtor:i}of e.builtins){const e=Ai(i);r[t]=e}return r}_hydrateComputeInput(){return null==this.computeInput?null:this.computeInput.inputCtor.locations.reduce(((t,e)=>({...t,[e.propertyKey]:Ai(e.typeCtor)})),{})}_injectPackPrecisionFactor(t,e){const r={};for(const i in t){const n=t[i],s=e.attributes.find((t=>t.name===i));if(s?.packPrecisionFactor){if("float"!==n.type&&"vec2"!==n.type&&"vec3"!==n.type&&"vec4"!==n.type)throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${n.type}`);r[i]=n.divide(new Pr(s.packPrecisionFactor))}else r[i]=n}return r}_hydrateFragmentInput(t){const e={};for(const r in t)e[r]=t[r];for(const{propertyKey:t,typeCtor:r}of Ji.builtins){const i=Ai(r);e[t]=i}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:r,propertyKey:i}of t.builtins)e.set(i,r);return e}_getFragmentInputBuiltins(t){const e=t.constructor,r=new Map;for(const t of e.builtins??[])r.set(t.propertyKey,t.builtin);return r}_createShaderBuilder(t,e){const r=new Ge;return this._insertDebugInfo(r),t.insertVertexShader(r),e.insertFragmentShader(r),r}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}}function nn(t){const e=jr(12.9898),r=jr(78.233),i=jr(43758.5453);return Ii(Di(zi(Ti(t,Xr(e,r)),jr(3.14))).multiply(i))}function sn(t){return pi(t,jr(ve))}function on(t,e){const r=jr(2**e);return zi(Pi(t.divide(r)),jr(2))}function an(t,e){return fi(on(t,e),jr(.5))}function cn(t,e){return on(t,e+f.length)}function un(t){return Ti(t,Zr(255/256,255/65536,255/16777216,255/4294967296))}function ln(t){return Mi(Mi(Mi(t.x,t.y),t.z),t.w)}class hn extends en{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=Ci(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=function(t){const e=on(t.z,7),r=jr(1).subtract(e),i=t.xyz.subtract(((...t)=>new kr(...t))(0,0,jr(128)));return r.multiply(t).add(e.multiply(i))}(t),r=this.size,i=Hr(e.x),n=Hr(e.y).multiply(Hr(256)),s=Hr(e.z).multiply(Hr(256)).multiply(Hr(256)),o=jr(i.add(n).add(s)),a=zi(o,r),c=o.subtract(a).divide(r);this._uv=new Ir(a,c).add(.5).divide(r)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return Ci(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return Ci(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return Ci(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return Ci(this.gpgpu,e).setDebugName("storage4")}getFilterFlags(e){return t("webgl-ignores-sampler-precision")?Jr("ceil",this.getFilterData(e).x.multiply(jr(255))):this.getFilterData(e).x.multiply(jr(255))}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}}U([ji(Tr)],hn.prototype,"filterFlags",void 0),U([ji(Tr)],hn.prototype,"animation",void 0),U([ji(Tr)],hn.prototype,"gpgpu",void 0),U([ji(Tr)],hn.prototype,"visualVariableData",void 0),U([ji(Tr)],hn.prototype,"dataDriven0",void 0),U([ji(Tr)],hn.prototype,"dataDriven1",void 0),U([ji(Tr)],hn.prototype,"dataDriven2",void 0),U([ji(Pr)],hn.prototype,"size",void 0);class pn extends en{}U([ji(Pr)],pn.prototype,"activeReasons",void 0),U([ji(Pr)],pn.prototype,"highlightAll",void 0);class dn extends en{}U([ji(Ir)],dn.prototype,"position",void 0),U([ji(Pr)],dn.prototype,"distance",void 0);class fn extends en{}U([ji(Ar)],fn.prototype,"displayViewScreenMat3",void 0),U([ji(Ar)],fn.prototype,"displayViewMat3",void 0),U([ji(Ar)],fn.prototype,"displayMat3",void 0),U([ji(Ar)],fn.prototype,"viewMat3",void 0),U([ji(Ar)],fn.prototype,"tileMat3",void 0),U([ji(Pr)],fn.prototype,"displayZoomFactor",void 0),U([ji(Pr)],fn.prototype,"requiredZoomFactor",void 0),U([ji(Ir)],fn.prototype,"tileOffset",void 0),U([ji(Pr)],fn.prototype,"currentScale",void 0),U([ji(Pr)],fn.prototype,"currentZoom",void 0),U([ji(Pr)],fn.prototype,"metersPerSRUnit",void 0),U([ji(Pr)],fn.prototype,"rotation",void 0);class yn extends Ki{}U([Yi(0,kr)],yn.prototype,"id",void 0),U([Yi(1,Pr)],yn.prototype,"bitset",void 0),U([Yi(2,Ir)],yn.prototype,"pos",void 0);class mn extends Qi{}U([Yi(14,Ir)],mn.prototype,"nextPos1",void 0),U([Yi(15,Ir)],mn.prototype,"nextPos2",void 0);class gn extends Ji{}class xn extends rn{clip(t,e){let r=new Pr(0);const i=this.storage.getFilterFlags(t);if(r=r.add(jr(2).multiply(jr(1).subtract(cn(i,0)))),this.inside?r=r.add(jr(2).multiply(jr(1).subtract(cn(i,1)))):this.outside?r=r.add(jr(2).multiply(cn(i,1))):this.highlight&&(r=r.add(jr(2).multiply(jr(1).subtract(this._checkHighlight(i))))),null!=e){const t=new Pr(1).subtract(Bi(e.x,this.view.currentZoom)),i=Bi(e.y,this.view.currentZoom);r=r.add(new Pr(2).multiply(t.add(i)))}return r}getFragmentOutput(t,e,r=new Pr(1/255)){const i=new tn;return i.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,r)??t,i}_maybeHighlight(t,e){return this.highlight?new Mr(t.rgb,Bi(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let r=1;r<f.length;r++)e=e.add(this._checkHighlightBit(t,r));return Bi(new Pr(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return function(t,e){return on(t,e)}(t,e).multiply(on(this.highlight.activeReasons,e))}maybeRunHittest(t,e,r){if(null==this.hittestRequest)return null;const i=this.hittest(t,e,r),n=ni(yi(i,this.hittestRequest.distance),new Pr(2),new Pr(0)),s=this.storage.getAttributeDataCoords(t.id).multiply(2).subtract(1),o=new Mr(new Pr(1/255),0,0,Bi(new Pr(0),i).divide(255));return{glPointSize:new Pr(1),glPosition:new Mr(s,n,1),color:o}}_maybeWriteHittest(t){return null!=this.hittestRequest?t.color:null}}function _n(t,e,r){const i=r.subtract(e),n=bi((s=t.subtract(e),o=i,Ti(s,Jr("normalize",o))).divide(ki(i)),new Pr(0),new Pr(1));var s,o;return Si(t,e.add(n.multiply(r.subtract(e))))}function vn(t){const e=xi(t);return Bi(e.x.add(e.y).add(e.z),new Pr(1.05))}function bn(t,e,r,i){const n=new Ar(r.x.multiply(i.y).subtract(i.x.multiply(r.y)),i.x.multiply(e.y).subtract(e.x.multiply(i.y)),e.x.multiply(r.y).subtract(r.x.multiply(e.y)),r.y.subtract(i.y),i.y.subtract(e.y),e.y.subtract(r.y),i.x.subtract(r.x),e.x.subtract(i.x),r.x.subtract(e.x)),s=e.x.multiply(r.y.subtract(i.y)),o=r.x.multiply(i.y.subtract(e.y)),a=i.x.multiply(e.y.subtract(r.y)),c=s.add(o).add(a);return new Pr(1).divide(c).multiply(n.multiply(new kr(1,t)))}function wn(t,e,r,i){return pi(vn(bn(t,e,r,i)),new Pr(1))}function Sn(t){return t.distance.add(1)}function Tn(t,e,r){const{viewMat3:i,tileMat3:n}=t.view,s=i.multiply(n),o=s.multiply(new kr(e.pos,1)),a=s.multiply(new kr(r.nextPos1,1)),c=s.multiply(new kr(r.nextPos2,1));return function(t,e,r,i){const n=function(t,e){return t.x.multiply(e.y).subtract(e.x.multiply(t.y))}(r.subtract(e),i.subtract(e)),s=gi(function(t,e){return Qr("<",t,new Pr(.05),Fr)}(n),fi(n,new Pr(-.05)));return si([gi((o=s,"bool"===o.type?Jr("!",o):Jr("not",o)),wn(t.xy,e,r,i)),new Pr(-1)],[!0,()=>{const n=_n(t,e,r),s=_n(t,r,i),o=_n(t,i,e);return Ni(Ni(n,s),o)}]);var o}(t.hittestRequest.position,o.xy,a.xy,c.xy)}function Pn(t,e,r){return Si(t,r).subtract(e)}U([Zi],xn.prototype,"inside",void 0),U([Zi],xn.prototype,"outside",void 0),U([Xi(pn)],xn.prototype,"highlight",void 0),U([ji(hn)],xn.prototype,"storage",void 0),U([ji(fn)],xn.prototype,"view",void 0),U([Xi(dn)],xn.prototype,"hittestRequest",void 0);class In extends en{getColor(t,e,r){return si([mi(sn(t),r),e],[di(t,this.values.first()),this.colors.first()],[yi(t,this.values.last()),this.colors.last()],[!0,()=>{const e=this.values.findIndex((e=>fi(e,t))),r=this.values.get(e),i=e.subtract(1),n=this.values.get(i),s=t.subtract(n).divide(r.subtract(n));return Ei(this.colors.get(i),this.colors.get(e),s)}])}}U([ji(Sr.ofType(Mr,8))],In.prototype,"colors",void 0),U([ji(Sr.ofType(Pr,8))],In.prototype,"values",void 0);class kn extends en{getOpacity(t){return si([sn(t),new Pr(1)],[di(t,this.opacityValues.first()),this.opacities.first()],[yi(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex((e=>fi(e,t))),r=this.opacityValues.get(e),i=e.subtract(1),n=this.opacityValues.get(i),s=t.subtract(n).divide(r.subtract(n));return Ei(this.opacities.get(i),this.opacities.get(e),s)}])}}function Mn(t){return null!=t.visualVariableSizeMinMaxValue||null!=t.visualVariableSizeScaleStops||null!=t.visualVariableSizeStops||null!=t.visualVariableSizeUnitValue}function Nn(t,e,r){if(Mn(t)){const i=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(i,r)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(i,r)??t.visualVariableSizeUnitValue?.getSize(i,r)}return r}function En(t,e,r,i=new Fr(!1)){if(null==t.visualVariableColor)return r;const n=t.storage.getColorValue(e);return t.visualVariableColor.getColor(n,r,i)}function zn(t,e){if(null==t.visualVariableOpacity)return new Pr(1);const r=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(r)}function Dn(t,e){if(null==t.visualVariableRotation)return Ar.identity();const r=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(r)}U([ji(Sr.ofType(Pr,8))],kn.prototype,"opacities",void 0),U([ji(Sr.ofType(Pr,8))],kn.prototype,"opacityValues",void 0);class Fn extends yn{}U([Yi(3,Mr)],Fn.prototype,"color",void 0),U([Yi(4,Ir)],Fn.prototype,"zoomRange",void 0);class Bn extends xn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const r=zn(this,t.id),i=En(this,t.id,t.color).multiply(r),n=this.view.displayViewScreenMat3.multiply(new kr(t.pos.xy,1)),s=this.clip(t.id,t.zoomRange);return{glPosition:new Mr(n.xy,s,1),color:i,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new Pr(0))}hittest(t,e){return Tn(this,t,e)}}U([Xi(In)],Bn.prototype,"visualVariableColor",void 0),U([Xi(kn)],Bn.prototype,"visualVariableOpacity",void 0),U([G(0,Hi(Fn)),G(1,Hi(mn))],Bn.prototype,"vertex",null),U([G(0,Hi(gn))],Bn.prototype,"fragment",null);class Cn extends en{getPatternOffsetAtTileOrigin(t,e=new Pr(0),r=new Pr(1)){const i=new Ir(16777216).divide(t);let n=t.multiply(Ii(this.maxIntsToLocalOrigin.multiply(i))).add(this.tileOffsetFromLocalOrigin).subtract(new Pr(.5).multiply(t));return n=new Ir(n.x.multiply(r).subtract(n.y.multiply(e)),n.x.multiply(e).add(n.y.multiply(r))),zi(n,t)}}U([ji(Ir)],Cn.prototype,"tileOffsetFromLocalOrigin",void 0),U([ji(Ir)],Cn.prototype,"maxIntsToLocalOrigin",void 0);class On extends en{}U([ji(Ir)],On.prototype,"size",void 0),U([ji(Tr)],On.prototype,"texture",void 0);class Vn extends Fn{}function Rn(t,e){const r=Ei(new Ir(1),new Ir(1/p),new Ir(on(e.bitset,6),on(e.bitset,5))),i=t.view.requiredZoomFactor,n=new Ir(e.width,e.height).multiply(r),s=n.multiply(e.scale).multiply(i),o=e.angle.multiply(de),a=Di(o),c=wi(o),u=function(t,e,r,i,n){const s=pi(on(n,2),jr(1)),o=un(new Mr(t,0));return ni(s,qr(i.divide(e.x),r.divide(e.y),0,ri(r.divide(e.x)),i.divide(e.y),0,nn(Xr(o,0)),nn(Xr(0,o)),1),qr(i.divide(e.x),r.divide(e.y),0,ri(r.divide(e.x)),i.divide(e.y),0,0,0,1))}(e.id,s,a,c,e.bitset),l=t.localTileOffset.getPatternOffsetAtTileOrigin(n,a,c),h=i.multiply(e.scale).multiply(e.offset.subtract(l)).divide(s),d=new kr(e.pos,1),f=u.multiply(d).xy.subtract(h),y=e.tlbr.divide(t.mosaicInfo.size.xyxy);let m=on(e.bitset,4);return null!=t.visualVariableColor&&(m=ni(sn(t.storage.getColorValue(e.id)),new Pr(0),m)),{tileTextureCoord:f,tlbr:y,sampleAlphaOnly:m}}function $n(t,e){const r=zi(e.tileTextureCoord,new Pr(1)),i=Ei(e.tlbr.xy,e.tlbr.zw,r);let n=Ci(t.mosaicInfo.texture,i);return n=ni(fi(e.sampleAlphaOnly,new Pr(.5)),n.aaaa,n),e.color.multiply(n)}U([Yi(5,Mr)],Vn.prototype,"tlbr",void 0),U([Yi(6,Pr)],Vn.prototype,"width",void 0),U([Yi(7,Pr)],Vn.prototype,"height",void 0),U([Yi(8,Ir)],Vn.prototype,"offset",void 0),U([Yi(9,Ir)],Vn.prototype,"scale",void 0),U([Yi(10,Pr)],Vn.prototype,"angle",void 0);class Ln extends Bn{vertex(t,e){return{...super.vertex(t,e),...Rn(this,t)}}fragment(t){const e=$n(this,t);return this.getFragmentOutput(e,t,new Pr(0))}}U([ji(On)],Ln.prototype,"mosaicInfo",void 0),U([ji(Cn)],Ln.prototype,"localTileOffset",void 0),U([G(0,Hi(Vn)),G(1,Hi(mn))],Ln.prototype,"vertex",null),U([G(0,Hi(class extends gn{}))],Ln.prototype,"fragment",null);class Un extends en{getSize(t,e){const r=this.minMaxValueAndSize.xy,i=this.minMaxValueAndSize.zw;return ni(sn(t),e,(()=>{const e=bi(t.subtract(r.x).divide(r.y.subtract(r.x)),new Pr(0),new Pr(1));return i.x.add(e.multiply(i.y.subtract(i.x)))}))}}U([ji(Mr)],Un.prototype,"minMaxValueAndSize",void 0);class Gn extends en{getSizeForViewScale(t){return si([di(t,this.values.first()),this.sizes.first()],[yi(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>fi(e,t))),r=this.values.get(e),i=e.subtract(1),n=this.values.get(i),s=t.subtract(n).divide(r.subtract(n));return Ei(this.sizes.get(i),this.sizes.get(e),s)}])}}U([ji(Sr.ofType(Pr,8))],Gn.prototype,"sizes",void 0),U([ji(Sr.ofType(Pr,8))],Gn.prototype,"values",void 0);class An extends en{getSize(t,e){const r=si([sn(t),e],[di(t,this.values.first()),this.sizes.first()],[yi(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex((e=>fi(e,t))),r=this.values.get(e),i=e.subtract(1),n=this.values.get(i),s=t.subtract(n).divide(r.subtract(n));return Ei(this.sizes.get(i),this.sizes.get(e),s)}]);return ni(sn(r),e,r)}}U([ji(Sr.ofType(Pr,8))],An.prototype,"sizes",void 0),U([ji(Sr.ofType(Pr,8))],An.prototype,"values",void 0);class Wn extends en{getSize(t,e){return ni(sn(t),e,t.multiply(this.unitValueToPixelsRatio))}}U([ji(Pr)],Wn.prototype,"unitValueToPixelsRatio",void 0);class Yn extends yn{}U([Yi(3,Mr)],Yn.prototype,"color",void 0),U([Yi(4,Ir)],Yn.prototype,"offset",void 0),U([Yi(5,Ir)],Yn.prototype,"normal",void 0),U([Yi(6,Pr)],Yn.prototype,"halfWidth",void 0),U([Yi(7,Pr)],Yn.prototype,"referenceHalfWidth",void 0),U([Yi(8,Ir)],Yn.prototype,"zoomRange",void 0);class Hn extends gn{}class jn extends en{}function Xn(t){return Mi(new Pr(ye).multiply(Bi(t,new Pr(me))),new Pr(1))}function Zn(t,e){const{halfWidth:r,normal:i}=t,n=Xn(r),s=ki(i).multiply(r);return bi(n.multiply(r.subtract(s)).divide(e.add(n).subtract(new Pr(1))),new Pr(0),new Pr(1))}function qn(t,e){const{id:r,offset:i,pos:n,normal:s,zoomRange:o}=e,{displayViewScreenMat3:a,displayViewMat3:c}=t.view,u=En(t,r,e.color),l=zn(t,r),h=function(t,e){const{id:r,halfWidth:i,referenceHalfWidth:n}=e;if(Mn(t)){const e=Nn(t,r,new Pr(2).multiply(n));return new Pr(.5).multiply(i.divide(Mi(n,new Pr(_e)))).multiply(e)}return i}(t,e),p=new Pr(.5).multiply(t.antialiasingControls.antialiasing),d=Mi(h.add(p),new Pr(.45)).add(new Pr(.1).multiply(p)),f=Xn(d).multiply(d).multiply(i),y=c.multiply(new kr(f,new Pr(0))),m=a.multiply(new kr(n,new Pr(1))).add(y),g=new Pr(2).multiply(Bi(h,new Pr(0))).add(t.clip(r,o)),x=new Mr(m.xy,g,1);return{color:u,opacity:l,halfWidth:d,normal:s,scaledOffset:f,scaledHalfWidth:h,glPosition:new Mr(x.xy,g,1)}}function Kn(t,e){const{opacity:r,color:i}=t,n=Zn(t,e);return r.multiply(i).multiply(n)}U([ji(Pr)],jn.prototype,"antialiasing",void 0),U([ji(Pr)],jn.prototype,"blur",void 0);class Qn extends xn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const r=qn(this,t);return{...r,...this.maybeRunHittest(t,e,r.halfWidth)}}fragment(t){const e=Kn(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,r){const{viewMat3:i,tileMat3:n}=this.view,s=i.multiply(n),o=s.multiply(new kr(t.pos,1)),a=s.multiply(new kr(e.nextPos1,1)),c=s.multiply(new kr(e.nextPos2,1)),u=this.hittestRequest.position;return Ni(_n(u,o.xy,a.xy),_n(u,o.xy,c.xy)).subtract(r)}}U([ji(jn)],Qn.prototype,"antialiasingControls",void 0),U([Xi(In)],Qn.prototype,"visualVariableColor",void 0),U([Xi(kn)],Qn.prototype,"visualVariableOpacity",void 0),U([Xi(Un)],Qn.prototype,"visualVariableSizeMinMaxValue",void 0),U([Xi(Gn)],Qn.prototype,"visualVariableSizeScaleStops",void 0),U([Xi(An)],Qn.prototype,"visualVariableSizeStops",void 0),U([Xi(Wn)],Qn.prototype,"visualVariableSizeUnitValue",void 0),U([G(0,Hi(Yn)),G(1,Hi(mn))],Qn.prototype,"vertex",null),U([G(0,Hi(Hn))],Qn.prototype,"fragment",null);class Jn extends yn{}U([Yi(3,Ir)],Jn.prototype,"offset",void 0),U([Yi(4,Mr)],Jn.prototype,"color",void 0),U([Yi(5,Ir)],Jn.prototype,"normal",void 0),U([Yi(6,Pr)],Jn.prototype,"halfWidth",void 0),U([Yi(7,Pr)],Jn.prototype,"referenceHalfWidth",void 0),U([Yi(8,Ir)],Jn.prototype,"zoomRange",void 0);class ts extends Hn{}function es(t,e,r){const{id:i,bitset:n}=e,s=on(n,0),o=fi(s,new Pr(.5)),a=qn(t,e),c=ni(o,a.halfWidth,new Pr(0)),u=zn(t,i),l=En(t,i,e.color),h=ni(o,e.color,l.multiply(u)),p=t.view.displayViewScreenMat3.multiply(new kr(e.pos.xy,1)),d=t.clip(e.id),f=new Mr(p.xy,d,1),y=ni(o,a.glPosition,f),m=r&&t.maybeRunHittest(e,r,o);return{isOutline:s,color:h,opacity:new Pr(1),halfWidth:c,normal:a.normal,glPosition:y,...m}}class rs extends xn{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}U([ji(jn)],rs.prototype,"antialiasingControls",void 0),U([Xi(In)],rs.prototype,"visualVariableColor",void 0),U([Xi(kn)],rs.prototype,"visualVariableOpacity",void 0),U([Xi(Un)],rs.prototype,"visualVariableSizeMinMaxValue",void 0),U([Xi(Gn)],rs.prototype,"visualVariableSizeScaleStops",void 0),U([Xi(An)],rs.prototype,"visualVariableSizeStops",void 0),U([Xi(Wn)],rs.prototype,"visualVariableSizeUnitValue",void 0);class is extends rs{vertex(t,e){return es(this,t,e)}fragment(t){const{color:e,isOutline:r}=t,i=fi(r,new Pr(.5)),n=ni(i,Kn(t,this.antialiasingControls.blur),e),s=ni(i,new Pr(1/255),new Pr(0));return this.getFragmentOutput(n,t,s)}hittest(t,e,r){return ni(r,Sn(this.hittestRequest),Tn(this,t,e))}}U([G(0,Hi(Jn)),G(1,Hi(mn))],is.prototype,"vertex",null),U([G(0,Hi(ts))],is.prototype,"fragment",null);class ns extends Fn{}function ss(t,e){const r=e.tlbr.xy,i=e.tlbr.zw,n=i.x.subtract(r.x),s=r.y.subtract(i.y),o=new Ir(n,s).multiply(e.inverseRasterizationScale),a=o.multiply(t.view.requiredZoomFactor),c=function(t){const e=new Pr(1),r=new Pr(0);return new Ar(e.divide(t.x),r.divide(t.y),0,ri(r.divide(t.x)),e.divide(t.y),0,0,0,1)}(a),u=t.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new kr(e.pos,1);return{tileTextureCoord:c.multiply(l).xy.subtract(u),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function os(t,e){const r=zi(t.tileTextureCoord,new Pr(1)),i=Ei(t.tlbr.xy,t.tlbr.zw,r),n=Ci(e.texture,i);return t.color.multiply(n)}U([Yi(5,Mr)],ns.prototype,"tlbr",void 0),U([Yi(6,Pr)],ns.prototype,"inverseRasterizationScale",void 0);class as extends Bn{vertex(t,e){return{...super.vertex(t,e),...ss(this,t)}}fragment(t){const e=os(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new Pr(0))}}U([ji(On)],as.prototype,"mosaicInfo",void 0),U([ji(Cn)],as.prototype,"localTileOffset",void 0),U([G(0,Hi(ns)),G(1,Hi(mn))],as.prototype,"vertex",null),U([G(0,Hi(class extends gn{}))],as.prototype,"fragment",null);class cs extends Jn{}U([Yi(9,Mr)],cs.prototype,"tlbr",void 0),U([Yi(10,Pr)],cs.prototype,"inverseRasterizationScale",void 0);class us extends ts{}class ls extends is{vertex(t,e){return{...es(this,t,e),...ss(this,t)}}fragment(t){const{isOutline:e}=t,r=fi(e,new Pr(.5)),i=ni(r,Kn(t,this.antialiasingControls.blur),os(t,this.mosaicInfo)),n=ni(r,new Pr(1/255),new Pr(0));return this.getFragmentOutput(i,t,n)}}U([ji(On)],ls.prototype,"mosaicInfo",void 0),U([ji(Cn)],ls.prototype,"localTileOffset",void 0),U([G(0,Hi(cs)),G(1,Hi(mn))],ls.prototype,"vertex",null),U([G(0,Hi(us))],ls.prototype,"fragment",null);const hs=16,ps=.0625;class ds extends yn{}U([Yi(3,Mr)],ds.prototype,"color",void 0),U([Yi(4,Mr)],ds.prototype,"tlbr",void 0),U([Yi(5,Pr)],ds.prototype,"angle",void 0),U([Yi(6,Pr)],ds.prototype,"aux1",void 0),U([Yi(7,Pr)],ds.prototype,"aux2",void 0),U([Yi(8,Ir)],ds.prototype,"aux3",void 0),U([Yi(9,Ir)],ds.prototype,"aux4",void 0),U([Yi(10,Ir)],ds.prototype,"zoomRange",void 0);class fs extends rs{vertex(t,e){const{aux1:r,aux2:i,aux3:n,aux4:s}=t,o={...t,width:r,height:i,offset:n,scale:s.multiply(ps)},a=es(this,{...t,halfWidth:r.multiply(ps),referenceHalfWidth:i.multiply(ps),offset:n.multiply(ps),normal:s.subtract(128).multiply(ps)}),c=Rn(this,o),u=fi(a.isOutline,new Pr(.5));return{...a,...c,...this.maybeRunHittest(t,e,u)}}fragment(t){const{isOutline:e}=t,r=fi(e,new Pr(.5)),i=ni(r,Kn(t,this.antialiasingControls.blur),$n(this,t)),n=ni(r,new Pr(1/255),new Pr(0));return this.getFragmentOutput(i,t,n)}hittest(t,e,r){return ni(r,Sn(this.hittestRequest),Tn(this,t,e))}}U([ji(On)],fs.prototype,"mosaicInfo",void 0),U([ji(Cn)],fs.prototype,"localTileOffset",void 0),U([G(0,Hi(ds)),G(1,Hi(mn))],fs.prototype,"vertex",null),U([G(0,Hi(class extends us{}))],fs.prototype,"fragment",null);const ys=ze.attributes,ms=Ve.attributes,gs={createComputedParams:t=>t,attributes:{id:ys.id,pos:ys.pos,zoomRange:ys.zoomRange,tlbr:ys.tlbr,angle:ys.angle,color:ys.color,bitset:{type:N.UNSIGNED_BYTE,count:1,pack:t=>Me(t)},aux1:{count:1,type:N.UNSIGNED_SHORT,pack:t=>Ne(t)},aux2:{count:1,type:N.UNSIGNED_SHORT,pack:t=>Ee(t)},aux3:{count:2,type:N.SHORT,pack:({offsetX:t,offsetY:e})=>[E(t),E(e)]},aux4:{count:2,type:N.UNSIGNED_BYTE,pack:({scaleX:t,scaleY:e})=>[t*hs,e*hs]}}},xs={createComputedParams:t=>t,attributes:{id:ys.id,pos:ys.pos,zoomRange:ys.zoomRange,tlbr:ys.tlbr,angle:ys.angle,color:ms.color,bitset:{type:N.UNSIGNED_BYTE,count:1,pack:t=>re([[0,!0]])},aux1:{count:1,type:N.UNSIGNED_SHORT,pack:t=>E(.5*t.width)*hs},aux2:{count:1,type:N.UNSIGNED_SHORT,pack:t=>E(.5*t.referenceWidth)*hs},aux3:{count:2,type:N.SHORT,packTessellation:({extrusionOffsetX:t,extrusionOffsetY:e})=>[t*hs,e*hs]},aux4:{count:2,type:N.UNSIGNED_BYTE,packTessellation:({normalX:t,normalY:e})=>[t*hs+128,e*hs+128]}}};class _s extends Re{constructor(){super(...arguments),this.vertexSpec=xs}}const vs={createComputedParams:t=>t,attributes:{...ue.attributes,...Oe.attributes}},bs={createComputedParams:t=>t,attributes:{...ue.attributes,...Ve.attributes}};class ws extends Re{constructor(){super(...arguments),this.vertexSpec=bs}}const Ss={createComputedParams:t=>t,attributes:{pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1},offset:{type:N.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}},Ts=8388607,Ps=t=>t&Ts;function Is(t,e){return((e?8388608:0)|t)>>>0}function ks(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Ms(t,e){return Math.sqrt(t*t+e*e)}function Ns(t){const e=Ms(t[0],t[1]);t[0]/=e,t[1]/=e}function Es(t){return t.length-1}function zs(t,e,r=1){const[i,n]=function(t,e){return t[e+1]}(t,e);return Math.sqrt(i*i+n*n)*r}class Ds{constructor(t,e,r,i,n){this._segments=t,this._index=e,this._distance=r,this._xStart=i,this._yStart=n,this._done=!1}static create(t){return new Ds(t,0,0,t[0][0],t[0][1])}clone(){return new Ds(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let r=Math.acos(e);return t>0&&(r=2*Math.PI-r),r}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Es(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const r=this.backwardLength;if(t<=r)return this._distance=(r-t)/this.length,this;let i=this.backwardLength;for(;this.prev();){if(i+this.length>t)return this._seekBackwards(t-i);i+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let r=this.remainingLength;for(;this.next();){if(r+this.length>t)return this.seek(t-r,e);r+=this.length}return this._distance=1,e?this:null}}function Fs(t,e,r,i=!0){const n=function(t){let e=0;for(let r=0;r<Es(t);r++)e+=zs(t,r);return e}(t),s=Ds.create(t),o=n/2;if(!i)return s.seek(o),void r(s.clone(),0,o+0*e,n);const a=Math.max((n-e)/2,0),c=Math.floor(a/e),u=o-c*e;s.seek(u);for(let t=-c;t<=c;t++)s.x<512&&s.x>=0&&s.y<512&&s.y>=0&&r(s.clone(),t,o+t*e,n),s.seek(e)}function Bs(t,e){const r=1e-6;if(e<=0)return;const i=t.length;if(i<3)return;const n=[];let s=0;n.push(0);for(let e=1;e<i;e++)s+=(o=t[e],a=t[e-1],Ms(o[0]-a[0],o[1]-a[1])),n.push(s);var o,a;e=Math.min(e,.2*s);const c=[];c.push(t[0][0]),c.push(t[0][1]);const u=t[i-1][0],l=t[i-1][1],h=ks([0,0],t[0],t[1]);Ns(h),t[0][0]+=e*h[0],t[0][1]+=e*h[1],ks(h,t[i-1],t[i-2]),Ns(h),t[i-1][0]+=e*h[0],t[i-1][1]+=e*h[1];for(let t=1;t<i;t++)n[t]+=e;n[i-1]+=e;const p=.5*e;for(let s=1;s<i-1;s++){let o=0,a=0,u=0;for(let i=s-1;i>=0&&!(n[i+1]<n[s]-p);i--){const c=p+n[i+1]-n[s],l=n[i+1]-n[i],h=n[s]-n[i]<p?1:c/l;if(Math.abs(h)<r)break;const d=h*h,f=h*c-.5*d*l,y=h*l/e,m=t[i+1],g=t[i][0]-m[0],x=t[i][1]-m[1];o+=y/f*(m[0]*h*c+.5*d*(c*g-l*m[0])-d*h*l*g/3),a+=y/f*(m[1]*h*c+.5*d*(c*x-l*m[1])-d*h*l*x/3),u+=y}for(let c=s+1;c<i&&!(n[c-1]>n[s]+p);c++){const i=p-n[c-1]+n[s],l=n[c]-n[c-1],h=n[c]-n[s]<p?1:i/l;if(Math.abs(h)<r)break;const d=h*h,f=h*i-.5*d*l,y=h*l/e,m=t[c-1],g=t[c][0]-m[0],x=t[c][1]-m[1];o+=y/f*(m[0]*h*i+.5*d*(i*g-l*m[0])-d*h*l*g/3),a+=y/f*(m[1]*h*i+.5*d*(i*x-l*m[1])-d*h*l*x/3),u+=y}c.push(o/u),c.push(a/u)}c.push(u),c.push(l);for(let e=0,r=0;e<i;e++)t[e][0]=c[r++],t[e][1]=c[r++]}class Cs{static getPlacement(t,e,r,i,n,s){const o=w(r);return o?(-1===e&&t.invertY(),o.execute(t,r,i,n,s)):null}}class Os{constructor(t){const{offsetX:e,offsetY:r,postAngle:i,fontSize:n,transforms:s}=t;if(this.offsetX=e,this.offsetY=r,this.postAngle=i,this.fontSize=n,this.transforms=s,s&&s.infos.length>1){const t=st(n,i,!1,e,r,s);this.fontSize=t.size,this.postAngle=t.rotation,this.offsetX=t.offsetX,this.offsetY=t.offsetY}}}const Vs=[4,4],Rs=[16,4],$s={topLeft:Rs,topRight:Rs,bottomLeft:Rs,bottomRight:Rs},Ls=[4,2],Us=[4,6],Gs={topLeft:Ls,topRight:Ls,bottomLeft:Us,bottomRight:Us},As={topLeft:Ls,topRight:Us,bottomLeft:Ls,bottomRight:Us},Ws={topLeft:Us,topRight:Us,bottomLeft:Vs,bottomRight:Vs},Ys={topLeft:Vs,topRight:Vs,bottomLeft:Us,bottomRight:Us},Hs={topLeft:Us,topRight:Vs,bottomLeft:Us,bottomRight:Vs},js={topLeft:Vs,topRight:Us,bottomLeft:Vs,bottomRight:Us},Xs={createComputedParams:t=>t,attributes:{pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:t,mapAligned:e,isLineLabel:r})=>re([[0,t],[3,!!e],[4,!!r]])},zoomRange:{type:N.UNSIGNED_BYTE,count:2,packPrecisionFactor:u,packTessellation:({minZoom:t,maxZoom:e})=>[t||0,e||100]},offset:{type:N.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:t})=>{const{bottomLeft:e,bottomRight:r,topLeft:i,topRight:n}=t;return[i,n,e,r]}}},textureUV:{type:N.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:t})=>{const{bottomLeft:e,bottomRight:r,topLeft:i,topRight:n}=t;return[i,n,e,r]}}},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:t})=>t},fontSize:{type:N.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:t})=>E(t)},referenceSize:{type:N.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:t},{referenceSize:e})=>E(e??t)},haloColor:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:t})=>ie(t)},haloFontSize:{type:N.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:t})=>E(t)},clipAngle:{type:N.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:t})=>qs(t||0)},referenceSymbol:{type:N.BYTE,count:4,packPrecisionFactor:1,packTessellation:(t,e)=>{if(!t.referenceBounds)return[0,0,0,0];const r=J(e.horizontalAlignment),i=tt(e.verticalAlignment),{offsetX:n,offsetY:s,size:o}=t.referenceBounds;return[E(n),-E(s),E(o),r+1<<2|i+1]}}}};class Zs extends qt{constructor(){super(...arguments),this.vertexSpec=Xs,this._textMeshParamsPropsInitialized=!1,this.enablePixelBuffering=!0}ensurePacked(t,e,r){super.ensurePacked(t,e,r),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new Os(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,e,r){const i=this._getShaping();if(!i)return;const n=e.getDisplayId();if(null!=this.evaluatedMeshParams.placement)return this._writePlacedTextMarkers(t,e,i,r);if(r&&r.nextPath())return r.nextPoint(),this._writeGlyphs(t,n,r.x,r.y,i,0);if("esriGeometryPolygon"===e.geometryType){const r=e.readCentroidForDisplay();if(!r)return;const[s,o]=r.coords;return this._writeGlyphs(t,n,s,o,i,0)}if("esriGeometryMultipoint"===e.geometryType){const r=e.readGeometryForDisplay();return void r?.forEachVertex(((e,r)=>this._writeGlyphs(t,n,e,r,i,0)))}const s=e.readXForDisplay(),o=e.readYForDisplay();return this._writeGlyphs(t,n,s,o,i,0)}_writePlacedTextMarkers(t,e,r,i){const n=i??b.fromFeatureSetReaderCIM(e);if(!n)return;const s=Cs.getPlacement(n,-1,this.evaluatedMeshParams.placement,E(1),t.id,Ht());if(!s)return;const o=e.getDisplayId();let a=s.next();for(;null!=a;){const e=a.tx,i=-a.ty,n=-a.getAngle();this._writeGlyphs(t,o,e,i,r,n),a=s.next()}}_getShaping(){const t=this._textMeshTransformProps,e=this.evaluatedMeshParams;if(!e.glyphs?.glyphs.length)return null;const r=Math.round(E(t.fontSize)),i=E(t.offsetX),n=E(t.offsetY),s=nt(E(e.lineWidth),32,512),o=y*nt(e.lineHeightRatio,.25,4);return et(e.glyphs,{scale:r/m,angle:t.postAngle,xOffset:i,yOffset:n,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,maxLineWidth:s,lineHeight:o,decoration:e.decoration,borderLineSizePx:E(e.boxBorderLineSize),hasBackground:!!e.boxBackgroundColor,useCIMAngleBehavior:e.useCIMAngleBehavior})}_writeGlyphs(t,e,r,i,n,s,o){const a=this.evaluatedMeshParams,c=this._textMeshTransformProps,u=c.fontSize,l=E(c.offsetX),h=E(c.offsetY);0!==s&&n.setRotation(s);const p=n.bounds,d=r+p.x+l,f=i+p.y-h,y=2*(a.minPixelBuffer?a.minPixelBuffer/u:1),m=Math.max(p.width,p.height)*y;n.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,n.glyphs[0].textureBinding),this.enablePixelBuffering&&t.recordBounds(d,f,m,m),this._writeTextBox(t,e,r,i,n.textBox,o),t.recordEnd());for(const s of n.glyphs){t.recordStart(this.instanceId,this.attributeLayout,s.textureBinding),this.enablePixelBuffering&&t.recordBounds(d,f,m,m);const{texcoords:n,offsets:c}=s;this._writeQuad(t,e,r,i,{texcoords:n,offsets:c,fontSize:u,color:ie(a.color),isBackground:!1,referenceBounds:o}),t.recordEnd()}0!==s&&n.setRotation(-s)}_writeTextBox(t,e,r,i,n,s,o){const a=this.evaluatedMeshParams,{fontSize:c}=this._textMeshTransformProps,{boxBackgroundColor:u,boxBorderLineColor:l}=a,h={isBackground:!0,fontSize:c,referenceBounds:s,...o};u&&(this._writeQuad(t,e,r,i,{texcoords:$s,offsets:n.main,color:ie(u),...h}),l||(this._writeQuad(t,e,r,i,{texcoords:Ws,offsets:n.top,color:ie(u),...h}),this._writeQuad(t,e,r,i,{texcoords:Ys,offsets:n.bot,color:ie(u),...h}),this._writeQuad(t,e,r,i,{texcoords:Hs,offsets:n.left,color:ie(u),...h}),this._writeQuad(t,e,r,i,{texcoords:js,offsets:n.right,color:ie(u),...h}))),l&&(this._writeQuad(t,e,r,i,{texcoords:Gs,offsets:n.top,color:ie(l),...h}),this._writeQuad(t,e,r,i,{texcoords:Gs,offsets:n.bot,color:ie(l),...h}),this._writeQuad(t,e,r,i,{texcoords:As,offsets:n.left,color:ie(l),...h}),this._writeQuad(t,e,r,i,{texcoords:As,offsets:n.right,color:ie(l),...h}))}_writeQuad(t,e,r,i,n){const s=t.vertexCount();this._writeVertex(t,e,r,i,n),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}}const qs=t=>Math.round(t*(254/360)),Ks=j((t=>{let e=0;if(0===t)return 1/0;for(;!(t%2);)e++,t/=2;return e})),Qs={createComputedParams:t=>t,attributes:{...Fe.attributes,bitset:{type:N.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:t,shouldScaleDash:e,isSDF:r})=>re([[4,t],[2,e],[3,r]])},tlbr:{type:N.UNSIGNED_SHORT,count:4,pack:({sprite:t})=>{const{rect:e,width:r,height:i}=t,n=e.x+l,s=e.y+l;return[n,s,n+r,s+i]}},accumulatedDistance:{type:N.UNSIGNED_SHORT,count:1,packTessellation:({distance:t})=>t},segmentDirection:{type:N.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:t,directionY:e})=>[t,e]}}};class Js{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){const e=new Js(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:r,width:i,height:n,angle:s,outlineSize:o,referenceSize:a,sprite:c,overrideOutlineColor:u}=t;return e.rawWidth=E(i),e.rawHeight=E(n),e.angle=s,e.outlineSize=E(o),e.referenceSize=E(a),e.overrideOutlineColor=u,e.offsetX=E(t.offsetX),e.offsetY=E(t.offsetY),"simple"!==r||c.sdf||(e.rawWidth=c.width,e.rawHeight=c.height),e.sizeRatio=c.sdf?2:1,e._computeSize(t,!1),e}static fromComplexMeshParams(t){const e=new Js(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects);let{alignment:r,transforms:i,size:n,scaleX:s,anchorX:o,anchorY:a,angle:c,colorLocked:u,frameHeight:l,offsetX:h,offsetY:p,outlineSize:d,referenceSize:f,scaleFactor:y,sizeRatio:m,isAbsoluteAnchorPoint:g,rotateClockwise:x,scaleSymbolsProportionally:_,sprite:v}=t;if(i&&i.infos.length>0){const t=st(n,c,x,h,p,i);n=t.size,c=t.rotation,h=t.offsetX,p=t.offsetY,x=!1}y&&(n*=y,h*=y,p*=y),e.alignment=r,e.rawHeight=E(n),e.rawWidth=e.rawHeight*s*(v.width/v.height),e.referenceSize=E(f),e.sizeRatio=m,e.angle=c,e.rotateClockwise=x,e.anchorX=o,e.anchorY=a,e.offsetX=E(h),e.offsetY=E(p),g&&n&&(e.anchorX=o/n,e.anchorY=a/n);const b=_&&l?n/l:1;return e.outlineSize=0===d||isNaN(d)?0:Math.max(E(d)*b,.75),e.scaleSymbolsProportionally=_,e.colorLocked=u,e._computeSize(t,!0),e}constructor(t,e,r,i,n,s,o){this.sprite=t,this.color=e,this.outlineColor=r,this.minPixelBuffer=i,this.placement=n,this.scaleInfo=s,this.effects=o,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=$.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,e){const{sprite:r,hasSizeVV:i}=t,n=!!r.sdf,{rawWidth:s,rawHeight:o,sizeRatio:a,outlineSize:c}=this,u=s*a,h=o*a;if(n&&!i){const t=e&&s>o?u:s,r=o,i=c+2;this.computedWidth=Math.min(t+i,u),this.computedHeight=Math.min(r+i,h)}else this.computedWidth=u,this.computedHeight=h;const p=n?g/Math.max(u,h):1,d=.5*(u-this.computedWidth)*p,f=.5*(h-this.computedHeight)*p,y=r.rect.x+l+d,m=r.rect.y+l+f,x=y+r.width-2*d,_=m+r.height-2*f;this.texXmin=Math.floor(y),this.texYmin=Math.floor(m),this.texXmax=Math.ceil(x),this.texYmax=Math.ceil(_),this.computedWidth*=(this.texXmax-this.texXmin)/(x-y),this.computedHeight*=(this.texYmax-this.texYmin)/(_-m),this.anchorX*=u/this.computedWidth,this.anchorY*=h/this.computedHeight}}const to={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4}},eo=3.14159265359/180,ro=128/Math.PI,io={createComputedParams:t=>Js.from(t),attributes:{pos:{type:N.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1,pack:({sprite:t,alignment:e,scaleSymbolsProportionally:r,overrideOutlineColor:i,colorLocked:n})=>{let s=0;return t.sdf&&(s|=ee(to.bitset.isSDF)),e===$.MAP&&(s|=ee(to.bitset.isMapAligned)),r&&(s|=ee(to.bitset.scaleSymbolsProportionally)),i&&(s|=ee(to.bitset.overrideOutlineColor)),n&&(s|=ee(to.bitset.colorLocked)),s}},zoomRange:{type:N.SHORT,count:2,packPrecisionFactor:u,pack:({scaleInfo:t},{tileInfo:e})=>te(t,e)},offset:{type:N.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:t,computedWidth:e,computedHeight:r,anchorX:i,anchorY:n,offsetX:s,offsetY:o,rotateClockwise:a})=>{const c=function(t,e,r,i,n=!1){const s=Q(),o=n?1:-1;return t?X(s,o*eo*t):Z(s),(e||r)&&q(s,s,[e,-r]),i&&K(s,s,o*eo*-i),s}(0,s,o,-t,a),u=-(.5+i)*e,l=-(.5-n)*r,h=[u,l],p=[u+e,l],d=[u,l+r],f=[u+e,l+r];return ot(h,h,c),ot(p,p,c),ot(d,d,c),ot(f,f,c),[h,p,d,f]}}},textureUV:{type:N.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:t,texXmin:e,texYmax:r,texYmin:i})=>[[e,i],[t,i],[e,r],[t,r]]}},color:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:t})=>ie(t)},outlineColor:{type:N.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:t})=>ie(t)},sizing:{type:N.UNSIGNED_BYTE,count:4,pack:({rawWidth:t,rawHeight:e,outlineSize:r,referenceSize:i})=>[ne(Math.max(t,e),128),ne(r,128),ne(i,128),0]},placementAngle:{type:N.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:t})=>{return e=t*ro,e%=256,Math.abs(e>=0?e:e+256);var e}},sizeRatio:{type:N.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sizeRatio:t})=>t}}},no={createComputedParams:t=>t,attributes:{pos:{type:N.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:N.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:N.UNSIGNED_BYTE,count:1,pack:t=>0},offset:{type:N.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:t,outlineWidth:e})=>{const r=Math.round(E(t+2*e)),i=-r/2,n=-r/2;return[[i,n],[i+r,n],[i,n+r],[i+r,n+r]]}}},texCoords:{type:N.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:N.UNSIGNED_BYTE,count:2,pack:({size:t})=>[t,t]},referenceSize:{type:N.UNSIGNED_BYTE,count:1,pack:({size:t})=>E(t)},zoomRange:{type:N.UNSIGNED_BYTE,count:2,pack:({scaleInfo:t},{tileInfo:e})=>te(t,e)}}},so=function(t){const e={};for(const r in t){const i={name:r,constructor:t[r]};e[r]=i}return e}({FillMeshWriter:ce,DotDensityMeshWriter:class extends Qt{constructor(){super(...arguments),this.vertexSpec=Jt}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}},ComplexFillMeshWriter:class extends le{constructor(){super(...arguments),this.vertexSpec=ze}},PatternFillMeshWriter:le,OutlineFillMeshWriter:$e,PatternOutlineFillMeshWriter:class extends $e{constructor(){super(...arguments),this.vertexSpec=vs}_createOutlineWriter(t,e,r,i){return new ws(t,e,r,i)}_write(t,e,r){const i=r?.asOptimized()??e.readGeometryForDisplay(),n=this._clip(i);if(!n)return;const s=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,s),this._writeGeometry(t,e,n),this._lineMeshWriter.writeLineVertices(t,b.fromOptimizedCIM(n,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,r){super.ensurePacked(t,e,r),this._lineMeshWriter.ensurePacked(t,e,r)}enqueueRequest(t,e,r){super.enqueueRequest(t,e,r),this._lineMeshWriter.enqueueRequest(t,e,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}},ComplexOutlineFillMeshWriter:class extends $e{constructor(){super(...arguments),this.vertexSpec=gs}_createOutlineWriter(t,e,r,i){return new _s(t,e,r,i)}_write(t,e,r){const i=r?.asOptimized()??e.readGeometryForDisplay(),n=this._clip(i);if(!n)return;const s=this.evaluatedMeshParams.sprite?.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,s),this._writeGeometry(t,e,n),this._lineMeshWriter.writeLineVertices(t,b.fromOptimizedCIM(n,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,r){super.ensurePacked(t,e,r),this._lineMeshWriter.ensurePacked(t,e,r)}enqueueRequest(t,e,r){super.enqueueRequest(t,e,r),this._lineMeshWriter.enqueueRequest(t,e,r)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}},MarkerMeshWriter:class extends qt{constructor(){super(...arguments),this.vertexSpec=io}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,e,r){const i=this.evaluatedMeshParams.sprite?.textureBinding,n=e.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,i);const s=this.evaluatedMeshParams.minPixelBuffer,o=Math.max(this.evaluatedMeshParams.computedWidth,s),a=Math.max(this.evaluatedMeshParams.computedHeight,s);if(null!=this.evaluatedMeshParams.placement)this._writePlacedMarkers(t,e,r,o,a);else if(r&&r.nextPath()){r.nextPoint();const e=r.x,i=r.y;t.recordBounds(e,i,o,a),this._writeQuad(t,n,e,i)}else if("esriGeometryPolygon"===e.geometryType){const r=e.readCentroidForDisplay();if(!r)return;const[i,s]=r.coords;t.recordBounds(i,s,o,a),this._writeQuad(t,n,i,s)}else if("esriGeometryPoint"===e.geometryType){const r=e.readXForDisplay(),i=e.readYForDisplay();t.recordBounds(r,i,o,a),this._writeQuad(t,n,r,i)}else{const r=e.readGeometryForDisplay();r?.forEachVertex(((e,r)=>{t.recordBounds(e,r,o,a),this._writeQuad(t,n,e,r)}))}t.recordEnd()}_writePlacedMarkers(t,e,r,i,n){const s=r??b.fromFeatureSetReaderCIM(e)?.clone();if(!s)return;const o=Cs.getPlacement(s,-1,this.evaluatedMeshParams.placement,E(1),t.id,Ht());if(!o)return;const a=e.getDisplayId();let c=o.next();for(;null!=c;){const e=c.tx,r=-c.ty,s=-c.getAngle();t.recordBounds(e,r,i,n),this._writeQuad(t,a,e,r,s),c=o.next()}}_writeQuad(t,e,r,i,n){const s=t.vertexCount(),o=null==n?null:{placementAngle:n};this._writeVertex(t,e,r,i,o),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}},PieChartMeshWriter:class extends qt{constructor(){super(...arguments),this.vertexSpec=no}_write(t,e){const r=e.getDisplayId();let i,n;if("esriGeometryPoint"===e.geometryType)i=e.readXForDisplay(),n=e.readYForDisplay();else{const t=e.readCentroidForDisplay();if(!t)return;i=t?.coords[0],n=t?.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(i,n,this.evaluatedMeshParams.size,this.evaluatedMeshParams.size);const s=t.vertexCount();this._writeVertex(t,r,i,n),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2),t.recordEnd()}},TextMeshWriter:Zs,LineMeshWriter:Ce,TexturedLineMeshWriter:class extends Ce{constructor(t,e,r,i){super(t,e,r,i),this.vertexSpec=Qs,this._tessellationOptions.textured=!0}_write(t,e,r){const i=r??b.fromFeatureSetReaderCIM(e);if(!i)return;const{sprite:n}=this.evaluatedMeshParams;this._writeGeometry(t,e,i,n?.textureBinding)}},HeatmapMeshWriter:class extends qt{constructor(){super(...arguments),this.vertexSpec=Ss}_write(t,e){t.recordStart(this.instanceId,this.attributeLayout);const r=e.getDisplayId();if("esriGeometryPoint"===e.geometryType){const i=e.readXForDisplay(),n=e.readYForDisplay();this._writeQuad(t,r,i,n)}else if("esriGeometryMultipoint"===e.geometryType){const i=e.readGeometryForDisplay();i?.forEachVertex(((e,i)=>{e>=0&&e<=512&&i>=0&&i<=512&&this._writeQuad(t,r,e,i)}))}t.recordEnd()}_writeQuad(t,e,r,i){const n=t.vertexCount();this._writeVertex(t,e,r,i),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}},LabelMeshWriter:class extends Zs{constructor(){super(...arguments),this.enablePixelBuffering=!1,this._zoomLevel=0}_write(t,e,r,i){if(this._zoomLevel=i||0,null!=r)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(e.geometryType){case"esriGeometryPoint":{const r=e.readXForDisplay(),i=e.readYForDisplay();return this._writePoint(t,r,i,e)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const r=e.readCentroidForDisplay();if(!r)return;const[i,n]=r.coords;if(i<0||i>=c||n<0||n>=c)return;return this._writePoint(t,i,n,e)}case"esriGeometryPolyline":{const r=e.readLegacyGeometryForDisplay();this._writeLines(t,e,r)}}}_writePoint(t,e,r,i){const n=this._getShaping();if(!n)return;let s=this._getPointReferenceBounds();s||(s={offsetX:0,offsetY:0,size:0});const o=n.boundsT,a=rt(this.evaluatedMeshParams.horizontalAlignment),c=it(this.evaluatedMeshParams.verticalAlignment),u=this.evaluatedMeshParams.scaleInfo?.maxScale??0,l=this.evaluatedMeshParams.scaleInfo?.maxScale??0,h=Ps(i.getDisplayId());t.metricStart(new M(h,e,r,a,c,u,l,s)),t.metricBoxWrite(o),this._writeGlyphs(t,i.getDisplayId(),e,r,n,0,s),t.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const t of this._references){const e=t.getBoundsInfo();if(e)return e}return null}_writeLines(t,e,r){const{repeatLabel:i,scaleInfo:n}=this.evaluatedMeshParams,s=this.evaluatedMeshParams.repeatLabelDistance||128,o=this._getShaping();if(!o)return;this._current={out:t,id:e.getDisplayId(),shaping:o,zoomRange:te(n,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0}};const a=function(t,e){const r=e;for(let e=0;e<t.length;e++){let i=t[e];Bs(i,r);const n=[];n.push(i[0]);for(let t=1;t<i.length;t++){const[e,r]=i[t-1],[s,o]=i[t],a=Math.round(s-e),c=Math.round(o-r);n.push([a,c])}t[e]=n,i=n}return t}(r.paths,o.bounds.width),c=this._placeSubdivGlyphs.bind(this),u=(o.bounds.width+s)/2;for(const t of a)Fs(t,u,c,!!i)}_placeSubdivGlyphs(t,e,r,i){const{allowOverrun:n,labelPosition:s,repeatLabelDistance:o}=this.evaluatedMeshParams,a=this._current.zoomRange[0],c=Ks(e),u=this._current.shaping.bounds.width/2,l=Math.sqrt(o||128)/2,h=Math.min(r,i-r),p=this._current.shaping.isMultiline?25:Math.log2(h/(l+u/2)),d=0===e?p:Math.min(c,p),f=Math.max(a,this._zoomLevel+1-d),y=this._zoomLevel-f,m=this._current.shaping.bounds.width/2*2**y;this._current.shaping.isMultiline?0===e&&this._placeStraight(t,f):n&&y<0?this._placeStraightAlong(t,a):"parallel"===s?this._placeStraightAlong(t,f):"curved"===s&&this._placeCurved(t,f,m)}_placeStraight(t,e){const{out:r,id:i,shaping:n,zoomRange:s,referenceBounds:o}=this._current,{x:a,y:c}=t,u=t.angle*(180/Math.PI)%360,l=(t.angle*(180/Math.PI)+180)%360;if(n.textBox){const a=Math.max(e,s[0],0),c=Math.min(25,s[1]),h=X(Q(),-t.angle),[p,d]=n.shapeBackground(h),f={minZoom:a,maxZoom:c,clipAngle:u,mapAligned:!0,isLineLabel:!0};r.recordStart(this.instanceId,this.attributeLayout,n.glyphs[0].textureBinding),this._writeTextBox(r,i,t.x,t.y,d,o,f),r.recordEnd(),f.clipAngle=l,r.recordStart(this.instanceId,this.attributeLayout,n.glyphs[0].textureBinding),this._writeTextBox(r,i,t.x,t.y,d,o,f),r.recordEnd()}for(const h of n.glyphs)h.minZoom=e,h.maxZoom=s[1],h.angle=t.angle,this._writeLineGlyph(r,i,a,c,n.bounds,h,u,o,!0),h.angle=t.angle+Math.PI,this._writeLineGlyph(r,i,a,c,n.bounds,h,l,o,!0)}_placeCurved(t,e,r){const i=t.clone(),n=t.angle*(180/Math.PI)%360,s=(t.angle*(180/Math.PI)+180)%360;this._placeFirst(i,e,1,n),this._placeBack(t,i,e,r,1,n),this._placeForward(t,i,e,r,1,n),this._placeFirst(i,e,0,s),this._placeBack(t,i,e,r,0,s),this._placeForward(t,i,e,r,0,s)}_placeStraightAlong(t,e){const{out:r,id:i,shaping:n,zoomRange:s,referenceBounds:o}=this._current,{boxBorderLineColor:a,boxBackgroundColor:c}=this.evaluatedMeshParams,u=t.clone(),l=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;if(n.glyphs.length>0&&(a||c)){const a=Math.max(e,s[0],0),c=Math.min(25,s[1]),u=X(Q(),-t.angle),[p,d]=n.shapeBackground(u),f={minZoom:a,maxZoom:c,clipAngle:l,mapAligned:!0,isLineLabel:!0};r.recordStart(this.instanceId,this.attributeLayout,n.glyphs[0].textureBinding),this._writeTextBox(r,i,t.x,t.y,d,o,f),r.recordEnd(),f.clipAngle=h,r.recordStart(this.instanceId,this.attributeLayout,n.glyphs[0].textureBinding),this._writeTextBox(r,i,t.x,t.y,d,o,f),r.recordEnd()}this._placeFirst(u,e,1,l,!0),this._placeFirst(u,e,0,h,!0)}_placeBack(t,e,r,i,n,s){const o=t.clone();let a=t.backwardLength+0;for(;o.prev()&&!(a>=i);)this._placeOnSegment(o,e,a,r,-1,n,s),a+=o.length+0}_placeForward(t,e,r,i,n,s){const o=t.clone();let a=t.remainingLength+0;for(;o.next()&&!(a>=i);)this._placeOnSegment(o,e,a,r,1,n,s),a+=o.length+0}_placeFirst(t,e,r,i,n=!1){const s=t,{out:o,id:a,shaping:c,zoomRange:u,referenceBounds:l}=this._current,h=c.glyphs;for(const p of h){const h=p.x>c.bounds.x?r:1-r,d=h*t.remainingLength+(1-h)*t.backwardLength,f=Math.abs(p.x+p.width/2-c.bounds.x),y=Math.max(0,this._zoomLevel+Math.log2(f/(d+0))),m=Math.max(e,n?0:y);p.maxZoom=Math.min(u[1],25),p.angle=t.angle+(1-r)*Math.PI,p.minZoom=Math.max(u[0],m),this._writeLineGlyph(o,a,s.x,s.y,c.bounds,p,i,l,!0)}}_placeOnSegment(t,e,r,i,n,s,o){const{out:a,id:c,shaping:u,referenceBounds:l}=this._current,h=u.glyphs,p=t.dx/t.length,d=t.dy/t.length,f={x:t.x+r*-n*p,y:t.y+r*-n*d};for(const e of h){const h=e.x>u.bounds.x?s:1-s;if(!(h&&1===n||!h&&-1===n))continue;const p=Math.abs(e.x+e.width/2-u.bounds.x),d=Math.max(0,this._zoomLevel+Math.log2(p/r)-.1),y=Math.max(i,this._zoomLevel+Math.log2(p/(r+t.length+0)));0!==d&&(e.angle=t.angle+(1-s)*Math.PI,e.minZoom=y,e.maxZoom=d,this._writeLineGlyph(a,c,f.x,f.y,u.bounds,e,o,l,!0))}}_writeLineGlyph(t,e,r,i,n,s,o,a,c){const u=r+n.x,l=i+n.y,h=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),p=Math.max(n.width,n.height)*h;t.recordStart(this.instanceId,this.attributeLayout,s.textureBinding),this.enablePixelBuffering&&t.recordBounds(u,l,p,p);const{texcoords:d,offsets:f}=s,y=this._textMeshTransformProps.fontSize;this._writeQuad(t,e,r,i,{texcoords:d,offsets:f,fontSize:y,color:ie(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:a,minZoom:Math.max(this._current.zoomRange[0],s.minZoom),maxZoom:Math.min(this._current.zoomRange[1],s.maxZoom),clipAngle:o,mapAligned:c,isLineLabel:!0}),t.recordEnd()}}});let oo=class extends at{constructor(t){super(t),this.debugName="",this._updatingHandles=new pt,this._idToUpdatingState=new ct}get updating(){const e=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some((t=>t));if(t("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map((([t,e])=>`-> ${t}: ${e}`)).join("\n");console.log(`${this.debugName}: Updating: ${e}\n-> Handles: ${this._updatingHandles.updating}\n${t}`)}return e}addUpdateTracking(t,e){const r=ut((()=>e.updating),(e=>this._idToUpdatingState.set(t,e)),{sync:!0});this.addHandles(r)}addPromise(t){return this._updatingHandles.addPromise(t)}};U([lt({constructOnly:!0})],oo.prototype,"debugName",void 0),U([lt({readOnly:!0})],oo.prototype,"updating",null),oo=U([ht("esri.view.2d.layers.support.UpdateTracking2D")],oo);export{xi as $,xn as A,Ti as B,Wt as C,ln as D,Sn as E,Pr as F,rn as G,Bn as H,Ln as I,fs as J,ls as K,Pn as L,Ar as M,Ji as N,is as O,as as P,ni as Q,sn as R,Tr as S,pi as T,oo as U,Ki as V,he as W,pe as X,Di as Y,wi as Z,Xi as _,dt as a,Ni as a0,Pi as a1,on as a2,ge as a3,Nn as a4,Dn as a5,xe as a6,Rr as a7,li as a8,hi as a9,zn as aA,En as aB,de as aC,bn as aD,ri as aE,vn as aF,fe as aG,to as aH,Gi as aI,Fr as aa,Te as ab,Ie as ac,Pe as ad,In as ae,kn as af,Un as ag,Gn as ah,An as ai,Wn as aj,On as ak,Qn as al,Yn as am,Ii as an,Ei as ao,un as ap,bi as aq,fi as ar,qn as as,Zn as at,we as au,Se as av,be as aw,mn as ax,Qi as ay,an as az,Is as b,ft as c,Ts as d,en as e,kr as f,Ps as g,Mi as h,Mr as i,ki as j,Fi as k,Yi as l,so as m,ve as n,Hi as o,tn as p,Ir as q,fn as r,Bi as s,Ci as t,ji as u,gn as v,Sr as w,Zi as x,yn as y,Wr as z};
