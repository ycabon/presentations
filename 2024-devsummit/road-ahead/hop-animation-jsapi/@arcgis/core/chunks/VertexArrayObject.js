/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{f as e}from"./maybe.js";import{t as i}from"../core/lang.js";import{R as s}from"./enums.js";import{b as r,u as n}from"./Texture.js";const o=()=>t.getLogger("esri.views.webgl.VertexArrayObject");let u=class{constructor(t,e,i,s,r=null){this._context=t,this._locations=e,this._layout=i,this._buffers=s,this._indexBuffer=r,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce(((t,e)=>t+this._buffers[e].usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*i}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const t in this._buffers)this._buffers[t]?.dispose(),delete this._buffers[t];this._indexBuffer=e(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&o().warn("Leaked WebGL VAO")}disposeVAOOnly(){if(this._glName){const t=this._context?.capabilities?.vao;t.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(s.VertexArrayObject,this)}this._context=null}initialize(){if(this._initialized)return;const t=this._context?.capabilities?.vao;if(t){const e=t.createVertexArray();t.bindVertexArray(e),this._bindLayout(),t.bindVertexArray(null),this._glName=e,this._context.instanceCounter.increment(s.VertexArrayObject,this)}this._initialized=!0}bind(){this.initialize();const t=this._context?.capabilities?.vao;t?t.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:t,_layout:e,_indexBuffer:i}=this;t||o().error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const i in t){const s=t[i];s||o().error("Vertex buffer is uninitialized!");const n=e[i];n||o().error("Vertex element descriptor is empty!"),r(this._context,this._locations,s,n)}null!=i&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i.glName):this._context.bindBuffer(i))}unbind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:t,_layout:e}=this;t||o().error("Vertex buffer dictionary is empty!");for(const i in t){const s=t[i];s||o().error("Vertex buffer is uninitialized!");const r=e[i];n(this._context,this._locations,s,r)}null!=this._indexBuffer&&this._context.unbindBuffer(this._indexBuffer.bufferType)}};export{u as V};
