/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{M as t,S as e,m as i,addFrameTask as n}from"../core/scheduling.js";import{b as o}from"./vec3.js";import{h as a}from"../core/lang.js";import{d as s,r}from"./maybe.js";import h from"../views/input/gamepad/GamepadInputDevice.js";import{b as c}from"./screenUtils2.js";import{I as l}from"./InputManager.js";import{c as d}from"./screenUtils.js";import{c as u}from"../core/promiseUtils.js";import{s as m}from"./ensureType.js";import{c as p}from"./mathUtils.js";import"../request.js";import g from"../core/Error.js";import"./Logger.js";import"../core/urlUtils.js";import{g as _}from"./capabilities.js";const f=t=>t*t,v=t=>1-f(1-t),w=t=>t*t*t,P=t=>1-w(1-t),x=t=>t<.5?w(2*t)/2:(P(2*(t-.5))+1)/2,b=t=>t*t*t*t,D=t=>1-b(1-t),M=t=>t*t*t*t*t,y=t=>1-M(1-t),S=t=>1-Math.cos(t*Math.PI/2),k=t=>1-S(1-t),C=t=>2**(10*(t-1)),T=t=>1-C(1-t),E=t=>-(Math.sqrt(1-t*t)-1),F=t=>1-E(1-t);function Z(t){const e=2*(t-Math.sqrt((t-1)*t)),i=e/2/t;return n=>n<i?t*n*n:e*n-e+1}function A(t,e){return(i,n)=>i<e?e*t(i/e,n):1-t((1-i)/(1-e),n)*(1-e)}const z=A(Z(1),1),L=A(Z(1),0),I=A(Z(1),.5),W=A(Z(2),1),N=A(Z(2),0),U=A(Z(2),.5),q=A(Z(3),1),j=A(Z(3),0),G=A(Z(3),.5),H=A(Z(4),1),R=A(Z(4),0),B=A(Z(4),.5),O={linear:t=>t,"in-quad":f,"out-quad":v,"in-out-quad":t=>t<.5?f(2*t)/2:(v(2*(t-.5))+1)/2,"in-coast-quad":z,"out-coast-quad":L,"in-out-coast-quad":I,"in-cubic":w,"out-cubic":P,"in-out-cubic":x,"in-coast-cubic":W,"out-coast-cubic":N,"in-out-coast-cubic":U,"in-quart":b,"out-quart":D,"in-out-quart":t=>t<.5?b(2*t)/2:(D(2*(t-.5))+1)/2,"in-coast-quart":q,"out-coast-quart":j,"in-out-coast-quart":G,"in-quint":M,"out-quint":y,"in-out-quint":t=>t<.5?M(2*t)/2:(y(2*(t-.5))+1)/2,"in-coast-quint":H,"out-coast-quint":R,"in-out-coast-quint":B,"in-sine":S,"out-sine":k,"in-out-sine":t=>t<.5?S(2*t)/2:(k(2*(t-.5))+1)/2,"in-expo":C,"out-expo":T,"in-out-expo":t=>t<.5?C(2*t)/2:(T(2*(t-.5))+1)/2,"in-circ":E,"out-circ":F,"in-out-circ":t=>t<.5?E(2*t)/2:(F(2*(t-.5))+1)/2},$=t(500),K=t(8e3);class Y{constructor(t){this._createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:2},this.source=t(),this.target=t()}clone(){const t=new Y(this._createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,e,i){this.source!==t&&this.source.copyFrom(t),this.target!==e&&this.target.copyFrom(e),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:2,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const e=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/e}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}let V=class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((t,i)=>e(t+i.time)),e(0))}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1),t*=this.time;let i=0,n=0;const o=this.definition,a=this.segments.reduce(((t,e)=>t||e.definition.hasZoom),!1);for(let s=0;s<this.segments.length;s++){const r=this.segments[s],h=r.definition;if(t<=r.time||s===this.segments.length-1){if(e=this.segmentInterpolateComponentsAt(r,0===r.time?0:t/r.time,e),o.hasPan&&!isNaN(e.pan)&&isFinite(o.compared.pan)?e.pan=(i+h.compared.pan*e.pan)/o.compared.pan:e.pan=1,o.hasRotate&&!isNaN(e.rotate)&&isFinite(o.compared.rotate)?e.rotate=(n+h.compared.rotate*e.rotate)/o.compared.rotate:e.rotate=1,a&&!isNaN(e.zoom)&&isFinite(h.compared.targetZoom)){const{sourceZoom:t,targetZoom:i}=h.compared,n=e.zoom*(i-t)+t,o=this.segments[this.segments.length-1].definition.compared.targetZoom;e.zoom=n/o}else e.zoom=1;return e}t-=r.time,i+=h.compared.pan,n+=h.compared.rotate}}segmentInterpolateComponentsAt(t,e,i){return t.interpolateComponentsAt(e,i)}};class J{get time(){return this._time}constructor(t){t&&this.update(t)}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,e=t.compared,i=e.sourceZoom,n=e.targetZoom;this._zoomSign=i>n?1:-1,this._panPixelsAtSource=e.pan*t.source.pixelsPerPanAtZoom(i);const o=(t.source.pixelsPerRotateAtZoom(i)+t.target.pixelsPerRotateAtZoom(n))/2;this._rotatePixels=e.rotate*o}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:n,hasPan:o,hasRotate:a}=this.definition;let s=0,r=0;n&&(o&&(s=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),a&&(r=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const h=this.definition.desiredPixelFlow;if(n&&o&&a){const t=s+r+s*r;this._zoomPixelFlow=s*r/t*h,this._panPixelFlow=r/t*h,this._rotatePixelFlow=s/t*h}else if(n&&o){const t=1+s;this._zoomPixelFlow=s/t*h,this._panPixelFlow=1/t*h}else if(n&&a){const t=1+r;this._zoomPixelFlow=r/t*h,this._rotatePixelFlow=1/t*h}else if(o&&a){const t=this._panPixelsAtSource/this._rotatePixels,e=1+t;this._panPixelFlow=t/e*h,this._rotatePixelFlow=1/e*h}else o?this._panPixelFlow=h:n?this._zoomPixelFlow=h:a&&(this._rotatePixelFlow=h);this._time=a?this.rotateTime:n?this.zoomTime:o?this.panTime:e(0)}get rotateTime(){return this.definition.hasRotate?e(this._rotatePixels/this._rotatePixelFlow):e(0)}get zoomTime(){return this.definition.hasZoom?e(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):e(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return e(Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow))}return e(this._panPixelsAtSource/this._panPixelFlow)}return e(0)}_interpolateComponentsZoom(t){if(0===t||1===t)return t;if(this.definition.hasZoom){const e=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(e*(e/i)**-t-e)/(i-e)}return t}_interpolateComponentsPan(t){if(0===t||1===t)return t;if(this.definition.hasPan&&this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(e*t*this._time)-1))/(e*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,e){t=Math.min(Math.max(t,0),1);const i=this._interpolateComponentsZoom(t),n=this._interpolateComponentsPan(t),o=this._interpolateComponentsRotate(t);return e?(e.zoom=i,e.pan=n,e.rotate=o):e={zoom:i,pan:n,rotate:o},e}}function Q(t,e,i){const n=e-t.compared.sourceZoom,o=t.halfWindowPanAtZoom(n);return-t.halfWindowSize*(i.ascensionFactor*Math.LN2*t.compared.pan+o)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*o)}function X(t,e,i){const n=1/e,o=Math.log(t.compared.sourceZoom*n),a=1/t.desiredPixelFlow,s=1/Math.LN2,r=e-t.compared.sourceZoom,h=1/r,c=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(r))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*n*a*s*h*c-t.halfWindowSize*o*a*s*h+t.halfWindowSize*o*a*s*c/(r*r)}function tt(t,e,i){const n=e-t.compared.sourceZoom,o=1/n,a=1/e,s=Math.log(t.compared.sourceZoom*a),r=(i.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(n))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*o*(-2*o*a*r+2*o*s+2*a-2*s*r/(n*n)-r/(e*e))/(t.desiredPixelFlow*Math.LN2)}function et(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function it(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function nt(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function ot(t,e,i){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function at(t,e,i){const n=Math.log(e/t.compared.targetZoom),o=1/t.desiredPixelFlow,a=1/Math.LN2,s=-e+t.compared.targetZoom,r=1/s,h=(-t.halfWindowPanAtZoom(e)-i.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*n*o*a*r+t.halfWindowSize*n*o*a*h/(s*s)+t.halfWindowSize*o*a*r*h/e}function st(t,e,i){const n=e-t.compared.targetZoom,o=1/n,a=1/e,s=Math.log(e/t.compared.targetZoom),r=(t.halfWindowPanAtZoom(e)+i.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*o*(-2*o*a*r-2*o*s+2*a+2*s*r/(n*n)-r/(e*e))/(t.desiredPixelFlow*Math.LN2)}function rt(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function ht(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function ct(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}class lt extends V{constructor(t,e){super(),this._preallocSegments=[new J,new J,new J],this._ascensionSegment=null,this._descensionSegment=null,this.update(t,e)}update(t,e){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let i=null;e?.apex&&(i=function(t,e){let i=function(t,e){const i=Math.max(t.compared.sourceZoom,t.compared.targetZoom),n=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return n<i?null!=e.maximumDistance?i+(e.maximumDistance-i)/2:1.5*i:e.maximumDistance?Math.min(e.maximumDistance,n):n}(t,e);const n={ascensionFactor:null!=e.ascensionFactor?e.ascensionFactor:.5,descensionFactor:null!=e.descensionFactor?e.descensionFactor:.5},o=0===n.ascensionFactor,a=0===n.descensionFactor,s=o?et:Q,r=o?it:X,h=o?nt:tt,c=a?rt:ot,l=a?ht:at,d=a?ct:st,u=e=>s(t,e,n)+function(t,e,i){return-t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}(t,e,n)+c(t,e,n),m=e=>r(t,e,n)+function(t,e,i){return t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}(t,e,n)+l(t,e,n),p=e=>h(t,e,n)+function(t,e,i){return-2*t.compared.pan*t.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}(t,e,n)+d(t,e,n);let g=u(i);const _=function(t){const e=t.compared.sourceZoom-t.compared.targetZoom;if(0===e)return t.compared.pan*t.halfWindowSize/(t.desiredPixelFlow*t.halfWindowPanAtZoom(t.compared.sourceZoom));const i=Math.LN2*t.compared.pan,n=e,o=t.halfWindowPanAtZoom(n),a=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*o);return t.compared.sourceZoom<=t.compared.targetZoom?a*(i-o):a*(i+o)}(t);let f;const v=e.maximumIterations||20,w=null!=e.maximumDistance?e.maximumDistance:1/0;for(f=0;f<v;f++){const n=e.desiredSlope??1e-6;let o=m(i);Math.abs(o)>n&&(o+=n);const a=o/p(i);if(isNaN(a)||i>=w&&a<0){if(!isFinite(w))return null;i=w,g=u(i);break}if(i-=a,i<t.compared.sourceZoom||i<t.compared.targetZoom)return null;const s=u(i);if(Math.abs(s-g)/g<=.005)break;g=s}return g>.7*_||i<t.compared.sourceZoom||i<t.compared.targetZoom?null:i}(t,e.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,e?.apex)}segmentInterpolateComponentsAt(t,e,i){return i=t.interpolateComponentsAt(e,i),t===this._ascensionSegment?i.zoom=v(i.zoom):t===this._descensionSegment&&(i.zoom=f(i.zoom)),i}_updateWithApex(t,e){const[i,n,o]=this._preallocSegments,a=e?.ascensionFactor??.5,s=Math.min(1-a,null!=e?.ascensionFactor&&null!=e.descensionFactor?e.descensionFactor:.5),r=1-a-s;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=t,i.definition.compared.pan=this.definition.compared.pan*a,i.definition.compared.rotate=this.definition.compared.rotate*a,i.update(),this._ascensionSegment=i,this.segments.push(i),r>0&&(n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.copyFrom(this.definition),n.definition.compared.sourceZoom=t,n.definition.compared.targetZoom=t,n.definition.compared.pan=this.definition.compared.pan*r,n.definition.compared.rotate=this.definition.compared.rotate*r,n.update(),this.segments.push(n)),o.definition?o.definition.copyFrom(this.definition):o.definition=this.definition.clone(),o.definition.compared.sourceZoom=t,o.definition.compared.pan=this.definition.compared.pan*s,o.definition.compared.rotate=this.definition.compared.rotate*s,o.update(),this._descensionSegment=o,this.segments.push(o)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const dt={zoom:0,pan:0,rotate:0};let ut=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=t(0),this.definition=new Y(e),this.path=new lt}update(t,n,o){this.definition.update(t,n,o),this.path.update(this.definition,o),this._time=this._applyTimeSettings(i(isFinite(this.path.time)?this.path.time:e(0)),o),this._easing=o.easing??(this._time>=1e3?I:T)}cameraAt(t,e){e=e||this._createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const i=this.path.interpolateComponentsAt(t,dt);return e.interpolate(this.definition.source,this.definition.target,i),e}_normalizedEasing(t){const e=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(t,this._time)-e)/(i-e)}_applyTimeSettings(e,i){const n=null!=i.speedFactor?i.speedFactor:1;null!=i.duration?e=i.duration:null!=i.speedFactor&&(e=t(e/n));const o=null!=i.minDuration?i.minDuration:$/n,a=null!=i.maxDuration?i.maxDuration:K/n;return t(Math.min(Math.max(o,e),a))}};function mt(t,e){switch(e){case"primary":return"touch"===t.pointerType||0===t.button;case"secondary":return"touch"!==t.pointerType&&2===t.button;case"tertiary":return"touch"!==t.pointerType&&1===t.button}}function pt(t,e){if("touch"===t.pointerType)return!1;switch(e){case"primary":return 0===t.button;case"secondary":return 2===t.button;case"tertiary":return 1===t.button}}class gt{constructor(t){this._callbacks=t,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(t){const e=t.data,i=e.pointers.size;switch(e.action){case"start":this._currentCount=i,this._emitStart(t);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(t);break;case"end":this._emitEnd(t),this._currentCount=0}this._previousEvent=t}_emitStart(t){this._startEvent=t,this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.start(this._currentCount,t,this._startEvent)}_emitUpdate(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.update(this._currentCount,t,this._startEvent)}_emitEnd(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.end(this._currentCount,t,this._startEvent),this._startEvent=null}}function _t(t){let e=t*t;return t<0&&(e*=-1),e}function ft(t){return t.translation[0]=0,t.translation[1]=0,t.translation[2]=0,t.heading=0,t.tilt=0,t}function vt(t,e,i){const n=i,a=t.state,s=t.device,r="forward-down"===e.tiltDirection?1:-1;return"standard"===s.deviceType?(n.translation[0]=_t(a.axes[0]),n.translation[1]=_t(a.axes[1]),n.translation[2]=_t(a.buttons[7])-_t(a.buttons[6]),n.heading=_t(a.axes[2]),n.tilt=_t(a.axes[3])):"spacemouse"===s.deviceType&&(n.translation[0]=1.2*_t(a.axes[0]),n.translation[1]=1.2*_t(a.axes[1]),n.translation[2]=2*-_t(a.axes[2]),n.heading=1.2*_t(a.axes[5]),n.tilt=1.2*_t(a.axes[3])),n.tilt*=r,o(n.translation,n.translation,1),n}function wt(t,e){const i=e;return i.translation[0]=t[1]-t[0],i.translation[1]=t[3]-t[2],i.translation[2]=t[4]-t[5],i.heading=t[7]-t[6],i.tilt=t[8]-t[9],i.zoom=t[10]-t[11],i}function Pt(t){return 0===t.translation[0]&&0===t.translation[1]&&0===t.translation[2]&&0===t.heading&&0===t.tilt&&0===t.zoom}function xt(t){const e=()=>t("visible"===document.visibilityState);return document.addEventListener("visibilitychange",e),{remove:()=>document.addEventListener("visibilitychange",e)}}function bt(t){const e=t.native;return e?{buttons:e.buttons.map((t=>t.pressed?t.value||1:0)),axes:e.axes.map((e=>function(t,e){const i=Math.abs(t);return i<e?0:Math.sign(t)*(i-e)/(1-e)}(e,t.axisThreshold)))}:{buttons:[],axes:[]}}class Dt{constructor(t,e){this._element=t,this._input=e,this._hasEventListeners=!1,this._onConnectGamepad=t=>{this._connectGamepad(t.gamepad)},this._onDisconnectGamepad=t=>{const e=t.gamepad,i=e.index,n=this._inputDevices[i];n&&(this._emitGamepadEvent(e,bt(n),!1),this._inputDevices.splice(i,1),this._latestUpdate.splice(i,1),this._input.gamepad.devices.remove(n),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,n=window.isSecureContext;this.supported=i&&n,this.supported&&(this._forEachGamepad((t=>this._connectGamepad(t))),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this._callback=t}_connectGamepad(t){const e=new h(t);"unknown"!==e.deviceType&&(this._inputDevices[t.index]=e,this._input.gamepad.devices.add(e)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=n({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const t=document.hasFocus(),e=this._element.contains(document.activeElement),i="document"===this._input.gamepad.enabledFocusMode&&!t||"view"===this._input.gamepad.enabledFocusMode&&!e;this._forEachGamepad((t=>{const e=this._inputDevices[t.index];if(!e)return;const n=this._latestUpdate[t.index],o=bt(e),a=i||function(t){for(let e=0;e<t.axes.length;e++)if(0!==t.axes[e])return!1;for(let e=0;e<t.buttons.length;e++)if(0!==t.buttons[e])return!1;return!0}(o);if(n){if(n.timestamp===t.timestamp)return;if(!n.active&&a)return;if(function(t,e){if(t.axes.length!==e.axes.length)return!1;if(t.buttons.length!==e.buttons.length)return!1;for(let i=0;i<t.axes.length;i++)if(t.axes[i]!==e.axes[i])return!1;for(let i=0;i<t.buttons.length;i++)if(t.buttons[i]!==e.buttons[i])return!1;return!0}(n.state,o))return}this._emitGamepadEvent(t,o,!a)}))}_forEachGamepad(t){const e=window.navigator.getGamepads();for(let i=0;i<e.length;i++){const n=e[i];this._validate(n)&&t(n)}}_emitGamepadEvent(t,e,i){const n=this._latestUpdate[t.index],o=n&&n.active;if(!o&&!i)return;const a=!o&&i?"start":o&&i?"update":"end";this._latestUpdate[t.index]={timestamp:t.timestamp,state:e,active:i},this._callback&&this._callback({device:this._inputDevices[t.index],state:e,action:a})}_validate(t){if(!t)return!1;if(!t.connected)return!1;for(let e=0;e<t.axes.length;e++)if(isNaN(t.axes[e]))return!1;return!0}}const Mt=a("edge"),yt=a("chrome"),St=a("ff"),kt=a("safari"),Ct="esri-view-surface",Tt={touchNone:`${Ct}--touch-none`,touchPan:`${Ct}--touch-pan`};class Et{constructor(t,e){this._input=e,this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new Dt(t,this._input),this._gamepadSource.onEvent=t=>this._callback("gamepad",t)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach((t=>{this._releasePointerCaptureSafe(t)})),this._gamepadSource=s(this._gamepadSource),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const e in this._active)if(!t||!t.has(e)){const t=this._active[e];this._element.removeEventListener(Ft[e],t),delete this._active[e]}t&&t.forEach((t=>{if(!this._active[t]&&Ft[t]){const e=(this._eventHandlers[t]||this._handleDefault).bind(this,t);this._element.addEventListener(Ft[t],e),this._active[t]=e}})),this._gamepadSource.hasEventListeners=t?.has("gamepad")??!1}setPointerCapture(t,e){e?this._setPointerCatpureSafe(t.pointerId):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?Tt.touchNone:Tt.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?Tt.touchPan:Tt.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(Tt.touchNone),this._element.classList.remove(Tt.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCatpureSafe(t){try{this._element.setPointerCapture(t),this._activePointerCaptures.add(t)}catch{}}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch(t){}}_updateNormalizedPointerLikeEvent(t,e){const i=c(this._element,t);return Et.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),e.x=i.x,e.y=i.y,e}_handleKey(t,e){const{key:i}=e;i&&"key-up"===t&&this._keyDownState.delete(i);const n={native:e,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&"key-down"===t&&this._keyDownState.add(n.key),this._callback(t,n)}_handlePointer(t,e){const i=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,pointerType:e.pointerType,button:e.button,buttons:e.buttons,eventId:this._eventId++});this._callback(t,i)}_handlePointerPreventDefault(t,e){const i=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,pointerType:e.pointerType,button:e.button,buttons:e.buttons,eventId:this._eventId++});e.preventDefault(),this._callback(t,i)}_handleMouseWheel(t,e){let i=e.deltaY;switch(e.deltaMode){case 0:Mt&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Mt?i*=.7:yt||kt?i*=.6:St&&(i*=1.375);const n=Math.abs(i);if(n>100){const t=.02;i=i/n*200/(1+Math.exp(-t*(n-100)))}const o=this._updateNormalizedPointerLikeEvent(e,{native:e,x:0,y:0,deltaY:i});this._callback(t,o)}_handlePointerCaptureLost(t,e){this._activePointerCaptures.delete(e.pointerId),this._handleDefault(t,e)}_handleDefault(t,e){const i={native:e};e.preventDefault(),this._callback(t,i)}_preventAltKeyDefault(t){"Alt"===t.key&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}}Et.test={disableSubpixelCoordinates:!1};const Ft={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class Zt extends l{constructor(){super(!0),this.registerIncoming("context-menu",(t=>{t.data.native.preventDefault()}))}}const At={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};function zt(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function Lt(t){const{native:e}=t,{pointerId:i,button:n,pointerType:o}=e;return"mouse"===o?`${i}:${n}`:`${o}`}class It extends l{constructor(t){super(!1),this._navigationTouch=t,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,e,i,n){return{action:t,pointerType:this._pointerType,button:this._mouseButton,buttons:e.buttons,timestamp:n,pointers:Ut(this._activePointerMap),pointer:e,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(t){const e=t.native.pointerId,i=Nt(this._activePointerMap).angle,n={event:t,initialAngle:0,lastAngle:0};this._activePointerMap.set(e,n);const o=qt(n,Wt(this._activePointerMap));n.initialAngle=o,n.lastAngle=o,this._updatePointerAngles(i)}_updatePointer(t){if(t&&null==t.x&&null==t.y)return;const e=t.native.pointerId,i=this._activePointerMap.get(e);i?i.event=t:this._addPointer(t)}_removePointer(t){const e=Nt(this._activePointerMap).angle;this._activePointerMap.delete(t),this._updatePointerAngles(e)}_updatePointerAngles(t){const e=Nt(this._activePointerMap);this._activePointerMap.forEach((i=>{i.initialAngle=qt(i,e)-t,i.lastAngle=qt(i,e)-t}))}_emitEvent(t,e,i){const n=Nt(this._activePointerMap);this._drag.emit(this._createPayload(t,e,n,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const i=e.data.native.pointerId,n=t(e.timestamp);this._activePointerMap.get(i)&&(1===this._activePointerMap.size?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,n),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",e.data,t(e.timestamp))))}_handlePointerDrag(e){const i=e.data,n=i.currentEvent,o=t(e.timestamp);switch(i.action){case"start":case"update":this._isDragging?this._activePointerMap.has(n.native.pointerId)?(this._updatePointer(n),!this._isCurrentDragSuppressed&&this._emitEvent("update",n,o)):(this._addPointer(n),this._emitEvent("added",n,o),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(n),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",n,o))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&"touch"===this._pointerType&&1===this._activePointerMap.size}}function Wt(t){const e=[];return t.forEach((t=>{e.push(d(t.event.x,t.event.y))})),function(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:d()},0===t.length)return e;if(1===t.length)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(2===t.length){const[i,n]=t,[o,a]=[n.x-i.x,n.y-i.y];return e.radius=Math.sqrt(o*o+a*a)/2,e.center.x=(i.x+n.x)/2,e.center.y=(i.y+n.y)/2,e}let i=0,n=0;for(let e=0;e<t.length;e++)i+=t[e].x,n+=t[e].y;i/=t.length,n/=t.length;const o=t.map((t=>t.x-i)),a=t.map((t=>t.y-n));let s=0,r=0,h=0,c=0,l=0,u=0,m=0;for(let t=0;t<o.length;t++){const e=o[t],i=a[t],n=e*e,d=i*i;s+=n,r+=d,h+=e*i,c+=n*e,l+=d*i,u+=e*d,m+=i*n}const p=.5*(c+u),g=.5*(l+m),_=s*r-h*h,f=(p*r-g*h)/_,v=(s*g-h*p)/_,w=d(f+i,v+n);return{radius:Math.sqrt(f*f+v*v+(s+r)/t.length),center:w}}(e)}function Nt(t){const e=Wt(t);let i=0;return t.forEach((t=>{let n=qt(t,e),o=n-t.lastAngle;for(;o>Math.PI;)o-=2*Math.PI;for(;o<-Math.PI;)o+=2*Math.PI;n=t.lastAngle+o,t.lastAngle=n;const a=n-t.initialAngle;i+=a})),i/=t.size||1,{angle:i,radius:e.radius,center:e.center}}function Ut(t){const e=new Map;return t.forEach(((t,i)=>e.set(i,t.event))),e}function qt(t,e){const i=t.event,n=i.x-e.center.x,o=i.y-e.center.y;return Math.atan2(o,n)}var jt;!function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"}(jt||(jt={}));class Gt extends l{constructor(t=At.maximumDoubleClickDelay,e=At.maximumDoubleClickDistance,i=At.maximumDoubleTouchDelay,n=At.maximumDoubleTouchDistance,o=u){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=e,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=n,this._clock=o,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach((t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()})),super.onUninstall()}_handlePointerDown(t){const e=t.data,i=Lt(e);if(!this._pointerState.has(i)){const t={downButton:e.native.button,x:e.x,y:e.y,immediateDoubleClick:null};this._pointerState.set(i,t),this.startCapturingPointer(e.native)}}_handlePointerUp(t){const e=t.data,i=Lt(e),n=this._pointerState.get(i);if(n&&n.downButton===e.native.button){const i=n.immediateDoubleClick,o="touch"===t.data.native.pointerType?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;i?(i.timeoutHandle.remove(),zt(i,t.data)>o?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,i.modifiers),this._removeState(e))):zt(n,t.data)>o?this._removeState(e):this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,e){const i="touch"===t.data.native.pointerType?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;e.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout((()=>this._removeState(t.data)),i)}}_removeState(t){const e=Lt(t);this._pointerState.delete(e),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}}class Ht extends l{constructor(t=At.maximumClickDelay,e=At.movementUntilMouseDrag,i=At.movementUntilPenDrag,n=At.movementUntilTouchDrag,o=At.holdDelay,a=u){super(!1),this._maximumClickDelay=t,this._movementUntilMouseDrag=e,this._movementUntilPenDrag=i,this._movementUntilTouchDrag=n,this._holdDelay=o,this._clock=a,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",(t=>{this._handlePointerLoss(t,"pointer-up")})),this.registerIncoming("pointer-capture-lost",(t=>{this._handlePointerLoss(t,"pointer-capture-lost")})),this.registerIncoming("pointer-cancel",(t=>{this._handlePointerLoss(t,"pointer-cancel")})),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach((t=>{t.holdTimeout=r(t.holdTimeout)})),super.onUninstall()}_handlePointerDown(t){const e=t.data,i=e.native.pointerId;let n=null;0===this._pointerState.size&&(n=this._clock.setTimeout((()=>{const e=this._pointerState.get(i);if(e){if(!e.isDragging){const i=e.previousEvent;this._pointerHold.emit(i,void 0,t.modifiers),e.holdEmitted=!0}e.holdTimeout=null}}),this._holdDelay));const o={startEvent:e,previousEvent:e,startTimestamp:t.timestamp,isDragging:!1,downButton:e.native.button,holdTimeout:n,modifiers:new Set};this._pointerState.set(i,o),this.startCapturingPointer(e.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_createPointerDragData(t,e,i){return{action:t,startEvent:e.startEvent,previousEvent:e.previousEvent,currentEvent:i}}_handlePointerMove(t){const e=t.data,i=e.native.pointerId,n=this._pointerState.get(i);n&&(n.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",n,e),void 0,n.modifiers):function(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}(e,n.startEvent)>this._getDragThreshold(e.native.pointerType)&&this._startDragging(t),n.previousEvent=e)}_getDragThreshold(t){switch(t){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(t){const e=t.data,i=e.native.pointerId;this._pointerState.forEach((n=>{null!=n.holdTimeout&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging||(n.modifiers=t.modifiers,n.isDragging=!0,i===n.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",n,e)):this._pointerDrag.emit(this._createPointerDragData("start",n,n.previousEvent),t.timestamp))}))}_handlePointerLoss(t,e){const i=t.data,n=i.native.pointerId,o=this._pointerState.get(n);o&&(null!=o.holdTimeout&&(o.holdTimeout.remove(),o.holdTimeout=null),o.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",o,"pointer-up"===e?i:o.previousEvent),void 0,o.modifiers):"pointer-up"===e&&o.downButton===i.native.button&&t.timestamp-o.startTimestamp<=this._maximumClickDelay&&!o.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(n),this.stopCapturingPointer(i.native),0===this._pointerState.size&&this._moveHandle.pause())}}class Rt extends l{constructor(t=At.maximumDoubleClickDelay,e=At.maximumDoubleClickDistance,i=At.maximumDoubleTouchDelay,n=At.maximumDoubleTouchDistance,o=u){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=e,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=n,this._clock=o,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this))}onUninstall(){this._pointerState.forEach((t=>t.doubleClickTimer=r(t.doubleClickTimer)))}get hasPendingInputs(){return m(this._pointerState,(t=>null!=t.doubleClickTimer))}_clearDoubleClickTimer(t,e){const i=this._pointerState.get(t);i&&(i.doubleClickTimer=r(i.doubleClickTimer),e&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){const e=this._pointerState.get(t);1===e.pointerDownCount&&this._click.emit(e.event.data,void 0,e.event.modifiers),e.doubleClickTimer=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}_getPointerId(t){const{pointerId:e,pointerType:i,button:n}=t.native;return"mouse"===i?`${e}:${n}`:`${i}`}_handleImmediateClick(t){const e=t.data,{pointerType:i}=e.native,n=this._getPointerId(e);if(!this._pointerState.has(n))return void this._startClick(t);const o=this._pointerState.get(n),{data:a,modifiers:s}=o.event,r="touch"===i?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;zt(a,e)>r?(this._clearDoubleClickTimer(n,!0),this._startClick(t)):(this._clearDoubleClickTimer(n,!1),2===o.pointerDownCount&&this._doubleClick.emit(a,void 0,s))}_handlePointerDown(t){const e=Lt(t.data),i=this._pointerState.get(e);i&&(i.pointerDownCount+=1)}_startClick(t){const{data:e}=t,{native:{pointerType:i}}=e,n=Lt(e),o="touch"===i?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,a=this._clock.setTimeout((()=>this._doubleClickTimeoutExceeded(n)),o);this._pointerState.set(n,{event:t,doubleClickTimer:a,pointerDownCount:1}),this.refreshHasPendingInputs()}}function Bt(t,e){const i=function(t,e){const{format:i,quality:n,rotation:o,disableDecorations:a}=t||{},s=ee(t,e.padding),r=function(t,e){const i={x:0,y:0,width:e.width,height:e.height};if(t?.area){null!=t.area.x&&(i.x=Math.floor(t.area.x)),null!=t.area.y&&(i.y=Math.floor(t.area.y));const n=null!=t.area.width?Math.floor(t.area.width):null,o=null!=t.area.height?Math.floor(t.area.height):null;if(i.width=e.width-i.x,i.height=e.height-i.y,null!=n&&null!=o)i.width=Math.min(i.width,n),i.height=Math.min(i.height,o);else if(null==n&&null!=o){const t=Math.min(i.width,n);i.height=t/i.width*i.height,i.width=t}else if(null!=n&&null==o){const t=Math.min(i.height,o);i.width=t/i.height*i.width,i.height=t}}return function(t,e){const i=Math.floor(Math.max(t.x,0)),n=Math.floor(Math.max(t.y,0)),o={x:i,y:n,width:Math.floor(Math.min(t.width,e.width-i)),height:Math.floor(Math.min(t.height,e.height-n))},a=o.width/o.height,s=t.width/t.height;if(s===a)return o;if(s>a){const t=Math.floor(o.width/s),e=o.height-t;return{x:o.x,y:Math.floor(o.y+e/2),width:o.width,height:t}}const r=Math.floor(o.height*s),h=o.width-r;return{x:Math.floor(o.x+h/2),y:o.y,width:r,height:o.height}}(function(t,e){if(null==e?.width||null==e.height)return t;const i=e.width/e.height,n=t.width/t.height;if(n===i)return t;if(n<i){const e=Math.floor(t.height*i);return t.x-=(e-t.width)/2,t.width=e,t}const o=Math.floor(t.width/i);return t.y-=(o-t.height)/2,t.height=o,t}(i,t),e)}(t,{width:e.width-s.left-s.right,height:e.height-s.top-s.bottom}),{width:h,height:c}=function(t,e){if(!t)return e;const i=t.width,n=t.height;if(null!=i&&null!=n)return{width:Math.floor(i),height:Math.floor(n)};if(null==i&&null==n)return e;const o=e.width/e.height;return null==n?{width:Math.floor(i),height:Math.floor(i/o)}:{width:Math.floor(n*o),height:Math.floor(n)}}(t,r),l=ie(i),d=ae[l];return{format:l,quality:p(null!=n?n:d,0,100),area:r,width:h,height:c,rotation:o,disableDecorations:!!a,ignoreBackground:!!t?.ignoreBackground,ignorePadding:!!t?.ignorePadding}}(t,e),n=i.area,o=i.width/n.width,a=ee(i,e.padding),s=a.left+a.right,r=a.top+a.bottom,h=e.width-s,c=e.height-r,l=Math.floor(h*o+s),d=Math.floor(c*o+r),u=t?.layers??[],m=i.ignoreBackground,g=i.ignorePadding;return{framebufferWidth:l,framebufferHeight:d,region:{x:Math.floor(n.x*o)+a.left,y:Math.floor(n.y*o)+a.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:o,layers:u,disableDecorations:i.disableDecorations,ignoreBackground:m,ignorePadding:g,objectAndLayerIdColor:!1}}function Ot(t,e,i){const{ctx:n,canvas:o}=Kt(t,i),a=n.getImageData(0,0,t.width,t.height),s=function(t,e){const i=ne[e.format],n=e.quality/100;return t.toDataURL(i,n)}(o,e);return Yt(o),{dataUrl:s,data:a}}function $t(t,e){const{ctx:i,canvas:n}=Kt(t,e),o=i.getImageData(0,0,t.width,t.height);return Yt(n),o}function Kt(t,e){const i=(null==Vt&&(Vt=document.createElement("canvas")),Vt);e.premultipliedAlpha&&function(t){const e=t.data,i=e.length;for(let t=0;t<i;t+=4){const i=e[t+3];if(255!==i&&i>0){const n=255/i;e[t]=e[t]*n,e[t+1]=e[t+1]*n,e[t+2]=e[t+2]*n}}}(t),i.width=t.width,i.height=t.height;const n=i.getContext("2d",{willReadFrequently:!0});return n.putImageData(t,0,0),e.flipY&&function(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}(n),{ctx:n,canvas:i}}function Yt(t){t.width=0,t.height=0}let Vt=null;function Jt(t,e){const i=ie(t),n=ae[i];return{format:i,quality:p(null!=e?e:n,0,100)}}function Qt(t,e){return e/Math.max(t[0],t[1])}function Xt(t,e,i,n=0,o=0,a=t.width-n,s=t.height-o,r=!1){const{data:h}=t,{width:c,height:l,data:d}=e,u=a/c,m=s/l,p=Math.ceil(u/2),g=Math.ceil(m/2),_=t.width;for(let t=0;t<l;t++)for(let e=0;e<c;e++){const a=4*(e+(r?l-t-1:t)*c);let s=0,f=0,v=0,w=0,P=0,x=0;const b=(t+.5)*m;for(let a=Math.floor(t*m);a<(t+1)*m;a++){const t=Math.abs(b-(a+.5))/g,r=(e+.5)*u,c=t*t;for(let t=Math.floor(e*u);t<(e+1)*u;t++){const e=Math.abs(r-(t+.5))/p,l=Math.sqrt(c+e*e);if(l>=1)continue;let d=2*l*l*l-3*l*l+1;const u=4*(n+t+(o+a)*_);x+=d*h[u+3],f+=d,!i&&h[u+3]<255&&(d=d*h[u+3]/255),v+=d*h[u],w+=d*h[u+1],P+=d*h[u+2],s+=d}}d[a]=v/s,d[a+1]=w/s,d[a+2]=P/s,d[a+3]=x/f}return e}function te(t,e,i){if(!e)return t;const{framebufferWidth:n,framebufferHeight:o,pixelRatio:a,region:s}=t,r=ee(t,i),h=r.left+r.right,c=r.top+r.bottom,l=n-h,d=o-c,u=Math.min(8,Math.min((2048-h)/l,(2048-c)/d));return u<1.5?t:{...t,framebufferWidth:Math.round(l*u)+h,framebufferHeight:Math.round(d*u)+c,pixelRatio:a*u,resample:{region:{x:Math.round((s.x-r.left)*u)+r.left,y:Math.round((s.y-r.top)*u)+r.top,width:Math.round(s.width*u),height:Math.round(s.height*u)},width:n,height:o}}}function ee(t,e){return!e||t&&t.ignorePadding?se:e}function ie(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return oe}}const ne={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},oe="png",ae={png:100,jpg:98,jpeg:98},se={top:0,right:0,bottom:0,left:0};function re(t){const e=_();return e.available?"3d"===t&&e.majorPerformanceCaveat?new g("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist."):e.supportsHighPrecisionFragment?e.supportsVertexShaderSamplers?null:new g("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new g("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new g("webgl:required","WebGL2 is required but not supported.",(new Error).stack)}export{ut as A,Et as B,gt as D,O as E,Gt as I,Ht as P,Rt as S,vt as a,At as b,It as c,Zt as d,mt as e,Jt as f,Lt as g,Ot as h,Pt as i,$t as j,Qt as k,re as l,zt as m,Xt as n,xt as o,x as p,T as q,ft as r,pt as s,wt as t,Bt as u,te as v};
