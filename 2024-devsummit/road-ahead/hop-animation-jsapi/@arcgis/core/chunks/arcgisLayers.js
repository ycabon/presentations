/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{getFilename as r,urlToObject as t}from"../core/urlUtils.js";import{p as a,b as s}from"./arcgisLayerUrl.js";import{f as o}from"./associatedFeatureServiceUtils.js";import{f as l}from"./fetchService.js";import{s as n}from"./layerUtils2.js";import{l as i}from"./lazyLayerLoader.js";import{f as c}from"./requestPresets.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"./persistableUrlUtils.js";import"../kernel.js";import"../request.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";const u={FeatureLayer:!0,SceneLayer:!0};async function p(i){const p=i.properties?.customParameters,d=await async function(i,p){let m=a(i);if(null==m&&(m=await async function(e,a){const o=await c(e,{customParameters:a});let l=null,n=null;const i=o.type;if("Feature Layer"===i||"Table"===i?(l="FeatureServer",n=o.id??null):"indexedVector"===i?l="VectorTileServer":o.hasOwnProperty("mapName")?l="MapServer":o.hasOwnProperty("bandCount")&&o.hasOwnProperty("pixelSizeX")?l="ImageServer":o.hasOwnProperty("maxRecordCount")&&o.hasOwnProperty("allowGeometryUpdates")?l="FeatureServer":o.hasOwnProperty("streamUrls")?l="StreamServer":y(o)?(l="SceneServer",n=o.id):o.hasOwnProperty("layers")&&y(o.layers?.[0])&&(l="SceneServer"),!l)return null;const u=null!=n?s(e):null;return{title:null!=u&&o.name||r(e),serverType:l,sublayer:n,url:{path:null!=u?u.serviceUrl:t(e).path}}}(i,p)),null==m)throw new e("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:i});const{serverType:d,sublayer:j}=m;let S;const v={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"},b="FeatureServer"===d,w="SceneServer"===d,h={parsedUrl:m,Constructor:null,layerId:b||w?j??void 0:void 0,layers:[],tables:[]};switch(d){case"MapServer":if(null!=j)S="FeatureLayer";else{const e=await async function(e,r){return(await c(e,{customParameters:r})).tileInfo}(i,p);S=e?"TileLayer":"MapImageLayer"}break;case"ImageServer":{const e=await c(i,{customParameters:p}),{tileInfo:r,cacheType:t}=e;S=r?"LERC"!==r?.format?.toUpperCase()||t&&"elevation"!==t.toLowerCase()?"ImageryTileLayer":"ElevationLayer":"ImageryLayer";break}case"SceneServer":{const e=await c(m.url.path,{customParameters:p});if(S="SceneLayer",e){const r=e?.layers;if("Voxel"===e?.layerType)S="VoxelLayer";else if(r?.length){const e=r[0]?.layerType;null!=e&&null!=n[e]&&(S=n[e])}}break}case"3DTilesServer":S="IntegratedMesh3DTilesLayer";break;case"FeatureServer":if(S="FeatureLayer",null!=j){const e=await c(i,{customParameters:p});h.sourceJSON=e,"Oriented Imagery Layer"===e.type&&(S="OrientedImageryLayer")}break;default:S=v[d]}if(u[S]&&null==j){const e=await async function(e,r,t){let a,s,n=!1;switch(r){case"FeatureServer":{const r=await l(e,{customParameters:t});n=!!r.layersJSON,a=r.layersJSON||r.serviceJSON;break}case"SceneServer":{const r=await async function(e,r){const t=await c(e,{customParameters:r}),a=t.layers?.[0];if(!a)return{serviceInfo:t};try{const{serverUrl:a}=await o(e),s=await c(a,{customParameters:r}).catch((()=>null));return s&&(t.tables=s.tables),{serviceInfo:t,tableServerUrl:a}}catch{return{serviceInfo:t}}}(e,t);a=r.serviceInfo,s=r.tableServerUrl;break}default:a=await c(e,{customParameters:t})}const i=a?.layers,u=a?.tables;return{layers:i?.map((e=>({id:e.id}))).reverse()||[],tables:u?.map((e=>({serverUrl:s,id:e.id}))).reverse()||[],layerInfos:n?i:[],tableInfos:n?u:[]}}(i,d,p);if(b&&(h.sublayerInfos=e.layerInfos,h.tableInfos=e.tableInfos),1!==e.layers.length+e.tables.length)h.layers=e.layers,h.tables=e.tables,b&&e.layerInfos?.length&&(h.sublayerConstructorProvider=await async function(e){const r=[],t=[];if(e.forEach((e=>{const{type:a}=e;"Oriented Imagery Layer"===a?(r.push(a),t.push(f("OrientedImageryLayer"))):(r.push(a),t.push(f("FeatureLayer")))})),!t.length)return;const a=await Promise.all(t),s=new Map;return r.forEach(((e,r)=>{s.set(e,a[r])})),e=>s.get(e.type)}(e.layerInfos));else if(b||w){const r=e.layerInfos?.[0]??e.tableInfos?.[0];h.layerId=e.layers[0]?.id??e.tables[0]?.id,h.sourceJSON=r,b&&"Oriented Imagery Layer"===r?.type&&(S="OrientedImageryLayer")}}return h.Constructor=await f(S),h}(i.url,p),j={...i.properties,url:i.url};if(d.layers.length+d.tables.length===0)return null!=d.layerId&&(j.layerId=d.layerId),null!=d.sourceJSON&&(j.sourceJSON=d.sourceJSON),new d.Constructor(j);const S=new(0,(await import("../layers/GroupLayer.js")).default)({title:d.parsedUrl.title});return await async function(e,r,t){function a(e,r,a,s){const o={...t,layerId:r,sublayerTitleMode:"service-name"};return null!=e&&(o.url=e),null!=a&&(o.sourceJSON=a),s(o)}const s=r.sublayerConstructorProvider;for(const{id:t,serverUrl:o}of r.layers){const l=m(r.sublayerInfos,t),n=(l&&s?.(l))??r.Constructor,i=a(o,t,l,(e=>new n(e)));e.add(i)}if(r.tables.length){const t=await f("FeatureLayer");r.tables.forEach((({id:s,serverUrl:o})=>{const l=a(o,s,m(r.tableInfos,s),(e=>new t(e)));e.tables.add(l)}))}}(S,d,j),S}function m(e,r){return e?e.find((e=>e.id===r)):null}function y(e){return null!=e&&e.hasOwnProperty("store")&&e.hasOwnProperty("id")&&"number"==typeof e.id}async function f(e){return(0,i[e])()}export{p as fromUrl};
