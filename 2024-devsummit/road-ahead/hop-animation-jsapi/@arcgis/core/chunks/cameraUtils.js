/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../Camera.js";import{C as t,a as n}from"./Cyclical.js";import{L as r}from"./Logger.js";import{r as i,a,d as o,e as s}from"./mathUtils.js";import{throwIfAborted as c}from"../core/promiseUtils.js";import{p as l,k as u,b as f,c as m,h as p,d,l as y,n as h,e as g,g as M,y as v,G as R}from"./vec3.js";import{c as w,f as T,a as x}from"./vec3f64.js";import{r as b}from"./unitUtils.js";import S from"../geometry/Point.js";import{project as j,projectWithZConversion as C}from"../geometry/projection.js";import z from"../geometry/SpatialReference.js";import{p as P,a as H}from"./projectPointToVector.js";import{p as A,a as D}from"./projectVectorToPoint.js";import{p as G}from"./projectVectorToVector.js";import{V as U}from"./ViewingMode.js";import{r as E}from"./aaBoundingRect.js";import{n as I}from"./Intersector2.js";import{y as L,d as q,a as O,z as k}from"./mat4.js";import{c as F}from"./mat4f64.js";import W from"../geometry/Extent.js";import{geographicToWebMercator as _}from"../geometry/support/webMercatorUtils.js";import{g as V,a as J}from"./earthUtils.js";import{g as X}from"./ElevationProvider.js";import{i as K}from"./spatialReferenceSupport.js";function Y(e,t,n,r){return null!=e.renderCoordsHelper.fromRenderCoords(t.eye,$,r)&&E(n,$)}function B(e,t){return e.elevationProvider?e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground")??0:0}function N(e,t,n,r){const i=e.state.camera.clone();t&&n&&r&&(i.eye=t,i.center=n,i.up=r),function(e,t,n){let r=Q[e.viewingMode];r||(r=I(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,Q[e.viewingMode]=r);const{isGlobal:i}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,n)||Z(e,t.origin,n))||!(!e.renderCoordsHelper.intersectManifold(t,0,n)||Z(e,t.origin,n))||!!i&&function(e,t,n){const r=d(e.origin,e.origin)-n*n,i=r>0?Math.sqrt(r)/3:1;return f(t,e.direction,i/y(e.direction)),p(t,t,e.origin),!0}(t,n,b(e.spatialReference).radius)}(e,i.ray,ee)||l(ee,i.center);const a=e.state.constraints,o=a.minimumPoiDistance;if(u(i.eye,ee)<o){const t=a.collision.enabled;l(te,i.viewForward),f(te,te,o),t?i.eye=m($,ee,te):p(ee,i.eye,te);const n=e.renderCoordsHelper,r=n.getAltitude(i.eye),s=a.collision.elevationMargin;t&&r<s&&(m(te,ee,i.eye),i.eye=n.setAltitude($,s,i.eye),p(ee,i.eye,te))}return i.center=ee,i}function Z(e,t,n){if(!e.state.isGlobal||!e.stateManager.constraintsManager)return!1;const r=B(e,t),i=e.stateManager.constraintsManager.nearFarHeuristic,{far:a}=i.compute(t,n,e.renderDataExtent,r,ne),o=a*a;return u(t,n)>o}const Q={},$=w(),ee=w(),te=w(),ne={near:0,far:0},re=w(),ie=w();function ae(){return{direction:w(),up:w()}}function oe(e,t,n,r,o){let s=h(re,e),c=d(s,r);const u=c>0;c=Math.abs(c),c>.99&&(c=Math.abs(d(t,r)),c<.99?(l(s,t),u&&f(s,s,-1)):s=null);let p=0;if(s){f(ie,r,d(r,s)),m(s,s,ie);const e=d(s,o)/(y(s)*y(o));g(ie,s,o),p=(d(ie,r)>0?1:-1)*i(a(e))}const M=i(a(-d(r,e)/y(e)));return n?(n.heading=p,n.tilt=M,n):{heading:p,tilt:M}}const se=T(0,1,0),ce=T(0,0,1),le=F(),ue=w(),fe=w();function me(e,t,n,r=ae()){const{direction:i,up:a}=r;return L(le,-o(t)),q(le,le,o(n)),M(i,ce,le),f(i,i,-1),M(a,se,le),r}function pe(e,t,n,r,i){const a=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return P(t,ue,a),P(t,fe,a),ue[0]-=n/2,fe[0]+=n/2,ue[1]-=r/2,fe[1]+=r/2,G(ue,a,ue,o),G(fe,a,fe,o),i?(i.xmin=ue[0],i.ymin=ue[1],i.xmax=fe[0],i.ymax=fe[1],i.spatialReference=o):i=new W(ue[0],ue[1],fe[0],fe[1],o),i}const de=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){return oe(t,n,r,ce,se)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i=me(0,n,r),a=w();return f(a,i.direction,-t),p(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}},eyeTiltToLookAtTilt:function(e){return o(e)},headingTiltToDirectionUp:me,lookAtTiltToEyeTilt:function(e){return i(e)},toExtent:pe},Symbol.toStringTag,{value:"Module"})),ye=T(0,0,1),he=h(w(),T(1,1,1)),ge=new t(-180,180),Me=F(),ve=w(),Re=w();function we(e,t,n,r=ae()){g(ve,e,ye),0===d(ve,ve)&&g(ve,e,he),O(Me,-o(t),e),k(Me,Me,-o(n),ve);const{up:i,direction:a}=r;return g(i,ve,e),h(i,i),M(i,i,Me),h(a,e),v(a,a),M(a,a,Me),r}function Te(e){const t=e[1];e[1]=-e[2],e[2]=t}function xe(e,t){const n=we(t,e.heading,e.tilt);return e.up=n.up,e}function be(e,t,r,a,s){let c,l,u,f;const m=t.latitude,p=b(e.spatialReference).radius,d=t.longitude,y=V(m,r,p)/2;c=d-y,l=d+y;const h=o(m),g=(1+Math.sin(h))/(1-Math.sin(h)),M=(g+1)*Math.tan(a/p/2),v=M*M;function R(e){const t=Math.PI/2;return(e=n.normalize(e,-t))>t&&(e=Math.PI-e),e}if(u=1.5*Math.PI-2*Math.atan(.5*(M+Math.sqrt(4*g+v))),f=u+a/p,u=R(u),f=R(f),f<u){const e=f;f=u,u=e}if(u=Math.max(i(u),-90),f=Math.min(i(f),90),l=ge.monotonic(c,l),l-c>180){const e=(l-c-180)/2;c+=e,l-=e}const w=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:z.WGS84;return s?(s.xmin=c,s.ymin=u,s.xmax=l,s.ymax=f,s.spatialReference=w):s=new W(c,u,l,f,w),e.spatialReference&&e.spatialReference.isWebMercator&&_(s,!1,s),s}const Se=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:function(e,t,n,r){const i=ve,a=Re;return h(i,e),g(Re,i,ye),0===d(Re,Re)&&g(Re,i,he),g(a,Re,i),oe(t,n,r,i,a)},eyeForCenterWithHeadingTilt:function(e,t,n,r){const i={eye:w(),up:null,tilt:r,heading:n},a=ve;a[0]=e[0],a[1]=e[2],a[2]=-e[1];const c=t,l=o(n),u=o(r),m=Math.sin(l),p=Math.cos(l),d=Math.sin(u),h=Math.cos(u),g=y(a);let M;if(Math.abs(u)<1e-8)M=c+g;else{const e=g/d,t=s(c/e),n=Math.PI-u-t;M=e*Math.sin(n)}const v=h*c,R=c*c*(d*d),T=p*p*R,x=M-v,b=x*x,S=T*(T+b-a[1]*a[1]);if(S<0)return f(i.eye,a,M/g),i.tilt=0,xe(i,e);const j=Math.sqrt(S),C=a[1]*x,z=T+b;let P;if(P=p>0?-j+C:j+C,Math.abs(z)<1e-8)return g<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=c):f(i.eye,a,M/g),i.tilt=0,Te(i.eye),xe(i,e);i.eye[1]=P/z;const H=m*m*R,A=d*c,D=p*A*i.eye[1],G=i.eye[1]*i.eye[1],U=1-G,E=Math.sqrt(U),I=T*G+H-2*D*E*x+U*b;return Math.abs(I)<1e-8?(f(i.eye,a,M/g),i.tilt=0,Te(i.eye),xe(i,e)):(i.eye[0]=(U*(M*a[0]-v*a[0])-A*E*(a[0]*i.eye[1]*p+a[2]*m))/I,i.eye[2]=(U*(M*a[2]-v*a[2])-A*E*(a[2]*i.eye[1]*p-a[0]*m))/I,f(i.eye,i.eye,M),Te(i.eye),xe(i,e))},eyeTiltToLookAtTilt:function(e,t,n){const r=o(e),i=y(t);return s(n/(i/Math.sin(r)))+r},headingTiltToDirectionUp:we,lookAtTiltToEyeTilt:function(e,t,n){const r=y(t),a=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),o=s(n/(a/Math.sin(e)));return i(e-o)},toExtent:be},Symbol.toStringTag,{value:"Module"})),je=()=>r.getLogger("esri.views.3d.support.cameraUtils"),Ce=39.37,ze=96,Pe=1,He=8,Ae=5,De=1,Ge=w(),Ue={heading:0,tilt:0},Ee=w(),Ie=new t(-20037508.342788905,20037508.342788905),Le=new t(-180,180);var qe;function Oe(e){return e.spatialReference??z.WGS84}function ke(e){return"global"===e.viewingMode?Se:de}function Fe(e,t,n,r,i){return ke(e).headingTiltToDirectionUp(t,n,r,i)}function We(e,t){if(null==t)return null;const n=e.renderSpatialReference,r=ke(e).headingTiltToDirectionUp,i=w();if(!P(t.position,i,n))return null;const a=r(i,t.heading,t.tilt);f(a.direction,a.direction,e.state.camera.distance),p(a.direction,a.direction,i);const s=N(e,i,a.direction,a.up);return s.fov=o(t.fov),s.row=t.layout.row,s.rows=t.layout.rows,s.column=t.layout.column,s.columns=t.layout.columns,s}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(qe||(qe={}));const _e=w();function Ve(t,n,r){const a=t.renderSpatialReference,o=Ne(t,n.eye,n.viewForward,n.up,Ue);let s=Oe(t);return G(n.eye,a,_e,s)||(s=z.WGS84,G(n.eye,a,_e,s)),null==r?r=new e(new S(_e,s),o.heading,o.tilt,i(n.fov)):(r.position.x=_e[0],r.position.y=_e[1],r.position.z=_e[2],r.position.spatialReference=s,r.heading=o.heading,r.tilt=o.tilt,r.fov=i(n.fov)),r.layout.row=n.row,r.layout.rows=n.rows,r.layout.column=n.column,r.layout.columns=n.columns,r}function Je(e,t,n){const r=e.state.camera,i=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===U.Global&&null!=n&&(t*=Math.cos(o(n))),t/=e.renderCoordsHelper.unitInMeters,i/(ze*Ce/t)/Math.tan(r.fovX/2)}function Xe(e,t,n){const r=e.state.camera,i=t*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let s=ze*Ce/(a/i);return e.renderCoordsHelper.viewingMode===U.Global&&null!=n&&(s/=Math.cos(o(n))),s*e.renderCoordsHelper.unitInMeters}async function Ke(e,t,n,r,i,a){return Be(e,t,Je(e,n,t.latitude),r,i,a)}function Ye(e,t,n,r,i,a){return dt(e,Qe(e,r.heading,r.tilt,t,n,i),r.fov,a)}async function Be(e,t,n,r,i,a){const o=await $e(e,r.heading,r.tilt,t,n,i,a);return c(a),yt(e,o,r.fov,a)}function Ne(e,t,n,r,i){return ke(e).directionToHeadingTilt(t,n,r,i)}function Ze(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Ee,e.spatialReference)&&e.elevationProvider&&(X(e.elevationProvider,Ee)??0)>Ee[2]-De)}function Qe(e,t,n,r,i,a){const o=r instanceof S?r:null,s=function(e,t){const n=w();if(null==t)return l(n,e.state.camera.center);if(t instanceof S){if(!P(t,n,e.renderSpatialReference))return null;const{basemapTerrain:r,elevationProvider:i}=e;if(null==t.z&&null!=r&&null!=i){const r=X(i,t);null!=r&&e.renderCoordsHelper.setAltitude(n,r)}return n}return l(n,t)}(e,r);return et(e,t,n,o,s,i,a)}async function $e(e,t,n,r,i,a,o){const s=r instanceof S?r:null,u=await async function(e,t,n){const r=w();if(null==t)return l(r,e.state.camera.center);if(t instanceof S){const{renderSpatialReference:i,basemapTerrain:a,elevationProvider:o}=e,s=t.spatialReference;if(await H(t,r,i,0,{signal:n}),c(n),null==t.z&&null!=a&&null!=o){const i=await o.queryElevation(t.x,t.y,t.z??0,s,"ground",n);c(n),null!=i&&e.renderCoordsHelper.setAltitude(r,i)}return r}return l(r,t)}(e,r,o);return c(o),tt(e,t,n,s,u,i,a,o)}function et(e,t,n,r,i,a,o){if(null==i)return null;if(!r&&(r=new S({spatialReference:Oe(e)}),!A(i,e.renderSpatialReference,r)))return null;const s=nt(e,t,n,i,a,o);if(rt(e,n,o)&&Ze(e,s.eye)){const{tilt:o,mode:s}=it(e,n,i,a);return et(e,t,o,r,i,a,s)}return at(s,i)}async function tt(e,t,n,r,i,a,o,s){r||(r=new S({spatialReference:Oe(e)}),await D(i,e.renderSpatialReference,r,{signal:s})||(r=null)),c(s);const l=nt(e,t,n,i,a,o);if(rt(e,n,o)&&await async function(e,t,n){if(Ze(e,t))return!0;const{elevationProvider:r,spatialReference:i,renderCoordsHelper:a}=e;if(null==r||!a.fromRenderCoords(t,Ee,i))return!1;const[o,s,l]=Ee,u=await r.queryElevation(o,s,l,i,"ground",n)??0;return c(n),u>l-De}(e,l.eye,s)){c(s);const{tilt:o,mode:l}=it(e,n,i,a);return tt(e,t,o,r,i,a,l,s)}return at(l,i)}function nt(e,t,n,r,i,a){const o=function(e,t,n,r,i,a){let o=0;return a===qe.ADJUST&&function(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>He)return!0;const i=e.renderSpatialReference,a=Oe(e),o=new S({spatialReference:a});if(!A(t,i,o))return!1;const s=new S({spatialReference:a});if(!A(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,s))return!1;const c=Math.tan(.5*e.state.camera.fov)*r;return s.distance(o)/c>Ae}(e,r,i)?(t=0,o=function(e,t,n,r){const i=pt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);a.max=Math.min(a.max,.5*Math.PI);const o=a.min*(1-ft)+a.max*ft;return Math.min(i,o)}(e,i,n,r)):o=pt(e,r,i,n),o=e.state.constraints.clampTilt(i,o),{heading:t,tilt:n=mt(e,r,i,o)}}(e,t,n,r,i=Math.max(i,e.state.constraints.minimumPoiDistance),a);return(0,ke(e).eyeForCenterWithHeadingTilt)(r,i,o.heading,o.tilt)}function rt(e,t,n){const r=e.map.ground.navigationConstraint;return n===qe.ADJUST&&"global"===e.viewingMode&&t>0&&(null==r||"stay-above"===r.type)}function it(e,t,n,r){const i=mt(e,n,r,function(e,t,n,r){let i=pt(e,r,t,n);if(!e.state.constraints.tilt)return i;const a=e.state.constraints.tilt(t);return i=Math.min(i,.5*Math.PI),a.min*(1-ft)+i*ft}(e,r,t,n));return{tilt:i,mode:t-i<1?qe.LOCKED:qe.ADJUST}}function at(e,t){return{...e,center:x(t)}}function ot(e,t){const{state:n,spatialReference:r}=e,i=t.spatialReference;return n.isGlobal&&K(i,U.Global)||n.isLocal&&r.equals(i)}function st(e,t){let n,r,i;if(e.state.isGlobal){const e=new S(t.xmin,t.ymin,t.spatialReference),a=new S(t.xmax,t.ymax,t.spatialReference),o=t.spatialReference.isGeographic?Le:Ie;n=new S({x:o.center(e.x,a.x),y:(a.y+e.y)/2,z:null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0,spatialReference:t.spatialReference});const s=b(t.spatialReference),c=J(n,e,a);r=c.lon,i=c.lat,o.diff(e.x,a.x)>o.range/2&&(r+=s.halfCircumference),r=Math.min(r,s.halfCircumference),i=Math.min(i,s.halfCircumference)}else{const a=e.renderSpatialReference??t.spatialReference;a.equals(t.spatialReference)||(t=j(t,a)),r=t.xmax-t.xmin,i=t.ymax-t.ymin;const o=null!=t.zmax&&null!=t.zmin?(t.zmax+t.zmin)/2:void 0;n=new S({x:t.xmin+.5*r,y:t.ymin+.5*i,z:o,spatialReference:a})}const a=null!=t.zmax&&null!=t.zmin?t.zmax-t.zmin:0,o=e.state.camera,s=1/Math.tan(o.fovX/2),c=1/Math.tan(o.fovY/2),l=1/Math.tan(o.fov/2);return{center:n,distance:Math.max(.5*r*s,.5*i*c,.5*a*l)/Pe}}async function ct(e,t,n,r,i,a){const o=ot(e,t)?t:await C(t,e.spatialReference,{signal:a});c(a);const{center:s,distance:l}=st(e,o),u=await $e(e,n,r,s,l,i,a);return c(a),yt(e,u,e.camera.fov,a)}function lt(e,t,n,r,i,a){let o;try{o=ot(e,t)?t:j(t,e.spatialReference)}catch(e){return null}const{center:s,distance:c}=st(e,o),l=Qe(e,n,r,s,c,i);return null==l?null:dt(e,l,e.camera.fov,a)}function ut(e,t,n){const r=e.renderSpatialReference,i=new S({spatialReference:Oe(e)});if(!A(n,r,i))return null;const a=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),s=R(t.eye,n),c=2*s*a*Pe,l=2*s*o*Pe;return"global"===e.viewingMode?be(e,i,c,l):pe(e,i,c,l)}const ft=.7;function mt(e,t,n,r){return ke(e).lookAtTiltToEyeTilt(r,t,n)}function pt(e,t,n,r){return ke(e).eyeTiltToLookAtTilt(r,t,n)}function dt(t,n,r,i){if(null==n)return null;const a=t.renderSpatialReference,o=new S({spatialReference:Oe(t)});return A(n.eye,a,o)?(i??=new e,i.position=o,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):null}async function yt(t,n,r,i){const a=t.renderSpatialReference,o=new S({spatialReference:Oe(t)});return await D(n.eye,a,o,{signal:i}),c(i),new e(o,n.heading,n.tilt,r)}function ht(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);je().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function gt(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);je().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Mt(e,t){return G(t.center,e.renderSpatialReference,Ge,z.WGS84),Xe(e,t.distance,Ge[1])}export{qe as O,ct as a,Ye as b,Be as c,Mt as d,We as e,lt as f,Oe as g,N as h,Ve as i,Xe as j,Ke as k,Ne as l,B as m,Y as n,ht as o,Qe as p,Fe as q,ae as r,Je as s,ut as t,gt as z};
