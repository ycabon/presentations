/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{h as r}from"../core/lang.js";import{L as s}from"./Logger.js";import{c as i}from"./MD5.js";import n from"../layers/support/AggregateField.js";import a from"../layers/support/ExpressionInfo.js";import t from"../renderers/support/AuthoringInfo.js";r.add("esri-cluster-arcade-enabled",!0);const o=r("esri-cluster-arcade-enabled");function u(e,r){const s=r.clone();if(!l(s))return s;if(s.authoringInfo||(s.authoringInfo=new t),s.authoringInfo.isAutoGenerated=!0,"visualVariables"in s){const r=(s.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression));r.forEach((r=>{"rotation"===r.type?r.field?r.field=d(e,r.field,"avg_angle","number"):r.valueExpression&&(r.field=p(e,r.valueExpression,"avg_angle","number"),r.valueExpression=null):r.normalizationField?(r.field=d(e,r.field,"avg_norm","number",r.normalizationField),r.normalizationField=null):r.field?r.field=d(e,r.field,"avg","number"):r.valueExpression&&(r.field=p(e,r.valueExpression,"avg","number"),r.valueExpression=null)})),s.visualVariables=r}switch(s.type){case"simple":break;case"pie-chart":for(const r of s.attributes)r.field?r.field=d(e,r.field,"sum","number"):r.valueExpression&&(r.field=p(e,r.valueExpression,"sum","number"),r.valueExpression=null);break;case"unique-value":s.field?s.field=d(e,s.field,"mode","string"):s.valueExpression&&(s.field=p(e,s.valueExpression,"mode","string"),s.valueExpression=null);break;case"class-breaks":s.normalizationField?(s.field=d(e,s.field,"avg_norm","number",s.normalizationField),s.normalizationField=null):s.field?s.field=d(e,s.field,"avg","number"):s.valueExpression&&(s.field=p(e,s.valueExpression,"avg","number"),s.valueExpression=null)}return s}const l=r=>{const i=i=>s.getLogger("esri.views.2d.layers.support.clusterUtils").error(new e("Unsupported-renderer",i,{renderer:r}));if(!r)return!1;switch(r.type){case"unique-value":if(r.field2||r.field3)return i("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(r.normalizationField){const e=r.normalizationType;if("field"!==e)return i(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return i(`FeatureReductionCluster does not support renderers of type ${r.type}`),!1}if(!o){if("valueExpression"in r&&r.valueExpression)return i("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in r&&r.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return i("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function p(e,r,s,t){const o=i(r),u="mode"===s?`cluster_type_${o}`:"sum"===s?`cluster_sum_${o}`:`cluster_avg_${o}`;return e.some((e=>e.name===u))||e.push(new n({name:u,isAutoGenerated:!0,onStatisticExpression:new a({expression:r,returnType:t}),statisticType:s})),u}function d(e,r,s,t,o){if("cluster_count"===r||e.some((e=>e.name===r)))return r;const u=function(e,r,s){switch(e){case"sum":return`cluster_sum_${r}`;case"avg":case"avg_angle":return`cluster_avg_${r}`;case"mode":return`cluster_type_${r}`;case"avg_norm":{const e=s,n="field",a=r.toLowerCase()+",norm:"+n+","+e.toLowerCase();return"cluster_avg_"+i(a)}}}(s,r,o);return e.some((e=>e.name===u))||("avg_norm"===s?e.push(new n({name:u,isAutoGenerated:!0,onStatisticExpression:new a({expression:`$feature.${r} / $feature.${o}`,returnType:t}),statisticType:"avg"})):e.push(new n({name:u,isAutoGenerated:!0,onStatisticField:r,statisticType:s}))),u}export{u as c,l as i};
