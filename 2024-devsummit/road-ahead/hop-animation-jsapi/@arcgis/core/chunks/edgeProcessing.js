/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{n as e}from"./InterleavedLayout.js";import{V as n}from"./VertexAttribute.js";import{g as o}from"./glUtil.js";import{R as s,D as r}from"../core/lang.js";import{h as i,n as c,i as a,s as f,p as l,d as u,x as g,e as m,c as N}from"./vec3.js";import{c as p}from"./vec3f64.js";import{a as d}from"./Normals.js";import{d as I,a as S}from"./mathUtils.js";const O=e().vec3f(n.POSITION).u16(n.COMPONENTINDEX),h=e().vec2u8(n.SIDENESS),A=o(h),E=e().vec3f(n.POSITION0).vec3f(n.POSITION1).vec2i16(n.NORMALCOMPRESSED).u16(n.COMPONENTINDEX).u8(n.VARIANTOFFSET,{glNormalized:!0}).u8(n.VARIANTSTROKE).u8(n.VARIANTEXTENSION,{glNormalized:!0}),T=e().vec3f(n.POSITION0).vec3f(n.POSITION1).vec2i16(n.NORMALCOMPRESSED).vec2i16(n.NORMAL2COMPRESSED).u16(n.COMPONENTINDEX).u8(n.VARIANTOFFSET,{glNormalized:!0}).u8(n.VARIANTSTROKE).u8(n.VARIANTEXTENSION,{glNormalized:!0}),v=new Map([[n.POSITION0,0],[n.POSITION1,1],[n.COMPONENTINDEX,2],[n.VARIANTOFFSET,3],[n.VARIANTSTROKE,4],[n.VARIANTEXTENSION,5],[n.NORMALCOMPRESSED,6],[n.NORMAL2COMPRESSED,7],[n.SIDENESS,8]]);function w(t,e,n){const o=e/3,s=new Uint32Array(n+1),r=new Uint32Array(n+1),i=(t,e)=>{t<e?s[t+1]++:r[e+1]++};for(let e=0;e<o;e++){const n=t[3*e],o=t[3*e+1],s=t[3*e+2];i(n,o),i(o,s),i(s,n)}let c=0,a=0;for(let t=0;t<n;t++){const e=s[t+1],n=r[t+1];s[t+1]=c,r[t+1]=a,c+=e,a+=n}const f=new Uint32Array(6*o),l=s[n],u=(t,e,n)=>{if(t<e){const o=s[t+1]++;f[2*o]=e,f[2*o+1]=n}else{const o=r[e+1]++;f[2*l+2*o]=t,f[2*l+2*o+1]=n}};for(let e=0;e<o;e++){const n=t[3*e],o=t[3*e+1],s=t[3*e+2];u(n,o,e),u(o,s,e),u(s,n,e)}const g=(t,e)=>{const n=2*t,o=e-t;for(let t=1;t<o;t++){const e=f[n+2*t],o=f[n+2*t+1];let s=t-1;for(;s>=0&&f[n+2*s]>e;s--)f[n+2*s+2]=f[n+2*s],f[n+2*s+3]=f[n+2*s+1];f[n+2*s+2]=e,f[n+2*s+3]=o}};for(let t=0;t<n;t++)g(s[t],s[t+1]),g(l+r[t],l+r[t+1]);const m=new Int32Array(3*o),N=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,p=(t,e)=>{const n=N(t,e);m[3*e+n]=-1},d=(t,e,n,o)=>{const s=N(t,e);m[3*e+s]=o;const r=N(n,o);m[3*o+r]=e};for(let t=0;t<n;t++){let e=s[t];const n=s[t+1];let o=r[t];const i=r[t+1];for(;e<n&&o<i;){const n=f[2*e],s=f[2*l+2*o];n===s?(d(t,f[2*e+1],s,f[2*l+2*o+1]),e++,o++):n<s?(p(t,f[2*e+1]),e++):(p(s,f[2*l+2*o+1]),o++)}for(;e<n;)p(t,f[2*e+1]),e++;for(;o<i;)p(f[2*l+2*o],f[2*l+2*o+1]),o++}return m}class R{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?D:V}write(t,e,n){const o=this._edgeHashFunction(n);b.seed=o;const s=b.getIntRange(0,255),r=b.getIntRange(0,this.settings.variants-1),i=b.getFloat(),c=255*(.5*function(t,e){const n=t<0?-1:1;return Math.abs(t)**1.2*n}(-(1-Math.min(i/.7,1))+Math.max(0,i-.7)/(1-.7))+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,s),t.variantStroke.set(e,r),t.variantExtension.set(e,c)}trim(t,e){return t.slice(0,e)}}const y=new Float32Array(6),P=new Uint32Array(y.buffer),M=new Uint32Array(1);function V(t){const e=y;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],M[0]=5381;for(let t=0;t<P.length;t++)M[0]=31*M[0]+P[t];return M[0]}function D(t){const e=y;e[0]=C(t.position0[0]),e[1]=C(t.position0[1]),e[2]=C(t.position0[2]),e[3]=C(t.position1[0]),e[4]=C(t.position1[1]),e[5]=C(t.position1[2]),M[0]=5381;for(let t=0;t<P.length;t++)M[0]=31*M[0]+P[t];return M[0]}const L=1e4;function C(t){return Math.round(t*L)/L}class F{constructor(){this._commonWriter=new R}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return E.createBuffer(t)}write(t,e,n){this._commonWriter.write(t,e,n),i(_,n.faceNormal0,n.faceNormal1),c(_,_);const{typedBuffer:o,typedBufferStride:s}=t.normalCompressed;d(o,e,_[0],_[1],_[2],s)}trim(t,e){return this._commonWriter.trim(t,e)}}F.Layout=E,F.glLayout=o(E,1);class x{constructor(){this._commonWriter=new R}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return T.createBuffer(t)}write(t,e,n){this._commonWriter.write(t,e,n);{const{typedBuffer:o,typedBufferStride:s}=t.normalCompressed;d(o,e,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],s)}{const{typedBuffer:o,typedBufferStride:s}=t.normal2Compressed;d(o,e,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],s)}}trim(t,e){return this._commonWriter.trim(t,e)}}x.Layout=T,x.glLayout=o(T,1);const _=p(),b=new s,j=-1;var B;function W(t,e,n,o=k){const s=t.vertices.position,i=t.vertices.componentIndex,g=I(o.anglePlanar),p=I(o.angleSignificantEdge),d=Math.cos(p),S=Math.cos(g),O=z.edge,h=O.position0,A=O.position1,E=O.faceNormal0,T=O.faceNormal1,v=function(t){const e=t.faces.length/3,n=t.vertices.position,o=t.faces,s=H.v0,r=H.v1,i=H.v2,a=new Float32Array(3*e);for(let t=0;t<e;t++){const e=o[3*t],f=o[3*t+1],l=o[3*t+2];n.getVec(e,s),n.getVec(f,r),n.getVec(l,i),N(r,r,s),N(i,i,s),m(s,r,i),c(s,s),a[3*t]=s[0],a[3*t+1]=s[1],a[3*t+2]=s[2]}return a}(t),w=function(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let s=0;for(let t=0;t<e;t++){const e=o[3*t],r=o[3*t+1],i=o[3*t+2],c=n[3*t],a=n[3*t+1],f=n[3*t+2];s+=e===j||c<a?1:0,s+=r===j||a<f?1:0,s+=i===j||f<c?1:0}const r=new Int32Array(4*s);let i=0;for(let t=0;t<e;t++){const e=o[3*t],s=o[3*t+1],c=o[3*t+2],a=n[3*t],f=n[3*t+1],l=n[3*t+2];(e===j||a<f)&&(r[i++]=a,r[i++]=f,r[i++]=t,r[i++]=e),(s===j||f<l)&&(r[i++]=f,r[i++]=l,r[i++]=t,r[i++]=s),(c===j||l<a)&&(r[i++]=l,r[i++]=a,r[i++]=t,r[i++]=c)}return r}(t),R=w.length/4,y=e.allocate(R);let P=0;const M=R,V=n.allocate(M);let D=0,L=0,C=0;const F=r(0,R),x=new Float32Array(R);x.forEach(((t,e,n)=>{s.getVec(w[4*e],h),s.getVec(w[4*e+1],A),n[e]=a(h,A)})),F.sort(((t,e)=>x[e]-x[t]));const _=new Array,b=new Array;for(let t=0;t<R;t++){const o=F[t],r=x[o],c=w[4*o],a=w[4*o+1],m=w[4*o+2],N=w[4*o+3],p=N===j;if(s.getVec(c,h),s.getVec(a,A),p)f(E,v[3*m],v[3*m+1],v[3*m+2]),l(T,E),O.componentIndex=i.get(c),O.cosAngle=u(E,T);else{if(f(E,v[3*m],v[3*m+1],v[3*m+2]),f(T,v[3*N],v[3*N+1],v[3*N+2]),O.componentIndex=i.get(c),O.cosAngle=u(E,T),U(O,S))continue;O.cosAngle<-.9999&&l(T,E)}L+=r,C++,p||X(O,d)?(e.write(y,P++,O),_.push(r)):K(O,g)&&(n.write(V,D++,O),b.push(r))}const B=new Float32Array(_.reverse()),W=new Float32Array(b.reverse());return{regular:{instancesData:e.trim(y,P),lodInfo:{lengths:B}},silhouette:{instancesData:n.trim(V,D),lodInfo:{lengths:W}},averageEdgeLength:L/C}}function X(t,e){return t.cosAngle<e}function U(t,e){return t.cosAngle>e}function K(t,e){const n=S(t.cosAngle),o=z.fwd,s=z.ortho;return g(o,t.position1,t.position0),n*(u(m(s,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}!function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"}(B||(B={}));const z={edge:{position0:p(),position1:p(),faceNormal0:p(),faceNormal1:p(),componentIndex:0,cosAngle:0},ortho:p(),fwd:p()},H={v0:p(),v1:p(),v2:p()},k={anglePlanar:4,angleSignificantEdge:35};function q(t){const e=G(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Q.updateSettings(t.writerSettings),Y.updateSettings(t.writerSettings),W(e,Q,Y)}function G(e,n,o,s){if(n){const t=w(o,s,e.count);return new J(o,s,t,e)}const r=t(e.buffer,e.stride/4,{originalIndices:o,originalIndicesLength:s}),i=w(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:O.createView(r.buffer)}}class J{constructor(t,e,n,o){this.faces=t,this.facesLength=e,this.neighbors=n,this.vertices=o}}const Q=new F,Y=new x,Z=e().vec3f(n.POSITION0).vec3f(n.POSITION1),$=e().vec3f(n.POSITION0).vec3f(n.POSITION1).u16(n.COMPONENTINDEX);export{O as E,F as R,x as S,h as V,G as a,W as b,Z as c,$ as d,q as e,v as f,B as g,A as h};
