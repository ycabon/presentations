/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import{m as e,e as i,B as a,u as o,n,h as s}from"./colorUtils2.js";import{m as r,h as l,r as p,d as h,b as c}from"./handleUtils.js";import{d as u,r as d}from"./maybe.js";import{watch as m,on as g,syncAndInitial as _,when as f,sync as v,initial as y}from"../core/reactiveUtils.js";import{property as M}from"../core/accessorSupport/decorators/property.js";import{h as b,r as S,i as x}from"../core/lang.js";import"./Logger.js";import{subclass as w}from"../core/accessorSupport/decorators/subclass.js";import{z as E,s as T,h as O,b as j,G as A,c as I,n as D,d as G,e as R,x as C,j as L,l as P,a as k,k as U,p as V,m as z}from"./vec3.js";import{c as H,f as F,a as N}from"./vec3f64.js";import{b as X,a as Z,i as Y,r as B,d as W,h as q,g as Q}from"./elevationInfoUtils.js";import{E as J}from"./ElevationInfo.js";import{b as K,g as $}from"./screenUtils.js";import"../core/Error.js";import tt from"../Color.js";import et from"../core/Accessor.js";import{c as it}from"./asyncUtils.js";import{d as at,c as ot,r as nt}from"./mathUtils.js";import{throwIfAborted as st}from"../core/promiseUtils.js";import{h as rt}from"./quantityFormatUtils.js";import{n as lt,x as pt,g as ht,Z as ct}from"./unitUtils.js";import{o as ut,g as dt,n as mt,e as gt,h as _t,b as ft}from"./vec2.js";import{c as vt,f as yt}from"./vec2f64.js";import{i as Mt,m as bt}from"./coordsUtils.js";import{s as St,a as xt,g as wt,y as Et,h as Tt,t as Ot,e as jt,q as At,m as It}from"./plane.js";import{f as Dt}from"./messages.js";import{g as Gt}from"./getDefaultUnitForView.js";import{T as Rt}from"./TextOverlayItem.js";import{c as Ct,v as Lt,a as Pt,f as kt,b as Ut,g as Vt}from"./automaticLengthMeasurementUtils.js";import{v as zt}from"./viewUtils.js";import{S as Ht}from"./SnappingVisualizer3D.js";import{M as Ft}from"./interfaces.js";import{S as Nt,O as Xt}from"./OutlineVisualElement.js";import{E as Zt}from"./ExtendedLineVisualElement.js";import{V as Yt}from"./VerticesVisualElement.js";import{e as Bt,E as Wt}from"./ElevationContext.js";import{G as qt}from"./GraphicState.js";import{R as Qt}from"./Material.js";import{D as Jt,g as Kt,m as $t,a as te,c as ee,b as ie}from"./editPlaneUtils.js";import{D as ae,S as oe,E as ne}from"./drawSurfaces.js";import{getDrawMeshHelpMessage as se}from"./helpMessageUtils3d.js";import re from"../core/Collection.js";import le from"../core/Evented.js";import{z as pe,s as he,d as ce,c as ue,m as de}from"./quantityUtils.js";import{U as me}from"./UpdatingHandles.js";import{m as ge}from"./dehydratedPoint.js";import{M as _e,R as fe,c as ve,g as ye,d as Me,p as be,a as Se}from"./manipulatorUtils2.js";import{l as xe}from"./snappingUtils.js";import{S as we,i as Ee,a as Te,g as Oe,b as je}from"../widgets/Sketch/SketchViewModel.js";import{c as Ae}from"./manipulatorUtils.js";import{signal as Ie}from"../core/signal.js";import{L as De}from"./LaserlineVisualElement.js";import{p as Ge}from"./projectPointToVector.js";import{p as Re}from"./projectVectorToVector.js";import{c as Ce,k as Le,F as Pe}from"./aaBoundingBox.js";import{g as ke}from"./aaBoundingRect.js";import{P as Ue}from"./PointVisualElement.js";import Ve from"../core/Handles.js";import{f as ze,y as He,m as Fe,a as Ne,x as Xe,v as Ze,d as Ye,s as Be,z as We,r as qe}from"./mat4.js";import{c as Qe,f as Je,I as Ke}from"./mat4f64.js";import{b as $e,c as ti,d as ei,e as ii,f as ai,g as oi,a as ni}from"./dragEventPipeline3D.js";import{d as si,b as ri,c as li,e as pi,f as hi,g as ci,E as ui,h as di,I as mi,i as gi,j as _i,a as fi,k as vi}from"./InteractiveToolBase.js";import{C as yi}from"./basicInterfaces.js";import{g as Mi,t as bi,h as Si,i as xi,e as wi,d as Ei,f as Ti}from"./GeometryUtil.js";import{C as Oi}from"./ColorMaterial.js";import{a as ji,M as Ai}from"./interfaces2.js";import{G as Ii}from"./GraphicManipulator.js";import{E as Di,P as Gi,O as Ri,A as Ci,b as Li}from"./EditGeometryOperations.js";import{S as Pi}from"./SnappingContext.js";import{c as ki}from"./SnappingDragPipelineStep.js";import{T as Ui,S as Vi}from"./Tooltip.js";import{b as zi,c as Hi,T as Fi,d as Ni,e as Xi,a as Zi}from"./TranslateTooltipInfos.js";import"../geometry.js";import Yi from"../geometry/Polyline.js";import{i as Bi}from"./utils9.js";import{M as Wi}from"./IViewEvents.js";import{a as qi}from"./automaticAreaMeasurementUtils.js";import{c as Qi}from"./SnappingManager.js";import Ji from"../geometry/SpatialReference.js";import Ki from"../geometry/Point.js";import{V as $i}from"./ViewingMode.js";import{b as ta}from"./Cyclical.js";import{addFrameTask as ea}from"../core/scheduling.js";import{d as ia,a as aa,b as oa,g as na,e as sa}from"./axisAngleDegrees.js";import ra from"../geometry/support/MeshTransform.js";import{i as la}from"./meshVertexSpaceUtils.js";import{S as pa,O as ha,I as ca,R as ua,k as da,l as ma,d as ga,v as _a,F as fa,G as va,q as ya,H as Ma,J as ba}from"./ShiftManipulator.js";import{a as Sa,c as xa,u as wa}from"./boundedPlane.js";import{g as Ea}from"./Factory.js";import{a as Ta}from"./ray.js";import{E as Oa,a as ja}from"./ExtentTooltipInfos.js";import"./vec4.js";import"./common.js";import"./vec4f64.js";import"../config.js";import"./ensureType.js";import"./utils.js";import"./metadata.js";import"./tracking.js";import"./shared.js";import"./SimpleObservable.js";import"./ObservableBase.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./jsonMap.js";import"../core/JSONSupport.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./assets.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./Axis.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./colorUtils.js";import"./unitFormatUtils.js";import"./ByteSizeUnit.js";import"./mat3f64.js";import"./quatf64.js";import"./mathUtils2.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"./projector.js";import"./widgetUtils.js";import"./measurementUtils2.js";import"../geometry/projection.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./spatialReferenceEllipsoidUtils.js";import"./vec4f32.js";import"./EngineVisualElement.js";import"../core/Identifiable.js";import"./RenderGeometry.js";import"./debugFlags2.js";import"../views/3d/webgl/ManagedFBO.js";import"./enums.js";import"./StencilUtils.js";import"./mat3.js";import"./BindType.js";import"./interfaces5.js";import"./ShaderTechniqueConfiguration.js";import"./VertexAttribute.js";import"./doublePrecisionUtils.js";import"./requestImageUtils.js";import"./Texture.js";import"./ContentObject.js";import"./Util.js";import"./IntegerPassUniform.js";import"./compilerUtils.js";import"./weather.js";import"../views/3d/environment/CloudyWeather.js";import"./enumeration.js";import"../views/3d/environment/FoggyWeather.js";import"../views/3d/environment/RainyWeather.js";import"../views/3d/environment/SnowyWeather.js";import"../views/3d/environment/SunnyWeather.js";import"./RenderState.js";import"./RenderPlugin.js";import"./NestedMap.js";import"./Camera.js";import"./frustum.js";import"./Attribute.js";import"./Geometry.js";import"./Indices.js";import"./triangle.js";import"./lineSegment.js";import"./RibbonLineMaterial.js";import"./sphere.js";import"./Octree.js";import"./InterleavedLayout.js";import"./BufferView.js";import"./types.js";import"./OrderIndependentTransparency.js";import"./floatRGBA.js";import"./VertexArrayObject2.js";import"./VertexArrayObject.js";import"./Intersector.js";import"./Intersector2.js";import"./verticalOffsetUtils.js";import"./orientedBoundingBox.js";import"./quat.js";import"./computeTranslationToOriginAndRotation.js";import"./glUtil.js";import"./VertexElementDescriptor.js";import"./MemCache.js";import"./BufferObject.js";import"./Scheduler.js";import"./debugFlags.js";import"./VisualElement.js";import"./RightAngleQuadVisualElement.js";import"./normalizedPoint.js";import"./Settings.js";import"./RightAngleSnappingHint.js";import"./SnappingVisualizer.js";import"./PointSnappingHint.js";import"./lineStippleUtils.js";import"./DoubleArray.js";import"./line.js";import"./line2.js";import"./triangulationUtils.js";import"./earcut.js";import"./_commonjsHelpers.js";import"./deduplicate.js";import"./Object3DVisualElement.js";import"./ElevationProvider.js";import"./hydratedFeatures.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./memoize.js";import"../layers/GraphicsLayer.js";import"./GraphicsCollection.js";import"../layers/Layer.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"../layers/mixins/ScaleRangeLayer.js";import"./dehydratedFeatureComparison.js";import"./createUtils.js";import"../geometry/Circle.js";import"../geometry/support/geodesicUtils.js";import"../geometry/geometryEngine.js";import"./geometryEngineBase.js";import"./hydrated.js";import"./surfaceCoordinateSystems.js";import"./mat2d.js";import"./mat2df64.js";import"./helpMessageUtils.js";import"./keybindings.js";import"./uuid.js";import"./angularMeasurementUtils.js";import"./diffUtils.js";import"../views/interactive/sketch/SketchLabelOptions.js";import"./SnappingOperation.js";import"./graphicUtils.js";import"./DefaultBufferWriter.js";import"./OutputHighlight.glsl.js";import"./geometry2dUtils.js";import"./timeUtils.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./DataLayerSource.js";import"../layers/support/Field.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./FullTextSearch.js";import"./spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./InputManager.js";import"./Queue.js";import"./PropertiesPool.js";import"./layerUtils2.js";import"./layerUtils.js";import"../views/interactive/sketch/SketchTooltipOptions.js";import"../views/interactive/sketch/SketchValueOptions.js";import"../views/interactive/snapping/SnappingOptions.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./hitTestSelectUtils.js";import"./screenUtils2.js";import"../layers/support/FeatureFilter.js";import"./floorFilterUtils.js";import"./projectVectorToWGS84ComparableLonLat.js";import"./geodesicMeasurementUtils.js";import"./CameraSpace.glsl.js";import"./HUDMaterial.js";import"./VerticalOffset.glsl.js";import"./GLTextureMaterial.js";import"./drawUtils.js";import"./vec3f32.js";import"./TriangleMaterial.js";import"./defaults.js";import"./defaultsJSON.js";import"./drapedUtils.js";import"./themeUtils.js";import"../widgets/Widget.js";import"./domUtils.js";import"./jsxWidgetSupport.js";import"./legacyIcon.js";import"./jsxFactory.js";import"./a11yUtils.js";import"./messageBundle.js";import"./directionModeIcons.js";import"../symbols/support/cimSymbolUtils.js";import"./utils6.js";import"./LRUCache.js";import"./euclideanAreaMeasurementUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"./vec32.js";import"./ImageMaterial.js";import"./DefaultLayouts.js";import"../analysis/SlicePlane.js";import"./persistable.js";import"./MD5.js";import"./multiOriginJSONSupportUtils.js";import"./resourceExtension.js";import"./LineVisualElement.js";import"./RenderCoordsHelper.js";import"./projectVectorToPoint.js";const Aa={default:15,far:25};let Ia=class extends et{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=it((async t=>{const e=await Dt("esri/core/t9n/Units");st(t),this._messagesUnits=e}));this.addHandles([m((()=>[null!=this.context&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits]),(()=>this._update())),...["vertex-add","vertex-update","vertex-remove"].map((t=>g((()=>this.context?.editGeometryOperations),t,(()=>this._update())))),r((()=>t.abort())),m((()=>this._colors),(t=>this._updateStyle(t)))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return null==this._messagesUnits}get test(){return{labelContents:this._labelInfos.slice(0,this._nextLabelIndex).map((t=>t.label.text))}}get _edgeDistancePixels(){return Aa[this.edgeDistance]}get _colors(){const t=this.context?.view.effectiveTheme.textColor??tt.fromArray([255,255,255]);return{textColor:t,backgroundColor:e(i(t,a.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const{context:t,stagedVertex:e}=this;if(!t)return this._destroyUnusedLabels();const{editGeometryOperations:i}=t,{components:a,geometry:o,coordinateHelper:n}=i.data;if(!o)return this._destroyUnusedLabels();const s=a.length;for(let a=0;a<s;++a){const r=Da(o,i,e,n,a);if(r.length<2||!Ga(r,t.view,t.elevationInfo,n.spatialReference))continue;const l=1===s&&!Mt(r);let p=Pa,h=ka;this.toScreenPointArray(t,r[0],p);for(let e=1;e<r.length;++e){const i=r[e-1],a=r[e];this.toScreenPointArray(t,a,h),this._addLabel(t,i,p,a,h,l),[p,h]=[h,p]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){const i=this._nextLabelIndex,a=this._labelInfos;for(let o=0;o<i;++o){const{label:i}=a[o];i.textColor=t,i.backgroundColor=e}}_addLabel(t,e,i,a,o,n){const{label:s}=this._getOrCreateLabel(t);if(!this.visible||ut(i,o)<3025)return void(s.visible=!1);const{spatialReference:r}=t.editGeometryOperations.data,l=Ct(e,a,r),p=this._messagesUnits,h=Gt(t.view);s.text=null!=p&&null!=l?rt(p,l,h):"",s.visible=!0;const c=o[0]-i[0],u=o[1]-i[1];n?dt(Ca,-u,c):dt(Ca,u,-c),mt(Ca,Ca),gt(Ca,Ca,this._edgeDistancePixels),_t(La,i,o,.5),ft(La,La,Ca),s.position=[La[0],La[1]],Math.abs(Ca[0])>Math.abs(Ca[1])?s.anchor=Ca[0]>0?"left":"right":s.anchor=-Ca[1]<0?"top":"bottom"}_getOrCreateLabel(t){const e=this._labelInfos.length>this._nextLabelIndex,{textColor:i,backgroundColor:a}=this._colors;if(e){const t=this._labelInfos[this._nextLabelIndex++],{label:e}=t;return e.textColor=i,e.backgroundColor=a,t}const o=new Rt({anchor:"center",fontSize:8,textColor:i,backgroundColor:a});t.view.overlay?.items.add(o);const n={label:o};return this._labelInfos.push(n),this._nextLabelIndex=this._labelInfos.length,n}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){this.context?.view.overlay?.items.remove(t),t.destroy()}};function Da(t,e,i,a,o){const n=[];if(e.data.components[o].iterateVertices((t=>{n.push(a.toXYZ(t.pos,St.get()))})),0===o&&null!=i&&n.push(a.toXYZ(i,St.get())),n.length<2)return n;const s=n[0],r=n[n.length-1];return"polygon"===t.type&&n.length>2&&!E(s,r)&&n.push(s),n}function Ga(t,e,i,a){if("2d"===e.type)return!0;const o=lt(a)??1,n=pt(a),s=t=>X(e,t,a,i,Z)??0;for(let e=1;e<t.length;++e){const i=t[e-1],a=t[e],r=(a[0]-i[0])*o,l=(a[1]-i[1])*o,p=(s(a)-s(i))*n;if(Math.abs(p)/Math.sqrt(r*r+l*l)>Ra)return!1}return!0}t([M()],Ia.prototype,"context",void 0),t([M()],Ia.prototype,"stagedVertex",void 0),t([M()],Ia.prototype,"visible",void 0),t([M()],Ia.prototype,"edgeDistance",void 0),t([M()],Ia.prototype,"updating",null),t([M()],Ia.prototype,"_messagesUnits",void 0),t([M()],Ia.prototype,"_edgeDistancePixels",null),t([M()],Ia.prototype,"_colors",null),Ia=t([w("esri.views.interactive")],Ia);const Ra=at(5),Ca=vt(),La=vt(),Pa=K(),ka=K();let Ua=class extends Ia{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:i},a,o=K()){const{spatialReference:n}=i.data.coordinateHelper;return zt(a,n,e,t,Va),t.state.camera.projectToScreen(Va,o),o}};Ua=t([w("esri.views.3d.interactive.SegmentLabels3D")],Ua);const Va=H();function za(t){const{graphic:e}=t;return[m((()=>t.displaying),(t=>{t?function(t){const{geometry:e}=t;Fa(e)&&t.notifyMeshTransformChanged({action:Ft.EnableFastUpdates})}(e):Ha(e)}),{..._}),r((()=>Ha(e)))]}function Ha(t){const{geometry:e}=t;Fa(e)&&t.notifyMeshTransformChanged({action:Ft.DisableFastUpdates})}function Fa(t){return"mesh"===t?.type&&"georeferenced"!==t.vertexSpace.type}let Na=class extends Jt{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new Nt({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new J({mode:t,offset:e});const i=this.geometryToPlace;i&&this.addHandles([m((()=>i.vertexSpace.origin),(()=>this.graphic?.notifyMeshTransformChanged()),v),m((()=>i.vertexAttributes),(()=>this.graphic?.notifyGeometryChanged()),v)])}normalizeCtorArgs(t){if(!t.elevationInfo){const e=t.hasZ??!0;return{...t,elevationInfo:Y(e)}}return t}initializeGraphic(t){const{view:e}=this,i=this._createGraphicState=new qt({graphic:t});return l([e.maskOccludee(t),e.trackGraphicState(i),m((()=>({element:this._outlineVisualElement,isDraped:i.isDraped})),(({element:t,isDraped:e})=>{t&&(t.isDraped=e)}),_),this._setupLoadingIndicator(i),...za(i)])}updateDrawMeshTooltipInfo(t){const{graphic:e,sketchOptions:i,view:a}=this;t.sketchOptions=i,t.viewType=a.type,t.helpMessage=se(e,this.view),this.updateElevation(t.elevation)}makeDrawOperation(){const{geometryType:t}=this,e="circle"!==t&&"rectangle"!==t;return new ae({view:this.view,manipulators:this.manipulators,geometryType:Kt(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new oe(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new ne(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new Ht,segmentLabels:e?new Ua:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===B(this.hasZ,this.elevationInfo),cursor:this.cursor,constraintsEnabled:!0})}onActiveVertexChanged(t){const{view:e}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[t],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(t),r();const i=this._settings,a=i.manipulators.vertex,n=new Yt({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=n;const s=i.visualElements.zVerticalLine,p=new Zt({view:e,extensionType:s.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Qt.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=p;const h=l([m((()=>i.visualElements.zVerticalLine),(t=>t.apply(p)),y),m((()=>({selectedColor:o(i.colors.selected),outlineColor:o(i.manipulators.vertex.outlineColor)})),(({selectedColor:t,outlineColor:e})=>{n.color=t,n.outlineColor=e}),y),r((()=>{this._activeVertexVisualElement=u(this._activeVertexVisualElement),this._verticalLineVisualElement=u(this._verticalLineVisualElement)}))]);return n.attached=!0,this._updateVerticalLineVisualElement(t),h}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(!e)return;const{renderCoordsHelper:i,elevationProvider:a}=this.view;T(Za,t[0],t[1],t[2]),Xa.setFromElevationInfo(this.elevationInfo),Za[2]=Bt(Za,a,Xa,i),i.toRenderCoords(Za,this.view.spatialReference,Za)?(e.setStartEndFromWorldDownAtLocation(Za),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=t,r();const e=this.internalGraphicsLayer.elevationInfo,{view:i}=this,a=this._settings,o=new Xt({view:i,geometry:t,elevationInfo:e,isDraped:this._createGraphicState?this._createGraphicState.isDraped:"on-the-ground"===B(this.hasZ,e),attached:!1,isDecoration:!0});this._outlineVisualElement=o;const n=l([m((()=>a.visualElements.lineGraphics.outline),(t=>t.apply(o)),y),m((()=>a.visualElements.lineGraphics.shadowStyle),(t=>t.apply(o)),y),r((()=>{this._outlineVisualElement=u(this._outlineVisualElement)}))]);return o.attached=!0,o.laserlineEnabled=!0,n}onRegularVerticesChanged(t){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=t,r();const{view:e}=this,i=this._settings,a=i.manipulators.vertex,n=new Yt({view:e,spatialReference:e.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:a.size,outlineSize:a.outlineSize,renderOccluded:a.renderOccluded,attached:!1,isDecoration:!0}),s=l([m((()=>({color:o(i.manipulators.vertex.color),outlineColor:o(i.manipulators.vertex.outlineColor)})),(({color:t,outlineColor:e})=>{n.color=t,n.outlineColor=e}),y),r((()=>{this._verticesVisualElement=u(this._verticesVisualElement)}))]);return n.attached=!0,this._verticesVisualElement=n,s}updateGraphicGeometry(t){if("mesh"!==this.geometryType||"point"!==t?.type)super.updateGraphicGeometry(t);else{const e=this.geometryToPlace;e?.centerAt(t);const i=this._graphic;e&&i.geometry===e||(i.geometry=e)}}_setupLoadingIndicator(t){const{drawOperation:e}=this;if(!this.geometryToPlace)return e.loading=!1,null;e.loading=!0;const i=r((()=>{e.loading=!1}));let a;const o=()=>a&&cancelAnimationFrame(a);return l([f((()=>t.displaying),(()=>{o(),a=requestAnimationFrame((()=>i.remove()))}),{..._,once:!0}),r(o),i])}};t([M({constructOnly:!0})],Na.prototype,"elevationInfo",void 0),t([M({constructOnly:!0})],Na.prototype,"geometryType",void 0),t([M()],Na.prototype,"type",void 0),t([M({constructOnly:!0})],Na.prototype,"view",void 0),Na=t([w("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Na);const Xa=new Wt,Za=H();function Ya(t){if(null==t||"polyline"!==t.type&&"polygon"!==t.type)return 0;const e="polyline"===t.type?t.paths:t.rings;for(const t of e)for(let e=0;e<t.length-1;e++){const i=t[e],a=t[e+1],o=i[0]-a[0],n=i[1]-a[1];if(o*o+n*n>xe)return Math.atan2(a[1]-i[1],a[0]-i[0])}return 0}var Ba,Wa;!function(t){t[t.NONE=0]="NONE",t[t.ANY=1]="ANY",t[t.Z=2]="Z",t[t.XY=4]="XY"}(Ba||(Ba={})),function(t){t[t.TRANSLATE_Z=0]="TRANSLATE_Z",t[t.TRANSLATE_XY=1]="TRANSLATE_XY",t[t.SCALE=2]="SCALE",t[t.ROTATE=3]="ROTATE",t[t.SCALE_ROTATE=4]="SCALE_ROTATE"}(Wa||(Wa={}));class qa{constructor(){this.grabbingState=Ba.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=Ba.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator(((t,e)=>{if(e===Wa.TRANSLATE_Z&&(this.zManipulator=t),t instanceof _e&&(t.selected&&(0===this.numSelected&&(this.firstSelected=t),this.numSelected++),null==this.firstGrabbedXY&&t.grabbing&&e===Wa.TRANSLATE_XY&&(this.firstGrabbedXY=t)),t.grabbing)switch(this.grabbingState|=Ba.ANY,e){case Wa.TRANSLATE_Z:this.grabbingState|=Ba.Z;break;case Wa.TRANSLATE_XY:this.grabbingState|=Ba.XY}}))}}function Qa(t){return null!=t.geometry&&("polygon"===t.geometry.type||"polyline"===t.geometry.type)}const Ja=H();function Ka(t){const{view:e,graphic:i}=t,a=new qt({graphic:i}),o=[],n=function(t,e,i){const{view:a,graphic:o}=t,n=new Ue({view:a,geometry:$a(o),elevationInfo:W(o),isDecoration:!0});return function(t,e,i,a){const o=new Nt({getTheme:()=>t.view.effectiveTheme});(function(t,e,i,a){const{view:o,graphic:n}=t;let s=null;const r=()=>{const t=$a(n);(t=>{null!=s&&(s.remove(),s=null),i.isDraped&&null!=t&&(s=function(i,a,o){const n=i.elevationProvider.spatialReference;Ge(a,to,n);const s=to[0],r=to[1];return i.elevationProvider.on("elevation-change",(i=>{ke(i.extent,s,r)&&(e.geometry=t)}))}(o,t))})(t),e.geometry=t};a.push(i.on("changed",r),c((()=>s))),r()})(t,e,i,a),o.visualElements.pointGraphics.outline.apply(e),a.push(m((()=>i.displaying),(()=>{e.attached=i.displaying}),y))}(t,n,e,i),i.push(h(n)),n}(t,a,o);return function(t,e,i,a){const{view:o,graphic:n}=t,s=new Nt({getTheme:()=>o.effectiveTheme}),r=new Zt({view:o,extensionType:s.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Qt.OccludeAndTransparent,isDecoration:!0});i.push(m((()=>s.visualElements.zVerticalLine),(t=>t.apply(r)),y));const l=new De({view:o,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),p=at(s.visualElements.heightPlaneAngleCutoff),c=new De({view:o,attached:!1,angleCutoff:p,isDecoration:!0}),u=W(t.graphic),d=Wt.fromElevationInfo(u),g="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,_=new qa,f=Ie(1);i.push(m((()=>({heightPlane:s.visualElements.heightPlane,alpha:f.value})),(({heightPlane:t,alpha:e})=>t.apply(c,e)),y));const v=Ie(1);i.push(m((()=>({shadowStyle:s.visualElements.pointGraphics.shadowStyle,alpha:v.value})),(({shadowStyle:t,alpha:e})=>t.apply(l,e)),y));const M=()=>{_.update(t);const i=$a(n),p=g&&(e.isDraped||null==i||!i.hasZ);let h=!0;if(p||null==i)h=!1;else{const t=Bt(i,o.elevationProvider,d,o.renderCoordsHelper);T(to,i.x,i.y,t),Re(to,i.spatialReference,to,o.renderCoordsHelper.spatialReference),r.setStartEndFromWorldDownAtLocation(to),l.intersectsWorldUpAtLocation=to}const u=_.grabbingState&Ba.Z?s.visualElements.laserlineAlphaMultiplier:1;f.value=u;const m=Le(eo);!p&&e.displaying&&a.calculateMapBounds(m)&&Re(Pe(m,to),o.spatialReference,to,o.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=to,c.attached=!0):c.attached=!1;const y=_.grabbingState&Ba.XY?s.visualElements.laserlineAlphaMultiplier:1;v.value=y;const M=h&&e.displaying&&!p;l.attached=M,r.attached=M};i.push(m((()=>[e.displaying,e.isDraped]),M),e.on("changed",M)),t.forEachManipulator((t=>{i.push(t.events.on("grab-changed",M))})),i.push(h(l)),i.push(h(r)),i.push(h(c)),M()}(t,a,o,n),o.push(e.trackGraphicState(a)),{visualElement:n,remove:()=>p(o)}}function $a(t){const e=t.geometry;return null==e?null:"point"===e.type?e:"mesh"===e.type?e.anchor.clone():null}const to=H(),eo=Ce();function io(t){switch(t.graphic.geometry.type){case"point":case"mesh":return Ka(t);case"polygon":case"polyline":return function(t){const{view:e,graphic:i}=t,a=new qt({graphic:i}),o=function(t,e){const{view:i,graphic:a}=t,o=new Xt({view:i,geometry:Qa(a)?a.geometry:null,elevationInfo:W(a),attached:!1,isDecoration:!0}),n=new Nt({getTheme:()=>i.effectiveTheme}),s=()=>{o.attached=e.displaying},r=l([m((()=>n.visualElements.lineGraphics.outline),(t=>t.apply(o)),y),m((()=>n.visualElements.lineGraphics.shadowStyle),(t=>t.apply(o)),y),m((()=>e.displaying),s),m((()=>e.isDraped),(t=>{o.isDraped=t})),e.on("changed",(()=>o.geometry=Qa(a)?a.geometry:null)),h(o)]);return s(),{visualElement:o,remove:()=>r.remove()}}(t,a),n=function(t,e,i){const{graphic:a,view:o}=t,n=[],s=W(a),r="on-the-ground"===s.mode||!s.offset&&"absolute-height"!==s.mode,u=new qa,d=new Nt({getTheme:()=>o.effectiveTheme}),g=d.visualElements,_=new Zt({view:o,extensionType:g.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:Qt.OccludeAndTransparent,isDecoration:!0}),f=at(g.heightPlaneAngleCutoff),v=new De({view:o,attached:!1,angleCutoff:f,isDecoration:!0}),M=Ie(1);n.push(m((()=>({lineShadowStyle:d.visualElements.lineGraphics.shadowStyle,pointShadowStyle:d.visualElements.pointGraphics.shadowStyle,alpha:M.value})),(({lineShadowStyle:t,pointShadowStyle:i,alpha:a})=>{t.apply(e,a),i.apply(_,a)}),y));const b=Ie(1);n.push(m((()=>({heightPlane:d.visualElements.heightPlane,alpha:b.value})),(({heightPlane:t,alpha:e})=>t.apply(v,e)),y));const S=()=>{if(u.update(t),!i.displaying||r&&(i.isDraped||!Qa(a)||!a.geometry.hasZ))return e.laserlineEnabled=!1,_.attached=!1,void(v.attached=!1);e.laserlineEnabled=!0;const o=u.grabbingState&Ba.XY?g.laserlineAlphaMultiplier:1;M.value=o;const n=u.grabbingState&Ba.Z?g.laserlineAlphaMultiplier:1;b.value=n,function(t,e){const i=1===e.numSelected?e.firstSelected:e.numSelected>1&&null!=e.firstGrabbedXY?e.firstGrabbedXY:null;null!=i?(t.setStartEndFromWorldDownAtLocation(i.renderLocation),t.attached=!0):t.attached=!1}(_,u),function(t,e,i,a){if(a.numSelected>0){T(Ja,0,0,0);let e=0;t.forEachManipulator(((t,i)=>{i===Wa.TRANSLATE_XY&&t.selected&&t instanceof _e&&(O(Ja,Ja,t.renderLocation),e++)})),e>0?(i.heightManifoldTarget=j(Ja,Ja,1/e),i.attached=!0):i.attached=!1}else{const a=e.attachmentOrigin;null!=a&&t.view.renderCoordsHelper.toRenderCoords(a,Ja)?(i.heightManifoldTarget=Ja,i.attached=!0):i.attached=!1}}(t,e,v,u)};n.push(m((()=>d.visualElements.zVerticalLine),(t=>t.apply(_)),y)),n.push(i.on("changed",S),m((()=>i.displaying),S),e.events.on("attachment-origin-changed",S),h(_),h(v));const x=[],w=()=>{p(x),x.length=0,t.forEachManipulator((t=>x.push(t.events.on("grab-changed",S)))),t.forEachManipulator((t=>x.push(t.events.on("select-changed",S)))),S()};return w(),n.push(t.onManipulatorsChanged(w),c((()=>l(x)))),l(n)}(t,o.visualElement,a),s=[o,n,e.maskOccludee(i),e.trackGraphicState(a)];return{visualElement:o.visualElement,remove:()=>p(s)}}(t);default:return null}}const ao=70,oo=Math.ceil(ao/3*2),no=5*Math.PI/12,so=1*Math.PI/3;class ro{constructor(){this._available=!0}set location(t){this._forEachManipulator3D((e=>e.location=t))}set elevationAlignedLocation(t){this._forEachManipulator3D((e=>e.elevationAlignedLocation=t))}set elevationInfo(t){this._forEachManipulator3D((e=>e.elevationInfo=t))}get renderLocation(){let t;return this._forEachManipulator3D((e=>{t||(t=e.renderLocation)})),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D((e=>e.available=t))}get hovering(){return this.someManipulator((t=>t.hovering))}get grabbing(){return this.someManipulator((t=>t.grabbing))}get dragging(){return this.someManipulator((t=>t.dragging))}hasManipulator(t){return this.someManipulator((e=>e===t))}someManipulator(t){let e=!1;return this.forEachManipulator((i=>{!e&&t(i)&&(e=!0)})),e}_forEachManipulator3D(t){this.forEachManipulator(((e,i)=>{e instanceof _e&&t(e,i)}))}}function lo(t,e,i,a){const o=(i,a)=>e({action:i,graphic:t,dxScreen:a.screenDeltaX,dyScreen:a.screenDeltaY});return i(((e,i,n)=>(i.next((t=>("start"===t.action&&o("start",t),t))).next(si(t,a)).next((t=>{switch(t.action){case"start":case"update":(t.translationX||t.translationY||t.translationZ)&&o("update",t);break;case"end":o("end",t)}return t})),{steps:i,cancel:n=n.next(ri(t)).next((t=>(o("end",{screenDeltaX:0,screenDeltaY:0}),t)))})))}function po(t){if(null==t?.axis)return 1;const{mapStart:e,mapEnd:i,axis:a}=t,o=[i.x-e.x,i.y-e.y];return o[0]*a[0]+o[1]*a[1]>0?1:-1}class ho extends ro{constructor(t){super(),this._handles=new Ve,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=ao,this._updateAfterDrag=!1,this.events=new le,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),null!=t.radius&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=u(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,Wa.TRANSLATE_XY)}createGraphicDragPipeline(t,e,i){const a=e.graphic,o=W(a),n=a.geometry.spatialReference;return lo(a,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),o,n,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){return l(this._arrowManipulatorInfos.map((({manipulator:o},n)=>li(o,((o,s,r,l,p)=>{const h=s.next((t=>({...t,manipulatorType:Wa.TRANSLATE_XY}))).next(pi(this._view,o.elevationAlignedLocation)).next($e(this._view,o.elevationAlignedLocation,e,i,a)).next(hi(o.location,this.angle+(n+1)*Math.PI*.5)).next(ci());t(o,h,r,l,p)})))))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},i){const a=this._radius/ao,o=54*a,n=o*Math.sqrt(3)/2,s=Mi(this._opaqueMaterial,n,o/2,o/2,.02);bi(s,ze(xt.get(),T(St.get(),0,-n/3,0))),t.renderObjects=[new fe(s,ji.Focused),new fe(s.instantiate({material:this._transparentMaterial}),ji.Unfocused)],t.radius=n/3*2*1.2;const r=He(xt.get(),i*Math.PI/2),l=ze(xt.get(),T(St.get(),0,100*a,0));Fe(e,r,l)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=Ne(xt.get(),t,F(0,0,1));if(null==e)return;const i=Xe(xt.get(),T(St.get(),this.displayScale,this.displayScale,this.displayScale)),a=Fe(xt.get(),i,e);for(const t of this._arrowManipulatorInfos){const e=Fe(xt.get(),a,t.transform);t.manipulator.modelTransform=e}}_createArrowManipulator(t){const e=new _e({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:F(0,0,1)}}),i={manipulator:e,transform:Qe()};return this._updateArrowManipulator(i,t),this._handles.add(e.events.on("drag",(t=>{this._updateAfterDrag&&"end"===t.action&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)}))),i}_createMaterial(t=1){const e=new Oi({cullFace:yi.Back,renderOccluded:Qt.Transparent,isDecoration:!0});return this._handles.add(m((()=>tt.toUnitRGBA(this._view.effectiveTheme.accentColor)),(i=>{i[3]*=t,e.setParameters({color:i})}),y)),e}get test(){return{arrowManipulators:this._arrowManipulatorInfos.map((({manipulator:t})=>t))}}}class co{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e=this._lastDragEvent.mapEnd,i=this._snap(this._lastDragEvent.screenEnd);if(null!=i){const a={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:!0===t?i:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(a)}}this._enabled=t}_snap(t){const e=null!=this._view?this._view.toMap(t,{exclude:[]}):null;return null!=e&&null!=this._view&&(e.z=q(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const i=new ui;return this._next=i,[t=>{if(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled){const e=this._snap(t.screenEnd);return null!=e?{action:t.action,mapStart:t.mapStart,mapEnd:e,screenStart:t.screenStart,screenEnd:t.screenEnd}:null}return{action:t.action,mapStart:t.mapStart,mapEnd:t.mapEnd,screenStart:t.screenStart,screenEnd:t.screenEnd}},i]}}class uo extends ro{constructor(t){super(),this._handles=new Ve,this._snapToScene=new co,this._scale=1,this._radius=ao,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),null!=t.snapToScene&&(this.snapToScene=t.snapToScene),null!=t.radius&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles=u(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,Wa.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}createGraphicDragPipeline(t,e,i){const a=e.graphic,o=W(a),n=a.geometry.spatialReference;return lo(a,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),o,n,a)),this._view.state.viewingMode)}createDragPipeline(t,e,i,a){const o=this._view;return li(this._manipulator,((n,s,r,l,p)=>{const h=s.next(pi(o,n.elevationAlignedLocation)).next($e(o,n.elevationAlignedLocation,e,i,a)).next(...this._snapToScene.createDragEventPipelineStep(o,e)).next((t=>({...t,manipulatorType:Wa.TRANSLATE_XY}))).next(ci());t(n,h,r,l,p)}))}_updateManipulatorTransform(){const t=Xe(xt.get(),T(St.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new _e({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:F(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=Si(this._discMaterial,.02,1,128,F(0,0,1),F(0,0,0));t.transformation=Xe(Qe(),F(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new fe(t,ji.Focused),new fe(t.instantiate({material:this._discMaterialTransparent}),ji.Unfocused)],this._manipulator.radius=this._radius/ao*80}_createMaterial(t=1){const e=new Oi({cullFace:yi.Back,renderOccluded:Qt.Transparent,isDecoration:!0});return this._handles.add(m((()=>tt.toUnitRGBA(this._view.effectiveTheme.accentColor)),(i=>{i[3]*=t,e.setParameters({color:i})}),y)),e}get test(){return{discManipulator:this._manipulator}}}class mo extends ro{constructor(t){super(),this._radius=ao,this.events=new le,this._tool=t.tool,this._view=t.view;const e=new Nt({getTheme:()=>this._view.effectiveTheme});this._settings=e,null!=t.radius&&(this._radius=t.radius);const i=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:ve(this._createDarkenedColor(i,1,.25),Qt.Occlude),materialFocused:ve(this._createDarkenedColor(i,1,0),Qt.Occlude),materialOccludedUnfocused:ve(this._createDarkenedColor(i,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:ve(this._createDarkenedColor(i,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=m((()=>this._view.effectiveTheme.accentColor),(t=>{const e=this._createDarkenedColor(t,1,.25),i=this._createDarkenedColor(t,1,0),a=this._createDarkenedColor(t,.7,0),o=this._createDarkenedColor(t,.85,0),{materialUnfocused:n,materialFocused:s,materialOccludedUnfocused:r,materialOccludedFocused:l}=this._materials;n.setParameters({color:e}),s.setParameters({color:i}),r.setParameters({color:a}),l.setParameters({color:o})})),this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._themeHandle=d(this._themeHandle),this._manipulator.applyObjectTransform=vo,this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){t(this._manipulator,Wa.TRANSLATE_Z)}createGraphicDragPipeline(t,e,i){const a=e.graphic.geometry.spatialReference;return lo(e.graphic,i,(e=>this.createDragPipeline(((i,a,o,n,s)=>(({steps:a,cancel:o}=t(i,a,o,n,s)),e(i,a,o))),a)),this._view.state.viewingMode)}createDragPipeline(t,e){const i=this._view;return li(this._manipulator,((a,o,n,s,r)=>{const l=o.next((t=>({...t,manipulatorType:Wa.TRANSLATE_Z}))).next(ti(i,a.renderLocation,e)).next(ci());t(a,l,n,s,r)}))}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/ao,i=t.zManipulator.height*e,a=t.zManipulator.coneHeight*e,o=t.zManipulator.coneWidth*e,n=t.zManipulator.width*e,s=[F(0,0,0),F(0,0,i)],r=[F(0,0,0),F(0,0,i+a)],l=(t=>{const e=Qe();return Ze(e,e,[0,0,i]),Ye(e,e,Math.PI/2),e})(),{materialUnfocused:p,materialFocused:h,materialOccludedUnfocused:c,materialOccludedFocused:u}=this._materials,d=xi(p,s,n/2,16,!1),m=wi(p,a,o/2,16,!1);m.transformation=l,this._manipulator.renderObjects=[new fe(m,ji.Unfocused),new fe(d,ji.Unfocused),new fe(m.instantiate({material:h}),ji.Focused),new fe(d.instantiate({material:h}),ji.Focused),new fe(m.instantiate({material:c}),ji.Unfocused),new fe(d.instantiate({material:c}),ji.Unfocused),new fe(m.instantiate({material:u}),ji.Focused),new fe(d.instantiate({material:u}),ji.Focused)],this._manipulator.radius=n/2+2,this._manipulator.collisionType={type:"line",paths:[r]}}_createManipulator(){const t=this._view,e=new _e({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=e=>{const i=t.state.camera,a=go;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,a);const o=A(i.eye,a),n=i.computeRenderPixelSizeAtDist(o),s=I(_o,a,i.eye);D(s,s);const r=fo;t.renderCoordsHelper.worldUpAtPosition(go,r);const l=Math.abs(G(s,r)),p=R(_o,s,r),h=R(_o,p,r),c=ot(l,.01,1),u=1-Math.sqrt(1-c*c)/c/i.fullWidth,d=this._settings,m=this._radius/ao,g=d.zManipulator.width*m;j(h,D(h,h),(1/u-1)*o+n*g),e[12]-=_o[0],e[13]-=_o[1],e[14]-=_o[2]},this._manipulator=e,this._updateManipulator()}_createDarkenedColor(t,e,i){const a=n(t,i);return a.a*=e,tt.toUnitRGBA(a)}get test(){return{manipulator:this._manipulator}}}const go=H(),_o=H(),fo=H(),vo=()=>{};class yo extends ro{constructor(t){super(),this._handles=new Ve,this._interactive=!0;const{tool:e,view:i,snapToScene:a,radius:o}=t;this._view=i,this.xyManipulation=new uo({tool:e,view:i,snapToScene:a,radius:o}),this.xyAxisManipulation=new ho({tool:e,view:i,radius:o}),this.zManipulation=new mo({tool:e,view:i,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator((t=>this._handles.add(t.events.on("grab-changed",(()=>this._updateManipulatorInteractivity())))))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createGraphicDragPipeline(t,e,i){return l([this.xyManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(bo.XY,e,i,a,o,n)),e,i),this.xyAxisManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(bo.XY_AXIS,e,i,a,o,n)),e,i),this.zManipulation.createGraphicDragPipeline(((e,i,a,o,n)=>t(bo.Z,e,i,a,o,n)),e,i)])}createDragPipeline(t,e,i,a){return l([this.xyManipulation.createDragPipeline(((e,i,a,o,n)=>t(bo.XY,e,i,a,o,n)),e,i,a),this.xyAxisManipulation.createDragPipeline(((e,i,a,o,n)=>t(bo.XY_AXIS,e,i,a,o,n)),e,i,a),this.zManipulation.createDragPipeline(((e,i,a,o,n)=>t(bo.Z,e,i,a,o,n)),i)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator((e=>t(e,Wa.TRANSLATE_XY))),this.xyAxisManipulation.forEachManipulator((e=>t(e,Wa.TRANSLATE_XY))),this.zManipulation.forEachManipulator((e=>t(e,Wa.TRANSLATE_Z)))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator((t=>t.focused))||this.xyAxisManipulation.someManipulator((t=>t.focused));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(b("esri-mobile"))return;const i=[];e.forEachManipulator((t=>i.push(t))),t.forEachManipulator((t=>i.push(t)));const a=()=>{const e=[];this._xyAxisVisible||t.forEachManipulator((t=>e.push(t.disableDisplay()))),this._handles.remove(Mo),this._handles.add(e,Mo)};for(const t of i)this._handles.add(t.events.on("focus-changed",a));this._view.inputManager&&this._handles.add(f((()=>this._view.inputManager?.latestPointerType),a)),a()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator((e=>{e.interactive=!t&&this._interactive||e.grabbing}))}static radiusForSymbol(t){const e=null!=t&&"point-3d"===t.type&&t.symbolLayers;return e&&e.some((t=>"icon"===t.type))?oo:ao}}const Mo="disable-xy-axis-display";var bo;!function(t){t[t.XY=0]="XY",t[t.XY_AXIS=1]="XY_AXIS",t[t.Z=2]="Z"}(bo||(bo={}));class So extends ro{constructor(t){super(),this._view=t.view,this._tool=t.tool,this._graphicState=t.graphicState,this._createManipulator(),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}forEachManipulator(t){t(this._manipulator,Wa.TRANSLATE_XY)}createGraphicDragPipeline(t){return lo(this._graphicState.graphic,t,(t=>this.createDragPipeline(t)),this._view.state.viewingMode)}createDragPipeline(t){const e=this._view,i=this._graphicState.graphic,a=null!=i.geometry?i.geometry.spatialReference:null;return li(this._manipulator,((o,n,s,r,l)=>{const p=n.next(ei(l,e,i,a)).next(di()).next(ci());t(o,p,s,r,l)}))}_createManipulator(){const t=this._view,e=this._graphicState.graphic;this._manipulator=new Ii({graphic:e,view:t,selectable:!0,cursor:"move"})}}class xo{constructor(t){this.allGraphics=t,this.type="graphic-move-start"}}class wo{constructor(t,e,i){this.dx=t,this.dy=e,this.allGraphics=i,this.type="graphic-move"}}class Eo{constructor(t){this.allGraphics=t,this.type="graphic-move-stop"}}const To="manipulators";let Oo=class extends(le.EventedMixin(mi)){constructor(t){super(t),this._infos=new Map,this.graphics=new re,this.enableZ=!0,this.sketchOptions=new we,this.type="move-3d",this.tooltip=null,this._updatingHandles=new me,this._moveManipulation=null,this._latestTooltipInfo=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{view:t}=this;this.addHandles([this.graphics.on("change",(t=>{t.removed.forEach((t=>this.removeHandles(t))),this._updateGraphicInfos(t),this._setupFastTransformUpdates(t.added),this._refreshManipulators()})),m((()=>this.sketchOptions.tooltips.effectiveEnabled),(e=>{this.tooltip=e?new Ui({info:this._latestTooltipInfo,view:t}):u(this.tooltip)}),_)]);const e=this.graphics.toArray();this._updateGraphicInfos({added:e,removed:[]}),this._setupFastTransformUpdates(e),this._refreshManipulators(),this.finishToolCreation()}destroy(){this.tooltip=u(this.tooltip),this._moveManipulation=u(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:t,removed:e}){for(const e of t){if(Ee(e)!==Te.SUPPORTED)continue;const t=new jo(e),i=this.view.trackGraphicState(t.state);this._infos.set(t.graphic,{info:t,handle:i})}for(const t of e)this._infos.get(t)?.handle.remove(),this._infos.delete(t)}_setupFastTransformUpdates(t){for(const e of t){const{info:t}=this._infos.get(e);this.addHandles(za(t.state),e)}}_refreshManipulators(){if(this.removeHandles(To),this._moveManipulation=u(this._moveManipulation),this.manipulators.removeAll(),0===this._infos.size)return;const t=Array.from(this._infos.values(),(({info:t})=>t));this._createManipulators(t),this._createVisualElements(t),this._updateMoveManipulation(t)}_createManipulators(t){for(const e of t){const i=e.state;e.manipulationXY=new So({tool:this,view:this.view,graphicState:i}),e.manipulationXY.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(t=>{this.emit("immediate-click",{...t,graphic:i.graphic}),t.stopPropagation()})),t.events.on("grab-changed",(({action:t})=>{"start"===t?this._showTooltip(bo.XY):this._hideTooltip()}))],To))),this.addHandles(e.manipulationXY.createDragPipeline(((e,i,a,o)=>this._buildDragEventPipeline(t,bo.XY,e,i,a,o))),To)}this._createMoveManipulation(t)}_createMoveManipulation(t){const e=new yo({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===t.length?yo.radiusForSymbol(t[0].graphic.symbol):ao});this._moveManipulation=e,e.elevationInfo={mode:"absolute-height",offset:0},e.forEachManipulator((t=>{this.addHandles(t.events.on("immediate-click",(i=>{e.zManipulation.hasManipulator(t)||1!==this.graphics.length||this.emit("immediate-click",{...i,graphic:this.graphics.at(0)}),i.stopPropagation()})),To)}));const i=t=>e=>{this.addHandles([e.events.on("focus-changed",(({action:e})=>{"focus"===e?this._showTooltip(t):this._hideTooltip()})),e.events.on("grab-changed",(()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=pe)}))],To)};this._moveManipulation.xyManipulation.forEachManipulator(i(bo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(bo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(bo.Z));const a=()=>this._updateMoveManipulation(t);for(const e of t)this.addHandles([e.state.on("changed",a),m((()=>e.state.displaying),a)],To);const o=t[t.length-1];this.addHandles(o.state.on("changed",(()=>this._updateMoveManipulationAngle(o))),To),this.addHandles(e.createDragPipeline(((e,i,a,o,n)=>this._buildDragEventPipeline(t,e,i,a,o,n)),W(o.graphic),o.graphic.geometry.spatialReference,o.graphic),To),this._updateMoveManipulationAngle(o)}_createVisualElements(t){for(const e of t){const i=e.graphic,a=io({view:this.view,graphic:i,forEachManipulator:t=>{e.manipulationXY?.forEachManipulator(t),this._moveManipulation?.forEachManipulator(t)},onManipulatorsChanged:()=>r()});null!=a&&(e.geometryRepresentation=a.visualElement,e.geometryRepresentation instanceof Xt&&this.addHandles([e.geometryRepresentation.events.on("attachment-origin-changed",(()=>{e.state.isDraped||this._updateMoveManipulation(t)})),m((()=>e.state.isDraped),(()=>this._updateMoveManipulation(t)))],To),this.addHandles(a,To))}}_updateMoveManipulationAngle(t){this._moveManipulation&&(this._moveManipulation.angle=Ya(t.graphic.geometry))}_updateMoveManipulation(t){const e=ge(0,0,0,this.view.spatialReference);let i=0,a=!1;const o=this._moveManipulation;if(o){for(const o of t){if(!o.state.displaying)continue;const t=o.state.graphic;this.enableZ&&Ae(t)&&(a=!0);const n=o.geometryRepresentation instanceof Xt&&!o.state.isDraped?o.geometryRepresentation.attachmentOrigin:ye(this.view,t);if(null!=n){const{x:t,y:a,z:o}=n;e.x+=t,e.y+=a,o&&(e.z??=0,e.z+=o),i++}}i>0?(e.x/=i,e.y/=i,e.z??=0,e.z/=i,o.location=e,o.xyManipulation.available=!0,o.xyAxisManipulation.available=!0,o.zManipulation.available=a):o.available=!1}}_buildDragEventPipeline(t,e,i,a,o,n){const s=[],r=[];let l=null,p=null;const h=()=>{for(const t of s)t.dragging=!1;s.length=0,r.length=0,l=null,p=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===t.length&&e===bo.XY){const e=t[0].graphic;({steps:a,cancel:o}=this._buildSnappingPipelineSteps(e,W(e),a,o,n))}return o=o.next((t=>p?.(t))).next((()=>(this.emit("graphic-move-stop",new Eo(r)),this.destroyed||h(),null))),{steps:a=a.next((e=>{if("start"===e.action){s.length=0,r.length=0;for(const e of t)e.dragging||!e.manipulationXY?.hasManipulator(i)&&e.manipulationXY?.grabbing||(s.push(e),r.push(e.graphic),e.dragging=!0);if(0!==r.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=gi(r,this.view.state.viewingMode),p=_i(r),this.emit("graphic-move-start",new xo(r)),this.destroyed))return null}return 0!==r.length?e:null})).next((t=>l?.(t))).next((t=>(this._updateMoveTooltip(e,t),t))).next((t=>{switch(t.action){case"start":case"update":if(t.translationX||t.translationY||t.translationZ){const e=this.view.toScreen(t.mapStart),i=this.view.toScreen(t.mapEnd),a=i.x-e.x,o=i.y-e.y;if(this.emit("graphic-move",new wo(a,o,r)),this.destroyed)return null}break;case"end":if(this.emit("graphic-move-stop",new Eo(r)),this.destroyed)return null;h()}return null})),cancel:o}}_showTooltip(t){this._updateMoveTooltip(t),this._latestTooltipInfo&&(this._latestTooltipInfo.distance=pe)}_hideTooltip(){this.tooltip?.clear(),this._latestTooltipInfo=null}_updateMoveTooltip(t,e){const{sketchOptions:i,tooltip:a}=this;switch(t){case bo.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??=new Fi({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,((t,e)=>Pt(t,e)));break;case bo.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??=new Hi({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,((t,i)=>he(Pt(t,i),po(e))));break;case bo.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??=new zi({sketchOptions:i}),this._updateMoveTooltipDistance(this._latestTooltipInfo,e,Lt)}this._latestTooltipInfo.sketchOptions=i,a&&(a.info=this._latestTooltipInfo)}_updateMoveTooltipDistance(t,e,i){if(null==e||"end"===e.action)return;const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:pe}_buildSnappingPipelineSteps(t,e,i,a,o){const n=t.geometry;if(null==n||"point"!==n.type&&"mesh"!==n.type)return{steps:i,cancel:a};const s=("point"===n.type?n:n.anchor).clone(),r=new Pi({elevationInfo:e,pointer:o,editGeometryOperations:Di.fromGeometry(s,this.view.state.viewingMode),visualizer:new Ht,excludeFeature:t}),l=this.snappingManager,{snappingStep:p,cancelSnapping:h}=ki({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(h),{steps:i=i.next((e=>(s.z=Q(this.view,s,W(t),{mode:"absolute-height",offset:0}),{...e,snapOrigin:r.coordinateHelper.pointToVector(s)}))).next(...p),cancel:a}}};t([M({constructOnly:!0,nonNullable:!0})],Oo.prototype,"view",void 0),t([M()],Oo.prototype,"graphics",void 0),t([M({constructOnly:!0,nonNullable:!0})],Oo.prototype,"enableZ",void 0),t([M({constructOnly:!0,type:we})],Oo.prototype,"sketchOptions",void 0),t([M({constructOnly:!0})],Oo.prototype,"snappingManager",void 0),t([M()],Oo.prototype,"type",void 0),t([M()],Oo.prototype,"updating",null),t([M()],Oo.prototype,"tooltip",void 0),Oo=t([w("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],Oo);class jo{constructor(t){this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new qt({graphic:t})}get graphic(){return this.state.graphic}}function Ao(t,e,i){const a="on-the-ground"===i.mode?Gi.XY:Gi.XYZ;return new Ri(t,a,e,0)}function Io(t,e,i){const a=H();if(!t.renderCoordsHelper.toRenderCoords(e,a))return null;const o=Do(t,e,wt(i.plane)),n=Do(t,e,i.edgeDirection);if(null==o||null==n)return null;const s=R(H(),o,n);return Et(a,s,Tt())}function Do(t,e,i){const a=ge(e.x+i[0],e.y+i[1],e.z+i[2],e.spatialReference),o=H(),n=H();return t.renderCoordsHelper.toRenderCoords(e,o)&&t.renderCoordsHelper.toRenderCoords(a,n)?C(n,o,n):null}let Go=class extends Vi{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=pe,this.area=null,this.totalLength=null}};t([M()],Go.prototype,"type",void 0),t([M()],Go.prototype,"distance",void 0),t([M()],Go.prototype,"area",void 0),t([M()],Go.prototype,"totalLength",void 0),Go=t([w("esri.views.interactive.tooltip.ReshapeEdgeOffsetTooltipInfo")],Go);let Ro=class extends(le.EventedMixin(et)){constructor(t){super(t),this._selectedIndex=0,this._manipulatorHandles=new Ve,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=Vo.NONE,this._updatingHandles=new me,this._recreatingManipulators=!1,this._settings=new Nt({getTheme:()=>this.view.effectiveTheme}),this._latestTooltipInfo=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null,this._translateVertexTooltipInfo=null,this._translateVertexXYTooltipInfo=null,this._translateVertexZTooltipInfo=null,this._edgeOffsetTooltipInfo=null,this.outputGeometry=null,this._vertexLaserLineVisualElement=null}initialize(){const{graphic:t,view:e}=this,i=this._settings.manipulators,a=i.vertex;this._vertexManipulatorMaterial=ve(o(a.color),a.renderOccluded),this._vertexManipulatorOutlineMaterial=Me(o(a.outlineColor),a.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Me(o(a.hoverOutlineColor),a.renderOccluded);const n=i.edge;this._edgeManipulatorMaterial=ve(o(n.color),n.renderOccluded),this._edgeManipulatorOutlineMaterial=Me(o(n.outlineColor),n.renderOccluded);const s=i.edgeOffset;this._edgeOffsetManipulatorMaterial=ve(o(s.color),s.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=ve(o(s.hoverColor),s.renderOccluded,!1);const r=i.selected;this._selectedManipulatorMaterial=ve(o(r.color),r.renderOccluded),this._selectedManipulatorOutlineMaterial=Me(o(r.outlineColor),r.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Me(o(r.hoverOutlineColor),r.renderOccluded);const l=this._graphicState=new qt({graphic:t});this.tooltip=new Ui({view:e}),this.addHandles([m((()=>{const t=this._settings.manipulators;return{vertexSettings:t.vertex,edgeSettings:t.edge,edgeOffsetSettings:t.edgeOffset,selectedSettings:t.selected}}),(({vertexSettings:t,edgeSettings:e,edgeOffsetSettings:i,selectedSettings:a})=>{t.applyColor(this._vertexManipulatorMaterial),t.applyOutline(this._vertexManipulatorOutlineMaterial),t.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),e.applyColor(this._edgeManipulatorMaterial),e.applyOutline(this._edgeManipulatorOutlineMaterial),i.applyColor(this._edgeOffsetManipulatorMaterial),i.applyHover(this._edgeOffsetManipulatorHoverMaterial),a.applyColor(this._selectedManipulatorMaterial),a.applyOutline(this._selectedManipulatorOutlineMaterial),a.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)})),m((()=>l.displaying),(t=>{for(const e of this._manipulatorInfos)e.manipulator.available=t})),m((()=>({labels:this._segmentLabels,enabled:this.sketchOptions.labels.enabled,edgeOffsetEnabled:this.enableEdgeOffset})),(({labels:t,enabled:e,edgeOffsetEnabled:i})=>{null!=t&&(t.visible=e,t.edgeDistance=i?"far":"default")}),y),m((()=>this.sketchOptions.tooltips.effectiveEnabled),(t=>{this.tooltip.info=t?this._latestTooltipInfo:null}),y),this.view.trackGraphicState(l)])}destroy(){this._segmentLabels=u(this._segmentLabels),this.tooltip=u(this.tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get inputGeometry(){return null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null}set inputGeometry(t){this._recreateEditGeometryAndManipulators(t)}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get graphic(){return this.tool.graphic}get enableZShape(){return this.tool.enableZShape}get enableZVertex(){return this.tool.enableZVertex}get enableMoveGraphic(){return this.tool.enableMoveGraphic}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get sketchOptions(){return this.tool.sketchOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const t=this._manipulatorInfos.filter((t=>t.manipulator.selected&&"vertex"===t.type));this._removeVertices(t)}onManipulatorSelectionChanged(){this.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=u(this._moveManipulation),this._graphicMoveManipulation=u(this._graphicMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(t){if(null==this._editGeometryOperations)return;const e=W(this.graphic);for(const i of this._editGeometryOperations.data.components){const a=t?.byComponentIndex.get(i.index);for(const t of i.vertices){const i=a?.has(t.index);this._createVertexOrEdgeManipulator(t,e,i)}for(const t of i.edges)this._createVertexOrEdgeManipulator(t,e)}this._createGraphicMoveManipulation(),this._createMoveManipulation(e),this._createVisualElements()}get canRedo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canRedo}get canUndo(){return null!=this._editGeometryOperations&&this._editGeometryOperations.canUndo}redo(){if(null==this._editGeometryOperations)return null;const t=this._editGeometryOperations.redo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}undo(){if(null==this._editGeometryOperations)return null;this.emit("undo");const t=this._editGeometryOperations.undo();return null!=t&&(this.outputGeometry=this._editGeometryOperations.data.geometry,this._recreateManipulators()),t}_recreateManipulators(){this._recreatingManipulators||(this._recreatingManipulators=!0,this._removeManipulators(),this._hideTooltip(),this._createManipulators(),this._recreatingManipulators=!1)}_recreateEditGeometryAndManipulators(t){const e={byComponentIndex:new Map};if(null!=t&&null!=this.inputGeometry&&bt(t,this.inputGeometry))for(const t of this._manipulatorInfos)if("vertex"===t.type&&t.manipulator.selected){const{index:i,component:{index:a}}=t.handle,{byComponentIndex:o}=e,n=o.get(a)||new Set;n.add(i),o.set(a,n)}if(this._recreatingManipulators=!0,this._removeManipulators(),this._hideTooltip(),this._editGeometryOperations=u(this._editGeometryOperations),this._segmentLabels=u(this._segmentLabels),null==t)return void(this._recreatingManipulators=!1);const i="mesh"===t.type?t.anchor:t;this._editGeometryOperations=Di.fromGeometry(i,this.view.state.viewingMode),this._createManipulators(e);const a=this.sketchOptions.labels;this._segmentLabels=new Ua({context:{view:this.view,editGeometryOperations:this._editGeometryOperations,elevationInfo:W(this.graphic),labelOptions:a,graphic:this.graphic,graphicState:this._graphicState},visible:a.enabled}),this._recreatingManipulators=!1}_perGraphicManipulatorDragAction(t,e){if("end"===e.action)return e;let i=0;const a=[],o=this._manipulatorInfos.some((t=>"vertex"===t.type&&t.manipulator.selected)),n=t===zo.SELECTED_OR_ALL&&o;for(const t of this._manipulatorInfos)"vertex"===t.type&&(t.manipulator.grabbing||n&&!t.manipulator.selected||a.push(t),i++);if(0===a.length)return e;if(this._moveVertices(a,e),a.length===i){if(this._updateEventState(Vo.MOVING),this.destroyed)return e;this.emit("move",{type:"move",dx:e.screenDeltaX,dy:e.screenDeltaY,mover:this.graphic})}else{if(this._updateEventState(Vo.RESHAPING),this.destroyed)return e;this.emit("reshape",{type:"reshape",mover:this.graphic})}return e}_isMultiVertexSelection(){return this._manipulatorInfos.reduce(((t,e)=>"vertex"===e.type&&e.manipulator.selected?t+1:t),0)>1}_perVertexManipulatorDragAction(t){if(this._updateEventState(Vo.RESHAPING),this.destroyed)return;const{mapDeltaX:e,mapDeltaY:i,mapDeltaZ:a}=t;if(!e&&!i&&!a)return;const o=[];for(const e of this._manipulatorInfos)"vertex"===e.type&&(e.manipulator.selected&&!e.manipulator.grabbing||e===t.info)&&o.push(e);this._moveVertices(o,t,Ci.ACCUMULATE_STEPS),this.emit("reshape",{type:"reshape",mover:this.graphic})}_updateEventState(t){if(t===this._reshapeEventState)return!1;switch(t){case Vo.NONE:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case Vo.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case Vo.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case Vo.MOVING:switch(this._reshapeEventState){case Vo.NONE:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case Vo.RESHAPING:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case Vo.RESHAPING:switch(this._reshapeEventState){case Vo.NONE:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case Vo.MOVING:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;const e=this._reshapeEventState!==t;return this._reshapeEventState=t,e}_createGraphicMoveManipulation(){const{tool:t,view:e}=this,i=this._graphicState;if(this._graphicMoveManipulation=new So({tool:t,view:e,graphicState:i}),this.enableMoveGraphic){let t=null;this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline(((e,i,a)=>{i.next((t=>this._trackNumDragging(t))).next((e=>("start"===e.action&&(t=this._editGeometryOperations.createUndoGroup()),e))).next((t=>this._perGraphicManipulatorDragAction(zo.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(bo.XY,t),t))).next((e=>{"end"===e.action&&(this._hideTooltip(),t=d(t))})),a.next((()=>this._onDragCancel(!0,(()=>t=d(t)))))}))),this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(t,!1))))}else this._graphicMoveManipulation.forEachManipulator((t=>{t.grabbable=!1,t.cursor=null}));this._graphicMoveManipulation.forEachManipulator((t=>this._manipulatorHandles.add(t.events.on("immediate-click",(t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()})))))}_createMoveManipulation(t){const{graphic:e,tool:i,view:a}=this,o=this._graphicState;this._moveManipulation=new yo({tool:i,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Ae(e),snapToScene:!1,radius:yo.radiusForSymbol(e.symbol)}),this._moveManipulation.forEachManipulator((t=>this.addHandles([t.events.on("immediate-click",(i=>{this._moveManipulation.zManipulation.hasManipulator(t)||this._manipulatorInfos.some((t=>t.manipulator.selected))||this.emit("immediate-click",{...i,graphic:e}),i.stopPropagation()})),this._watchAndUpdateGrabState(t,!1)])));const n=t=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{"focus"===e?this._updateTranslateTooltip(t):this._hideTooltip()})))};this._moveManipulation.xyManipulation.forEachManipulator(n(bo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(n(bo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(n(bo.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const s=e.geometry.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline(((a,o,n,s,r)=>{const{snappingStep:l,cancelSnapping:p}=ki({predicate:t=>!!t.info,snappingManager:i.snappingManager,snappingContext:new Pi({editGeometryOperations:this._editGeometryOperations,elevationInfo:t,pointer:r,excludeFeature:e,visualizer:new Ht}),updatingHandles:this._updatingHandles,useZ:!1});return s=s.next((t=>(this._onDragCancel(),t))).next(p),{steps:n=n.next((t=>this._trackNumDragging(t))).next((t=>{const e=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));return t.manipulatorType===Wa.TRANSLATE_XY&&1===e.length?{...t,info:e[0],snapOrigin:e[0].handle.pos}:t})).next(fi(this.view,t,e)).next(...l).next(di()).next((t=>this._perGraphicManipulatorDragAction(zo.SELECTED_OR_ALL,t))).next((t=>(this._updateTranslateTooltip(a,t),t))),cancel:s}}),t,s,e),m((()=>o.displaying),(()=>this._updateMoveManipulationPosition()),y),o.on("changed",(()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()})),m((()=>o.isDraped),(t=>{this._updateMoveManipulationPosition();const e="align-move-manipulation";t?this.addHandles(this.view.elevationProvider.on("elevation-change",(()=>this._updateMoveManipulationPosition())),e):this.removeHandles(e)}),y)])}_createVisualElements(){const{graphic:t,view:e}=this,i=io({view:e,graphic:t,forEachManipulator:t=>{if(!this.destroyed&&!this._recreatingManipulators){this._graphicMoveManipulation.forEachManipulator(t),this._moveManipulation.forEachManipulator(t);for(const e of this._manipulatorInfos)t(e.manipulator,Wa.TRANSLATE_XY)}},onManipulatorsChanged:t=>this.on("manipulators-changed",t)});null!=i&&(this._outlineVisualElement=i.visualElement instanceof Xt?i.visualElement:null),null!=this._outlineVisualElement&&this._manipulatorHandles.add(this._outlineVisualElement.events.on("attachment-origin-changed",(()=>{this._graphicState.isDraped||this._updateMoveManipulationPosition()}))),this._manipulatorHandles.add(i)}_createEdgeOffsetManipulator(t,e=W(this.graphic)){if(t.component.vertices.length<=2)return null;const i=this._settings.manipulators.edgeOffset,a=i.size/2,o=a+i.collisionPadding,n=a/o,s=n*Math.sqrt(3)/2;null==this._edgeOffsetManipulatorGeometryInside&&(this._edgeOffsetManipulatorGeometryInside=Mi(this._edgeOffsetManipulatorMaterial,s,n/2,n/2,i.height,i.offset)),null==this._edgeOffsetManipulatorGeometryOutside&&(this._edgeOffsetManipulatorGeometryOutside=Mi(this._edgeOffsetManipulatorMaterial,-s,n/2,n/2,i.height,-i.offset));const r=[new fe(this._edgeOffsetManipulatorGeometryInside.instantiate(),ji.Unfocused),new fe(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),ji.Focused),new fe(this._edgeOffsetManipulatorGeometryOutside.instantiate(),ji.Unfocused),new fe(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),ji.Focused)],p=new _e({view:this.view,renderObjects:r,elevationInfo:"on-the-ground"!==e.mode||Bi(this.graphic.symbol)?{mode:"absolute-height",offset:0}:e,worldOriented:!1,focusMultiplier:1,radius:o,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionType:{type:"disc",direction:F(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),h=new _e({view:this.view,worldSized:!0,worldOriented:!1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),collisionPriority:-10,cursor:this.enableMoveGraphic?"move":"default",metadata:{deleting:!1}}),c={manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:h,elevationInfo:e,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(c,i.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(c);const u=[];for(const e of[t.leftVertex,t.rightVertex]){const t=this._getManipulatorInfoFromHandle(e);null!=t&&u.push(t.manipulator.events.on("location-update",(()=>this._updateEdgeOffsetManipulator(c))))}c.locationUpdateHandle=l(u),this._manipulatorHandles.add(c.locationUpdateHandle,p),this._manipulatorHandles.add([this._watchAndUpdateGrabState(p,!0),this._watchAndUpdateGrabState(h,!0)],p),this._manipulatorHandles.add(li(p,this._createEdgeOffsetPipeline(c,e)),p),this._manipulatorHandles.add(li(h,((t,i,a,o)=>{if("touch"===o)this._createEdgeOffsetPipeline(c,e)(t,i,a);else if(this.enableMoveGraphic){const o=this.graphic,n=null!=o.geometry?o.geometry.spatialReference:null;i.next((t=>this._trackNumDragging(t))).next(pi(this.view,t.elevationAlignedLocation)).next($e(this.view,t.elevationAlignedLocation,e,n,o)).next(ci()).next(di()).next((t=>this._perGraphicManipulatorDragAction(zo.ALL,t))).next((t=>(this._updateTranslateGraphicTooltip(bo.XY,t),t))).next((t=>{"end"===t.action&&this._hideTooltip()})),a.next((()=>this._onDragCancel(!t.metadata.deleting)))}})),p);const d=t=>{this._manipulatorInfos.some((t=>t.manipulator.selected))?this._clearSelection():this.emit("immediate-click",{...t,graphic:this.graphic}),t.stopPropagation()};return this._manipulatorHandles.add([p.events.on("immediate-click",d),h.events.on("immediate-click",d),p.events.on("focus-changed",(({action:t})=>{const{sketchOptions:e,tooltip:i}=this;if("focus"===t){const t=this._edgeOffsetTooltipInfo??=new Go({sketchOptions:e});t.distance=pe,t.sketchOptions=e,this._updateTooltipAreaOrTotalLength(t),this._latestTooltipInfo=t,i.info=e.tooltips.effectiveEnabled?this._latestTooltipInfo:null}else this._hideTooltip()}))],p),this._manipulatorInfos.push(c),this.manipulators.add(p),this.manipulators.add(h),this.emit("manipulators-changed"),c}_autoHideEdgeOffsetManipulator(t,e){const i=t.manipulator,a=t.edgeManipulator,o=()=>{t.visibilityHandle=d(t.visibilityHandle);const o=this._getManipulatorInfoFromHandle(t.handle.leftVertex),n=this._getManipulatorInfoFromHandle(t.handle.rightVertex),s=null!=o&&null!=n&&function(t,e,i){const a=i.projectToRenderScreen(t,$()),o=i.projectToRenderScreen(e,$());return null!=a&&null!=o?L(I(a,a,o)):0}(o.manipulator.renderLocation,n.manipulator.renderLocation,this.view.state.camera)<e;(!i.focused&&!a.focused||s)&&(i.grabbable=!s,a.grabbable=!s,t.visibilityHandle=l([i.disableDisplay(),r((()=>{i.grabbable=!0,a.grabbable=this.enableMoveGraphic}))]))};this._manipulatorHandles.add([i.events.on("focus-changed",o),a.events.on("focus-changed",o),r((()=>{d(t.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)}))],i),o()}_updateEdgeOffsetManipulator(t){this._updateManipulatorPosition(t);const{coordinateHelper:e}=this._editGeometryOperations.data,i=Io(this.view,t.manipulator.elevationAlignedLocation,Ao(e,t.handle,t.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(t.handle.leftVertex),o=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==a||null==o)return;const n=a.manipulator.renderLocation,s=o.manipulator.renderLocation,r=null!=i?function(t,e,i){const a=wt(t),o=C(H(),e,i),n=R(H(),o,a),s=R(H(),o,n);return Je(o[0],o[1],o[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],0,0,0,0,1)}(i,n,s):Ke;t.manipulator.modelTransform=r,t.edgeManipulator.elevationAlignedLocation=t.manipulator.elevationAlignedLocation,t.edgeManipulator.modelTransform=r;const l=P(I(Po,n,s))/2;t.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(t,e){return(i,a,o)=>{this._clearSelection();const{step:n,cleanup:s}=this._initializeEdgeOffset(t,e);a.next((t=>this._trackNumDragging(t))).next(pi(this.view,i.elevationAlignedLocation)).next(n).next(ii(this.view)).next(ai(this.view,this._editGeometryOperations.data.spatialReference)).next(di()).next(this._applyComputeEdgeOffsetDistanceStep()).next(this._applyEdgeOffsetStep(t)).next(this._showEdgeOffsetTooltip()).next((t=>{"end"===t.action&&s()})),o.next((()=>{i.metadata.deleting||(s(),this._onDragCancel())}))}}_initializeEdgeOffset(t,e){const{view:i}=this,a=this._editGeometryOperations,n=Ao(a.data.coordinateHelper,t.handle,e),s=a.createUndoGroup(),r=Io(i,t.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const e=this._getManipulatorInfoFromHandle(t.handle.leftVertex.leftEdge);null!=e&&this._splitEdgeManipulator(e,1)}if(n.requiresSplitEdgeRight){const e=this._getManipulatorInfoFromHandle(t.handle.rightVertex.rightEdge);null!=e&&this._splitEdgeManipulator(e,0)}const p=()=>new Yi({paths:[[t.handle.leftVertex.pos,t.handle.rightVertex.pos]],spatialReference:a.data.spatialReference}),c=this._settings,u=new Xt({view:i,isDraped:this._graphicState.isDraped,geometry:p(),elevationInfo:t.elevationInfo,width:c.visualElements.lineGraphics.outline.width,attached:!1,isDecoration:!0});let g;const _=()=>{this._cleanEdgeOffsetCollapsedEdges(t),g=d(g)},f=this.on("undo",_);return g=l([m((()=>o(this._accentColor)),(t=>u.color=t),y),h(u),m((()=>this._graphicState.isDraped),(t=>u.isDraped=t)),this._graphicState.on("changed",(()=>u.geometry=p())),s,f]),u.attached=!0,{step:t=>null==n||null==r?(_(),null):{...t,operation:n,plane:r},cleanup:_}}_applyEdgeOffsetStep(t){return e=>{if(this.destroyed||null==e.operation)return e;this._updateEventState(Vo.RESHAPING);const{mapDeltaX:i,mapDeltaY:a,mapDeltaZ:o}=e;return(i||a||o)&&(this._offsetEdge(t,e),this.emit("reshape",{type:"reshape",mover:this.graphic})),e}}_applyComputeEdgeOffsetDistanceStep(){return t=>{const{operation:e,mapEnd:i}=t;return null==e||null==i?t:("start"===t.action&&e.selectArrowFromStartPoint(i),{...t,signedDistance:e.signedDistanceToPoint(i)})}}_showEdgeOffsetTooltip(){return t=>{const{mapEnd:e,signedDistance:i,operation:a}=t,{tooltip:o,sketchOptions:n}=this;if(null!=i){const o=this._edgeOffsetTooltipInfo??=new Go({sketchOptions:n});o.sketchOptions=n,o.distance="end"===t.action?pe:function(t,e,i,a,o){if(t){const t=o.toXYZ(o.pointToVector(i)),n=Ot(a,t,St.get()),s=Qi(n,t,o.spatialReference);if(null!=s)return ce(s.value*Math.sign(e),s.unit)}return ce(e*ht(i.spatialReference),"meters")}(this._graphicState.isDraped,i*a.selectedArrow,e,a.plane,this._editGeometryOperations.data.coordinateHelper),this._updateTooltipAreaOrTotalLength(o),this._latestTooltipInfo=o}else this._latestTooltipInfo=null;return o.info=n.tooltips.effectiveEnabled?this._latestTooltipInfo:null,t}}_cleanEdgeOffsetCollapsedEdges(t){const e=t.handle.leftVertex.leftEdge?.leftVertex,i=t.handle.leftVertex,a=t.handle.rightVertex.rightEdge?.rightVertex,o=t.handle.rightVertex,n=this._editGeometryOperations.data.coordinateHelper,s=[];if(e&&n.distance(e.pos,i.pos)<ko){const t=this._getManipulatorInfoFromHandle(i);null!=t&&s.push(t)}if(n.distance(i.pos,o.pos)<ko||a&&n.distance(a.pos,o.pos)<ko){const t=this._getManipulatorInfoFromHandle(o);null!=t&&s.push(t)}s.length&&this._removeVertices(s)}_computeVertexManipulatorSizeAndOutline(t){const e=t.size/2,i=e+t.collisionPadding;return{size:e/i,outlineSize:(e+t.outlineSize)/i}}_createVertexOrEdgeManipulator(t,e=W(this.graphic),i=!1){const{view:a}=this,o=this._settings;if("edge"===t.type){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(t,e);if(!this.enableMidpoints)return null}if(null==this._vertexManipulatorGeometry||null==this._vertexManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.vertex);this._vertexManipulatorGeometry=Ei(this._vertexManipulatorMaterial,t,16,16),this._vertexManipulatorOutlineGeometry=Ei(this._vertexManipulatorOutlineMaterial,e,16,16)}if(null==this._edgeManipulatorGeometry||null==this._edgeManipulatorOutlineGeometry){const{size:t,outlineSize:e}=this._computeVertexManipulatorSizeAndOutline(o.manipulators.edge);this._edgeManipulatorGeometry=Ei(this._edgeManipulatorMaterial,t,16,16),this._edgeManipulatorOutlineGeometry=Ei(this._edgeManipulatorOutlineMaterial,e,16,16)}const{geometry:n}=this.graphic,s=n?.type,r="point"===s||"mesh"===s?[]:[new fe(this._vertexManipulatorGeometry.instantiate(),Uo.Vertex|ji.Unselected),new fe(this._vertexManipulatorOutlineGeometry.instantiate(),Uo.Vertex|ji.Unfocused|ji.Unselected),new fe(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Uo.Vertex|ji.Focused|ji.Unselected),new fe(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),ji.Selected),new fe(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),ji.Selected|ji.Unfocused),new fe(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),ji.Selected|ji.Focused)];this.enableMidpoints&&r.push(new fe(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),Uo.Edge|ji.Focused|ji.Unselected),new fe(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),Uo.Edge|ji.Focused|ji.Unselected),new fe(this._edgeManipulatorGeometry.instantiate(),Uo.Edge|ji.Unfocused|ji.Unselected),new fe(this._edgeManipulatorOutlineGeometry.instantiate(),Uo.Edge|ji.Unfocused|ji.Unselected));const p=new _e({view:a,renderObjects:r,elevationInfo:e,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer?.visible),metadata:{deleting:!1}});p.selected=i,this._setTypeSpecificManipulatorSettings(p,t,e);const h="edge"===t.type?{manipulator:p,handle:t,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:p,handle:t,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(h),this.manipulators.add(p),this._updateManipulatorPosition(h),"edge"===h.type){const t=[];for(const e of[h.handle.leftVertex,h.handle.rightVertex]){const i=this._getManipulatorInfoFromHandle(e);null!=i&&t.push(i.manipulator.events.on("location-update",(()=>this._updateManipulatorPosition(h))))}h.locationUpdateHandle=l(t),this._manipulatorHandles.add(h.locationUpdateHandle,p)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(p,!0),p);const c=li(p,((t,i,a,o)=>{let n=null;const{snappingStep:s,cancelSnapping:r}=ki({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Pi({editGeometryOperations:this._editGeometryOperations,elevationInfo:e,pointer:o,excludeFeature:this.graphic,visualizer:new Ht}),updatingHandles:this._updatingHandles,useZ:!1});a=a.next((e=>(this._onDragCancel(!t.metadata.deleting,(()=>n=d(n))),e))).next(r),i.next((t=>this._trackNumDragging(t))).next((t=>{if("start"===t.action&&(n=this._editGeometryOperations.createUndoGroup()),"edge"===h.type){const e=this._splitEdgeManipulator(h);return{...t,info:e,snapOrigin:e.handle.pos}}return{...t,info:h,snapOrigin:h.handle.pos}})).next(pi(this.view,t.elevationAlignedLocation)).next(oi(this.view,this.graphic,t.elevationAlignedLocation,t.location.spatialReference,this.graphic)).next(fi(this.view,e,this.graphic)).next(...s).next(di()).next((e=>{this._perVertexManipulatorDragAction(e),"end"===e.action&&(n=d(n)),this._updateTranslateVertexTooltip(t,bo.XY,e)}))}));return this._manipulatorHandles.add([c,p.events.on("immediate-click",(t=>this._manipulatorClickCallback(t,h))),p.events.on("select-changed",(()=>{h.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition()})),p.events.on("focus-changed",(({action:t})=>{"focus"===t&&"edge"!==h.type?this._updateTranslateVertexTooltip(p,bo.XY):this._hideTooltip()}))],p),this.emit("manipulators-changed"),h}_trackNumDragging(t){switch(t.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return t}_onDragCancel(t=!0,e){switch(this._numDragging--,t&&(this.undo(),this.outputGeometry=null!=this._editGeometryOperations?this._editGeometryOperations.data.geometry:null),null!=this.tool.snappingManager&&this.tool.snappingManager.doneSnapping(),this._hideTooltip(),this._reshapeEventState){case Vo.NONE:break;case Vo.MOVING:this.emit("move",{type:"move",dx:0,dy:0,mover:this.graphic});break;case Vo.RESHAPING:this.emit("reshape",{type:"reshape",mover:this.graphic})}e&&e(),this.destroyed||this._updateEventState(Vo.NONE)}_setTypeSpecificManipulatorSettings(t,e,i){const{graphic:a}=this,o=this._settings;switch(e.type){case"vertex":{t.state=Uo.Vertex,t.selectable=!0,t.cursor="move",t.collisionPriority=2;const{size:e,collisionPadding:n}=o.manipulators.vertex;t.radius=e/2+n,t.elevationInfo=i;const{geometry:s}=a,r=s?.type;t.interactive=null!=r&&"point"!==r&&"mesh"!==r;break}case"edge":{t.state=Uo.Edge,t.selectable=!1,t.cursor="copy",t.collisionPriority=-1;const{size:e,collisionPadding:n}=o.manipulators.edge;t.radius=e/2+n,t.elevationInfo="on-the-ground"!==i.mode||Bi(a.symbol)?{mode:"absolute-height",offset:0}:i;break}}}_watchAndUpdateGrabState(t,e){return t.events.on("grab-changed",(i=>this._onGrabStateChanged(t,e,i.action,i.pointerType)))}_onGrabStateChanged(t,e,i,a="mouse"){if(!this._recreatingManipulators){if("start"===i)e&&this._updateSelection(t),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(Vo.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,("touch"!==a||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach((t=>{const{manipulator:e}=t,{geometry:i}=this.graphic,a=i?.type;e.interactive=e.grabbing||!this._numGrabbing&&null!=a&&"point"!==a&&"mesh"!==a,"edgeManipulator"in t&&(t.edgeManipulator.interactive=t.edgeManipulator.grabbing||!this._numGrabbing)})),this._graphicMoveManipulation.forEachManipulator((t=>{t.interactive=t.grabbing||!this._numGrabbing})))}}_clearSelection(){for(const t of this._manipulatorInfos)t.manipulator.grabbing||(t.manipulator.selected=!1)}_updateSelection(t){t.grabbing&&!t.selected&&t.selectable&&(this._clearSelection(),t.selected=!0,this.emit("manipulators-changed"))}_removeManipulator(t){null!=t&&(t.manipulator.metadata.deleting=!0,this.manipulators.remove(t.manipulator),this._manipulatorHandles.remove(t.manipulator),S(this._manipulatorInfos,t),this.emit("manipulators-changed"))}_getManipulatorInfoFromHandle(t){if(t)for(const e of this._manipulatorInfos)if(t===e.handle)return e;return null}_updateManipulatorPosition(t){if(null==t)return;const e=this._editGeometryOperations;if("vertex"===t.type)t.manipulator.location=e.data.coordinateHelper.vectorToDehydratedPoint(t.handle.pos,Lo),t.manipulator.grabbing&&null!=this._vertexLaserLineVisualElement&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=t.manipulator.renderLocation);else if("edge"===t.type){const i=this._getManipulatorInfoFromHandle(t.handle.leftVertex),a=this._getManipulatorInfoFromHandle(t.handle.rightVertex);if(null==i||null==a)return;const o=i.manipulator,n=a.manipulator;if(null!=t.manipulator.elevationInfo&&"on-the-ground"===t.manipulator.elevationInfo.mode){const i=o.location,a=n.location,s=.5,r=i.x+s*(a.x-i.x),l=i.y+s*(a.y-i.y),p=i.hasZ&&a.hasZ?0:void 0;t.manipulator.location=ge(r,l,p,e.data.spatialReference)}else k(Po,o.renderLocation,n.renderLocation,.5),t.manipulator.renderLocation=Po}}_splitEdgeManipulator(t,e=.5){const i=this._editGeometryOperations,a=i.splitEdge(t.handle,e).createdVertex;t.locationUpdateHandle=d(t.locationUpdateHandle);const o=W(this.graphic);let n;this.enableEdgeOffset?(this._removeManipulator(t),n=this._createVertexOrEdgeManipulator(a)):(n=t,n.handle=a,n.type="vertex",this._setTypeSpecificManipulatorSettings(t.manipulator,t.handle,o)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(n),this.enableEdgeOffset||this._updateTranslateVertexTooltip(n.manipulator,bo.XY),this._updateSelection(t.manipulator);const s=this._updateEventState(Vo.RESHAPING),r=i.data.coordinateHelper.vectorToArray(n.handle.pos),l=i.data.components.indexOf(a.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),s&&this._updateEventState(Vo.NONE),n}_updateMoveManipulationPosition(){const t=T(Po,0,0,0);let e=0,i=!1,a=null,o=null;for(const n of this._manipulatorInfos)"vertex"===n.type&&(n.manipulator.selected?(e++,O(t,t,n.manipulator.renderLocation),null==a||n.selectedIndex>a.selectedIndex?(o=a,a=n):(null==o||n.selectedIndex>o.selectedIndex)&&(o=n)):i=!0);if(0===e){const t=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t,this._moveManipulation.zManipulation.available=t&&this.enableZShape&&Ae(this.graphic),this._moveManipulation.angle=Ya(this.graphic.geometry),this._moveManipulation.radius=yo.radiusForSymbol(this.graphic.symbol)}else{const t=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=t,this._moveManipulation.xyAxisManipulation.available=t,this._moveManipulation.zManipulation.available=t&&this.enableZVertex&&Ae(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=t&&1!==e;let i=0;if(null!=a){const t=a.handle.pos,e=null!=o?o.handle.pos:a.handle.leftEdge&&a.handle.leftEdge.leftVertex?a.handle.leftEdge.leftVertex.pos:null,n=null==o&&a.handle.rightEdge&&a.handle.rightEdge.rightVertex?a.handle.rightEdge.rightVertex.pos:null;e&&n?this._moveManipulation.xyAxisManipulation.available=!1:e?i=Co(e,t):n&&(i=Co(t,n))}this._moveManipulation.angle=i,this._moveManipulation.radius=oo}0!==e&&i?(j(t,t,1/e),Lo.spatialReference=this._editGeometryOperations.data.spatialReference,Lo.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,Lo),this._moveManipulation.elevationAlignedLocation=Lo):null==this._outlineVisualElement||this._graphicState.isDraped||null==this._outlineVisualElement.attachmentOrigin?be(this.view,this._moveManipulation,this.graphic):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(t){const e=new Array,i=this._editGeometryOperations;for(const a of t){const t=a.handle.component;if("vertex"===a.type&&i.canRemoveVertex(t)){e.push(a.handle),this._removeManipulator(a),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(a.handle.rightEdge));const o=i.removeVertices([a.handle]),n=o.removedVertices?.[0].createdEdge;n?this._createVertexOrEdgeManipulator(n):this.enableEdgeOffset&&t.vertices.length<=2&&this._removeManipulator(this._getManipulatorInfoFromHandle(t.edges[0]))}}if(e.length>0){const t=e.map((t=>{const e=i.data.components.indexOf(t.component);return{coordinates:i.data.coordinateHelper.vectorToArray(t.pos),componentIndex:e,vertexIndex:t.index}}));this.outputGeometry=i.data.geometry;const a=this._updateEventState(Vo.RESHAPING);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:t.map((t=>t.coordinates)),vertices:t}),this.destroyed)return;if(a&&(this._updateEventState(Vo.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}_moveVertices(t,e,i=("start"===e.action?Ci.NEW_STEP:Ci.ACCUMULATE_STEPS)){const a=this._editGeometryOperations;a.moveVertices(t.map((t=>t.handle)),e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,i),this.outputGeometry=a.data.geometry;for(const e of t)this._updateManipulatorPosition(e)}_offsetEdge(t,e){if(null==e.operation||null==e.signedDistance)return;const i=this._editGeometryOperations,a=e.operation.clone();a.distance=e.signedDistance,i.updateVertices([t.handle.leftVertex,t.handle.rightVertex],a),this.outputGeometry=i.data.geometry,this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t.handle.rightVertex))}_manipulatorClickCallback(t,e){t.shiftKey||this._clearSelection(),"vertex"===e.type&&(e.manipulator.selected=!e.manipulator.selected,t.button===Wi.Right&&this._removeVertices([e])),"edge"===e.type&&t.button===Wi.Left&&this._splitEdgeManipulator(e),t.stopPropagation()}_updateTranslateTooltip(t,e){const i=this._manipulatorInfos.filter((t=>"vertex"===t.type&&t.manipulator.selected));1===i.length?this._updateTranslateVertexTooltip(i[0].manipulator,t,e):this._updateTranslateGraphicTooltip(t,e)}_updateTranslateGraphicTooltip(t,e){const{sketchOptions:i,tooltip:a}=this;switch(t){case bo.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??=new Fi({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,e,((t,e)=>Pt(t,e)));break;case bo.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??=new Hi({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,e,((t,i)=>he(Pt(t,i),po(e))));break;case bo.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??=new zi({sketchOptions:i}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,e,Lt)}this._latestTooltipInfo.sketchOptions=i,a.info=i.tooltips.effectiveEnabled?this._latestTooltipInfo:null}_updateTranslateVertexTooltip(t,e,i){const{sketchOptions:a,tooltip:o}=this;switch(e){case bo.XY:this._latestTooltipInfo=this._translateVertexTooltipInfo??=new Zi({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,((t,e)=>Pt(t,e))),this._updateTooltipAreaOrTotalLength(this._latestTooltipInfo);break;case bo.XY_AXIS:this._latestTooltipInfo=this._translateVertexXYTooltipInfo??=new Xi({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,((t,e)=>he(Pt(t,e),po(i)))),this._updateTooltipAreaOrTotalLength(this._latestTooltipInfo);break;case bo.Z:this._latestTooltipInfo=this._translateVertexZTooltipInfo??=new Ni({sketchOptions:a}),this._updateTranslateTooltipDistance(this._latestTooltipInfo,i,Lt)}const n=kt(t.elevationAlignedLocation);this._latestTooltipInfo.elevation=null!=n?$t({actual:n}):null,this._latestTooltipInfo.sketchOptions=a,o.info=a.tooltips.effectiveEnabled?this._latestTooltipInfo:null}_updateTranslateTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:pe}else t.distance=pe}_updateTooltipAreaOrTotalLength(t){const{geometry:e}=this.graphic;if(null==e)return t.area=null,void(t.totalLength=null);t.area="polygon"===e.type?qi(e):null,t.totalLength="polyline"===e.type?Ut(e):null}_hideTooltip(){this.tooltip.clear(),this._latestTooltipInfo=null}get test(){return{segmentLabels:this._segmentLabels,manipulatorInfos:this._manipulatorInfos}}};function Co(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI/2}t([M()],Ro.prototype,"_editGeometryOperations",void 0),t([M()],Ro.prototype,"_segmentLabels",void 0),t([M({constructOnly:!0})],Ro.prototype,"tool",void 0),t([M()],Ro.prototype,"tooltip",void 0),t([M()],Ro.prototype,"inputGeometry",null),t([M()],Ro.prototype,"outputGeometry",void 0),t([M({readOnly:!0})],Ro.prototype,"updating",null),t([M()],Ro.prototype,"manipulators",null),t([M()],Ro.prototype,"view",null),t([M()],Ro.prototype,"graphic",null),t([M()],Ro.prototype,"enableZShape",null),t([M()],Ro.prototype,"enableZVertex",null),t([M()],Ro.prototype,"enableMoveGraphic",null),t([M()],Ro.prototype,"enableMidpoints",null),t([M()],Ro.prototype,"enableEdgeOffset",null),t([M()],Ro.prototype,"sketchOptions",null),t([M()],Ro.prototype,"_accentColor",null),Ro=t([w("esri.views.3d.interactive.editingTools.reshapeGraphic.ReshapeOperation")],Ro);const Lo=ge(0,0,void 0,Ji.WGS84),Po=H(),ko=1e-6;var Uo,Vo,zo;!function(t){t.Vertex=Ai.Custom1,t.Edge=Ai.Custom2}(Uo||(Uo={})),function(t){t[t.NONE=0]="NONE",t[t.MOVING=1]="MOVING",t[t.RESHAPING=2]="RESHAPING"}(Vo||(Vo={})),function(t){t[t.ALL=0]="ALL",t[t.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(zo||(zo={}));let Ho=class extends(le.EventedMixin(mi)){constructor(t){super(t),this._internalGeometryUpdate=!1,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveGraphic=!0,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.sketchOptions=new we,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new Ro({tool:this});this.addHandles([t.on("reshape",(t=>{"reshape"===t.type&&this._onReshapeGeometryChanged(),this.emit("reshape",t)})),t.on("move",(t=>{"move"===t.type&&this._onReshapeGeometryChanged(),this.emit("move",t)})),t.on("vertex-add",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-add",t)})),t.on("vertex-remove",(t=>{this._onReshapeGeometryChanged(),this.emit("vertex-remove",t)})),t.on("immediate-click",(t=>this.emit("immediate-click",t))),this.view.on("pointer-down",["Shift"],(t=>t.stopPropagation())),m((()=>this.graphic),(()=>this._updateGraphic()),_)]),this.finishToolCreation()}destroy(){this._reshapeOperation=u(this._reshapeOperation)}get updating(){return this._reshapeOperation?.updating??!1}_updateGeometry(){const t=Oe(this.graphic);this._reshapeOperation.inputGeometry=null!=t?t.clone():null}_updateGraphic(){if(this.removeHandles("onGraphicGeometryChange"),this._updateGeometry(),je(this.graphic)!==Te.SUPPORTED)return;const t=m((()=>this.graphic?.geometry),(()=>{!1===this._internalGeometryUpdate&&this._updateGeometry()}),v);this.addHandles(t,"onGraphicGeometryChange")}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}_updateGeometryInternally(t){this._internalGeometryUpdate=!0;const{graphic:e}=this,{geometry:i}=e;"mesh"===i?.type&&"point"===t.type?(e.geometry=i.centerAt(t),e.notifyGeometryChanged()):e.geometry=t,this._internalGeometryUpdate=!1}_onReshapeGeometryChanged(){const{outputGeometry:t}=this._reshapeOperation;null!=this.graphic&&t&&this._updateGeometryInternally(t.clone())}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.undo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){null!=this.snappingManager&&this.snappingManager.doneSnapping();const t=this._reshapeOperation.redo(),{outputGeometry:e}=this._reshapeOperation;t&&e&&this._updateGeometryInternally(e.clone())}onInputEvent(t){"key-down"!==t.type||"Delete"!==t.key&&"Backspace"!==t.key||this._reshapeOperation.removeSelectedVertices()}reset(){}get test(){return{snappingManager:this.snappingManager,reshapeOperation:this._reshapeOperation}}};t([M()],Ho.prototype,"_reshapeOperation",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"view",void 0),t([M({constructOnly:!0})],Ho.prototype,"graphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"enableZShape",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"enableZVertex",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"enableMoveGraphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"enableMidpoints",void 0),t([M({constructOnly:!0,nonNullable:!0})],Ho.prototype,"enableEdgeOffset",void 0),t([M()],Ho.prototype,"type",void 0),t([M({constructOnly:!0,type:we})],Ho.prototype,"sketchOptions",void 0),t([M({constructOnly:!0})],Ho.prototype,"snappingManager",void 0),t([M()],Ho.prototype,"updating",null),t([M()],Ho.prototype,"automaticManipulatorSelection",void 0),Ho=t([w("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Ho);let Fo=class extends Vi{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};t([M()],Fo.prototype,"type",void 0),t([M()],Fo.prototype,"rotation",void 0),t([M()],Fo.prototype,"rotationPrecision",void 0),t([M()],Fo.prototype,"orientation",void 0),t([M()],Fo.prototype,"orientationPrecision",void 0),t([M()],Fo.prototype,"rotationType",void 0),Fo=t([w("esri.views.interactive.tooltip.TransformRotateTooltipInfo")],Fo);let No=class extends Vi{constructor(t){super(t),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};t([M()],No.prototype,"type",void 0),t([M()],No.prototype,"scale",void 0),t([M()],No.prototype,"size",void 0),t([M()],No.prototype,"sizeUnit",void 0),t([M()],No.prototype,"sizePrecision",void 0),No=t([w("esri.views.interactive.tooltip.TransformScaleTooltipInfo")],No);let Xo=class extends Vi{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};var Zo;t([M()],Xo.prototype,"type",void 0),t([M()],Xo.prototype,"orientation",void 0),t([M()],Xo.prototype,"orientationPrecision",void 0),t([M()],Xo.prototype,"rotationType",void 0),t([M()],Xo.prototype,"size",void 0),t([M()],Xo.prototype,"sizePrecision",void 0),t([M()],Xo.prototype,"sizeUnit",void 0),Xo=t([w("esri.views.interactive.tooltip.TransformAbsoluteTooltipInfo")],Xo),function(t){t.ScaleIn=Ai.Custom2,t.ScaleOut=Ai.Custom3,t.RotateLeft=Ai.Custom4,t.RotateRight=Ai.Custom5,t.Unlocked=Ai.Custom7,t.DelayedFocused=Ai.Custom8,t.TouchInput=Ai.Custom12}(Zo||(Zo={}));let Yo=class extends et{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}get updating(){return!!this._activeAnimation}constructor(t){super(t),this.mode=null,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=200,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new le,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._tooltip=new Ui({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([f((()=>!this.sketchOptions.tooltips.effectiveEnabled),(()=>this._tooltip.clear()),y),m((()=>{const{adapter:t}=this,{info:e}=this._tooltip;return e===this._absoluteTooltipInfo&&this.getFocused()?[e,t.size,t.orientationClockwise]:[null]}),(([t])=>{t&&this._updateFocusTooltip()}))])}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=u(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=ea({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=u(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,Wa.SCALE_ROTATE)}_createManipulator(){const t=this._createRingManipulator();this._ringManipulator=t,this.tool.manipulators.add(t);const e=this.tool.graphicState.graphic,i=li(t,((t,i,a)=>{this._scaleRotateDragData=null;const o=this.adapter.startInteraction(),n={mode:"none",origin:N(t.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=n,this._updateDragState();const s=St.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,s),i.next(ni(this.tool.view,Et(t.renderLocation,s,Tt()))).next((t=>{const i=wt(t.plane),a=Se(t.renderStart,t.renderEnd,n.origin,i),s=ta.shortestSignedDiff(n.angle,a);n.angleDir=ot(n.angleDir+s,-.3,.3),n.angle=a;const r=function(t,e){const i=I(St.get(),e.renderStart,t.origin),a=I(St.get(),e.renderEnd,t.origin),o=P(i),n=P(a);return 0===o?0:n/o}(n,t),l=r-this.adapter.scale;if(n.scaleDir=ot(n.scaleDir+l,-.2,.2),this._onScaleChanged(),"none"===n.mode){const i=this.mode||function(t,e,i,a){const{renderStart:o,renderEnd:n}=t,s=Bo(o,a,St.get()),r=Bo(n,a,St.get());if(U(s,r)<100)return null;const l=I(St.get(),o,i),p=R(St.get(),l,wt(e)),h=o,c=O(St.get(),h,p),u=Bo(i,a,St.get()),d=s,m=Bo(c,a,St.get()),g=I(St.get(),m,d),_=I(St.get(),s,u),f=jt(d,g),v=jt(u,_);return At(f,r)<At(v,r)?"rotate":"scale"}(t,t.plane,n.origin,this.tool.view.state.camera);if(null!=i){switch(i){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:e,angle:0}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:e,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}n.mode=i}}switch(n.mode){case"rotate":o.state.angle=n.initialAngle+a;break;case"scale":o.state.scale=r,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),t.action){case"start":case"update":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:e,angle:nt(n.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:e,xScale:r,yScale:r})}break;case"end":switch(n.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:nt(n.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:r,yScale:r})}}return"end"===t.action&&(this.startAnimation(qo(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),o.done()),t})).next(this._updateTooltipPipelineStep(n)),a.next((()=>{if(o.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:e,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:e,xScale:1,yScale:1})}this.startAnimation(qo(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this.addHandles([i,t.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(function(t,e,i){let a=0,o=null;const n=()=>!1;return{start:()=>{o=t.getFocused,t.getFocused=n,a=0,e()},update:t=>(a+=t,!o?.()||a>=i.delayMs?Wo.STOP:Wo.CONTINUE),destroy:()=>{o&&(t.getFocused=o),e()}}}(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),t.events.on("immediate-click",(t=>{t.stopPropagation()})),m((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),y)])}_updateTooltipPipelineStep(t){return e=>{const{sketchOptions:i}=this,{effectiveEnabled:a,visualVariables:o}=i.tooltips;if(!a)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const n=this._tooltip;switch(t.mode){case"scale":{n.info=this._scaleTooltipInfo??=new No({sketchOptions:i});const{size:t,scale:e}=this.adapter,a=o?.size,s=n.info;s.sketchOptions=i,s.scale={value:e},s.size=null!=t?ce(t,"meters"):void 0,s.sizePrecision=Qo(a?.valueType),s.sizeUnit=a?.unit;break}case"rotate":{n.info=this._rotateTooltipInfo??=new Fo({sketchOptions:i});const{orientationClockwise:t,relativeAngleClockwise:e}=this.adapter,a=o?.rotation,s=Qo(a?.valueType),r=n.info;r.sketchOptions=i,r.rotation=null!=e?ue(e,"radians","geographic"):void 0,r.rotationPrecision=s,r.rotationType=a?.rotationType??"geographic",r.orientation=null!=t?ue(t,"radians","geographic"):void 0,r.orientationPrecision=s;break}}return e}}_updateFocusTooltip(){const{sketchOptions:t,_tooltip:e}=this,{effectiveEnabled:i,visualVariables:a}=t.tooltips;if(i)if(this.getFocused()){const i=a?.rotation,o=a?.size,n=this.mode,{size:s,orientationClockwise:r}=this.adapter,l=null!=r&&(null==n||"rotate"===n),p=null!=s&&(null==n||"scale"===n);e.info=this._absoluteTooltipInfo??=new Xo({sketchOptions:t});const h=e.info;h.sketchOptions=t,h.orientation=l?ue(r,"radians","geographic"):void 0,h.orientationPrecision=Qo(i?.valueType),h.rotationType=i?.rotationType??"geographic",h.size=p?ce(s,"meters"):void 0,h.sizeUnit=o?.unit,h.sizePrecision=Qo(o?.valueType)}else e.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(Zo.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(Zo.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(Zo.ScaleIn|Zo.ScaleOut,!1),this._ringManipulator.updateStateEnabled(Zo.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(Zo.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(Zo.RotateLeft|Zo.RotateRight,!1),this._ringManipulator.updateStateEnabled(Zo.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(Zo.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(Zo.ScaleIn|Zo.ScaleOut|Zo.RotateLeft|Zo.RotateRight,!1)}_updateManipulatorTransform(){const t=Ne(xt.get(),this.adapter.angle,F(0,0,1));if(null==t)return;const e=this.getScale(),i=Xe(xt.get(),T(St.get(),e,e,e));this._ringManipulator.modelTransform=Fe(xt.get(),i,t)}_createRingManipulator(){const t=(t,e,i)=>{const a=[],o=Math.ceil(128*(e-t)/(2*Math.PI));for(let n=0;n<o+1;n++){const s=t+n*(e-t)/o;a.push(F(i*Math.cos(s),i*Math.sin(s),0))}return a},e=e=>t(0,2*Math.PI,e),i=this._createMaterial(1),a=(t,e,a=i)=>Ti(a,(t=>[[-t/2,0],[t/2,0],[t/2,.25],[-t/2,.25]])(e),t,[],[],!1),o=e(160),n=a(o,24),s={left:new Array,right:new Array},r=[];for(let e=0;e<2;e++){const o=e*Math.PI-Math.PI/4,n=Math.PI/2-no,l=o+n,p=o+Math.PI/2-n,h=t(l,p,190),c=a(h,9);r.push(h),r.push(t(l,p,201)),s.left.push(c),s.right.push(c.instantiate());for(let t=0;t<2;t++){const e=0===t,a=Qe();if(e){Be(a,a,[1,-1,1]),We(a,a,-l,[0,0,1]);const t=Math.round(.2*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}else{We(a,a,p,[0,0,1]);const t=Math.round(.8*(h.length-1));a[12]=h[t][0],a[13]=h[t][1],a[14]=h[t][2]}const o=Mi(i,60,0,23,.5);bi(o,a),(e?s.left:s.right).push(o)}}const l=[];for(let e=0;e<2;e++){const i=e*Math.PI-Math.PI/4,o=Math.PI/2-so,n=i+o,s=i+Math.PI/2-o,r=t(n,s,213);l.push(a(r,9))}const p=this._createMaterial(.66),h=this._createMaterial(.5),c=this._createMaterial(.33),u=e(190),d=e(213),m=a(u,9,p),g=a(d,9,c),_=e(130),f=e(107),v=a(_,9,p),y=a(f,9,c);let M=[new fe(n,Zo.DelayedFocused),new fe(n.instantiate({material:h}),ji.None)];this.mode&&"scale"!==this.mode||(M=M.concat([...l.map((t=>new fe(t,Zo.DelayedFocused|Zo.Unlocked))),new fe(m,Zo.DelayedFocused|Zo.ScaleIn),new fe(g,Zo.DelayedFocused|Zo.ScaleIn),new fe(v,Zo.DelayedFocused|Zo.ScaleOut),new fe(y,Zo.DelayedFocused|Zo.ScaleOut)])),this.mode&&"rotate"!==this.mode||(M=M.concat([...s.right.map((t=>new fe(t.instantiate(),Zo.DelayedFocused|Zo.Unlocked))),...s.left.map((t=>new fe(t,Zo.DelayedFocused|Zo.RotateLeft))),...s.right.map((t=>new fe(t,Zo.DelayedFocused|Zo.RotateRight)))]));const b=[o,...r];return new _e({view:this.tool.view,renderObjects:M,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:W(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:b,direction:F(0,0,1)}})}_createMaterial(t){const e=new Oi({cullFace:yi.Back,renderOccluded:Qt.Transparent,isDecoration:!0});return this.addHandles(m((()=>({color:s(this.tool.view.effectiveTheme.accentColor,t)})),(t=>e.setParameters(t)),y)),e}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}};function Bo(t,e,i){return e.projectToScreen(t,Jo),T(i,Jo[0],Jo[1],0)}var Wo;function qo(t,e){let i=null,a=1;const o=()=>a;return{start:()=>{a=t.getScale(),i=t.getScale,t.getScale=o,e()},update:t=>(a+=((a+1)/2-a)*Math.min(3*t,1),e(),Math.abs(a-1)<.01?Wo.STOP:Wo.CONTINUE),destroy:()=>{i&&(t.getScale=i),e()}}}function Qo(t){switch(t){case"integer":case"long":return 0;default:return null}}t([M({constructOnly:!0})],Yo.prototype,"tool",void 0),t([M({constructOnly:!0})],Yo.prototype,"adapter",void 0),t([M({constructOnly:!0})],Yo.prototype,"sketchOptions",void 0),t([M()],Yo.prototype,"mode",void 0),t([M()],Yo.prototype,"_activeAnimation",void 0),t([M()],Yo.prototype,"updating",null),Yo=t([w("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],Yo),function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(Wo||(Wo={}));const Jo=K();function Ko(t){return null!=t.geometry&&"mesh"===t.geometry.type?(e=t.geometry,la(e.vertexSpace)?function(t,e,i){let a=e?.clone(),o=N(i.origin),n=null,s=null;return{undo:e=>{n=t.transform?.clone(),s=N(i.origin),t.transform=a,t.vertexSpace.origin=o,e.notifyMeshTransformChanged()},redo:e=>{a=t.transform?.clone(),o=N(i.origin),t.transform=n,t.vertexSpace.origin=s,e.notifyMeshTransformChanged()}}}(e,e.transform,e.vertexSpace):function(t){let e,i=t.vertexAttributes.clonePositional();return{undo:a=>{e=t.vertexAttributes.clonePositional(),t.vertexAttributes=i,a.notifyGeometryChanged()},redo:a=>{i=t.vertexAttributes.clonePositional(),t.vertexAttributes=e,a.notifyGeometryChanged()}}}(e)):function(t){let e=t.geometry,i=null;return{undo(t){i=t.geometry,t.geometry=e},redo(t){e=t.geometry,t.geometry=i}}}(t);var e}let $o=class extends et{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([f((()=>{const t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null}),(({interactionState:t})=>{this._updateMeshRotation(t)}),v),f((()=>{const t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null}),(({interactionState:t})=>{this._updateMeshSize(t)}),v)])}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const t=this.geometry.transform;if(null==t)return this._interactionState?.angle??0;const e=aa(t.rotation)[2];return Math.abs(e)>.999999?at(oa(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const t=new tn({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return Ko(this.graphic)}_updateMeshRotation(t){const{angle:e,previousAngle:i}=t;t.previousAngle=e;const{geometry:a}=this,{vertexSpace:o}=a,n=nt(e-i);if("georeferenced"===o.type){const t=!la(o)&&this.viewingMode===$i.Global,e=this.geometry.anchor;this.geometry.rotate(0,0,n,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new ra;const{transform:t}=a,e=na(0,0,n,en);t.rotation=sa(t.rotation,e,t.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(t){const{scale:e,previousScale:i}=t;t.previousScale=e;const{geometry:a}=this,{vertexSpace:o}=a,n=e/i;if("georeferenced"===o.type){const t=!la(o)&&this.viewingMode===$i.Global,e=this.geometry.anchor;this.geometry.scale(n,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{a.transform??=new ra;const{transform:t}=a;t.scale=j(t.scale,t.scale,n),this.graphic.notifyMeshTransformChanged()}}};t([M({constructOnly:!0})],$o.prototype,"graphic",void 0),t([M({constructOnly:!0})],$o.prototype,"geometry",void 0),t([M({constructOnly:!0})],$o.prototype,"viewingMode",void 0),t([M()],$o.prototype,"initialAngle",null),t([M()],$o.prototype,"angle",null),t([M()],$o.prototype,"angleClockwise",null),t([M()],$o.prototype,"relativeAngle",null),t([M()],$o.prototype,"relativeAngleClockwise",null),t([M()],$o.prototype,"scale",null),t([M()],$o.prototype,"_interactionState",void 0),$o=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],$o);let tn=class extends et{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};t([M()],tn.prototype,"angle",void 0),t([M()],tn.prototype,"initialAngle",void 0),t([M()],tn.prototype,"previousAngle",void 0),t([M()],tn.prototype,"previousScale",void 0),t([M()],tn.prototype,"scale",void 0),t([M()],tn.prototype,"state",null),tn=t([w("InteractionState")],tn);const en=ia();let an=class extends et{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(f((()=>null!=this._interactionState?this._interactionState.state:null),(t=>{this._updateSymbol(t)}),v))}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){return null!=this._interactionState?this._interactionState.angle:null!=this._orientationReferenceSymbolLayer?(t=this._orientationReferenceSymbolLayer.heading??0,-at(t)):0;var t}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}get size(){const t=this._sizeReferenceSymbolLayer;if(null==t)return null;const e=this.findLayerView(),i=this._graphicSymbol;if(null==e||null==i||"point-3d"!==i.type)return null;const a=e.getSymbolLayerSize(i,t);if("size"in a&&null!=a.size)return a.size;const o=this.sizeAxis;return!("width"in a)||null==a.width||null!=o&&"width"!==o&&"all"!==o&&"width-and-depth"!==o?!("depth"in a)||null==t.depth||null!=o&&"depth"!==o&&"all"!==o&&"width-and-depth"!==o?!("height"in a)||null==t.height||null!=o&&"height"!==o&&"all"!==o?null:a.height:a.depth:a.width}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type))}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return null==t||0===t.symbolLayers.length?null:t.symbolLayers.find((t=>"object"===t.type&&null!=t.heading))}get _graphicSymbol(){return null!=this.graphic?.symbol&&"point-3d"===this.graphic.symbol.type?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(null!=this._interactionState||null==t||null==e)return on;const i=t.symbolLayers.map((i=>"object"===i.type?e.getSymbolLayerSize(t,i):null)).toArray(),a=t.clone(),o=this.angle,n=new nn({originalSymbol:a,angle:o,initialSizes:i});this._interactionState=n;const s=()=>{this._interactionState=null};return{state:n,done:s,cancel:()=>{this._graphicSymbol=a,s()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:i=>{e=i.symbol,i.symbol=t},redo:i=>{t=i.symbol,i.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:i,initialSizes:a}){const o=this._graphicSymbol;if(null==o||"point-3d"!==o.type)return;const n=o.clone(),s=-nt(e-this.initialAngle);let r=!1;this._forEachObjectSymbolLayerPair(i,n,((e,i,o)=>{const n=(e.heading??0)+s;i.heading!==n&&(i.heading=n,r=!0);const l=a[o];if(null!=l&&"width"in l){l.width=this.sizeFilter(l.width),l.height=this.sizeFilter(l.height),l.depth=this.sizeFilter(l.depth);const e=l.width*t;i.width!==e&&(i.width=e,r=!0);const a=l.depth*t;i.depth!==a&&(i.depth=a,r=!0);const o=l.height*t;i.height!==o&&(i.height=o,r=!0)}})),r&&(this._graphicSymbol=n)}_forEachObjectSymbolLayerPair(t,e,i){t.symbolLayers.forEach(((t,a)=>{const o=e.symbolLayers.at(a);"object"===t.type&&"object"===o.type&&i(t,o,a)}))}};t([M()],an.prototype,"initialAngle",null),t([M()],an.prototype,"angle",null),t([M()],an.prototype,"angleClockwise",null),t([M()],an.prototype,"orientation",null),t([M()],an.prototype,"orientationClockwise",null),t([M()],an.prototype,"relativeAngle",null),t([M()],an.prototype,"relativeAngleClockwise",null),t([M()],an.prototype,"scale",null),t([M()],an.prototype,"size",null),t([M()],an.prototype,"sizeAxis",void 0),t([M({constructOnly:!0})],an.prototype,"graphic",void 0),t([M()],an.prototype,"_interactionState",void 0),t([M({constructOnly:!0})],an.prototype,"findLayerView",void 0),t([M({constructOnly:!0})],an.prototype,"sizeFilter",void 0),t([M()],an.prototype,"_sizeReferenceSymbolLayer",null),t([M()],an.prototype,"_orientationReferenceSymbolLayer",null),t([M()],an.prototype,"_graphicSymbol",null),an=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateObjectSymbol3DAdapter")],an);const on={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let nn=class extends et{get state(){const{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:o}=this;return{originalSymbol:t,angle:e,initialAngle:i,scale:a,initialSizes:o}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=t.angle}};t([M()],nn.prototype,"originalSymbol",void 0),t([M()],nn.prototype,"angle",void 0),t([M()],nn.prototype,"initialAngle",void 0),t([M()],nn.prototype,"initialSizes",void 0),t([M()],nn.prototype,"scale",void 0),t([M()],nn.prototype,"state",null),nn=t([w("InteractionState")],nn);let sn=class extends(le.EventedMixin(mi)){constructor(t){super(t),this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new we,this.type="transform-3d",this.tooltip=null,this._updatingHandles=new me,this._scaleRotate=null,this._translateGraphicTooltipInfo=null,this._translateGraphicXYTooltipInfo=null,this._translateGraphicZTooltipInfo=null}initialize(){const{graphic:t,view:e}=this;this.graphicState=new qt({graphic:t}),this.addHandles(m((()=>this.sketchOptions.tooltips.effectiveEnabled),(t=>{this.tooltip=t?new Ui({view:e}):u(this.tooltip)}),_)),this._moveManipulation=new yo({tool:this,view:e,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Ae(t),radius:yo.radiusForSymbol(t.symbol)}),this._moveManipulation.forEachManipulator((e=>this.addHandles(e.events.on("immediate-click",(e=>{this.emit("immediate-click",{...e,graphic:t}),e.stopPropagation()})))));const i=t=>e=>{this.addHandles(e.events.on("focus-changed",(({action:e})=>{const i=this.tooltip;null!=i&&("focus"===e?this._updateMoveTooltip(t):i.clear())})))};this._moveManipulation.xyManipulation.forEachManipulator(i(bo.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(i(bo.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(i(bo.Z));const a=W(t);this._moveManipulation.elevationInfo=a,this.addHandles(za(this.graphicState));const{geometry:o}=t;if(this._moveManipulation.createGraphicDragPipeline(((i,n,s,r,l)=>{if(null!=o&&i===bo.XY){const{snappingStep:i,cancelSnapping:n}=ki({snappingContext:new Pi({elevationInfo:a,pointer:l,editGeometryOperations:Di.fromGeometry(new Ki({spatialReference:o.spatialReference}),e.state.viewingMode),visualizer:new Ht,excludeFeature:t}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});r=r.next(n),s=s.next(vi(this.view,a)).next(...i)}return{steps:s=s.next((t=>(this._updateMoveTooltip(i,t),t))),cancel:r}}),this.graphicState,(t=>{const{action:e,graphic:i,dxScreen:a,dyScreen:o}=t,n={graphic:i,dxScreen:a,dyScreen:o};switch(e){case"start":this.emit("graphic-translate-start",n),this.emit("record-undo",{record:this._createGeometryUndoRecord()});break;case"update":this.emit("graphic-translate",n);break;case"end":this.emit("graphic-translate-stop",n)}})),this._moveManipulation.angle=null!=this._scaleRotate?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(m((()=>this._scaleRotateAdapter.angle),(()=>this._updateMoveAngle()))),this.enableScaling||this.enableRotation){const t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Yo({tool:this,mode:t,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions}),this.addHandles(this._scaleRotate.events.on("scale-changed",(()=>this._onScaleChanged())))}this.addHandles([io({view:this.view,graphic:this.graphic,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>r()}),this.graphicState.on("changed",(()=>this._onGeometryChanged())),this._hideManipulatorsForGraphicState(),m((()=>e.scale),(()=>this._updateMoveAngle()))].filter(x)),this.addHandles(this.view.trackGraphicState(this.graphicState)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator((t=>{t instanceof _e&&this.addHandles(t.events.on("grab-changed",(()=>this._updateManipulatorsInteractive())))})),this.finishToolCreation()}destroy(){this.tooltip=u(this.tooltip),this._moveManipulation.destroy(),this._scaleRotate=u(this._scaleRotate),this._scaleRotateAdapter=u(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("graphic",null)}_updateManipulatorsInteractive(){null!=this._scaleRotate&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){return null!=this.graphic.geometry&&"mesh"===this.graphic.geometry.type?new $o({graphic:this.graphic,geometry:this.graphic.geometry,viewingMode:this.view.state.viewingMode}):new an({graphic:this.graphic,sizeFilter:t=>this._enforceNonZeroSize(t),findLayerView:()=>this.view.allLayerViews.find((t=>t.layer===this.graphic.layer)),sizeAxis:this.sketchOptions?.tooltips?.visualVariables?.size?.axis??null})}_forEachManipulator(t){this._moveManipulation?.forEachManipulator(t),this._scaleRotate?.forEachManipulator(t)}_hideManipulatorsForGraphicState(){return m((()=>this.graphicState.displaying),(t=>{this._forEachManipulator((e=>e.available=t)),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Ae(this.graphic)}))}_createGeometryUndoRecord(){return Ko(this.graphic)}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){return this._updatingHandles.updating||!!this._scaleRotate?.updating}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){this._scaleRotate?.cancelActiveAnimation()}_onScaleChanged(){null!=this._scaleRotate&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){this.view.state.viewingMode===$i.Local||this.view.scale<1e6?this._moveManipulation.angle=this._scaleRotateAdapter.angle:this._moveManipulation.angle=0}_onGeometryChanged(){be(this.view,this,this.graphic)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}_updateMoveTooltip(t,e){const{sketchOptions:i,tooltip:a}=this;if(null!=a){switch(a.clear(),t){case bo.XY:a.info=this._translateGraphicTooltipInfo??=new Fi({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,e)=>Pt(t,e)));break;case bo.XY_AXIS:a.info=this._translateGraphicXYTooltipInfo??=new Hi({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,e,((t,i)=>he(Pt(t,i),po(e))));break;case bo.Z:a.info=this._translateGraphicZTooltipInfo??=new zi({sketchOptions:i}),this._updateMoveTooltipDistance(a.info,e,Lt)}a.info.sketchOptions=i}}_updateMoveTooltipDistance(t,e,i){if(null!=e&&"end"!==e.action){const{mapStart:a,mapEnd:o}=e,n=i(a,o);t.distance=null!=n?n:pe}else t.distance=pe}get test(){return{discManipulator:this._moveManipulation.xyManipulation.test.discManipulator,zManipulator:this._moveManipulation.zManipulation.test.manipulator,ringManipulator:null!=this._scaleRotate?this._scaleRotate.test.ringManipulator:null,arrowManipulators:this._moveManipulation.xyAxisManipulation.test.arrowManipulators,setRingIndicatorDelayMs:t=>null!=this._scaleRotate?this._scaleRotate.test.setRingIndicatorDelayMs(t):null,scaleRotateAdapter:this._scaleRotateAdapter,scaleRotateTransform:this._scaleRotate}}};t([M({constructOnly:!0,nonNullable:!0})],sn.prototype,"view",void 0),t([M({constructOnly:!0,nonNullable:!0})],sn.prototype,"graphic",void 0),t([M({constructOnly:!0,nonNullable:!0})],sn.prototype,"enableZ",void 0),t([M()],sn.prototype,"enableRotation",void 0),t([M()],sn.prototype,"enableScaling",void 0),t([M({constructOnly:!0,type:we})],sn.prototype,"sketchOptions",void 0),t([M()],sn.prototype,"graphicState",void 0),t([M({value:!1})],sn.prototype,"snapToScene",null),t([M({constructOnly:!0})],sn.prototype,"snappingManager",void 0),t([M({readOnly:!0})],sn.prototype,"type",void 0),t([M({readOnly:!0})],sn.prototype,"updating",null),t([M()],sn.prototype,"tooltip",void 0),sn=t([w("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],sn);class rn{constructor(t,e,i,a){this._tool=t,this._graphicState=e,this._editGeometryOperations=i,this._bounds=a,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const o=this._tool,n=o.view;this.moveXYGraphicManipulation=new So({view:n,tool:o,graphicState:this._graphicState}),o.addHandles(this._createMoveXYGraphicDragPipeline()),this.moveZManipulator=new pa(n,ha.CENTER_ON_CALLOUT),this.moveZManipulator.state|=ca,o.manipulators.add(this.moveZManipulator),o.addHandles([this._createMoveZDragPipeline()]),o.addHandles([o.on("graphic-translate-stop",(()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null}))])}destroy(){this.moveXYGraphicManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYGraphicManipulation.forEachManipulator(t),t(this.moveZManipulator,Wa.TRANSLATE_Z)}updateManipulators(t,e){const i=this.moveZManipulator,a=qe(xt.get(),t,Math.PI);a[12]=0,a[13]=0,a[14]=0,i.modelTransform=a,i.renderLocation=I(St.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYGraphicManipulation.grabbing||this.moveXYGraphicManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool,e=this._moveXYTooltipInfo??=new Fi({sketchOptions:t.sketchOptions});if(this.moveXYGraphicManipulation.dragging){const i=this._bounds,a=i.mapBoundsStart.origin,o=i.mapBounds.origin,{renderSpatialReference:n}=t.view;if(!n)return null;const s=Ct(a,o,n);if(null==s)return null;e.distance=s}else e.distance=pe;return e}_computeMoveZTooltipInfo(){const t=this._tool,e=this._moveZTooltipInfo??=new zi({sketchOptions:t.sketchOptions});if(this.moveZManipulator.dragging){const i=this._bounds,a=i.mapBoundsStart.origin,o=i.mapBounds.origin,{renderSpatialReference:n}=t.view;if(!n)return null;const s=Vt(a,o,n);if(null==s)return null;e.distance=s}else e.distance=pe;return e}_createMoveXYGraphicDragPipeline(){return this.moveXYGraphicManipulation.createDragPipeline(((t,e,i)=>this._applyGraphicMoveSteps(e,i)))}_createMoveZDragPipeline(){const t=this._editGeometryOperations.data.spatialReference;return li(this.moveZManipulator,((e,i,a)=>{const o=N(e.renderLocation),n=i.next(ti(this._tool.view,o,t)).next(ci());this._applyGraphicMoveSteps(n,a)}))}_applyGraphicMoveSteps(t,e){const i=this._tool,a=i.graphic,o=t.next((t=>("start"===t.action&&(i.inputState={type:"move"},this._bounds.backupMapBounds(),i.emit("graphic-translate-start",{graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY})),t))).next(di()).next(this._moveDragUpdateGeometry()).next((t=>{const e={graphic:a,dxScreen:t.screenDeltaX,dyScreen:t.screenDeltaY};switch(t.action){case"start":case"update":(t.mapEnd.x-t.mapStart.x||t.mapEnd.y-t.mapStart.y||(t.mapEnd.z??0)-(t.mapStart.z??0))&&i.emit("graphic-translate",e);break;case"end":i.inputState=null,i.emit("graphic-translate-stop",e)}return t}));return e.next((()=>{null!=i.inputState&&i.emit("graphic-translate-stop",{graphic:a,dxScreen:0,dyScreen:0}),i.cancel()})),o}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(null==t.inputState||"move"!==t.inputState.type)return e;const i=[];for(const t of this._editGeometryOperations.data.components)i.push(...t.vertices);const a="start"===e.action?Ci.NEW_STEP:Ci.ACCUMULATE_STEPS,o=this._editGeometryOperations.moveVertices(i,e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a);return te(o,this._bounds.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,e}}}class ln{constructor(t,e,i){this._tool=t,this._editGeometryOperations=e,this._bounds=i,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const a=this._tool,o=a.view,n=!o._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this.rotateManipulator=new ua(o,((t,e)=>Ea(o.textures,{accentColor:t,contrastColor:e,preMultiplyAlpha:n}))),a.addHandles([this.rotateManipulator.events.on("grab-changed",(t=>this._onRotateGrab(t))),this._createRotateDragPipeline(this.rotateManipulator)]),a.manipulators.add(this.rotateManipulator),a.addHandles([a.on("graphic-rotate-start",(t=>{this._startAngle=t.angle})),a.on("graphic-rotate",(t=>{this._endAngle=t.angle})),a.on("graphic-rotate-stop",(()=>{this._startAngle=0,this._endAngle=0}))])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,Wa.ROTATE)}updateManipulators(t,e){const i=this._bounds.mapBounds.plane[2]<0?Math.PI:0,a=Ye(xt.get(),t,i);a[12]=0,a[13]=0,a[14]=0,this.rotateManipulator.modelTransform=a,this.rotateManipulator.renderLocation=O(St.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo??=new Oa({sketchOptions:this._tool.sketchOptions});return t.angle=this._startAngle-this._endAngle,t}_onRotateGrab({action:t,screenPoint:e}){const i=this._tool,a=this._bounds;if("start"!==t||!e)return;const o=da(a.displayBounds,i.view.renderCoordsHelper,ma.HEADING,Tt()),n=Ta(i.view.state.camera,e);It(o,n,St.get())&&(a.backupMapBounds(),i.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(t){const e=this._tool,i=e.graphic;return li(t,((t,a,o)=>{const n=e.inputState;null!=n&&(a.next((t=>("start"===t.action&&e.emit("graphic-rotate-start",{graphic:i,angle:0}),t))).next(ni(e.view,n.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(n)).next(this._rotateDragUpdateGeometry()).next((t=>{const a={graphic:i,angle:nt(t.rotateAngle)};switch(t.action){case"start":case"update":e.emit("graphic-rotate",a);break;case"end":e.inputState=null,e.emit("graphic-rotate-stop",a)}return t})),o.next((()=>{null!=e.inputState&&e.emit("graphic-rotate-stop",{graphic:i,angle:0}),e.cancel()})))}))}_rotateDragRenderPlaneToRotate(t){return e=>{const i=wt(t.rotatePlane),a=Se(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdateGeometry(){const t=this._tool,e=this._bounds;return i=>{const a=V(H(),e.mapBoundsStart.origin),o=[];for(const t of this._editGeometryOperations.data.components)o.push(...t.vertices);const n="start"===i.action?Ci.NEW_STEP:Ci.ACCUMULATE_STEPS,s=this._editGeometryOperations.rotateVertices(o,a,i.rotateAngle,n,Li.REPLACE);return Sa(e.mapBoundsStart,e.mapBounds),te(s,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,i}}}class pn{constructor(t,e,i){this._tool=t,this._onDisplayBoundsChanged=e,this.mapBounds=xa(),this.mapBoundsStart=xa(),this.displayBounds=xa(),this._calculateMapBounds(i)}get displayBoundsMargin(){const{view:t,graphic:e}=this._tool,i=t.pointsOfInterest?.centerOnSurfaceFrequent.location??e.geometry?.extent?.center;return i?hn*t.pixelSizeAt(i):0}backupMapBounds(){Sa(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){this._calculateDisplayBounds(),this._onDisplayBoundsChanged()}_calculateMapBounds(t){const{view:e,attachmentOrigin:i}=this._tool,a=t.geometry,o=function(t){const e=Ya(t);return yt(Math.cos(e),Math.sin(e))}(a);gt(o,o,-1);const n=e.spatialReference,s=a.spatialReference,r=i?e.pixelSizeAt(i)*ct(n)/ht(s):0;ee(o,t,cn*r,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e,graphic:i}=this._tool;if(!i.geometry)return;const a=e?.z??Bt(this.mapBounds.origin,t.elevationProvider,Wt.fromElevationInfo(W(i)),t.renderCoordsHelper),o=Sa(this.mapBounds);o.origin[2]=a??0,function(t,e,i,a=0,o){o||(o=xa()),e.toRenderCoords(t.origin,i,o.origin);const n=St.get();O(n,t.origin,t.basis1),O(n,n,t.basis2),e.toRenderCoords(n,i,n);const s=St.get();O(s,t.origin,t.basis1),I(s,s,t.basis2),e.toRenderCoords(s,i,s);const r=St.get();I(r,t.origin,t.basis1),I(r,r,t.basis2),e.toRenderCoords(r,i,r);const l=St.get();I(l,t.origin,t.basis1),O(l,l,t.basis2),e.toRenderCoords(l,i,l);const p=k(St.get(),n,s,.5);I(p,p,o.origin);const h=k(St.get(),r,l,.5);I(h,o.origin,h),k(o.basis1,p,h,.5);const c=k(St.get(),l,n,.5);I(c,c,o.origin);const u=k(St.get(),s,r,.5);I(u,o.origin,u),k(o.basis2,c,u,.5);const d=R(St.get(),o.basis1,o.basis2),m=R(d,d,o.basis1);D(m,m),j(o.basis2,m,G(o.basis2,m)),j(o.basis1,o.basis1,1+a/P(o.basis1)),j(o.basis2,o.basis2,1+a/P(o.basis2)),wa(o)}(o,t.renderCoordsHelper,i.geometry.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const hn=10,cn=80;function un(t,e,i){const a=St.get();I(a,I(a,t.origin,t.basis1),t.basis2);const o=St.get();z(o,a,t.basis1,2);const n=St.get();z(n,o,t.basis2,2);const s=St.get();z(s,a,t.basis2,2),a[2]=o[2]=n[2]=s[2]=e;const r=de(Ct(a,o,i),Ct(s,n,i)),l=de(Ct(o,n,i),Ct(a,s,i));return null==l||null==r?null:[r,l]}class dn{get zMax(){if(!this._zMaxDirty)return this._zMax;const t=this._editGeometryOperations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const i of t.components)for(const t of i.vertices){const i=e.getZ(t.pos)??0;this._zMax=Math.max(i,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,i,a,o){this._tool=t,this._graphicState=e,this._editGeometryOperations=i,this._bounds=a,this._preserveAspectRatioStep=o,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=xa(),this._displayBoundsMarginStart=0,this._startScale=vt(),this._endScale=vt(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const n=this._tool,s=n.view;this.resizeManipulators=this._resizeHandles.map((t=>{const e=new ga(s,t);return n.addHandles([e.events.on("grab-changed",(t=>this._onResizeGrab(t))),this._createResizeDragPipeline(e,t)]),e})),n.manipulators.addMany(this.resizeManipulators),n.addHandles([n.on("graphic-scale-start",(t=>{dt(this._startScale,t.xScale,t.yScale),dt(this._endScale,t.xScale,t.yScale)})),n.on("graphic-scale",(t=>{dt(this._endScale,t.xScale,t.yScale)})),n.on("graphic-scale-stop",(()=>{dt(this._startScale,0,0),dt(this._endScale,0,0)})),this._graphicState.on("changed",(()=>{"resize"!==n.inputState?.type&&(this._zMaxDirty=!0)}))])}destroy(){this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()}))}forEachManipulator(t){this.resizeManipulators.forEach((e=>t(e,Wa.SCALE)))}updateManipulators(t,e){this.resizeManipulators.forEach(((i,a)=>{_a(i,this._resizeHandles[a],t,e)}))}getUpdatedTooltipInfo(){return this.resizeManipulators.some((t=>t.focused))?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,e=this._scaleTooltipInfo??=new ja({sketchOptions:t.sketchOptions}),i=t.graphic.geometry;if(null==i)return null;const a=un(this._bounds.mapBounds,this.zMax,i.spatialReference);return null==a?null:(e.xSize=a[0],e.ySize=a[1],null!=this._sizeStart&&this.resizeManipulators.some((t=>t.dragging))?(e.xScale=a[0].value/this._sizeStart[0].value,e.yScale=a[1].value/this._sizeStart[1].value):(e.xScale=1,e.yScale=1),e)}_onResizeGrab({action:t,screenPoint:e}){const i=this._tool,a=this._bounds;if("start"!==t||!e||!i.graphic.geometry)return;const o=Ta(i.view.state.camera,e);It(a.displayBounds.plane,o,St.get())&&(a.backupMapBounds(),Sa(a.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=a.displayBoundsMargin,this._sizeStart=un(a.mapBoundsStart,this.zMax,i.graphic.geometry.spatialReference),i.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const i=this._tool,a=i.graphic;return li(t,((t,o,n)=>{null!=i.inputState&&(o.next((t=>("start"===t.action&&i.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),t))).next(ni(i.view,this._displayBoundsStart.plane)).next((t=>({...t,handle:e}))).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next((t=>{const e={graphic:a,xScale:t.factor1,yScale:t.factor2};switch(t.action){case"start":case"update":i.emit("graphic-scale",e);break;case"end":i.inputState=null,i.emit("graphic-scale-stop",e)}return t})),n.next((()=>{null!=i.inputState&&i.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1}),i.cancel()})))}))}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return e=>{const i=this._displayBoundsStart,a=e.handle.direction,o=t.displayBoundsMargin,n=this._displayBoundsMarginStart,s=V(St.get(),i.origin);z(s,s,i.basis1,-a[0]),z(s,s,i.basis2,-a[1]);const r=I(St.get(),e.renderEnd,s),l=I(St.get(),e.renderStart,s),p=fa(e.handle),h=va(i),c=va(t.displayBounds)/h,u=(t,e)=>{if(0===t)return 1;let i=P(e),a=.5*t*G(e,r)/i;const s=a<0?-1:1;p&&(a+=(i-.5*t*G(e,l)/i)*s*c);const h=i<1.5*n?1:mn;return i=Math.max(i-n,mn),s>0&&(a-=o),s*Math.max(s*(a/i),h)};return{...e,factor1:u(a[0],i.basis1),factor2:u(a[1],i.basis2)}}}_resizeDragUpdateGeometry(){const t=this._tool,e=this._bounds;return i=>{const a=V(H(),e.mapBoundsStart.origin);z(a,a,e.mapBoundsStart.basis1,-i.handle.direction[0]),z(a,a,e.mapBoundsStart.basis2,-i.handle.direction[1]);const o=dt(vt(),e.mapBoundsStart.basis1[0],e.mapBoundsStart.basis1[1]);mt(o,o);const n=[];for(const t of this._editGeometryOperations.data.components)n.push(...t.vertices);const s="start"===i.action?Ci.NEW_STEP:Ci.ACCUMULATE_STEPS,r=this._editGeometryOperations.scaleVertices(n,a,o,i.factor1,i.factor2,s,Li.REPLACE);return Sa(e.mapBoundsStart,e.mapBounds),te(r,e.mapBounds),t.graphic.geometry=this._editGeometryOperations.data.geometry,i}}}const mn=1e-6;class gn{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&null!=this._lastDragEvent&&null!=this._next){const e={...this._lastDragEvent,action:"update"};t&&this._adjustScaleFactors(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new ui;return this._next=t,[t=>(this._lastDragEvent="end"!==t.action?{...t}:null,this._enabled&&this._adjustScaleFactors(t),t),t]}_adjustScaleFactors(t){const e=fa(t.handle)?Math.max(Math.abs(t.factor1),Math.abs(t.factor2)):0===t.handle.direction[0]?Math.abs(t.factor2):Math.abs(t.factor1);t.factor1=t.factor1<0?-e:e,t.factor2=t.factor2<0?-e:e}get test(){return{_adjustScaleFactors:t=>this._adjustScaleFactors(t)}}}let _n=class extends(le.EventedMixin(mi)){constructor(t){super(t),this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.sketchOptions=new we,this._preserveAspectRatio=new gn,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:t,graphic:e}=this,i=this._graphicState=new qt({graphic:e}),a=e.geometry,o=this._editGeometryOperations=Di.fromGeometry(a,t.state.viewingMode),n=this._bounds=new pn(this,(()=>this._updateManipulators()),o.data);this._extentMove=new rn(this,i,o,n),this._extentScale=new dn(this,i,o,n,(()=>this._preserveAspectRatio.createDragEventPipelineStep())),this._extentRotate=new ln(this,o,n),this.addHandles([m((()=>this.enableZ),(()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,Wa.TRANSLATE_Z))),m((()=>this.enableScaling),(()=>this._extentScale.forEachManipulator((t=>this._updateManipulatorAvailability(t,Wa.SCALE))))),m((()=>this.enableRotation),(()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,Wa.ROTATE)))]),this._updateAllManipulatorAvailability();const s=io({view:t,graphic:e,forEachManipulator:t=>this._forEachManipulator(t),onManipulatorsChanged:()=>r()});if(null!=s){const{visualElement:t}=s;t instanceof Xt&&(this._outlineVisualElement=t,this.addHandles(t.events.on("attachment-origin-changed",(()=>this._bounds.updateDisplayBounds())))),this.addHandles(s)}this.addHandles([i.on("changed",(()=>this._onGeometryChanged())),m((()=>i.displaying),(()=>this._updateAllManipulatorAvailability())),m((()=>i.isDraped),(()=>this._graphicDrapedChanged()),y),m((()=>t.pointsOfInterest?.centerOnSurfaceFrequent.location),(()=>n.updateDisplayBounds())),t.trackGraphicState(i)]),this._forEachManipulator((t=>{this.addHandles(t.events.on("grab-changed",(()=>{this.grabbing=t.grabbing,this._updateAllManipulatorAvailability()})))})),this._forEachManipulator(((t,i)=>{this.addHandles(t.events.on("immediate-click",(t=>{i===Wa.TRANSLATE_XY&&this.emit("immediate-click",{...t,graphic:e}),t.stopPropagation()})))})),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this._editGeometryOperations.destroy(),this.tooltip.destroy(),this._set("view",null),this._set("graphic",null)}_initializeTooltip(){const{view:t}=this,e=this.tooltip=new Ui({view:t}),i=()=>{e.info=this._getUpdatedTooltipInfo()};this.addHandles([m((()=>this.sketchOptions.tooltips.effectiveEnabled),i),this.on("graphic-translate-start",i),this.on("graphic-translate",i),this.on("graphic-translate-stop",(()=>{this.tooltip.clear()})),this.on("graphic-rotate-start",i),this.on("graphic-rotate",i),this.on("graphic-rotate-stop",i),this.on("graphic-scale-start",i),this.on("graphic-scale",i),this.on("graphic-scale-stop",i)]),this._forEachManipulator((t=>{this.addHandles([t.events.on("focus-changed",i),t.events.on("grab-changed",i),t.events.on("drag",(t=>{"cancel"===t.action?this.tooltip.clear():i()}))])}))}_getUpdatedTooltipInfo(){return this.sketchOptions.tooltips.effectiveEnabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(fn),this._bounds.updateDisplayBounds(),this._graphicState.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",(t=>{null!=this._attachmentOrigin&&ke(t.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()})),fn)}_updateManipulators(){if(!this.visible)return;const t=this._bounds.displayBounds,e=ya(t,xt.get());this._extentMove.updateManipulators(e,t),this._extentScale.updateManipulators(e,t),this._extentRotate.updateManipulators(e,t)}_updateAllManipulatorAvailability(){this._forEachManipulator(((t,e)=>this._updateManipulatorAvailability(t,e)))}_updateManipulatorAvailability(t,e){const i=this.grabbing&&!t.grabbing;if(t.interactive=!i,t instanceof _e){const a=this._graphicState.displaying,o=this.enableZ&&Ae(this.graphic);switch(e){case Wa.ROTATE:t.available=a&&this.enableRotation;break;case Wa.SCALE:t.available=a&&(this.enableScaling||this.enableRotation||o),t.interactive=!i&&this.enableScaling,t.state=this.enableScaling?Ma:ba;break;case Wa.TRANSLATE_Z:t.available=a&&o;break;default:t.available=a}}}_forEachManipulator(t){this._extentMove.forEachManipulator(t),this._extentScale.forEachManipulator(t),this._extentRotate.forEachManipulator(t)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(t){this._preserveAspectRatio.enabled=t,this._set("preserveAspectRatio",t)}get attachmentOrigin(){const t=this.graphic.geometry,e=this._graphicState.isDraped?null:this._outlineVisualElement?.attachmentOrigin;return this._attachmentOrigin=e??ye(this.view,this.graphic)??t?.extent?.center,this._attachmentOrigin}reset(){}cancel(){if(this.canUndo){const t=this._editGeometryOperations.undo();ie(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}this.inputState=null}get canUndo(){return this._editGeometryOperations.canUndo}undo(){if(null!=this.inputState)this.view.activeTool=null;else if(this.canUndo){const t=this._editGeometryOperations.undo();ie(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get canRedo(){return this._editGeometryOperations.canRedo}redo(){if(this.canRedo){const t=this._editGeometryOperations.redo();te(t,this._bounds.mapBounds),this.graphic.geometry=this._editGeometryOperations.data.geometry}}get test(){return{moveZManipulator:this._extentMove.moveZManipulator,resizeManipulators:this._extentScale.resizeManipulators,rotateManipulator:this._extentRotate.rotateManipulator}}};t([M({constructOnly:!0,nonNullable:!0})],_n.prototype,"view",void 0),t([M({constructOnly:!0,nonNullable:!0})],_n.prototype,"graphic",void 0),t([M()],_n.prototype,"enableZ",void 0),t([M()],_n.prototype,"enableScaling",void 0),t([M()],_n.prototype,"enableRotation",void 0),t([M({constructOnly:!0,type:we})],_n.prototype,"sketchOptions",void 0),t([M()],_n.prototype,"preserveAspectRatio",null),t([M()],_n.prototype,"grabbing",void 0),t([M()],_n.prototype,"inputState",void 0),t([M({readOnly:!0})],_n.prototype,"type",void 0),t([M()],_n.prototype,"tooltip",void 0),_n=t([w("esri.views.3d.interactive.editingTools.transformGraphic.ExtentTransformTool")],_n);const fn="draped-elevation-changes";export{Na as DrawGraphicTool3D,_n as ExtentTransformTool,Oo as GraphicMoveTool,Ho as GraphicReshapeTool,sn as GraphicTransformTool};
