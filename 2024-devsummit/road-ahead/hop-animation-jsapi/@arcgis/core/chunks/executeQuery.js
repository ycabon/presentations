/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{h as o}from"../core/lang.js";import{whenOrAbort as r}from"../core/promiseUtils.js";import{a as e,b as a}from"./infoFor3D.js";import{D as n}from"./DataLayerSource.js";import{e as s}from"./executeQueryJSON.js";import{e as i}from"./executeQueryPBF.js";import f from"../rest/support/FeatureSet.js";import u from"../rest/support/Query.js";async function c(t,o,e,a){return async function(t,o,e,a){const n=e?.infoFor3D;if(!p(t,n)||null==n||!o.assetMaps||!o.features?.length)return f.fromJSON(o);const{meshFeatureSetFromJSON:s}=await r(import("./meshFeatureSet.js"),a);return s(t,n,o)}(o,await l(t,o,e,a),e,a)}async function l(r,f,c,l){const d={...l},y=function(o,r){let s=u.from(o);s.sourceSpatialReference=s.sourceSpatialReference??r?.sourceSpatialReference??null,(r?.gdbVersion||r?.dynamicDataSource)&&(s=s===o?s.clone():s,s.gdbVersion=o.gdbVersion||r.gdbVersion,s.dynamicDataSource=o.dynamicDataSource?n.from(o.dynamicDataSource):r.dynamicDataSource);const i=r?.infoFor3D;if(null!=i&&p(o,i)){s=s===o?s.clone():s,s.formatOf3DObjects=null;const{supportedFormats:r,queryFormats:n}=i,f=e("model/gltf-binary",r)??a("glb",r),u=e("model/gltf+json",r)??a("gtlf",r);for(const t of n){if(t===f){s.formatOf3DObjects=t;break}t!==u||s.formatOf3DObjects||(s.formatOf3DObjects=t)}if(!s.formatOf3DObjects)throw new t("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(null==s.outFields||!s.outFields.includes("*")){s=s===o?s.clone():s,null==s.outFields&&(s.outFields=[]);const{originX:t,originY:r,originZ:e,translationX:a,translationY:n,translationZ:f,scaleX:u,scaleY:c,scaleZ:l,rotationX:m,rotationY:p,rotationZ:d,rotationDeg:y}=i.transformFieldRoles;s.outFields.push(t,r,e,a,n,f,u,c,l,m,p,d,y)}}return s}(f,c),j=null!=f.outStatistics?.[0],b=o("featurelayer-pbf-statistics"),g=!j||b;let D;if("pbf"===c?.format&&g)try{D=await i(r,y,d)}catch(t){if("query:parsing-pbf"!==t.name)throw t;c.format="json"}return"json"!==c?.format&&g||(D=await s(r,y,d)),m(c?.fieldsIndex,D.fields),D}function m(t,o){if(null!=t&&null!=o)for(const r of o){const o=t.get(r.name);o&&Object.assign(r,o.toJSON())}}function p(t,o){return null!=o&&!0===t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}export{l as a,c as e,m as n};
