/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{L as e}from"./Logger.js";import{b as n}from"./maybe.js";import{i as o,g as r}from"./aaBoundingBox.js";import{f as s}from"./aaBoundingRect.js";import{isPoint as u,isPolygon as l,isPolyline as c,isMultipoint as i}from"../geometry/support/jsonUtils.js";import{O as a}from"./OptimizedFeature.js";import{O as f}from"./OptimizedFeatureSet.js";import{O as d}from"./OptimizedGeometry.js";function h(t,e){return t?e?4:3:e?3:2}const m=()=>e.getLogger("esri.layers.graphics.featureConversionUtils"),g={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},y=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s},p=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+2]},b=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+3]},w=(t,e,n,o,r,s)=>{t[n]=r,t[n+1]=s,t[n+2]=e[o+2],t[n+3]=e[o+3]};function I(t,e,n,o){if(t){if(n)return e&&o?w:p;if(e&&o)return b}else if(e&&o)return p;return y}function M({scale:t,translate:e},n){return Math.round((n-e[0])/t[0])}function G({scale:t,translate:e},n){return Math.round((e[1]-n)/t[1])}function N({scale:t,translate:e},n,o){return n*t[o]+e[o]}function T(t,e,n){return t?e?n?k(t):P(t):n?x(t):j(t):null}function j(t){const e=t.coords;return{x:e[0],y:e[1]}}function F(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function P(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function Z(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function x(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function v(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function k(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function z(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function E(t,e){return t&&e?z:t?Z:e?v:F}function L(t,e,n=E(null!=e.z,null!=e.m)){return n(t,e)}function O(t,e,n){if(null==t)return null;const o=h(e,n),r=[];for(let e=0;e<t.coords.length;e+=o){const n=[];for(let r=0;r<o;r++)n.push(t.coords[e+r]);r.push(n)}return e?n?{points:r,hasZ:e,hasM:n}:{points:r,hasZ:e}:n?{points:r,hasM:n}:{points:r}}function q(t,e,n=h(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const o=t.coords;let r=0;for(const t of e.points)for(let e=0;e<n;e++)o[r++]=t[e];return t}function U(t,e,n){if(!t)return null;const o=h(e,n),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let n=0;n<t;n++){const t=[];for(let e=0;e<o;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?n?{paths:u,hasZ:e,hasM:n}:{paths:u,hasZ:e}:n?{paths:u,hasM:n}:{paths:u}}function R(t,e,n=h(e.hasZ,e.hasM)){const{lengths:o,coords:r}=t;let s=0;for(const t of e.paths){for(const e of t)for(let t=0;t<n;t++)r[s++]=e[t];o.push(t.length)}return t}function S(t,e,n){if(!t)return null;const o=h(e,n),{coords:r,lengths:s}=t,u=[];let l=0;for(const t of s){const e=[];for(let n=0;n<t;n++){const t=[];for(let e=0;e<o;e++)t.push(r[l++]);e.push(t)}u.push(e)}return e?n?{rings:u,hasZ:e,hasM:n}:{rings:u,hasZ:e}:n?{rings:u,hasM:n}:{rings:u}}function V(t,e,n=e.hasZ,o=e.hasM){return Y(t,e.rings,n,o)}function Y(t,e,n,o){const r=h(n,o),{lengths:s,coords:u}=t;let l=0;it(t);for(const t of e){for(const e of t)for(let t=0;t<r;t++)u[l++]=e[t];s.push(t.length)}return t}const $=[],_=[];function B(t,e,n,o,r){$[0]=t;const[s]=A(_,$,e,n,o,r);return at($),at(_),s}function A(e,n,o,r,s,u){if(at(e),!o){for(const t of n){const n=u?t.attributes[u]:void 0;e.push(new a(null,t.attributes,null,n))}return e}switch(o){case"esriGeometryPoint":return function(t,e,n,o,r){const s=E(n,o);for(const{geometry:n,attributes:o}of e){const e=null!=n?s(new d,n):null;t.push(new a(e,o,null,r?o[r]:void 0))}return t}(e,n,r,s,u);case"esriGeometryMultipoint":return function(t,e,n,o,r){const s=h(n,o);for(const{geometry:n,attributes:o}of e){const e=null!=n?q(new d,n,s):null;t.push(new a(e,o,null,r?o[r]:void 0))}return t}(e,n,r,s,u);case"esriGeometryPolyline":return function(t,e,n,o,r){const s=h(n,o);for(const{geometry:n,attributes:o,centroid:u}of e){const e=null!=n?R(new d,n,s):null,l=null!=u?L(new d,u):null;t.push(new a(e,o,l,r?o[r]:void 0))}return t}(e,n,r,s,u);case"esriGeometryPolygon":return function(t,e,n,o,r){for(const{geometry:s,centroid:u,attributes:l}of e){const e=null!=s?V(new d,s,n,o):null,c=r?l[r]:void 0;null!=u?t.push(new a(e,l,F(new d,u),c)):t.push(new a(e,l,null,c))}return t}(e,n,r,s,u);default:m().error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${o}'`)),at(e)}return e}function C(t,e,n,o){_[0]=t,J($,_,e,n,o);const r=$[0];return at($),at(_),r}function D(e,n,o){if(null==e)return null;const r=new d;return"hasZ"in e&&null==n&&(n=e.hasZ),"hasM"in e&&null==o&&(o=e.hasM),u(e)?E(null!=n?n:null!=e.z,null!=o?o:null!=e.m)(r,e):l(e)?V(r,e,n,o):c(e)?R(r,e,h(n,o)):i(e)?q(r,e,h(n,o)):void m().error("convertFromGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${e}'`))}function H(e,n,o,r){const s=e&&("coords"in e?e:e.geometry);if(null==s)return null;switch(n){case"esriGeometryPoint":{let t=j;return o&&r?t=k:o?t=P:r&&(t=x),t(s)}case"esriGeometryMultipoint":return O(s,o,r);case"esriGeometryPolyline":return U(s,o,r);case"esriGeometryPolygon":return S(s,o,r);default:return m().error("convertToGeometry:unknown-geometry",new t(`Unable to parse unknown geometry type '${n}'`)),null}}function J(e,n,o,r,s){if(at(e),null==o)return function(t,e){for(const n of e)t.push({attributes:n.attributes});return t}(e,n);switch(o){case"esriGeometryPoint":return function(t,e,n,o){let r=j;n&&o?r=k:n?r=P:o&&(r=x);for(const n of e){const{geometry:e,attributes:o}=n,s=null!=e?r(e):null;t.push({attributes:o,geometry:s})}return t}(e,n,r,s);case"esriGeometryMultipoint":return function(t,e,n,o){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?O(r,n,o):null});return t}(e,n,r,s);case"esriGeometryPolyline":return function(t,e,n,o){for(const{geometry:r,attributes:s}of e)t.push({attributes:s,geometry:null!=r?U(r,n,o):null});return t}(e,n,r,s);case"esriGeometryPolygon":return function(t,e,n,o){for(const{geometry:r,attributes:s,centroid:u}of e){const e=null!=r?S(r,n,o):null;if(null!=u){const n=j(u);t.push({attributes:s,centroid:n,geometry:e})}else t.push({attributes:s,geometry:e})}return t}(e,n,r,s);default:m().error("convertToFeatureSet:unknown-geometry",new t(`Unable to parse unknown geometry type '${o}'`))}return e}function K(t){const{objectIdFieldName:e,spatialReference:n,transform:o,fields:r,hasM:s,hasZ:u,features:l,geometryType:c,exceededTransferLimit:i,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=t,h={features:J([],l,c,u,s),fields:r,geometryType:c,objectIdFieldName:e,spatialReference:n,uniqueIdField:a,queryGeometry:H(f,d,!1,!1)};return o&&(h.transform=o),i&&(h.exceededTransferLimit=i),s&&(h.hasM=s),u&&(h.hasZ=u),h}function Q(e,n){const o=new f,{hasM:r,hasZ:s,features:u,objectIdFieldName:l,spatialReference:c,geometryType:i,exceededTransferLimit:a,transform:d,fields:h}=e;return h&&(o.fields=h),o.geometryType=i??null,o.objectIdFieldName=l??n??null,o.spatialReference=c??null,o.objectIdFieldName?(u&&A(o.features,u,i,s,r,o.objectIdFieldName),a&&(o.exceededTransferLimit=a),r&&(o.hasM=r),s&&(o.hasZ=s),d&&(o.transform=d),o):(m().error(new t("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),o)}function W(t){const{transform:e,features:n,hasM:o,hasZ:r}=t;if(!e)return t;for(const t of n)null!=t.geometry&&st(t.geometry,t.geometry,o,r,e),null!=t.centroid&&st(t.centroid,t.centroid,o,r,e);return t.transform=null,t}function X(t,e){const{geometryType:n,features:o,hasM:r,hasZ:s}=e;if(!t)return e;for(let e=0;e<o.length;e++){const u=o[e],l=u.weakClone();l.geometry=new d,tt(l.geometry,u.geometry,r,s,n,t),u.centroid&&(l.centroid=new d,tt(l.centroid,u.centroid,r,s,"esriGeometryPoint",t)),o[e]=l}return e.transform=t,e}function tt(t,e,n,o,r,s,u=n,l=o){if(it(t),!e?.coords.length)return null;const c=g[r],{coords:i,lengths:a}=e,f=h(n,o),d=h(n&&u,o&&l),m=I(n,o,u,l);if(!a.length)return m(t.coords,i,0,0,M(s,i[0]),G(s,i[1])),it(t,f,0),t;let y,p,b,w,N=0,T=0,j=T;for(const e of a){if(e<c)continue;let n=0;T=j,b=y=M(s,i[N]),w=p=G(s,i[N+1]),m(t.coords,i,T,N,b,w),n++,N+=f,T+=d;for(let o=1;o<e;o++,N+=f)b=M(s,i[N]),w=G(s,i[N+1]),b===y&&w===p||(m(t.coords,i,T,N,b-y,w-p),T+=d,n++,y=b,p=w);n>=c&&(t.lengths.push(n),j=T)}return at(t.coords,j),t.coords.length?t:null}function et(t,e,n,o,r,s,u=n,l=o){if(it(t),!e?.coords.length)return null;const c=g[r],{coords:i,lengths:a}=e,f=h(n,o),d=h(n&&u,o&&l),m=I(n,o,u,l);if(!a.length)return m(t.coords,i,0,0,i[0],i[1]),it(t,f,0),t;let y=0;const p=s*s;for(const e of a){if(e<c){y+=e*f;continue}const n=t.coords.length/d,o=y,r=y+(e-1)*f;m(t.coords,i,t.coords.length,o,i[o],i[o+1]),ot(t.coords,i,f,p,m,o,r),m(t.coords,i,t.coords.length,r,i[r],i[r+1]);const s=t.coords.length/d-n;s>=c?t.lengths.push(s):at(t.coords,n*d),y+=e*f}return t.coords.length?t:null}function nt(t,e,n,o){const r=t[e],s=t[e+1],u=t[n],l=t[n+1],c=t[o],i=t[o+1];let a=u,f=l,d=c-a,h=i-f;if(0!==d||0!==h){const t=((r-a)*d+(s-f)*h)/(d*d+h*h);t>1?(a=c,f=i):t>0&&(a+=d*t,f+=h*t)}return d=r-a,h=s-f,d*d+h*h}function ot(t,e,n,o,r,s,u){let l,c=o,i=0;for(let t=s+n;t<u;t+=n)l=nt(e,t,s,u),l>c&&(i=t,c=l);c>o&&(i-s>n&&ot(t,e,n,o,r,s,i),r(t,e,t.length,i,e[i],e[i+1]),u-i>n&&ot(t,e,n,o,r,i,u))}function rt(t,e,n,u){if(!e?.coords?.length)return null;const l=h(n,u);let c=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;if(e&&e.coords){const t=e.coords;for(let e=0;e<t.length;e+=l){const n=t[e],o=t[e+1];c=Math.min(c,n),a=Math.max(a,n),i=Math.min(i,o),f=Math.max(f,o)}}return o(t)?r(t,c,i,a,f):s(c,i,a,f,t),t}function st(t,e,o,r,s){const{coords:u,lengths:l}=e,c=h(o,r);if(!u.length)return t!==e&&it(t),t;n(s);const{originPosition:i,scale:a,translate:f}=s,d=ft;d.originPosition=i;const m=d.scale;m[0]=a[0]??1,m[1]=-(a[1]??1),m[2]=a[2]??1,m[3]=a[3]??1;const g=d.translate;if(g[0]=f[0]??0,g[1]=f[1]??0,g[2]=f[2]??0,g[3]=f[3]??0,!l.length){for(let e=0;e<c;++e)t.coords[e]=N(d,u[e],e);return t!==e&&it(t,c,0),t}let y=0;for(let e=0;e<l.length;e++){const n=l[e];t.lengths[e]=n;for(let e=0;e<c;++e)t.coords[y+e]=N(d,u[y+e],e);let o=t.coords[y],r=t.coords[y+1];y+=c;for(let e=1;e<n;e++,y+=c){o+=u[y]*m[0],r+=u[y+1]*m[1],t.coords[y]=o,t.coords[y+1]=r;for(let e=2;e<c;++e)t.coords[y+e]=N(d,u[y+e],e)}}return t!==e&&it(t,u.length,l.length),t}function ut(t,e,n,o,r,s){if(it(t),t.lengths.push(...e.lengths),n===r&&o===s)for(let n=0;n<e.coords.length;n++)t.coords.push(e.coords[n]);else{const u=h(n,o),l=I(n,o,r,s),c=e.coords;for(let e=0;e<c.length;e+=u)l(t.coords,c,t.coords.length,e,c[e],c[e+1])}return t}function lt(t,e,n,o){let r=0,s=t[o*e],u=t[o*(e+1)];for(let l=1;l<n;l++){const n=s+t[o*(e+l)],c=u+t[o*(e+l)+1],i=(n-s)*(c+u);s=n,u=c,r+=i}return.5*r}function ct(t,e){const{coords:n,lengths:o}=t;let r=0,s=0;for(let t=0;t<o.length;t++){const u=o[t];s+=lt(n,r,u,e),r+=u}return Math.abs(s)}function it(t,e=0,n=0){at(t.lengths,n),at(t.coords,e)}function at(t,e=0){t.length!==e&&(t.length=e)}const ft={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{K as a,H as b,V as c,D as d,A as e,C as f,rt as g,B as h,et as i,T as j,U as k,S as l,O as m,W as n,Q as o,L as p,tt as q,ut as r,Y as s,ct as t,st as u,X as v};
