/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{id as t}from"../kernel.js";import{symbolTypesRenderer as e}from"../symbols.js";import{a as r}from"./asyncUtils.js";import n from"../core/Error.js";import{J as a}from"./jsonMap.js";import{parseWhereClause as o}from"../core/sql.js";import{c as s}from"../core/accessorSupport/decorators/subclass.js";import{q as i}from"./featureQueryAll.js";import{f as u}from"./layerUtils2.js";import c from"../renderers/SimpleRenderer.js";import l from"../renderers/UniqueValueRenderer.js";import p from"../rest/support/AttachmentQuery.js";import d from"../rest/support/Query.js";import y from"../rest/support/RelationshipQuery.js";const f=new a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function m(t,e,r,a){const o=await G(t);if(await h(t,e,a),!o.addAttachment)throw new n(a,"Layer source does not support addAttachment capability");return o.addAttachment(e,r)}function h(t,e,r){const{attributes:a}=e,{objectIdField:o}=t;return t.capabilities?.data?.supportsAttachment?e?a?o&&a[o]?Promise.resolve():Promise.reject(new n(r,`feature is missing the identifying attribute ${o}`)):Promise.reject(new n(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new n(r,"A feature is required to add/delete/update attachments")):Promise.reject(new n(r,"this layer doesn't support attachments"))}async function w(t,e,r,a,o){const s=await G(t);if(await h(t,e,o),!s.updateAttachment)throw new n(o,"Layer source does not support updateAttachment capability");return s.updateAttachment(e,r,a)}async function b(t,e,r){const{applyEdits:n}=await import("./editingSupport.js"),a=await t.load(),{source:o,globalIdField:s}=a;let i=r;return("feature"===a.type?a.infoFor3D:null)&&null!=e.deleteFeatures&&null!=s&&(i={...i,globalIdToObjectId:await U(t,e.deleteFeatures,s)}),n(a,o,e,r)}async function g(t,e,r){const{uploadAssets:n}=await import("./editingSupport.js"),a=await t.load();return n(a,a.source,e,r)}async function j(t,e,r,a){const o=await G(t);if(await h(t,e,a),!o.deleteAttachments)throw new n(a,"Layer source does not support deleteAttachments capability");return o.deleteAttachments(e,r)}async function I(t,e,r){const a=(await t.load({signal:e?.signal})).source;if(!a.fetchRecomputedExtents)throw new n(r,"Layer source does not support fetchUpdates capability");return a.fetchRecomputedExtents(e)}async function q(t,e,r,a){e=p.from(e),await t.load();const o=t.source,s=t.capabilities;if(!s?.data?.supportsAttachment)throw new n(a,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:c,num:l,size:d,start:y,where:f}=e;if(!s?.operations?.supportsQueryAttachments&&(i?.length>0||c?.length>0||d?.length>0||l||y||f))throw new n(a,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(u?.length||c?.length||f))throw new n(a,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!o.queryAttachments)throw new n(a,"Layer source does not support queryAttachments capability",e);return o.queryAttachments(e)}async function F(t,e,r,a){const o=await G(t);if(!o.queryObjectIds)throw new n(a,"Layer source does not support queryObjectIds capability");return o.queryObjectIds(d.from(e)??t.createQuery(),r)}async function A(t,e,r,a){const o=await G(t);if(!o.queryFeatureCount)throw new n(a,"Layer source does not support queryFeatureCount capability");return o.queryFeatureCount(d.from(e)??t.createQuery(),r)}async function O(t,e,r,a){const o=await G(t);if(!o.queryExtent)throw new n(a,"Layer source does not support queryExtent capability");return o.queryExtent(d.from(e)??t.createQuery(),r)}async function P(t,e,r,a){const o=await G(t);if(!o.queryRelatedFeatures)throw new n(a,"Layer source does not support queryRelatedFeatures capability");return o.queryRelatedFeatures(y.from(e),r)}async function E(t,e,r,a){const o=await G(t);if(!o.queryRelatedFeaturesCount)throw new n(a,"Layer source does not support queryRelatedFeaturesCount capability");return o.queryRelatedFeaturesCount(y.from(e),r)}async function S(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:n}=await e.refresh();if(null!=n&&(t.sourceJSON={...t.sourceJSON,...n},t.read(n,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await o(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function R(t){const e=new d,r=t.capabilities?.data,n=t.capabilities?.query;e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:a,timeExtent:o}=t;return e.timeExtent=null!=a&&null!=o?o.offset(-a.value,a.unit):o||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function x(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeGlobalID"===t.type)return t.name}function M(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeOID"===t.type)return t.name}function C(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function G(t){return(await t.load()).source}async function L(e,r,n){const a=e.parsedUrl?.path;a&&e.authenticationTriggerEvent===r&&await async function(e,r){if(!t)return;if(t.findCredential(e))return;let n;try{const a=await u(e,r);a&&(n=await t.checkSignInStatus(`${a}/sharing`))}catch(t){}if(n)try{const n=null!=r?r.signal:null;await t.getCredential(e,{signal:n})}catch(t){}}(a,n)}function Q(t){return!t.sourceJSON?.isMultiServicesView&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const v=s({types:e});function T(t,e){if(t.defaultSymbol)return t.types?.length?new l({defaultSymbol:v(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map((t=>({id:t.id,symbol:v(t.symbol,t,e)})))}):new c({symbol:v(t.defaultSymbol,t,e)})}function D(t){let e=t.sourceJSON?.cacheMaxAge;if(!e)return!1;const r=t.editingInfo?.lastEditDate?.getTime();return null==r||(e*=1e3,Date.now()-r<e)}async function U(t,e,n){if(null==e)return null;const a=[],{objectIdField:o}=t;if(e.forEach((t=>{let e=null;if("attributes"in t){const{attributes:r}=t;e={globalId:r[n],objectId:null!=r[o]&&-1!==r[o]?r[o]:null}}else e={globalId:t.globalId,objectId:null!=t.objectId&&-1!==t.objectId?t.objectId:null};null!=e.globalId&&(null!=e.objectId&&-1!==e.objectId||a.push(e.globalId))})),0===a.length)return null;const s=t.createQuery();s.where=a.map((t=>`${n}='${t}'`)).join(" OR "),s.returnGeometry=!1,s.outFields=[o,n],s.cacheHint=!1;const u=await r(i(t,s));if(!u.ok)return null;const c=new Map,l=u.value.features;for(const t of l){const e=t.attributes[n],r=t.attributes[o];null!=e&&null!=r&&-1!==r&&c.set(e,r)}return c}export{Q as a,m as b,T as c,b as d,L as e,R as f,j as g,I as h,F as i,A as j,O as k,P as l,E as m,S as n,M as o,g as p,q,x as r,f as s,D as t,w as u,C as v,U as w};
