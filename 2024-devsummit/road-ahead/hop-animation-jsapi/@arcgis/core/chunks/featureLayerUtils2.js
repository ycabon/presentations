/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{e as r,s as e}from"../core/lang.js";import"../core/Error.js";import{s as t,a as o}from"./utils22.js";import{p as s}from"./arcgisLayerUrl.js";import{f as a}from"./fetchService.js";import{l as i}from"./layerUtils2.js";import{l as p}from"./lazyLayerLoader.js";import{a as l,r as n,t as m,b as c}from"./portalItemUtils.js";import"./Logger.js";import"../config.js";import"./originUtils.js";import"./multiOriginJSONSupportUtils.js";import"../portal/Portal.js";import"./tslib.es6.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"./persistableUrlUtils.js";import"./jsonContext.js";import"./saveAPIKeyUtils.js";import"./saveUtils.js";import"./requestPresets.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"./vec3f64.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";const u="Feature Service",y="feature-layer-utils",j=`${y}-save`,f=`${y}-save-as`;function d(r){return{isValid:i(r)&&("feature"!==r.type||!r.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function g(r){const e=[],t=[];for(const{layer:o,layerJSON:s}of r)o.isTable?t.push(s):e.push(s);return{layers:e,tables:t}}function b(r){return g([r])}function P(e,t){if(e.length<2)return;const o=[];for(const{id:r}of e)o.push(r);r(o.sort(S),t.slice().sort(S))&&e.sort(((r,e)=>{const o=t.indexOf(r.id),s=t.indexOf(e.id);return o<s?-1:o>s?1:0}))}function S(r,e){return r<e?-1:r>e?1:0}function h(r,t,o){const s=e(r,t,((r,e)=>r.id===e.id));r=r.filter((r=>!s.removed.some((e=>e.id===r.id))));const a=s.added;return a.forEach((({id:e})=>{r.push({id:e})})),{itemResources:r,added:a.filter((({id:r})=>!o.includes(r)))}}function L(r,e,t){r.isTable?I(t.tables,e):I(t.layers,e)}function I(r,e){const t=r.findIndex((({id:r})=>r===e.id));-1===t?r.push(e):r[t]=e}async function U(r,e){const{url:t,layerId:o,title:a,fullExtent:i,isTable:p}=r,u=s(t);e.url="FeatureServer"===u?.serverType?t:`${t}/${o}`,e.title||=a,e.extent=null,p||null==i||(e.extent=await l(i)),n(e,m.METADATA),n(e,m.MULTI_LAYER),c(e,m.SINGLE_LAYER),p&&c(e,m.TABLE)}async function v(r,e){return t({layer:r,itemType:u,validateLayer:d,createItemData:(r,e)=>async function(r,e){return/\/\d+\/?$/.test(r.url)?b(e[0]):async function(r,e){if(r.reverse(),!e)return g(r);const t=await async function(r,e){let t=await r.fetchData("json");if(function(r){return!!(r&&Array.isArray(r.layers)&&Array.isArray(r.tables))}(t))return t;t||={},function(r){r.layers||=[],r.tables||=[]}(t);const{layer:{url:o,customParameters:s,apiKey:i}}=e[0];return await async function(r,e,t){const{url:o,customParameters:s,apiKey:i}=e,{serviceJSON:l,layersJSON:n}=await a(o,{customParameters:s,apiKey:i}),m=h(r.layers,l.layers,t),c=h(r.tables,l.tables,t);r.layers=m.itemResources,r.tables=c.itemResources;const u=[...m.added,...c.added],y=n?[...n.layers,...n.tables]:[];await async function(r,e,t,o){const s=await async function(r){const e=[];r.forEach((({type:r})=>{const t=function(r){let e;switch(r){case"Feature Layer":case"Table":e="FeatureLayer";break;case"Oriented Imagery Layer":e="OrientedImageryLayer";break;case"Catalog Layer":e="CatalogLayer"}return e}(r),o=p[t];e.push(o())}));const t=await Promise.all(e),o=new Map;return r.forEach((({type:r},e)=>{o.set(r,t[e])})),o}(e),a=e.map((({id:r,type:e})=>new(s.get(e))({url:t,layerId:r,sourceJSON:o.find((({id:e})=>e===r))})));await Promise.allSettled(a.map((r=>r.load()))),a.forEach((e=>{const{layerId:t,loaded:o,defaultPopupTemplate:s}=e;if(!o||null==s)return;const a={id:t,popupInfo:s.toJSON()};"ArcGISFeatureLayer"!==e.operationalLayerType&&(a.layerType=e.operationalLayerType),L(e,a,r)}))}(r,u,o,y)}(t,{url:o??"",customParameters:s,apiKey:i},e.map((r=>r.layer.layerId))),t}(e,r);for(const e of r)L(e.layer,e.layerJSON,t);return function(r,e){const t=[],o=[];for(const{layer:r}of e){const{isTable:e,layerId:s}=r;e?o.push(s):t.push(s)}P(r.layers,t),P(r.tables,o)}(t,r),t}(e,r)}(e,[r]),errorNamePrefix:j},e)}async function T(r,e,t){return o({layer:r,itemType:u,validateLayer:d,createItemData:(r,e)=>Promise.resolve(b(r)),errorNamePrefix:f,newItem:e,setItemProperties:U},t)}export{v as save,T as saveAs};
