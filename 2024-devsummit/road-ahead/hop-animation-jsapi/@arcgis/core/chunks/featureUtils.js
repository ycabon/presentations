/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{r as e,L as t}from"./Logger.js";import{f as n,c as r}from"./date.js";import{formatNumber as i,convertNumberFormatToIntlOptions as o}from"../intl.js";import{featureHasFields as a,isTimeOnlyField as s,l,isRasterPixelValueField as u}from"../layers/support/fieldUtils.js";import{g as f}from"./layerUtils2.js";import{i as c,f as d}from"./utils2.js";import{g as p}from"./timeZoneUtils.js";const m=()=>t.getLogger("esri.widgets.Feature.support.featureUtils"),y=/href=(""|'')/gi,g=/(\{([^\{\r\n]+)\})/g,I=/\'/g,h=/^\s*expression\//i,b=/(\n)/gi,T=/[\u00A0-\u9999<>\&]/gim,w=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,F=/^(?:mailto:|tel:)/,N="relationships/",Z=r("short-date-short-time");function j(e){if(null!=e)return(e.sourceLayer||e.layer)??void 0}async function E(e,t){return"function"==typeof e?e(t):e}function x(e=""){if(e)return!F.test(e.trim().toLowerCase())}function q(e){return!!e&&h.test(e)}function v(e,t){const n=function(e,t){if(!q(t)||!e)return;const n=t.replace(h,"").toLowerCase();return e.find((({name:e})=>e.toLowerCase()===n))}(t,e?.fieldName);return n?n.title||null:e?e.label||e.fieldName:null}function C(e,t){const n=A(t,e);return n?n.name:e}function U(e,t){return e&&e.map((e=>C(e,t)))}function A(e,t){return e&&"function"==typeof e.getField&&t?e.getField(t)??null:null}function L(e){return`${e}`.trim()}function M({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:o}){return r?R({formattedAttributes:t,template:k(r,{...t,...i,...e},n),fieldInfoMap:o}):""}function R({formattedAttributes:t,template:n,fieldInfoMap:r}){return L((i=e(e(n,(e=>function(e,t){const n=t.get(e.toLowerCase());return`{${n?.fieldName||e}}`}(e,r))),t),i.replaceAll(y,"")));var i}function $(e,t){return e.replaceAll(g,((e,n,r)=>{const i=A(t,r);return i?`{${i.name}}`:n}))}function k(t,n,r){const i=$(t,r);return i?i.replaceAll(w,((t,r,i)=>function(t,n,r){const i=(n=L(n))&&"{"!==n[0];return e(t,function(e,t=!1){const n={...e};return Object.keys(n).forEach((e=>function(e,t,n=!1){const r=t[e];if("string"==typeof r){const i="%27",o=(n?encodeURIComponent(r):r).replaceAll(I,i);t[e]=o}}(e,n,t))),n}(r,i||!1))}(t,r||i,n))):i}function D(e){return function(e){return null!=e&&"object"==typeof e&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&("feature"===e.type||"scene"===e.type)&&"when"in e}(e)&&function(e){return null!=e&&"object"==typeof e&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}(e)}function z(e){return!!e&&"object"==typeof e&&"sourceLayer"in e&&D(e.sourceLayer)}function O(e,t,n,r){return e.trim().split(t).map((e=>i(Number(e),o(r)))).join(n)}function G(e,t){if(e?.length&&t)return e.find((e=>e.fieldName?.toLowerCase()===t.toLowerCase()))}function S(e,t,r,i){const{creatorField:o,creationDateField:a,editorField:s,editDateField:l}=e;if(!t)return;const u=p(i&&"preferredTimeZone"in i?i.preferredTimeZone:null,!(!i||!("datesInUnknownTimezone"in i)||!i.datesInUnknownTimezone),r,Z,"date"),f={...Z,...u},c=t[l];if("number"==typeof c){const e=t[s];return{type:"edit",date:n(c,f),user:e}}const d=t[a];if("number"==typeof d){const e=t[o];return{type:"create",date:n(d,f),user:e}}return null}function P(e,t){const n=new Map;return e?(e.forEach((e=>{const r=C(e.fieldName,t);e.fieldName=r,n.set(r.toLowerCase(),e)})),n):n}function Q(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)?(r.forEach((e=>{if("fields"===e.type){const n=e?.fieldInfos;n&&t.push(...n)}})),t):t}function _(e){return e.replaceAll(T,(e=>`&#${e.charCodeAt(0)};`))}function H(e){return"string"==typeof e?e.replaceAll(b,'<br class="esri-text-new-line" />'):e}function B(e){const{value:t,fieldName:n,fieldInfos:r,fieldInfoMap:a,layer:l,graphic:f,timeZone:p}=e;if(null==t)return"";const m=function({fieldName:e,value:t,graphic:n,layer:r}){if(W(e))return null;if(!r||"function"!=typeof r.getFieldDomain)return null;const i=n&&r.getFieldDomain(e,{feature:n});return i&&"coded-value"===i.type?i.getName(t):null}({fieldName:n,value:t,graphic:f,layer:l});if(m)return m;const y=function({fieldName:e,graphic:t,layer:n}){if(W(e))return null;if(!n||"function"!=typeof n.getFeatureType)return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const i=n.getFeatureType(t);return i?i.name:null}({fieldName:n,graphic:f,layer:l});if(y)return y;if(a.get(n.toLowerCase()))return function(e,t){const{fieldInfos:n,fieldName:r,preventPlacesFormatting:a,layer:s,timeZone:l}=t,f=G(n,r),c=A(s,r);if(f&&!u(r)){const t=c?.type,n=f.format?.dateFormat;if("date"===t||"date-only"===t||"time-only"===t||"timestamp-offset"===t||n)return d(e,{format:n,fieldType:t,timeZoneOptions:{layerTimeZone:s&&"preferredTimeZone"in s?s.preferredTimeZone:null,viewTimeZone:l,datesInUnknownTimezone:!(!s||!("datesInUnknownTimezone"in s)||!s.datesInUnknownTimezone)}})}const p=f?.format;return"string"==typeof e&&u(r)&&p?function(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?O(e,",",", ",t):e.includes(";")?O(e,";","; ",t):e.includes(" ")?O(e," "," ",t):i(Number(e),o(t))}(e,p):(e=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){const t=Number(e);if(!isNaN(t))return t}return e}(e,p),"string"==typeof e||null==e||null==p?H(e):i(e,a?{...o(p),minimumFractionDigits:0,maximumFractionDigits:20}:o(p)))}(t,{fieldInfos:r||Array.from(a.values()),fieldName:n,layer:l,timeZone:p});const g=l?.fieldsIndex?.get(n);return g&&(c(g)||s(g))?d(t,{fieldType:g.type,timeZoneOptions:{layerTimeZone:l&&"preferredTimeZone"in l?l.preferredTimeZone:null,viewTimeZone:p,datesInUnknownTimezone:!(!l||!("datesInUnknownTimezone"in l)||!l.datesInUnknownTimezone)}}):H(t)}function J({fieldInfos:e,attributes:t,layer:n,graphic:r,fieldInfoMap:i,relatedInfos:o,timeZone:a}){const s={};return o?.forEach((t=>function({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}){e&&t&&(t.relatedFeatures?.forEach((a=>X({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))),t.relatedStatsFeatures?.forEach((a=>X({attributes:e,graphic:a,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:o}))))}({attributes:s,relatedInfo:t,fieldInfoMap:i,fieldInfos:e,layer:n,timeZone:a}))),t&&Object.keys(t).forEach((o=>{const l=t[o];s[o]=B({fieldName:o,fieldInfos:e,fieldInfoMap:i,layer:n,value:l,graphic:r,timeZone:a})})),s}async function K(e,t){const{layer:n,graphic:r,outFields:i,objectIds:o,returnGeometry:a,spatialReference:s}=e,l=o[0];if("number"!=typeof l&&"string"!=typeof l){const e="Could not query required fields for the specified feature. The feature's ID is invalid.",t={layer:n,graphic:r,objectId:l,requiredFields:i};return m().warn(e,t),null}if(!f(n)?.operations?.supportsQuery){const e="The specified layer cannot be queried. The following fields will not be available.",t={layer:n,graphic:r,requiredFields:i,returnGeometry:a};return m().warn(e,t),null}const u=n.createQuery();return u.objectIds=o,u.outFields=i?.length?i:[n.objectIdField],u.returnGeometry=!!a,u.returnZ=!!a,u.returnM=!!a,u.outSpatialReference=s,(await n.queryFeatures(u,t)).features[0]}async function V({graphic:e,popupTemplate:t,layer:n,spatialReference:r},i){if(!n||!t)return;if("function"==typeof n.load&&await n.load(i),!e.attributes)return;const o=e.attributes[n.objectIdField];if(null==o)return;const s=[o],u=await t.getRequiredFields(n.fieldsIndex),f=a(u,e),c=f?[]:u,d=t.returnGeometry||await async function(e){if(!e.expressionInfos?.length)return!1;const t=await l(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}(t);if(f&&!d)return;const p=await K({layer:n,graphic:e,outFields:c,objectIds:s,returnGeometry:d,spatialReference:r},i);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes={...e.attributes,...p.attributes}))}function W(e=""){return!!e&&e.includes(N)}function X({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:o,timeZone:a}){e&&t&&n&&Object.keys(t.attributes).forEach((s=>{const l=(u={layerId:n.relation.id.toString(),fieldName:s})?`${N}${u.layerId}/${u.fieldName}`:"";var u;const f=t.attributes[s];e[l]=B({fieldName:l,fieldInfos:r,fieldInfoMap:i,layer:o,value:f,graphic:t,timeZone:a})}))}const Y=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},ee=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||"attachments"===t)return;const i=null!=n.where?n.where:null,o=null!=n.geometry?n.geometry:null;Y(r)||Y(i)||"extent"===o?.type||"tile"===n.resultType||(n.cacheHint=!0)},te=({query:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},ne=({queryPayload:e,layer:t,method:n})=>{ee({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})};function re(e,t,n){return e&&t&&n?ie(e.allLayers,t,n)||ie(e.allTables,t,n):null}function ie(e,t,{relatedTableId:n}){const r="scene"===t.type&&t.associatedLayer?t.associatedLayer.url:t.url;return e.filter(D).find((e=>e!==t&&e.url===r&&e.layerId===n))}function oe(e){const t=e.getObjectId();return null!=t?`oid:${t}`:`uid:${e.uid}`}export{j as a,C as b,z as c,E as d,v as e,re as f,oe as g,W as h,D as i,$ as j,R as k,U as l,q as m,G as n,H as o,_ as p,P as q,Q as r,M as s,K as t,S as u,V as v,J as w,te as x,ne as y,x as z};
