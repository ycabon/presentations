/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../config.js";import o from"../core/Error.js";import{h as t}from"../core/lang.js";import{L as r}from"./Logger.js";import i from"../geometry/Point.js";import{geographicToWebMercator as n}from"../geometry/support/webMercatorUtils.js";import s from"../portal/Portal.js";import{p as c}from"./project.js";import u from"../rest/support/ProjectParameters.js";const a=()=>r.getLogger("esri.widgets.support.geolocationUtils"),m={maximumAge:0,timeout:15e3,enableHighAccuracy:!0};function l(){return function(){const e=t("esri-geolocation");return e||a().warn("geolocation-unsupported","Geolocation unsupported."),e}()&&function(){const e=window.isSecureContext;return e||a().warn("insecure-context","Geolocation requires a secure origin."),e}()}function g(e){return e||(e=m),new Promise(((t,r)=>{setTimeout((()=>r(new o("geolocation:timeout","getting the current geolocation position timed out"))),15e3),navigator.geolocation.getCurrentPosition(t,r,e??void 0)}))}function p(t,r){const{position:a,view:m}=t,l=function(e){const o=e&&e.coords||{},t={accuracy:o.accuracy,altitude:o.altitude,altitudeAccuracy:o.altitudeAccuracy,heading:o.heading,latitude:o.latitude,longitude:o.longitude,speed:o.speed};return e?{coords:t,timestamp:e.timestamp}:e}(a),g=l?.coords;if(!g)throw new o("geometry-service:no-coords","Geolocation has no coordinates");return function(t,r,i){if(!r)return Promise.resolve(t);const a=r.spatialReference;return a.isWGS84?Promise.resolve(t):a.isWebMercator?Promise.resolve(n(t)):function(o){if(e.geometryServiceUrl)return Promise.resolve(e.geometryServiceUrl);const t=s.getDefault();return t.load(o).catch((()=>{})).then((()=>t.helperServices?.geometry?.url))}(i).then((e=>{if(!e)throw new o("geometry-service:missing-url","Geometry service URL is missing");const r=new u({geometries:[t],outSpatialReference:a});return c(e,r,i).then((e=>e[0]))}))}(function({longitude:e,latitude:o,altitude:t}){return new i({longitude:e,latitude:o,z:t||void 0,spatialReference:{wkid:4326}})}(g),m,r)}export{g,p,l as s};
