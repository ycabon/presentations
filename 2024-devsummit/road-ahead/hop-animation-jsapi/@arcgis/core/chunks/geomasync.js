/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{version as n}from"../kernel.js";import{L as t,p as e,M as r,O as i,P as a,B as o,A as s,E as l,f as c,e as u,G as f,y as m,Q as d,R as p,T as w,U as h,z as y,V as j,W as g,X as v,Y as P,F as I,Z as A,_ as F,$ as R}from"./arcadeUtils.js";import{c as b,a as x,b as N}from"./TimeOnly.js";import{g as S}from"./portalUtils.js";import{g as O}from"./unitUtils.js";import U from"../geometry/Extent.js";import D from"../geometry/Geometry.js";import{disjoint as k,intersects as z,touches as C,crosses as L,within as M,contains as T,overlaps as Z,equals as J,relate as E,intersect as B,union as q,difference as G,symmetricDifference as Q,clip as W,cut as V,planarArea as H,geodesicArea as X,planarLength as Y,geodesicLength as $,distance as _,densify as K,geodesicDensify as nn,generalize as tn,buffer as en,geodesicBuffer as rn,offset as an,rotate as on,simplify as sn,isSimple as ln,convexHull as cn,nearestCoordinate as un,nearestVertex as fn}from"../geometry/geometryEngineAsync.js";import mn from"../geometry/Multipoint.js";import dn from"../geometry/Point.js";import pn from"../geometry/Polygon.js";import wn from"../geometry/Polyline.js";import{fromJSON as hn}from"../geometry/support/jsonUtils.js";import yn from"../portal/Portal.js";import{l as jn}from"./utils20.js";import"../core/lang.js";import"../core/urlUtils.js";import"../config.js";import"../core/Error.js";import"./Logger.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../geometry.js";import"../geometry/SpatialReference.js";import"./writer.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"./typeUtils.js";import"../geometry/support/webMercatorUtils.js";import"./reader.js";import"./zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ImmutableArray.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"./datetime.js";import"./number.js";import"./locale.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./OptimizedGeometry.js";import"../layers/support/FieldsIndex.js";import"./UnknownTimeZone.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./timeZoneUtils.js";import"./messages.js";import"./hash.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"./SimpleObservable.js";import"../core/workers/RemoteClient.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";function gn(t){return 0===n.indexOf("4.")?pn.fromExtent(t):new pn({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function vn(n,t,r){if(e(n,2,2,t,r),n[0]instanceof D&&n[1]instanceof D);else if(n[0]instanceof D&&null===n[1]);else if(n[1]instanceof D&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new s(t,l.InvalidParameter,r)}async function Pn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid)&&(e=F(n.spatialReference)/O(n.spatialReference));let r=0;if("polyline"===n.type)for(const t of n.paths)for(let n=1;n<t.length;n++)r+=R(t[n],t[n-1],e);else if("polygon"===n.type)for(const t of n.rings){for(let n=1;n<t.length;n++)r+=R(t[n],t[n-1],e);(t[0][0]!==t[t.length-1][0]||t[0][1]!==t[t.length-1][1]||void 0!==t[0][2]&&t[0][2]!==t[t.length-1][2])&&(r+=R(t[0],t[t.length-1],e))}else"extent"===n.type&&(r+=2*R([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*R([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(d(n.zmax,0)*e-d(n.zmin,0)*e));const i=new wn({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return Y(i,t)}function In(n){"async"===n.mode&&(n.functions.disjoint=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null===a[0]||null===a[1]||k(a[0],a[1]))))},n.functions.intersects=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&z(a[0],a[1]))))},n.functions.touches=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&C(a[0],a[1]))))},n.functions.crosses=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&L(a[0],a[1]))))},n.functions.within=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&M(a[0],a[1]))))},n.functions.contains=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&T(a[0],a[1]))))},n.functions.overlaps=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null!==a[1]&&Z(a[0],a[1]))))},n.functions.equals=function(t,o){return n.standardFunctionAsync(t,o,((n,s,l)=>(e(l,2,2,t,o),l[0]===l[1]||(l[0]instanceof D&&l[1]instanceof D?J(l[0],l[1]):(r(l[0])&&r(l[1])||!!(i(l[0])&&i(l[1])||a(l[0])&&a(l[1])))&&l[0].equals(l[1])))))},n.functions.relate=function(r,i){return n.standardFunctionAsync(r,i,((n,a,c)=>{if(c=t(c),e(c,3,3,r,i),c[0]instanceof D&&c[1]instanceof D)return E(c[0],c[1],o(c[2]));if(c[0]instanceof D&&null===c[1])return!1;if(c[1]instanceof D&&null===c[0])return!1;if(null===c[0]&&null===c[1])return!1;throw new s(r,l.InvalidParameter,i)}))},n.functions.intersection=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null===a[0]||null===a[1]?null:B(a[0],a[1]))))},n.functions.union=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>{const o=[];if(0===(a=t(a)).length)throw new s(e,l.WrongNumberOfParameters,r);if(1===a.length)if(c(a[0])){const n=t(a[0]);for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof D))throw new s(e,l.InvalidParameter,r);o.push(n[t])}}else{if(!u(a[0])){if(a[0]instanceof D)return f(b(a[0]),e.spatialReference);if(null===a[0])return null;throw new s(e,l.InvalidParameter,r)}{const n=t(a[0].toArray());for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof D))throw new s(e,l.InvalidParameter,r);o.push(n[t])}}}else for(let n=0;n<a.length;n++)if(null!==a[n]){if(!(a[n]instanceof D))throw new s(e,l.InvalidParameter,r);o.push(a[n])}return 0===o.length?null:q(o)}))},n.functions.difference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null!==a[0]&&null===a[1]?b(a[0]):null===a[0]?null:G(a[0],a[1]))))},n.functions.symmetricdifference=function(e,r){return n.standardFunctionAsync(e,r,((n,i,a)=>(vn(a=t(a),e,r),null===a[0]&&null===a[1]?null:null===a[0]?b(a[1]):null===a[1]?b(a[0]):Q(a[0],a[1]))))},n.functions.clip=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,2,r,i),!(o[1]instanceof U)&&null!==o[1])throw new s(r,l.InvalidParameter,i);if(null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return null===o[1]?null:W(o[0],o[1])}))},n.functions.cut=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,2,r,i),!(o[1]instanceof wn)&&null!==o[1])throw new s(r,l.InvalidParameter,i);if(null===o[0])return[];if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return null===o[1]?[b(o[0])]:V(o[0],o[1])}))},n.functions.area=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(e(o,1,2,r,i),null===(o=t(o))[0])return 0;if(m(o[0])){const n=await o[0].sumArea(x(d(o[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(o[0])||u(o[0])){const n=p(o[0],r.spatialReference);return null===n?0:H(n,x(d(o[1],-1)))}if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return H(o[0],x(d(o[1],-1)))}))},n.functions.areageodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(e(o,1,2,r,i),null===(o=t(o))[0])return 0;if(m(o[0])){const n=await o[0].sumArea(x(d(o[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(o[0])||u(o[0])){const n=p(o[0],r.spatialReference);return null===n?0:X(n,x(d(o[1],-1)))}if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return X(o[0],x(d(o[1],-1)))}))},n.functions.length=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(e(o,1,2,r,i),null===(o=t(o))[0])return 0;if(m(o[0])){const n=await o[0].sumLength(N(d(o[1],-1)),!1,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(o[0])||u(o[0])){const n=w(o[0],r.spatialReference);return null===n?0:Y(n,N(d(o[1],-1)))}if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return Y(o[0],N(d(o[1],-1)))}))},n.functions.length3d=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(e(o,1,2,r,i),null===(o=t(o))[0])return 0;if(c(o[0])||u(o[0])){const n=w(o[0],r.spatialReference);return null===n?0:!0===n.hasZ?Pn(n,N(d(o[1],-1))):Y(n,N(d(o[1],-1)))}if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return!0===o[0].hasZ?Pn(o[0],N(d(o[1],-1))):Y(o[0],N(d(o[1],-1)))}))},n.functions.lengthgeodetic=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(e(o,1,2,r,i),null===(o=t(o))[0])return 0;if(m(o[0])){const n=await o[0].sumLength(N(d(o[1],-1)),!0,r.abortSignal);if(r.abortSignal.aborted)throw new s(r,l.Cancelled,i);return n}if(c(o[0])||u(o[0])){const n=w(o[0],r.spatialReference);return null===n?0:$(n,N(d(o[1],-1)))}if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return $(o[0],N(d(o[1],-1)))}))},n.functions.distance=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{o=t(o),e(o,2,3,r,i);let f=o[0];(c(o[0])||u(o[0]))&&(f=h(o[0],r.spatialReference));let m=o[1];if((c(o[1])||u(o[1]))&&(m=h(o[1],r.spatialReference)),!(f instanceof D))throw new s(r,l.InvalidParameter,i);if(!(m instanceof D))throw new s(r,l.InvalidParameter,i);return _(f,m,N(d(o[2],-1)))}))},n.functions.distancegeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{o=t(o),e(o,2,3,r,i);const c=o[0],u=o[1];if(!(c instanceof dn))throw new s(r,l.InvalidParameter,i);if(!(u instanceof dn))throw new s(r,l.InvalidParameter,i);const f=new wn({paths:[],spatialReference:c.spatialReference});return f.addPath([c,u]),$(f,N(d(o[2],-1)))}))},n.functions.densify=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,3,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=y(o[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);if(c<=0)throw new s(r,l.InvalidParameter,i);return o[0]instanceof pn||o[0]instanceof wn?K(o[0],c,N(d(o[2],-1))):o[0]instanceof U?K(gn(o[0]),c,N(d(o[2],-1))):o[0]}))},n.functions.densifygeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,3,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=y(o[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);if(c<=0)throw new s(r,l.InvalidParameter,i);return o[0]instanceof pn||o[0]instanceof wn?nn(o[0],c,N(d(o[2],-1))):o[0]instanceof U?nn(gn(o[0]),c,N(d(o[2],-1))):o[0]}))},n.functions.generalize=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,4,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=y(o[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return tn(o[0],c,j(d(o[2],!0)),N(d(o[3],-1)))}))},n.functions.buffer=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,3,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=y(o[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return 0===c?b(o[0]):en(o[0],c,N(d(o[2],-1)))}))},n.functions.buffergeodetic=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,2,3,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);const c=y(o[1]);if(isNaN(c))throw new s(r,l.InvalidParameter,i);return 0===c?b(o[0]):rn(o[0],c,N(d(o[2],-1)))}))},n.functions.offset=function(r,i){return n.standardFunctionAsync(r,i,((n,a,c)=>{if(c=t(c),e(c,2,6,r,i),null===c[0])return null;if(!(c[0]instanceof pn||c[0]instanceof wn))throw new s(r,l.InvalidParameter,i);const u=y(c[1]);if(isNaN(u))throw new s(r,l.InvalidParameter,i);const f=y(d(c[4],10));if(isNaN(f))throw new s(r,l.InvalidParameter,i);const m=y(d(c[5],0));if(isNaN(m))throw new s(r,l.InvalidParameter,i);return an(c[0],u,N(d(c[2],-1)),o(d(c[3],"round")).toLowerCase(),f,m)}))},n.functions.rotate=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{o=t(o),e(o,2,3,r,i);let c=o[0];if(null===c)return null;if(!(c instanceof D))throw new s(r,l.InvalidParameter,i);c instanceof U&&(c=pn.fromExtent(c));const u=y(o[1]);if(isNaN(u))throw new s(r,l.InvalidParameter,i);const f=d(o[2],null);if(null===f)return on(c,u);if(f instanceof dn)return on(c,u,f);throw new s(r,l.InvalidParameter,i)}))},n.functions.centroid=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,1,1,r,i),null===o[0])return null;let m=o[0];if((c(o[0])||u(o[0]))&&(m=h(o[0],r.spatialReference)),null===m)return null;if(!(m instanceof D))throw new s(r,l.InvalidParameter,i);return m instanceof dn?f(b(o[0]),r.spatialReference):m instanceof pn?m.centroid:m instanceof wn?g(m):m instanceof mn?v(m):m instanceof U?m.center:null}))},n.functions.multiparttosinglepart=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{o=t(o),e(o,1,1,r,i);const c=[];if(null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);if(o[0]instanceof dn)return[f(b(o[0]),r.spatialReference)];if(o[0]instanceof U)return[f(b(o[0]),r.spatialReference)];const u=await sn(o[0]);if(u instanceof pn){const n=[],t=[];for(let e=0;e<u.rings.length;e++)if(u.isClockwise(u.rings[e])){const t=hn({rings:[u.rings[e]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(t)}else t.push({ring:u.rings[e],pt:u.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(u instanceof wn){const n=[];for(let t=0;t<u.paths.length;t++){const e=hn({paths:[u.paths[t]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(e)}return n}if(o[0]instanceof mn){const n=f(b(o[0]),r.spatialReference);for(let t=0;t<n.points.length;t++)c.push(n.getPoint(t));return c}return null}))},n.functions.issimple=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,1,1,r,i),null===o[0])return!0;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return ln(o[0])}))},n.functions.simplify=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,1,1,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return sn(o[0])}))},n.functions.convexhull=function(r,i){return n.standardFunctionAsync(r,i,((n,a,o)=>{if(o=t(o),e(o,1,1,r,i),null===o[0])return null;if(!(o[0]instanceof D))throw new s(r,l.InvalidParameter,i);return cn(o[0])}))},n.functions.getuser=function(t,r){return n.standardFunctionAsync(t,r,(async(n,i,a)=>{e(a,0,2,t,r);let c=d(a[1],""),u=!0===c;if(c=!0===c||!1===c?"":o(c),0===a.length||a[0]instanceof P){let n=null;n=t.services?.portal?t.services.portal:yn.getDefault(),a.length>0&&(n=S(a[0],n));const e=await jn(n,c,u);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return I.convertObjectToArcadeDictionary(n,A(t))}return null}let f=null;if(m(a[0])&&(f=a[0]),f){if(u=!1,c)return null;await f.load();const n=await f.getOwningSystemUrl();if(!n){if(!c){const n=await f.getIdentityUser();return n?I.convertObjectToArcadeDictionary({username:n},A(t)):null}return null}let e=null;e=t.services?.portal?t.services.portal:yn.getDefault(),e=S(new P(n),e);const r=await jn(e,c,u);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return I.convertObjectToArcadeDictionary(n,A(t))}return null}throw new s(t,l.InvalidParameter,r)}))}),n.functions.nearestcoordinate=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(o=t(o),e(o,2,2,r,i),!(o[0]instanceof D||null===o[0]))throw new s(r,l.InvalidParameter,i);if(!(o[1]instanceof dn||null===o[1]))throw new s(r,l.InvalidParameter,i);if(null===o[0]||null===o[1])return null;const c=await un(o[0],o[1]);return null===c?null:I.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance,sideOfLine:0===c.distance?"straddle":c.isRightSide?"right":"left"},A(r),!1,!0)}))},n.functions.nearestvertex=function(r,i){return n.standardFunctionAsync(r,i,(async(n,a,o)=>{if(o=t(o),e(o,2,2,r,i),!(o[0]instanceof D||null===o[0]))throw new s(r,l.InvalidParameter,i);if(!(o[1]instanceof dn||null===o[1]))throw new s(r,l.InvalidParameter,i);if(null===o[0]||null===o[1])return null;const c=await fn(o[0],o[1]);return null===c?null:I.convertObjectToArcadeDictionary({coordinate:c.coordinate,distance:c.distance,sideOfLine:0===c.distance?"straddle":c.isRightSide?"right":"left"},A(r),!1,!0)}))}}export{In as registerFunctions};
