/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{ae as r,O as e,Q as t,Z as n,l as o}from"./unitUtils.js";import{c as a}from"./mat3f64.js";import{p as i,m as s,i as l,s as f}from"./mat4.js";import{c,I as p}from"./mat4f64.js";import{w as u,n as m,o as g}from"./vec3.js";import{c as y,Z as h,f as A}from"./vec3f64.js";import{f as F,t as P,h as T,j}from"./mat3.js";import{canProjectWithoutEngine as d}from"../geometry/projection.js";import{g as w}from"./spatialReferenceEllipsoidUtils.js";import{c as R}from"./computeTranslationToOriginAndRotation.js";import{p as M}from"./projectBuffer.js";import{n as C,c as _}from"./DoubleArray.js";import v from"../geometry/support/MeshGeoreferencedVertexSpace.js";import x from"../geometry/support/MeshLocalVertexSpace.js";import O from"../geometry/support/MeshTransform.js";import{i as S,v as b}from"./meshVertexSpaceUtils.js";import{c as E,d as V,t as L}from"./vec32.js";import{L as B}from"./Logger.js";import{y2lat as z}from"../geometry/support/webMercatorUtils.js";import{b as U,h as W}from"./BufferView.js";function G(r,e){return r.isGeographic||r.isWebMercator&&(e??!0)}function N(r,e,t){const n="local"===r.type;null!=t?.geographic&&t.geographic!==n&&B.getLogger(e).warnOnce(`Specifying the 'geographic' parameter (${t.geographic}) for a Mesh vertex space of type "${r.type}" is not supported. This parameter will be ignored.`)}const Y=()=>B.getLogger("esri.geometry.support.meshUtils.normalProjection");function Z(r,e,t,n,o){return K(n)?(J(rr.TO_PCPF,U.fromTypedArray(r),W.fromTypedArray(e),W.fromTypedArray(t),n,U.fromTypedArray(o)),o):(Y().error("Cannot convert spatial reference to PCPF"),o)}function $(r,e,t,n,o){return K(n)?(J(rr.FROM_PCPF,U.fromTypedArray(r),W.fromTypedArray(e),W.fromTypedArray(t),n,U.fromTypedArray(o)),o):(Y().error("Cannot convert to spatial reference from PCPF"),o)}function k(r,e,t){return M(r,e,0,t,w(e),0,r.length/3),t}function q(r,e,t){return M(r,w(t),0,e,t,0,r.length/3),e}function D(r,e,t){return T(or,t),E(e,r,or),j(or)||V(e,e),e}function I(r,e,t){if(T(or,t),E(e,r,or,4),j(or)||V(e,e,4),r!==e)for(let t=3;t<r.length;t+=4)e[t]=r[t];return e}function Q(r,e,t,n,o){if(!K(n))return Y().error("Cannot convert spatial reference to PCPF"),o;J(rr.TO_PCPF,U.fromTypedArray(r,4*Float32Array.BYTES_PER_ELEMENT),W.fromTypedArray(e),W.fromTypedArray(t),n,U.fromTypedArray(o,4*Float32Array.BYTES_PER_ELEMENT));for(let e=3;e<r.length;e+=4)o[e]=r[e];return o}function H(r,e,t,n,o){if(!K(n))return Y().error("Cannot convert to spatial reference from PCPF"),o;J(rr.FROM_PCPF,U.fromTypedArray(r,16),W.fromTypedArray(e),W.fromTypedArray(t),n,U.fromTypedArray(o,16));for(let e=3;e<r.length;e+=4)o[e]=r[e];return o}function J(r,e,t,n,o,a){if(!e)return;const i=t.count,s=w(o);if(X(o))for(let t=0;t<i;t++)n.getVec(t,er),e.getVec(t,tr),R(s,er,nr,s),F(or,nr),r===rr.FROM_PCPF&&P(or,or),u(tr,tr,or),a.setVec(t,tr);else for(let o=0;o<i;o++){n.getVec(o,er),e.getVec(o,tr),R(s,er,nr,s),F(or,nr);const i=z(t.get(o,1));let l=Math.cos(i);r===rr.TO_PCPF&&(l=1/l),or[0]*=l,or[1]*=l,or[2]*=l,or[3]*=l,or[4]*=l,or[5]*=l,r===rr.FROM_PCPF&&P(or,or),u(tr,tr,or),m(tr,tr),a.setVec(o,tr)}return a}function K(r){return X(r)||function(r){return r.isWebMercator}(r)}function X(n){return n.isWGS84||r(n)||e(n)||t(n)}var rr;!function(r){r[r.TO_PCPF=0]="TO_PCPF",r[r.FROM_PCPF=1]="FROM_PCPF"}(rr||(rr={}));const er=y(),tr=y(),nr=c(),or=a();function ar(r,e,t){return G(e.spatialReference,t?.geographic)?function(r,e,t){const n=e.spatialReference,o=mr(e,t,yr),a=new Float64Array(r.position.length),i=function(r,e,t,n){return L(n,r,e),q(n,new Float64Array(r.length),t)}(r.position,o,n,a),s=T(Ar,o),l=function(r,e,t,n,o){if(null==t)return null;const a=new Float32Array(t.length);return E(a,t,n),$(a,r,e,o,a),a}(i,a,r.normal,s,n),f=function(r,e,t,n,o){if(null==t)return null;const a=new Float32Array(t.length);E(a,t,n,4);for(let r=3;r<a.length;r+=4)a[r]=t[r];return H(a,r,e,o,a),a}(i,a,r.tangent,s,n);return{position:i,normal:l,tangent:f}}(r,e,t):function(r,e,t){const n=new Float64Array(r.position.length),o=r.position,a=e.x,i=e.y,s=e.z??0,l=gr(t?t.unit:null,e.spatialReference);for(let r=0;r<o.length;r+=3)n[r]=o[r]*l+a,n[r+1]=o[r+1]*l+i,n[r+2]=o[r+2]*l+s;return{position:n,normal:r.normal,tangent:r.tangent}}(r,e,t)}function ir(r,e=p){const{position:t,normal:n,tangent:o}=r;return{position:L(new Float64Array(t.length),t,e),normal:null!=n?D(n,new Float32Array(n.length),e):null,tangent:null!=o?I(o,new Float32Array(o.length),e):null}}function sr(r,e,t,n){const{position:o,normal:a,tangent:i}=r;if(!S(e))return{position:o,normal:a,tangent:i};const s=b(e,n);return ar(ir(r,t?.localMatrix),s,{geographic:"local"===e.type})}function lr(r,e,t){if(t?.useTransform){const{position:n,normal:o,tangent:a}=r,{x:i,y:s,z:l}=e,f=A(i,s,l??0);return{vertexAttributes:{position:n,normal:o,tangent:a},vertexSpace:t.geographic??1?new x({origin:f}):new v({origin:f}),transform:new O}}return{vertexAttributes:ar(r,e,t),vertexSpace:new v,transform:null}}function fr(r,e,t){return G(e.spatialReference,t?.geographic)?function(r,e,t){const n=e.spatialReference;mr(e,t,yr);const o=l(hr,yr),a=new Float64Array(r.position.length),i=function(r,e,t,n){const o=k(r,e,n),a=new Float64Array(o.length);return L(a,o,t),a}(r.position,n,o,a),s=T(Ar,o),f=function(r,e,t,n,o){if(null==r)return null;const a=Z(r,e,t,n,new Float32Array(r.length));return E(a,a,o),a}(r.normal,r.position,a,n,s),c=function(r,e,t,n,o){if(null==r)return null;const a=Q(r,e,t,n,new Float32Array(r.length));return E(a,a,o,4),a}(r.tangent,r.position,a,n,s);return{position:i,normal:f,tangent:c}}(r,e,t):ur(r,e,t)}function cr(r,e,t,n,o){if(!S(e))return fr(r,n,o);const{spatialReference:a}=n,i=sr(r,e,t,a);return n.equals(b(e,a))?ur(i,n,o):fr(i,n,o)}function pr({positions:r,transform:e,vertexSpace:t,inSpatialReference:n,outSpatialReference:o,outPositions:a,localMode:l}){const f=t.origin??h,c=null!=t.origin?e?.localMatrix??p:p;if("georeferenced"===t.type){const e=a??C(r.length);if(i(c,p)?_(e,r):L(e,r,c),!g(f,h)){const[r,t,n]=f;for(let o=0;o<e.length;o+=3)e[o]+=r,e[o+1]+=t,e[o+2]+=n}return M(e,n,0,e,o,0,e.length/3),e}let u=n;const m=w(n);u=o.isWebMercator&&l||!d(n,m)?u:m,R(n,f,yr,u),s(yr,yr,c);const y=a??C(r.length);return L(y,r,yr),M(y,u,0,y,o,0,y.length/3),y}function ur(r,e,t){const n=new Float64Array(r.position.length),o=r.position,a=e.x,i=e.y,s=e.z??0,l=gr(t?t.unit:null,e.spatialReference);for(let r=0;r<o.length;r+=3)n[r]=(o[r]-a)/l,n[r+1]=(o[r+1]-i)/l,n[r+2]=(o[r+2]-s)/l;return{position:n,normal:r.normal,tangent:r.tangent}}function mr(r,e,t){R(r.spatialReference,[r.x,r.y,r.z??0],t,w(r.spatialReference));const n=gr(e?e.unit:null,r.spatialReference);return f(t,t,[n,n,n]),t}function gr(r,e){if(null==r)return 1;const t=n(e);return 1/o(t,"meters",r)}const yr=c(),hr=c(),Ar=a(),Fr=Object.freeze(Object.defineProperty({__proto__:null,applyTransform:ir,georeference:ar,georeferenceApplyTransform:sr,georeferenceByTransform:lr,project:pr,ungeoreference:fr,ungeoreferenceByTransform:cr},Symbol.toStringTag,{value:"Module"}));export{ar as a,lr as b,k as c,Z as d,Q as e,q as f,sr as g,$ as h,G as i,H as j,cr as k,ir as l,I as m,Fr as n,pr as p,D as t,fr as u,N as v};
