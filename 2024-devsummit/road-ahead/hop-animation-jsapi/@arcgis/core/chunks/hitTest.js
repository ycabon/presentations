/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../Graphic.js";import{i as r}from"../core/Handles.js";import{b as n,s as t}from"./screenUtils.js";import{c as i}from"./vec3f64.js";import{p as s}from"./projectVectorToVector.js";import{f as o}from"./LayerConstants.js";import{j as c}from"./layerUtils2.js";import{d as a}from"./debugFlags2.js";import{g as l}from"./ElevationProvider.js";import{n as u,S as d,i as p,I as f}from"./Intersector2.js";import{t as m,a as g}from"./intersectorUtilsConversions.js";import{t as h}from"./verticalOffsetUtils.js";import y from"../geometry/SpatialReference.js";import U from"../geometry/Point.js";async function I(e,r,t,i){const s=t?b(e,t):i,o=n(r.x,r.y);s.requiresGroundFeedback=!0,s.enableDraped=!0;const l=u(e.state.viewingMode);l.options.selectionMode=!0,l.options.store=d.ALL,e.sceneIntersectionHelper.intersectIntersectorScreen(o,l,s);const f=function(e,r,n){const t=new Array;let i=null;for(let s=0;s<r.length;s++){const o=r[s],a=m(o,e);if(null!=a&&(a===e.map.ground||"type"in a&&c(a.type)))break;const l=g(o,e);if(null==l)continue;if("graphic"===l.type){if(null==i&&s!==r.length-1&&(i=new Set),null!=i){const e=S(l.graphic);if(i.has(e))continue;i.add(e)}if(!L(n,l.graphic))continue}const u=E(e,o),d=o.distanceInRenderSpace;if("media"===l.type){const e=l.element.toSource(u);t.push({...l,mapPoint:u,distance:d,sourcePoint:e})}else t.push({...l,mapPoint:u,distance:d})}return t}(e,l.results.all,s.graphics),h=l.results.ground,y=m(h,e),U=null!=y&&"type"in y&&c(y.type)?y:null,I={screenPoint:r,results:f,ground:{mapPoint:E(e,h),distance:p(h)?h.distanceInRenderSpace:0,layer:U}};return a.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(I.intersector=l),I}function j(e,r,n,i){const s=n?b(e,n):i,o=null!=s.graphics&&(null!=s.graphics.include||null!=s.graphics.exclude),c=t(r);s.enableDraped=s.include&&!s.include.has(h)||s.exclude&&s.exclude.has(h);const a=e.sceneIntersectionHelper,l=u(e.state.viewingMode);if(l.options.selectionMode=!0,l.options.store=o?d.ALL:d.MIN,l.options.hud=!n?.excludeHud,a.intersectIntersectorScreen(c,l,s),o){for(const r of l.results.all){const n=g(r,e);if(null==n)return E(e,r);if("graphic"!==n.type||L(s.graphics,n.graphic))return E(e,r)}return null}return E(e,l.results.min)}function E(e,r,n){return r.getIntersectionPoint(C)?(n=R(e,C,n),r.intersector===f.TERRAIN&&e.basemapTerrain&&(n.z=l(e.basemapTerrain,n)??0),n):null}function S(e){const r=e.sourceLayer,n=e.layer,t=r&&"objectIdField"in r?r:n&&"objectIdField"in n?n:r;if(t){const r=t.objectIdField??o,n=e.attributes?.[r];if(n)return`o-${t.id}-${n}`}return`u-${e.uid}`}function L(e,r){const n=S(r);return null==e||(null==e.include||e.include.has(n))&&(null==e.exclude||!e.exclude.has(n))}function R(e,r,n){let t=e.spatialReference||y.WGS84;return s(r,e.renderSpatialReference,C,t)?r=C:(t=y.WGS84,s(r,e.renderSpatialReference,C,t)&&(r=C)),n?(n.x=r[0],n.y=r[1],n.z=r[2],n.spatialReference=t):n=new U(r,t),n}function b(e,r){const n=x(e,r.include,v.INCLUDE),t=x(e,r.exclude,v.EXCLUDE);return{include:n.layerUids,exclude:t.layerUids,graphics:{include:n.graphicUids,exclude:t.graphicUids}}}function x(n,t,i,s={layerUids:void 0,graphicUids:void 0}){if(!t)return s;if(t instanceof e)!function(e,r){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(r)}(s,S(t)),i===v.INCLUDE&&(null!=n.graphicsView&&t.layer===n?w(s,n.graphicsView.processor.layer.id):t.layer&&w(s,t.layer.uid));else if(r(t))for(const e of t)e===n.graphics&&null!=n.graphicsView?w(s,n.graphicsView.processor.layer.id):e===n.map.ground?w(s,h):x(n,e,i,s);else"uid"in t&&w(s,t.uid);return s}function w(e,r){e.layerUids||(e.layerUids=new Set),e.layerUids.add(r)}const C=i();var v;!function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(v||(v={}));export{R as c,b as e,I as h,j as t};
