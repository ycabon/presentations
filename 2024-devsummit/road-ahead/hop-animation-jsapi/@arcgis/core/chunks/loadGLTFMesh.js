/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{g as r}from"./ensureType.js";import{k as o,r as s}from"./mathUtils.js";import{h as n}from"./mat3.js";import{c as i}from"./mat3f64.js";import{f as a}from"./vec3f64.js";import{f as m}from"./vec4f64.js";import l,{M as p}from"../geometry/support/MeshComponent.js";import c from"../geometry/support/MeshMaterialMetallicRoughness.js";import u from"../geometry/support/MeshTexture.js";import f from"../geometry/support/MeshTextureTransform.js";import{c as j,o as g,s as d,n as x,b as y,r as T,h,a as b}from"./BufferView.js";import{a as v,b as M,n as w,s as A}from"./vec32.js";import{D as C,l as U,c as S,f as E,t as R,n as B,a as O,b as $,d as D,s as P,e as V,g as G,h as I}from"./DefaultMaterial_COLOR_GAMMA.js";import{e as L}from"./types.js";import"../core/lang.js";import{b as q}from"./georeference.js";import{i as F}from"./resourceUtils3.js";import{b as _}from"./enums.js";import"./colorUtils.js";import"./vec3.js";import"./common.js";import"./Logger.js";import"../config.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/JSONSupport.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/MeshMaterial.js";import"./imageUtils.js";import"./reader.js";import"./writer.js";import"./persistableUrlUtils.js";import"../core/Clonable.js";import"./vec2.js";import"./vec4.js";import"./asyncUtils.js";import"./mat4f64.js";import"./Version.js";import"./mat4.js";import"./quat.js";import"./quatf64.js";import"./compilerUtils.js";import"./Indices.js";import"./unitUtils.js";import"./jsonMap.js";import"./assets.js";import"../geometry/projection.js";import"./SimpleObservable.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./spatialReferenceEllipsoidUtils.js";import"./computeTranslationToOriginAndRotation.js";import"./DoubleArray.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"./enumeration.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../geometry/support/MeshTransform.js";import"./axisAngleDegrees.js";import"./meshVertexSpaceUtils.js";import"./basicInterfaces.js";function k(t,e){return new t(new ArrayBuffer(e*t.ElementCount*L(t.ElementType)))}async function z(o,n,i){const l={...i,useTransform:i?.useTransform??!0},d=new C(function(t){const r=t?.resolveFile;return r?{busy:!1,request:async(t,o,s)=>{const n=r?.(t)??t,i="image"===o?"image":"binary"===o?"array-buffer":"json";return(await e(n,{responseType:i,signal:null!=s?s.signal:null})).data}}:null}(l)),x=(await U(d,n,l,!0)).model,T=x.lods.shift(),v=new Map,M=new Map;x.textures.forEach(((t,e)=>{return v.set(e,new u({data:(F((o=t).data),o.data),wrap:(r=o.parameters.wrap,{horizontal:K(r.s),vertical:K(r.t)})}));var r,o})),x.materials.forEach(((e,r)=>M.set(r,function(e,r){const o=new t((l=e.color,p=e.opacity,m(Q(l[0]),Q(l[1]),Q(l[2]),p))),n=e.emissiveFactor?new t(function(t){return a(Q(t[0]),Q(t[1]),Q(t[2]))}(e.emissiveFactor)):null,i=t=>t?new f({scale:t.scale?[t.scale[0],t.scale[1]]:[1,1],rotation:s(t.rotation??0),offset:t.offset?[t.offset[0],t.offset[1]]:[0,0]}):null;var l,p;return new c({color:o,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:n,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:J(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:i(e.colorTextureTransform),normalTextureTransform:i(e.normalTextureTransform),occlusionTextureTransform:i(e.occlusionTextureTransform),emissiveTextureTransform:i(e.emissiveTextureTransform),metallicRoughnessTextureTransform:i(e.metallicRoughnessTextureTransform)})}(e,v))));const w=function(t){let e=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},s=new Map,n=new Map,i=[];for(const m of t.parts){const{attributes:{position:t,normal:l,color:p,tangent:c,texCoord0:u}}=m,f=`\n      ${N(t,s)}/\n      ${N(l,s)}/\n      ${N(p,s)}/\n      ${N(c,s)}/\n      ${N(u,s)}/\n      ${a=m.transform,null!=a?a.toString():"-"}\n    `;let j=!1;const g=r(n,f,(()=>(j=!0,{start:e,length:t.count})));j&&(e+=t.count),l&&(o.normal=!0),p&&(o.color=!0),c&&(o.tangent=!0),u&&(o.texCoord0=!0),i.push({gltf:m,writeVertices:j,region:g})}var a;return{vertexAttributes:{position:k(h,e),normal:o.normal?k(y,e):null,tangent:o.tangent?k(j,e):null,color:o.color?k(g,e):null,texCoord0:o.texCoord0?k(b,e):null},parts:i,components:[]}}(T);for(const t of w.parts)H(w,t,M);const{position:A,normal:S,tangent:E,color:R,texCoord0:B}=w.vertexAttributes,O={position:A.typedBuffer,normal:null!=S?S.typedBuffer:null,tangent:null!=E?E.typedBuffer:null,uv:null!=B?B.typedBuffer:null,color:null!=R?R.typedBuffer:null},$=q(O,o,l);return{transform:$.transform,vertexSpace:$.vertexSpace,components:w.components,spatialReference:o.spatialReference,vertexAttributes:new p({position:$.vertexAttributes.position,normal:$.vertexAttributes.normal,tangent:$.vertexAttributes.tangent,color:O.color,uv:O.uv})}}function N(t,e){if(null==t)return"-";const o=t.typedBuffer;return`${r(e,o.buffer,(()=>e.size))}/${o.byteOffset}/${o.byteLength}`}function H(t,e,r){e.writeVertices&&function(t,e){const{position:r,normal:s,tangent:a,color:m,texCoord0:l}=t.vertexAttributes,p=e.region.start,{attributes:c,transform:u}=e.gltf,f=c.position.count;if(v(r.slice(p,f),c.position,u),null!=c.normal&&null!=s){const t=n(i(),u),e=s.slice(p,f);M(e,c.normal,t),o(t)&&w(e,e)}else null!=s&&E(s,0,0,1,{dstIndex:p,count:f});if(null!=c.tangent&&null!=a){const t=n(i(),u),e=a.slice(p,f);R(e,c.tangent,t),o(t)&&B(e,e)}else null!=a&&O(a,0,0,1,1,{dstIndex:p,count:f});if(null!=c.texCoord0&&null!=l?$(l.slice(p,f),c.texCoord0):null!=l&&D(l,0,0,{dstIndex:p,count:f}),null!=c.color&&null!=m){const t=c.color,e=m.slice(p,f);if(4===t.elementCount)t instanceof j?P(e,t,255):t instanceof g?V(e,t):t instanceof d&&P(e,t,1/256);else{O(e,255,255,255,255);const r=x.fromTypedArray(e.typedBuffer,e.typedBufferStride);t instanceof y?A(r,t,255):t instanceof x?G(r,t):t instanceof T&&A(r,t,1/256)}}else null!=m&&O(m.slice(p,f),255,255,255,255)}(t,e);const{indices:s,attributes:a,primitiveType:m,material:p}=e.gltf;let c=S(s||a.position.count,m);const u=e.region.start;if(u){const t=new Uint32Array(c);for(let e=0;e<c.length;e++)t[e]+=u;c=t}t.components.push(new l({name:e.gltf.name,faces:c,material:r.get(p),shading:a.normal?"source":"flat",trustSourceNormals:!0}))}function J(t){switch(t){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function K(t){switch(t){case _.CLAMP_TO_EDGE:return"clamp";case _.MIRRORED_REPEAT:return"mirror";case _.REPEAT:return"repeat"}}function Q(t){return t**(1/I)*255}export{z as loadGLTFMesh};
