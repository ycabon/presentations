/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import t from"../Color.js";import{d as o}from"./colorUtils2.js";import s from"../core/Error.js";import{l as e}from"./fontUtils.js";import{a as i,p as r}from"./screenUtils.js";import{g as l,d as m,e as a,h as p}from"./utils9.js";import{S as n,a as c,r as y,s as j}from"../symbols/support/symbolUtils.js";import{b as u}from"../symbols/Font.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./vec3f64.js";import"./common.js";import"./ensureType.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./vec4.js";import"./vec4f64.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/sql.js";import"../intl.js";import"./date.js";import"./locale.js";import"./timeZoneUtils.js";import"./datetime.js";import"./messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"./assets.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils4.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils5.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../core/reactiveUtils.js";import"./asyncUtils.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./jsonUtils.js";import"./parser.js";import"./utils3.js";import"./mat4.js";import"./_commonjsHelpers.js";import"../symbols/support/cimSymbolUtils.js";import"./utils6.js";import"./LRUCache.js";import"./MemCache.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./webStyleSymbolUtils.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./layerUtils2.js";import"./styleUtils.js";const h="picture-fill",b="picture-marker",d="simple-fill",f="simple-line",g="simple-marker",S="text",w="Aa",v=n.size,L=n.maxSize,U=n.maxOutlineSize,k=n.lineWidth,x=225,M=document.createElement("canvas");function D(t,o){const s=M.getContext("2d"),e=[];return o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" "),s.measureText(t).width}const z=7.2/2.54,C=72/2.54;function P(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?i(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?i(o.height):null}}function F(t,o){return t>o?"dark":"light"}function E(t,o){const s="number"==typeof o?.size?o?.size:null,e=null!=s?i(s):null,l=null!=o?.maxSize?i(o.maxSize):null,n=null!=o?.rotation?o.rotation:"angle"in t?t.angle:null,c=m(t);let y=a(t);"dark"!==T(t,245)||o?.ignoreWhiteSymbols||(y={width:.75,...y,color:"#bdc3c7"});const u={shape:null,fill:c,stroke:y,offset:[0,0]};y?.width&&(y.width=Math.min(y.width,U));const x=y?.width||0;let M=null!=o?.size&&(null==o?.scale||o?.scale),F=0,E=0,O=!1;switch(t.type){case g:{const s=t.style,{width:r,height:m}=P(o),a=r===m&&null!=r?r:null!=e?e:Math.min(i(t.size),l||L);switch(F=a,E=a,s){case"circle":u.shape={type:"circle",cx:0,cy:0,r:.5*a},M||(F+=x,E+=x);break;case"cross":u.shape={type:"path",path:[{command:"M",values:[0,.5*E]},{command:"L",values:[F,.5*E]},{command:"M",values:[.5*F,0]},{command:"L",values:[.5*F,E]}]};break;case"diamond":u.shape={type:"path",path:[{command:"M",values:[0,.5*E]},{command:"L",values:[.5*F,0]},{command:"L",values:[F,.5*E]},{command:"L",values:[.5*F,E]},{command:"Z",values:[]}]},M||(F+=x,E+=x);break;case"square":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,0]},{command:"L",values:[F,E]},{command:"L",values:[0,E]},{command:"Z",values:[]}]},M||(F+=x,E+=x),n&&(O=!0);break;case"triangle":u.shape={type:"path",path:[{command:"M",values:[.5*F,0]},{command:"L",values:[F,E]},{command:"L",values:[0,E]},{command:"Z",values:[]}]},M||(F+=x,E+=x),n&&(O=!0);break;case"x":u.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,E]},{command:"M",values:[F,0]},{command:"L",values:[0,E]}]},n&&(O=!0);break;case"path":u.shape={type:"path",path:t.path||""},M||(F+=x,E+=x),n&&(O=!0),M=!0}break}case f:{const{width:t,height:s}=P(o),i=p(y).reduce(((t,o)=>t+o),0),r=null!=s?s:null!=e?e:x,l=null!=t?t:i||k;y&&(y.width=r),F=l,E=r,M=!0,u.shape={type:"path",path:[{command:"M",values:[r/2,E/2]},{command:"L",values:[F-r/2,E/2]}]};break}case h:case d:{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:s,height:i}=P(o);F=!t&&s!==i||null==s?null!=e?e:v:s,E=!t&&s!==i||null==i?F:i,M||(F+=x,E+=x),M=!0,u.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[F,0]},{command:"L",values:[F,E]},{command:"L",values:[0,E]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:j.fill[0];break}case b:{const s=Math.min(i(t.width),l||L),r=Math.min(i(t.height),l||L),{width:m,height:a}=P(o),p=m===a&&null!=m?m:null!=e?e:Math.max(s,r),c=s/r;F=c<=1?Math.ceil(p*c):p,E=c<=1?p:Math.ceil(p/c),u.shape={type:"image",x:-Math.round(F/2),y:-Math.round(E/2),width:F,height:E,src:t.url||""},n&&(O=!0);break}case S:{const s=t,m=o?.overrideText||s.text||w,a=s.font,{width:p,height:n}=P(o),c=null!=n?n:null!=e?e:Math.min(i(a.size),l||L),y=D(m,{weight:a.weight,size:c,family:a.family}),j=/[\uE600-\uE6FF]/.test(m);F=p??(j?c:y),E=c;let h=.25*function(t){if(0===t.length)return 0;if(t.length>2){const o=r(1),s=parseFloat(t);switch(t.slice(-2)){case"px":return s;case"pt":return s*o;case"in":return 72*s*o;case"pc":return 12*s*o;case"mm":return s*z*o;case"cm":return s*C*o}}return parseFloat(t)}((a?c:0).toString());j&&(h+=5),u.shape={type:"text",text:m,x:s.xoffset||0,y:s.yoffset||h,align:"middle",alignBaseline:s.verticalAlignment,decoration:a&&a.decoration,rotated:s.rotated,kerning:s.kerning},u.font=a&&{size:c,style:a.style,decoration:a.decoration,weight:a.weight,family:a.family};break}}return{shapeDescriptor:u,size:[F,E],renderOptions:{node:o?.node,scale:M,opacity:o?.opacity,rotation:n,useRotationSize:O,effectView:o?.effectView,ariaLabel:o?.ariaLabel}}}async function O(t,o){const{shapeDescriptor:r,size:m,renderOptions:a}=E(t,o);if(!r.shape)throw new s("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const s=o.fill,e=t.color;if("pattern"===s?.type&&e&&t.type!==h){const t=await l(s.src,e.toCss(!0));s.src=t,o.fill=s}}(t,r),await async function(t,o,s,i){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await e(t.font)}catch{}const{width:r}=P(i),l=/[\uE600-\uE6FF]/.test(o.shape.text);null!=r||l||(s[0]=D(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family}))}(t,r,m,o);const p=[[r]];if("object"==typeof o?.symbolConfig&&o?.symbolConfig?.applyColorModulation){const t=.6*m[0];p.unshift([{...r,offset:[-t,0],fill:c(r.fill,-.3)}]),p.push([{...r,offset:[t,0],fill:c(r.fill,.3)}]),m[0]+=2*t,a.scale=!1}return"text"===t.type&&function(t,o,s,e,r){if(null!=t.haloColor&&null!=t.haloSize){r.masking??=s.map((()=>[]));const l=i(t.haloSize);e[0]+=l,e[1]+=l,s.unshift([{...o,fill:null,stroke:{color:t.haloColor,width:2*l,join:"round",cap:"round"}}]),r.masking.unshift([{shape:{type:"rect",x:0,y:0,width:e[0]+2*u,height:e[1]+2*u},fill:[255,255,255],stroke:null},{...o,fill:[0,0,0,0],stroke:null}])}null==t.backgroundColor&&null==t.borderLineColor||(e[0]+=2*u,e[1]+=2*u,s.unshift([{shape:{type:"rect",x:0,y:0,width:e[0],height:e[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:i(t.borderLineSize)}}]),r.masking?.unshift([]))}(t,r,p,m,a),y(p,m,a)}function T(s,e=x){const i=m(s),r=a(s),l=!i||"type"in i?null:new t(i),p=r?.color?new t(r?.color):null,n=l?F(o(l),e):null,c=p?F(o(p),e):null;return c?n?n===c?n:e>=x?"light":"dark":c:n}export{T as getContrastingBackgroundTheme,E as getRenderSymbolParameters,O as previewSymbol2D};
