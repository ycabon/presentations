/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{i as s}from"../core/lang.js";import{createResolver as n}from"../core/promiseUtils.js";import{initializeProjection as t,projectMany as r}from"../geometry/projection.js";import{j as e}from"./json.js";import{k as i,f as o,b as a}from"./unitUtils.js";import{lngLatToXY as m,xyToLngLat as u,canProject as c}from"../geometry/support/webMercatorUtils.js";const h=[0,0];function p(s,n){if(!n)return null;if("x"in n){const t={x:0,y:0};return[t.x,t.y]=s(n.x,n.y,h),null!=n.z&&(t.z=n.z),null!=n.m&&(t.m=n.m),t}if("xmin"in n){const t={xmin:0,ymin:0,xmax:0,ymax:0};return[t.xmin,t.ymin]=s(n.xmin,n.ymin,h),[t.xmax,t.ymax]=s(n.xmax,n.ymax,h),n.hasZ&&(t.zmin=n.zmin,t.zmax=n.zmax,t.hasZ=!0),n.hasM&&(t.mmin=n.mmin,t.mmax=n.mmax,t.hasM=!0),t}return"rings"in n?{rings:l(n.rings,s),hasM:n.hasM,hasZ:n.hasZ}:"paths"in n?{paths:l(n.paths,s),hasM:n.hasM,hasZ:n.hasZ}:"points"in n?{points:f(n.points,s),hasM:n.hasM,hasZ:n.hasZ}:null}function l(s,n){const t=[];for(const r of s)t.push(f(r,n));return t}function f(s,n){const t=[];for(const r of s){const s=n(r[0],r[1],[0,0]);t.push(s),r.length>2&&s.push(r[2]),r.length>3&&s.push(r[3])}return t}async function x(n,r){if(!n||!r)return;const e=Array.isArray(n)?n.map((s=>null!=s.geometry?s.geometry.spatialReference:null)).filter(s):[n];await t(e.map((s=>({source:s,dest:r}))))}const g=p.bind(null,m),y=p.bind(null,u);function j(s,n,t,m){if(!s)return s;if(t||(t=n,n=s.spatialReference),!i(n)||!i(t)||o(n,t))return s;if(c(n,t)){const n=a(t)?g(s):y(s);return n.spatialReference=t,n}return r(e,[s],n,t,null,m)[0]}const _=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(s,t,r,e){if(!s?.length||!t||!r||o(t,r))return s;const i={geometries:s,inSpatialReference:t,outSpatialReference:r,geographicTransformation:e,resolve:n()};return this._jobs.push(i),this._timer??=setTimeout(this._process,10),i.resolve.promise}_process(){this._timer=null;const s=this._jobs.shift();if(!s)return;const{geometries:n,inSpatialReference:t,outSpatialReference:i,resolve:o,geographicTransformation:m}=s;c(t,i)?a(i)?o(n.map(g)):o(n.map(y)):o(r(e,n,t,i,m,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};function M(s,n,t,r){return _.push(s,n,t,r)}export{M as a,x as c,j as p};
