/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import t from"../request.js";import{urlToObject as e,join as n}from"../core/urlUtils.js";import{getJsonType as r}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as i}from"../geometry/support/normalizeUtils.js";import{X as a}from"./unitUtils.js";import{p as o}from"./pbfQueryUtils.js";import{a as s}from"./queryZScale.js";function u(t){const e={};for(const n in t){if("declaredClass"===n)continue;const r=t[n];if(null!=r&&"function"!=typeof r)if(Array.isArray(r)){e[n]=[];for(let t=0;t<r.length;t++)e[n][t]=u(r[t])}else"object"==typeof r?r.toJSON&&(e[n]=JSON.stringify(r)):e[n]=r}return e}const l="Layer does not support extent calculation.";function y(t,e){const n=t.geometry,i=t.toJSON();delete i.compactGeometryEnabled,delete i.defaultSpatialReferenceEnabled;const o=i;let s,u,l;if(null!=n&&(u=n.spatialReference,l=a(u),o.geometryType=r(n),o.geometry=function(t,e){if(e&&"extent"===t.type)return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(e&&"point"===t.type)return`${t.x},${t.y}`;const n=t.toJSON();return delete n.spatialReference,JSON.stringify(n)}(n,t.compactGeometryEnabled),o.inSR=l),i.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(o.objectIds=i.objectIds.join(",")),i.orderByFields&&(o.orderByFields=i.orderByFields.join(",")),!i.outFields||!i.returnDistinctValues&&(e?.returnCountOnly||e?.returnExtentOnly||e?.returnIdsOnly)?delete o.outFields:i.outFields.includes("*")?o.outFields="*":o.outFields=i.outFields.join(","),i.outSR?(o.outSR=a(i.outSR),s=t.outSpatialReference):n&&(i.returnGeometry||i.returnCentroid)&&(o.outSR=o.inSR,s=u),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(o.outStatistics=JSON.stringify(i.outStatistics)),i.fullText&&(o.fullText=JSON.stringify(i.fullText)),i.pixelSize&&(o.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&null!=u&&null!=t.quantizationParameters?.extent&&u.equals(t.quantizationParameters.extent.spatialReference)&&delete i.quantizationParameters.extent.spatialReference,o.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.parameterValues&&(o.parameterValues=JSON.stringify(i.parameterValues)),i.rangeValues&&(o.rangeValues=JSON.stringify(i.rangeValues)),i.dynamicDataSource&&(o.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i.timeExtent){const t=i.timeExtent,{start:e,end:n}=t;null==e&&null==n||(o.time=e===n?e:`${e??"null"},${n??"null"}`),delete i.timeExtent}return t.defaultSpatialReferenceEnabled&&null!=u&&null!=s&&u.equals(s)&&(o.defaultSR=o.inSR,delete o.inSR,delete o.outSR),o}async function c(t,e,n,r){const i=null!=e.timeExtent&&e.timeExtent.isEmpty?{data:{features:[]}}:await x(t,e,"json",r);return s(e,n,i.data),i}async function f(t,e,n,r){if(null!=e.timeExtent&&e.timeExtent.isEmpty)return{data:n.createFeatureResult()};const i=await m(t,e,r),a=i;return a.data=o(i.data,n),a}function m(t,e,n){return x(t,e,"pbf",n)}function d(t,e,n){return null!=e.timeExtent&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):x(t,e,"json",n,{returnIdsOnly:!0})}function p(t,e,n){return null!=e.timeExtent&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):x(t,e,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}async function S(t,e,n){if(null!=e.timeExtent&&e.timeExtent.isEmpty)return{data:{count:0,extent:null}};const r=await x(t,e,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}),i=r.data;if(i.hasOwnProperty("extent"))return r;if(i.features)throw new Error(l);if(i.hasOwnProperty("count"))throw new Error(l);return r}async function x(r,a,o,s={},l={}){const c="string"==typeof r?e(r):r,f=a.geometry?[a.geometry]:[],m=await i(f,null,{signal:s.signal}),d=m?.[0];null!=d&&((a=a.clone()).geometry=d);const p=u({...c.query,f:o,...l,...y(a,l)});return t(n(c.path,function(t,e){return null!=t.formatOf3DObjects&&!(e.returnCountOnly||e.returnExtentOnly||e.returnIdsOnly)}(a,l)?"query3d":"query"),{...s,responseType:"pbf"===o?"array-buffer":"json",query:{...p,...s.query}})}export{S as a,p as b,d as c,f as d,c as e,m as f,u as m,x as r};
