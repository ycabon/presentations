/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import"../geometry.js";import{throwIfAborted as e}from"../core/promiseUtils.js";import{c as t}from"./vec3f64.js";import{a as o}from"./projectPointToVector.js";import{m as n}from"./dehydratedPoint.js";import{m as r}from"./elevationInfoUtils.js";import{b as s,c as a,d as i,E as c,S as p}from"./ElevationContext.js";import l from"../geometry/SpatialReference.js";import{l as d}from"../layers/support/fieldUtils.js";async function f(d,f,u,m,g){const{elevationProvider:h,renderCoordsHelper:y}=d,{elevationInfo:j}=f,{pointsInFeatures:I,spatialReference:v}=m,S=l.fromJSON(v),b=s(j,!0),w=await a(b,S,g);e(g);const R=[],x=new Set,D=new Set,C=new c,P=n(0,0,0,l.WGS84),q=new p,z=t();P.spatialReference=S;const E=d.elevationProvider.spatialReference??d.spatialReference;for(const{objectId:e,points:t}of I){const n=u(e);if(null==n){for(const e of t)R.push(e.z??0);x.add(e);continue}n.isDraped&&D.add(e);const s=n.graphic.geometry;C.setFromElevationInfo(r(s,j)),C.updateFeatureExpressionInfoContext(w,n.graphic,f);for(const{x:e,y:n,z:r}of t)P.x=e,P.y=n,P.z=r??0,await o(P,z,E,0,{signal:g}),i(z,h,C,y,q),R.push(q.z)}return{elevations:R,drapedObjectIds:D,failedObjectIds:x}}async function u(t,o,n){if(null==t||0===o.candidates.length)return m;const r=t.graphics3DGraphicsByObjectID??t.graphics3DGraphics,s=[],a=[],{renderer:i}=t,c=null!=i&&"arcadeRequired"in i&&i.arcadeRequired?d():null,p=async(e,{graphic:o,graphics3DSymbol:r})=>{const s=await c,a=await t.getRenderingInfoAsync(o,i,s,{signal:n});return null==a?[]:r.queryForSnapping(e,f,a,n)},{candidates:l,spatialReference:f}=o;for(let e=0;e<l.length;++e){const t=l[e],{objectId:o}=t,n="number"==typeof o?r?.get(o):void 0;if(null==n)continue;const{graphics3DSymbol:i}=n;i.symbologySnappingSupported&&(s.push(p(t,n)),a.push(e))}if(0===s.length)return m;const u=await Promise.all(s);e(n);const g=[],h=[];for(let e=0;e<u.length;++e){const t=u[e],o=a[e];for(const e of t)g.push(e),h.push(o)}return{candidates:g,sourceCandidateIndices:h}}const m={candidates:[],sourceCandidateIndices:[]};export{f as e,u as q};
