/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../Color.js";import"../rasterRenderers.js";import{g as t}from"./unitUtils.js";import n from"../layers/support/Field.js";import a from"../renderers/FlowRenderer.js";import s from"../renderers/support/AuthoringInfo.js";import r from"../renderers/support/ClassBreakInfo.js";import{p as l,c as i}from"./colorRampUtils.js";import{i as o,a as u,b as m,c,d as f,e as d}from"./stretchUtils.js";import p from"../renderers/support/UniqueValueInfo.js";import{c as h,C as b}from"./generateRendererUtils.js";import g from"../rest/support/MultipartColorRamp.js";import y from"../renderers/RasterStretchRenderer.js";import v from"../renderers/UniqueValueRenderer.js";import w from"../renderers/RasterColormapRenderer.js";import x from"../renderers/RasterShadedReliefRenderer.js";import C from"../renderers/ClassBreaksRenderer.js";import M from"../renderers/VectorFieldRenderer.js";const R=.25,T=g.fromJSON({type:"multipart",colorRamps:[{fromColor:[0,0,255],toColor:[0,255,255]},{fromColor:[0,255,255],toColor:[255,255,0]},{fromColor:[255,255,0],toColor:[255,0,0]}]}),j=g.fromJSON(l[0]),V=new Set(["scientific","standard-time","vector-uv","vector-magdir","vector-u","vector-v","vector-magnitude","vector-direction"]);function I(e,t){const{attributeTable:n,colormap:a}=e;if(o(e)){const t=A(e);if(null!=t)return t}if(null!=a){const t=U(e);if(null!=t)return t}if(null!=n){const t=B(e);if(null!=t)return t}return L(e,t)}function k(e,t=!1){const n=["raster-stretch"];return u(e,t)&&n.push("raster-colormap"),m(e)&&n.push("unique-value"),c(e,t)&&n.push("class-breaks"),f(e)&&n.push("raster-shaded-relief"),o(e)&&n.push("vector-field"),d(e)&&n.push("flow"),n}function S(e,t,n){const a=["nearest","bilinear","cubic","majority"].find((e=>e===n?.toLowerCase()));return"Map"===t?a??"bilinear":"standard-time"===e.dataType?a??"nearest":"thematic"===e.dataType||e.attributeTable||e.colormap?"nearest"===a||"majority"===a?a:"nearest":a??"bilinear"}function L(e,t){e=E(e,t?.variableName);const{bandCount:n}=e;let{bandIds:a,stretchType:s}=t||{};a?.some((e=>e>=n))&&(a=null);let r=e.statistics,l=e.histograms;n>1?(a=a?.length?a:q(e),r=null==r?null:a?.map((e=>r[e])),l=null==l?null:a?.map((e=>l[e]))):a=[0],null==s&&(s=function(e){let t="percent-clip";const{pixelType:n,dataType:a,histograms:s,statistics:r,multidimensionalInfo:l}=e,i=V.has(a)||"generic"===a&&null!=l;return"u8"!==n||"processed"!==a&&null!=s&&null!=r?"u8"===n||"elevation"===a||i?t="min-max":null!=s?t="percent-clip":null!=r&&(t="min-max"):t="none",t}(e));let i=!1;switch(s){case"none":i=!1;break;case"percent-clip":i=!l?.length;break;default:i=!r?.length}const{dataType:o}=e,u=1===a?.length&&V.has(o)?T:null,m=new y({stretchType:s,dynamicRangeAdjustment:i,colorRamp:u,outputMin:0,outputMax:255,gamma:1===a?.length?[1]:[1,1,1],useGamma:!1});return"percent-clip"===s?m.maxPercent=m.minPercent=R:"standard-deviation"===s&&(m.numberOfStandardDeviations=2),i||null==e.multidimensionalInfo&&!t?.includeStatisticsInStretch||("percent-clip"===s?m.histograms=l:"min-max"!==s&&"standard-deviation"!==s||(m.statistics=r)),m}function E(e,t){const{multidimensionalInfo:n}=e;if(!t||!n)return e;const a=n.variables.find((e=>e.name===t));if(!a)return e;if(e=e.clone(),a){const{statistics:t,histograms:n}=a;t?.length&&(e.statistics=t.map((e=>({min:e.min,max:e.max,avg:e.avg,stddev:e.stddev})))),n?.length&&(e.histograms=n)}return e}function q(e){const t=e.bandCount;if(1===t)return null;if(2===t)return[0];const{bandInfos:n}=e;let a;if(n.length===t){const{red:e,green:t,blue:s,nir:r}=function(e){const t={};for(let n=0;n<e.length;n++){const a=e[n],s=a.name.toLowerCase();if("red"===s)t.red=n;else if("green"===s)t.green=n;else if("blue"===s)t.blue=n;else if("nearinfrared"===s||"nearinfrared_1"===s||"nir"===s)t.nir=n;else if(a.maxWavelength&&a.minWavelength){const e=a.minWavelength,s=a.maxWavelength;null==t.blue&&e>=410&&e<=480&&s>=480&&s<=540?t.blue=n:null==t.green&&e>=490&&e<=560&&s>=560&&s<=610?t.green=n:null==t.red&&e>=595&&e<=670&&s>=660&&s<=730?t.red=n:null==t.nir&&e>=700&&e<=860&&s>=800&&s<=950&&(t.nir=n)}}return t}(n);null!=e&&null!=t&&null!=s?a=[e,t,s]:null!=r&&null!=e&&null!=t&&(a=[r,e,t])}return!a&&t>=3&&(a=[0,1,2]),a}function B(t,n,a,r){if(!m(t,n))return null;const{attributeTable:l,statistics:o}=t,u=F(l,n),c=z(l,"red"),f=z(l,"green"),d=z(l,"blue"),h=new s,b=[],g=new Set,y=!!(c&&f&&d);if(null!=l)l.features.forEach((t=>{const n=t.attributes[u.name];if(!g.has(t.attributes[u.name])&&null!=n){g.add(n);const a=y&&("single"===c.type||"double"===c.type)&&("single"===f.type||"double"===f.type)&&("single"===d.type||"double"===d.type)&&!l.features.some((e=>e.attributes[c.name]>1||e.attributes[f.name]>1||e.attributes[d.name]>1)),s=a?255:1;b.push(new p({value:t.attributes[u.name],label:t.attributes[u.name]+"",symbol:{type:"simple-fill",style:"solid",outline:null,color:new e(y?[t.attributes[c.name]*s,t.attributes[f.name]*s,t.attributes[d.name]*s,1]:[0,0,0,0])}}))}}));else if(o?.[0])for(let t=o[0].min;t<=o[0].max;t++)b.push(new p({value:t,label:t.toString(),symbol:{type:"simple-fill",style:"solid",outline:null,color:new e([0,0,0,0])}}));if(b.sort(((e,t)=>e.value&&"string"==typeof e.value.valueOf()?0:e.value>t.value?1:-1)),!y){const t=i(j,{numColors:b.length});b.forEach(((n,a)=>n.symbol.color=new e(t[a].slice(1,4)))),h.colorRamp=j}if(a||r){const t=a||i(r,{numColors:b.length}).map((e=>e.slice(1)));b.forEach(((n,a)=>n.symbol.color=new e(t[a]))),h.colorRamp=r}return new v({field:u.name,uniqueValueInfos:b,authoringInfo:h})}function F(e,t,a){let s;return null!=e?(s=t?e.fields.find((e=>t.toLowerCase()===e.name.toLowerCase())):function(e){let t;for(let n=0;n<e.length;n++){const a=e[n].name.toLowerCase();if("string"===e[n].type){if(a.startsWith("class")){t=e[n];break}null==t&&(a.endsWith("name")||a.endsWith("type"))&&(t=e[n])}}return t}(e.fields),s||(a||(s=e.fields.find((e=>"string"===e.type))),s||(s=z(e,"value")))):s=new n({name:"value"}),s}function z(e,t){return null==e?null:e.fields.find((e=>e.name.toLowerCase()===t))}function U(e){if(!u(e))return null;let t;const{attributeTable:n,colormap:a}=e;if(null!=n){const e=z(n,"value"),a=F(n,null,!0);"string"===a.type&&(t={},n.features.forEach((n=>{const s=n.attributes;t[s[e.name]]=a?s[a.name]:s[e.name]})))}return w.createFromColormap(a,t)}function W(e,n="traditional"){if(!f(e))return null;const{extent:a}=e,s=a.width*t(a.spatialReference);return new x({hillshadeType:n,scalingType:s>5e6?"adjusted":"none"})}function N(e,t){e=E(e,t?.variableName);const{attributeTable:n}=e;if(!c(e))return null;const a=null!=e.histograms?e.histograms[0]:null,l=null!=t?.numClasses&&isFinite(t?.numClasses)?t.numClasses:5,o=new s({classificationMethod:t?.classificationMethod,colorRamp:t?.colorRamp});let u=t?.field||"value";const m=[],f=[],d=null!=n,p=d&&n.fields.find((e=>"count"===e.name.toLowerCase())),g=d?n.fields.find((e=>e.name.toLowerCase()===u.toLowerCase())):void 0;if(g&&d){u=g.name;const e=n.features.length;let t=0;n.features.forEach((n=>t+=(p?n.attributes[p.name]:50)/e)),n.features.forEach((n=>{const a=n.attributes[g.name],s=p?n.attributes[p.name]:50;if(s>0){f.push(s);const n=Math.max(1,Math.round(s/e/t*1e3));for(let e=0;e<n;e++)m.push(a)}}))}else{const{pixelType:t}=e,s=(a.max-a.min)/a.size,r=t.includes("s")||t.includes("u"),l=r&&1===s?Math.floor(a.min+.5):a.min,i=r&&1===s?Math.floor(a.max-.5):a.max,o=a.size;let u,c=0;a.counts.forEach((e=>c+=e/o)),a.counts.forEach(((e,t)=>{if(e>0){f.push(e);const r=Math.max(1,Math.round(e/o/c*1e3));u=d?n.features[t].attributes[g.name]:0===t?l:t===o-1?i:a.min+s*(t+.5);for(let e=0;e<r;e++)m.push(u)}}))}const y=t?.classificationMethod||"natural-breaks";let v=t?.definedInterval;"defined-interval"!==y||v||(v=function(e,t,n){let a=0,s=0;if(null!=e.attributeTable){const n=e.attributeTable;a=s=n.features[0].attributes[t.name],n.features.forEach((e=>{const n=e.attributes[t.name];n<a&&(a=n),n>s&&(s=n)}))}else if(null!=e.histograms){const t=e.histograms;a=t[0].min,s=t[0].max}return(s-a)/n}(e,g,l));const w=h({values:m,valueFrequency:f,normalizationTotal:null,definition:new b({classificationMethod:y,breakCount:l,definedInterval:v})});let x=t?.colors;if(!x){const e=t?.colorRamp||T;o.colorRamp=e;const n=i(e,{numColors:w.classBreaks.length,interpolateAlpha:!0});x=n.map((e=>e.slice(1)))}const M=w.classBreaks.map(((e,t)=>new r({minValue:e.minValue,maxValue:e.maxValue,label:e.label,symbol:{type:"simple-fill",color:x[t]}})));return new C({field:u,classBreakInfos:M,authoringInfo:o})}const O=new Map([["m/s","meter-per-second"],["km/h","kilometer-per-hour"],["knots","knots"],["ft/s","feet-per-second"],["mph","mile-per-hour"]]);function A(e){if(!o(e))return null;let t;if(null!=e.statistics&&e.statistics.length&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:a}=G(e.dataType,e.statistics);t=[{type:"size",field:"Magnitude",minSize:10,maxSize:40,minDataValue:n,maxDataValue:a}]}const n=null!=e.multidimensionalInfo?O.get(e.multidimensionalInfo.variables[0].unit):null,a=new M({visualVariables:t,inputUnit:n,rotationType:"geographic"});return a.visualVariables=[...a.sizeVariables,...a.rotationVariables],a}function D(e){return{color:e.symbolLayers[0].material?.color,type:"esriSFS",style:"esriSFSSolid"}}function J(e){if("uniqueValue"===e.type){const t=e.uniqueValueInfos,n=t?.[0].symbol;return n?.symbolLayers?.length&&(e.uniqueValueInfos=t?.map((e=>({value:e.value,label:e.label,symbol:e.symbol?D(e.symbol):null})))),e}if("classBreaks"===e.type){const t=e.classBreakInfos,n=t[0].symbol;return n?.symbolLayers?.length&&(e.classBreakInfos=t.map((e=>({classMinValue:e.classMinValue,classMaxValue:e.classMaxValue,label:e.label,symbol:e.symbol?D(e.symbol):null})))),e}return e}function P(e){if(!d(e))return null;let t;if(null!=e.statistics&&e.statistics.length>0&&("vector-magdir"===e.dataType||"vector-uv"===e.dataType)){const{minMagnitude:n,maxMagnitude:a}=G(e.dataType,e.statistics);t=[{type:"color",field:"Magnitude",stops:[{value:n,color:"#1020C0"},{value:a,color:"#C02010"}]}]}return new a({visualVariables:t})}function G(e,t){let n,a;if("vector-magdir"===e)n=t[0].min,a=t[0].max;else{const e=t[0].min,s=t[0].max,r=t[1].min,l=t[1].max;n=0,a=Math.max(Math.abs(e),Math.abs(r),Math.abs(s),Math.abs(l))}return{minMagnitude:n,maxMagnitude:a}}export{z as a,U as b,N as c,P as d,G as e,L as f,E as g,q as h,W as i,B as j,F as k,A as l,S as m,J as n,I as o,k as p};
