/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{allSettledErrors as t,throwIfAborted as r,eachAlways as s}from"../core/promiseUtils.js";import{g as o}from"./uuid.js";import{getSiblingOfSameTypeI as a,contentToBlob as c}from"./resourceUtils.js";async function n(e,t,r){const s=await u(e,t,r);await h(s,t,r)}async function p(e,t,r,s,o){const a=await u(r,s,o);await e.update({data:t}),await h(a,s,o)}async function u(s,n,p){if(!n?.resources)return;const u=n.portalItem===s.portalItem?new Set(s.paths):new Set;s.paths.length=0,s.portalItem=n.portalItem;const h=new Set(n.resources.toKeep.map((e=>e.resource.path))),i=new Set,m=[];h.forEach((e=>{u.delete(e),s.paths.push(e)}));const f=[],l=[],w=[];for(const e of n.resources.toUpdate)if(u.delete(e.resource.path),h.has(e.resource.path)||i.has(e.resource.path)){const{resource:t,content:r,finish:n}=e,p=a(t,o());s.paths.push(p.path),f.push({resource:p,content:await c(r),compress:e.compress}),n&&w.push((()=>n(p)))}else{s.paths.push(e.resource.path),l.push({resource:e.resource,content:await c(e.content),compress:e.compress});const t=e.finish;t&&w.push((()=>t(e.resource))),i.add(e.resource.path)}for(const e of n.resources.toAdd)if(s.paths.push(e.resource.path),u.has(e.resource.path))u.delete(e.resource.path);else{f.push({resource:e.resource,content:await c(e.content),compress:e.compress});const t=e.finish;t&&w.push((()=>t(e.resource)))}if(f.length||l.length){const{addOrUpdateResources:e}=await import("./resourceUtils.js");await e(n.portalItem,f,"add",p),await e(n.portalItem,l,"update",p)}if(w.forEach((e=>e())),0===m.length)return u;const d=await t(m);if(r(p),d.length>0)throw new e("save:resources","Failed to save one or more resources",{errors:d});return u}async function h(e,t,r){if(!e||!t.portalItem)return;const o=[];for(const s of e){const e=t.portalItem.resourceFromPath(s);o.push(e.portalItem.removeResource(e,r))}await s(o)}export{n as s,p as u};
