/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{i as t,e}from"../core/lang.js";import{f as s,e as n}from"./mathUtils.js";import{s as r,c as i,d as o,a,p as c,h as u,l as f,g as l,o as h,m as d}from"./vec2.js";import{c as p,f as m,Z as g}from"./vec2f64.js";import{s as L,v as E,d as y,m as M,p as P,i as k,c as _,e as N,C as v,o as A,k as w,j,n as T,z as x}from"./vec3.js";import{c as R,a as q,f as b,d as I}from"./vec3f64.js";import{s as z,f as O}from"./vec4.js";import{c as S}from"./vec4f64.js";import{t as C}from"./geodesicConstants.js";import{directGeodeticSolver as H,inverseGeodeticSolver as F,InverseGeodeticSolverResult as D}from"../geometry/support/geodesicUtils.js";import{h as G,r as Y,y as Z,J as U,K as V,G as J,t as K,g as Q,d as X}from"./plane.js";import{e as W,h as B,j as $,p as tt,g as et}from"./sphere.js";import{t as st}from"./mathUtils2.js";import{b as nt,d as rt,a as it,f as ot,c as at,e as ct}from"./normalizedPoint.js";import{L as ut,i as ft}from"./geometry2dUtils.js";import{watch as lt,syncAndInitial as ht}from"../core/reactiveUtils.js";import{k as dt}from"../core/Accessor.js";import{sqlAnd as pt}from"../core/sql.js";import{a as mt}from"./timeUtils.js";import{m as gt}from"./dehydratedPoint.js";import Lt from"../rest/support/Query.js";import{V as Et}from"./InputManager.js";import{a as yt}from"./keybindings.js";function Mt({start:t,end:e,type:s},n,c){const u=[],f=r(St,e,t),l=r(Ct,t,n),h=i(f),d=2*o(f,l),m=d*d-4*h*(i(l)-c*c);if(0===m){const e=-d/(2*h);(s===It.PLANE||e>=0)&&u.push(a(p(),t,f,e))}else if(m>0){const e=Math.sqrt(m),n=(-d+e)/(2*h);(s===It.PLANE||n>=0)&&u.push(a(p(),t,f,n));const r=(-d-e)/(2*h);(s===It.PLANE||r>=0)&&u.push(a(p(),t,f,r))}return u}function Pt(t,e){const s=t.start,n=t.end,i=r(St,n,s),a=L(Ft,-i[1],i[0],0),u=e.start,f=e.end,l=E(Dt,f,u),h=y(l,a),d=L(Gt,s[0],s[1],0),p=E(Yt,d,u),m=y(p,a);if(Math.abs(h)<Ot)return Math.abs(m),[];const g=M(Zt,u,l,m/h);if(e.type===ut.RAY){const t=E(Ut,g,u);if(y(t,l)<-Ot)return[]}if(t.type===It.HALF_PLANE){const t=c(Ct,g,s);if(o(t,i)<-Ot)return[]}return[q(g)]}function kt(t,e){return jt(xt(Jt,0,t),xt(Kt,0,e)).map((([t,e])=>m(t,e)))}function _t(t,e){return vt(t,xt(Jt,t[2],e))}function Nt(t,e,s){const n=r(St,t,e),i=f(n),o=0===i?1:s/i,c=R();return a(c,e,n,o),c[2]=t[2],c}function vt(t,{start:e,end:s,type:n},r=R()){const i=E(Ht,t,e),o=E(Ft,s,e),a=y(i,o)/y(o,o);return M(r,e,o,n===ut.RAY?Math.max(a,0):a)}const At=(()=>{const t=R(),e=R(),s=R();return({start:n,end:r},{center:i,radius:o,normal:a,slicePlane:c})=>{const u=Z(i,a,Vt);if(qt(U(u,n),0)&&qt(U(u,r),0)){st(a,t,e);const u=(n,r)=>(_(s,r,i),l(n,y(s,t),y(s,e)),n),f=ft({start:u(St,n),end:u(Ct,r),type:ut.LINE},g,o),h=[];for(const[s,n]of f){const r=P(R(),i);M(r,r,t,s),M(r,r,e,n),c&&!bt(c,r)||h.push(r)}return h}const f=R();return V(u,n,r,f)?!qt(k(f,i),o)||c&&!bt(c,f)?[]:[f]:[]}})();function wt({start:t,end:e,type:s},n,a){const c=[],u=_(Ht,e,t),f=r(Ct,t,n),l=i(u),h=2*o(u,f),d=h*h-4*l*(i(f)-a*a);if(0===d){const e=-h/(2*l);(s===ut.LINE||e>=0)&&c.push(M(R(),t,u,e))}else if(d>0){const e=Math.sqrt(d),n=(-h+e)/(2*l);(s===ut.LINE||n>=0)&&c.push(M(R(),t,u,n));const r=(-h-e)/(2*l);(s===ut.LINE||r>=0)&&c.push(M(R(),t,u,r))}return c}function jt(t,e){const s=t.start,n=t.end,r=e.start,i=e.end,o=E(Ht,n,s),a=E(Ft,i,r),c=E(Dt,r,s),u=N(Gt,o,a);if(!qt(y(c,u),0))return[];const f=v(u);if(qt(f,0))return[];const l=N(Yt,c,a),h=y(l,u)/f,d=M(Zt,s,o,h);if(t.type===ut.RAY){const t=E(Ut,d,s);if(y(o,t)<-Ot)return[]}if(e.type===ut.RAY){const t=E(Ut,d,r);if(y(a,t)<-Ot)return[]}return[q(d)]}function Tt(t,e,s,n){const[r,i]=t,[o,a]=s,c=o-r,f=a-i,l=c*c+f*f,h=Math.sqrt(l);if(h>e+n)return[];if(h<Math.abs(e-n))return[];if(qt(h,0)&&qt(e,n))return[];const d=(e*e-n*n+l)/(2*h),p=Math.sqrt(e*e-d*d),g=p*f/h,L=p*c/h,[E,y]=u(St,t,s,d/h);return qt(g,L)?[m(E,y)]:[m(E+g,y-L),m(E-g,y+L)]}function xt(t,e,{start:s,end:n,type:r}){return L(t.start,s[0],s[1],e),L(t.end,n[0],n[1],e),t.type=zt[r],t}function Rt(t,e){return qt(t[2],e[2])}function qt(t,e){return s(Math.abs(t-e),0,Ot)}function bt(t,e){return Y(t,e)}var It;!function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"}(It||(It={}));const zt={[It.PLANE]:ut.LINE,[It.HALF_PLANE]:ut.RAY},Ot=1e-6,St=p(),Ct=p(),Ht=R(),Ft=R(),Dt=R(),Gt=R(),Yt=R(),Zt=R(),Ut=R(),Vt=G(),Jt={start:R(),end:R(),type:ut.LINE},Kt={start:R(),end:R(),type:ut.LINE};class Qt{intersect(t){return Pe(this,t)}closestPoints(t){return[this.closestTo(t)]}}class Xt extends Qt{constructor(t){super(),this.point=t}equals(t){return this===t||Ie(t)&&A(this.point,t.point)}closestTo(){return rt(this.point)}}class Wt extends Qt{constructor(t,e,s){super(),this.start=t,this.end=e,this.lineLike={start:t,end:e,type:s}}equals(t){return this===t||ze(t)&&this.lineLike.type===t.lineLike.type&&A(this.start,t.start)&&A(this.end,t.end)}closestTo(t){const e=vt(t,this.lineLike);return nt(e)}}class Bt extends Wt{constructor(t,e){super(t,e,ut.LINE)}}class $t extends Wt{constructor(t,e){super(t,e,ut.RAY)}}class te extends Qt{constructor(t){super(),this.constraints=t}equals(t){return this===t||be(t)&&e(this.constraints,t.constraints,((t,e)=>t.equals(e)))}closestTo(t){let e,s=1/0;for(const n of this.constraints){const r=n.closestTo(t),i=w(t,r);i<s&&(s=i,e=r)}return e?rt(e):t}closestPoints(t){return this.constraints.flatMap((e=>e===this?[]:e.closestPoints(t)))}}class ee extends Qt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||Ce(t)&&this.center[0]===t.center[0]&&this.center[1]===t.center[1]&&this.radius===t.radius}closestTo(t){const e=Nt(t,this.center,this.radius);return nt(e)}}class se extends Qt{constructor(t,e){super(),this.center=t,this.radius=e}equals(t){return this===t||He(t)&&A(this.center,t.center)&&this.radius===t.radius}closestTo(t){const e=Nt(t,this.center,this.radius);return e[2]=this.center[2],nt(e)}asCircle(){return new ne(rt(this.center),this.radius,ot(0,0,1))}}class ne extends Qt{constructor(t,e,s,n=void 0){super(),this.center=t,this.radius=e,this.normal=s,this.slicePlane=n}equals(t){return this===t||Fe(t)&&A(this.center,t.center)&&A(this.normal,t.normal)&&this.radius===t.radius}closestTo(t){const{center:e,radius:s}=this;K(this.getPlane(ie),t,re);const n=E(re,re,e),r=j(n);if(qt(r,0))return rt(t);const i=s/Math.sqrt(r),o=M(R(),e,n,i),{slicePlane:a}=this;if(a&&!bt(a,o)){const e=_e(a,this);return e?.closestTo(t)??rt(t)}return nt(o)}getPlane(t=G()){return Z(this.center,this.normal,t)}}const re=R(),ie=G();class oe extends Qt{constructor(t){super(),this.z=t}equals(t){return this===t||Oe(t)&&this.z===t.z}closestTo(t){return nt(b(t[0],t[1],this.z))}getPlane(t=G()){return L(ae,0,0,this.z),Z(ae,I,t)}}const ae=R();class ce extends Qt{constructor(t,e,s){super(),this.start=t,this.end=e,this.planeLike={start:it(t),end:it(e),type:s}}equals(t){return this===t||Se(t)&&this.planeLike.type===t.planeLike.type&&A(this.start,t.start)&&A(this.end,t.end)}closestTo(t){return nt(_t(t,this.planeLike))}closestEndTo(t){const{start:e,end:s}=this.planeLike;return Math.sign(o(r(ue,s,e),r(fe,it(t),e)))>0?this.end:this.start}getPlane(t=G()){const e=P(le,this.end);return e[2]+=1,X(this.start,this.end,e,t)}getSlicePlane(t=G()){const{start:e,end:s,type:n}=this.planeLike;if(n===It.PLANE)return;const r=L(le,e[0],e[1],0),i=L(he,s[0],s[1],0),o=_(he,i,r);return Z(r,o,t),t}}const ue=p(),fe=p(),le=R(),he=R();class de extends ce{constructor(t,e){super(t,e,It.HALF_PLANE)}}class pe extends ce{constructor(t,e){super(t,e,It.PLANE)}}class me extends Qt{constructor(t,e){super(),this.sphere=B(t,e)}equals(t){return this===t||De(t)&&$(this.sphere,t.sphere)}closestTo(t){const e=tt(this.sphere,t,R());return nt(e)}get center(){return et(this.sphere)}get radius(){return this.sphere[3]}}class ge extends Qt{constructor(t,e,s){super(),this.start=t,this.end=e,this.getZ=s,this.planeLike={start:it(t),end:it(e),type:It.PLANE}}equals(t){return this===t||Ge(t)&&A(this.start,t.start)&&A(this.end,t.end)&&this.getZ===t.getZ}closestTo(t){return function(t,e){const s=_t(e,t.planeLike);return s[2]=t.getZ(s[0],s[1])??Ye,nt(s)}(this,t)}addIfOnTheGround(t,e){for(const s of e){const e=this.getZ(s[0],s[1])??0;qt(s[2],e)&&(s[2]=e,t.push(s))}}}class Le extends Qt{constructor(t,e,s,n,r){super(),this._origin=t,this._spatialReference=e,this._distanceMeters=s,this._elevationMeters=n,this._directionDegrees=r}equals(t){return this===t||t instanceof Le&&d(this._origin,t._origin)&&this._distanceMeters===t._distanceMeters&&this._elevationMeters===t._elevationMeters&&this._directionDegrees===t._directionDegrees}closestTo([t,e,s]){if(l(Ee,t,e),null!=this._directionDegrees&&null!=this._distanceMeters)H(Ee,this._origin,this._directionDegrees,this._distanceMeters,this._spatialReference);else if(null!=this._directionDegrees)!function(t,e,s,n,r){let{azimuth:i,distance:o}=F(Me,e,n,r);i??=0;let a=o*Math.cos((i-s)*C);a=Math.max(0,a),H(t,e,s,a,r)}(Ee,this._origin,this._directionDegrees,Ee,this._spatialReference);else if(null!=this._distanceMeters){const{azimuth:t}=F(ye,this._origin,Ee,this._spatialReference);H(Ee,this._origin,t??0,this._distanceMeters,this._spatialReference)}return at(Ee[0],Ee[1],this._elevationMeters??s)}}const Ee=[0,0],ye=new D,Me=new D;function Pe(t,e){if(be(t)){const s=[];for(const n of t.constraints){const t=n.intersect(e);t&&s.push(t)}return qe(s)}if(be(e))return Pe(e,t);if(Ge(t))return je(t,e);if(Ge(e))return je(e,t);if(Ie(t)){const{point:s}=t,n=e.closestTo(s);return x(n,s)?t:void 0}if(ze(t)){if(Ie(e))return Pe(e,t);if(ze(e))return xe(jt(t.lineLike,e.lineLike));if(Oe(e))return ke(t,e);if(Se(e))return xe(Pt(e.planeLike,t.lineLike));if(Ce(e))return xe(wt(t.lineLike,e.center,e.radius));if(Fe(e))return xe(At(t.lineLike,e));if(He(e))return function({lineLike:t},{center:e,radius:s}){const n=e[2];return xe(wt(t,e,s).filter((t=>qt(t[2],n))))}(t,e);if(De(e))return function({lineLike:t},{sphere:e}){return xe(W(e,t.start,t.end))}(t,e)}else if(Oe(t)){if(Ie(e)||ze(e))return Pe(e,t);if(Oe(e))return function(t,e){return qt(t.z,e.z)?t:void 0}(t,e);if(Se(e))return function({z:t},{planeLike:e}){const[s,n]=e.start,[r,i]=e.end,o=ot(s,n,t),a=ot(r,i,t);return e.type===It.PLANE?new Bt(o,a):new $t(o,a)}(t,e);if(Ce(e))return function(t,e){const[s,n]=e.center;return new se(ot(s,n,t.z),e.radius)}(t,e);if(Fe(e))return Ne(t,e);if(He(e))return s=t,qt((n=e).center[2],s.z)?n:void 0;if(De(e))return function(t,{center:e,radius:s}){const n=Math.abs(e[2]-t.z);if(n>s&&!qt(n,s))return;const r=ot(e[0],e[1],t.z),i=Math.sqrt(s**2-n**2);return qt(i,0)?void 0:new se(r,i)}(t,e)}else if(Se(t)){if(Ie(e)||ze(e)||Oe(e))return Pe(e,t);if(Se(e))return Te(kt(t.planeLike,e.planeLike));if(Ce(e))return Te(Mt(t.planeLike,e.center,e.radius));if(Fe(e))return Ae(t,e);if(He(e))return ve(t,e);if(De(e))return we(t,e)}else if(Ce(t)){if(Ie(e)||ze(e)||Oe(e)||Se(e))return Pe(e,t);if(Ce(e))return Te(Tt(it(t.center),t.radius,it(e.center),e.radius));if(Fe(e))return;if(He(e))return function(t,e){return qt(h(it(t.center),it(e.center)),0)&&qt(t.radius,e.radius)?e:Re(Tt(it(t.center),t.radius,it(e.center),e.radius),e.center[2])}(t,e);if(De(e))return}else if(Fe(t)){if(Ie(e)||ze(e)||Oe(e)||Se(e)||Ce(e))return Pe(e,t);if(Fe(e))return;if(He(e))return void e.asCircle();if(De(e))return}else if(He(t)){if(Ie(e)||ze(e)||Oe(e)||Se(e)||Ce(e)||Fe(e))return Pe(e,t);if(He(e))return function(t,e){if(Rt(t.center,e.center))return qt(h(it(t.center),it(e.center)),0)&&qt(t.radius,e.radius)?t:Re(Tt(it(t.center),t.radius,it(e.center),e.radius),t.center[2])}(e,t);if(De(e))return}else if(De(t)){if(Ie(e)||ze(e)||Oe(e)||Se(e)||Ce(e)||He(e))return Pe(e,t);if(De(e))return}var s,n}const ke=(()=>{const t=G();return(e,s)=>{const{start:n,end:r}=e;if(Rt(n,r)&&qt(n[2],s.z))return e;const i=R();return V(s.getPlane(t),n,r,i)?new Xt(nt(i)):void 0}})(),_e=(()=>{const t=S(),e=R(),s=R();return(r,i,o)=>{const{normal:a,center:c,radius:u}=i;st(a,e,s);const f=Q(r),l=u*y(f,e),h=u*y(f,s);z(t,c[0],c[1],c[2],1);const d=O(r,t),p=Math.hypot(l,h),m=qt(p,0);if(qt(U(r,c),0)){if(m)return i;if(qt(u,0))return!o||bt(o,c)?new Xt(rt(c)):void 0;N(e,f,a),T(e,e);const t=new Array,s=q(c);M(s,s,e,u),o&&!bt(o,s)||t.push(s);const n=q(c);return M(n,n,e,-u),o&&!bt(o,n)||t.push(n),xe(t)}if(m)return;const g=-d/p;if(Math.abs(g)>1||qt(g,1))return;const L=Math.atan(l/h),E=n(g)-L,P=Math.PI-E,k=new Array,_=R();M(_,c,e,u*Math.cos(E)),M(_,_,s,u*Math.sin(E)),k.push(_);const v=R();return M(v,c,e,u*Math.cos(P)),M(v,v,s,u*Math.sin(P)),k.push(v),xe(o?function(t,e){return e.filter((e=>bt(t,e)))}(o,k):k)}})(),Ne=(()=>{const t=G();return(e,s)=>_e(e.getPlane(t),s,s.slicePlane)})(),ve=(()=>{const t=G();return(e,{center:s,radius:n})=>{const r=Mt(e.planeLike,s,n),i=s[2];e.getSlicePlane(t);const o=new Array;for(const[e,s]of r){const n=[e,s,i];bt(t,n)&&o.push(n)}return xe(o)}})(),Ae=(()=>{const t=G(),e=G();return(s,n)=>_e(s.getPlane(t),n,s.getSlicePlane(e))})(),we=(()=>{const t=G();return(e,{center:s,radius:n})=>{const r=e.getPlane(t),i=J(r,s),o=Math.abs(i);if(o>n&&!qt(o,n))return;const a=q(Q(r)),c=M(R(),s,a,i),u=Math.sqrt(n**2-i**2);return qt(u,0)?new Xt(nt(K(r,s,R()))):new ne(nt(c),u,a,e.getSlicePlane())}})();function je(t,e){const{planeLike:s,getZ:n}=t,r=new Array;if(Ie(e))t.addIfOnTheGround(r,(i=s,o=e.point,function({start:t,end:e,type:s},n){const r=E(Ht,n,t),i=E(Ft,e,t),o=N(Dt,i,r);if(v(o)/v(i)<Ot)switch(s){case ut.LINE:return[q(n)];case ut.RAY:return y(i,r)<-Ot?[]:[q(n)]}return[]}(xt(Jt,o[2],i),o)));else if(ze(e))t.addIfOnTheGround(r,Pt(s,e.lineLike));else if(Ce(e))for(const[t,i]of Mt(s,e.center,e.radius)){const e=n(t,i);null!=e&&r.push(b(t,i,e))}else if(Se(e)||Ge(e))for(const[t,i]of kt(s,e.planeLike)){const e=n(t,i)??Ye;r.push(b(t,i,e))}var i,o;return xe(r)}function Te(t){return qe(t.map((([t,e])=>{const s=ot(t,e,0),n=ot(t,e,1);return new Bt(s,n)})))}function xe(t){return qe(t.map((t=>t?new Xt(nt(t)):void 0)))}function Re(t,e){return xe(t.map((([t,s])=>[t,s,e])))}function qe(e){if(0!==e.length)return 1===e.length?e[0]??void 0:new te(e.filter(t))}function be(t){return t instanceof te}function Ie(t){return t instanceof Xt}function ze(t){return t instanceof Wt}function Oe(t){return t instanceof oe}function Se(t){return t instanceof ce}function Ce(t){return t instanceof ee}function He(t){return t instanceof se}function Fe(t){return t instanceof ne}function De(t){return t instanceof me}function Ge(t){return t instanceof ge}const Ye=0;function Ze(t,e){const s=t.x-e.x,n=t.y-e.y;return s*s+n*n}function Ue(t,e){return Math.sqrt(Ze(t,e))}function Ve(t,e){e.sort(((e,s)=>w(e.targetPoint,t)-w(s.targetPoint,t)))}var Je;function Ke({point:t,distance:e,returnEdge:s,vertexMode:n,coordinateHelper:{spatialReference:r},filter:i},o,a){return a=null!=a?a.clone():new Lt({where:"1=1"}),i&&(a.geometry=i.geometry,a.distance=i.distance,a.spatialRelationship=i.spatialRelationship,a.where=pt(a.where,i.where),a.timeExtent=mt(a.timeExtent,i.timeExtent),a.objectIds=(c=a.objectIds,u=i.objectIds,c||u?u?c?Array.from(dt(new Set(c),new Set(u))):u:c:null)),{point:gt(t[0],t[1],t[2],r.toJSON()),mode:o,distance:e,returnEdge:s,vertexMode:n,query:a.toJSON()};var c,u}function Qe(t,e,s){return{left:ct(t.leftVertex.pos,e,s),right:ct(t.rightVertex.pos,e,s)}}function Xe(t){return t.createQuery()}!function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"}(Je||(Je={}));const We=Symbol("snapping-toggle");function Be(t,e=(()=>{})){const s=lt((()=>({view:t.view,snappingOptions:t.snappingOptions})),(({view:s,snappingOptions:n})=>{if(t.removeHandles(We),!s||!n)return;const r=Et.TOOL,i=[s.on("key-down",(t=>{t.key!==yt.toggle||t.repeat||(n.enabledToggled=!0,e())}),r),s.on("key-up",(t=>{t.key===yt.toggle&&(n.enabledToggled=!1,e())}),r),s.on("pointer-move",(t=>{const s=t.native.ctrlKey;n.enabledToggled!==s&&(n.enabledToggled=s,e())}),r)];t.addHandles(i,We)}),ht);t.addHandles(s)}function $e(t){return null!=t&&"object"==typeof t&&"declaredClass"in t&&"esri.WebMap"===t.declaredClass&&"utilityNetworks"in t&&!!t?.utilityNetworks?.length}export{ge as D,Le as G,oe as H,Je as L,Xt as P,ee as V,Ke as a,Be as b,qe as c,de as d,$e as e,Bt as f,Ue as g,Ze as h,Ie as i,pe as j,Qe as k,Ot as l,Xe as m,vt as p,Ve as s};
