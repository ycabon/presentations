/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{O as t,Q as s,ae as n,af as r}from"./unitUtils.js";import{m as i}from"./layerUtils2.js";import{V as o}from"./ViewingMode.js";import{_ as a}from"./tslib.es6.js";import l from"../request.js";import u from"../core/Accessor.js";import{r as c,clone as h}from"../core/lang.js";import f from"../core/Error.js";import{r as m,a as p,d as T}from"./maybe.js";import{createResolver as d,onAbort as _,createAbortError as g,throwIfAborted as S,isAbortError as E}from"../core/promiseUtils.js";import{property as k}from"../core/accessorSupport/decorators/property.js";import"./Logger.js";import{subclass as O}from"../core/accessorSupport/decorators/subclass.js";import{a as y}from"./Util.js";import{T as b}from"./Scheduler.js";import{p as W,c as w,d as L,h as N,b as A}from"./vec3.js";import{c as R}from"./vec3f64.js";import{canProjectToWGS84ComparableLonLat as H}from"../geometry/projection.js";import{r as I,s as D,d as U,c as C}from"./aaBoundingRect.js";import{m as x}from"./TerrainConst.js";import{g as j,T as Q}from"./TilingScheme.js";class v{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class q{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new M}}class M{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class z{constructor(e,t,s,n){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=n.map((e=>new q(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t&&(t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,y(t.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}let F=class extends u{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new z(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(b.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=m(this._frameTask),this._tasks.forEach((e=>p(e.abortController))),this._loadQueue=T(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,n={}){const r=d();r.__signal=null!=n?n.signal:null;const i=this._createOrUpdateTask(e,t,s,n,r);return _(n,(()=>this._cancelRequest(i,r))),r.promise}_createTask(e,t,s,n,r,i){const o=new B(e,t,s,n,r);return this._updateTask(o,i),this._tasks.set(r,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){c(e.resolvers,t),t.reject(g()),0===e.resolvers.length&&(e.status===P.DOWNLOADING&&(e.status=P.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=P.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,n,r){const i=function(e,t,s){return`${e}:${t}:${s}`}(n?.uid||e,t,s),o=this._tasks.get(i);return o?(this._updateTask(o,r),o):this._createTask(e,n,t,s,i,r)}_doneLoadingCB(e,t){this._loadQueue&&(y(e.status===P.DOWNLOADING),e.status=P.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();S(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==P.DOWNLOADED&&(t.err=t.err||g()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!E(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const n of e.resolvers)if(t)E(t)?n.reject(t):n.reject(new f("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s>0?h(e.result):e.result;n.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===P.CANCELLED)return!1;let s,n;switch(e.startTime=performance.now(),e.status=P.DOWNLOADING,e.docType){case"binary":n="array-buffer",s=0;break;case"image":n="image";break;case"image+type":n="array-buffer";break;default:n="json"}e.abortController=new AbortController;const r=e.abortController.signal;e.request=l(e.url,{...e.options,responseType:n,timeout:s,signal:r});let i=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=s=>{e.status===P.DOWNLOADING&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),a),!0):(e.request.then((t=>{const u=t.data,c=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(u);if(n="image",e.size=u.byteLength,"unknown"===c)return e.request=l(e.url,{responseType:n,timeout:s,signal:r}),void e.request.then((e=>o(e.data)),a);const h=new Blob([u],{type:c}),f=window.URL.createObjectURL(h);i=()=>window.URL.revokeObjectURL(f),e.request=l(f,{responseType:n,timeout:s,signal:r}),e.request.then((e=>o(new G(e.data,c,i))),a)}),a),!0)}get test(){return{loadQueue:this._loadQueue}}};a([k({readOnly:!0})],F.prototype,"updating",void 0),F=a([O("esri.views.3d.support.StreamDataLoader")],F);class G{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}function V(e){return"image"in e&&"type"in e}class B extends v{constructor(e,t,s,n,r){super(n),this.url=e,this.options=t,this.docType=s,this.key=r,this.result=null,this.status=P.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=0}}var P,$,J;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(P||(P={})),function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"}($||($={})),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(J||(J={}));const K=R(),X=R(),Y=R(),Z=R();function ee(e,t,s,n){W(K,s),K[n]=t[n];const r=w(K,K,t),i=w(X,e,t),o=L(i,r),a=L(r,r);let l;l=o<=0?t:a<=o?s:N(K,t,A(r,r,o/a));const u=w(K,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const te=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,t,s){if(null==e)return j();if(e.spatialReference.isGeographic&&!H(e.spatialReference))return new f("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const n=Q.checkUnsupported(e);if(null!=n)return n;if(null==s)return new f("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const r=function(e,t){const s=e.lods,n=s[0].resolution*2**s[0].level,r=[n*e.size[0],n*e.size[1]],i=[e.origin.x,e.origin.y],o=U(t),a=C();Q.computeRowColExtent(o,r,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>x){const t=s[0].scale*2**s[0].level;let r=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/n;const i=Math.floor(Math.log(r)/Math.log(10));return r=Math.ceil(r/10**i)*10**i,new f("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+r.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:r,requiredNumRootTiles:l,allowedNumRootTiles:x})}return null}(e,s);if(r)return r;const i=e.spatialReference;return null==t||i.equals(t)||t.isWGS84&&i.isWebMercator?null:new f("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene")},isInsideExtent:function(e,t,s=0){const n=e.extent;if(null==n)return!1;if(0===s)return I(n,t);const r=Math.min(n[2]-n[0],n[3]-n[1]);return D(n,t,s*r)},tiltToExtentEdge:function(e,t,s){const n=e.extent;if(null==n)return 0;Y[0]=n[0],Y[1]=n[1],Y[2]=s,Z[0]=n[2],Z[1]=n[3],Z[2]=s;let r=1/0,i=1/0;return t[0]<Y[0]?r=ee(t,Y,Z,0):t[0]>Z[0]&&(r=ee(t,Z,Y,0)),t[1]<Y[1]?i=ee(t,Y,Z,1):t[1]>Z[1]&&(i=ee(t,Z,Y,1)),Math.min(r,i)}},Symbol.toStringTag,{value:"Module"})),se=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:function(e,n){if(null==e)return j();const r=e.lods.length-1,i=e.spatialReference,o=H(i)||t(i)||s(i);if(i.isWebMercator){if(!Q.makeWebMercatorAuxiliarySphere(r).compatibleWith(e))return new f("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!o)return new f("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Q.makeGCSWithTileSize(e.spatialReference,e.size[0],r).compatibleWith(e))return e.spatialReference.isWGS84?new f("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new f("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return null==n||e.spatialReference.equals(n)?void 0:new f("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")},isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0}},Symbol.toStringTag,{value:"Module"})),ne={[o.Global]:se,[o.Local]:te};function re(e,t){e||console.warn("Terrain: "+t)}let ie=!1,oe=!1;function ae(e){oe=e,ie=ie||e}function le(e){ie=e}function ue(e,t){if(ie&&!e){const e=(new Error).stack?.slice(5);throw console.warn("Terrain internal: "+(t??"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function ce(e){return fe(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function he(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function fe(e){return"imagery-tile-3d"===e?.type}function me(e){return"tile-3d"===e?.type}function pe(e){return"vector-tile-3d"===e?.type}function Te(e){return"wmts-3d"===e?.type}function de(e){return"elevation-3d"===e?.type}function _e(e){return"group"===e?.type}function ge(e){return e&&(me(e)||Te(e)||fe(e)||pe(e))}function Se(e){return e&&(me(e)||fe(e)||pe(e)||Te(e))}function Ee(e){return Se(e)||de(e)}function ke(e){const t=e?.sourceLayerInfo?.data;return null!=t&&"type"in t&&"raster-tile"===t.type}function Oe(e){return We(e?.sourceLayerInfo)||!!e?.isVTLBackground}function ye(e){const t=e?.sourceLayerInfo?.data;return null!=t&&"type"in t&&"tile-texture"===t.type}function be(e){const t=e?.sourceLayerInfo?.data;return t instanceof HTMLImageElement||t instanceof G||t instanceof HTMLCanvasElement||t instanceof ImageData}function We(e){return null!=e?.data&&"type"in e.data&&"vector-tile"===e.data.type}function we(e){return null!=e&&"release"in e&&e.release(),null}function Le(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Ne(e,t,s,n){return ne[n].checkIfTileInfoSupportedForViewSR(e,s,t)}function Ae(e,t,s){let n=null,r=null;if("wmts"===e?.type){const i=Re(e,t,s);n=i.tileInfo,r=i.fullExtent}else{r=he(e)?e.getCompatibleFullExtent(t):e.fullExtent;const i=s===o.Local;if(he(e))n=e.getCompatibleTileInfo(t,r,i);else if("vector-tile"===e?.type){const s=i&&!He(t)||Ie.force512VTL,r=e.tileInfo.spatialReference.isGeographic;n=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,r?1:2)}else n=e.tileInfo}return null!=n&&null!=r&&null==Ne(n,r,t,s)?{tileInfo:n,fullExtent:r}:null}function Re(t,s,n){const r=i(t);if(null!=r){if(!e.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const e=r.find((e=>null==Ne(e.tileInfo,e.fullExtent,s,n)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function He(e){return e.isWGS84||e.isWebMercator||n(e)||!r(e)}const Ie={force512VTL:!1};function De(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Ue(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function Ce(e,t,s=Be){return Math.abs(e-t)<s}function xe(e){return e===J.NORTH_EAST?J.SOUTH_WEST:e===J.NORTH_WEST?J.SOUTH_EAST:e===J.SOUTH_WEST?J.NORTH_EAST:J.NORTH_WEST}function je(e){return e===J.NORTH?J.SOUTH:e===J.EAST?J.WEST:e===J.SOUTH?J.NORTH:J.EAST}function Qe(e){return e===J.NORTH_WEST||e===J.SOUTH_WEST}function ve(e){return e===J.NORTH_WEST||e===J.NORTH_EAST}function qe(e){return e===J.NORTH_WEST||e===J.WEST||e===J.SOUTH_WEST}function Me(e){return e===J.NORTH_EAST||e===J.EAST||e===J.SOUTH_EAST}function ze(e){return e===J.SOUTH_EAST||e===J.SOUTH||e===J.SOUTH_WEST}function Fe(e){return e===J.NORTH_EAST||e===J.NORTH||e===J.NORTH_WEST}const Ge=[J.NORTH,J.EAST,J.SOUTH,J.WEST],Ve=[J.NORTH_EAST,J.SOUTH_EAST,J.SOUTH_WEST,J.NORTH_WEST],Be=1e-5;export{pe as A,Oe as B,ke as C,be as D,ye as E,V as F,We as G,Ee as H,G as I,_e as J,Se as K,de as L,Le as M,J as N,fe as O,me as P,le as Q,ae as R,F as S,$ as T,Ae as a,ue as b,Ne as c,ce as d,ge as e,ie as f,Re as g,je as h,he as i,Ve as j,Fe as k,ze as l,qe as m,Ge as n,xe as o,Me as p,oe as q,we as r,Qe as s,Ie as t,ve as u,He as v,re as w,Ce as x,Ue as y,De as z};
