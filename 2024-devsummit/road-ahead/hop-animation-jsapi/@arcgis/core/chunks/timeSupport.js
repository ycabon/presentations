/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{J as e}from"./jsonMap.js";import{f as t,e as r,c as n,b as i,w as s,k as o}from"./unitUtils.js";import{canProjectWithoutEngine as l}from"../geometry/projection.js";import{e as a}from"./extentUtils.js";import{fromJSON as u,isExtent as c,isPolygon as f,isPolyline as m,getJsonType as p}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as y}from"../geometry/support/normalizeUtils.js";import{c as R,p as S}from"./projectionSupport.js";import g from"../core/Error.js";import{f as d,g as h,b as w,h as j}from"../geometry/Extent.js";import{i as v,q as G,r as I,j as N,k as P,l as x,m as b,c as M}from"./featureConversionUtils.js";import{O as U}from"./OptimizedGeometry.js";const E=new U,F=new U,O=new U,A={esriGeometryPoint:N,esriGeometryPolyline:P,esriGeometryPolygon:x,esriGeometryMultipoint:b};function T(e,t,r,n=e.hasZ,i=e.hasM){if(null==t)return null;const s=e.hasZ&&n,o=e.hasM&&i;if(r){const l=G(O,t,e.hasZ,e.hasM,"esriGeometryPoint",r,n,i);return N(l,s,o)}return N(t,s,o)}function q(e,t,r,n,i,s,o=t,l=r){const a=t&&o,u=r&&l,c=null!=n?"coords"in n?n:n.geometry:null;if(null==c)return null;if(i){let n=v(F,c,t,r,e,i,o,l);return s&&(n=G(O,n,a,u,e,s)),A[e]?.(n,a,u)??null}if(s){const n=G(O,c,t,r,e,s,o,l);return A[e]?.(n,a,u)??null}return I(E,c,t,r,o,l),A[e]?.(E,a,u)??null}function C(e){return e&&_ in e?JSON.parse(JSON.stringify(e,J)):e}const _="_geVersion",J=(e,t)=>e!==_?t:void 0,z=new e({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),k=Object.freeze({});async function B(e,t,r){const{outFields:n,orderByFields:i,groupByFieldsForStatistics:s,outStatistics:o}=e;if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(i)for(let e=0;e<i.length;e++)i[e]=i[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(o)for(let e=0;e<o.length;e++)o[e].onStatisticField&&(o[e].onStatisticField=o[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),V(e,t,r)}async function V(e,t,o){if(!e)return null;let{where:l}=e;if(e.where=l=l?.trim(),(!l||/^1 *= *1$/.test(l)||t&&t===l)&&(e.where=null),!e.geometry)return e;let f=await async function(e){const{distance:t,units:o}=e,l=e.geometry;if(null==t||"vertexAttributes"in l)return l;const a=l.spatialReference,u=o?z.fromJSON(o):r(a),c=a&&(n(a)||i(a))?l:await R(a,s).then((()=>S(l,s)));return(await async function(){return(await import("./geometryEngineJSON.js").then((e=>e.g))).geodesicBuffer}())(c.spatialReference,c,t,u)}(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;f=a(f),f.spatialReference=t}if(f){await R(f.spatialReference,o),f=function(e,t){const r=e.spatialReference;return Z(e,t)&&c(e)?{spatialReference:r,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}(f,o);const t=(await y(u(f)))[0];if(null==t)throw k;const r="quantizationParameters"in e&&e.quantizationParameters?.tolerance||"maxAllowableOffset"in e&&e.maxAllowableOffset||0,n=r&&Z(f,o)?{densificationStep:8*r}:void 0,i=t.toJSON(),s=S(i,i.spatialReference,o,n);if(!s)throw k;s.spatialReference=o,e.geometry=s}return e}function Z(e,r){if(!e)return!1;const n=e.spatialReference;return(c(e)||f(e)||m(e))&&!t(n,r)&&!l(n,r)}function D(e,t){return e?t?4:3:t?3:2}function W(e,t,r,n,i){if(!e)return!1;const s=D(t,r),{coords:o,lengths:l}=e;let a=!1,u=0;for(const e of l)a=Y(a,o,s,u,e,n,i),u+=e*s;return a}function Y(e,t,r,n,i,s,o){let l=e,a=n;for(let e=n,u=n+i*r;e<u;e+=r){a=e+r,a===u&&(a=n);const i=t[e],c=t[e+1],f=t[a],m=t[a+1];(c<o&&m>=o||m<o&&c>=o)&&i+(o-c)/(m-c)*(f-i)<s&&(l=!l)}return l}const K="unsupported-query",$={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},H={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},L={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},Q={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function X(e,t,r,n,i){if(f(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=M(new U,t,!1,!1);return Promise.resolve((t=>function(e,t,r,n){return W(e,!1,!1,n.coords[0],n.coords[1])}(e,0,0,t)))}if(f(t)&&"esriGeometryMultipoint"===r){const r=M(new U,t,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,n,i,s){const o=D(i,s),{coords:l,lengths:a}=n;if(!a)return!1;for(let t=0,r=0;t<a.length;t++,r+=o)if(!W(e,!1,!1,l[r],l[r+1]))return!1;return!0}(r,0,0,e,n,i)))}if(c(t)&&"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>w(t,q(r,n,i,e))));if(c(t)&&"esriGeometryMultipoint"===r&&"esriSpatialRelContains"===e)return Promise.resolve((e=>j(t,q(r,n,i,e))));if(c(t)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?d:h(e)}(r);return Promise.resolve((s=>e(t,q(r,n,i,s))))}return import("./geometryEngineJSON.js").then((e=>e.g)).then((s=>{const o=s[$[e]].bind(null,t.spatialReference,t);return e=>o(q(r,n,i,e))}))}async function ee(e,t,r){const{spatialRel:n,geometry:i}=e;if(i){if(null==(s=n)||!0!==H[s])throw new g(K,"Unsupported query spatial relationship",{query:e});var s;if(o(i.spatialReference)&&o(r)){if(!function(e){return null!=e&&!0===L[p(e)]}(i))throw new g(K,"Unsupported query geometry type",{query:e});if(!function(e){return null!=e&&!0===Q[e]}(t))throw new g(K,"Unsupported layer geometry type",{query:e});if(e.outSR)return R(e.geometry?.spatialReference,e.outSR)}}}function te(e){if(c(e))return!0;if(f(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}async function re(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:n,endTimeField:i}=e;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(n&&i)await t.forEach((e=>{const t=r.getAttribute(e,n),l=r.getAttribute(e,i);null==t||isNaN(t)||(s=Math.min(s,t)),null==l||isNaN(l)||(o=Math.max(o,l))}));else{const e=n||i;await t.forEach((t=>{const n=r.getAttribute(t,e);null==n||isNaN(n)||(s=Math.min(s,n),o=Math.max(o,n))}))}return{start:s,end:o}}function ne(e,t,r){if(!t||!e)return null;const{startTimeField:n,endTimeField:i}=e;if(!n&&!i)return null;const{start:s,end:o}=t;if(null===s&&null===o)return null;if(void 0===s&&void 0===o)return()=>!1;const l=r.getAttributeAsTimestamp?.bind(r)??r.getAttribute.bind(r);return n&&i?function(e,t,r,n,i){return null!=n&&null!=i?s=>{const o=e(s,t),l=e(s,r);return(null==o||o<=i)&&(null==l||l>=n)}:null!=n?t=>{const i=e(t,r);return null==i||i>=n}:null!=i?r=>{const n=e(r,t);return null==n||n<=i}:void 0}(l,n,i,s,o):function(e,t,r,n){return null!=r&&null!=n&&r===n?n=>e(n,t)===r:null!=r&&null!=n?i=>{const s=e(i,t);return null!=s&&s>=r&&s<=n}:null!=r?n=>{const i=e(n,t);return null!=i&&i>=r}:null!=n?r=>{const i=e(r,t);return null!=i&&i<=n}:void 0}(l,n||i,s,o)}export{q as a,ee as b,C as c,re as d,B as e,X as f,ne as g,te as h,V as n,k as q,T as t};
