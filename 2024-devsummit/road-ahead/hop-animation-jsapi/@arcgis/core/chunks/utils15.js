/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{u as e}from"../core/lang.js";import{f as n}from"./messages.js";import{substitute as t}from"../intl.js";import{numericTypes as i}from"../layers/support/fieldUtils.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import o from"../popup/content/FieldsContent.js";import"../popup/content/MediaContent.js";import"../popup/content/RelationshipContent.js";import s from"../popup/content/TextContent.js";import a from"../popup/ExpressionInfo.js";import r from"../popup/FieldInfo.js";import{getAttributes as p}from"../renderers/support/utils.js";import{viewScaleRE as l}from"./visualVariableUtils.js";import{g as m}from"./utils13.js";let u=0;const f="expression/";function d(e){return"hasVisualVariables"in e&&e.hasVisualVariables()?e.visualVariables.filter((e=>!(l.test(e.valueExpression)||"target"in e&&"outline"===e.target))):[]}function c(e,n){if(!n)return null;const t=m(e);return t?.find((e=>e.name.toLowerCase()===n.toLowerCase()))}function g(e,n,t){let o=null;if(t){const n=e.featureReduction;n&&"popupTemplate"in n&&n.popupTemplate&&(o=n.popupTemplate.fieldInfos)}else"popupTemplate"in e&&e.popupTemplate&&(o=e.popupTemplate.fieldInfos);const s=t?c(e,n):e.getField(n);let a=null;if(o&&o.some((e=>!(!e||e.fieldName.toLowerCase()!==s?.name.toLowerCase()||(a=e.clone(),0)))),!a){const e=i.includes(s.type),n="integer"===s.type||"small-integer"===s.type;a=new r({fieldName:s.name,isEditable:s.editable,visible:!0,format:e?{places:n?0:2,digitSeparator:!0}:null})}return a.label||(a.label=s.alias),a}function x(e){const{expression:n,title:t,returnType:i}=e;return new a({name:"expr"+u++,expression:n,title:t,returnType:i})}function b(e){const n="number"===e.returnType?{places:2,digitSeparator:!0}:null;return new r({fieldName:`${f}${e.name}`,visible:!0,format:n})}async function j(i){const o=await n("esri/smartMapping/t9n/smartMapping"),{renderer:s,layer:a,normFieldExpressionTemplate:r,isFeatureReduction:l}=i,m=[],u=[],f=p(s,d);for(const e of f)if("field"===e.type)m.push(g(a,e.field,l));else if("normalized-field"===e.type){const n=l?c(a,e.field):a.getField(e.field),i=l?c(a,e.normalizationField):a.getField(e.normalizationField),s=x({type:"expression",expression:`\n      $feature["${n.name}"];\n      $feature["${i.name}"];\n      ${"percentage"===r?`($feature["${n.name}"] / $feature["${i.name}"]) * 100;`:`$feature["${n.name}"] / $feature["${i.name}"];`}\n      `,title:t("percentage"===r?o.normFieldLabelAsPercent:o.normFieldLabel,{expression1:n.alias,expression2:i.alias}),returnType:"number"});m.push(b(s),g(a,e.field,l),g(a,e.normalizationField,l)),u.push(s)}else if("expression"===e.type){const n=x(e);m.push(b(n)),u.push(n)}return{fieldInfos:e(m,((e,n)=>e.fieldName===n.fieldName)),expressionInfos:e(u,((e,n)=>e.expression===n.expression))}}async function F(e,i,a){const{fieldInfos:r,expressionInfos:p}=i,l=await n("esri/smartMapping/t9n/smartMapping");if(r.length>2)return[new o({fieldInfos:r})];const m=[];for(const n of r){const i=n.fieldName;let o=n.label;if(!o){const n=a?c(e,i):e.getField(i);if(n)o=n.alias||i;else if(p){const e=i.split(f)[1],n=p[p.findIndex((n=>n.name===e))];n&&(o=n.title||n.name)}}m.push(new s({text:t(l.fieldInfo,{fieldLabel:o,fieldValue:`{${i}}`})}))}return m}function $(e){return!(!("normalizationField"in e)||!e.normalizationField)||"hasVisualVariables"in e&&e.hasVisualVariables()&&e.visualVariables.some((e=>!(!("normalizationField"in e)||!e.normalizationField)))}export{j as a,F as b,g as c,f as e,d as g,$ as h};
