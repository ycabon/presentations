/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{u as t}from"./originUtils.js";import a from"../portal/Portal.js";import r from"../portal/PortalItem.js";import{c as o}from"./jsonContext.js";import{b as i,t as n}from"./portalItemUtils.js";import{v as s}from"./saveAPIKeyUtils.js";import{e as l}from"./saveUtils.js";async function m(t){const{layer:a,errorNamePrefix:r,validateLayer:o}=t;await a.load(),function(t,a,r){const o=r(t);if(!o.isValid)throw new e(`${a}:invalid-parameters`,o.errorMessage,{layer:t})}(a,r,o)}function c(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function p(t){const{item:a,errorNamePrefix:r,layer:o,validateItem:i}=t;if(s(a),function(t){const{item:a,itemType:r,additionalItemType:o,errorNamePrefix:i,layer:n}=t,s=[r];if(o&&s.push(o),!s.includes(a.type)){const t=s.map((e=>`'${e}'`)).join(", ");throw new e(`${i}:portal-item-wrong-type`,`Portal item type should be one of: "${t}"`,{item:a,layer:n})}}(t),i){const t=i(a);if(!t.isValid)throw new e(`${r}:invalid-parameters`,t.errorMessage,{layer:o})}}function f(e){return o(e,"portal-item")}async function y(e,t,a){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),l(t,{errorName:"layer-write:unsupported"},a),r}function d(e){i(e,n.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}async function u(a,r){const{layer:o,createItemData:i,createJSONContext:n,saveResources:s}=a;await m(a),function(t){const{layer:a,errorNamePrefix:r}=t,{portalItem:o}=a;if(!o)throw new e(`${r}:portal-item-not-set`,c(a,"requires the portalItem property to be set"));if(!o.loaded)throw new e(`${r}:portal-item-not-loaded`,c(a,"cannot be saved to a portal item that does not exist or is inaccessible"));p({...t,item:o})}(a);const l=o.portalItem,u=n?n(l):f(l),w=await y(o,u,r),I=await i({layer:o,layerJSON:w},l);return d(l),await l.update({data:I}),t(u),await(s?.(l,u)),l}async function w(e,o){const{layer:i,createItemData:n,createJSONContext:s,setItemProperties:l,saveResources:c}=e;await m(e);const u=function(e){const{newItem:t,itemType:o}=e;let i=r.from(t);return i.id&&(i=i.clone(),i.id=null),i.type??=o,i.portal??=a.getDefault(),p({...e,item:i}),i}(e),w=s?s(u):f(u),I=await y(i,w,o),v=await n({layer:i,layerJSON:I},u);return await l(i,u),d(u),await async function(e,t,a){const r=e.portal;await r.signIn(),await(r.user?.addItem({item:e,data:t,folder:a?.folder}))}(u,v,o),i.portalItem=u,t(w),await(c?.(u,w)),u}export{w as a,u as s};
