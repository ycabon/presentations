/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{a as t}from"./MultiOriginJSONSupport.js";import{whenOnce as r}from"../core/reactiveUtils.js";import{hasSameCanonicalPortal as o,urlToObject as a}from"../core/urlUtils.js";import{u as i}from"./originUtils.js";import s from"../geometry/SpatialReference.js";import{f as n}from"./unitUtils.js";import{webMercatorToGeographic as p}from"../geometry/support/webMercatorUtils.js";import{c as l}from"./arcgisLayerUrl.js";import{l as m,i as c}from"./layerUtils2.js";import u from"../portal/Portal.js";import d from"../portal/PortalItem.js";import{c as f}from"./jsonContext.js";import{r as j,t as y,b as w,h as g}from"./portalItemUtils.js";import{p as h}from"./project.js";import b from"../rest/support/ProjectParameters.js";import{f as v,h as _,i as P}from"./basemapUtils.js";import{s as U}from"./resourceUtils2.js";import{v as R}from"./saveAPIKeyUtils.js";import{b as S,e as A}from"./saveUtils.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"./maybe.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"./ensureType.js";import"../core/accessorSupport/decorators/property.js";import"./ObservableBase.js";import"../core/scheduling.js";import"../core/promiseUtils.js";import"../core/JSONSupport.js";import"./asyncUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"./multiOriginJSONSupportUtils.js";import"./writer.js";import"./jsonMap.js";import"./assets.js";import"../request.js";import"../kernel.js";import"./persistableUrlUtils.js";import"../core/Loadable.js";import"../core/Promise.js";import"./reader.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"./locale.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../geometry/projection.js";import"./vec3f64.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./coordsUtils.js";import"./Axis.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"../geometry/Polyline.js";import"./projectBuffer.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"../geometry/support/jsonUtils.js";import"./utils7.js";import"./utils8.js";import"../Basemap.js";import"./collectionUtils.js";import"./loadAll.js";import"./messages.js";import"../support/BasemapStyle.js";import"./writeUtils.js";import"./utils3.js";import"./colorUtils.js";import"./screenUtils.js";import"./mat4.js";import"./uuid.js";import"./resourceUtils.js";const O=["NatGeo_World_Map","Ocean_Basemap","USA_Topo_Maps","World_Imagery","World_Street_Map","World_Terrain_Base","World_Topo_Map","World_Hillshade","Canvas/World_Light_Gray_Base","Canvas/World_Light_Gray_Reference","Canvas/World_Dark_Gray_Base","Canvas/World_Dark_Gray_Reference","Ocean/World_Ocean_Base","Ocean/World_Ocean_Reference","Reference/World_Boundaries_and_Places","Reference/World_Reference_Overlay","Reference/World_Transportation"].map((e=>e.toLowerCase()));async function W(t,o,a){a??={},function(t,r){if(!r.portalItem)throw new e(`${t.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");R(r.portalItem),T(t,r.portalItem)}(t,o),await r((()=>!o.updatingFromView)),await o.load(),await G(o),await S(o),await M(t,o);const i=o.portalItem,s=f(i,"web-map",!0),n=o.write({},s);return await Promise.all(s.resources.pendingOperations),A(s,{errorName:`${t.name}:save`},a),await C(o,i),await async function(e,t,r,o,a){await r.update({data:o}),Q(e,t,r,o,a)}(t,o,i,n,s),await Promise.all([o.updateItemThumbnail(),U(o.resourceReferences,s)]),i}async function I(t,a,i,s){s??={};const n=function(e,t){let r=d.from(t);return r.id&&(r=r.clone(),r.id=null),r.type||(r.type=e.itemType),r.portal||(r.portal=u.getDefault()),R(r),T(e,r),r}(t,i);await r((()=>!a.updatingFromView)),await a.load(),function(t,r){const o=r.allLayers.filter((e=>"unsupported"===e.type&&"KnowledgeGraphLayer"===e.resourceInfo?.layerType));if(o.length)throw new e(`${t.name}:save-as-invalid-configuration`,`Failed to save a copy of ${t.name} to prevent persisting invalid configuration. See 'details.layers'`,{layers:o.toArray()})}(t,a),await G(a),await S(a),await M(t,a);const p=f(n,"web-map",!0),l=a.write({},p);await Promise.all(p.resources.pendingOperations),A(p,{errorName:`${t.name}:save`},s),await async function(e,t){j(t,L),j(t,K),j(t,y.METADATA),j(t,V),j(t,F),j(t,N),j(t,$),j(t,x),await C(e,t)}(a,n);const m=a.getThumbnailState(),c=await async function(t,r,a,i,s,n){const p=r.portalItem,l={item:p,authenticated:!(!p?.id||!p.portal.user)},m=a.portal;await m.signIn();const{copyAllowed:c,itemReloaded:u}=await async function(e,t){const{item:r,authenticated:o}=e;return r?.id&&r.typeKeywords?.includes("useOnly")?r.portal.portalHostname!==t.portalHostname?{copyAllowed:!1,itemReloaded:!1}:(o||await r.reload(),{copyAllowed:"admin"===r.itemControl||"update"===r.itemControl,itemReloaded:!0}):{copyAllowed:!0,itemReloaded:!1}}(l,m);if(l.authenticated||=u,!c)throw new e(`${t.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");const d=await async function(e,t,r,a){const i=e.portal,{item:s}=t,{folder:n,copyAllResources:p}=a;let l=!1;if(p&&s?.id&&o(s.portal.url,i.url)&&parseInt(s.portal.currentVersion,10)>=2023){const{total:e}=await s.fetchResources();l=!!e}if(l){const t=await s.copy({copyResources:"all",folder:n});e.id=t.id,e.portal=t.portal;const o=e.toJSON();await e.load(),e.read(o),await e.update({data:r})}else await(i.user?.addItem({item:e,folder:n,data:r}));return l}(a,l,i,n);return r.portalItem=a,Q(t,r,a,i,s),d}(t,a,n,l,p,s);return c&&(a.resourceReferences.portalItem=n),a.restoreThumbnailFromState(m),await Promise.all([a.updateItemThumbnail(),U(a.resourceReferences,p)]),n}function T(t,r){if(r.type!==t.itemType)throw new e(`${t.name}:portal-item-wrong-type`,`Portal item needs to have type "${t.itemType}"`)}async function M(t,o){if(!o.basemap?.baseLayers.length)throw new e(`${t.name}:save`,"Map does not have a valid basemap with a base layer.");let a=null;if(await r((()=>{const e=v(o.initialViewProperties,o.basemap);return a=e.spatialReference,!e.updating})),!n(a,o.initialViewProperties.spatialReference))throw new e(`${t.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",{expected:o.initialViewProperties.spatialReference,actual:a})}function G(e){const t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then((()=>{}))}async function C(e,t){t.extent=await async function(e,t){const r=t.clone().normalize();let o;if(r.length>1)for(const e of r)o?e.width>o.width&&(o=e):o=e;else o=r[0];return async function(e,t){const r=t.spatialReference;if(r.isWGS84)return t.clone();if(r.isWebMercator)return p(t);const{getGeometryServiceURL:o}=await import("./geometryServiceUtils.js"),a=await o(e),i=new b;return i.geometries=[t],i.outSpatialReference=s.WGS84,(await h(a,i))[0]}(e,o)}(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await async function(e,t){w(t,E),await function(e){const t=z(e).map((e=>e.load())).toArray();return Promise.allSettled(t).then((()=>{}))}(e),function(e,t){g(t,L)||g(t,$)||g(t,x)||g(t,N)||!q(e)?j(t,B):w(t,B)}(e,t),function(e,t){q(e)?w(t,D):j(t,D)}(e,t),function(e,t){!g(t,V)&&function(e){return z(e).filter((e=>"group"!==e.type)).every((t=>t.loaded&&function(e,t){return m(t)&&t.capabilities.operations.supportsSync||function(e){return c(e)||"map-notes"===e.type||"route"===e.type}(t)&&!t.portalItem||("tile"===t.type||"vector-tile"===t.type)&&(t.capabilities.operations.supportsExportTiles||function(e){return"tile"===e.type&&l(e.url)&&O.some((t=>e.url?.toLowerCase().includes("/"+t+"/")))}(t)||P(t))&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}(e,t)))}(e)?w(t,k):j(t,k)}(e,t),function(e,t){_(e.basemap)?w(t,J):j(t,J)}(e,t),function(e,t){e.utilityNetworks?.length?w(t,H):j(t,H)}(e,t),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}(e,t)}const E=y.JSAPI,L="CollectorDisabled",B="Collector",D="Data Editing",V="OfflineDisabled",k="Offline",$="Workforce Project",x="Workforce Worker",N="Workforce Dispatcher",F="Offline Map Areas",K="FieldMapsDisabled",J=y.DEVELOPER_BASEMAP,H="UtilityNetwork";function z(e){return e.allLayers.concat(e.allTables)}function q(e){return z(e).some((e=>e.loaded&&m(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&("subtype-group"!==e.type||e.sublayers.some((e=>e.editingEnabled)))))}function Q(e,r,o,s,n){t.prototype.read.call(r,{version:s.version,authoringApp:s.authoringApp,authoringAppVersion:s.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:o.itemUrl?a(o.itemUrl):void 0}),i(n),r.resourceInfo=s}export{W as save,I as saveAs};
