/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{P as t,f as e,E as s}from"./lang.js";import{createResolver as i,isAborted as n,createAbortError as a}from"./promiseUtils.js";import"../chunks/handleUtils.js";import"./Error.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/maybe.js";const h=[];function r(t){h.push(t),1===h.length&&queueMicrotask((()=>{const t=h.slice();h.length=0;for(const e of t)e()}))}class l{constructor(t,e=30){this.name=t,this._counter=0,this._samples=new Array(e)}record(t){null!=t&&(this._samples[++this._counter%this._samples.length]=t)}get median(){return this._samples.slice().sort(((t,e)=>t-e))[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce(((t,e)=>t+e),0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}}var o;!function(t){const e=(t,e,s,i)=>{let n=e,a=e;const h=s>>>1,r=t[n-1];for(;a<=h;){a=n<<1,a<s&&i(t[a-1],t[a])<0&&++a;const e=t[a-1];if(i(e,r)<=0)break;t[n-1]=e,n=a}t[n-1]=r},s=(t,e)=>t<e?-1:t>e?1:0;t.sort=function(t,i,n,a){void 0===i&&(i=0),void 0===n&&(n=t.length),void 0===a&&(a=s);for(let s=n>>>1;s>i;s--)e(t,s,n,a);const h=i+1;for(let s=n-1;s>i;s--){const n=t[i];t[i]=t[s],t[s]=n,e(t,h,s,a)}},t.iterableSort=function*(t,i,n,a){void 0===i&&(i=0),void 0===n&&(n=t.length),void 0===a&&(a=s);for(let s=n>>>1;s>i;s--)e(t,s,n,a),yield;const h=i+1;for(let s=n-1;s>i;s--){const n=t[i];t[i]=t[s],t[s]=n,e(t,h,s,a),yield}}}(o||(o={}));const c=o;class d{constructor(e){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new t,e&&(e.initialSize&&(this.data=new Array(e.initialSize)),e.allocator&&(this._allocator=e.allocator),void 0!==e.deallocator&&(this._deallocator=e.deallocator),e.shrink&&(this._shrink=()=>u(this)))}toArray(){return this.data.slice(0,this.length)}filter(t){const e=new Array;for(let s=0;s<this._length;s++){const i=this.data[s];t(i)&&e.push(i)}return e}at(t){if((t=Math.trunc(t)||0)<0&&(t+=this._length),!(t<0||t>=this._length))return this.data[t]}includes(t,e){const s=this.data.indexOf(t,e);return-1!==s&&s<this.length}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let e=t;e<this._length;++e)this.data[e]=this._deallocator(this.data[e]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,e=t.length){for(let s=0;s<e;s++)this.data[this._length++]=t[s]}fill(t,e){for(let s=0;s<e;s++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}unshift(t){this.data.unshift(t),this._length++,u(this)}pop(){if(0===this.length)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}remove(t){const s=e(this.data,t,this.length,this._hint);if(-1!==s)return this.data.splice(s,1),this.length=this.length-1,t}removeUnordered(t){return this.removeUnorderedIndex(e(this.data,t,this.length,this._hint))}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,e=t.length,i){this.length=s(this.data,t,this.length,e,this._hint,i),this._shrink()}front(){if(0!==this.length)return this.data[0]}back(){if(0!==this.length)return this.data[this.length-1]}swapElements(t,e){if(t>=this.length||e>=this.length||t===e)return;const s=this.data[t];this.data[t]=this.data[e],this.data[e]=s}sort(t){c.sort(this.data,0,this.length,t)}iterableSort(t){return c.iterableSort(this.data,0,this.length,t)}some(t,e){for(let s=0;s<this.length;++s)if(t.call(e,this.data[s],s,this.data))return!0;return!1}find(t,e){for(let s=0;s<this.length;++s){const i=this.data[s];if(t.call(e,i,s))return i}}filterInPlace(t,e){let s=0;for(let i=0;i<this._length;++i){const n=this.data[i];t.call(e,n,i,this.data)&&(this.data[i]=this.data[s],this.data[s]=n,s++)}if(this._deallocator)for(let t=s;t<this._length;t++)this.data[t]=this._deallocator(this.data[t]);return this._length=s,this._shrink(),this}forAll(t,e){const{data:s,length:i}=this;for(let n=0;n<i;++n)t.call(e,s[n],n,s)}forEach(t,e){this.data.slice(0,this.length).forEach(t,e)}map(t,e){const s=new Array(this.length);for(let i=0;i<this.length;++i)s[i]=t.call(e,this.data[i],i,this.data);return s}reduce(t,e){let s=e;for(let e=0;e<this.length;++e)s=t(s,this.data[e],e,this.data);return s}has(t){const e=this.length,s=this.data;for(let i=0;i<e;++i)if(s[i]===t)return!0;return!1}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this.data[t]}}function u(t){t.data.length>1.5*t.length&&(t.data.length=Math.floor(1.1*t.length))}function f(t){return t}function g(t){return 1e3*t}function m(t){return t}function p(t){return.001*t}class _{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class w{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let v=0,k=0;const A={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},y=["prepare","preRender","render","postRender","update","finish"],F=[],b=new d;class M{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const j={frameTasks:b,willDispatch:!1,clearFrameTasks:function(t=!1){b.forAll((t=>{t.removed=!0})),t&&q()},dispatch:P,executeFrameTasks:function(t){const e=t-v;v=t;const s=k>0?k:1e3/60,i=Math.max(0,e-s);A.time=t,A.frameDuration=s-i;for(let s=0;s<y.length;s++){const i=performance.now(),n=y[s];b.forAll((i=>{i.paused||i.removed||(0===s&&i.ticks++,i.phases[n]&&(A.elapsedFrameTime=performance.now()-t,A.deltaTime=0===i.ticks?0:e,i.phases[n]?.call(i,A)))})),N[s].record(performance.now()-i)}q(),O.record(performance.now()-t)},reschedule:function(){null!=S&&(cancelAnimationFrame(S),S=requestAnimationFrame(D))}};function x(t){const e=new w(t);return F.push(e),j.willDispatch||(j.willDispatch=!0,r(P)),e}function T(t){const e=new _(t);return b.push(e),null==S&&(v=performance.now(),S=requestAnimationFrame(D)),new M(e)}let S=null;function U(t){k=Math.max(0,t)}function D(){const t=performance.now();S=null,S=b.length>0?requestAnimationFrame(D):null,j.executeFrameTasks(t)}const E=new d;function q(){b.forAll((t=>{t.removed&&E.push(t)})),b.removeUnorderedMany(E.data,E.length),E.clear()}function P(){for(;F.length;){const t=F.shift();t.isActive&&t.callback()}j.willDispatch=!1}function I(t=1,e){const s=i(),h=()=>{n(e)?s.reject(a()):0===t?s():(--t,r((()=>h())))};return h(),s.promise}function R(t){return I(1,t)}function z(){const t=i(),e=T({postRender:()=>{e.remove(),x(t)}});return t.promise}async function L(){await R(),await new Promise((t=>requestAnimationFrame(t)))}const N=y.map((t=>new l(t))),O=new l("total");export{M as FrameTaskHandle,f as M,d as P,m as S,l as a,T as addFrameTask,j as debug,g as m,r as n,N as performanceInfo,O as performanceTotal,p as s,x as schedule,U as setFrameDuration,L as waitAnimationFrame,z as waitRender,R as waitTick,I as waitTicks};
