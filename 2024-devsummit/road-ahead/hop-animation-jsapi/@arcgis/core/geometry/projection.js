/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import n from"../core/Error.js";import{throwIfAborted as e,waitTick as r}from"../core/promiseUtils.js";import{t}from"../chunks/tracking.js";import{S as o}from"../chunks/SimpleObservable.js";import{c as s}from"../chunks/vec3f64.js";import{G as i,a8 as l,a9 as u,f as a,k as c,v as p,E as f}from"../chunks/unitUtils.js";import m from"./Extent.js";import h from"./Multipoint.js";import j from"./Point.js";import d from"./Polygon.js";import g from"./Polyline.js";import y from"./SpatialReference.js";import{p as R,a as k,b as x,g as w}from"../chunks/projectBuffer.js";import M from"./support/GeographicTransformation.js";import{g as S}from"../chunks/zscale.js";import"../core/lang.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/handleUtils.js";import"../chunks/maybe.js";import"../chunks/utils.js";import"../chunks/ObservableBase.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/JSONSupport.js";import"../chunks/tslib.es6.js";import"../core/Accessor.js";import"../core/Handles.js";import"../core/accessorSupport/decorators/subclass.js";import"../chunks/metadata.js";import"../chunks/ensureType.js";import"../core/accessorSupport/decorators/property.js";import"../core/scheduling.js";import"./Geometry.js";import"../chunks/reader.js";import"../chunks/writer.js";import"./support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../chunks/geodesicConstants.js";import"./support/GeographicTransformationStep.js";function b(n,e,r,t,o,s){return v[0]=n,v[1]=e,v[2]=r,R(v,t,0,o,s,0,1)}const v=s();let z=null,P=null,L=null,Z={};const G=new o;function T(){return!!z&&f()}function A(){return!!T()||(t(G),U(),!1)}function E(n,e){return!n||!e||I(n,e)||A()}function O(n,e){return!I(n,e)&&!T()}function U(n){return null==L&&(L=Promise.all([i(),import("../chunks/geometryEngineBase.js").then((n=>n.g)),import("../chunks/hydrated.js")])),L.then((([,r,{hydratedAdapter:t}])=>{e(n),P=t,z=r.default,z._enableProjection(l),G.notify()}))}function _(n,e,r=null,t=null){return Array.isArray(n)?0===n.length?[]:W(P,n,n[0].spatialReference,e,r,t):W(P,[n],n.spatialReference,e,r,t)[0]}function W(n,e,r,t,o=null,s=null){if(null==r||null==t)return e;if(I(r,t,o))return e.map((n=>V(n,r,t)));if(null==o&&u(r))return e.map((n=>V(n,r,y.WGS84))).map((n=>N(n,t)));if(null==o&&u(t))return e.map((n=>N(n,y.WGS84))).map((n=>V(n,y.WGS84,t)));if(null==o){const n=M.cacheKey(r,t);void 0!==Z[n]?o=Z[n]:(null==(o=q(r,t,void 0))&&(o=new M),Z[n]=o)}if(null==z||null==n)throw new H;return null!=s?z._project(n,e,r,t,o,s):z._project(n,e,r,t,o)}function B(n,e){const r=C([n],e);return null!=r.pending?{pending:r.pending,geometry:null}:null!=r.geometries?{pending:null,geometry:r.geometries[0]}:{pending:null,geometry:null}}function C(n,e){if(!T())for(const r of n)if(null!=r&&!a(r.spatialReference,e)&&c(r.spatialReference)&&c(e)&&!I(r.spatialReference,e))return t(G),{pending:U(),geometries:null};return{pending:null,geometries:n.map((n=>null==n?null:a(n.spatialReference,e)?n:c(n.spatialReference)&&c(e)?N(n,e):null))}}function q(n,e,r=null){if(null==n||null==e)return null;if(null==z||null==P)throw new H;const t=z._getTransformation(P,n,e,r,r?.spatialReference);return null!==t?M.fromGE(t):null}function F(n,e,r=null){if(null==z||null==P)throw new H;const t=z._getTransformationBySuitability(P,n,e,r,r?.spatialReference);if(null!==t){const n=[];for(const e of t)n.push(M.fromGE(e));return n}return[]}class H extends n{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}function J(){z=null,P=null,L=null,Z={}}const K={get loadPromise(){return L}};function N(n,e){try{const r=_(n,e);if(null==r)return null;"xmin"in n&&"xmin"in r&&(r.zmin=n.zmin,r.zmax=n.zmax);const t=S(r.type,n.spatialReference,e);return null!=t&&t(r),r}catch(n){if(!(n instanceof H))throw n;return null}}async function D(n,e,r){const t=n.spatialReference;return null!=t&&null!=e&&await Q(t,e,null,r),N(n,e)}function I(n,e,r){return!r&&(!!a(n,e)||c(n)&&c(e)&&!!k(n,e,x))}async function Q(n,e,t,o){if(T())return r(o);if(Array.isArray(n)){for(const{source:e,dest:r,geographicTransformation:t}of n)if(e&&r&&!I(e,r,t))return U(o)}else if(n&&e&&!I(n,e,t))return U(o);return r(o)}function V(n,e,r){return n?"x"in n?Y(n,e,new j,r,0):"xmin"in n?ln(n,e,new m,r,0):"rings"in n?on(n,e,new d,r,0):"paths"in n?rn(n,e,new g,r,0):"points"in n?nn(n,e,new h,r,0):null:null}function X(n,e,r=e.spatialReference,t=0){return null!=r&&null!=n.spatialReference&&null!=Y(n,n.spatialReference,e,r,t)}function Y(n,e,r,t,o){cn[0]=n.x,cn[1]=n.y;const s=n.z;return cn[2]=void 0!==s?s:o,R(cn,e,0,cn,t,0,1)?(r.x=cn[0],r.y=cn[1],r.spatialReference=t,void 0!==s||p(t)?(r.z=cn[2],r.hasZ=!0):(r.z=void 0,r.hasZ=!1),void 0===n.m?(r.m=void 0,r.hasM=!1):(r.m=n.m,r.hasM=!0),r):null}function $(n,e,r=e.spatialReference,t=0){return null!=n.spatialReference&&null!=r&&null!=nn(n,n.spatialReference,e,r,t)}function nn(n,e,r,t,o){const{points:s,hasZ:i,hasM:l}=n,u=[],a=s.length,c=[];for(const n of s)c.push(n[0],n[1],i?n[2]:o);if(!R(c,e,0,c,t,0,a))return null;const f=i||p(t);for(let n=0;n<a;++n){const e=3*n,r=c[e],t=c[e+1];f&&l?u.push([r,t,c[e+2],s[n][3]]):f?u.push([r,t,c[e+2]]):l?u.push([r,t,s[n][2]]):u.push([r,t])}return r.points=u,r.spatialReference=t,r.hasZ=i,r.hasM=l,r}function en(n,e,r=e.spatialReference,t=0){return null!=n.spatialReference&&null!=r&&null!=rn(n,n.spatialReference,e,r,t)}function rn(n,e,r,t,o){const{paths:s,hasZ:i,hasM:l}=n,u=[];if(!un(s,i??!1,l??!1,e,u,t,o))return null;const a=i||p(t);return r.paths=u,r.spatialReference=t,r.hasZ=a,r.hasM=l,r}function tn(n,e,r=e.spatialReference,t=0){return null!=n.spatialReference&&null!=r&&null!=on(n,n.spatialReference,e,r,t)}function on(n,e,r,t,o){const{rings:s,hasZ:i,hasM:l}=n,u=[];if(!un(s,i??!1,l??!1,e,u,t,o))return null;const a=i||p(t);return r.rings=u,r.spatialReference=t,r.hasZ=a,r.hasM=l,r}function sn(n,e,r=e.spatialReference,t=0){return null!=n.spatialReference&&null!=r&&null!=ln(n,n.spatialReference,e,r,t)}function ln(n,e,r,t,o){const{xmin:s,ymin:i,xmax:l,ymax:u,hasZ:a,hasM:c}=n;if(!b(s,i,a?n.zmin:o,e,cn,t))return null;const f=a||p(t);return r.xmin=cn[0],r.ymin=cn[1],f&&(r.zmin=cn[2]),b(l,u,a?n.zmax:o,e,cn,t)?(r.xmax=cn[0],r.ymax=cn[1],f&&(r.zmax=cn[2]),c&&(r.mmin=n.mmin,r.mmax=n.mmax),r.spatialReference=t,r):null}function un(n,e,r,t,o,s,i=0){const l=new Array;for(const r of n)for(const n of r)l.push(n[0],n[1],e?n[2]:i);if(!R(l,t,0,l,s,0,l.length/3))return!1;let u=0;o.length=0;const a=e||p(s);for(const e of n){const n=new Array;for(const t of e)a&&r?n.push([l[u++],l[u++],l[u++],t[3]]):a?n.push([l[u++],l[u++],l[u++]]):r?(n.push([l[u++],l[u++],t[2]]),u++):(n.push([l[u++],l[u++]]),u++);o.push(n)}return!0}function an(n){return null!=n&&null!=w(n)}const cn=s(),pn=Object.freeze(Object.defineProperty({__proto__:null,canProjectToWGS84ComparableLonLat:an,canProjectWithoutEngine:I,getTransformation:q,getTransformations:F,initializeProjection:Q,isLoaded:T,isLoadedOrLoad:A,isLoadedOrLoadFor:E,load:U,project:_,projectExtent:sn,projectMany:W,projectMultipoint:$,projectOrLoad:B,projectOrLoadMany:C,projectPoint:X,projectPolygon:tn,projectPolyline:en,projectWithZConversion:D,projectWithoutEngine:V,requiresLoad:O,test:K,tryProjectWithZConversion:N,unload:J},Symbol.toStringTag,{value:"Module"}));export{pn as a,an as canProjectToWGS84ComparableLonLat,I as canProjectWithoutEngine,q as getTransformation,F as getTransformations,Q as initializeProjection,T as isLoaded,A as isLoadedOrLoad,E as isLoadedOrLoadFor,U as load,b as p,_ as project,sn as projectExtent,W as projectMany,$ as projectMultipoint,B as projectOrLoad,C as projectOrLoadMany,X as projectPoint,tn as projectPolygon,en as projectPolyline,D as projectWithZConversion,V as projectWithoutEngine,O as requiresLoad,K as test,N as tryProjectWithZConversion,J as unload};
