/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Error.js";import{M as s}from"../chunks/MultiOriginJSONSupport.js";import{watch as i}from"../core/reactiveUtils.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{L as n}from"../chunks/Logger.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import a from"./Layer.js";import{BlendLayer as l}from"./mixins/BlendLayer.js";import{CustomParametersMixin as p}from"./mixins/CustomParametersMixin.js";import{B as m,ImageryTileMixin as u}from"./mixins/ImageryTileMixin.js";import{OperationalLayer as c}from"./mixins/OperationalLayer.js";import{PortalLayer as d}from"./mixins/PortalLayer.js";import{RefreshableLayer as h}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as f}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as g}from"./mixins/TemporalLayer.js";import{p as y}from"../chunks/commonProperties2.js";import b from"./support/Field.js";import"../geometry.js";import{isAbortError as j}from"../core/promiseUtils.js";import{i as v}from"../chunks/crsUtils.js";import x from"./support/DimensionalDefinition.js";import w from"../geometry/Extent.js";import{g as S,a as C,b as I,c as k,d as D,i as L,e as T}from"../chunks/xmlUtilities.js";import R from"../geometry/Polygon.js";import P from"./support/RasterInfo.js";import{g as M}from"../chunks/RasterSymbolizer.js";import{i as U}from"../chunks/vectorFieldUtils.js";import{createPopupTemplate as V}from"../support/popupUtils.js";import"../config.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/maybe.js";import"../chunks/metadata.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/ObservableBase.js";import"../chunks/tracking.js";import"../core/scheduling.js";import"../core/JSONSupport.js";import"../chunks/ensureType.js";import"../chunks/asyncUtils.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../chunks/assets.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/vec3f64.js";import"../chunks/common.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/utils3.js";import"../chunks/screenUtils.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../rasterRenderers.js";import"../renderers/ClassBreaksRenderer.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../chunks/enumeration.js";import"./support/fieldUtils.js";import"../core/sql.js";import"../intl.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../chunks/messages.js";import"../symbols/Symbol.js";import"../Color.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../symbols/support/jsonUtils.js";import"../chunks/layerUtils2.js";import"../renderers/FlowRenderer.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/support/ColormapInfo.js";import"../chunks/colorRampUtils.js";import"../chunks/colorUtils2.js";import"../chunks/vec4.js";import"../chunks/vec4f64.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../chunks/stretchRendererUtils.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../renderers/VectorFieldRenderer.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils7.js";import"../chunks/utils8.js";import"../chunks/utils9.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils6.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"./support/PixelBlock.js";import"../chunks/pixelRangeUtils.js";import"../chunks/arcgisLayerUrl.js";import"./support/MultidimensionalSubset.js";import"./support/RasterFunction.js";import"../chunks/RasterJobHandler.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"./support/TileInfo.js";import"./support/LOD.js";import"../chunks/TileKey.js";import"../chunks/multidimensionalUtils.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import"../geometry/projection.js";import"../chunks/projectBuffer.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/QueueProcessor.js";import"../chunks/ReactiveMap.js";import"../core/signal.js";import"../rest/support/FeatureSet.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/rasterFunctionHelper.js";import"./support/rasterFunctionConstants.js";import"../chunks/stretchUtils.js";import"../chunks/focalStatUtils.js";import"../chunks/rasterRendererHelper.js";import"../chunks/generateRendererUtils.js";import"../rest/support/ImageHistogramParameters.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"./support/MosaicRule.js";import"../chunks/dataUtils.js";import"../chunks/layerContainerType.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"./support/RasterBandInfo.js";import"./support/RasterSensorInfo.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../TimeInterval.js";import"./support/TimeInfo.js";function A(e,t,s=0){const i="--"+t.boundary,o=[];for(let e=0;e<i.length;e++)o.push(i.charCodeAt(e));const n=[],r="\n--"+t.boundary+"--";for(let e=0;e<r.length;e++)n.push(r.charCodeAt(e));const a=[10],l=[13,10],p=[],m=o.length,u=new Uint8Array(e,s),c=Math.min(5e4,u.length-m);let d=0,h=0;for(let e=0;e<c;e++){for(h=0;h<m&&u[e+h]===o[h];h++);h===m&&(d&&p.push(E(u.subarray(d,e),t)),e+=m-1,u[e+1]===a[0]?e+=1:u[e+1]===l[0]&&u[e+2]===l[1]&&(e+=2),d=e+1)}const f=n.length;for(let e=u.length-f-10;e<u.length-f;e++){for(h=0;h<f&&u[e+h]===n[h];h++);if(h===f){p.push(E(u.subarray(d,e),t));break}}return p}function E(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),i=Math.min(s.length,7),o={contentDisposition:"inline"};let n=0;for(let r=0;r<i;r++)if(s[r].length<4)n=n+s[r].length+1;else if("content"===s[r].slice(0,7).toLowerCase()){if(n=n+s[r].length+1,!s[r].includes(":"))continue;const e=s[r].substring(0,s[r].indexOf(":")).trim(),t=s[r].substring(s[r].indexOf(":")+1).trim();switch(e.toLowerCase()){case"content-type":o.contentType=t;break;case"content-description":o.contentDescription=t;break;case"content-transfer-encoding":o.contentTransferEncoding=t;break;case"content-id":o.contentID=t;break;case"content-disposition":o.contentDisposition=t;break;case"content-location":o.contentLocation=t}}else{if(o.contentDisposition.toLowerCase().includes("inline")&&s[r].length>=4&&o.contentType?.toLowerCase().indexOf("image")>-1){let t=!0,s=e.subarray(n,e.length);if(o.contentType.toLowerCase().indexOf("tif")>0){if("base64"===o.contentTransferEncoding){let e="";const t=s;for(let s=0;s<t.length;s+=65535){const i=t.subarray(s,s+65535>t.length-1?t.length-1:s+65535);e+=String.fromCharCode.apply(null,i)}const i=atob(e);s=new Uint8Array(i.length);for(let e=0;e<s.length;e++)s[e]=i.charCodeAt(e)}t=73===s[0]&&73===s[1]||77===s[0]&&77===s[1]}if(t){let t=s.buffer;"base64"!==o.contentTransferEncoding&&(t=new ArrayBuffer(e.length-n),s=new Uint8Array(t),s.set(e.subarray(n,e.length))),o.contentData=t}break}if((""===t.start||o.contentID===t.start)&&o.contentType){if(o.contentType.includes("text")||o.contentType.includes("xml")){o.contentData=String.fromCharCode.apply(null,e.subarray(n,e.length));break}o.contentData=e.subarray(n,e.length)}}return o}function O(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function F(e){const t={};for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1!==i.nodeType)continue;const o=T(i).toLowerCase();switch(o){case"title":case"abstract":t[o]=S(i);break;case"identifier":t.id=S(i);break;case"wgs84boundingbox":{const e=k(i,"LowerCorner"),s=k(i,"UpperCorner");t.lonLatEnvelope=new w({xmin:e[0],ymin:e[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(F(i))}}return t}function $(e,t){if(e.coverageSummaries)for(let s=0;s<e.coverageSummaries.length;s++)e.coverageSummaries[s].abstract=e.coverageSummaries[s].abstract||e.abstract,e.coverageSummaries[s].lonLatEnvelope=e.coverageSummaries[s].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[s].title=e.coverageSummaries[s].title||e.title,$(e.coverageSummaries[s],t);null!=e.id&&t.push(e)}function N(e){const t=C(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",s=C(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",i=C(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:O(t),describeCoverage:O(s),getCoverage:O(i)}}function G(e,t){const s=D(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),i="1.0.0"===t?e.getAttribute("default"):S(e,"InterpolationMethods/Default");return null!=i?[i].concat(s.filter((e=>e.toLowerCase()!==i.toLowerCase()))):s}function B(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.includes("nearest")?"nearest":t.includes("linear")?"bilinear":t.includes("cubic")?"cubic":null})).filter((e=>!!e))}function _(e){const t=I(e,"pos"),s=k(t[0]),i=k(t[1]);return new w({xmin:s[0],ymin:s[1],xmax:i[0],ymax:i[1],spatialReference:{wkid:4326}})}function q(e,t){const s=D(e,t);return s?.length&&""!==s[0]&&!isNaN(Number(s[0]))?s.map((e=>Number(e))):null}function W(e){const t=k(e,"MinimumValue"),s=k(e,"MaximumValue");return t.length&&s.length?t.map(((e,t)=>({min:e,max:s[t],avg:-1,stddev:-1}))):null}function H(e){return null==e?null:e.every((t=>t===e[0]))?e[0]:e}function z(e){const t=[],s=I(e,"RangeSet");let i=[];for(let e=0;e<s.length;e++){const o=S(s[e],"name"),n=S(s[e],"label"),r=[],a=q(s[e],"nullValues/singleValue"),l=I(s[e],"AxisDescription");for(let e=0;e<l.length;e++){const t=S(l[e],"name"),s=S(l[e],"label"),o=D(l[e],"singleValue");if(0===o.length){const t=S(l[e],"min"),s=S(l[e],"max"),i=Number(S(l[e],"res"))||1;if(null!==t&&null!==s)for(let e=parseInt(t,10);e<=parseInt(s,10);e+=i)o.push(e.toString())}"band"===t.toLowerCase()&&(i=o),r.push({name:t,label:s,values:o})}t.push({name:o,label:n,nullValues:a,axis:r})}return{rangeSet:t,bandNames:i}}function Q(e){const t=I(e,"timeposition");if(t.length>0){const e=[];for(let s=0;s<t.length;s++)e.push(new Date(S(t[s])));return{begin:e[0],end:e[e.length-1],values:e}}const s=C(e,"timePeriod")||C(e,"TimePeriod");return s?{begin:new Date(S(s,"beginPosition")||S(s,"BeginPosition")),end:new Date(S(s,"endPosition")||S(s,"EndPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const s=["Years","Months","Days","Hours","Minutes","Seconds"];let i,o,n;return t.includes("PT")?(t=t.slice(2),n=["H","M","S"].findIndex((e=>t.includes(e))),i=s[3+n],o=parseFloat(t.substring(0,t.length-1))):(t=t.slice(1),n=["Y","M","D"].findIndex((e=>t.includes(e))),n>-1&&(i=s[n]),o=parseFloat(t.substring(0,t.length-1))),{resolution:o,units:i}}(S(s,"timeResolution")||S(s,"TimeResolution"))}:null}function Y(e){const t=C(e,"spatialDomain"),s=C(t,"Envelope")||C(t,"EnvelopeWithTimePeriod"),i=s.getAttribute("srsName").split(":"),o=i[i.length-1],n=I(s,"pos"),r=k(n[0]),a=k(n[1]),l=parseInt(o,10),p=isNaN(l)?null:{wkid:l},m=new w({xmin:r[0],ymin:r[1],xmax:a[0],ymax:a[1],spatialReference:p}),u=C(t,"RectifiedGrid"),c=S(u,"low").split(" "),d=S(u,"high").split(" "),h=parseInt(d[0],10)-parseInt(c[0],10)+1,f=parseInt(d[1],10)-parseInt(c[1],10)+1,g=k(t,"origin/pos"),y=I(t,"offsetVector"),b={envelope:m,columns:h,rows:f,offset:{x:parseFloat(S(y[0]).split(" ")[0]),y:parseFloat(S(y[1]).split(" ")[1])},origin:{x:g[0],y:g[1]}},j=C(e,"temporalDomain")||C(e,"TemporalDomain");return{spatialDomain:b,temporalDomain:j?Q(j):null}}function J(e,t){const s=[],i=I(e,"Field");let o,n=[];for(let e=0;e<i.length;e++){const r=S(i[e],"Identifier"),a=S(i[e],"Description"),l=S(i[e],"Definition"),p=S(i[e],"Abstract"),m=S(i[e],"Title"),u=q(i[e],"NullValue"),c=C(i[e],"AllowedValues"),d=c?W(c):null,h=G(i[e],"1.1.0"),f=[],g=I(i[e],"Axis");for(let e=0;e<g.length;e++){const s=g[e].getAttribute("identifier"),i=S(g[e],"UOM"),r=S(g[e],"DataType"),a=D(g[e],"Key");t&&!s.toLowerCase().includes("band")||(n=a,o=u),f.push({identifier:s,uom:i,dataType:r,values:a,bandNoDataValues:o})}s.push({identifier:r,description:a,definition:l,abstract:p,title:m,supportedInterpolations:h,axis:f,nullValues:u,statistics:d})}return{rangeSet:s,bandNames:n,bandNoDataValues:o,statistics:s[0].statistics}}function Z(e){const t=C(e,"SpatialDomain"),s=C(t,"GridCRS"),i=S(s,"GridBaseCRS"),o=S(s,"GridOrigin"),n=o?.split(" ").map((e=>parseFloat(e)))??[0,0],r=k(s,"GridOffsets"),a=I(t,"BoundingBox");let l,p,m,u;for(let e=0;e<a.length;e++){const t=a[e].getAttribute("crs")?.toLowerCase();if(null!=t)if(t.includes("imagecrs")){const t=k(a[e],"LowerCorner"),s=k(a[e],"UpperCorner");l=s[0]-t[0]+1,p=s[1]-t[1]+1}else if(t.indexOf("epsg")>0){const s=t.split(":");m=parseInt(s[s.length-1],10);const i=k(a[e],"LowerCorner"),o=k(a[e],"UpperCorner");u=new w({xmin:i[0],ymin:i[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:m}})}}const c=l>p,d=u.xmax-u.xmin>u.ymax-u.ymin;let h=!1;v(m)&&(c===d?h=!1:(h=!0,u=new w({xmin:u.ymin,ymin:u.xmin,xmax:u.ymax,ymax:u.xmax,spatialReference:{wkid:m}})));const f={columns:l,rows:p,origin:{x:n[0],y:n[1]},offset:{x:r[0],y:r[r.length-1]},gridBaseCRS:i,envelope:u,useEPSGAxis:h},g=C(e,"temporalDomain")||C(e,"TemporalDomain");return{spatialDomain:f,temporalDomain:g?Q(g):null}}function K(e){const t=C(e,"Envelope")||C(e,"EnvelopeWithTimePeriod"),s=t.getAttribute("srsName"),i=s.slice(s.lastIndexOf("/")+1),o=t.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),n=k(t,"lowerCorner"),r=k(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].includes(o[0].toLowerCase());let l;const p=parseInt(i,10),m=isNaN(p)?null:{wkid:p};l=new w(a?{xmin:n[0],ymin:n[1],xmax:r[0],ymax:r[1],spatialReference:m}:{xmin:n[1],ymin:n[0],xmax:r[1],ymax:r[0],spatialReference:m});const u={mins:n,maxs:r},c=t.getAttribute("uomLabels").trim().split(" ");let d,h;if(L(t,"EnvelopeWithTimePeriod")){d=new Date(S(e,"beginPosition")||S(e,"BeginPosition")),h=new Date(S(e,"endPosition")||S(e,"EndPosition"));const t=c?.findIndex((e=>"oledatetime"===e?.toLowerCase()));t>-1&&(c[t]="ISO8601")}return{envelope:l,axisLabels:o,uomLabels:c.length?c:null,envelopeAllDims:u,beginPosition:d,endPosition:h,isEastFirst:a}}function X(e,t){const s=[],i=I(e,"DataRecord"),o=[];let n,r=[];for(let e=0;e<i.length;e++){const a=I(i[e],"field"),l=[];for(let e=0;e<a.length;e++){const s=a[e].getAttribute("name"),i=S(a[e],"description")||"",p=C(a[e],"uom")?.getAttribute("code")||"",m=k(a[e],"interval"),u=q(a[e],"nilValue")?.[0];t&&!s.toLowerCase().includes("band")||(o.push(s),m?.length&&(n=n||[],n.push({min:m[0],max:m[1],avg:-1,stddev:-1})),r.push(u)),l.push({name:s,description:i,uom:p,allowedValues:m,nilValue:u})}s.push(l)}return r.some((e=>null!=e))||(r=null),{rangeType:s,bandNames:o,bandStats:n,bandNoDataValues:r}}function ee(e){let t=1,s="";return Math.abs(e-1/24)<1/24*.01?s="Hours":Math.abs(e-1)<.01?s="Days":e<1?(t=Math.round(24*e),s="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?s="Months":e>364.99&&e<366.01&&(s="Years"),{interval:t,intervalUnit:s}}function te(e,t){const s=C(e,"RectifiedGrid"),i=k(s,"low"),o=k(s,"high"),n=[];for(let e=0;e<i.length;e++)n.push(o[e]-i[e]+1);const r=S(s,"axisLabels").split(" "),a=k(s,"origin/pos"),l=I(s,"offsetVector"),p=[];for(let e=0;e<l.length;e++){const t=k(l[e]),s=t.findIndex((e=>0!==e));p[s]=t[s]}let m,u,c,d=!1;return t?.length&&r?.length&&(d=[...t].sort(((e,t)=>e<t?-1:1)).join(",")===[...r].sort(((e,t)=>e<t?-1:1)).join(",")),["y","lat","latitude","north","nor","n","b"].includes((d?r:t)[0].toLowerCase())?(m=n[1],u=n[0],c={y:Math.abs(p[0]),x:Math.abs(p[1])}):(m=n[0],u=n[1],c={x:Math.abs(p[0]),y:Math.abs(p[1])}),{columns:m,rows:u,origin:a,offset:p,resolution:c,gridSamples:n,axisLabels:r,hasSameAxisLabelsAsBoundedBy:d}}function se(e){const t=C(e,"EarthObservation");if(!t)return null;const s=C(t,"phenomenonTime"),i=s?Q(s):null,o=C(t,"phenomenonTime"),n=o?Q(o):null,r=S(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let a=null;if(r){const e=r.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const t=[];for(let s=0;s<e.length/2;s+=2)t.push(e[s],e[s+1]);a=new R({rings:[t],spatialReference:{wkid:4326}})}}return{observation:{phenomenonTime:i,resultTime:n,footprint:a,identifier:S(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:S(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:S(e,"metaDataProperty/EarthObservationMetaData/status")}}}const ie=["nearest neighbor","bilinear","bicubic"],oe=["nearest","linear","cubic"],ne="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode";let re=class extends m{constructor(){super(...arguments),this.datasetFormat="WCSServer"}async open(e){await this.init();const s=e?.signal,i=await this._getCapabilities(s);if(this.capabilities=i,!this.version){let e=i.capabilitiesVersion?.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}const o=i.coverages.filter((({coverageSubType:e})=>null==e||""===e||/^rectified(grid|dataset)/i.test(e)));if(!o.length)throw new t("wcsraster-open","cannot find rectified grid coverages");null==this.coverageId&&(this.coverageId=o[0].id);const n=o.find((e=>e.id===this.coverageId));if(null==n)throw new t("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const r=await this._describeCoverage(s);this.coverageInfo=r[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=n.lonLatEnvelope,this.coverageInfo.supportedInterpolations=B(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new t("wcsraster-open",`coverage without spatial reference is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:p}=await this._getPixelTypeAndBandCount(s);a.pixelType=l,1===a.bandCount&&p>1&&(a.bandCount=p),this.updateTileInfo()}async fetchRawTile(e,s,i,o={}){if(this.isBlockOutside(e,s,i))return null;const{nativePixelSize:n,spatialReference:r}=this.rasterInfo,a=2**e,l=n.x*a,p=n.y*a,{blockWidth:m,blockHeight:u}=this.getBlockWidthHeight(e),{origin:c}=this.rasterInfo.storageInfo.tileInfo,d=this.getTileExtent({x:l,y:p},s,i,c,r,[m,u]),h=this.rasterInfo.extent,f=d.xmax>h.xmax,g=d.ymin<h.ymin,y=f||g;let b=d,j=m,v=u;if(y&&(b=d.clone().intersection(h),null!=b&&(f&&(j=Math.floor((b.xmax-b.xmin)/l),b.xmax=b.xmin+l*j),g&&(v=Math.floor((b.ymax-b.ymin)/p),b.ymin=b.ymax-p*v))),null==b||j<=1||v<=1)return null;const x=await this._getCoverage(b,j,v,a,o);if(!x)return null;const{coverageDescription:w}=this.coverageInfo;let{noDataValue:S,multidimensionalInfo:C}=this.rasterInfo;const{multidimensionalDefinition:I}=o;if(null!=C&&null!=I&&I.length){const e=I[0].variableName;if("2.0"===w.version){const t=w.rangeType[0].find((t=>t.name===e));S=t?.nilValue}else if("1.1"===w.version){const t=w.range.find((t=>t.identifier===e));S=t?.nullValues}}const k=await this.decodePixelBlock(x,{width:j,height:v,planes:null,pixelType:null,noDataValue:Array.isArray(S)?S[0]:S});if(null==k)return null;if(k&&(k.width!==j||k.height!==v))throw new t("wcsraster-fetch",`the response has unexpected dimension width: ${k.width}, height: {pixelBlock.height}`);return y?U(k,{x:0,y:0},{width:u,height:u}):k}async _getCapabilities(e){const s={service:"WCS",request:"GetCapabilities"};this.version&&(s.version=this.version,s.acceptVersions=this.version);try{const{data:i}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return function(e,s=null){let i=null;i="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e;const o=i.documentElement.getAttribute("version"),n=(o||s||"1.0.0").slice(0,3);let r;if("2.0"===n)r=function(e){const t=C(e,"ServiceIdentification"),s=S(t,"Title"),i=D(t,"ServiceTypeVersion"),o=D(t,"Profile"),n=N(C(e,"OperationsMetadata")),r=I(e,"Contents/CoverageSummary"),a=[];for(let e=0;e<r.length;e++){const t=r[e],s=S(t,"CoverageId"),i=C(t,"WGS84BoundingBox");let o;if(i){const e=k(i,"LowerCorner"),t=k(i,"UpperCorner");o=new w({xmin:e[0],ymin:e[1],xmax:t[0],ymax:t[1],spatialReference:{wkid:4326}})}const n=S(t,"CoverageSubtype")||"RectifiedGridCoverage";a.push({id:s,lonLatEnvelope:o,coverageSubType:n})}const l=C(e,"ServiceMetadata");return{name:s,supportedVersions:i,supportedFormats:D(l,"formatSupported"),supportedInterpolations:D(l,"interpolationSupported").concat(D(l,"InterpolationSupported")),onlineResources:n,profiles:o,coverages:a}}(i);else if("1.1"===n)r=function(e){const t=S(e,"ServiceIdentification/Title"),s=D(e,"ServiceIdentification/ServiceTypeVersion"),i=N(C(e,"OperationsMetadata")),o=[],n=C(e,"Contents");for(let e=0;e<n.childNodes.length;e++){const t=n.childNodes[e];1===t.nodeType&&L(t,"CoverageSummary")&&$(F(t),o)}return{name:t,onlineResources:i,coverages:o,supportedVersions:s,supportedFormats:D(n,"SupportedFormat")}}(i);else{if("1.0"!==n)throw new t("wcsraster:parsecapabilities","the capabilities version is not supported");r=function(e){const t=S(e,"Service/name"),s=C(e,"Capability"),i=C(s,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",o=C(s,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",n=C(s,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",r={getCapabilities:O(i),describeCoverage:O(o),getCoverage:O(n)},a=I(e,"CoverageOfferingBrief"),l=[];for(let e=0;e<a.length;e++){const t=a[e],s=S(t,"name"),i=I(t,"pos"),o=k(i[0]),n=k(i[1]),r=new w({xmin:o[0],ymin:o[1],xmax:n[0],ymax:n[1],spatialReference:{wkid:4326}});l.push({id:s,lonLatEnvelope:r})}return{name:t,onlineResources:r,coverages:l,supportedVersions:["1.0.0"]}}(i)}return r.capabilitiesVersion=o,r}(i)}catch(e){if(!j(e))throw new t("wcslayer:open","wcs capabilities is not valid or supported");throw e}}async _describeCoverage(e){const s={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version?.slice(0,3);"1.0"===i?s.coverage=this.coverageId:"1.1"===i?s.identifiers=this.coverageId:"2.0"===i&&(s.coverageId=this.coverageId);try{const{data:t}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return function(e,t){let s=null;if(s="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e,"1.0.0"===t)return I(s,"CoverageOffering").map((e=>function(e){const t={version:"1.0"};let s,i=[];for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(1===r.nodeType)if(L(r,"description"))t.description=S(r);else if(L(r,"name"))t.name=S(r);else if(L(r,"label"))t.label=S(r);else if(L(r,"supportedFormats"))t.supportedFormats=D(r,"formats");else if(L(r,"supportedCRSs"))t.supportedCRSs={requestResponseCRSs:D(o=r,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:D(o,"nativeCRSs").map((e=>e.split(":")[1]))};else if(L(r,"supportedInterpolations"))t.supportedInterpolations=G(r,"1.0.0");else if(L(r,"lonLatEnvelope"))t.lonLatEnvelope=_(r);else if(L(r,"rangeSet")){const e=z(r);t.rangeSet=e.rangeSet,i=e.bandNames;const o=e.rangeSet[0].nullValues;o?.length&&(s=H(o))}else L(r,"domainSet")&&(t.domainSet=Y(r))}var o;const n=B(t.supportedInterpolations),{name:r,description:a,label:l,lonLatEnvelope:p,supportedFormats:m}=t,{spatialDomain:u}=t.domainSet,c={x:Math.abs(u.offset.x),y:Math.abs(u.offset.y)},d=function(e){if(!e.temporalDomain)return null;const{begin:t,end:s,values:i,units:o,resolution:n}=e.temporalDomain;return{variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:i?.map((e=>e.getTime())),hasRegularIntervals:!i,interval:n,intervalUnit:o,extent:[t.getTime(),s.getTime()]}]}]}}(t.domainSet),h=new P({width:u.columns,height:u.rows,pixelSize:c,extent:u.envelope,spatialReference:u.envelope.spatialReference,bandCount:i.length||1,noDataValue:s,multidimensionalInfo:d});return{id:r,title:t.name,description:a||l,lonLatEnvelope:p,rasterInfo:h,bandNames:i,supportedFormats:m,supportedInterpolations:n,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e)));const i=I(s,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?i.map((e=>function(e,t){const s=[],i=[],o={supportedFormats:s,supportedCRSs:i,version:"1.1"};let n,r,a=[];for(let t=0;t<e.childNodes.length;t++){const l=e.childNodes[t];if(1!==l.nodeType)continue;const p=T(l).toLowerCase();switch(p){case"title":case"abstract":case"identifier":o[p]=S(l);break;case"supportedformat":{const e=S(l);s.includes(e)||s.push(e)}break;case"supportedcrs":{const e=S(l);i.includes(e)||i.push(e)}break;case"range":{const e=J(l,!!o.domain?.temporalDomain);o.range=e.rangeSet,a=e.bandNames;const{bandNoDataValues:t}=e;t?.length&&(n=H(t)),r=e.statistics}break;case"domain":o.domain=Z(l)}}const l=B(o.range[0].supportedInterpolations),{identifier:p,abstract:m,title:u,domain:c,range:d}=o,h={x:Math.abs(c.spatialDomain.offset.x),y:Math.abs(c.spatialDomain.offset.y)},f=function(e,t){if(!t.temporalDomain)return null;const s=e.filter((e=>!e.identifier.toLowerCase().includes("field_1")&&!e.axis.some((e=>e.identifier.includes("band"))))),i=[];if(s.length&&s.forEach((e=>{const t=e.axis.map((e=>{const t=e.values.map((t=>"ISO8601"===e.uom?(t=t.trim()).toLowerCase().includes("z")?new Date(t).getTime():new Date(t+"Z").getTime():parseFloat(t.trim()))),s=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:s}}));i.push({name:e.identifier.trim(),description:e.description?.trim()??"",unit:"",dimensions:t,statistics:e.statistics})})),t.temporalDomain){const{begin:e,end:s,values:o,units:n,resolution:r}=t.temporalDomain;i.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:o?.map((e=>e.getTime())),hasRegularIntervals:!o,interval:r,intervalUnit:n,extent:[e.getTime(),s.getTime()]})}))}return i.length?{variables:i}:null}(d,c);f&&(n=d[0].nullValues,1===n?.length&&(n=n[0]));const g=new P({width:c.spatialDomain.columns,height:c.spatialDomain.rows,pixelSize:h,extent:c.spatialDomain.envelope,spatialReference:c.spatialDomain.envelope.spatialReference,bandCount:a.length||1,noDataValue:n,statistics:r,multidimensionalInfo:f});return{id:p,title:o.title,description:m||u,lonLatEnvelope:null,bandNames:a,rasterInfo:g,supportedFormats:s,supportedInterpolations:l,coverageDescription:o,version:t,useEPSGAxis:c.spatialDomain.useEPSGAxis}}(e,t))):i.map((e=>function(e){const t={version:"2.0"};let s,i,o=[];for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(1===r.nodeType)if(L(r,"coverageId"))t.coverageId=S(r);else if(L(r,"ServiceParameters"))t.serviceParameters={supportedFormats:D(r,"nativeFormat")};else if(L(r,"boundedBy"))t.boundedBy=K(r);else if(L(r,"rangeType")){const e=X(r,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=e.rangeType,o=e.bandNames,s=e.bandStats;const{bandNoDataValues:n}=e;n?.length&&(i=H(n))}else if(L(r,"domainSet"))t.domainSet=te(r,t.boundedBy?.axisLabels);else if(L(r,"metadata")){const e=C(r,"EOMetadata");t.eoMetadata=e?se(e):null}}const{coverageId:n,boundedBy:r,domainSet:a,rangeType:l,serviceParameters:p}=t,m=function(e,t,s){if(s.axisLabels.length<=2)return null;const i=[];for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.length;e++)s[e].name.toLowerCase().includes("band")||i.push(s[e])}const o=[];if(i.length){const e=[];for(let i=2;i<s.axisLabels.length;i++){const o=(t.uomLabels?.length??0)>i?t.uomLabels?.[i]:"",n=s.axisLabels[i].toLowerCase().includes("time")||"iso8601"===o.toLowerCase()||"oledatetime"===o.toLowerCase();let r,a;if(n){const e=ee(s.offset[i]);r=e.interval,a=e.intervalUnit}else r=s.offset[i],a=o;const l=[];n?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[i]),l.push(t.envelopeAllDims.maxs[i])),e.push({name:s.axisLabels[i].trim(),description:s.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:l,interval:r,intervalUnit:a})}if(i.forEach((t=>{const{allowedValues:s}=t,i=2===s?.length?[{min:s[0],max:s[1],avg:-1,stddev:-1}]:null;o.push({name:t.name.trim(),description:t.description?.trim()??"",unit:t.uom.trim(),statistics:i,dimensions:e})})),o.length)return{variables:o}}return null}(l,r,a);return!s&&m&&(s=m?.variables[0].statistics),null!=m&&(i=l[0][0].nilValue),{id:n,title:n,description:n,lonLatEnvelope:null,bandNames:o,rasterInfo:new P({width:a.columns,height:a.rows,pixelSize:a.resolution,extent:r.envelope,spatialReference:r.envelope.spatialReference,bandCount:o.length||1,statistics:s,noDataValue:i,multidimensionalInfo:m}),supportedFormats:p.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}(e)))}(t,this.version)}catch(e){if(!j(e))throw new t("wcslayer:open","wcs coverage description is not valid or supported");throw e}}async _getPixelTypeAndBandCount(e){const{pixelSize:s,extent:i,multidimensionalInfo:o}=this.rasterInfo,r=i.center,a=new w({xmin:r.x-s.x,xmax:r.x+s.x,ymin:r.y-s.y,ymax:r.y+s.y,spatialReference:i.spatialReference});let l=[];if(null!=o){const e=o.variables[0];l=[],e.dimensions.forEach((t=>{l.push(new x({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:p}=this.coverageInfo,m={interpolation:"nearest",multidimensionalDefinition:l,signal:e},{version:u}=p,{ioConfig:c}=this,d="2.0"===u&&null==c.allowAnyMediaType||"1.1"===u&&null==c.use2GridOffsets;let h;try{h=await this._getCoverage(a,2,2,1,m,!0)}catch(e){if(!d)throw e;if("1.1"===u){if(!e.details?.isResolutionMismatch)throw e;c.use2GridOffsets=!0}}if(!h&&d&&("2.0"===u&&(c.allowAnyMediaType=!0),h=await this._getCoverage(a,2,2,1,m),h&&n.getLogger(this).warn("wcsraster:getcoverage",ne)),!h)throw new t("wcsraster-open","unable to determine pixel type");const f=await this.decodePixelBlock(h,{width:2,height:2,planes:null,pixelType:null});if(null==f)throw new t("wcsraster-open","unable to determine pixel type");return{pixelType:f.pixelType,bandCount:f.getPlaneCount()??0}}async _getCoverage(e,s,i,o,r,a=!1){const{coverageDescription:l}=this.coverageInfo,{version:p}=l,m="2.0"===p?this._getCoverage201Parameters(e,s,i,o,r,l):"1.1"===p?this._getCoverage110Parameters(e,s,i,r,l):this._getCoverage100Parameters(e,s,i,r),u="2.0"===p?await this.request(this._constructWCS201Url(m),{signal:r.signal,responseType:"array-buffer"}):await this.request(this.url,{query:m,signal:r.signal,responseType:"array-buffer"});if("1.0"===p)return u.data;if("2.0"===p&&!1!==this.ioConfig.allowAnyMediaType&&"tiff"===M(u.data))return a&&(this.ioConfig.allowAnyMediaType=!0,n.getLogger(this).warn("wcsraster:getcoverage",ne)),u.data;const c=function(e){const t=function(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!t)return null;if(!(t[0].trim()??"").startsWith("multipart/"))return null;const s={boundary:"",start:"",type:""};for(let e=1;e<t.length;e++){const i=t[e].indexOf("=");if(i>0){const o=t[e].slice(0,i).trim(),n=t[e].slice(i+1).trim();s[o]=n.startsWith('"')?n.slice(1,-1):n}}return s}(e);return t?{isMultipart:!0,data:t.boundary?A(e.data,t,0):null}:{isMultipart:!1,data:null}}(u);if(c.isMultipart&&c.data){const e=c.data.find((e=>e.contentType?.toLowerCase().includes("image")&&null!=e.contentData));return a&&"base64"===e?.contentTransferEncoding&&n.getLogger(this).warn("wcsraster:getcoverage","response is base64 encoded which may impact layer display performance"),e?.contentData}const d=new Uint8Array(u.data,0,Math.min(u.data.byteLength,2e3)),h=String.fromCharCode.apply(null,d).toLowerCase().includes("exception"),f=h&&String.fromCharCode.apply(null,d).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(h)throw new t("wcsraster:getcoverage","server returns an exception",{isResolutionMismatch:f});throw new t("wcsraster:getcoverage","response is not a supported multipart mediaType with inline tiff")}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0}_getCoverage100Parameters(e,t,s,i){const o=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,n=e.spatialReference.wkid,r=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:a,interpolation:l}=i,p=this._getInterpolationIndex(l),m=a?a.map((e=>this.coverageInfo.bandNames[e])):null,u=ie[p],{multidimensionalDefinition:c}=i;let d;if(null!=c&&null!=this.rasterInfo.multidimensionalInfo){const e=c.find((e=>"StdTime"===e.dimensionName));let t=e?.values;t&&t.length>0&&(t[0]instanceof Array&&(t=t[0]),d=t.map((e=>this._convertToISOTime(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:r,crs:`EPSG:${n}`,bbox:o,width:t,height:s,time:d,interpolation:u,band:m?.join(",")}}_getCoverage110Parameters(e,t,s,i,o){const{multidimensionalDefinition:n,bandIds:r,interpolation:a}=i,l=e.spatialReference.wkid,p=`urn:ogc:def:crs:EPSG::${l}`,m=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",u=this._getInterpolationIndex(a),c=oe[u],d=null==a||0===this.coverageInfo.supportedInterpolations?.indexOf(a),h=o.domain.spatialDomain,f=h.origin.x<=h.envelope.xmin&&h.origin.y<=h.envelope.ymin,g=e.width/t,y=e.height/s*(f?1:-1),b=f?[e.xmin,e.ymin]:[e.xmin,e.ymax],j=h.useEPSGAxis&&v(l),x=j?`${b[1]},${b[0]}`:`${b[0]},${b[1]}`,w=this.ioConfig.use2GridOffsets,S=j?w?`${y},${g}`:`${y},0,0,${g}`:w?`${g},${y}`:`${g},0,0,${y}`,C=g/2,I=e.xmin+C,k=e.xmax-C,D=Math.abs(y)/2,L=e.ymin+D,T=e.ymax-D,R=j?`${L},${I},${T},${k},${p}`:`${I},${L},${k},${T},${p}`,P=o.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let M,U=P&&c&&r?d?`${P.identifier}[${P.axis[0].identifier}[${r.join(",")}]]`:`${P.identifier}:${c}[${P.axis[0].identifier}[${r.join(",")}]]`:null;if(null!=n&&n.length)for(let e=0;e<n.length;e++){let t=n[e].values;const s=n[e].dimensionName?.toLowerCase(),i=n[e].variableName?.toLowerCase();if(t.length>0)if(t[0]instanceof Array&&(t=t[0]),"stdtime"===s)M=t.map((e=>this._convertToISOTime(e))).join(",");else{const e=o.range.find((e=>e.identifier.toLowerCase()===i));if(e){const i=e.axis.find((e=>e.identifier.toLowerCase()===s));i&&(U=d?e.identifier+"["+i.identifier+"["+t.join(",")+"]]":e.identifier+":"+c+"["+i.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:m,crs:`EPSG:${l}`,boundingbox:R,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:x,gridOffsets:S,gridBaseCRS:p,timeSequence:M,rangeSubset:U}}_convertToISOTime(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()}_getCoverage201Parameters(e,t,s,i,o,n){const{multidimensionalDefinition:r,interpolation:a}=o,l=this._getInterpolationIndex(a);let p=null;const{supportedInterpolations:m}=this.capabilities;if(m?.length)switch(l){case 0:p=m.find((e=>e.toLowerCase().includes("nearest")));break;case 1:p=m.find((e=>e.toLowerCase().includes("linear")));break;case 2:p=m.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:c}=this.coverageInfo,{boundedBy:d,domainSet:h,rangeType:f}=n,g=d.isEastFirst?0:1,y=1-g,{axisLabels:b}=d,j=b[g],v=b[y],x=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,w=x,S=[];S.push(`${j}(${e.xmin},${e.xmax})`),S.push(`${v}(${e.ymin},${e.ymax})`);const C=[];if(b.length>2)for(let e=2;e<b.length;e++){const t=h.origin[e];if(b[e].toLowerCase().includes("time")){let s=t.toString();d.uomLabels?.[e].toLowerCase().includes("ole")&&(C.push(b[e]),s=this._convertToISOTime(t,!0)),S.push(b[e]+",http://www.opengis.net("+s+")")}else S.push(b[e]+",http://www.opengis.net("+t+")")}let I=null;if(null!=r&&r.length){const e=[];f.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<r.length;s++){const i=b.find((e=>e===r[s].dimensionName)),o=e.find((e=>e===r[s].variableName));if(t.includes(o)||t.push(o),i){let e=r[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=i.toLowerCase().includes("time")?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const s=S.findIndex((e=>0===e.indexOf(i+",http://www.opengis.net")));-1===s&&S.push(i+",http://www.opengis.net("+t+")"),-1===s||S[s].includes("("+t+")")||S.splice(s,1,i+",http://www.opengis.net("+t+")")}}}t.length&&(I=t.join(","))}else c?.length>=2&&(I=(o.bandIds?o.bandIds.map((e=>c[e])):c).join(","));const k=S.join("&subset="),D=!n.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,L=D?null:`${j}(${t}),${v}(${s})`,T=D?1/i:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:I,interpolation:p,scaleSize:L,scaleFactor:T,subset:k,format:u,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:x,subsettingcrs:w}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},s=[];return Object.keys(t).forEach((e=>{const i=t[e];null!=i&&("subset"===e?"string"==typeof i&&i.split("&subset=").forEach((e=>{e&&s.push(`subset=${encodeURIComponent(e)}`)})):s.push(`${e}=${encodeURIComponent(i)}`))})),`${encodeURI(this.url)}?${s.join("&")}`}};e([o({type:String,json:{write:!0}})],re.prototype,"datasetFormat",void 0),e([o()],re.prototype,"tileType",void 0),e([o({type:String,json:{write:!0}})],re.prototype,"version",void 0),e([o({type:String,json:{write:!0}})],re.prototype,"coverageId",void 0),re=e([r("esri.layers.support.rasterDatasets.WCSRaster")],re);const ae=re,le=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let pe=class extends(l(f(c(d(p(u(g(h(s(a)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this._openRaster(t)),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[new b({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]}createPopupTemplate(e){return V({fields:this.rasterFields,title:this.title},e)}async _openRaster(e){const s=new ae({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await s.open({signal:e}),!s.rasterInfo)throw s.destroy(),new t("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:o}=s;this._set("serviceRasterInfo",o),this._set("spatialReference",o.spatialReference),null==this.title&&this.setAtOrigin("title",s.datasetName,"service"),null==this.coverageId&&this.setAtOrigin("coverageId",s.coverageInfo.id,"service"),this.setAtOrigin("tileInfo",s.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:n}=o;if(null!=n){const e=n.variables[0].dimensions.find((({name:e})=>"StdTime"===e));if(e){let t=e.extent?.[0]??e.values[0];Array.isArray(t)&&(t=t[0]);let s=e.extent?.[1]??e.values[e.values.length-1];Array.isArray(s)&&(s=s[1]);const i=le.has(e.intervalUnit?.toLowerCase())?e.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:t,end:s},timeZone:null,interval:i?{value:e.interval,unit:i}:null})}}this.raster=s,this._configDefaultSettings(),this.addHandles(i((()=>this.customParameters),(e=>this.raster.ioConfig.customFetchParameters=e)))}};e([o({type:String,nonNullable:!0,json:{write:!0}})],pe.prototype,"coverageId",void 0),e([o()],pe.prototype,"coverageInfo",null),e([o()],pe.prototype,"version",void 0),e([o()],pe.prototype,"isReference",void 0),e([o()],pe.prototype,"raster",void 0),e([o({readOnly:!0})],pe.prototype,"type",void 0),e([o(y)],pe.prototype,"popupEnabled",void 0),e([o()],pe.prototype,"popupTemplate",void 0),e([o({readOnly:!0})],pe.prototype,"defaultPopupTemplate",null),e([o({readOnly:!0,type:[b]})],pe.prototype,"fields",void 0),e([o({readOnly:!0,type:[b]})],pe.prototype,"rasterFields",null),pe=e([r("esri.layers.WCSLayer")],pe);const me=pe;export{me as default};
