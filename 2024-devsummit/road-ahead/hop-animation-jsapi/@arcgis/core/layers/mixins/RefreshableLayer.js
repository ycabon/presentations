/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{L as r}from"../../chunks/Logger.js";import{debounce as t,ignoreAbortErrors as s}from"../../core/promiseUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import{cast as n}from"../../core/accessorSupport/decorators/cast.js";import"../../core/lang.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import{e as i}from"../../chunks/layerContainerType.js";import h from"../../core/Collection.js";import"../../chunks/asyncUtils.js";import"../../core/Error.js";import{a as c}from"../../core/Accessor.js";import"../../config.js";import"../../chunks/handleUtils.js";import"../../chunks/maybe.js";import"../../chunks/ensureType.js";import"../../chunks/utils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../core/Evented.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";const m=new h,p=new WeakMap;function f(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:f(r,e%r):0}let l=0,u=0;function d(){const e=Date.now();let r=!1;for(const t of m){const s=t.deref();s?s.refreshInterval&&e-(p.get(s)??0)+5>=6e4*s.refreshInterval&&(p.set(s,e),s.refresh(e)):r=!0}if(r)for(let e=m.length-1;e>=0;e--)m.at(e).deref()||m.removeAt(e)}function j(e){return null!=e&&"object"==typeof e&&"refreshTimestamp"in e&&"refresh"in e}c((()=>{const e=Date.now();let r=0;for(const t of m){const s=t.deref();s&&(r=f(Math.round(6e4*s.refreshInterval),r),s.refreshInterval?p.get(s)||p.set(s,e):p.delete(s))}if(r!==u){if(u=r,clearInterval(l),0===u)return void(l=0);l=setInterval(d,u)}}));const v=h=>{let c=class extends h{constructor(...e){super(...e),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=t((()=>this.hasDataChanged())),this.when().then((()=>{var e;this.destroyed||null!=(e=this)&&"object"==typeof e&&"refreshInterval"in e&&"refresh"in e&&m.push(new WeakRef(this))}),(()=>{}))}destroy(){!function(e){const r=m.find((r=>r.deref()===e));r&&m.remove(r)}(this)}castRefreshInterval(e){return e>=.1?e:e<=0?0:.1}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(e=Date.now()){s(this._debounceHasDataChanged()).then((r=>{r&&this._set("refreshTimestamp",e),this.emit("refresh",{dataChanged:r})}),(e=>{r.getLogger(this).error(e),this.emit("refresh",{dataChanged:!1,error:e})}))}async hasDataChanged(){return!0}get test(){const e=this;return{set refreshInterval(r){e._set("refreshInterval",r)}}}};return e([o({type:Number,json:{write:!0,origins:{"web-scene":{write:{enabled:!0,layerContainerTypes:i}}}}})],c.prototype,"refreshInterval",void 0),e([n("refreshInterval")],c.prototype,"castRefreshInterval",null),e([o({readOnly:!0})],c.prototype,"refreshTimestamp",void 0),e([o({readOnly:!0})],c.prototype,"refreshParameters",null),c=e([a("esri.layers.mixins.RefreshableLayer")],c),c};export{v as RefreshableLayer,j as isRefreshableLayer};
