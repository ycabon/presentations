/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../request.js";import o from"../../core/Error.js";import{g as s}from"../../chunks/imageUtils.js";import{isDataProtocol as r,isBlobProtocol as i,isAbsolute as n,dataToBlob as m,join as a}from"../../core/urlUtils.js";import{g as p}from"../../chunks/uuid.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{r as l}from"../../chunks/reader.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import{w as h}from"../../chunks/writer.js";import j from"./MediaElementBase.js";import{g}from"../../chunks/resourceExtension.js";import{f as d,a as f,i as y,M as k}from"../../chunks/persistableUrlUtils.js";import"../../config.js";import"../../kernel.js";import"../../core/promiseUtils.js";import"../../chunks/handleUtils.js";import"../../chunks/maybe.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/ensureType.js";import"../../core/Identifiable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"./ControlPointsGeoreference.js";import"../../chunks/perspectiveUtils.js";import"../../chunks/mat3.js";import"../../chunks/common.js";import"../../chunks/mat3f64.js";import"../../chunks/vec2.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/screenUtils.js";import"../../chunks/vec2f64.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Polygon.js";import"../../geometry/Extent.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/zmUtils.js";import"../../geometry/projection.js";import"../../chunks/SimpleObservable.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GeoreferenceBase.js";import"../../core/Clonable.js";import"./CornersGeoreference.js";import"./ExtentAndRotationGeoreference.js";let v=class extends j{constructor(t){super(t),this.animationOptions=null,this.content=null,this.image=null,this.type="image",this.image=null}load(){const t=this.image;if("string"==typeof t){const e=s(t).then((t=>{this._set("content",t)}));this.addResolvingPromise(e)}else if(t instanceof HTMLImageElement){const e=t.decode().then((()=>{this._set("content",t)}));this.addResolvingPromise(e)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new o("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}get contentWidth(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return null==this.content?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,e,o){return d(e.url,o)}writeImage(t,o,s,c){if(null==t)return;const l=c?.portalItem,u=c?.resources;if(!l||!u)return void("string"==typeof t&&(o[s]=f(t,c)));const h="string"!=typeof t||r(t)||i(t)?null:t;if(h){if(null==y(h))return void(o[s]=h);const t=f(h,{...c,verifyItemRelativeUrls:c?.verifyItemRelativeUrls?{writtenUrls:c.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},k.NO);if(l&&t&&!n(t))return u.toKeep.push({resource:l.resourceFromPath(t),compress:!1}),void(o[s]=t)}o[s]="<pending>",u.pendingOperations.push(async function(t){return"string"==typeof t?r(t)?m(t):(await e(t,{responseType:"blob"})).data:new Promise((e=>function(t){if(t instanceof HTMLCanvasElement)return t;const e=t instanceof HTMLImageElement?t.naturalWidth:t.width,o=t instanceof HTMLImageElement?t.naturalHeight:t.height,s=document.createElement("canvas"),r=s.getContext("2d");return s.width=e,s.height=o,t instanceof HTMLImageElement?r.drawImage(t,0,0,t.width,t.height):t instanceof ImageData&&r.putImageData(t,0,0),s}(t).toBlob(e)))}(t).then((t=>{const e=function(t,e){const o=p(),s=`${a("media",o)}.${g({type:"blob",blob:t})}`;return e.resourceFromPath(s)}(t,l);o[s]=e.itemRelativeUrl,u.toAdd.push({resource:e,content:{type:"blob",blob:t},compress:!1,finish:t=>{this.image=t.url}})})))}};t([c()],v.prototype,"animationOptions",void 0),t([c({readOnly:!0})],v.prototype,"content",void 0),t([c({readOnly:!0})],v.prototype,"contentWidth",null),t([c({readOnly:!0})],v.prototype,"contentHeight",null),t([c({json:{name:"url",type:String}})],v.prototype,"image",void 0),t([l("image",["url"])],v.prototype,"readImage",null),t([h("image")],v.prototype,"writeImage",null),t([c({readOnly:!0,json:{name:"mediaType"}})],v.prototype,"type",void 0),v=t([u("esri.layers.support.ImageElement")],v);const b=v;export{b as default};
