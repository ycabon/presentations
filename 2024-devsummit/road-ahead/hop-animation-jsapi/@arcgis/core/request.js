/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import e from"./config.js";import{id as r}from"./kernel.js";import t from"./core/Error.js";import{h as s,clone as o}from"./core/lang.js";import{isAborted as n,onAbort as a,isAbortError as i,createAbortError as c}from"./core/promiseUtils.js";import{getOrigin as l,hasSameOrigin as u,getAppUrl as d,urlToObject as p,queryToObject as m,isDataProtocol as h,isBlobProtocol as f,normalize as y,getInterceptor as w,isTrustedServer as g,toHTTPS as b,objectToQuery as q,getProxyRule as k,getProxyUrl as S,addQueryParameters as v,i as O,addProxyRule as T}from"./core/urlUtils.js";import"./chunks/Logger.js";import"./core/JSONSupport.js";import"./chunks/tslib.es6.js";import"./core/Accessor.js";import"./core/Handles.js";import"./chunks/maybe.js";import"./core/accessorSupport/decorators/subclass.js";import"./chunks/metadata.js";import"./chunks/utils.js";import"./chunks/handleUtils.js";import"./chunks/tracking.js";import"./chunks/ensureType.js";import"./core/accessorSupport/decorators/property.js";import"./chunks/ObservableBase.js";import"./core/scheduling.js";const C=new Set(["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"]);function j(e){const r=l(e,!0);return!!r&&r.endsWith(".arcgis.com")&&!C.has(r)&&!e.endsWith("/sharing/rest/generateToken")}function E(e,r,t=!1,o){return new Promise(((a,i)=>{if(n(o))return void i(L());let c=()=>{d(),i(new Error(`Unable to load ${r}`))},l=()=>{const r=e;d(),a(r)},u=()=>{if(!e)return;const r=e;d(),r.src="",i(L())};const d=()=>{s("esri-image-decode")||(e.removeEventListener("error",c),e.removeEventListener("load",l)),c=null,l=null,e=null,null!=o&&o.removeEventListener("abort",u),u=null,t&&URL.revokeObjectURL(r)};null!=o&&o.addEventListener("abort",u),s("esri-image-decode")?e.decode().then(l,c):(e.addEventListener("error",c),e.addEventListener("load",l))}))}function L(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}const x="Timeout exceeded";function A(e){return"object"==typeof e&&!!e&&"message"in e&&e.message===x}async function U(o,i){o instanceof URL&&(o=o.toString()),i?.query instanceof URLSearchParams&&(i.query=m(i.query.toString().replaceAll("+"," ")));const c=h(o),u=f(o);u||c||(o=y(o));const d={url:o,requestOptions:{...i}};let p=w(o);if(p){const e=await async function(e,r){if(null!=e.responseData)return e.responseData;if(e.headers&&(r.requestOptions.headers={...r.requestOptions.headers,...e.headers}),e.query&&(r.requestOptions.query={...r.requestOptions.query,...e.query}),e.before){let s,o;try{o=await e.before(r)}catch(e){s=B("request:interceptor",e,r)}if((o instanceof Error||o instanceof t)&&(s=B("request:interceptor",o,r)),s)throw e.error&&e.error(s),s;return o}}(p,d);if(null!=e)return{data:e,getAllHeaders:F,getHeader:F,httpStatus:200,requestOptions:d.requestOptions,url:d.url};p.after||p.error||(p=null)}if(o=d.url,"image"===(i=d.requestOptions).responseType&&(s("host-webworker")||s("host-node")))throw B("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),d);if("head"===i.method){if(i.body)throw B("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),d);if(c||u)throw B("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),d)}if(await async function(){s("host-webworker")&&!D&&(D=await import("./chunks/request.js"))}(),D)return D.execute(o,i);const b=new AbortController;a(i,(()=>b.abort()));const q={controller:b,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:p,params:d,redoRequest:!1,useIdentity:P.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},k=await async function(t){let s,o;await async function(t){const s=t.params.url,o=t.params.requestOptions,a=t.controller.signal,i=o.body;let c=null,l=null;if(N&&"HTMLFormElement"in globalThis&&(i instanceof FormData?c=i:i instanceof HTMLFormElement&&(c=new FormData(i))),"string"==typeof i&&(l=i),t.fetchOptions={cache:o.cacheBust?"no-cache":"default",credentials:"same-origin",headers:o.headers||{},method:"head"===o.method?"HEAD":"GET",mode:"cors",priority:P.priority,redirect:"follow",signal:a},(c||l)&&(t.fetchOptions.body=c||l),"anonymous"===o.authMode&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(s)||o.query?.token||c?.get("token")),!t.hasToken&&e.apiKey&&j(s)&&(o.query||(o.query={}),o.query.token=e.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!W(s)&&!n(a)){let e;"immediate"===o.authMode?(await $(),e=await r.getCredential(s,{signal:a}),t.credential=e):"no-prompt"===o.authMode?(await $(),e=await r.getCredential(s,{prompt:!1,signal:a}).catch((()=>{})),t.credential=e):r&&(e=r.findCredential(s)),e&&(t.credentialToken=e.token,t.useSSL=!!e.ssl)}}(t);try{do{[s,o]=await z(t)}while(!await G(t,s,o))}catch(e){const r=B("request:server",e,t.params,s);throw r.details.ssl=t.useSSL,t.interceptor?.error&&t.interceptor.error(r),r}const a=t.params.url;if(o&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(a)){if(!t.hasToken&&!t.credentialToken&&o.user?.username&&!g(a)){const e=l(a,!0);e&&P.trustedServers.push(e)}Array.isArray(o.authorizedCrossOriginNoCorsDomains)&&function(r){e.request.crossOriginNoCorsDomains||(e.request.crossOriginNoCorsDomains={});const t=e.request.crossOriginNoCorsDomains;for(let e of r)e=e.toLowerCase(),/^https?:\/\//.test(e)?t[l(e)??""]=0:(t[l("http://"+e)??""]=0,t[l("https://"+e)??""]=0)}(o.authorizedCrossOriginNoCorsDomains)}const i=t.credential;if(i&&r){const e=r.findServerInfo(i.server);let t=e?.owningSystemUrl;if(t){t=t.replace(/\/?$/,"/sharing");const e=r.findCredential(t,i.userId);e&&-1===r._getIdenticalSvcIdx(t,e)&&e.resources.unshift(t)}}return{data:o,getAllHeaders:s?()=>Array.from(s.headers):F,getHeader:s?e=>s.headers.get(e):F,httpStatus:s?.status??200,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}(q);return p?.after?.(k),k}let D;const P=e.request,N="FormData"in globalThis,H=new Set([499,498,403,401]),R=new Set(["COM_0056","COM_0057","SB_0008"]),_=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],F=()=>null,I=Symbol();function M(e){const r=l(e);return!r||r.endsWith(".arcgis.com")||U._corsServers.includes(r)||g(r)}function B(e,r,s,n){let a="Error";const l={url:s.url,requestOptions:s.requestOptions,getAllHeaders:F,getHeader:F,ssl:!1};if(r instanceof t)return r.details?(r.details=o(r.details),r.details.url=s.url,r.details.requestOptions=s.requestOptions):r.details=l,r;if(r){const e=n&&(()=>Array.from(n.headers)),t=n&&(e=>n.headers.get(e)),s=n?.status,o=r.message;o&&(a=o),e&&t&&(l.getAllHeaders=e,l.getHeader=t),l.httpStatus=(null!=r.httpCode?r.httpCode:r.code)||s||0,l.subCode=r.subcode,l.messageCode=r.messageCode,"string"==typeof r.details?l.messages=[r.details]:l.messages=r.details,l.raw=I in r?r[I]:r}return i(r)?c():new t(e,a,l)}async function $(){r||await import("./identity/IdentityManager.js")}function W(e){return _.some((r=>r.test(e)))}async function z(t){let o=t.params.url;const n=t.params.requestOptions,a=t.fetchOptions??{},i=f(o)||h(o),m=n.responseType||"json",y=i?0:null!=n.timeout?n.timeout:P.timeout;let w=!1;if(!i){t.useSSL&&(o=b(o));let i={...n.query};t.credentialToken&&(i.token=t.credentialToken);let c=q(i);s("esri-url-encodes-apostrophe")&&(c=c.replaceAll("'","%27"));const m=o.length+1+c.length;let h;w="delete"===n.method||"post"===n.method||"put"===n.method||!!n.body||m>P.maxUrlLength;const f=n.useProxy||!!k(o);if(f){const e=S(o);h=e.path,!w&&h.length+1+m>P.maxUrlLength&&(w=!0),e.query&&(i={...e.query,...i})}if("HEAD"===a.method&&(w||f)){if(w){if(m>P.maxUrlLength)throw B("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params);throw B("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params)}if(f)throw B("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(w?(a.method="delete"===n.method?"DELETE":"put"===n.method?"PUT":"POST",n.body?o=v(o,i):(a.body=q(i),a.headers||(a.headers={}),a.headers["Content-Type"]="application/x-www-form-urlencoded")):o=v(o,i),f&&(t.useProxy=!0,o=`${h}?${o}`),i.token&&N&&a.body instanceof FormData&&!O(o)&&a.body.set("token",i.token),n.hasOwnProperty("withCredentials"))t.withCredentials=n.withCredentials;else if(!u(o,d()))if(g(o))t.withCredentials=!0;else if(r){const e=r.findServerInfo(o);e?.webTierAuth&&(t.withCredentials=!0)}t.withCredentials&&(a.credentials="include",function(r){const t=e.request.crossOriginNoCorsDomains;if(t){let e=l(r);if(e)return e=e.toLowerCase(),!u(e,d())&&t[e]<Date.now()-36e5}return!1}(o)&&await async function(r){const t=e.request.crossOriginNoCorsDomains,s=l(r);t&&s&&(t[s.toLowerCase()]=Date.now());const o=p(r);r=o.path,"json"===o.query?.f&&(r+="?f=json");try{await fetch(r,{mode:"no-cors",credentials:"include"})}catch{}}(w?v(o,i):o))}let C,j,E=0,L=!1;y>0&&(E=setTimeout((()=>{L=!0,t.controller.abort()}),y));try{if("native-request-init"===n.responseType)j=a,j.url=o;else if("image"!==n.responseType||"default"!==a.cache||"GET"!==a.method||w||function(e){if(e)for(const r of Object.getOwnPropertyNames(e))if(e[r])return!0;return!1}(n.headers)||!i&&!t.useProxy&&P.proxyUrl&&!M(o)){if(U._beforeFetch&&await U._beforeFetch(o,a),C=await fetch(o,a),U._afterFetch&&await U._afterFetch(C),t.useProxy||function(e){const r=l(e);r&&!U._corsServers.includes(r)&&U._corsServers.push(r)}(o),"native"===n.responseType)j=C;else if("HEAD"!==a.method)if(C.ok){switch(m){case"array-buffer":j=await C.arrayBuffer();break;case"blob":case"image":j=await C.blob();break;default:j=await C.text()}if(E&&(clearTimeout(E),E=0),"json"===m||"xml"===m||"document"===m)if(j)switch(m){case"json":j=JSON.parse(j);break;case"xml":j=J(j,"application/xml");break;case"document":j=J(j,"text/html")}else j=null;if(j){if("array-buffer"===m||"blob"===m){const e=C.headers.get("Content-Type");if(e&&/application\/json|text\/plain/i.test(e)&&j["blob"===m?"size":"byteLength"]<=750)try{const e=await new Response(j).json();e.error&&(j=e)}catch{}}"image"===m&&j instanceof Blob&&(j=await K(URL.createObjectURL(j),t,!0))}}else{j=await C.text();try{j=JSON.parse(j)}catch{}}}else j=await K(o,t)}catch(e){if("AbortError"===e.name){if(L)throw new Error(x);throw c("Request canceled")}if(!(!C&&e instanceof TypeError&&P.proxyUrl)||n.body||"delete"===n.method||"head"===n.method||"post"===n.method||"put"===n.method||t.useProxy||M(o))throw e;t.redoRequest=!0,T({proxyUrl:P.proxyUrl,urlPrefix:l(o)??""})}finally{E&&clearTimeout(E)}return[C,j]}function J(e,r){let t;try{t=(new DOMParser).parseFromString(e,r)}catch{}if(!t||t.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return t}async function G(e,t,s){if(e.redoRequest)return e.redoRequest=!1,!1;const o=e.params.requestOptions;if(!t||"native"===o.responseType||"native-request-init"===o.responseType)return!0;let n,a;if(s&&(s.error?n=s.error:"error"===s.status&&Array.isArray(s.messages)&&(n={...s},n[I]=s,n.details=s.messages)),!n&&!t.ok)throw n=new Error(`Unable to load ${t.url} status: ${t.status}`),n[I]=s,n;let i,c=null;n&&(a=Number(n.code),c=n.hasOwnProperty("subcode")?Number(n.subcode):null,i=n.messageCode,i=i?.toUpperCase());const l=o.authMode;if(403===a&&(4===c||n.message?.toLowerCase().includes("ssl")&&!n.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&("no-prompt"!==l||498===a)&&void 0!==a&&H.has(a)&&!W(e.params.url)&&(403!==a||(!i||!R.has(i))&&(null==c||2===c&&e.credentialToken))){await $();try{const t=await r.getCredential(e.params.url,{error:B("request:server",n,e.params),prompt:"no-prompt"!==l,signal:e.controller.signal,token:e.credentialToken});return e.credential=t,e.credentialToken=t.token,e.useSSL=e.useSSL||t.ssl,!1}catch(r){if("no-prompt"===l)return e.credential=void 0,e.credentialToken=void 0,!1;n=r}}if(n)throw n;return!0}function K(e,r,t=!1){const s=r.controller.signal,o=new Image;return r.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous",o.alt="",o.fetchPriority=P.priority,o.src=e,E(o,e,t,s)}U._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"],U._beforeFetch=void 0,U._afterFetch=void 0;export{U as default,A as i,E as l,j as s};
