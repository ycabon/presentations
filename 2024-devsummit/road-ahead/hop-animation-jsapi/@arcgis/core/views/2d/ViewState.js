/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../geometry.js";import e from"../../Viewpoint.js";import{JSONSupport as r}from"../../core/JSONSupport.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import{t as o}from"../../chunks/common.js";import{a as i,r as a,s as c,t as u,f as l,b as m,i as p}from"../../chunks/mat2d.js";import{c as f}from"../../chunks/mat2df32.js";import{c as h}from"../../chunks/mat2df64.js";import{s as y,d as j,e as g,r as d,m as x}from"../../chunks/mat3.js";import{c as w}from"../../chunks/mat3f32.js";import{q as k,e as v,g as b,s as R,n as G,k as S,d as z,l as A,p as M,b as _,t as U,j as N}from"../../chunks/vec2.js";import{f as C}from"../../chunks/vec2f32.js";import{c as T,f as V}from"../../chunks/vec2f64.js";import{getClosestDenormalizedXToReference as F,getDenormalizedExtent as q}from"../../geometry/support/normalizeUtils.js";import L from"../../core/Collection.js";import{k as O,g as P,f as D,j as E}from"../../chunks/unitUtils.js";import I from"../../geometry/Extent.js";import B from"../../geometry/Geometry.js";import W from"../../geometry/Point.js";import{isLoaded as Q,canProjectWithoutEngine as H,load as J,project as K}from"../../geometry/projection.js";import X from"../../geometry/SpatialReference.js";import"../../chunks/ensureType.js";import"../../geometry/Multipoint.js";import"../../chunks/writer.js";import"../../chunks/zmUtils.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../core/Error.js";import"../../config.js";import"../../chunks/tracking.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/maybe.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/reader.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../Camera.js";import"../../CameraLayout.js";import"../../core/Clonable.js";import"../../chunks/Cyclical.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils7.js";import"../../chunks/utils8.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";function Y(t){return function(t){return t instanceof Float32Array&&t.length>=2}(t)||function(t){return Array.isArray(t)&&t.length>=2}(t)}const Z=96,$=39.37,tt=180/Math.PI;function et(t){return t.wkid?t:t.spatialReference||X.WGS84}function rt(t,e){return e.type?b(t,e.x,e.y):N(t,e)}function nt(t){return P(t)}function st(t,e){const r=Math.max(1,e[0]),n=Math.max(1,e[1]);return Math.max(t.width/r,t.height/n)*gt(t.spatialReference)}async function ot(t,e,r,n){let s,o;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(L.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const s=t.every((t=>"attributes"in t)),o=t.some((t=>!t.geometry));let i=t;if(s&&o&&e&&e.allLayerViews){const r=new Map;for(const e of t){const t=e.layer,n=r.get(t)||[],s=e.attributes[t.objectIdField];null!=s&&n.push(s),r.set(t,n)}const n=[];r.forEach(((t,r)=>{const s=e.allLayerViews.find((t=>t.layer.id===r.id));if(s&&"queryFeatures"in s){const e=r.createQuery();e.objectIds=t,e.returnGeometry=!0,n.push(s.queryFeatures(e))}}));const s=await Promise.all(n),o=[];for(const t of s)if(t&&t.features&&t.features.length)for(const e of t.features)null!=e.geometry&&o.push(e.geometry);i=o}for(const t of i)n=await ot(t,e,r,n);return n}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])s=new W(t);else if(t instanceof B)s=t;else if("geometry"in t)if(t.geometry)s=t.geometry;else if(t.layer){const r=t.layer,n=e.allLayerViews.find((t=>t.layer.id===r.id));if(n&&"queryFeatures"in n){const e=r.createQuery();e.objectIds=[t.attributes[r.objectIdField]],e.returnGeometry=!0;const o=await n.queryFeatures(e);s=o?.features?.[0]?.geometry}}if(null==s)return null;switch(s.type){case"point":o=new I({xmin:s.x,ymin:s.y,xmax:s.x,ymax:s.y,spatialReference:s.spatialReference});break;case"extent":case"multipoint":case"polygon":case"polyline":o=q(s);break;default:o=s.extent}if(!o)return null;Q()||H(o.spatialReference,r)||await J();const i=K(o,r);return i?n=n?n.union(i):i:null}function it(t,e){return D(et(t),e)?t:K(t,e)}async function at(t,r){if(!t||!r)return new e({targetGeometry:new W,scale:0,rotation:0});let n=r.spatialReference;const{constraints:s,padding:o,viewpoint:i,size:a}=r,c=[o?a[0]-o.left-o.right:a[0],o?a[1]-o.top-o.bottom:a[1]];let u=null;t instanceof e?u=t:t.viewpoint?u=t.viewpoint:t.target&&"esri.Viewpoint"===t.target.declaredClass&&(u=t.target);let l=null;u?.targetGeometry?l=u.targetGeometry:t instanceof I?l=t:(t||t&&("center"in t||"extent"in t||"target"in t))&&(l=await ot(t.center,r,n)||await ot(t.extent,r,n)||await ot(t.target,r,n)||await ot(t,r,n)),!l&&i?.targetGeometry?l=i.targetGeometry:!l&&r.extent&&(l=r.extent),n||(n=et(r.spatialReference||r.extent||l)),Q()||D(l.spatialReference,n)||H(l.spatialReference,n)||await J();const m=it("center"in l?l.center:l,n);!1!==r.pickClosestTarget&&"point"===m.type&&"point"===i.targetGeometry?.type&&(m.x=F(m.x,i.targetGeometry.x,m.spatialReference));let p=0;if(null!=u?.targetGeometry&&"point"===u.targetGeometry.type)p=u.scale;else if("scale"in t&&t.scale)p=t.scale;else if("zoom"in t&&-1!==t.zoom&&s&&s.effectiveLODs)p=s.zoomToScale(t.zoom);else if(Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height){const t=it(r.extent,n);p=null!=t?st(t,c):r.extent?st(r.extent,c):i.scale}else p=st(it(l.extent,n),c);const f=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&null!=t.layer?.minScale&&null!=t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,r=0;for(const n of t){const t=n.layer;t?.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,r=t.maxScale>r?t.maxScale:r)}return e&&r?{min:e,max:r}:null}}}(t.target??t);f&&(f.min&&f.min<p?p=f.min:f.max&&f.max>p&&(p=f.max));let h=0;u?h=u.rotation:t.hasOwnProperty("rotation")?h=t.rotation:i&&(h=i.rotation);let y=new e({targetGeometry:m,scale:p,rotation:h});return s&&(y=s.fit(y),s.constrainByGeometry(y),s.rotationEnabled||(y.rotation=i.rotation)),y}function ct(t,e){const r=t.targetGeometry,n=e.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function ut(t,e,r){return r?b(t,.5*(e[0]-r.right+r.left),.5*(e[1]-r.bottom+r.top)):v(t,e,.5)}const lt=function(){const t=T();return function(e,r,n){const s=r.targetGeometry;rt(t,s);const o=.5*ht(r);return e.xmin=t[0]-o*n[0],e.ymin=t[1]-o*n[1],e.xmax=t[0]+o*n[0],e.ymax=t[1]+o*n[1],e.spatialReference=s.spatialReference,e}}();function mt(t,e,r,n,s){return Rt(t,e,r.center),t.scale=st(r,n),s?.constraints?.constrain(t),t}const pt=function(){const t=T();return function(e,r,n){return M(e,function(t,e){return v(t,e,.5)}(e,r),ut(t,r,n))}}(),ft=function(){const t=h(),e=T();return function(r,n,s,o){const i=ht(n),c=jt(n);return b(e,i,i),m(t,e),a(t,t,c),u(t,t,pt(e,s,o)),u(t,t,[0,o.top-o.bottom]),b(r,t[4],t[5])}}();function ht(t){return t.scale*yt(t.targetGeometry?.spatialReference)}function yt(t){return null!=t&&O(t)?1/(nt(t)*$*Z):1}function jt(t){return o(t.rotation)||0}function gt(t){return O(t)?nt(t)*$*Z:1}const dt=function(){const t=T(),e=T(),r=T();return function(n,s,o,l,m,p){return k(t,s),v(e,o,.5*p),b(r,1/l*p,-1/l*p),i(n,e),m&&a(n,n,m),c(n,n,r),u(n,n,t),n}}(),xt=function(){const t=T();return function(e,r,n,s){const o=ht(r),i=jt(r);return rt(t,r.targetGeometry),dt(e,t,n,o,i,s)}}(),wt=function(){const t=T();return function(e,r,n,s){const o=ht(r);return rt(t,r.targetGeometry),dt(e,t,n,o,0,s)}}();function kt(t){const e=E(t);return e?e.valid[1]-e.valid[0]:0}const vt=function(){const t=T(),e=T(),r=[0,0,0];return function(n,s,o){R(t,n,s),G(t,t),R(e,n,o),G(e,e),S(r,t,e);let i=Math.acos(z(t,e)/(A(t)*A(e)))*tt;return r[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),bt=function(){const t=T();return function(e,r,n,s){const o=e.targetGeometry;return ct(e,r),ft(t,r,n,s),o.x+=t[0],o.y+=t[1],e}}(),Rt=function(t,e,r){ct(t,e);const n=t.targetGeometry;return n.x=r.x,n.y=r.y,n.spatialReference=r.spatialReference,t},Gt=function(){const t=T();return function(e,r,n,s,o){o||(o="center"),M(t,n,s),v(t,t,.5);const i=t[0],a=t[1];switch(o){case"center":b(t,0,0);break;case"left":b(t,-i,0);break;case"top":b(t,0,a);break;case"right":b(t,i,0);break;case"bottom":b(t,0,-a);break;case"top-left":b(t,-i,a);break;case"bottom-left":b(t,-i,-a);break;case"top-right":b(t,i,a);break;case"bottom-right":b(t,i,-a)}return Tt(e,r,t),e}}();function St(t,e,r){return ct(t,e),t.rotation+=r,t}function zt(t,e,r){return ct(t,e),t.rotation=r,t}const At=function(){const t=T();return function(e,r,n,s,o){return ct(e,r),isNaN(n)||0===n||(Nt(t,s,r,o),e.scale=r.scale*n,Ct(t,t,e,o),Tt(e,e,b(t,t[0]-s[0],s[1]-t[1]))),e}}();function Mt(t,e,r){return ct(t,e),t.scale=r,t}const _t=function(){const t=T();return function(e,r,n,s,o,i){return ct(e,r),isNaN(n)||0===n||(Nt(t,o,r,i),e.scale=r.scale*n,e.rotation+=s,Ct(t,t,e,i),Tt(e,e,b(t,t[0]-o[0],o[1]-t[1]))),e}}(),Ut=function(){const t=T(),e=T();return function(r,n,s,o,i,a,c){return pt(e,a,c),_(t,i,e),o?_t(r,n,s,o,t,a):At(r,n,s,t,a)}}(),Nt=function(){const t=h();return function(e,r,n,s){return U(e,r,function(t,e,r,n){return xt(t,e,r,1),p(t,t)}(t,n,s))}}(),Ct=function(){const t=h();return function(e,r,n,s){return U(e,r,xt(t,n,s,1))}}(),Tt=function(){const t=T(),e=h();return function(r,n,s){ct(r,n);const o=ht(n),i=r.targetGeometry;return l(e,jt(n)),c(e,e,V(o,o)),U(t,s,e),i.x+=t[0],i.y+=t[1],r}}();var Vt;const Ft=[0,0];let qt=Vt=class extends r{constructor(t){super(t),this._viewpoint2D={center:T(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new I,this.id=0,this.inverseTransform=h(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=h(),this.transformNoRotation=h(),this.displayMat3=w(),this.displayViewMat3=w(),this.viewMat3=w(),this.viewMat2d=f(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=ct(r,t.viewpoint),this._set("size",N(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Vt({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return Y(e)?U(t,e,this.inverseTransform):(Ft[0]=e,Ft[1]=r,U(t,Ft,this.inverseTransform))}toScreen(t,e,r){return Y(e)?U(t,e,this.transform):(Ft[0]=e,Ft[1]=r,U(t,Ft,this.transform))}toScreenNoRotation(t,e,r){return Y(e)?U(t,e,this.transformNoRotation):(Ft[0]=e,Ft[1]=r,U(t,Ft,this.transformNoRotation))}toScreenClosest(t,e,r){Y(e)?(Ft[0]=e[0],Ft[1]=e[1]):(Ft[0]=e,Ft[1]=r);const[n]=Ft,{center:s,extent:o,spatialReference:i,transform:a}=this;return(n<o.xmin||n>o.xmax)&&(Ft[0]=F(n,s[0],i)),U(t,Ft,a)}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,n=this._get("pixelRatio")||1,s=this._get("size");return dt(t,r,s,e,0,n),t}_update(){const{center:t,spatialReference:r,scale:n,rotation:s}=this._viewpoint2D,c=this._get("pixelRatio")||1,l=this._get("size"),m=new e({targetGeometry:new W(t[0],t[1],r),scale:n,rotation:s});if(this._set("viewpoint",m),!l||!r||!n)return;this.resolution=ht(m),this.rotation=s,this.scale=n,this.spatialReference=r,N(this.center,t);const f=0!==l[0]?2/l[0]:0,h=0!==l[1]?-2/l[1]:0;y(this.displayMat3,f,0,0,0,h,0,-1,1,1);const w=j(this.viewMat3),k=C(l[0]/2,l[1]/2),v=C(-l[0]/2,-l[1]/2),b=o(s);g(w,w,k),d(w,w,b),g(w,w,v),x(this.displayViewMat3,this.displayMat3,w);const R=i(this.viewMat2d,k);return a(R,R,b),u(R,R,v),lt(this.extent,m,l),xt(this.transform,m,l,c),p(this.inverseTransform,this.transform),wt(this.transformNoRotation,m,l,c),this.worldScreenWidth=function(t,e){return Math.round(kt(t)/e)}(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};t([n({readOnly:!0})],qt.prototype,"id",void 0),t([n({value:1,json:{write:!0}})],qt.prototype,"pixelRatio",null),t([n({json:{write:!0}})],qt.prototype,"size",null),t([n()],qt.prototype,"spatialReference",void 0),t([n({type:e,json:{write:!0}})],qt.prototype,"viewpoint",null),qt=Vt=t([s("esri.views.2d.ViewState")],qt);const Lt=qt;export{gt as a,pt as b,ut as c,vt as d,Lt as default,yt as e,ct as f,kt as g,at as h,bt as i,Rt as j,mt as k,zt as l,Mt as m,st as n,Gt as o,Ut as p,St as r,_t as s,Tt as t};
