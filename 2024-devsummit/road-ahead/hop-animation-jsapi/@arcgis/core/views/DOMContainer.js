/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../chunks/tslib.es6.js";import"../intl.js";import{b as e,r as s,e as i}from"../chunks/domUtils.js";import{o as r}from"../core/promiseUtils.js";import{h as o}from"../core/lang.js";import{L as n}from"../chunks/Logger.js";import{d as a,r as h}from"../chunks/maybe.js";import{watch as d,initial as c,whenOnce as l}from"../core/reactiveUtils.js";import{addFrameTask as u}from"../core/scheduling.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import f from"../core/Accessor.js";import g from"../core/Collection.js";import{U as _}from"../chunks/UpdatingHandles.js";import{c as y}from"../chunks/projector.js";import{o as v}from"../chunks/locale.js";import{f as j}from"../chunks/messages.js";import"../chunks/date.js";import"../chunks/jsonMap.js";import"../config.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"../core/JSONSupport.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/ensureType.js";import"../chunks/ObservableBase.js";import"../chunks/assets.js";import"../chunks/asyncUtils.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../chunks/widgetUtils.js";let k=class extends f{constructor(){super(...arguments),this.items=new g,this._watchUpdatingTracking=new _,this._callbacks=new Map,this._projector=y(),this._hiddenProjector=y()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const t=document.createElement("div");t.className="esri-overlay-surface",this._set("surface",t),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),t.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange((()=>this.items),(t=>{for(const e of t.added){const t=()=>e.render();this._callbacks.set(e,t),this._projector.append(this.surface,t)}for(const e of t.removed){const t=this._projector.detach(this._callbacks.get(e));this.surface.removeChild(t.domNode),this._callbacks.delete(e)}}))}addItem(t){this.items.add(t)}removeItem(t){this.items.remove(t)}destroy(){this.items.removeAll(),this._callbacks.forEach((t=>this._projector.detach(t))),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(t){const e=this._hiddenSurface,s=this._hiddenProjector;let i;const r=()=>(i=t.render(),i);s.append(e,r),s.renderNow();const o={left:0,top:0,right:0,bottom:0};if(i?.domNode){const t=i.domNode.getBoundingClientRect();o.left=t.left,o.top=t.top,o.right=t.right,o.bottom=t.bottom}for(s.detach(r);e.firstChild;)e.removeChild(e.firstChild);return o}overlaps(t,e){const s=this.computeBoundingRect(t),i=this.computeBoundingRect(e);return Math.max(s.left,i.left)<=Math.min(s.right,i.right)&&Math.max(s.top,i.top)<=Math.min(s.bottom,i.bottom)}get hasVisibleItems(){return this.items.some((t=>t.visible))}async prepare(){await document.fonts.load(this._fontString()).catch((()=>{}))}renderCanvas(t,e){const s=!!e?.disableDecorations;if(!this.items.some((t=>t.visible&&!(s&&t.isDecoration))))return;const i=t.getContext("2d");i.save(),i.font=this._fontString(),this.items.forEach((t=>{s&&t.isDecoration||(i.save(),t.renderCanvas(i),i.restore())})),i.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};t([p({readOnly:!0})],k.prototype,"surface",void 0),t([p({readOnly:!0})],k.prototype,"items",void 0),t([p({readOnly:!0})],k.prototype,"needsRender",null),t([p({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0),t([p({readOnly:!0})],k.prototype,"updating",null),k=t([m("esri.views.overlay.ViewOverlay")],k);const w=k,C=[0,0];function b(t){const e=(t.ownerDocument||window.document).defaultView,s=t.getBoundingClientRect();return C[0]=s.left+(e?.pageXOffset??0),C[1]=s.top+(e?.pageYOffset??0),C}function O(t){t&&(i(t),t.parentNode&&t.parentNode.removeChild(t))}const H=750,R=i=>{let f=class extends i{constructor(...t){super(...t),this._freqInfo={freq:16,time:H},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([d((()=>this.cursor),(t=>{const{surface:e}=this;e&&e.setAttribute("data-cursor",t)})),d((()=>this.navigating),(t=>{const{surface:e}=this;e&&e.setAttribute("data-navigating",t.toString())}))])}initialize(){const t=o("mac"),e=async()=>{t&&(await l((()=>this.ready)),this.messagesCommon=await j("esri/t9n/common").catch((()=>{})))};e(),this.addHandles([d((()=>this.ui),((t,e)=>this._handleUIChange(t,e)),c),this.on("focus",(()=>this.notifyChange("focused"))),this.on("blur",(()=>this.notifyChange("focused"))),v(e),d((()=>[this.surface,this.messagesCommon]),(()=>{t&&this.surface?.setAttribute("aria-label",this.messagesCommon?.ariaLabels?.navigationMacVoiceOver??"")}))])}destroy(){this.destroyed||(this.ui=a(this.ui),this.container=null)}get container(){return this._get("container")??null}set container(t){const i=this._get("container"),r=e(t);if(r||"string"!=typeof t||n.getLogger(this).error("#container",`element with id '${t}' not found`),i===r)return;if(this._stopMeasuring(),i&&(i.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(O(this.root),this._set("root",null)),this.userContent&&(s(this.userContent,i),O(this.userContent),this._set("userContent",null))),!r)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);r.classList.add("esri-view");const o=document.createElement("div");o.className="esri-view-user-storage",s(r,o),r.appendChild(o),this._set("userContent",o);const a=document.createElement("div");a.className="esri-view-root",r.insertBefore(a,r.firstChild),this._set("root",a);const c=document.createElement("div");c.className="esri-view-surface",c.setAttribute("role","application"),c.tabIndex=0,a.appendChild(c),this._set("surface",c);const l=new w;a.appendChild(l.surface),this._set("overlay",l),this.addHandles(d((()=>l.needsRender),(t=>{t&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=u({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=h(this._overlayRenderTaskHandle)}))),this.forceDOMReadyCycle(),this._set("container",r),this._startMeasuring()}get focused(){const t=document.activeElement===this.surface;return document.hasFocus()&&t}get size(){return[this.width,this.height]}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(t,e,s){const i=this.position;return t-=i?i[0]:0,e-=i?i[1]:0,s?(s[0]=t,s[1]=e):s=[t,e],s}containerToPage(t,e,s){const i=this.position;return t+=i?i[0]:0,e+=i?i[1]:0,s?(s[0]=t,s[1]=e):s=[t,e],s}_handleUIChange(t,e){this.removeHandles("ui"),e&&e!==t&&e.destroy(),t&&(t.view=this,this.addHandles(d((()=>this.root),(e=>{t.container=e?function(t){const e=document.createElement("div");return t.appendChild(e),e}(e):null}),c),"ui")),this._set("ui",t)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const t=this._freqInfo;t.freq=16,t.time=H,this.addHandles([r(window,"resize",(()=>{t.freq=16,t.time=H})),u({prepare:t=>{const e=this._measure(),s=this._freqInfo;if(s.time+=t.deltaTime,e&&(s.freq=16,this._get("resizing")||this._set("resizing",!0)),s.time<s.freq)return;s.time=0;const i=this._position();s.freq=i||e?16:Math.min(H,2*s.freq),!e&&s.freq>=512&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const t=this.container,e=t?t.clientWidth:0,s=t?t.clientHeight:0;if(0===e||0===s)return this.suspended||this._set("suspended",!0),!1;const i=this.width,r=this.height;return e===i&&s===r?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",e),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:r,width:e,height:s}),!0)}_position(){const t=this.container,e=this.position,s=t&&b(t);return!(!s||e&&s[0]===e[0]&&s[1]===e[1]||(this._set("position",[s[0],s[1]]),0))}forceDOMReadyCycle(){}};return t([p()],f.prototype,"container",null),t([p({readOnly:!0})],f.prototype,"focused",null),t([p({readOnly:!0})],f.prototype,"height",void 0),t([p()],f.prototype,"messagesCommon",void 0),t([p({type:w})],f.prototype,"overlay",void 0),t([p({readOnly:!0})],f.prototype,"position",void 0),t([p({readOnly:!0})],f.prototype,"resizing",void 0),t([p({readOnly:!0})],f.prototype,"root",void 0),t([p({value:null,readOnly:!0})],f.prototype,"size",null),t([p({readOnly:!0})],f.prototype,"surface",void 0),t([p({readOnly:!0})],f.prototype,"suspended",void 0),t([p()],f.prototype,"ui",void 0),t([p({readOnly:!0})],f.prototype,"userContent",void 0),t([p({readOnly:!0})],f.prototype,"width",void 0),t([p()],f.prototype,"widthBreakpoint",void 0),f=t([m("esri.views.DOMContainer")],f),f};export{R as DOMContainer};
