/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import"../geometry.js";import i from"../Viewpoint.js";import r,{O as s}from"../core/Collection.js";import{b as n}from"../chunks/domUtils.js";import a from"../core/Error.js";import{createAbortError as o,isAborted as l,createResolver as c,isAbortError as h,after as d,onAbort as u,throwIfAbortError as p,throwIfAborted as m,whenOrAbort as _,isPromiseLike as g,o as f}from"../core/promiseUtils.js";import{m as y,d as v,h as x}from"../chunks/handleUtils.js";import{clone as w,h as b,r as C,e as T,s as P,X as S,c as R,x as O,C as E}from"../core/lang.js";import{L as A}from"../chunks/Logger.js";import{r as M,d as D,a as I,c as L,f as N,b as F,g as V}from"../chunks/maybe.js";import{watch as U,syncAndInitial as j,initial as k,sync as q,whenOnce as z,on as B,when as H}from"../core/reactiveUtils.js";import{schedule as G,s as W,M as $,m as Q,addFrameTask as X,P as Y,a as Z,setFrameDuration as K}from"../core/scheduling.js";import{b as J,c as ee,s as te,g as ie,e as re,d as se}from"../chunks/screenUtils.js";import{initialize as ne}from"../core/workers/workers.js";import{property as ae}from"../core/accessorSupport/decorators/property.js";import{cast as oe}from"../core/accessorSupport/decorators/cast.js";import{subclass as le}from"../core/accessorSupport/decorators/subclass.js";import{a as ce,s as he,e as de,b as ue}from"../chunks/ensureType.js";import pe,{O as me,f as _e,g as ge,b as fe,v as ye}from"../core/Accessor.js";import{g as ve}from"../chunks/utils.js";import{f as xe,c as we,a as be,d as Ce,b as Te,U as Pe,e as Se,Z as Re,u as Oe}from"../chunks/vec3f64.js";import{o as Ee}from"../chunks/GraphicsCollection.js";import Ae from"../geometry/HeightModelInfo.js";import{canProjectToWGS84ComparableLonLat as Me,isLoadedOrLoadFor as De,requiresLoad as Ie,projectWithoutEngine as Le,canProjectWithoutEngine as Ne,project as Fe}from"../geometry/projection.js";import{p as Ve}from"../chunks/projectBoundingRect.js";import{p as Ue}from"../chunks/projectPointToVector.js";import{c as je,e as ke,C as qe,w as ze,o as Be,a as He,l as Ge,f as We,G as $e,k as Qe,h as Xe,n as Ye,F as Ze,E as Ke,b as Je,d as et,p as tt,m as it,g as rt,y as st,t as nt}from"../chunks/aaBoundingRect.js";import{e as at,c as ot,a as lt,t as ct,h as ht,B as dt}from"../chunks/boundedPlane.js";import{c as ut,v as pt,r as mt,R as _t}from"../chunks/RenderCoordsHelper.js";import{d as gt}from"../chunks/scaleUtils.js";import{j as ft,q as yt,v as vt,w as xt,x as wt,y as bt,z as Ct}from"../chunks/layerUtils2.js";import Tt,{A as Pt}from"./View.js";import{BreakpointsOwner as St}from"./BreakpointsOwner.js";import{DOMContainer as Rt}from"./DOMContainer.js";import Ot from"./GroundView.js";import{PopupView as Et}from"./PopupView.js";import At from"./ViewAnimation.js";import{V as Mt,s as Dt,v as It}from"../chunks/ViewingMode.js";import{c as Lt}from"../chunks/asyncUtils.js";import{Clonable as Nt}from"../core/Clonable.js";import{c as Ft,d as Vt,r as Ut,l as jt,u as kt,a as qt,e as zt,v as Bt}from"../chunks/mathUtils.js";import{h as Ht,r as Gt,Q as Wt,af as $t,O as Qt,g as Xt,f as Yt,aa as Zt,t as Kt,s as Jt}from"../chunks/unitUtils.js";import{f as ei,b as ti,a as ii,g as ri,d as si}from"../chunks/mathUtils2.js";import{n as ni}from"../chunks/compilerUtils.js";import ai from"./3d/environment/SunLighting.js";import oi from"./3d/environment/VirtualLighting.js";import li from"../webscene/Environment.js";import ci from"../webscene/SunLighting.js";import hi from"../webscene/VirtualLighting.js";import di from"../core/Evented.js";import{s as ui,l as pi,j as mi,n as _i,d as gi,b as fi,a as yi,h as vi,i as xi,e as wi,I as bi,v as Ci,p as Ti,c as Pi,x as Si,g as Ri,w as Oi,k as Ei,y as Ai,m as Mi,G as Di,f as Ii,o as Li,z as Ni,B as Fi,t as Vi,J as Ui}from"../chunks/vec3.js";import{p as ji}from"../chunks/projectPointToWGS84ComparableLonLat.js";import{u as ki}from"../chunks/colorUtils2.js";import qi from"../core/Handles.js";import{g as zi,j as Bi,y as Hi,x as Gi,s as Wi}from"../chunks/vec2.js";import{s as $i,t as Qi,b as Xi,h as Yi,c as Zi,v as Ki,l as Ji,e as er}from"../chunks/vec4.js";import{c as tr,Z as ir,f as rr,a as sr}from"../chunks/vec4f64.js";import{c as nr,f as ar,Z as or}from"../chunks/vec2f64.js";import{A as lr,D as cr,c as hr,q as dr,m as ur,r as pr,a as mr,e as _r,z as gr,v as fr,k as yr,i as vr,p as xr}from"../chunks/mat4.js";import{c as wr,f as br,I as Cr}from"../chunks/mat4f64.js";import{a as Tr,T as Pr,g as Sr,P as Rr,M as Or,m as Er,A as Ar,F as Mr,I as Dr,N as Ir,h as Lr,b as Nr,d as Fr,V as Vr,c as Ur,n as jr,i as kr}from"../chunks/IntegerPassUniform.js";import{g as qr,M as zr,b as Br,a as Hr,F as Gr,j as Wr,d as $r,R as Qr,o as Xr,P as Yr,l as Zr,aj as Kr,C as Jr,I as es,a0 as ts,$ as is,D as rs,n as ss,r as ns,T as as,a3 as os,U as ls,ad as cs,h as hs,S as ds,E as us,v as ps,x as ms,w as _s,af as gs,i as fs,c as ys,N as vs,av as xs,Z as ws,aw as bs,y as Cs,m as Ts,s as Ps,ax as Ss,q as Rs,k as Os,Y as Es,X as As,_ as Ms,ay as Ds,Q as Is}from"../chunks/StencilUtils.js";import{g as Ls,C as Ns,h as Fs,B as Vs,i as Us,j as js,k as ks,l as qs,S as zs,O as Bs,m as Hs,T as Gs,n as Ws,o as $s,p as Qs,P as Xs,M as Ys,q as Zs,r as Ks,L as Js,b as en,c as tn,G as rn,R as sn,s as nn,t as an,u as on,v as ln,w as cn,x as hn,H as dn,y as un,z as pn,A as mn,E as _n,I as gn,J as fn,K as yn,N as vn,Q as xn,U as wn,V as bn,X as Cn}from"../chunks/RenderGeometry.js";import{g as Tn,N as Pn}from"../chunks/interfaces5.js";import{V as Sn}from"../chunks/VertexAttribute.js";import{D as Rn,A as On,c as En,g as An,h as Mn,U as Dn,j as In,k as Ln,R as Nn,e as Fn,l as Vn,f as Un}from"../chunks/Material.js";import{j as jn,k as kn,m as qn,i as zn,e as Bn,b as Hn,U as Gn,T as Wn,a as $n,n as Qn,f as Xn,l as Yn,S as Zn,P as Kn,D as Jn}from"../chunks/enums.js";import{m as ea,s as ta,e as ia,i as ra,l as sa,d as na,T as aa,f as oa,o as la,c as ca,a as ha,h as da}from"../chunks/OrderIndependentTransparency.js";import{p as ua,S as pa}from"../chunks/ShaderTechniqueConfiguration.js";import{ColorFormat as ma,M as _a,A as ga,DepthFormat as fa,ManagedFBO as ya}from"./3d/webgl/ManagedFBO.js";import{e as va,P as xa,n as wa,m as ba,f as Ca,C as Ta,h as Pa,i as Sa,j as Ra,k as Oa,R as Ea,I as Aa,s as Ma,l as Da,o as Ia,p as La,q as Na,u as Fa,E as Va,c as Ua,r as ja,L as ka}from"../chunks/EllipsoidMode.js";import{a as qa,S as za,C as Ba,d as Ha,B as Ga,b as Wa,e as $a,i as Qa,f as Xa,g as Ya,h as Za}from"../chunks/RenderPlugin.js";import Ka from"../webscene/background/ColorBackground.js";import{m as Ja,R as eo,n as to,o as io,E as ro,i as so,h as no,j as ao,k as oo,p as lo,l as co,M as ho,q as uo,r as po,C as mo,s as _o,b as go,F as fo,t as yo,S as vo}from"../chunks/objectResourceUtils.js";import{f as xo,t as wo,i as bo,b as Co,c as To}from"../chunks/mat3.js";import{f as Po,z as So,a as Ro}from"../chunks/vec3f32.js";import{c as Oo,a as Eo}from"../chunks/mat3f64.js";import{F as Ao,e as Mo,a as Do,R as Io}from"../chunks/FramebufferObject.js";import{a as Lo,v as No,T as Fo,b as Vo,u as Uo}from"../chunks/Texture.js";import{T as jo,Y as ko,n as qo,I as zo,a as Bo}from"../chunks/Scheduler.js";import{b as Ho}from"../chunks/weather.js";import{T as Go,O as Wo,V as $o,u as Qo}from"../chunks/OutputHighlight.glsl.js";import{g as Xo}from"../chunks/glUtil.js";import{n as Yo}from"../chunks/InterleavedLayout.js";import{p as Zo}from"../chunks/GeometryUtil.js";import{V as Ko,H as Jo}from"../chunks/VertexArrayObject2.js";import{B as el}from"../chunks/BufferObject.js";import{p as tl,a as il}from"../chunks/Util.js";import{U as rl}from"../chunks/UpdatingHandles.js";import{f as sl,g as nl}from"../chunks/assets.js";import{p as al}from"../chunks/earthUtils.js";import{b as ol,d as ll,e as cl,C as hl,a as dl,f as ul}from"../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import{k as pl,h as ml,l as _l,m as gl,t as fl,g as yl,b as vl,n as xl,c as wl,a as bl}from"../chunks/sphere.js";import{e as Cl,E as Tl,b as Pl,v as Sl,h as Rl,a as Ol,m as El,s as Al,M as Ml,y as Dl,g as Il,j as Ll,P as Nl,Q as Fl,d as Vl,G as Ul,I as jl}from"../chunks/plane.js";import{z as kl,V as ql,e as zl,F as Bl,t as Hl,B as Gl,N as Wl,E as $l}from"../chunks/ElevationUpdateEvent.js";import{m as Ql,n as Xl,e as Yl,i as Zl,t as Kl,j as Jl,o as ec,h as tc,f as ic,O as rc,p as sc,s as nc,z as ac,q as oc,r as lc,l as cc}from"../chunks/cameraUtils.js";import{p as hc,A as dc,E as uc,q as pc,e as mc,s as _c,a as gc,i as fc,t as yc,o as vc,D as xc,B as wc,I as bc,P as Cc,S as Tc,c as Pc,d as Sc,n as Rc,h as Oc,j as Ec,u as Ac,v as Mc,l as Dc}from"../chunks/WebGLRequirements.js";import{C as Ic,P as Lc}from"../chunks/Camera.js";import{n as Nc,d as Fc,S as Vc,i as Uc,I as jc,s as kc,c as qc}from"../chunks/Intersector2.js";import{b as zc,C as Bc}from"../chunks/Cyclical.js";import{c as Hc,f as Gc,d as Wc}from"../chunks/ray.js";import{t as $c,b as Qc,a as Xc}from"../chunks/verticalOffsetUtils.js";import{I as Yc,a as Zc,V as Kc}from"../chunks/InputManager.js";import Jc from"../geometry/Extent.js";import eh from"../geometry/Point.js";import{P as th,e as ih,l as rh,j as sh,m as nh,i as ah,n as oh,o as lh,a as ch,p as hh,k as dh,q as uh,h as ph}from"../chunks/frustum.js";import{create as mh,fromCamera as _h,toCameraSync as gh}from"../chunks/viewpointUtils.js";import{P as fh}from"../chunks/PropertiesPool.js";import{R as yh}from"../chunks/RenderState.js";import{F as vh,M as xh,Z as wh,R as bh,P as Ch}from"../chunks/ZoomMomentumEstimator.js";import{d as Th}from"../chunks/debugFlags2.js";import{H as Ph,S as Sh}from"../chunks/HUDMaterial.js";import{F as Rh,V as Oh}from"../chunks/FeatureTileDescriptor3D.js";import{a as Eh}from"../chunks/triangle.js";import{a as Ah,b as Mh,j as Dh,p as Ih,f as Lh}from"../chunks/projectBuffer.js";import{c as Nh,t as Fh,h as Vh}from"../chunks/hitTest.js";import Uh from"../geometry/SpatialReference.js";import{E as jh}from"../chunks/ElevationRange.js";import{g as kh}from"../chunks/ElevationProvider.js";import qh from"../Color.js";import{getGeometryServiceURL as zh}from"../chunks/geometryServiceUtils.js";import{p as Bh}from"../chunks/project.js";import Hh from"../rest/support/ProjectParameters.js";import{h as Gh}from"../chunks/hitTestSelectUtils.js";import{signal as Wh}from"../core/signal.js";import{S as $h,a as Qh,i as Xh,b as Yh,d as Zh,r as Kh,T as Jh,w as ed,I as td,e as id,N as rd,o as sd,f as nd,n as ad,h as od,j as ld,k as cd,l as hd,m as dd,p as ud,q as pd,s as md,u as _d,x as gd,y as fd,z as yd,A as vd,B as xd,C as wd,D as bd,E as Cd,F as Td,G as Pd,H as Sd,J as Rd,K as Od,L as Ed,M as Ad,O as Md,P as Dd,Q as Id,R as Ld,c as Nd}from"../chunks/terrainUtils.js";import Fd from"./3d/support/SceneViewPerformanceInfo.js";import{l as Vd,D as Ud,o as jd}from"../chunks/DefaultMaterial_COLOR_GAMMA.js";import{isSVG as kd}from"../core/urlUtils.js";import qd from"../Graphic.js";import"../symbols.js";import zd from"../symbols/PointSymbol3D.js";import Bd from"../symbols/IconSymbol3DLayer.js";import Hd from"../symbols/TextSymbol3DLayer.js";import{C as Gd}from"../chunks/CollectionFlattener.js";import{p as Wd}from"../chunks/projectVectorToVector.js";import{isRefreshableLayer as $d}from"../layers/mixins/RefreshableLayer.js";import{E as Qd}from"../chunks/ElevationQueryTileCache.js";import{a as Xd,E as Yd}from"../chunks/LercDecoder.js";import{a as Zd,R as Kd,p as Jd}from"../chunks/RenderableTile.js";import{E as eu}from"../chunks/ElevationSamplerData.js";import{e as tu,w as iu,g as ru,a as su,p as nu,b as au,c as ou,m as lu,t as cu,d as hu,f as du}from"../chunks/TerrainConst.js";import{y2lat as uu}from"../geometry/support/webMercatorUtils.js";import{b as pu,S as mu,C as _u,A as gu,D as fu,R as yu}from"../chunks/basicInterfaces.js";import{k as vu,J as xu,f as wu,c as bu,x as Cu}from"../chunks/aaBoundingBox.js";import{d as Tu,a as Pu}from"../chunks/Normals.js";import{g as Su}from"../chunks/common.js";import{c as Ru,h as Ou,g as Eu,f as Au,e as Mu,a as Du,b as Iu}from"../chunks/rasterUtils.js";import{n as Lu}from"../chunks/DoubleArray.js";import{b as Nu,o as Fu}from"../chunks/BufferView.js";import"../chunks/TileStrategy.js";import{T as Vu}from"../chunks/TileKey2.js";import Uu from"./2d/ViewState.js";import{S as ju}from"../chunks/StyleDefinition.js";import{T as ku,l as qu}from"../chunks/resources.js";import{V as zu,A as Bu}from"../chunks/Attribute.js";import{T as Hu}from"../chunks/TilingScheme.js";import{j as Gu,O as Wu,P as $u,k as Qu,l as Xu,U as Yu}from"../chunks/RibbonLineMaterial.js";import{C as Zu}from"../chunks/ContentObject.js";import{c as Ku,a as Ju}from"../chunks/Indices.js";import{b as ep}from"../chunks/vec32.js";import{C as tp,e as ip}from"../chunks/symbolColorUtils.js";import{c as rp}from"../chunks/orientedBoundingBox.js";import{c as sp}from"../chunks/quat.js";import{c as np}from"../chunks/quatf64.js";import{a as ap,c as op}from"../chunks/mat3f32.js";import{p as lp,u as cp}from"../chunks/floatRGBA.js";import{B as hp}from"../chunks/BindType.js";import{d as dp,E as up,f as pp,V as mp,g as _p,h as gp,R as fp,S as yp}from"../chunks/edgeProcessing.js";import{V as vp}from"../chunks/VertexArrayObject.js";import{O as xp}from"../chunks/Octree.js";import{r as wp}from"../chunks/requestImageUtils.js";import"../chunks/tracking.js";import{C as bp}from"../chunks/CameraSpace.glsl.js";import{B as Cp}from"../chunks/Geometry.js";import{T as Tp}from"../chunks/edgeUtils.js";import{E as Pp}from"../chunks/EdgeWorkerHandle.js";import{h as Sp}from"../chunks/testSVGPremultipliedAlpha.js";import{R as Rp,A as Op}from"../chunks/RenderingContext.js";import{c as Ep}from"../chunks/imageUtils.js";import{c as Ap}from"../chunks/capabilities.js";import{o as Mp}from"../chunks/layerViewUtils.js";import{i as Dp,d as Ip}from"../chunks/screenUtils2.js";import{i as Lp}from"../chunks/spatialReferenceSupport.js";import Np from"./ui/DefaultUI.js";import"../CameraLayout.js";import"../chunks/metadata.js";import"../chunks/ObservableBase.js";import"../config.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/jsonMap.js";import"../request.js";import"../kernel.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/coordsUtils.js";import"../chunks/Axis.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/date.js";import"../chunks/locale.js";import"../chunks/timeZoneUtils.js";import"../chunks/datetime.js";import"../chunks/messages.js";import"../chunks/collectionUtils.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/geodesicConstants.js";import"../chunks/lineSegment.js";import"../chunks/spatialReferenceEllipsoidUtils.js";import"../chunks/projectVectorToPoint.js";import"../Map.js";import"../Basemap.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/loadAll.js";import"../portal/Portal.js";import"../portal/PortalGroup.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/persistableUrlUtils.js";import"../support/BasemapStyle.js";import"../chunks/writeUtils.js";import"../Ground.js";import"../chunks/enumeration.js";import"../chunks/opacityUtils.js";import"../chunks/colorUtils.js";import"../chunks/editableLayers.js";import"../chunks/infoFor3D.js";import"../chunks/basemapUtils.js";import"../chunks/utils3.js";import"../chunks/collectionUtils2.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../core/Identifiable.js";import"../support/TablesMixin.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"./BasemapView.js";import"./Magnifier.js";import"../chunks/ReactiveMap.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/FullTextSearch.js";import"../chunks/spatialRelationships.js";import"../rest/support/StatisticDefinition.js";import"./Theme.js";import"../chunks/ViewEvents.js";import"../chunks/IViewEvents.js";import"../chunks/interfaces2.js";import"./input/Input.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/Navigation.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/heightModelInfoUtils.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/projectionUtils.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../core/sql.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils4.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils5.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/projector.js";import"../chunks/widgetUtils.js";import"../layers/support/ElevationSampler.js";import"../chunks/dehydratedPoint.js";import"../chunks/computeTranslationToOriginAndRotation.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"../chunks/TileKey.js";import"./3d/environment/SunnyWeather.js";import"../chunks/lightingTypes.js";import"../webscene/background/Background.js";import"./3d/environment/CloudyWeather.js";import"./3d/environment/FoggyWeather.js";import"./3d/environment/RainyWeather.js";import"./3d/environment/SnowyWeather.js";import"../chunks/projectVectorToWGS84ComparableLonLat.js";import"../chunks/doublePrecisionUtils.js";import"../chunks/lengthUtils.js";import"../chunks/axisAngleDegrees.js";import"../chunks/NestedMap.js";import"../chunks/Intersector.js";import"../chunks/MemCache.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/hydratedFeatures.js";import"../chunks/labelUtils.js";import"../chunks/devEnvironmentUtils.js";import"../chunks/resourceUtils3.js";import"../chunks/vec2f32.js";import"../chunks/Version.js";import"../chunks/GLTextureMaterial.js";import"../chunks/DefaultBufferWriter.js";import"../chunks/VerticalOffset.glsl.js";import"../chunks/debugFlags.js";import"../chunks/types.js";import"../chunks/_commonjsHelpers.js";import"../chunks/ElevationContext.js";import"../chunks/unitConversionUtils.js";import"../chunks/graphicUtils.js";import"../chunks/dehydratedFeatures.js";import"../chunks/quantizationUtils.js";import"../chunks/featureConversionUtils.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/OptimizedGeometry.js";import"../chunks/earcut.js";import"../chunks/SnappingCandidate.js";import"../chunks/visualVariableUtils.js";import"../chunks/sizeVariableUtils.js";import"../chunks/triangulationUtils.js";import"../chunks/deduplicate.js";import"../chunks/CIMSymbolHelper.js";import"../chunks/BidiEngine.js";import"../chunks/fontUtils.js";import"../chunks/GeometryUtils.js";import"../chunks/enums2.js";import"../chunks/utils6.js";import"../chunks/definitions.js";import"../chunks/HighlightOptions.js";import"../chunks/shapingUtils.js";import"../chunks/mat2d.js";import"../chunks/mat2df32.js";import"../chunks/Rect.js";import"../chunks/BoundingBox.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../chunks/OverrideHelper.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils9.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/LRUCache.js";import"../chunks/line.js";import"../chunks/line2.js";import"../chunks/lineStippleUtils.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"../geometry/support/MeshTextureTransform.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"../chunks/meshVertexSpaceUtils.js";import"../geometry/support/MeshGeoreferencedVertexSpace.js";import"../chunks/georeference.js";import"../geometry/support/MeshLocalVertexSpace.js";import"../geometry/support/MeshTransform.js";import"../chunks/interfaces.js";import"../chunks/DefaultLayouts.js";import"../chunks/styleUtils.js";import"../chunks/webStyleSymbolUtils.js";import"../symbols/support/jsonUtils.js";import"../chunks/Intersector4.js";import"../chunks/ColorMaterial.js";import"../chunks/TriangleMaterial.js";import"../chunks/LayerConstants.js";import"../chunks/intersectorUtilsConversions.js";import"../chunks/Intersector3.js";import"../chunks/utils7.js";import"../chunks/utils8.js";import"../chunks/ByteSizeUnit.js";import"../chunks/LayerViewPerformanceInfo.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/layerContainerType.js";import"../chunks/WorkerHandle.js";import"../chunks/enums3.js";import"../chunks/config.js";import"../chunks/TiledDisplayObject.js";import"../chunks/DisplayObject.js";import"../chunks/QueueProcessor.js";import"../chunks/mat2df64.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/workerHelper.js";import"../chunks/ProgramCache.js";import"../chunks/Program.js";import"./ui/UI.js";import"../chunks/themeUtils.js";import"../widgets/Attribution.js";import"../widgets/Widget.js";import"../chunks/uuid.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/legacyIcon.js";import"../widgets/Attribution/AttributionViewModel.js";import"../chunks/globalCss.js";import"../chunks/accessibleHandler.js";import"../chunks/messageBundle.js";import"../chunks/jsxFactory.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../chunks/utils18.js";import"../widgets/support/GoTo.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";function Fp(e,t){const i=ve(e),r=ve(t),s=i.store,n=r.store,a=r.metadata;for(const t in a){const i=a[t],r=s.originOf(t),o=n.originOf(t);if(!i.readOnly&&o!==me.DEFAULTS)if(r===me.DEFAULTS)e.set(t,n.get(t));else{const e=s.get(t),i=n.get(t);e&&i&&i instanceof pe&&e instanceof pe&&e instanceof i.constructor&&Fp(e,i)}}}const Vp=()=>import("../chunks/TileLayerView3D.js"),Up=()=>import("../chunks/ElevationLayerView3D.js"),jp={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":Up,"base-tile":Vp,"bing-maps":Vp,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),dimension:()=>import("../chunks/DimensionLayerView3D.js"),elevation:Up,feature:()=>import("../chunks/FeatureLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"line-of-sight":()=>import("../chunks/LineOfSightLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),media:()=>import("../chunks/MediaLayerView3D.js"),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":Vp,"oriented-imagery":()=>import("../chunks/FeatureLayerView3D.js"),"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),voxel:()=>import("../chunks/VoxelLayerView3D.js"),route:()=>import("../chunks/RouteLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:Vp,"integrated-mesh-3dtiles":()=>import("../chunks/IntegratedMesh3DTilesLayerView3D.js"),"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":Vp,wfs:()=>import("../chunks/WFSLayerView3D.js"),wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),catalog:null,"catalog-dynamic-group":null,"catalog-footprint":null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null},kp="analyses-owner-handles";var qp,zp;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(qp||(qp={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(zp||(zp={}));let Bp=class extends pe{constructor(e){super(e),this._allAnalysisViews=new r,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=Hp(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(o("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(o()),this._attachedToViewResolver=Hp()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(null==t||t.state.list===zp.REMOVED)throw new a("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),kp)}_disconnectOwners(){this.removeHandles(kp),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return y((()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}))}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:qp.PENDING,list:zp.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=Lt((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=zp.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=zp.REMOVED,this._scheduleUpdate()):A.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){null==this._scheduledUpdateHandle&&(this._scheduledUpdateHandle=G((()=>this._update())))}_update(){this._scheduledUpdateHandle=M(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===zp.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case qp.PENDING:e.createAnalysisViewTask=I(e.createAnalysisViewTask);break;case qp.CREATED:null!=e.view&&(this._allAnalysisViews.remove(e.view),e.view=D(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,null==s.module)try{s.module=await this._loadAnalysisModule(r)}catch(e){throw this._creatingViewCount-=1,e}if(l(t))throw this._creatingViewCount-=1,o("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});try{await n.when()}catch(e){throw this._creatingViewCount-=1,e}if(l(t))throw this._creatingViewCount-=1,n.destroy(),o("AnalysisView creation aborted");return e.view=n,e.state.view=qp.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./3d/analysis/AreaMeasurementAnalysisView3D.js");case"dimension":return import("../chunks/DimensionAnalysisView3D.js");case"direct-line-measurement":return import("./3d/analysis/DirectLineMeasurementAnalysisView3D.js");case"line-of-sight":return import("./3d/analysis/LineOfSightAnalysisView3D.js");case"slice":return import("./3d/analysis/SliceAnalysisView3D.js")}}};function Hp(){const e=c();return e.promise.catch((()=>{})),e}e([ae()],Bp.prototype,"updating",null),e([ae({constructOnly:!0})],Bp.prototype,"view",void 0),e([ae()],Bp.prototype,"_allAnalysisViews",void 0),e([ae()],Bp.prototype,"_creatingViewCount",void 0),Bp=e([le("esri.views.3d.analysis.AnalysisViewManager3D")],Bp);const Gp=Bp;let Wp=class extends pe{constructor(e){super(e),this.collision=new Yp,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Mt.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Mt.Local?this._set("altitude",e):A.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Ft(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Ft(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Mt.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=Xp)=>(i.min=Qp.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?ei([[4e3,Qp.max],[1e4,Vt(88)],[6e6,Vt(88)]]):()=>Qp.max;return(t,i=Xp)=>(i.min=Qp.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?ei([[4e3,Qp.max],[5e4,Vt(88)],[6e6,Vt(88)],[2e7,Qp.min]]):ei([[3e5,Qp.max],[3e6,Vt(88)],[6e6,Vt(88)],[2e7,Qp.min]]);return(t,i=Xp)=>(i.min=Qp.min,i.max=e(t),i)}};e([ae()],Wp.prototype,"altitude",null),e([ae({readOnly:!0})],Wp.prototype,"collision",void 0),e([ae()],Wp.prototype,"distance",void 0),e([ae({readOnly:!0})],Wp.prototype,"minimumPoiDistance",void 0),e([ae()],Wp.prototype,"tilt",void 0),e([ae({constructOnly:!0})],Wp.prototype,"mode",void 0),Wp=e([le("esri.views.3d.state.Constraints")],Wp);const $p={min:-2e5,max:4*Ht.radius},Qp={min:Vt(.5),max:Vt(179.5)},Xp={min:0,max:0};let Yp=class extends pe{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([ae({type:Boolean})],Yp.prototype,"enabled",void 0),e([ae({type:Number})],Yp.prototype,"elevationMargin",void 0),Yp=e([le("esri.views.3d.state.Constraints.CollisionConstraint")],Yp);let Zp=class extends Nt{constructor(){super(...arguments),this.min=$p.min,this.max=$p.max}};e([ae({type:Number})],Zp.prototype,"min",void 0),e([ae({type:Number})],Zp.prototype,"max",void 0),Zp=e([le("esri.views.3d.constraints.AltitudeConstraint")],Zp);let Kp=class extends Nt{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([ae({type:Number,value:1e-8})],Kp.prototype,"near",null),e([oe("near")],Kp.prototype,"castNear",null),e([ae({type:Number,value:1e-8})],Kp.prototype,"far",null),e([oe("far")],Kp.prototype,"castFar",null),e([ae({type:["auto","manual"]})],Kp.prototype,"mode",void 0),Kp=e([le("esri.views.3d.constraints.ClipDistanceConstraint")],Kp);const Jp={min:Ut(Qp.min),max:Ut(Qp.max)};let em=class extends Nt{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Ft(e,Jp.min,Jp.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([ae({type:["auto","manual"]})],em.prototype,"mode",void 0),e([ae({type:Number,value:Jp.max})],em.prototype,"max",null),e([oe("max")],em.prototype,"castMax",null),em=e([le("esri.views.3d.constraints.TiltConstraint")],em);let tm=class extends Nt{constructor(){super(...arguments),this.tilt=new em,this.altitude=new Zp,this.clipDistance=new Kp}};e([ae({type:em})],tm.prototype,"tilt",void 0),e([ae({type:Zp})],tm.prototype,"altitude",void 0),e([ae({type:Kp})],tm.prototype,"clipDistance",void 0),tm=e([le("esri.views.3d.constraints.Constraints")],tm);const im={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:ai,virtual:oi}};var rm;let sm=rm=class extends pe{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new rm({quality:this.quality})}};var nm;e([ae({type:["low","high"],value:"low"})],sm.prototype,"quality",null),sm=rm=e([le("esri.views.3d.environment.SceneViewAtmosphere")],sm);let am=nm=class extends li{constructor(e){super(e),this.atmosphere=new sm,this.lighting=this.castLighting(),this.cachedCameraTrackingEnabled=null}destroy(){this.atmosphere.destroy()}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new nm({...t,lighting:t.lighting?"virtual"===t.lighting.type?oi.fromWebsceneLighting(t.lighting):ai.fromWebsceneLighting(t.lighting):void 0})}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){const t=this._convertLighting(e);return t!==e&&this.addHandles(v(t)),t}_convertLighting(e){return e?e instanceof ai||e instanceof oi?e:e instanceof ci?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new ai({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof hi?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new oi({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):ce(im,e):new ai}clone(){return new nm({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:w(this.background)})}cloneWithWebsceneEnvironment(e){return new nm({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:w(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):ai.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):oi.fromWebsceneLighting(e.lighting);default:return ni(e.lighting),ai.fromWebsceneLighting(e.lighting)}}};e([ae({type:sm,json:{read:!1},nonNullable:!0})],am.prototype,"atmosphere",void 0),e([ae({nonNullable:!0})],am.prototype,"lighting",void 0),e([oe("lighting")],am.prototype,"castLighting",null),am=nm=e([le("esri.views.3d.environment.SceneViewEnvironment")],am);const om=am;var lm;function cm(e){return Ft((e-1e5)/9e5,0,1)}!function(e){e[e.Realistic=0]="Realistic",e[e.Local=1]="Local",e[e.Mars=2]="Mars",e[e.None=3]="None"}(lm||(lm={}));const hm=1e5,dm=xe(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),um=xe(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),pm=xe(parseFloat(Number(dm[0]+um[0]).toFixed(6)),parseFloat(Number(dm[1]+um[1]).toFixed(6)),parseFloat(Number(dm[2]+um[2]).toFixed(6))),mm=wr(),_m=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:dm,build:function(e){const t=new qr;t.attributes.add(Sn.POSITION,"vec2"),t.include(Tr,{textureCoordinateType:Pr.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add(new zr("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new zr("inverseViewMatrix",((e,t)=>lr(mm,t.camera.viewMatrix)))),i.code.add(Tn`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Br("backgroundColor",(e=>e.backgroundColor)),new Hr("radii",(e=>e.radii)),new Br("cameraPosition",((e,t)=>t.camera.eye)),new Gr("heightParameters",(e=>e.heightParameters)),new Wr("innerFadeDistance",(e=>e.innerFadeDistance)),new Wr("altitudeFade",(e=>e.altitudeFade)),new $r("depthTexture",(e=>e.depthTexture)),new Wr("hazeStrength",(e=>e.hazeStrength))),r.constants.add("betaRayleigh","vec3",dm),r.constants.add("betaCombined","vec3",pm),r.constants.add("betaMie","float",3996e-9),r.constants.add("scaleHeight","float",8500),Sr(r),t.include(Ls),e.haze&&(r.include(Qr),r.uniforms.add(new Hr("nearFar",((e,t)=>t.camera.nearFar)))),r.code.add(Tn`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(Tn`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(Tn`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(Tn`
    const int STEPS = 6;

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?Tn`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?"":Tn`mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * `} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":Tn`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${e.haze?Tn`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:Tn`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    ${e.haze?"":Tn`
            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
                return fragColor;
              }

              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
              if (relDist > 1.0) {
                return surfaceColor;
              }

              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
            }

            float getGlow(float dist, float radius, float intensity) {
              return pow(radius / max(dist, 1e-6), intensity);
            }

            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){

              // Get the amount of atmosphere between camera and the Sun along the view ray
              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, max(scaleFract, 0.0));

              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray
              // This will make the colour of the Sun reddish on the horizon and white from space
              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));

              // Alignment of light direction and view ray
              float mu = clamp(dot(rayDir, lightDir), 0.0, 1.0);
              // Draw the Sun as a bright disc
              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));

              return normalize(sunTransmittance) * sunDisc;
            }`}

    ${e.haze&&e.reduced?Tn`
        float getDepth(vec2 uv){
          return linearDepthFromTexture(depthTexture, uv, nearFar);
        }

        float textureBilinear(vec2 uv) {
          // Information about the high-resolution depth texture
          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
          vec2 texelSize = 1.0 / depthTextureSize;

          // The uv inside the upper right pixel - of the tile of 4 pixels -
          // that the atmosphere uv maps to in the depth texture
          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);

          // Relative distance of the uv coordinates inside the depth texture pixel
          vec2 f = fract(depthUV);

          // Snap to the centre of the depth texture pixel
          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;

          // Read the depth texture pixel and its three neighbours
          float d0 = getDepth(snapUV);
          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
          float d3 = getDepth(snapUV + texelSize);

          // Return the bilinearly interpolated value of the neighbouring pixels based
          // on the sample position in the depth texture pixel
          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
        }
        `:""}

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?Tn`
          vec4 depthSample = texture(depthTexture, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;

              ${e.reduced?Tn`cameraSpaceRay *= -textureBilinear(vuv0);`:Tn`cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0, nearFar);`}

            terrainDepth = max(0.0, length(cameraSpaceRay));
          }else{
            discard;
          }
          `:Tn`${e.reduced?"":Tn`
                float depthSample = texture(depthTexture, vuv0).r;
                if (depthSample != 1.0) {
                  fragColor = vec4(0);
                  return;
                }`}`}

      ${e.haze?Tn`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            // Alpha is ignored for haze blending
            float alpha = 1.0;
            `:Tn`
            vec3 col = linearizeGamma(backgroundColor);
            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            col += getSun(cameraPosition, rayDir, mainLightDirection);
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":Tn`fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);`}
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class gm extends Pn{constructor(){super(...arguments),this.heightParameters=tr(),this.radii=nr(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=nr(),this.backgroundColor=we()}}class fm extends Xr{initializeProgram(e){return new Yr(e.rctx,fm.shader.get().build(this.configuration),Rn)}initializePipeline(){return this.configuration.reduced?ea({blending:ta(jn.ONE,jn.ZERO),depthTest:{func:kn.ALWAYS},colorWrite:ia}):this.configuration.haze?ea({blending:ra(jn.ONE,jn.ZERO,jn.ONE_MINUS_SRC_COLOR,jn.ONE),colorWrite:ia}):ea({blending:ta(jn.SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}fm.shader=new Zr(_m,(()=>Promise.resolve().then((()=>_m))));class ym extends pa{constructor(){super(...arguments),this.haze=!1,this.reduced=!1}}e([ua()],ym.prototype,"haze",void 0),e([ua()],ym.prototype,"reduced",void 0);class vm extends Pn{}const xm=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:vm,build:function(e){const t=new qr;t.include(qa),t.fragment.uniforms.add(new $r("colorTexture",(e=>e.color)),new $r("depthTexture",(e=>e.depth)));const i=e.haze;return t.fragment.code.add(Tn`
    void main() {
      ${i?Tn`vec4`:Tn`float`} depthSample = texture(depthTexture, uv) ${i?"":Tn`.r`};
      if (depthSample ${i?Tn`== vec4(0)`:Tn`!= 1.0`} ) {
          fragColor = vec4(0);
          return;
      }
      fragColor = texture(colorTexture, uv);
    }
    `),t}},Symbol.toStringTag,{value:"Module"}));class wm extends Xr{initializeProgram(e){return new Yr(e.rctx,wm.shader.get().build(this.configuration),Rn)}initializePipeline(){return this.configuration.haze?ea({blending:ra(jn.ONE,jn.ZERO,jn.ONE_MINUS_SRC_COLOR,jn.ONE),depthTest:{func:kn.ALWAYS},colorWrite:ia}):ea({blending:ta(jn.SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),depthTest:{func:kn.ALWAYS},colorWrite:ia})}}wm.shader=new Zr(xm,(()=>Promise.resolve().then((()=>xm))));class bm{constructor(e,t){this._view=e,this._context=t,this.type=lm.Realistic,this._handles=new qi,this._compositingPassParameters=new vm,this._atmosphereConfiguration=new ym,this._passParameters=new gm,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=Ht.radius,this._fadeHaze=0,this._updateRadius(Ht.radius);const i=this._context.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([U((()=>this._view?.basemapTerrain?.rootTileElevationBounds),(()=>this._view?.basemapTerrain?this._updateRootTileElevationBounds():null)),U((()=>this._view?.basemapTerrain?.visibleElevationBounds),(()=>this._view?.basemapTerrain?this._updateVisibleElevationBounds():null)),U((()=>this._view?.environment.background),(e=>{const t=e instanceof Ka?ki(e.color):ir;ui(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])}),j)]);const r=new ym;r.haze=!1,this._atmosphereTechnique=this._context.techniqueRepository.acquire(fm,r),r.haze=!0,this._atmosphereHazeTechnique=this._context.techniqueRepository.acquire(fm,r),r.reduced=!0,r.haze=!1,this._atmosphereReducedTechnique=this._context.techniqueRepository.acquire(fm,r),r.haze=!0,this._atmosphereHazeReducedTechnique=this._context.techniqueRepository.acquire(fm,r),this._vao=va(i,xa)}destroy(){this._handles.destroy(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,t){this._render(e,t?this._atmosphereTechnique:this._atmosphereReducedTechnique,e.offscreenRenderingHelper.depthTexture,t,!1)}renderHaze(e,t,i){this._fadeHaze=t,this._render(e,i?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,e.bindParameters.linearDepth?.getTexture(),i,!0)}_render(e,t,i,r,s){if(null==i)return;const n=e.offscreenRenderingHelper;this._update(e.bindParameters.camera),this._passParameters.depthTexture=i;const a=e.rctx.bindTechnique(t,e.bindParameters,this._passParameters);if(r)n.renderDepthDetached((()=>this._renderCommon(a,e)));else{const t=e.rctx.getViewport(),r=pi(e.bindParameters.camera.eye)-Ht.radius;let o;if(r<hm){const e=Math.min(1,Math.max(0,r/hm));o=s?jt(.4,.5,e):jt(.2,.3,e)}else{const e=Math.min(1,Math.max(0,(r-hm)/15e5));o=s?jt(.5,1,e):jt(.3,.6,e)}const l=Kr(Math.round(o*e.bindParameters.camera.fullViewport[2])),c=Kr(Math.round(o*e.bindParameters.camera.fullViewport[3]));e.rctx.setViewport(0,0,l,c);const h=n.renderToCachedFBO(null,"chapman",(()=>this._renderCommon(a,e)),[0,0,0,1],ma.RGBA,null,l,c);e.rctx.setViewport(t.x,t.y,t.width,t.height),this._compositingPassParameters.color=h.getTexture(),this._compositingPassParameters.depth=i,this._atmosphereConfiguration.haze=s;const d=this._context.techniqueRepository.acquire(wm,this._atmosphereConfiguration);e.rctx.bindTechnique(d,e.bindParameters,this._compositingPassParameters),n.renderDepthDetached((()=>e.rctx.screen.draw())),d.release(),h.release()}}_renderCommon(e,t){null!=this._vao&&(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(qn.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=Ht.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Ht.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,zi(this._passParameters.radii,e,e+hm),this._passParameters.innerFadeDistance=2*Math.sqrt(1e4*(2*e-1e4))}_update(e){if(!e)return;const t=mi(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],s=Ft((i-this._passParameters.radii[0])/hm,0,1);$i(this._passParameters.heightParameters,i,t,r,s),this._passParameters.altitudeFade=cm(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=jt(jt(.6,1,kt(9500,10500,i-Ht.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const Cm=wr(),Tm=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr,{attributes:t,varyings:i,vertex:r,fragment:s}=e;return t.add(Sn.POSITION,"vec2"),i.add("worldRay","vec3"),r.uniforms.add(new zr("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new zr("inverseViewMatrix",((e,t)=>lr(Cm,t.camera.viewMatrix)))),r.code.add(Tn`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),s.include(Jr),s.include(es),e.include(Ja,{pbrMode:Rr.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(ts),e.include(Ls),e.include(Or),e.include(Ns),s.uniforms.add(new Br("cameraPosition",((e,t)=>t.camera.eye))),s.code.add(Tn`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}},Symbol.toStringTag,{value:"Module"}));class Pm extends Xr{constructor(e){super(e,new pa,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,Pm.shader.get().build(),Rn)}initializePipeline(){return ea({blending:ra(jn.ONE,jn.ZERO,jn.SRC_ALPHA,jn.ONE),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}Pm.shader=new Zr(Tm,(()=>Promise.resolve().then((()=>Tm))));let Sm=class extends pe{constructor(e){super(e),this._technique=new Pm(e),this._vao=va(e.rctx)}destroy(){this._technique=L(this._technique),this._vao=N(this._vao)}render(e){if(!this._technique.compiled)return void this.requestRender();const t=e.bindParameters.cloudsFade;if(null==this._vao||null==t.data)return;const i=e.rctx.bindTechnique(this._technique,e.bindParameters,Rm);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(qn.TRIANGLE_STRIP,0,4)}};e([ae({constructOnly:!0})],Sm.prototype,"rctx",void 0),e([ae({constructOnly:!0})],Sm.prototype,"viewingMode",void 0),e([ae({constructOnly:!0})],Sm.prototype,"planetRadius",void 0),e([ae({constructOnly:!0})],Sm.prototype,"requestRender",void 0),Sm=e([le("esri.views.3d.environment.CloudsComposition")],Sm);const Rm=new Pn;var Om;!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(Om||(Om={}));class Em extends pa{constructor(){super(...arguments),this.steps=Om.SIXTEEN,this.writeTextureChannels=Fs.RG}}e([ua({count:Om.COUNT})],Em.prototype,"steps",void 0),e([ua({constValue:b("esri-mobile")?1024:2048})],Em.prototype,"cubeMapSize",void 0),e([ua()],Em.prototype,"writeTextureChannels",void 0);class Am{constructor(e,t,i,r,s,n,a,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=n,this.cloudHeight=a,this.raymarchingSteps=o,this.median=l}}const Mm=new Am([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Om.SIXTEEN),Dm={sunny:Mm,cloudy:new Am([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Om.TWOHUNDRED,.6),rainy:new Am([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Om.TWOHUNDRED,.4),snowy:new Am([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Om.HUNDRED,.65),foggy:new Am([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Om.SIXTEEN),default:Mm},Im=b("esri-mobile")?64:128,Lm=Im/128,Nm=Math.ceil(Math.sqrt(Im)),Fm=(Im+2)*Nm,Vm=Fm/1560;class Um extends Pn{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=Dm.default.raymarchingSteps,this.weatherTile=nr(),this.viewMatrix=Oo()}}const jm=nr(),km=Object.freeze(Object.defineProperty({__proto__:null,CloudsPassParameters:Um,build:function(e){const t=new qr;t.include(qa,!1);const i=t.fragment;return i.uniforms.add(new Wr("cloudRadius",(e=>e.cloudRadius)),new Wr("power",(e=>jt(35,120,e.absorption))),new Wr("sigmaE",(e=>1+e.absorption)),new Wr("density",(e=>jt(0,.3,e.density))),new Wr("cloudSize",(e=>jt(0,.02,Math.max(.01,1-e.cloudSize)))),new Wr("detailSize",(e=>jt(0,.2,Math.max(.01,1-e.detailSize)))),new Wr("smoothness",(e=>jt(0,.5,1-e.smoothness))),new Wr("cloudHeight",(e=>jt(0,1500,e.cloudHeight))),new Wr("coverage",(e=>e.coverage)),new is("view",(e=>e.viewMatrix)),new $r("cloudShapeTexture",(e=>null!=e.noiseTexture?e.noiseTexture.textureAtlas:null)),new Hr("cloudVariables",(e=>zi(jm,e.coverage,e.absorption)))),i.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),i.code.add(Tn`
    const int STEPS = ${e.steps===Om.SIXTEEN?Tn`16`:e.steps===Om.HUNDRED?Tn`100`:Tn`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(Tn`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${Tn.float(Fm)};
      const float dataWidth = ${Tn.float(Fm)};
      const float tileRows = ${Tn.float(Nm)};
      const vec3 atlasDimensions = vec3(${Tn.float(Im)}, ${Tn.float(Im)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${Tn.float(Lm)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${Tn.float(Vm)} * p) / ${Tn.float(Fm)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(Tn`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(Tn`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),i.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),i.code.add(Tn`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(Tn`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.code.add(Tn`void main() {
if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),t}},Symbol.toStringTag,{value:"Module"}));class qm extends Xr{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,qm.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:ta(jn.CONSTANT_COLOR,jn.ONE_MINUS_CONSTANT_COLOR,zn.ADD,this.configuration.writeTextureChannels===Fs.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}var zm;qm.shader=new Zr(km,(()=>Promise.resolve().then((()=>km)))),function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(zm||(zm={}));class Bm extends pa{constructor(){super(...arguments),this.mode=zm.Full}}e([ua({count:zm.COUNT})],Bm.prototype,"mode",void 0);class Hm extends Pn{constructor(){super(...arguments),this.weatherTile=ar(0,0)}}const Gm=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Hm,build:function(e){const t=new qr;if(t.include(qa,!1),t.fragment.code.add(Tn`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===zm.Full){const e=2,i=8;t.fragment.code.add(Tn`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${Tn.float(Nm)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${Tn.float(i)});

      float worley0 = worley(p, ${Tn.float(e)} * 2.0);
      float worley1 = worley(p, ${Tn.float(e)} * 8.0);
      float worley2 = worley(p, ${Tn.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${Tn.float(e)});
      float worley1 = worley(p, ${Tn.float(e)} * 2.0);
      float worley2 = worley(p, ${Tn.float(e)} * 4.0);
      float worley3 = worley(p, ${Tn.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new Hr("weatherTile",(e=>e.weatherTile))),t.fragment.code.add(Tn`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${Tn.float(128)});

      // Get global coordinates of p
      p += weatherTile * ${Tn.float(128)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${Tn.float(1e5)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),t.fragment.code.add(Tn`void main() {`),e.mode===zm.Full&&t.fragment.code.add(Tn`
        float padWidth = 1.0;
        float paddedSize = ${Tn.float(Im)} + 2.0 * padWidth;
        float tileCount = ${Tn.float(Nm)} * ${Tn.float(Nm)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${Tn.float(Im)};
          }

          if (startPadY) {
            pixel.y += ${Tn.float(Im)};
          }

          if (endPadX) {
            pixel.x -= ${Tn.float(Im)};
          }

          if (endPadY) {
            pixel.y -= ${Tn.float(Im)};
          }

          uv = vec2(pixel.xy / ${Tn.float(Im)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${Tn.float(Im)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${Tn.float(Nm)} * ${Tn.float(Nm)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${Tn.float(Nm)} * ${Tn.float(Nm)});
        p = p_;
        p.z /= (${Tn.float(Nm)} * ${Tn.float(Nm)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),t.fragment.code.add(Tn`
      vec2 mapUV = ${Tn.float(128)} * (gl_FragCoord.xy / ${Tn.float(Fm)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${e.mode===zm.Full?Tn`fragColor.ba = vec2(0.0, map);`:Tn`fragColor = vec4(map);`};
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Wm extends Xr{initializeProgram(e){return new Yr(e.rctx,Wm.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:this.configuration.mode===zm.Full?ta(jn.ONE,jn.ZERO):ra(jn.ZERO,jn.ONE,jn.ONE,jn.ZERO),depthTest:{func:kn.ALWAYS},colorWrite:ia})}}Wm.shader=new Zr(Gm,(()=>Promise.resolve().then((()=>Gm))));let $m=class extends pe{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Hm,this._fbo=new Ao(e.context.renderContext.rctx,new Lo(Fm)),this._vao=va(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return null!=this._texture?null!=this._weatherMapTechnique&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(zm.WeatherMap)):null!=this._fullTechnique&&this._fullTechnique.compiled&&(this._texture=this._render(zm.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(Bi(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=L(this._fullTechniqueCached),this._weatherMapTechniqueCached=L(this._weatherMapTechniqueCached),this._fbo=N(this._fbo),this._vao=N(this._vao)}get _fullTechnique(){if(null==this._fullTechniqueCached){const e=new Bm;e.mode=zm.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Wm,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(null==this._weatherMapTechniqueCached){const e=new Bm;e.mode=zm.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Wm,e)}return this._weatherMapTechniqueCached}_render(e){if(null==this._vao||null==this._fbo)return null;const t=e===zm.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,r=i.getViewport();i.setViewport(0,0,Fm,Fm),i.bindFramebuffer(this._fbo);const s=i.bindTechnique(t,null,this._passParameters);return i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._fbo.colorTexture}};e([ae({constructOnly:!0})],$m.prototype,"context",void 0),e([ae({readOnly:!0})],$m.prototype,"_techniqueRepository",null),$m=e([le("esri.views.3d.environment.NoiseTextureAtlas")],$m);let Qm=class extends pe{constructor(e){super(e),this._techniques=new Array,this._techniqueConfiguration=new Em,this._bindParameters=new Vs(null,null),this._passParameters=new Um,this._weatherTile=nr(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=jt(Dm.default.coverage[0],Dm.default.coverage[1],.5),this.density=jt(Dm.default.density[0],Dm.default.density[1],.5),this.absorption=jt(Dm.default.absorption[0],Dm.default.absorption[1],.5),this.cloudSize=jt(Dm.default.cloudSize[0],Dm.default.cloudSize[1],.5),this.detailSize=jt(Dm.default.detailSize[0],Dm.default.detailSize[1],.5),this.smoothness=jt(Dm.default.smoothness[0],Dm.default.smoothness[1],.5),this.cloudHeight=jt(Dm.default.cloudHeight[0],Dm.default.cloudHeight[1],.5),this.raymarchingSteps=Dm.default.raymarchingSteps,this._viewMatrix=wr(),this._dirty=!1,this.running=!1,this._vao=va(e.context.renderContext.rctx)}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=t===Fs.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[i]=new qm({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null==e||null==t)return;zi(this._weatherTile,(e+90)/180,(t+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let r=0,s=0;if(null!=this.view.environment&&"virtual"!==this.view.environment.lighting.type&&null!=this.view.environment.lighting.date){const e=new Date(this.view.environment.lighting.date);e.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),r=31*e.getUTCMonth()+e.getUTCDate(),s=e.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+r)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+s%100)%(4*this._weatherTileCount),Hi(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=Gt(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this.addHandles([this.view.resourceController.scheduler.registerTask(jo.CLOUDS_GENERATOR,this),U((()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps]),(()=>this.setDirty()),k)])}destroy(){this._techniques.forEach((e=>L(e))),this._frameBufferCube=N(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=D(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case Om.SIXTEEN:return 1;case Om.HUNDRED:return 4;case Om.COUNT:case Om.TWOHUNDRED:return 8}}get usedMemory(){return(this._frameBufferCube?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){if(null!=this._passParameters.noiseTexture)this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new $m({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return null!=this._passParameters.noiseTexture.textureAtlas}_ensureFrameBufferCube(e){if(null==this._frameBufferCube){const t=new Lo(e);t.target=Bn.TEXTURE_CUBE_MAP,t.wrapMode=Hn.CLAMP_TO_EDGE,this._frameBufferCube=new Ao(this.context.renderContext.rctx,t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=N(this._frameBufferCube)}applyPreset(e,t){const i=e.median,r=e=>{const r=jt(e[0],e[1],i);return t<.5?jt(e[0],r,2*t):jt(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),Bi(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return ko;if(this.context.renderContext.bindParameters.cloudsFade.fadeMode===Us.CROSS_FADE||!this._ensureNoiseTexture())return ko;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=js.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=Xm[this._faceIndex],r=Ym[this._faceIndex];cr(this._viewMatrix,Zm,i,r),xo(this._passParameters.viewMatrix,this._viewMatrix);const s=this.context.renderContext.rctx,n=s.bindTechnique(t,this._bindParameters,this._passParameters);s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao);const a=s.getViewport(),o=t.configuration.cubeMapSize,l=o/this._tilesPerFace,c=this._tileIndex*l;s.setViewport(0,c,o,l);const h=this._ensureFrameBufferCube(o);s.bindFramebuffer(h);const d=Bn.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return h.setColorTextureTarget(d),s.gl.drawArrays(s.gl.TRIANGLE_STRIP,0,4),s.gl.flush(),s.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.running||(this.context.renderContext.bindParameters.cloudsFade.renderingStage=js.FADING)):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),ko}};e([ae({constructOnly:!0})],Qm.prototype,"context",void 0),e([ae({constructOnly:!0})],Qm.prototype,"view",void 0),e([ae({constructOnly:!0})],Qm.prototype,"requestRender",void 0),e([ae()],Qm.prototype,"coverage",void 0),e([ae()],Qm.prototype,"density",void 0),e([ae()],Qm.prototype,"absorption",void 0),e([ae()],Qm.prototype,"cloudSize",void 0),e([ae()],Qm.prototype,"detailSize",void 0),e([ae()],Qm.prototype,"smoothness",void 0),e([ae()],Qm.prototype,"cloudHeight",void 0),e([ae()],Qm.prototype,"raymarchingSteps",void 0),e([ae()],Qm.prototype,"running",void 0),Qm=e([le("esri.views.3d.environment.CloudsGenerator")],Qm);const Xm=[Po(1,0,0),Po(-1,0,0),Po(0,1,0),Po(0,-1,0),Po(0,0,1)],Ym=[Po(0,1,0),Po(0,1,0),Po(0,0,-1),Po(0,0,1),Po(0,1,0)],Zm=So();class Km extends Pn{constructor(){super(...arguments),this.fogColor=we(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}}const Jm=wr(),e_=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:Km,build:function(){const e=new qr;e.attributes.add(Sn.POSITION,"vec2"),e.include(Tr,{textureCoordinateType:Pr.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add(new zr("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new zr("inverseViewMatrix",((e,t)=>lr(Jm,t.camera.viewMatrix)))),t.code.add(Tn`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add(new Wr("atmosphereC",(e=>e.atmosphereC)),new Br("cameraPosition",((e,t)=>t.camera.eye)),new Hr("nearFar",((e,t)=>t.camera.nearFar)),new $r("depthTexture",(e=>e.depthTexture)),new Wr("fogStrength",(e=>e.fogStrength)),new Wr("fogAmount",(e=>e.fogAmount)),new Br("fogColor",(e=>e.fogColor))),e.include(Ls),i.include(Qr),i.code.add(Tn`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(Tn`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),i.code.add(Tn`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = texture(depthTexture, vuv0).r;
float zNorm = 2.0 * depthSample - 1.0;
float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linDepth;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
vec4 fog = applyFog(terrainDepth, rayDir);
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
}`),e}},Symbol.toStringTag,{value:"Module"}));class t_ extends Xr{constructor(e){super(e,new pa,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,t_.shader.get().build(),Rn)}initializePipeline(){return ea({blending:ra(jn.SRC_ALPHA,jn.ZERO,jn.ONE_MINUS_SRC_ALPHA,jn.ONE),colorWrite:ia})}}t_.shader=new Zr(e_,(()=>Promise.resolve().then((()=>e_))));let i_=class extends pe{constructor(e){super(e),this._passParameters=new Km;const t=e.context.renderContext.rctx;this._vao=va(t,xa),this._technique=new t_(e);const i=Gt(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+hm}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const r=e.offscreenRenderingHelper;r.renderDepthDetached((()=>{this._passParameters.depthTexture=r.depthTexture;const t=e.rctx.bindTechnique(i,e.bindParameters,this._passParameters);this._renderFog(t,e)}))}_renderFog(e,t){const i=t.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(qn.TRIANGLE_STRIP,0,4)}_update(e,t){const i=e.bindParameters.camera;_i(s_,i.eye);const r=Math.max(0,gi(s_,e.bindParameters.lighting.mainLight.direction)),s=t.color;fi(n_,s,.1),yi(this._passParameters.fogColor,n_,s,r);const n=pi(i.eye),a=n*n;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-kt(.95*Ho,1*Ho,Math.abs(n-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};e([ae({constructOnly:!0})],i_.prototype,"context",void 0),e([ae({constructOnly:!0})],i_.prototype,"view",void 0),e([ae({constructOnly:!0})],i_.prototype,"rctx",void 0),e([ae({constructOnly:!0})],i_.prototype,"viewingMode",void 0),i_=e([le("esri.views.3d.environment.Fog")],i_);class r_{constructor(){this.color=we(),this.strength=0,this.amount=0}}const s_=we(),n_=we();var a_;!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(a_||(a_={}));class o_ extends rs{constructor(){super(...arguments),this.geometry=a_.Cone}}e([ua({count:a_.COUNT})],o_.prototype,"geometry",void 0);class l_ extends Pn{constructor(){super(...arguments),this.texV=nr(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new c_}}class c_{constructor(){this.center=we(),this.v1=we(),this.v2=we()}}const h_=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:c_,SimpleAtmospherePassParameters:l_,build:function(e){const t=new qr,{vertex:i,fragment:r}=t;if(Sr(i),e.geometry===a_.Underground)t.attributes.add(Sn.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add(new Br("cameraPosition",((e,t)=>t.camera.eye)),new Wr("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))),i.code.add(Tn`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(Tn`void main() {
fragColor = color;
}`);else{t.include(Go,e),t.attributes.add(Sn.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===a_.Cylinder;i.uniforms.add(new zr("proj",((e,t)=>t.camera.projectionMatrix)),new zr("view",((e,t)=>t.camera.viewMatrix))),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new Br("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new Br("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new Br("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new Hr("texV",(e=>e.texV))),i.uniforms.add(new Wr("innerScale",(e=>e.innerScale))));const n=6.2831853,a=1/128;i.code.add(Tn`
		void main(void) {
      ${s?Tn`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:Tn`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${Tn.float(n*a)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${Tn.float(a)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new $r("tex",(e=>e.texture))),s||r.uniforms.add(new Wr("altitudeFade",(e=>e.altitudeFade))),r.code.add(Tn`
		void main() {
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?Tn`fragColor = atmosphereColor;`:Tn`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}},Symbol.toStringTag,{value:"Module"}));class d_ extends Xr{initializeProgram(e){return new Yr(e.rctx,d_.shader.get().build(this.configuration),Rn)}initializePipeline(){return this.configuration.geometry===a_.Cylinder?ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),culling:sa,depthTest:{func:kn.LEQUAL},colorWrite:ia}):ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}d_.shader=new Zr(h_,(()=>Promise.resolve().then((()=>h_))));const u_=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);class p_{constructor(e,t){this.type=lm.Local,this._configuration=new o_,this._passParameters=new l_,this._configuration.geometry=a_.Cylinder,this._technique=t.techniqueRepository.acquire(d_,this._configuration);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=No(this._vao,"geometry");const r=new Lo;r.wrapMode=Hn.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new Fo(i,r,u_)}destroy(){this._passParameters.texture=N(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);var r,s;r=m_,s=e.bindParameters.camera.viewMatrix,hr(r,s),r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.setUniformMatrix4fv("view",m_),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(qn.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=Zo(1,2,!1),{data:i,indices:r}=t[0][1],s=__.createBuffer(r.length),n=s.position;for(let e=0;e<r.length;++e){const t=3*r[e%3==0?e+2:e%3==2?e-2:e];n.set(e,0,i[t]),n.set(e,1,i[t+1]),n.set(e,2,i[t+2])}return new Ko(e,Rn,{geometry:Xo(__)},{geometry:el.createVertex(e,Gn.STATIC_DRAW,s.buffer)})}}const m_=wr(),__=Yo().vec3f(Sn.POSITION),g_=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),f_=-1e4,y_=ei([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class v_{constructor(e,t){this.view=e,this.type=lm.Mars,this._passParameters=new l_,this._vaoCount=0,this._texV1=1;const i=Gt(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+f_)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=t.techniqueRepository;const r=t.renderContext.rctx;this._cameraChangeHandle=U((()=>this.view.state?.camera),(()=>t.requestRender()),j),this._vao=this._createRibbon(r),this._vaoCount=No(this._vao,"geometry"),this._fadeVao=va(r),this._fadeVaoCount=No(this._fadeVao,"geometry");const s=new Lo;s.wrapMode=Hn.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new Fo(r,s,g_);const n=new o_;n.geometry=a_.Cone,this._coneTechnique=this._techniqueRepository.acquire(d_,n),n.geometry=a_.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(d_,n)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=N(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(qn.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,e.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(qn.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=we(),i=this._planetRadius,r=pi(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(50,s),a=i+f_;var o,l,c;this._passParameters.innerScale=(l=i,c=a,(o=i+n)*o/(Math.sqrt(o*o-l*l)*Math.sqrt(o*o-c*c)+l*c)-1),this._passParameters.altitudeFade=cm(s),fi(t,e.eye,(i+50)/r),x_(t,e.center,e.up,i,this._passParameters.silhouette);const h=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),d=1-511/512,u=y_(s);let p=this._texV0+d*this._texVScale,m=this._texV0+h*u*this._texVScale;if(s>50){x_(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=Ft((t-1.5)/(h-1.5),0,1);p=this._texV0+r*d*this._texVScale,m=this._texV0+jt(this._texV1,h*u,r)*this._texVScale}zi(this._passParameters.texV,p,m)}_createRibbon(e){const t=ss(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r]=e,t[r+1]=this._innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this._middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this._outerRimFactor,t[r+8]=1;const s=3*e+1,n=127===e?1:s+3,a=15*e;i[a]=s,i[a+1]=s+1,i[a+2]=n+1,i[a+3]=n+1,i[a+4]=n,i[a+5]=s,i[a+6]=s+1,i[a+7]=s+2,i[a+8]=n+2,i[a+9]=n+2,i[a+10]=n+1,i[a+11]=s+1,i[a+12]=s,i[a+13]=n,i[a+14]=0}const r=T_.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new Ko(e,Rn,{geometry:Xo(T_)},{geometry:el.createVertex(e,Gn.STATIC_DRAW,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return vi(b_,r.center,r.v2),fi(C_,b_,this._outerRimFactor),dr(w_,t,b_,i),tl(b_,w_,e.projectionMatrix,e.viewport,b_),tl(C_,w_,e.projectionMatrix,e.viewport,C_),xi(b_,C_)/e.height}}function x_(e,t,i,r,s){const n=pi(e),a=r*Math.sqrt(n*n-r*r)/n,o=Math.sqrt(r*r-a*a),l=s.v1,c=s.v2;return fi(s.center,e,o/n),wi(l,e,t),mi(l)<1&&wi(l,e,i),fi(l,l,a/pi(l)),wi(c,l,e),fi(c,c,a/pi(c)),a}const w_=wr(),b_=we(),C_=we(),T_=Yo().vec3f(Sn.POSITION);var P_;!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(P_||(P_={}));class S_ extends pa{constructor(){super(...arguments),this.type=P_.Rain}}e([ua({count:P_.COUNT})],S_.prototype,"type",void 0);const R_=we(),O_=we(),E_=xe(1,1,1),A_=xe(.85,.85,.85),M_=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new qr;return t.attributes.add(Sn.POSITION,"vec3"),t.attributes.add(Sn.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new Br("cameraPosition",((e,t)=>t.camera.eye))),t.vertex.uniforms.add(new Br("offset",((e,t)=>function(e,t){const i=t.camera.eye,r=.5*e.width,s=1/e.width,n=bi(R_,ui(R_,(i[0]+r)*s,(i[1]+r)*s,(i[2]+r)*s));return Ci(n,i,fi(n,n,e.width))}(e,t)))),t.vertex.uniforms.add(new Wr("width",(e=>e.width))),t.vertex.uniforms.add(new zr("proj",((e,t)=>t.camera.projectionMatrix))),t.vertex.uniforms.add(new zr("view",((e,t)=>t.camera.viewMatrix))),t.vertex.uniforms.add(new Wr("time",(e=>e.time))),t.varyings.add("vUv","vec2"),t.vertex.code.add(Tn`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===P_.Rain?Tn`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:Tn`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add(new Wr("opacity",(e=>e.opacity)),new Br("particleColor",((t,i)=>function(e,t){const i=t.type===P_.Rain?A_:E_,r=fi(R_,i,.7),s=e.camera.eye;_i(O_,s);const n=Math.max(0,gi(O_,e.lighting.mainLight.direction));return yi(r,r,i,n)}(i,e)))),t.fragment.code.add(Tn`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===P_.Rain?Tn`d = 0.35 * smoothstep(0.5, 0.0, d);`:Tn`d = smoothstep(0.5, 0.1, d);`}
      fragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class D_ extends Pn{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}}class I_ extends Xr{initializeProgram(e){return new Yr(e.rctx,I_.shader.get().build(this.configuration),L_)}initializePipeline(){return ea({blending:ra(jn.ONE,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}I_.shader=new Zr(M_,(()=>Promise.resolve().then((()=>M_))));const L_=new Map([[Sn.POSITION,0],[Sn.INSTANCEFEATUREATTRIBUTE,1]]);let N_=class extends pe{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new D_,this._animation=new On,this._updatingTracking=new rl,this._passParameters.time=0,this._passParameters.radius=Gt(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=L(this._snowTechniqueCached),this._rainTechniqueCached=L(this._rainTechniqueCached),this._vao=N(this._vao),this._instanceIdBuffer=N(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(null==this._rainTechniqueCached){const e=new S_;e.type=P_.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(I_,e)}return this._rainTechniqueCached}get _snowTechnique(){if(null==this._snowTechniqueCached){const e=new S_;e.type=P_.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(I_,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,i){const r="rainy"===i?this._rainTechnique:this._snowTechnique;if(!r.compiled)return void this.context.requestRender();const s=e.rctx;if(this._ensureResources(s),null==r||null==this._vao||null==this._instanceIdBuffer)return;if(null!=e.bindParameters.cloudsFade.data&&(this._passParameters.opacity=e.bindParameters.cloudsFade.opacity),this._passParameters.opacity<=0)return;t=t<.5?jt(0,.35,2*t):jt(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*W(this._animation.time)%1e5;const n=s.bindTechnique(r,e.bindParameters,this._passParameters);s.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),Vo(s,L_,this._instanceIdBuffer,V_,0),s.drawArraysInstanced(qn.TRIANGLES,0,3,this._numParticles*t),Uo(s,L_,this._instanceIdBuffer,V_)}_ensureResources(e){null==this._vao&&(this._vao=this._createVertexArrayObject(e)),null==this._instanceIdBuffer&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let e=0;e<this._numParticles;e++)t.push(e);return el.createVertex(e,Gn.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Ko(e,L_,{geometry:Xo(F_)},{geometry:el.createVertex(e,Gn.STATIC_DRAW,t)})}};e([ae({constructOnly:!0})],N_.prototype,"context",void 0),e([ae({constructOnly:!0})],N_.prototype,"view",void 0),e([ae({readOnly:!0})],N_.prototype,"updating",null),e([ae()],N_.prototype,"_updatingTracking",void 0),N_=e([le("esri.views.3d.environment.Precipitation")],N_);const F_=Yo().vec3f(Sn.POSITION),V_=Xo(Yo().f32(Sn.INSTANCEFEATUREATTRIBUTE),1),U_=wr(),j_=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr;return e.attributes.add(Sn.POSITION,"vec3"),e.attributes.add(Sn.COLOR,"vec4"),e.attributes.add(Sn.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add(new zr("transform",((e,t)=>function(e,t){const i=24e-8;return hr(U_,t.camera.projectionMatrix),U_[10]=i-1,U_[11]=-1,U_[14]=(i-2)*t.camera.near,ur(U_,U_,t.camera.viewMatrix),ur(U_,U_,e.modelMatrix)}(e,t))),new Gr("viewport",((e,t)=>t.camera.fullViewport)),new Wr("pixelRatio",((e,t)=>t.camera.pixelRatio))),e.vertex.code.add(Tn`void main(void) {
gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(Tn`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class k_ extends Pn{constructor(){super(...arguments),this.modelMatrix=wr()}}class q_ extends Xr{constructor(e){super(e,new pa,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,q_.shader.get().build(),Rn)}initializePipeline(){return ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),depthTest:{func:kn.LEQUAL},colorWrite:ia})}}q_.shader=new Zr(j_,(()=>Promise.resolve().then((()=>j_))));let z_=class extends pe{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return null!=this._loadDataTask&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._passParameters=new k_,this._updatingTracking=new rl}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=I(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=L(this._technique),this._vao=N(this._vao),Q_=null}render(e){const{rctx:t}=e;if(this._ensureResources(t),null==this._technique||null==this._vao)return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,e.bindParameters,this._passParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(qn.POINTS,0,this._numPoints)}_ensureResources(e){if(null!=this._technique||null==Q_)return;this._technique=new q_({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Q_.byteLength/W_;const t=new Float32Array(Q_,0,2*this._numPoints),i=new Uint8Array(Q_,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(e=>this._update(e)),k)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=hr(this._passParameters.modelMatrix,G_);pr(r,r,-i*Math.PI),ur(r,H_,r),pr(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=$_.createBuffer(r),n=s.position,a=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e],s=t[2*e+1];n.set(e,0,-Math.cos(r)*Math.sin(s)),n.set(e,1,-Math.sin(r)*Math.sin(s)),n.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),c=this._hexToRGB(B_[l[1]]);a.set(e,0,255*c[0]),a.set(e,1,255*c[1]),a.set(e,2,255*c[2]),a.set(e,3,255),o.set(e,l[0])}return new Ko(e,Rn,{geometry:Xo($_)},{geometry:el.createVertex(e,Gn.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(null!=Q_)return null;const e=Lt((async e=>{const{data:t}=await sl("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),Q_=t}));return e.promise.catch((e=>{h(e)||A.getLogger(this).error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new a("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/W_;if(t%1!=0||t>5e4||t<5e3)throw new a("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([ae({constructOnly:!0})],z_.prototype,"view",void 0),e([ae({constructOnly:!0})],z_.prototype,"requestRender",void 0),e([ae({readOnly:!0})],z_.prototype,"updating",null),e([ae()],z_.prototype,"_loadDataTask",void 0),e([ae()],z_.prototype,"_updatingTracking",void 0),z_=e([le("esri.views.3d.environment.Stars")],z_);const B_=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],H_=br(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),G_=br(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),W_=9,$_=Yo().vec3f(Sn.POSITION).vec4u8(Sn.COLOR).f32(Sn.SIZE);let Q_=null;var X_,Y_;!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(X_||(X_={}));let Z_=Y_=class extends za{constructor(e){super(e),this.produces=new Map([[ns.ENVIRONMENT_OPAQUE,()=>!(null===this._atmosphere&&null===this._stars)],[ns.ENVIRONMENT_TRANSPARENT,()=>!(null===this._atmosphere)]]),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new K_,this._newWeatherParameters=new K_,this._fadedWeatherParameters=new K_,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return null!=this.atmosphere?this.atmosphere.type:lm.None}consumes(){return this._atmosphereType===lm.Realistic?Ba:Ha}updateAnimation(e){return null!=this._precipitation&&this._precipitation.update(e)}get updating(){return null!=this._stars&&this._stars.updating||null!=this._clouds&&this._clouds.running}get weatherVisible(){return pi(this.view.state.camera.eye)-Gt(this.view.spatialReference).radius<=Ho}get usedMemory(){return this._clouds?.usedMemory??0}get _stars(){const e=this.view,t=e.environment?.starsEnabled??!1,i=this._get("_stars");return t&&null!=this._context?null!=i?i:new z_({view:e,requestRender:()=>this._setNeedsRender()}):(D(i),null)}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||null==this._context)return D(e),null;const t=this.view,i=this._context;return null!=e&&e.context===i?e:(D(e),new N_({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||null==this._context)return D(e),null;if(null!=e)return e;const t=this.view,i=this._context;return D(e),new Qm({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||null==this._context)return D(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=Gt(this.view.spatialReference).radius;return null!=e&&e.viewingMode===t&&e.planetRadius===r?e:(D(e),new Sm({rctx:i,viewingMode:t,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||null==this._context)return D(e),null;if(null!=e)return e;const t=this.view,i=this._context,r=this._context.renderContext.rctx,s=this.view.state.viewingMode;return new i_({context:i,view:t,rctx:r,viewingMode:s})}get weatherEnabled(){return!!this.view?.environmentManager?.weatherEnabled}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([U((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled})),(e=>this._updateAtmosphere(e)),j),U((()=>this._stars),t),U((()=>this._precipitation),t),U((()=>this._clouds),(()=>this._updateWeather()),k),U((()=>this._fog),(()=>this._updateFogHaze()),k),U((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),q),U((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),j)])}uninitializeRenderContext(){this._context=null,this._atmosphere=D(this._atmosphere),this._set("_stars",D(this._stars)),this._set("_precipitation",D(this._precipitation)),this._set("_clouds",D(this._clouds)),this._set("_cloudsComposition",D(this._cloudsComposition)),this._set("_fog",D(this._fog))}prepareRender(e){e.bindParameters.cloudsFade.data=ks(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&(this._updateWeatherFading(e.bindParameters,e.time),e.bindParameters.cloudsFade.renderingStage===js.FINISHED&&null!=this._clouds&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}renderNode(e){switch(e.bindParameters.slot){case ns.ENVIRONMENT_OPAQUE:null!=this._stars&&this._stars.render(e),null!=this.atmosphere&&(this.atmosphere.render(e,this.view?._stage?.renderer?.fullResolutionAtmosphere),null!=this._cloudsComposition&&null!=e.bindParameters.cloudsFade.data&&(this.weatherVisible&&null!=this._clouds&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),e.bindParameters.cloudsFade.isFading&&null!=this._context&&null!=e.bindParameters.cloudsFade.data?.cubeMap&&this._context.requestRender());break;case ns.ENVIRONMENT_TRANSPARENT:if(null!=this.atmosphere&&(this.atmosphere.renderHaze(e,this._weatherParameters.hazeAmount,this.view?._stage?.renderer?.fullResolutionAtmosphere),this._weatherParameters.fog.amount>0&&null!=this._fog&&this._fog.render(e,this._weatherParameters.fog),this._precipitation)){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}updateLightSources(e,t,i,r){if(null!=this._context){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=t,s.bindParameters.newLighting.globalFactor=i,s.bindParameters.newLighting.set(e),r===X_.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return null==e?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeatherFading(e,t){e.cloudsFade.updateFading(e.camera,this.view.state.mode,t,this.view.qualitySettings.fadeDuration),e.cloudsFade.updateParallax(e.camera),e.weatherFading&&(this._updateLighting(e),this._updateFogAtmoshpere(e))}_updateLighting(e){e.cloudsFade.fadeMode!==Us.CROSS_FADE&&e.cloudsFade.fadeMode!==Us.FADE_IN?e.fadeLighting(0):e.fadeLighting(e.cloudsFade.fadeFactor)}_updateFogAtmoshpere(e){e.cloudsFade.fadeMode!==Us.CROSS_FADE&&e.cloudsFade.fadeMode!==Us.FADE_IN?this._fadeWeather(0):this._fadeWeather(e.cloudsFade.fadeFactor)}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:i}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(i,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;null!=e&&null!=this._clouds&&(this._clouds.applyPreset(Dm[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){null!=this._context&&this._context.requestRender()}_updateFogHaze(){const e=this._weatherUpdateParameters;if(null==this._fog||null==e||null==this._context)return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=jt(3e-5,.005,e.weatherAdjustment**3),Ti(this._newWeatherParameters.fog.color,eg),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=jt(4e-6,2e-4,(e.effect??0)**3),Ti(this._newWeatherParameters.fog.color,J_),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=jt(4e-6,2e-4,(e.effect??0)**3),Ti(this._newWeatherParameters.fog.color,eg),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(t!==lm.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==t){this._atmosphere=D(this._atmosphere);const e=this._getAtmosphereClass(t);e&&(this._atmosphere=new e(this.view,this._context))}}else this._atmosphere=D(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(e){switch(e){case lm.Realistic:return bm;case lm.Local:return p_;case lm.Mars:return v_;default:case lm.None:return null}}_selectAtmosphereType(e){const{enabled:t,viewingMode:i}=e;return!t||Wt(this.view.spatialReference)?lm.None:i===Mt.Local?lm.Local:null!=this._context&&bm.isSupported(this._context)&&$t(this.view.spatialReference)?lm.Realistic:Qt(this.view.spatialReference)?lm.Mars:lm.None}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:e=>{tg=Y_.prototype._getAtmosphereClass,Y_.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{Y_.prototype._getAtmosphereClass=tg}}}};e([ae({constructOnly:!0})],Z_.prototype,"view",void 0),e([ae({readOnly:!0})],Z_.prototype,"atmosphere",null),e([ae({readOnly:!0})],Z_.prototype,"_atmosphereType",null),e([ae({type:Boolean,readOnly:!0})],Z_.prototype,"updating",null),e([ae({readOnly:!0})],Z_.prototype,"weatherVisible",null),e([ae()],Z_.prototype,"_context",void 0),e([ae()],Z_.prototype,"_atmosphere",void 0),e([ae({readOnly:!0})],Z_.prototype,"_stars",null),e([ae({readOnly:!0})],Z_.prototype,"_precipitation",null),e([ae({readOnly:!0})],Z_.prototype,"_clouds",null),e([ae({readOnly:!0})],Z_.prototype,"_cloudsComposition",null),e([ae({readOnly:!0})],Z_.prototype,"_fog",null),e([ae({readOnly:!0})],Z_.prototype,"weatherEnabled",null),e([ae({readOnly:!0})],Z_.prototype,"_precipitationEnabled",null),e([ae({readOnly:!0})],Z_.prototype,"_weatherUpdateParameters",null),Z_=Y_=e([le("esri.views.3d.environment.EnvironmentRenderer")],Z_);class K_{constructor(){this.fog=new r_,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,Ti(this.fog.color,e.fog.color)}lerp(e,t,i){this.fog.amount=jt(e.fog.amount,t.fog.amount,i),this.hazeAmount=jt(e.hazeAmount,t.hazeAmount,i),this.fog.strength=jt(e.fog.strength,t.fog.strength,i),yi(this.fog.color,e.fog.color,t.fog.color,i)}}const J_=xe(.5,.5,.5),eg=xe(1.5,1.5,1.5);let tg,ig=class extends di.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandlesKey="viewHandles",this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new Er,this._ambientLight=new Ar,this._moonLight=new Mr,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!this._renderer?.updating)}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Mt.Global&&$t(this._view.spatialReference)}get weatherVisible(){return this.weatherEnabled&&this._renderer?.weatherVisible}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Z_({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([U((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),q),U((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),q),U((()=>e.stationary),(()=>this._interactingStationaryHandler())),U((()=>e.environment.lighting.directShadowsEnabled),t,q),U((()=>e.qualitySettings.ambientOcclusion),t,q),U((()=>e.qualitySettings.reflections),t,q),U((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),q),U((()=>e.environment.weather.type),(()=>this._updateLighting(null,X_.Faded)),q),U((()=>this.weatherEnabled),(()=>this._updateLighting(null,X_.Faded)),q),U((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),j),U((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),j),U((()=>e.state.camera),i,j),U((()=>this.disableQueries),i)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=D(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!Me(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),null!=this._referencePosWGS84Comparable){const e=al(this._referencePosWGS84Comparable,ag);null!=e&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=$t(this._view.spatialReference);if(i&&!Me(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;const r=e.position;return null==this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable=we()),i?ji(r,this._referencePosWGS84Comparable):ui(this._referencePosWGS84Comparable,r.longitude??0,r.latitude??0,r.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,t=X_.Immediate){const i=this._view;e=e||("virtual"===i.environment.lighting.type?null:i.environment.lighting.date);const r=this._referencePosWGS84Comparable,s=r?rg:sg,n=this.weatherVisible?i.environment.weather.type:"disabled";null!=r?ol(e,r,i.state.viewingMode,n,i.state.camera,s):"virtual"===i.environment.lighting.type&&ll(i.state.camera,i.state.viewingMode,s.direct.directionToLightSource);const a=this._mainLight,o=s.direct;fi(a.intensity,o.color,o.intensity*Math.PI),Ti(a.direction,o.directionToLightSource),a.specularStrength=s.specularStrength,a.environmentStrength=s.environmentStrength;const l=this._ambientLight;fi(l.intensity,s.ambient.color,s.ambient.intensity);const c=this._moonLight;yi(c.intensity,og,lg,s.globalFactor);const h=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));fi(c.intensity,c.intensity,h),Ti(c.direction,o.directionToLightSource),this._renderer.updateLightSources([a,l,c],s.noonFactor,s.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||null==e)return!1;const i=ng;i.setTime((t||this._view.environment.lighting.date).getTime());const r=al(e,ag);if(null==r)return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),a=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(a),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=null==this._referencePosWGS84Comparable||cl(this._referencePosWGS84Comparable[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=d(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=d(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};e([ae({type:Boolean,readOnly:!0})],ig.prototype,"updating",null),e([ae()],ig.prototype,"disableQueries",void 0),e([ae()],ig.prototype,"_disableWeather",void 0),e([ae()],ig.prototype,"weatherEnabled",null),e([ae()],ig.prototype,"weatherVisible",null),e([ae()],ig.prototype,"referencePositionWGS84Comparable",null),e([ae()],ig.prototype,"_renderer",void 0),e([ae()],ig.prototype,"_referencePosWGS84Comparable",void 0),ig=e([le("esri.views.3d.environment.SceneViewEnvironmentManager")],ig);const rg=new hl,sg=new hl,ng=new Date,ag={hours:0,minutes:0,seconds:0},og=xe(.22,.22,.33),lg=xe(.22,.22,.22);var cg,hg,dg;!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(cg||(cg={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(hg||(hg={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(dg||(dg={}));class ug{constructor(e=cg.ALL,t=hg.NONE,i=0,r=null,s=null,n=dg.TUMBLE){this.selection=e,this.interactionType=t,this.interactionFactor=i,this.interactionStartCamera=r,this.interactionDirection=s,this.tiltMode=n}}function pg(e,t){return 0!=(e&t)}function mg(e,t,i,r,s,n){0!==e&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):null!=r?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}const _g=new ug(cg.NONE);function gg(e,t,i,r){return t=t||e.viewForward,Ti(r,t),fi(r,r,Math.sign(gi(t,i))),r}function fg(e,t,i=_g){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||t.interactionType===hg.TUMBLE&&pg(t.selection,cg.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const r=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,yg);!function(e,t,i){const r=t.interactionType;if(r===hg.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===hg.TUMBLE||r===hg.ZOOM,c=fg(e,a),h=0===c?0:e.renderCoordsHelper.getAltitude(a.eye);i.min=s,i.max=n,mg(c,h,l,o,.05*h,i)}(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=Ft(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}const yg={min:0,max:0},vg=we(),xg=we(),wg=we(),bg=we();function Cg(e,t,i=_g){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;Pg.min=0,Pg.max=r,function(e,t,i){const r=t.interactionType;if(r===hg.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:a,interactionFactor:o}=t;if(!a)return;const l=r===hg.ZOOM||r===hg.PAN,c=Cg(e,a),h=0===c?0:Tg(e,a);i.min=s,i.max=n,mg(c,h,l,o,.05*h,i)}(e,i,Pg);const s=Tg(e,t),n=Pg.max-s;return n>=-1e-6?0:n}function Tg(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?xi(t.eye,i.renderLocation):0}const Pg={min:0,max:0},Sg=we(),Rg=we(),Og=we(),Eg=we(),Ag=we();function Mg(e,t,i=Dg.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=Ql(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),a=s+r.collision.elevationMargin;if(n>=a)return!1;const o=pi(t.eye);if(Pi(Ig,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Lg,a,t.eye),i===Dg.EYE_AND_CENTER)t.center=vi(Ig,t.eye,Ig);else if(i===Dg.EYE_AND_CENTER_SCALE){const e=(o-n+a)/o;t.center=fi(Ig,t.center,e)}return!0}var Dg;!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Dg||(Dg={}));const Ig=we(),Lg=we();function Ng(e,t,i){e.worldUpAtPosition(t,Fg),Pi(Vg,i,t);const r=pi(Vg);return 0===r?0:qt(gi(Vg,Fg)/r)}const Fg=we(),Vg=we();function Ug(e,t,i,r=_g,s){if(!e.state.constraints.tilt)return 0;const n=t.distance,a=e.state.constraints.tilt(n,$g);return function(e,t,i){if(t.interactionType===hg.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t;if(!r)return;const{min:n,max:a}=i,o=Ug(e,r,_g,t),l=0===o?0:Ng(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=a,t.interactionType===hg.TUMBLE?(pg(t.selection,cg.ALTITUDE)&&zg(e,r,i),mg(o,l,!0,s,Wg,i)):mg(o,l,!1,s,Wg,i)}(e,i,a),r.interactionType===hg.TUMBLE&&pg(r.selection,cg.ALTITUDE)&&zg(e,r.interactionStartCamera,a),i.tiltMode===dg.LOOK_AROUND||r.tiltMode===dg.LOOK_AROUND?function(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,r){const s=jg(e,t,Qg),n=Ft(s.tiltAtCenter,i.min,i.max);if(!kg(s.tiltAtCenter-n))return 0;let a,o;return s.centerIsOnSurface?(a=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const a=qg(e,n);if(t.clampTilt(a,r)===n)return n;let o=0;for(;o<10&&kg(n-s);){const i=(s+n)/2,r=qg(e,i);kg(t.clampTilt(r,i)-i)?s=i:n=i,o++}return n}(s),o=function(e,t){const i=zt(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=zt(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}(s,a)):(a=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&a<Math.PI/2&&(r.requiresTwoSteps=!0,a=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,a)),r&&(r.eyeCenterDistance=qg(s,a)),o}(e,t,i,r);case"local":return function(e,t,i,r){const s=Ng(e.renderCoordsHelper,t.center,t.eye),n=Ft(s,i.min,i.max),a=s-n;if(!kg(a))return 0;if(r){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,a=Math.cos(n);Math.abs(a)>1e-4?r.eyeCenterDistance=s/a:r.eyeCenterDistance=t.distance}return a}(e,t,i,r)}}(e,t,a,s):function(e,t,i){const r=Ng(e.renderCoordsHelper,t.center,t.eye),s=r-Ft(r,i.min,i.max);return kg(s)?s:0}(e,t,a)}function jg(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Gt(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,Gg);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,null!=n?(i.eyeCenterDistance=xi(t.eye,n),i.tiltAtCenter=Ng(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Ng(e.renderCoordsHelper,t.center,t.eye):(_l(gl(fl,s),t.ray,Gg),i.eyeCenterDistance=xi(t.eye,Gg),i.tiltAtCenter=qt(-gi(t.viewForward,_i(Gg,Gg)))),i.radius=s,i.eyeRadius=pi(t.eye),i.constraints=e.state.constraints,i}function kg(e){return Math.abs(e)>1e-9}function qg(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Ft(t,0,Math.PI),r=zt(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const t=Math.PI-r,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function zg(e,t,i){const r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;const s=mi(t.center),n=Math.sqrt(s),a=t.distance,o=Gt(e.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-a*a-s)/(-2*n*a),d=(c*c-a*a-s)/(-2*n*a);i.min=Math.max(i.min,Math.min(Math.PI-qt(d),i.max)),i.max=Math.min(i.max,Math.PI-qt(h))}const Bg=we(),Hg=wr(),Gg=we(),Wg=Vt(5),$g={min:0,max:0},Qg={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Xg={eyeCenterDistance:0,requiresTwoSteps:!1};function Yg(e,t,i=Jg,r=t){r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let s=!1;for(let t=0;t<ef;t++){let t=0;for(const n of Kg)if(pg(i.selection,n.type)){const a=Math.abs(n.error(e,r,i));n.apply(e,r,i)&&(s=!0,t+=a)}if(0===t)break}const n=pg(i.selection,cg.COLLISION),a=function(e,t){switch(e){case hg.PAN:return Dg.EYE_AND_CENTER;case hg.ASCEND:return t.state.isGlobal?Dg.EYE_AND_CENTER_SCALE:Dg.EYE_AND_CENTER;default:return Dg.EYE}}(i.interactionType,e);return n&&Mg(e,r,a)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function Zg(e){const t=Math.min(1,e/150);return hc(t)}const Kg=[{type:cg.TILT,error:function(e,t,i){return Ug(e,t,i)*t.distance},apply:function e(t,i,r,s=!0){Xg.eyeCenterDistance=0,Xg.requiresTwoSteps=!1;const n=Ug(t,i,r,_g,Xg);if(0===n)return!1;switch(mr(Hg,-n,i.viewRight),r.tiltMode){case dg.LOOK_AROUND:Ri(Bg,i.viewForward,Hg),fi(Bg,Bg,Xg.eyeCenterDistance),i.center=vi(Gg,i.eye,Bg);break;case dg.TUMBLE:Pi(Bg,i.center,i.eye),Ri(Bg,Bg,Hg),i.eye=Pi(Gg,i.center,Bg);break;default:ni(r.tiltMode)}return i.up=Ri(Gg,i.up,Hg),!Xg.requiresTwoSteps||!s||e(t,i,r,!1)}},{type:cg.ALTITUDE,error:fg,apply:function(e,t,i=_g){const r=fg(e,t,i);if(0===r)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,a=gg(t,i.interactionDirection,function(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),fi(r,r,i),r}(e,t,Math.sign(r),xg),vg),o=Ti(wg,t.viewForward),l=s.intersectInfiniteManifold(Cl(t.eye,a),n,bg);return t.eye=null!=l?l:s.setAltitude(bg,n,t.eye),t.center=kl(bg,t.eye,o,t.center),!0}},{type:cg.DISTANCE,error:Cg,apply:function(e,t,i=_g){const r=Cg(e,t,i);if(0===r)return!1;const s=e.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=Tg(e,t)+r,a=Ti(Sg,t.eye),o=gg(t,i.interactionDirection,function(e,t,i){return Si(Eg,e.eye,t)}(t,s.renderLocation),Og);if(!pl(ml(s.renderLocation,n),Cl(t.eye,o),Ag))return!1;t.eye=Ag;const l=Pi(Rg,t.eye,a);t.center=vi(Ag,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,Ag);return null!=h&&(t.center=h),!0}}],Jg=new ug,ef=5;class tf{constructor(e){this.viewingMode=e,this.center=we(),this.pitch=0,this.yaw=0,this.distance=0,this.direction=be(hf),this.fov=55,this.size=1}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Mt.Global){const i=(pi(this.center)+pi(e.center))/2;t.pan=ti(this.center,e.center)*i}else t.pan=xi(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const r=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,r),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){this.viewingMode===Mt.Global?ii(e.center,t.center,i.pan,this.center):yi(this.center,e.center,t.center,i.pan),this.distance=isFinite(t.distance)?t.distance*i.zoom:e.distance,this.pitch=jt(e.pitch,t.pitch,i.rotate);let r=e.yaw;const s=t.yaw;Math.abs(s-r)>=Math.PI&&(r+=2*(r<s?1:-1)*Math.PI),this.yaw=jt(r,s,i.rotate)}copyFrom(e){Ti(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,Ti(this.direction,e.direction),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,uf);Ti(this.center,e.center),Pi(af,e.center,e.eye),Oi(af,af,t),Oi(of,e.up,t),this.distance=pi(af),0!==this.distance&&(af[0]/=this.distance,af[1]/=this.distance,af[2]/=this.distance),this.pitch=this._eyeUpToPitch(af),this.yaw=function(e,t){const i=lf;return Math.abs(t[2])<.5?(Ti(i,t),e[2]>0&&fi(i,i,-1)):Ti(i,e),wi(sf,i,cf),_i(sf,sf),ti(df,sf,cf)}(af,of),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,uf);wo(t,t),this._axisAngleVec3(df,this.pitch-Math.PI/2,hf,af),this._axisAngleVec3(cf,this.yaw,af,af),this._axisAngleVec3(df,this.pitch-Math.PI/2,cf,of),this._axisAngleVec3(cf,this.yaw,of,of),fi(af,af,this.distance),Oi(af,af,t),Oi(of,of,t),e.center=this.center,e.eye=Pi(af,this.center,af),e.up=of}_axisAngleVec3(e,t,i,r){const s=Math.cos(t),n=Math.sin(t);return fi(rf,i,s),wi(sf,e,i),fi(sf,sf,n),fi(nf,e,(1-s)*gi(e,i)),vi(r,vi(r,rf,sf),nf)}_lookAtOrientation(e,t=Oo()){return this._upAtLookAt(e,nf),wi(rf,this.direction,nf),_i(rf,rf),0===rf[0]&&0===rf[1]&&0===rf[2]&&Ti(rf,df),wi(sf,nf,rf),_i(sf,sf),t[0]=rf[0],t[1]=sf[0],t[2]=nf[0],t[3]=rf[1],t[4]=sf[1],t[5]=nf[1],t[6]=rf[2],t[7]=sf[2],t[8]=nf[2],t}_upAtLookAt(e,t){return this.viewingMode===Mt.Local?Ti(t,cf):_i(t,e)}_eyeUpToPitch(e){return Math.PI-ti(cf,e)}}const rf=we(),sf=we(),nf=we(),af=we(),of=we(),lf=we(),cf=Ce,hf=Te,df=Pe,uf=Oo();class pf{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=$(0),this._animation=new dc((()=>new tf(e))),this._current=new tf(e)}update(e,t,i){const{source:r,target:s}=this._animation.definition,n=Pi(mf,t.center,e.center),a=pi(n);a>=1e-5?(n[0]/=a,n[1]/=a,n[2]/=a):(n[0]=0,n[1]=1,n[0]=0),Ti(r.direction,n),Ti(s.direction,n),r.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(r),this._animation.update(r,s,i),this.currentTime=$(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Ic,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=$(this.currentTime+Q(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}const mf=we();var _f;!function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"}(_f||(_f={}));let gf=class extends pe{constructor(e){super(e),this.state=_f.Ready}get active(){return this.state===_f.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=_f.Stopped,!0)}finishController(){this.state=_f.Finished}get steppingFinished(){return!1}};e([ae({constructOnly:!0})],gf.prototype,"view",void 0),e([ae({readOnly:!0})],gf.prototype,"active",null),e([ae()],gf.prototype,"state",void 0),e([ae({readOnly:!0})],gf.prototype,"isInteractive",null),gf=e([le("esri.views.3d.state.controllers.CameraController")],gf);let ff=class extends gf{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(o()),this._asyncResult=null),this.state===_f.Finished||this.state===_f.Stopped?(F(e),this.state===_f.Finished?e.resolve():e.reject(o())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=_f.Running,null!=this.viewAnimation&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){null==this.viewAnimation||this.state!==_f.Ready&&this.state!==_f.Running||(this.viewAnimation.state===At.State.FINISHED?this.finish():this.viewAnimation.state===At.State.STOPPED&&(this.state=_f.Stopped))}onControllerEnd(){null==this.viewAnimation||this.viewAnimation.done||(this.state===_f.Finished?this.viewAnimation.finish():this.state===_f.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===_f.Finished?this._asyncResult.resolve():this._asyncResult.reject(o()))}finish(){this.finishController()}};ff=e([le("esri.views.3d.state.controllers.AnimationController")],ff);let yf=class extends ff{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new pf(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new At}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);vf.copyFrom(this.view.state.camera);const r=Nc(this.view.state.viewingMode);this.intersectionHelper.intersectRay(vf.ray,r,xf)&&(vf.center=xf),this.animation.update(vf,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?uc[e.easing]:e.easing}}};e([ae({constructOnly:!0})],yf.prototype,"mode",void 0),e([ae({readOnly:!0})],yf.prototype,"isInteractive",null),yf=e([le("esri.views.3d.state.controllers.PointToPointAnimationController")],yf);const vf=new Ic,xf=we();function wf(e=Tf){return[e[0],e[1],e[2],e[3]]}function bf(e,t){return function(e,t,i,r,s=wf()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}(e[0],e[1],e[2],t,Tl.get())}function Cf(e,t,i){return wi(i,e,t),_i(i,i),i[3]=Pl(e,t),i}const Tf=[0,0,1,0];function Pf(e,t,i,r){const s=Hc(t,i,Sf);return pl(e,s,r)}const Sf=Sl();var Rf;!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(Rf||(Rf={}));const Of=[1,3e8],Ef=1508e5,Af={exclude:new Set([$c])};function Mf(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Df(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function If(e,t,i){const r=mr(Ol.get(),i[3],i);null==r||_r(r,Cr)||(Pi(Cy,e.eye,t),Ri(Cy,Cy,r),e.eye=vi(Cy,Cy,t),Pi(Cy,e.center,t),Ri(Cy,Cy,r),e.center=vi(Cy,Cy,t),e.up=Ri(Cy,e.up,r))}function Lf(e,t,i,r){return El(e,Hc(t,i,Oy),r)}function Nf(e,t,i,r){const s=Al.get();let n=1-i;Pi(s,t,e.eye);const a=pi(s);let o=a*(1-n);n>=0&&o<r&&(o=r,n=-(o-a)/a),Math.abs(a-o)<1e-6||(fi(s,s,n),e.eye=vi(Cy,e.eye,s),e.center=yi(Cy,e.center,t,n))}function Ff(e,t,i){t.getScreenCenter(Vf),Pf(e,t,Vf,Cy)&&(t.center=Cy);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=fi(Al.get(),t.viewForward,s);t.eye=Pi(Cy,t.center,n)}const Vf=J();function Uf(e,t){ui(t,0,0,0);for(const i of e)vi(t,t,i);fi(t,t,1/e.length)}function jf(e,t,i,r){return Math.sin(e/pi(t))*(i+r.radius)}function kf(e,t,i,r){return jf(Math.PI/2,t,i,r)+(e-Math.PI/2)}var qf;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(qf||(qf={}));const zf=Vt(16),Bf=.95,Hf=Vt(18),Gf=45,Wf=Vt(80);function $f(e,t,i,r,s,n){const a=we(),o=vl();let l=!0,c=!0;return e.intersectScreen(i,a,n)?o[3]=pi(a):(c=!1,t.aboveGround&&s!==Rf.Ellipsoid?o[3]=Math.max(pi(t.center),.9*r.radius):o[3]=pi(t.eye)-t.relativeElevation,s===Rf.Silhouette?Zf(o,t,i,a):l=Pf(o,t,i,a)),{sphere:o,scenePickPoint:l?a:null,hasGeometryIntersection:c}}function Qf(e,t,i){return pi(e.eye)-i.radius>3e4?qf.Horizontal:(Hc(e,t,Ey),-Math.sign(e.relativeElevation)*(.5*Math.PI+Pl(e.eye,Ey.direction))<zf?qf.Vertical:qf.Horizontal)}function Xf(e,t,i){Pi(Yf,i,t),e.eye=Pi(Cy,e.eye,Yf),e.center=Pi(Cy,e.center,Yf)}const Yf=we();function Zf(e,t,i,r){const s=Hc(t,i,Oy);return!(null==s||(_l(e,s,Kf),pl(e,s,r)?Ei(Kf,s.origin)<Ei(r,s.origin)&&(Ti(r,Kf),1):(Pi(Jf,t.eye,t.center),_i(Jf,Jf),Ml(Jf,-gi(_i(Jf,Jf),Kf),ey),El(ey,s,r),1)))}const Kf=we(),Jf=we(),ey=Rl();function ty(e,t,i,r,s,n){let a=0;if(wi(Sy,e,t),Pi(Ty,e,t),pi(e)<=s||!r.aboveGround){wi(i,Ty,r.eye);const o=gi(e,t)/(pi(e)*pi(t));if(o<.9999)a=qt(o);else{const i=pi(wi(we(),e,t))/(pi(e)*pi(t));a=zt(i)}const l=Math.cos(Ft(zc.normalize(Vt(n)),0,Wf));a=-a-Math.max(0,pi(t)-s)/(l*s)}else Pi(iy,r.eye,r.center),wi(i,Ty,iy),a=-pi(Ty)/s;return _i(i,i),fi(i,i,pi(Sy)),a}const iy=we();function ry(e,t,i,r){let s,n;const a=Math.cos(Ft(zc.normalize(Vt(r)),0,Wf));return s=t>i?-(t-i)/(a*i):t<-i?Math.PI-(t+i)/(a*i):qt(t/i),n=e>i?-(e-i)/(a*i):e<-i?Math.PI-(e+i)/(a*i):qt(e/i),(n-s)*i}function sy(e,t,i,r,s,n,a,o,l,c){wi(Sy,e,t),ut(n.up,n.eye,uy,py,my),ut([0,0,1],n.eye,cy,hy,dy),Ti(i,hy),Ti(r,cy),_i(i,i),fi(i,i,pi(Sy)),pt(e,_i(py,py),_i(my,my),_i(uy,uy),_y),pt(t,py,my,uy,gy),function(e,t,i,r,s,n,a,o,l,c){const h=ry(e[2],t[2],n[3],o),d=l?ry(e[0],t[0],n[3],180):t[0]-e[0],u=Math.sin(a)*d-Math.cos(a)*h,p=Math.cos(a)*d+Math.sin(a)*h;_i(Cy,s);const m=l?u/Math.sqrt(Math.abs(n[3]**2-gi(i,Cy)**2)):u/n[3],_=p/Math.sqrt(Math.abs(n[3]**2-gi(i,r)**2));zi(c,m,_)}(_y,gy,e,cy,hy,a,o,l,c,s)}function ny(e,t,i,r,s,n){mr(vy,r,i),mr(xy,n,s),ur(wy,vy,xy),Pi(Cy,e.eye,t),Ri(Cy,Cy,wy),e.eye=vi(Cy,Cy,t),Pi(Cy,e.center,t),Ri(Cy,Cy,wy),e.center=vi(Cy,Cy,t),Pi(Cy,e.up,t),Ri(Cy,Cy,wy),e.up=vi(Cy,Cy,t)}function ay(e,t,i,r,s,n){return(Math.abs(r)>Math.PI-Hf||Math.abs(r)<Hf)&&(Math.abs(e[2])<i*Bf||Math.abs(t)>i)&&n.aboveGround&&s<Gf}function oy(e,t,i,r,s,n){if(n)Cf(i,r,yy),If(t,yl(e),yy);else{const n=ty(i,r,Ry,t,e[3],s);If(t,yl(e),bf(Ry,n))}}function ly(e,t,i,r,s,n,a){const o=a?20:1;let l,c;Ti(by,r),Py.copyFrom(t);for(let r=0;r<o&&Ei(i,by)>1e-12&&(l=Ei(i,by),sy(i,by,hy,cy,fy,Py,e,s,n,a),ny(Py,yl(e),cy,fy[1],hy,fy[0]),h=by,d=by,u=yl(e),p=cy,m=fy[1],_=hy,g=fy[0],mr(vy,m,p),mr(xy,g,_),ur(wy,vy,xy),Pi(d,h,u),Ri(d,d,wy),vi(d,d,u),c=Ei(i,by),c<l||0===r);r++)t.copyFrom(Py);var h,d,u,p,m,_,g}const cy=we(),hy=we(),dy=we(),uy=we(),py=we(),my=we(),_y=we(),gy=we(),fy=nr(),yy=wf(),vy=wr(),xy=wr(),wy=wr(),by=we(),Cy=we(),Ty=we(),Py=new Ic,Sy=we(),Ry=we(),Oy={origin:we(),direction:we()},Ey={origin:we(),direction:we()};let Ay=class extends yf{constructor(){super(...arguments),this._zoomLocation=we(),this._tmpCamera=new Ic,this._tmpViewDir=we(),this._tmpRayDir={origin:we(),direction:we()},this._targetOnSphere=we(),this._tmpCenter=we(),this._beginCamera=new Ic,this._constraintOptions=new ug(cg.ALL_EXCEPT_COLLISION,hg.ZOOM,null,this._beginCamera),this._sphere=vl()}initialize(){this._intersector=Nc(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,s=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?Af:{})&&(r=e>0,s=!0),this._tmpCamera.copyFrom(i.camera),r?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:Ti(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,s),this.begin(this._tmpCamera)}animationSettings(){return{duration:$(600),easing:pc}}_updateCamera(e,t,i,r,s){const n=Qf(e,r,Gt(this.view.spatialReference)),a=Math.abs(this.view.camera.position.z);_i(Dy,e.eye),fi(Dy,Dy,-1),Hc(e,r,this._tmpRayDir),_i(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=Ft(Math.min(8,1/Math.abs(gi(Dy,this._tmpRayDir.direction)))*a,200,Ef);if(n===qf.Horizontal){let s=.6**t;this._sphere[3]=pi(i),Pi(this._tmpViewDir,e.center,e.eye);const n=Math.min(pi(this._tmpViewDir),o);let a=n*s;if(s<=1&&a<4&&(a=4,s=a/n),Math.abs(n-a)<1e-6)return;const m=pi(e.center);if(this._sphere[3]!==m){const t=this._sphere[3]+s*(m-this._sphere[3]);e.center=fi(My,e.center,t/m)}fi(this._tmpViewDir,this._tmpViewDir,-s),e.eye=vi(My,e.center,this._tmpViewDir),Yg(this.view,e,this._constraintOptions),Ei(i,e.center)>1e-12&&Pf(this._sphere,e,r,this._targetOnSphere)&&(l=this._sphere,c=e,h=i,d=this._targetOnSphere,u=this.view.camera.heading,p=this.view.camera.tilt,ay(h,gi(c.up,h),l[3],-zc.normalize(Vt(u)),p,c)?ly(l,c,h,d,-zc.normalize(Vt(u)),p,!0):oy(l,c,h,d,p,!0))}else{let n=.6**Math.abs(t);const a=t>0?1:-1;Pi(this._tmpViewDir,i,e.eye);const l=pi(this._tmpViewDir),c=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,60);let h=null!=c?c:o;h=s&&t>0?Math.min(h,l):h,fi(this._tmpRayDir.direction,this._tmpRayDir.direction,h),vi(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=h*n;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,n=d/h),Math.abs(h-d)<1e-6)return;fi(this._tmpRayDir.direction,this._tmpRayDir.direction,a*(1-n)),e.eye=vi(My,e.eye,this._tmpRayDir.direction),e.center=vi(My,e.center,this._tmpRayDir.direction)}var l,c,h,d,u,p;Mg(this.view,e)}};Ay=e([le("esri.views.3d.state.controllers.global.ZoomStepController")],Ay);const My=we(),Dy=we();let Iy,Ly=null;const Ny=new Map;async function Fy(e){null==Ly&&(null==Iy&&(Iy=import("../chunks/VoxelWasmPerSceneView.js")),Ly=await Iy);const t=e.view;let i=Ny.get(t);return i||(i=new Ly.default({view:t}),Ny.set(t,i)),i.addVoxelLayer(e)}function Vy(e){return Ny.get(e)}function Uy(e){const t=e.view,i=Ny.get(t);i&&i.removeVoxelLayer(e)<1&&(Ny.delete(t),0===Ny.size&&(Iy=null,Ly=null))}let jy=class extends yf{constructor(){super(...arguments),this._zoomLocation=we(),this._tmpCamera=new Ic,this._tmpRayDir=we(),this._tmpCenter=we(),this._beginCamera=new Ic,this._constraintOptions=new ug(cg.ALL,hg.ZOOM,null,this._beginCamera)}zoomStep(e,t){if(!this.active)return;const i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);const r=Nc(this.view.state.viewingMode);let s=!1;e>0?(s=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?Af:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:Ti(this._zoomLocation,this._tmpCamera.center);const n=.6**e;let a=this.view._stage.renderView.getMinimalDepthForArea(Vy(this.view),t[0],t[1],this.view.state.camera,60);Pi(zy,this._tmpCamera.eye,this._zoomLocation),_i(zy,zy);const o=Ft(Math.min(8,1/Math.abs(gi(qy,zy)))*Math.abs(this.view.camera.position.z),200,Ef);if(a=null!=a?a:o,a){const e=we();Pi(e,this._zoomLocation,this._tmpCamera.eye),(a<pi(e)||!s)&&(_i(e,e),vi(this._zoomLocation,this._tmpCamera.eye,fi(e,e,a)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:$(600),easing:pc}}_updateCamera(e,t,i){Pi(this._tmpRayDir,i,e.eye);const r=pi(this._tmpRayDir);let s=r*t;const n=t<=1,a=Math.max(4,1.01*e.nearFar[0]);0!==s&&(n&&s<a&&(s=a,t=s/r),Math.abs(r-s)<1e-6||(fi(this._tmpRayDir,this._tmpRayDir,t),e.eye=Pi(ky,i,this._tmpRayDir),e.center=yi(ky,e.center,i,1-t),Yg(this.view,e,this._constraintOptions)))}};jy=e([le("esri.views.3d.state.controllers.local.ZoomStepController")],jy);const ky=we(),qy=xe(0,0,1),zy=we();class By extends Yc{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if(mc(t,"primary")){const i=this._view.state.isGlobal?new Ay({view:this._view,mode:"animation"}):new jy({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),J(t.x,t.y)),e.stopPropagation()}}}class Hy{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Gt(t),this._unitInMeters=Xt(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,r,s){s||(s={near:0,far:0});let n=e[2]*this._unitInMeters;const a=n,o=n-r,l=this._elevationProvider?.visibleElevationBounds;l&&(n=o>=0?a-this._unitInMeters*l.min:this._unitInMeters*l.max-a);const c={x:(i=null!=i?i:new Jc({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},h=Math.max(c.x,c.y,c.z);Pi(Ky,t,e),Zy[0]=Ky[0]>0?i.xmax:i.xmin,Zy[1]=Ky[1]>0?i.ymax:i.ymin,Zy[2]=Ky[2]>0?h/2:-h/2,Pi(Zy,Zy,e),_i(Ky,Ky);const d=1.1*gi(Zy,Ky)*this._unitInMeters,u=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),p=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=p*Xy*this._unitInMeters,_=p*Yy*this._unitInMeters,g=Ft((n-_)/(m-_),0,1)**3,f=Math.min(jt(u,d,g),u)*Math.max(Math.log(Math.abs(o)),1);return Wy(Math.min(f,Math.max(34064e4,h))/this._unitInMeters,$y,this._unitInMeters,s)}}class Gy{constructor(e){this._referenceEllipsoid=Gt(e)}compute(e,t,i,r,s){s||(s={near:0,far:0});const n=pi(e),a=n-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,r),l=Math.abs(a-r),c=Math.max(l,Math.abs(a)),h=Math.sqrt(c*(c+2*o)),d=n+this._referenceEllipsoid.radius;return Wy(1.2*jt(h,d,cm(c)),Ft(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function Wy(e,t,i,r){const s=Qy/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const $y=2e4,Qy=2,Xy=.001,Yy=1e-4,Zy=we(),Ky=we();let Jy=class extends pe{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;null!=e.spatialReference&&Xl(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>Mg(this.view,e,Dg.EYE_AND_CENTER)))}};e([ae({constructOnly:!0})],Jy.prototype,"view",void 0),Jy=e([le("esri.views.3d.state.ElevationCollisionConstraint")],Jy);let ev=class extends pe{constructor(e){var t,i,r;super(e),this.nearFarHeuristic=(t=e.view.state.viewingMode,i=e.view.basemapTerrain,r=e.view.renderCoordsHelper.spatialReference,t===Mt.Global?new Gy(r):new Hy(i,r))}initialize(){this.addHandles([U((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),U((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e))),U((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),q),U((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),q),U((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),q),U((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),q),U((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),q),U((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),q)]),this.view.state.isLocal&&this.addHandles(U((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),k)),this._updateNearFar(),this.view.state.viewingMode!==Mt.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Jy({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>this._updateCameraNearFarManual(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Ql(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(cg.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Mt.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Vt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Ut(i))}}_updateLocalSurfaceDistance(e){if(null==e)return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=cg.ALL){this.view.state.updateCamera((t=>Yg(this.view,t,new ug(e,hg.NONE,null))))}};e([ae({constructOnly:!0})],ev.prototype,"view",void 0),e([ae({readOnly:!0})],ev.prototype,"surfaceCollisionConstraint",void 0),ev=e([le("esri.views.3d.state.ConstraintsManager")],ev);class tv{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=ih(),this._points=rh(),this.lines=new Array(12),this._origin=we(),this._direction=we(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:we(),endpoint:null}}update(e){sh(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),Ti(this._origin,e.eye),Ti(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)Ti(this._points[t],e[t]);nh(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return ah(this.frustum,e)}intersectsRay(e){return oh(this.frustum,e)}intersectsLineSegment(e,t){return lh(this.frustum,e,t)}intersectsPoint(e){return ch(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;iv(this.lines[t],e[t],e[i]),iv(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),iv(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function iv(e,t,i){e.origin=t,e.endpoint=i,Si(e.direction,t,i)}tv.planePointIndices=hh,tv.nearFarLineIndices=[[th.NEAR_BOTTOM_LEFT,th.FAR_BOTTOM_LEFT],[th.NEAR_BOTTOM_RIGHT,th.FAR_BOTTOM_RIGHT],[th.NEAR_TOP_RIGHT,th.FAR_TOP_RIGHT],[th.NEAR_TOP_LEFT,th.FAR_TOP_LEFT]];let rv=class extends gf{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=_f.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(null==e.spatialReference||Xl(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),Mg(this.view,e,Dg.EYE_AND_CENTER)||this.constraintEnabled||(this.state=_f.Stopped)}))}};e([ae({constructOnly:!0})],rv.prototype,"desiredCamera",null),rv=e([le("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],rv);class sv{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this._animationController=null,this.promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;null!=this.options.signal&&u(this.options.signal,(()=>{this.abort()})),this._abortController=i,this.waitForReady()}))}resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&null!=this._animationController&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(o())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await z((()=>this.view.ready),this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}async createViewPoint(){if("finished"!==this.state){this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null;try{const e=await mh(this.view,this.target,this._abortController.signal);if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(null==t)return;if(this.options.animate){if(null==this._animationController)return;this.startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}catch(e){this.reject(e)}}}_getCameraFromViewpoint(e){const r=!!(this.target instanceof i&&this.target.camera||this.target instanceof t),s=e.camera;if(null==s)return null;if(!this.view.stateManager.isCompatible(s)){const e=s.position,t=e&&e.spatialReference,i=t?t.wkid:"none",r=this.view.spatialReference?.wkid;return this.reject(new a("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${i}, view: ${r})`,{camera:s})),null}const n=Yl(this.view,s);return null==n?(this.reject(new a("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:n,isFullySpecified:r}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(null==i)return void this.reject(new a("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||null==t.viewAnimation||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let r;e.isFullySpecified?(r=new rv({view:this.view,desiredCamera:e.camera}),Mg(this.view,e.camera,Dg.EYE_AND_CENTER)):Yg(this.view,e.camera),t.begin(e.camera,this.options);const s=e=>{if(null!=this.view.state)switch(t.state){case _f.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case _f.Ready:case _f.Rejected:case _f.Running:case _f.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;r&&(i&&i.active?i instanceof yf&&null!=i.viewAnimation&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=r):null!=t.viewAnimation&&t.viewAnimation.target===e.viewpoint&&t.state===_f.Finished&&(this.view.state.cameraController=r))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return i instanceof yf&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new yf({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(null!=t&&t.stop(),this.reject(new a("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}let nv=class extends pe{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=_v,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return null!=this.renderState},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(e){this.viewStateManager._idleTimeout=e?_v:0}},this._propertiesPool=new fh({frustum:tv},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new av}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([B((()=>this.view.state.events),"before-camera-change",(e=>e&&this._updateElevation(e))),U((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),q)]),H((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([X({prepare:()=>this._prepareFrame()}),U((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(pv)})),B((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=D(this._propertiesPool)}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Zl(this.view,this.view.state.camera,hv);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(Yl(this.view,e),{applyConstraints:!1})||A.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Zl(this.view,this.view.state.contentCamera,hv);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Yl(this.view,e);null!=t?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(mv),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=Se(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([U((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(mv),this.test.contentCameraResetState.clear())})),U((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))})),U((()=>this.view.state.camera),(e=>{const t=Ei(r,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],mv),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():A.getLogger(this).error("#center=","Invalid center",e):A.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):A.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=Kl(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return null!=t?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||A.getLogger(this).error("#extent=","Invalid extent",e):A.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):A.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){const e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Jl(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||A.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[Lc.TOP]/i),n=Math.round(t[Lc.RIGHT]/i),a=Math.round(t[Lc.BOTTOM]/i),o=Math.round(t[Lc.LEFT]/i);return null!=r&&r.top===s&&r.right===n&&r.bottom===a&&r.left===o?r:{top:s,right:n,bottom:a,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,uv),this.view.state.updateCamera((e=>e.padding=uv)))}_paddingToArray(e,t,i){e?$i(i,e.top||0,e.right||0,e.bottom||0,e.left||0):$i(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return ee((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?_h(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||A.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const t=null!=e.camera?e.camera.position:e.targetGeometry,i=null!=t&&t.spatialReference;A.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else A.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?ec(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||A.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);const i=this.view._stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Mo(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return null!=this._devicePixelRatioOverride?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(eo.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?._stage?.renderer;return e&&(e.isFeatureEnabled(eo.PhysicalPixelRendering,yh.IDLE)||e.isFeatureEnabled(eo.PhysicalPixelRendering,yh.INTERACTING)||e.isFeatureEnabled(eo.PhysicalPixelRendering,yh.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!De(this.center.spatialReference,e)||this._isOverridden("camera")&&!De(this.camera.position.spatialReference,e)||this._isOverridden("extent")&&!De(this.extent.spatialReference,e)||!(!this._isOverridden("viewpoint")||De(this.viewpoint.targetGeometry?.spatialReference,e)&&De(this.viewpoint.camera?.position?.spatialReference,e)))}init(){this._constraintsManager=new ev({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this._initialViewpoint||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===Mt.Local&&this.addHandles(H((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(pv),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),pv)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(pv),this._constraintsManager=D(this._constraintsManager))}async goTo(e,t){const i={animate:!0,...t};return null!=this._gotoOperation&&this._gotoOperation.abort(i.animate),this._gotoOperation=new sv(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(tc(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){null!=this._gotoOperation&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of lv){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(null==e||this._cameraSetByUser)return;if(e instanceof t)return void this.setStateCamera(Yl(this.view,e),{applyConstraints:!1});if(e instanceof i){if(e.targetGeometry instanceof Jc){const t=ic(this.view,e.targetGeometry,0,.5,rc.LOCKED);return void(null!=t&&this.setStateCamera(Yl(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const r=ic(this.view,e,0,.5,rc.LOCKED);null!=r&&this.setStateCamera(Yl(this.view,r),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&ov.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return null!=e&&(e instanceof i?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof t?this.isCompatible(e.position):e.spatialReference&&!Ie(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=cv){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=dv){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=sc(this.view,r,s,e,t,rc.ADJUST);return null==n?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=ic(this.view,e,t,i,rc.ADJUST,hv);return r?Yl(this.view,r):null}_scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=nc(this.view,e,r);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(ac(this.view,e))}_viewpointToCamera(e){return Yl(this.view,gh(this.view,e))}setStateCamera(e,t){return!(null==e||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&Yg(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new rv({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(0!==i.width&&0!==i.height&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){const e=this.view.state.camera;e.fullWidth===i.width&&e.fullHeight===i.height&&e.pixelRatio===i.pixelRatio||(dv.copyFrom(e),dv.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,uv),dv.padding=uv),dv.fullWidth=i.width,dv.fullHeight=i.height,dv.pixelRatio=i.pixelRatio,this.view.state.camera=dv),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,r=t?Ql(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){null!=this.test.renderState?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=yh.ANIMATING:this.view.interacting?this.view.state.mode=yh.INTERACTING:(this.view.state.mode===yh.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=yh.INTERACTING:this.view.state.mode=yh.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};e([ae({type:t,dependsOn:["view.state.camera","ready"]})],nv.prototype,"camera",null),e([ae({type:t,dependsOn:["view.state.contentCamera","ready"]})],nv.prototype,"contentCamera",null),e([ae({type:eh})],nv.prototype,"center",null),e([ae({type:Jc})],nv.prototype,"extent",null),e([ae({readOnly:!0})],nv.prototype,"frustum",null),e([ae()],nv.prototype,"_constraintsManager",void 0),e([ae({readOnly:!0})],nv.prototype,"constraintsManager",null),e([ae()],nv.prototype,"_initialViewpoint",null),e([ae({readOnly:!0})],nv.prototype,"hasInitialView",null),e([ae({readOnly:!0,type:Boolean})],nv.prototype,"ready",void 0),e([ae({type:Number})],nv.prototype,"scale",null),e([ae()],nv.prototype,"padding",null),e([ae({readOnly:!0})],nv.prototype,"screenCenter",null),e([ae({constructOnly:!0})],nv.prototype,"view",void 0),e([ae({type:i})],nv.prototype,"viewpoint",null),e([ae({type:Number})],nv.prototype,"zoom",null),e([ae({readOnly:!0})],nv.prototype,"_rasterPixelRatio",null),e([ae({readOnly:!0})],nv.prototype,"_usePhysicalPixelRendering",null),e([ae({readOnly:!0})],nv.prototype,"_usePhysicalPixelRenderingAny",null),e([ae()],nv.prototype,"_windowDevicePixelRatio",void 0),e([ae()],nv.prototype,"_devicePixelRatioOverride",void 0),nv=e([le("esri.views.3d.state.ViewStateManager")],nv);class av{constructor(){this.width=0,this.height=0,this.pixelRatio=1}}const ov=new Set(["camera","viewpoint","extent","scale","center","zoom"]),lv=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],cv={heading:0,tilt:0},hv=new t,dv=new Ic,uv=tr(),pv="pending-initial-view",mv="content-camera-reset",_v=300;let gv=class extends gf{constructor(){super(...arguments),this.startCamera=new Ic,this.currentCamera=new Ic,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<100}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=_f.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout((()=>this.notifyChange("isInteractive")),100),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var fv;e([ae({readOnly:!0})],gv.prototype,"isInteractive",null),e([ae()],gv.prototype,"_lastInteraction",void 0),gv=e([le("esri.views.3d.state.controllers.InteractiveController")],gv),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(fv||(fv={}));let yv=class extends gv{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=fv.CENTER,this._rotScale=0,this._lastPoint=nr(),this._tmpWorldUp=we(),this._tmpViewDir=we(),this._tmpRotCurPoint=nr(),this._tmpTransf=wr(),this._tmpAxis=we(),this._tmpPivotPoint=we(),this._pivotPos=we(),this._constraintOptions=new ug(cg.ALL,hg.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===fv.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case fv.EYE:Ti(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=hg.LOOK_AROUND,this._constraintOptions.tiltMode=dg.LOOK_AROUND,this._constraintOptions.selection=cg.NONE;break;case fv.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?Af:{});t||Ti(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=hg.TUMBLE,this._constraintOptions.tiltMode=dg.TUMBLE,this._constraintOptions.selection=cg.ALL&~cg.DISTANCE;break}}Mf(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=we();Pi(r,this._pivotPos,i.eye);const s=pi(r),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,xv);let a=Math.max(Math.min(5,1/Math.abs(gi(xv,i.viewForward)))*n,10);t&&(a=Math.min(s,a));const o=Gt(this.view.spatialReference),l=J(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),c=Qf(this.startCamera,l,o);let h=this.view._stage.renderView.getMinimalDepthForArea(Vy(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),d=this.view._stage.renderView.getMinimalDepthForArea(Vy(this.view),e[0],e[1],i,90);null==h&&null==d||(h=h??d??0,d=null==d||c===qf.Horizontal?h:d,a=h>d?d:h,a=t?Math.min(a,s):a),_i(r,r),Ti(this._pivotPos,vi(this._tmpPivotPoint,i.eye,fi(this._tmpPivotPoint,r,a)))}update(e){if(this.active){switch(this.pivot){case fv.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case fv.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Yg(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),Mf(e,t,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;Pi(this._tmpViewDir,i,r);const a=pi(this._tmpViewDir),o=qt(gi(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===fv.EYE){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=Ft(s+o,Qp.min,Qp.max)-o,wi(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===fv.CENTER&&(n=-n),mr(this._tmpTransf,n,this._tmpWorldUp),gr(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),Ri(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Ri(vv,e.up,this._tmpTransf),vi(vv,r,this._tmpViewDir),Bi(this._lastPoint,this._tmpRotCurPoint),vv}};e([ae()],yv.prototype,"pivot",void 0),yv=e([le("esri.views.3d.state.controllers.RotateController")],yv);const vv=we(),xv=we();class wv extends Yc{constructor(e,t,i,r){super(!0),this._view=e,this.pointerAction=t,this._pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!_c(e.data,this.pointerAction))return;const i=J(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new yv({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let bv=class extends gv{constructor(){super(...arguments),this._pickPoint=we(),this._tmpP0=nr(),this._panAxisAngle=wf(),this._tmpRayDir=we(),this._tmpRayDirPick=we(),this._targetOnSphere=we(),this._navMode=qf.Horizontal,this._tmpRay={origin:we(),direction:we()},this.dragBeginPoint=J(),this._normalizedAnchorPoint=nr(),this._constraintOptions=new ug(cg.ALL_EXCEPT_COLLISION,hg.ZOOM,0,this.startCamera),this._sphere=vl(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Bi(this.dragBeginPoint,e),Mf(this.startCamera,e,this._normalizedAnchorPoint);const t=Gt(this.view.spatialReference),i=$f(this._intersectionHelper,this.startCamera,e,t,Rf.Ellipsoid,0===this.view.map.ground.opacity?Af:{});if(this._navMode=Qf(this.startCamera,e,t),this._navMode===qf.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let t;Hc(this.startCamera,e,this._tmpRay),_i(this._tmpRay.direction,this._tmpRay.direction),null!=i.scenePickPoint&&(Pi(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=pi(this._tmpRayDirPick));const r=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Tv);let s=Ft(Math.min(30,1/Math.abs(gi(Tv,this._tmpRay.direction)))*r,Of[0],Of[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=null!=t?Math.min(s,t):s,this._hasPickPoint=!0,fi(this._tmpRay.direction,this._tmpRay.direction,s),vi(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===qf.Horizontal){Pi(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=pi(this._tmpRayDir);Mf(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this._sphere[3]/pi(this.currentCamera.center));this.currentCamera.center=fi(Cv,this.currentCamera.center,e)}fi(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=vi(Cv,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Zg(Gi(this.dragBeginPoint,e)),Yg(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(Zf(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Cf(this._pickPoint,this._targetOnSphere,this._panAxisAngle),If(this.currentCamera,yl(this._sphere),this._panAxisAngle))}else{const t=pi(this._tmpRay.direction);Mf(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;fi(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=vi(Cv,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=vi(Cv,this.currentCamera.center,this._tmpRayDir)}Mg(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};bv=e([le("esri.views.3d.state.controllers.global.ZoomController")],bv);const Cv=we(),Tv=we();let Pv=class extends gv{constructor(){super(...arguments),this._tmpP=we(),this._tmpDir=we(),this._tmpN=we(),this._tmpP0=nr(),this._tmpPoi=we(),this._tmpRayDir=we(),this.dragBeginPoint=J(),this._normalizedAnchorPoint=nr(),this._constraintOptions=new ug(cg.ALL,hg.ZOOM,0,this.startCamera,we()),this._plane=Rl()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Bi(this.dragBeginPoint,e),Mf(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?Af:{});Pi(this._tmpDir,this._tmpP,this.startCamera.eye);const i=pi(this._tmpDir);_i(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let s=Ft(Math.min(30,1/Math.abs(gi(Rv,this._tmpDir)))*r,Of[0],Of[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(Vy(this.view),e[0],e[1],this.view.state.camera,80);s=null!=n?n:s,s=t?Math.min(s,i):s,fi(this._tmpDir,this._tmpDir,s),vi(this._tmpP,this.startCamera.eye,this._tmpDir),Pi(this._tmpN,this.startCamera.eye,this.startCamera.center),_i(this._tmpN,this._tmpN),this._tmpN[1]<0&&Ai(this._tmpN,this._tmpN),Dl(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.active)return;(function(e,t,i,r){return El(e,Gc(t,i,Oy),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||Ti(this._tmpPoi,this.currentCamera.center),Mf(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Bi(this._normalizedAnchorPoint,this._tmpP0),Pi(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=pi(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&(Ti(this._constraintOptions.interactionDirection,this._tmpRayDir),fi(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(fi(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=vi(Sv,this.currentCamera.eye,this._tmpRayDir),yi(Sv,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Sv[2]=Math.max(this.startCamera.center[2],Sv[2]):Sv[2]=Math.min(this.startCamera.center[2],Sv[2]),this.currentCamera.center=Sv,this._constraintOptions.interactionFactor=Zg(Gi(this.dragBeginPoint,e)),Yg(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};Pv=e([le("esri.views.3d.state.controllers.local.ZoomController")],Pv);const Sv=we(),Rv=xe(0,0,1);class Ov extends Yc{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!_c(e.data,this.pointerAction))return;const i=J(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new bv({view:this._view}):this._cameraController=new Pv({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let Ev=class extends gv{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Ic,this._headingStart=0,this._constraintOptions=new ug(cg.ALL,hg.NONE,0,new Ic,null,dg.LOOK_AROUND)}handleEventGamepad(e){const t=gc(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||fc(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,yc(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=yc(this._keysButtonState,this._transformation);fc(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Vv),this._applyDisabledMovementTypes(Vv),this._applyPan(Vv.pan),this._applyRotate(Vv.rotate),this._applyZoom(Vv.zoom),this._applyAscend(Vv.ascend),this._constraintOptions.interactionType=hg.NONE,this._constraintOptions.selection=cg.COLLISION,Yg(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Pi(Uv,t.center,t.eye),Ri(Uv,Uv,e.matrix),t.center=vi(Uv,Uv,t.eye),t.up=Ri(Uv,t.up,e.matrix),this._constraintOptions.interactionType=hg.LOOK_AROUND,this._constraintOptions.selection=cg.ALL_EXCEPT_COLLISION,Yg(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Ri(Uv,t.eye,e.matrix),t.center=Ri(Uv,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Ri(Uv,t.up,e.matrix)),this._constraintOptions.interactionType=hg.PAN,this._constraintOptions.selection=cg.ALL,Yg(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=vi(Uv,this.currentCamera.eye,fi(Al.get(),t,e)),Ti(jv,t),Ai(jv,jv),this._constraintOptions.interactionDirection=jv,this._constraintOptions.interactionType=hg.ZOOM,this._constraintOptions.selection=cg.ALL_EXCEPT_COLLISION,Yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Al.get());if(this._constraintOptions.interactionDirection=Ti(jv,t),this.view.state.isGlobal){const t=pi(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=fi(Uv,this.currentCamera.eye,i),this.currentCamera.center=fi(Uv,this.currentCamera.center,i)}else{const i=fi(Al.get(),t,e);this.currentCamera.eye=vi(Uv,this.currentCamera.eye,i),this.currentCamera.center=vi(Uv,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=hg.ASCEND,this._constraintOptions.selection=cg.COLLISION,Yg(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=cg.ALL_EXCEPT_COLLISION,Yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,yr(e.pan.matrix),e.rotate.enabled=!1,yr(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Uv)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=ui(Al.get(),s[0],s[1],0);_i(o,o);const l=n.translation[0]*e.pan;if(0!==l){const e=fi(Al.get(),r,l);fr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(a.mode){case"pan":{const t=-n.translation[1]*e.pan;if(0!==t){const e=fi(Al.get(),o,t);fr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:ni(a.mode)}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;0!==h&&(gr(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Al.get())),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=Ng(this.view.renderCoordsHelper,t.center,t.eye),p=Ft(u+d,Qp.min,Qp.max)-u;p&&(gr(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this._transformation,a=this.view.navigation.gamepad,o=wi(Al.get(),s,r);_i(o,o),Ai(o,o),function(e,t,i,r,s,n,a,o,l){ay(e.center,gi(e.up,e.center),pi(e.center),-zc.normalize(Vt(n)),a,t)?function(e,t,i,r,s,n){const{eye:a}=e;ut([0,0,1],a,cy,hy,dy);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-gi(e.center,cy)**2/pi(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*o)/c,d=-Math.cos(n)*l+Math.sin(n)*o;switch(gr(r.pan.matrix,r.pan.matrix,h,cy),r.pan.enabled=!0,s.mode){case"pan":gr(r.pan.matrix,r.pan.matrix,d,hy),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-zc.normalize(Vt(s))):function(e,t,i,r,s){const{eye:n,viewRight:a}=e,o=wi(Al.get(),a,n),l=t.translation[0]*i.pan;switch(0!==l&&(gr(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(gr(r.pan.matrix,r.pan.matrix,e,a),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Vv.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;0!==h&&(gr(i.rotate.matrix,i.rotate.matrix,h,this._tmpCamera.eye),i.rotate.enabled=!0);const d=n.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(gr(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=Gt(this.view.spatialReference),s=jf(Qp.min,t.origin,i,r);let n=0,a=0;const o=Al.get();return this.view.renderCoordsHelper.intersectManifold(t,i,o)?(n=jf(Ng(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),a=jf(Qp.max,t.origin,i,r)):(_l(gl(fl,i+r.radius),t,o),n=kf(Math.PI+Pl(t.direction,o),t.origin,i,r),a=kf(Qp.max,t.origin,i,r)),Ft(n+e,s,a)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=oc(this.view,t,0,Mv,kv),n=i.intersectManifoldClosestSilhouette(Cl(t,s),e,Al.get()),a=xi(t,n),o=i.intersectManifoldClosestSilhouette(Cl(t,Si(Al.get(),t,r.center)),e,Al.get()),l=xi(t,o);return Math.min(a,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,Al.get());if(s){const t=Pi(Al.get(),e,n),i=pi(t);fi(t,t,1/i);const r=_i(Al.get(),e),s=qt(gi(r,t));return i*Math.sin(Math.min(Dv,s))}{const i=Ti(Al.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),xi(n,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:Lv}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+Gt(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=Al.get(),a=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),o=this._clampedDistanceToSurface(t,n),l=r.width/2,c=Iv*r.width,h=Iv*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(n),m=a-t;return{pan:(s?u:d)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*m-m),zoom:2**(c*e/l)*o-o,rotate:Ft(p*h,Nv,Fv)*e}}_applyDisabledMovementTypes(e){null==this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&yr(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&yr(e.rotate.matrix))}static activatesFor(e,t){const i=gc(t,e.navigation.gamepad,Av);return!("end"===t.action||fc(i))}};e([ae({constructOnly:!0})],Ev.prototype,"gamepadDevice",void 0),e([ae({constructOnly:!0})],Ev.prototype,"disableMovements",void 0),Ev=e([le("esri.views.3d.state.controllers.GamepadKeyboardController")],Ev);const Av={translation:[0,0,0],heading:0,tilt:0,zoom:0},Mv=80,Dv=Vt(Mv),Iv=.75,Lv=5,Nv=Vt(30),Fv=Vt(80),Vv={zoom:0,ascend:0,pan:{enabled:!1,matrix:wr()},rotate:{enabled:!1,matrix:wr()}},Uv=we(),jv=we(),kv=lc();class qv extends Yc{constructor(e){super(!0),this._view=e,this._watchHandles=new qi,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([U((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),k),U((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||Ev.activatesFor(this._view,e.data)){if(!i){const t=new Ev({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t)&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var zv;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(zv||(zv={}));class Bv extends Yc{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Mt.Local},this._keyToNumber={[t.left]:zv.LEFT,[t.right]:zv.RIGHT,[t.forward]:zv.FORWARD,[t.backward]:zv.BACKWARD,[t.up]:zv.UP,[t.down]:zv.DOWN,[t.headingLeft]:zv.HEADINGLEFT,[t.headingRight]:zv.HEADINGRIGHT,[t.tiltUp]:zv.TILTUP,[t.tiltDown]:zv.TILTDOWN,[t.zoomIn]:zv.ZOOMIN,[t.zoomOut]:zv.ZOOMOUT},this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=vc((e=>e?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Ev({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleStop(){this._cameraControllerKeyboard?.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class Hv extends Yc{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,(e=>this._handleMouseWheel(e)))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Ay({view:this._view,mode:"interaction"}):new jy({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,J(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class Gv{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Wv=class extends ff{constructor(){super(...arguments),this._beginCamera=new Ic,this._elapsedTimeSec=0,this.constraintOptions=new ug(cg.ALL,hg.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new At}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Yg(this.view,t,this.constraintOptions)}};Wv=e([le("esri.views.3d.state.controllers.momentum.MomentumController")],Wv);let $v=class extends Wv{constructor(e){super(e),this.interactionType=hg.PAN,this._tmpPan=we()}momentumStep(e,t){const i=this.momentum.value(e);fi(this._tmpPan,this.momentum.direction,i),t.eye=Pi(Qv,t.eye,this._tmpPan),t.center=Pi(Qv,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};e([ae({constructOnly:!0})],$v.prototype,"momentum",void 0),$v=e([le("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],$v);const Qv=we(),Xv=we(),Yv=we();let Zv=class extends Wv{constructor(e){super(e),this.interactionType=hg.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);Ti(Yv,t.eye),_i(Yv,Yv),wi(this.momentum.axis2,Yv,this.momentum.axis1),ny(t,Xv,this.momentum.axis1,i,this.momentum.axis2,r)}};e([ae({constructOnly:!0})],Zv.prototype,"momentum",void 0),Zv=e([le("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Zv);let Kv=class extends Wv{set center(e){this._set("center",be(e))}set axis(e){this._set("axis",be(e))}constructor(e){super(e),this.interactionType=hg.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);If(t,this.center,bf(this.axis,i))}};e([ae({constructOnly:!0})],Kv.prototype,"momentum",void 0),e([ae({constructOnly:!0})],Kv.prototype,"center",null),e([ae({constructOnly:!0})],Kv.prototype,"axis",null),Kv=e([le("esri.views.3d.state.controllers.momentum.MomentumController")],Kv);let Jv=class extends Wv{set zoomCenter(e){this._set("zoomCenter",be(e))}constructor(e){super(e),this.interactionType=hg.ZOOM,this.constraintOptions.interactionDirection=we()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;Ti(i,t.eye);const r=this.momentum.valueDelta(0,e);Nf(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Si(i,t.eye,i)}};e([ae({constructOnly:!0})],Jv.prototype,"momentum",void 0),e([ae({constructOnly:!0})],Jv.prototype,"zoomCenter",null),Jv=e([le("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Jv);let ex=class extends Wv{set screenCenter(e){this._set("screenCenter",J(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",be(e))}constructor(e){super(e),this.interactionType=hg.ZOOM,this.radius=0,this._tmpSceneCenter=we(),this._tmpZoomAxisAngle=wf(),this._sphere=vl()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);Ff(this._sphere,t,i),this.constraintOptions.interactionType=hg.ZOOM,Yg(this.view,t,this.constraintOptions),Zf(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Cf(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),If(t,yl(this._sphere),this._tmpZoomAxisAngle),this.constraintOptions.interactionType=hg.PAN}};e([ae({constructOnly:!0})],ex.prototype,"momentum",void 0),e([ae({constructOnly:!0})],ex.prototype,"screenCenter",null),e([ae({constructOnly:!0})],ex.prototype,"sceneCenter",null),e([ae({constructOnly:!0})],ex.prototype,"radius",void 0),ex=e([le("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],ex);class tx{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const ix=1e-5;class rx extends xh{constructor(e,t,i,r,s,n=0,a){super(e,t,i),this._angularVelocity1=r,this.axis1=s,this.angularVelocity2=n,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class sx{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=we(),this._tmpAxis2=we(),this._tmpAngles=nr(),this._time=new vh(.3),this._screen=[new vh(.4),new vh(.4)],this._angle1=new tx(.6),this._angle2=new tx(.6),this._axis1=we(),this._axis2=we(),this._lastScene=we()}addMomentumDirectRotation(e,t,i,r,s,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=ty(this._lastScene,t,this._tmpAxis2,r,s,n);this._angle2.update(0),mi(this._tmpAxis2)<ix?e=0:_i(this._axis1,this._tmpAxis2),this._angle1.update(e),Ti(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,n,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;sy(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,s,n,a,!1),mi(this._tmpAxis2)<ix?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),_i(this._axis1,this._tmpAxis1),_i(this._axis2,this._tmpAxis2)),Ti(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==i||null==r?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,s=this._angle1.filteredValue,n=this._angle2.filteredValue,a=null==r||null==n?0:n/r;return new rx(e,t,i,null==r||null==s?0:s/r,this._axis1,a,this._axis2)}}let nx=class extends gv{constructor(){super(...arguments),this._smoothRotation=new Gv(.05),this._rotationAxis=we(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Rl(),this._beginRadius=0,this._smoothScaling=new Gv(.05),this._zoomCenterScreen=J(),this._zoomMomentumEstimator=new wh,this._rotationMomentumEstimator=new bh,this._panSphericalMomentumEstimator=new sx,this._panPlanarMomentumEstimator=new Ch,this._adjustedSphere=vl(),this._tmp3d=we(),this._tmpScreenPointArray=J(),this._beginScreenPoint=J(),this._beginScenePoint=we(),this._screenPickPoint=J(),this._scenePickPoint=we(),this._mode=qf.Horizontal,this._sphere=vl(),this._pointerCount=0,this._tmpInteractionDirection=we(),this._beginCamera=new Ic,this._constraintOptions=new ug(cg.ALL,hg.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-zc.normalize(Vt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),te(e.center,this._screenPickPoint),Bi(this._beginScreenPoint,this._screenPickPoint);const t=Gt(this.view.spatialReference),i=$f(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Rf.Silhouette,0===this.view.map.ground.opacity?Af:{});null!=i.scenePickPoint&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,Ti(this._beginScenePoint,this._scenePickPoint),this._mode=Qf(this.startCamera,this._screenPickPoint,t),this._mode===qf.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._mode===qf.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===qf.Horizontal?new ex({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Jv({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Kv({view:this.view,momentum:i,center:yl(this._sphere),axis:this._rotationAxis});if(this._mode===qf.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Zv({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new $v({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=Ai(this._tmp3d,this.startCamera.viewForward);Dl(this._scenePickPoint,i,this._panningPlane);const r=J(this._screenPickPoint[0],0),s=we(),n=pi(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],Zf(this._adjustedSphere,this.startCamera,r,s);const a=ie();this.startCamera.projectToRenderScreen(s,a);const o=we(),l=we(),c=we();Pi(o,this._scenePickPoint,this.currentCamera.eye);const h=pi(o);_i(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=null!=u?u:d;p=t?Math.min(p,h):p,Ti(c,vi(l,this.currentCamera.eye,fi(l,o,p))),this._panningPlane[3]=-gi(Il(this._panningPlane),c),this.startCamera.center=vi(l,this.startCamera.eye,fi(l,this.startCamera.viewForward,p));const m=te(e.center,this._tmpScreenPointArray);Lf(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),Ff(this._sphere,this.currentCamera,this._smoothScaling.value),te(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=hg.ZOOM,this._constraintOptions.interactionFactor=Zg(e.radius-this._beginRadius),Yg(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=te(e.center,this._tmpScreenPointArray);Zf(this._sphere,this.currentCamera,t,this._tmp3d),ay(this._beginScenePoint,gi(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(ly(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(oy(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=hg.PAN,this._constraintOptions.interactionFactor=Zg(Gi(this._screenPickPoint,t)),Yg(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){_i(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Ai(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+Df(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),If(this.currentCamera,yl(this._sphere),bf(this._rotationAxis,s)),this._constraintOptions.interactionType=hg.TUMBLE,this._constraintOptions.interactionFactor=Zg(e.radius*i),Yg(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=te(e.center,this._tmpScreenPointArray);Lf(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(Xf(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=hg.PAN,this._constraintOptions.interactionFactor=Zg(Gi(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Yg(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Nf(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=hg.ZOOM,this._constraintOptions.interactionFactor=Zg(e.radius-this._beginRadius),Yg(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){Ti(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Ai(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=Df(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),If(this.currentCamera,yl(this._sphere),bf(this._rotationAxis,n)),this._constraintOptions.interactionType=hg.TUMBLE,this._constraintOptions.interactionFactor=Zg(e.radius*n),Yg(this.view,this.currentCamera,this._constraintOptions)}};nx=e([le("esri.views.3d.state.controllers.global.PinchAndPanController")],nx);const ax=xe(0,0,1),ox=16/180*Math.PI;let lx=class extends gv{constructor(){super(...arguments),this._rotationValueSmooth=new Gv(.05),this._scalingValueSmooth=new Gv(.05),this._planeHorizontal=Rl(),this._planeVertical=Rl(),this._rotationMomentumEstimator=new bh,this._panMomentumEstimator=new Ch(300,12,.9),this._zoomMomentumEstimator=new wh,this._beginRadius=0,this._beginCenter=we(),this._beginAngle=0,this._tmpPoints=[],this._panMode=qf.Horizontal,this._beginCenterScreen=J(),this._tmpCentroid3d=we(),this._tmpCentroid2d=J(),this._tmp2d=J(),this._pointerCount=0,this._beginCamera=new Ic,this._constraintOptions=new ug(cg.ALL,hg.NONE,0,this._beginCamera)}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),te(e.center,this._beginCenterScreen),Ml(ax,0,this._planeHorizontal);const i=we(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,0===this.view.map.ground.opacity?Af:{}),s=we();Ai(s,this.startCamera.viewForward);const n=we();Ti(n,ax);const a=gi(s,n),o=zt(a<0?-a:a);this._panMode=o>=ox?qf.Horizontal:qf.Vertical;const l=Math.min(5,1/Math.abs(gi(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);Ll(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||Nl(this._planeHorizontal,this._planeHorizontal);const c=we(),h=we(),d=we();Pi(c,i,this.currentCamera.eye);const u=pi(c);if(_i(c,c),this._panMode===qf.Vertical){fi(n,n,a),Pi(Il(this._planeVertical),s,n),_i(Il(this._planeVertical),Il(this._planeVertical)),Ll(this._planeVertical,this._planeVertical,i);const t=this.view._stage.renderView.getMinimalDepthForArea(Vy(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let o=null!=t?t:l;o=r?Math.min(o,u):o,Ti(d,vi(h,this.currentCamera.eye,fi(h,c,o))),this._planeVertical[3]=-gi(Il(this._planeVertical),d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),Uf(this._tmpPoints,this._beginCenter)}else{const t=r?u:l;Ti(d,vi(h,this.currentCamera.eye,fi(h,c,t))),this._planeHorizontal[3]=-gi(Il(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),Uf(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._panMode===qf.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),Nf(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=hg.ZOOM,this._constraintOptions.interactionFactor=Zg(Math.abs(e.radius-this._beginRadius)),Yg(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),Uf(this._tmpPoints,this._tmpCentroid3d),te(e.center,this._tmpCentroid2d),Xf(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=hg.PAN,this._constraintOptions.interactionFactor=Zg(Gi(this._beginCenterScreen,this._tmpCentroid2d)),Yg(this.view,this.currentCamera,this._constraintOptions),t){const t=r,i=this._rotationValueSmooth.value,s=i+Df(e.angle-i),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(s);const a=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp);const o=Il(this._planeHorizontal);If(this.currentCamera,t,bf(o,a)),this._constraintOptions.interactionType=hg.TUMBLE,this._constraintOptions.interactionFactor=Zg(Math.abs(e.radius*a)),Yg(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Jv({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Kv({view:this.view,momentum:i,center:this._beginCenter,axis:Il(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new $v({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const s=this._tmp2d;let n=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[n]&&(r[n]=we()),Lf(t,i,s,r[n]),n+=1})),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};lx=e([le("esri.views.3d.state.controllers.local.PinchAndPanController")],lx);class cx extends Yc{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!_c(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new nx({view:this._view}):new lx({view:this._view})}}class hx extends Yc{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class dx extends Yc{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class ux extends dx{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class px extends dx{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class mx extends Yc{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this._invert?-1:1,i=J(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new yv({view:this._view,pivot:fv.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}class _x extends Yc{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new xc({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,n=1/0;for(const{x:e,y:a}of t.pointers.values())i=Math.max(i,e),r=Math.min(r,e),s=Math.max(s,a),n=Math.min(n,a);let a=-1/0,o=1/0,l=-1/0,c=1/0;for(const{x:t,y:i}of e.pointers.values())a=Math.max(a,t),o=Math.min(o,t),l=Math.max(l,i),c=Math.min(c,i);const h=i-r,d=s-n,u=a-o,p=l-c;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-h)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let gx=class extends pe{destroy(){this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=D(this._inputManager)}connect(){const e=this.view;this._source=new wc(this.view.surface,e.input);const t=[new bc,new Cc,new Tc,new Pc(this.view.navigation),new _x],i=new Zc({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Sc],Kc.INTERNAL),this._modeDragPan=new cx(e,"primary"),this._modeDragRotate=new wv(e,"secondary",fv.CENTER),this._modeDragZoom=new Ov(e,"tertiary"),i.installHandlers("navigation",[new hx(e),new By(e),new qv(e),new Bv(e,{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"}),new Hv(e),new px(e,"p"),new ux(e,"n"),new wv(e,"primary",fv.EYE,["b"]),new wv(e,"secondary",fv.CENTER,["b"]),new cx(e,"tertiary",["b"]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new mx(e)],Kc.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this.addHandles(U((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),k))}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=fx.get(e)?.get(t);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e([ae()],gx.prototype,"view",void 0),e([ae({value:"pan"})],gx.prototype,"primaryDragAction",null),e([ae({value:"default"})],gx.prototype,"mode",null),e([ae({readOnly:!0})],gx.prototype,"updating",null),e([ae()],gx.prototype,"latestPointerType",null),e([ae()],gx.prototype,"latestPointerLocation",null),e([ae()],gx.prototype,"multiTouchActive",null),e([ae()],gx.prototype,"_inputManager",void 0),gx=e([le("esri.views.3d.input.SceneInputManager")],gx);const fx=new Map,yx=new Map,vx=new Map;yx.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),yx.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),vx.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),vx.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),fx.set("default",yx),fx.set("pro",vx);const xx=gx;let wx,bx,Cx=!1,Tx=!1,Px=!1,Sx=!1,Rx=null;function Ox(){Rx&&(Rx(),Rx=null)}function Ex(e,t,i,r,s){Ox();const n=wx.height,a=bx;a.beginPath(),a.lineWidth=1,a.strokeStyle=s,a.moveTo(e,n-i),a.lineTo(t,n-i),a.stroke(),a.lineTo(t,n-r),a.stroke(),a.lineTo(t,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.lineTo(e,n-i),a.stroke(),a.closePath()}const Ax=we(),Mx=tr(),Dx=tr(),Ix=we(),Lx=wr(),Nx=vl(),Fx=Sl(),Vx=we(),Ux=je();class jx{constructor(){this.aabr=je(),this.distance=0,this.culled=!1,this.visible=!1}}class kx{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var qx;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(qx||(qx={}));class zx{constructor(){this.camera=new Ic,this.slicePlane=ot(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),lt(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let Bx=class extends pe{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new zx,this._state=qx.Idle,this._active=new Map,this._visible=new Map,this._iterators=new Wx,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==qx.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/qx.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case qx.Idle:this._startUpdate(),e.madeProgress();case qx.Process:if(this._state=qx.Process,!this._processActiveGraphics(e))return;case qx.Sort:if(this._state=qx.Sort,!this._sortVisibleGraphics(e))return;case qx.Deconflict:if(this._state=qx.Deconflict,!this._deconflictVisibleGraphics(e))return;default:!function(e,t){if(!Tx||!bx)return;Ox();const i=bx;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const n=e.accBins[t][e.accBinsNumY-1-s];r+=n.length;const a=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,c=(s+1)*e.accBinsSizeY;i.fillText(n.length.toFixed(),a+5,l+15),Ex(a,o,l,c,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}(this,this._visible),this._state=qx.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(null==e||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?.geometries.length??0))return!1;const i=t?.geometries[0],r=i?.material;return r instanceof Ph}_startUpdate(){var e;e=this.view,Px=Th.DECONFLICTOR_SHOW_VISIBLE,Sx=Th.DECONFLICTOR_SHOW_INVISIBLE,Cx=Px||Sx,Tx=Th.DECONFLICTOR_SHOW_GRID,Rx=null,Cx||Tx?Rx=()=>function(e){null==wx&&(wx=document.createElement("canvas"),wx.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(wx));const{state:t}=e,{camera:i,pixelRatio:r}=t,{width:s,height:n}=i,a=s*r,o=n*r;wx.setAttribute("width",`${a}px`),wx.setAttribute("height",`${o}px`),wx.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),bx=wx.getContext("2d"),bx.clearRect(0,0,s,n),bx.font="12px Arial"}(e):wx&&(wx.parentElement.removeChild(wx),wx=null),this._dirty=!1,this._viewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:i}=this._viewState.camera;this._initBins(t,i),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new jx,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,zl.DECONFLICTION,!0)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=lr(Lx,this._viewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._viewState.camera.relativeElevation>0?Nx:null;let s=0;for(null!=r&&(Ri(yl(r),Re,this._viewState.camera.viewMatrix),r[3]=Gt(this.view.spatialReference).radius,s=xl(r,Re));!e.done;){e.madeProgress();const n=t.next();if(!0===n.done)return this._resetActiveGraphicsIterator(),!0;const a=n.value,o=a?.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(a,i,r,s),o.culled?this._visible.delete(a.graphics3DGraphic.graphic.uid):this._visible.set(a.graphics3DGraphic.graphic.uid,a))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===ql.LABEL;for(;!e.done;){e.madeProgress();const n=t.next();if(!0===n.done)return this._resetVisibleGraphicsIterator(),!0;const a=n.value,o=a.info[this.visibilityGroup];if(!o||o.culled){this._setGraphicVisibility(a,!1);continue}const l=a.graphics3DGraphic,c=!i||l.isVisible();o.visible=c&&!this._isConflicted(a),o.visible&&this._addToBins(a),this._setGraphicVisibility(a,o.visible),r=o,s=o.visible,Cx&&(s&&Px||!s&&Sx)&&Ex(r.aabr[0],r.aabr[2],r.aabr[1],r.aabr[3],s?"green":"red")}var r,s;return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=Hx(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=Hx(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.visible=e.graphics3DGraphic.getVisibilityFlag(i,zl.DECONFLICTION);const n=e.info?.[i];s.prio=e.graphics3DGraphic.deconflictionPriority,s.distance=n?n.distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>e.prio!==t.prio?t.prio-e.prio:e.distance!==t.distance?e.distance-t.distance:e.visible!==t.visible?e.visible?-1:1:e.id-t.id));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const n=e.info[this.visibilityGroup];if(!s.isVisible(ql.GRAPHIC,zl.DECONFLICTION))return void(n.culled=!0);const a=this.getGraphicsLayers(s);ke(n.aabr);let o=null;for(const s of a){if(!this.layerSupportsDeconfliction(s))continue;const a=s.stageObject.geometries[0].material;if(null==o&&(o=Qx,this._getProjectionInfo(s,t,o),o.isOutsideScreen||this._isCulledBySlice(e,Ax)||null!=i&&this._isCulledByHorizon(o,i,r)))return void(n.culled=!0);this._expandBoundingRect(n,s,a,o)}null==o?n.culled=!0:(n.distance=o.distance,n.culled=!1)}_getProjectionInfo(e,t,i){const r=this._viewState.camera,s=e.stageObject,n=s.geometries[0],a=n.material,o=yl(s.boundingVolumeWorldSpace.bounds);Ri(Ax,o,r.viewMatrix);const l=n.attributes,c=l.get(Sn.NORMAL).data,h=l.get(Sn.CENTEROFFSETANDDISTANCE).data;a.applyShaderOffsetsView(Ax,c,s.transformation,h,r,i.scaleInfo,Ax),$i(Mx,Ax[0],Ax[1],Ax[2],1),Qi(Dx,Mx,r.projectionMatrix),fi(i.positionNDC,Dx,1/Dx[3]),a.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,Ix),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(Ix[2]),i.distance=Ix[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),$i(Dx,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Qi(Mx,Dx,t),Xi(Mx,Mx,1/Mx[3]),ui(i.positionView,Ax[0],Ax[1],Ax[2])}_isCulledByHorizon(e,t,i){return Ti(Fx.direction,e.positionView),ui(Fx.origin,0,0,0),!!pl(t,Fx,Vx)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&at(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const n=this._viewState.camera,a=t.getScreenSize($x);En(a,s.factor,a),a[0]*=n.pixelRatio,a[1]*=n.pixelRatio;const o=qe(i.calculateRelativeScreenBounds(a,s.factorAlignment.scale,Ux),jt(0,n.fullWidth,.5+.5*r[0]),jt(0,n.fullHeight,.5+.5*r[1])),l=this.marginFactor;if(0!==l){const e=l*Math.min(ze(o),Be(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}He(e.aabr,o,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];let r=!0;for(let e=Math.floor(i.aabr[0]/this._accBinsSizeX);e<=Math.floor(i.aabr[2]/this._accBinsSizeX);e++)if(!(e<0||e>=this._accBinsNumX))for(let s=Math.floor(i.aabr[1]/this._accBinsSizeY);s<=Math.floor(i.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;r=!1;const n=this._accBins[e][s];for(let e=0;e<n.length;e++){const r=n.data[e],s=r.info[this.visibilityGroup];if(s&&s.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,Ge(s.aabr,i.aabr)))return!0}}return r}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new Y)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),r=Math.floor(t.aabr[2]/this._accBinsSizeX),s=Math.floor(t.aabr[1]/this._accBinsSizeY),n=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this._accBinsNumX))for(let i=s;i<=n;i++)i<0||i>=this._accBinsNumY||this._accBins[t][i].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,zl.DECONFLICTION,t),this.visibilityGroup===ql.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*Hx(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}e([ae({constructOnly:!0})],Bx.prototype,"view",void 0),e([ae({type:Boolean,readOnly:!0})],Bx.prototype,"updating",null),Bx=e([le("esri.views.3d.layers.graphics.Deconflictor")],Bx);class Gx{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class Wx{constructor(e=null,t=null,i=null){this.active=e,this.visible=t,this.sort=i,this.sortArray=new Y({allocator:e=>e||new Gx})}}const $x=nr(),Qx=new class{constructor(){this.positionView=we(),this.positionNDC=we(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Sh}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let Xx=class extends Bx{constructor(e){super(e),this.visibilityGroup=ql.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return ko;const t=performance.now();if(e.state!==yh.IDLE&&t-this._lastDeconfliction<2e3)return ko;super.runTask(e),this.state===qx.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};e([ae({constructOnly:!0})],Xx.prototype,"parent",void 0),Xx=e([le("esri.views.3d.layers.graphics.LabelDeconflictor")],Xx);let Yx=class extends Bx{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=ql.GRAPHIC,this._marginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this.addHandles([U((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),U((()=>this.view?.map?.ground?.opacity),((e,t)=>{1!==e&&1!==t||this.setDirty()})),U((()=>this.view?.slicePlane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),k)]),this._frameTask=this.view.resourceController.scheduler.registerTask(jo.GRAPHICS_DECONFLICTOR,this),this._labels=new Xx({view:this.view,parent:this})}destroy(){this._labels=D(this._labels),this._frameTask=M(this._frameTask)}get marginFactor(){return this._marginFactor}set marginFactor(e){this._marginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&Zx(e));t.setVisibilityFlag(ql.GRAPHIC,zl.DECONFLICTION,i)}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;null!=e&&ct(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=null!=e}_slicePlaneChanged(){he(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new kx(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),Zx(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Zx(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.setVisibilityFlag(ql.GRAPHIC,zl.DECONFLICTION,!0)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t?.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function Zx(e){const t=e.layer;return!(!t?.featureReduction||"selection"!==t.featureReduction.type)}Yx=e([le("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Yx);class Kx{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustumBoundingSphereCenter=we(),this._frustumBoundingSphereRadius=0,this._frustum=new tv(e),this._extendedFrustum=new tv(e),this._intersector=new Bl({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e),this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(e){const t=this._renderCoordsHelper.viewingMode===Mt.Global&&e.lij[0]>=Jx&&e.lij[0]<ew,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==Oh.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const t=tv.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],n=i[r];Pi(sw,n,s),fi(sw,sw,iw),vi(i[r],s,sw)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let t=Oh.INVISIBLE;const i=this._cache.get(e.id);if(null!=i)return i;const r=ow.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(i!==Oh.INVISIBLE&&(t=i,i===Oh.VISIBLE_ON_SURFACE))break}return ow.release(r),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const i=this._cache.get(e.id);if(null!=i)return i;const r=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,r),r}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Mt.Global&&e.lij[0]<tw?this._calculateSingleTileVisibilitySided(e,!1)===Oh.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_isTileVisibleInFrustum(e){return this._renderCoordsHelper.viewingMode===Mt.Local?this._isTileVisibleInFrustumLocal(e):this._isTileVisibleInFrustumGlobal(e)}_updateFrustumBoundingSphere(){const e=this._frustum,t=e.origin,i=Ew;_i(i,e.direction);const r=e.points,s=Aw;Ci(s,r[4],t);const n=.5*gi(s,s)/gi(i,s),a=this._frustumBoundingSphereCenter;Mi(a,t,i,n);const o=1+n;this._frustumBoundingSphereRadius=o}_isTileVisibleInFrustumLocal(e){const t=e.tilingScheme.spatialReference,i=e.extent,r=this._renderCoordsHelper.spatialReference,s=yw;if(s[0]=i[0],s[1]=i[1],s[2]=0,s[3]=i[2],s[4]=i[3],s[5]=0,!Ih(s,t,0,s,r,0,2))return!1;const n=vw;ui(n[0],s[0],s[1],0),ui(n[1],s[3],s[1],0),ui(n[2],s[3],s[4],0),ui(n[3],s[0],s[4],0);const a=xw;ui(a,.5*(s[0]+s[3]),.5*(s[1]+s[4]),.5*(s[2]+s[5]));const o=ww;ui(o,0,0,1);const l=.5*Di(n[0],n[2]),c=this._frustum,h=this._frustumBoundingSphereRadius,d=this._frustumBoundingSphereCenter,u=Dw;Ci(u,d,a);const p=gi(o,u),m=Mw;if(Mi(m,a,o,p),Di(m,d)>l+h)return!1;const _=fw,g=p+h,f=p-h;for(let e=0;e<4;++e)Mi(_[e],n[e],o,g),Mi(_[e+4],n[e],o,f);return!pw(c.planes,_,8)}_isTileVisibleInFrustumGlobal(e){const t=e.tilingScheme.spatialReference,i=e.extent,r=this._renderCoordsHelper.spatialReference;if(e.lij[0]<mw)return!0;const s=vw,n=.5*(i[0]+i[2]),a=s[0][2]>0,o=s[3][2]<0,l=a||o,c=i[a?1:3];if(ui(s[0],i[0],i[1],0),ui(s[1],i[2],i[1],0),ui(s[2],i[2],i[3],0),ui(s[3],i[0],i[3],0),ui(s[4],n,c,0),!function(e,t,i,r,s,n,a=1){const o=Ah(t,s,Mh);if(null==o)return!1;if(o===Dh){if(e===r&&i===n)return!0;const t=i+a;for(let s=i,a=n;s<t;++s,++a)Ti(r[a],e[s]);return!0}const l=i+a;for(let t=i,s=n;t<l;++t,++s)o(e[t],0,r[s],0);return!0}(s,t,0,s,r,0,l?5:4))return!1;const h=Gt(r).radius;if(l){const e=xe(0,0,1),t=Cw;lw(t,e,s[0]);const i=Tw;if(lw(i,e,s[1]),a){const r=bw,n=s[4],a=Pw;lw(a,n,e),lw(r,a,n);const o=s[0];wi(o,t,r),hw(o,h);const l=s[1];wi(l,i,r),hw(l,h)}else if(o){const r=bw,n=s[4],a=Pw;lw(a,n,e),lw(r,n,a);const o=s[3];wi(o,r,t),hw(o,h);const l=s[2];wi(l,r,i),hw(l,h)}}const d=xw;{const e=Vw;Ci(e,s[3],s[0]),_i(e,e);const t=Uw;vi(t,s[0],s[3]),fi(t,t,.5);const i=-gi(t,e),r=jw,n=kw;vi(r,s[0],s[1]),fi(r,r,.5),vi(n,s[2],s[3]),fi(n,n,.5);const a=qw;Ci(a,n,r),_i(a,a);const o=-(i+gi(e,r))/gi(e,a);Mi(d,r,a,o),hw(d,h)}fi(ww,d,1/h);const u=Iw,p=this._frustumBoundingSphereRadius,m=this._frustumBoundingSphereCenter,_=this._frustum,g=_.planes;if(s.some((e=>_.intersectsPoint(e))))return!0;if(_.intersectsPoint(d))return!0;const f=Sw;_i(f,d);const y=Lw;Ci(y,m,u);const v=gi(y,f);if(v<-p)return!1;const x=Ow;_i(x,s[0]);const w=gi(x,f);if(w<=0)return!0;const b=Rw;fi(b,f,v);const C=Di(b,m),T=t.isWGS84,P=e.lij,S=T&&P[2]===2**P[0]-1,R=T&&0===P[2],O=R?Zw:S?Xw:$w,E=R?Kw:S?Yw:Qw,A=_.points;{const e=s,t=Jw;for(const i of O){const r=zw,s=Bw,n=e[i],a=u;if(cw(r,e[(i+1)%4],n),cw(s,a,n),lw(t,s,r),gw(t,A))return!1}}let M=null;if(v<2*p){const e=2.5*p;if(C>w*e+p)return!1;const t=Fw,i=e/w;for(let e=0;e<4;++e)fi(t[e],s[e],i/h);ui(t[4],0,0,0),M=t}else{const e=(v+p)/w,t=(v-p)/w,i=Nw;for(let r=0;r<4;++r){const n=s[r];fi(i[r+4],n,t/h),fi(i[r],n,e/h)}M=i}if(pw(g,M,M.length))return!1;const D=_.lines,I=Hw,L=Gw;for(const e of E){_i(I,s[e]);for(const e of D)if(_i(L,e.direction),tb(L,I,M,A))return!1}return!0}_calculateSingleTileVisibilitySided(e,t){if(this._isTileVisibleInFrustum(e)){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const i=Gt(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._frustum,i,!0)?Oh.VISIBLE_ON_SURFACE:Oh.VISIBLE_WHEN_EXTENDED}return Oh.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,sw);this._aboveGround||Ai(t,t);const i=qt(-gi(t,e.viewForward));if(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),s=this._extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],n=this._renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(n)){switch(this._renderCoordsHelper.worldUpAtPosition(i,sw),t){case th.FAR_BOTTOM_LEFT:case th.FAR_TOP_LEFT:case th.NEAR_BOTTOM_LEFT:case th.NEAR_TOP_LEFT:Fl(this._extendedFrustum.planes[dh.LEFT],sw,sw);break;case th.FAR_BOTTOM_RIGHT:case th.FAR_TOP_RIGHT:case th.NEAR_BOTTOM_RIGHT:case th.NEAR_TOP_RIGHT:Fl(this._extendedFrustum.planes[dh.RIGHT],sw,sw)}fi(sw,sw,r.direction),this._renderCoordsHelper.intersectInfiniteManifold(Cl(i,sw),r.zWithMargin,i)}}if(this._extendedFrustum.updatePoints(s),Vl(s[th.NEAR_BOTTOM_LEFT],s[th.NEAR_BOTTOM_RIGHT],s[th.NEAR_TOP_RIGHT],nw),Vl(s[th.NEAR_BOTTOM_RIGHT],s[th.NEAR_TOP_RIGHT],s[th.NEAR_TOP_LEFT],aw),gi(Il(nw),Il(aw))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[th.NEAR_BOTTOM_LEFT],e[th.NEAR_BOTTOM_RIGHT]]=[e[th.NEAR_BOTTOM_RIGHT],e[th.NEAR_BOTTOM_LEFT]]:[e[th.NEAR_TOP_LEFT],e[th.NEAR_TOP_RIGHT]]=[e[th.NEAR_TOP_RIGHT],e[th.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-rw;return{zWithMargin:e,pointIndices:tv.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+rw;return{zWithMargin:e,pointIndices:tv.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const Jx=2,ew=6,tw=12,iw=.95,rw=1,sw=we(),nw=Rl(),aw=Rl(),ow=new _e(Array,(e=>{4!==e.length&&(e[0]=new Rh,e[1]=new Rh,e[2]=new Rh,e[3]=new Rh)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));function lw(e,t,i){return wi(e,t,i),_i(e,e),e}function cw(e,t,i){return Ci(e,t,i),_i(e,e),e}function hw(e,t){return fi(e,e,t/Ii(e)),e}const dw=[dh.LEFT,dh.RIGHT,dh.BOTTOM,dh.TOP,dh.FAR];function uw(e,t,i){for(let r=0;r<i;++r)if(Ul(e,t[r])<0)return!1;return!0}function pw(e,t,i){for(const r of dw)if(uw(e[r],t,i))return!0;return!1}const mw=3,_w=1e-5;function gw(e,t){for(const i of t)if(gi(i,e)<_w)return!1;return!0}const fw=[we(),we(),we(),we(),we(),we(),we(),we()],yw=[0,0,0,0,0,0],vw=[we(),we(),we(),we(),we()],xw=we(),ww=we(),bw=we(),Cw=we(),Tw=we(),Pw=we(),Sw=we(),Rw=we(),Ow=we(),Ew=we(),Aw=we(),Mw=we(),Dw=we(),Iw=xe(0,0,0),Lw=we(),Nw=[we(),we(),we(),we(),we(),we(),we(),we()],Fw=[we(),we(),we(),we(),we()],Vw=we(),Uw=we(),jw=we(),kw=we(),qw=we(),zw=we(),Bw=we(),Hw=we(),Gw=we(),Ww=we(),$w=[0,1,2,3],Qw=[0,1,2,3],Xw=[0,1,3],Yw=[0,1,3],Zw=[1,2,3],Kw=[1,2,3],Jw=we(),eb=[0,0];function tb(e,t,i,r){const s=Ww;lw(s,e,t);const n=eb;return function(e,t,i){let r=1/0,s=-1/0;for(const e of i){const i=gi(t,e);r=Math.min(r,i),s=Math.max(s,i)}e[0]=r,e[1]=s}(n,s,i),function(e,t,i,r){let s=1/0,n=-1/0;for(const a of r){const r=gi(i,a);if(s=Math.min(s,r),n=Math.max(n,r),s<=t&&n>=e)return!1}return!0}(n[0],n[1],s,r)}class ib{constructor(e){this._camera=new Ic,this._focusOnMap=[0,0],this._screenRect=je(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new Kx(e.renderCoordsHelper)}begin(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,We(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=$e(e.extent,this._focusOnMap),e.measures.visibility!==Oh.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=rb,i=1<<t,r=e.measures.screenRect;ke(r);let s=0;const n=e.lij,a=n[0],o=a+t,l=n[1]<<t,c=n[2]<<t,h=this._tileSizeWithBias(e),d=h*h,u=this._camera,{frustum:p,viewport:m}=u;if(this._renderCoordsHelper.viewingMode===Mt.Local||a>mw){const t=ab;this._tilingScheme.getExtent(n[0],n[1],n[2],t);const i=nb,r=ub,s=ke();for(let e=0;e<4;++e)this._toRenderCoords(t,pb[e][0],pb[e][1],r[e]),u.projectToScreen(r[e],i[e]),Qe(s,i[e]);const a=pw(p,r,4),o=s[0]>m[2]||s[1]>m[3]||s[2]<m[0]||s[3]<m[1];if(a||o)return void(e.measures.shouldSplit=!1)}for(let t=0;t<i;t++)for(let n=0;n<i;n++)if(s+=this._computeScreenArea(o,l+t,c+n,r),s>d)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===Oh.VISIBLE_WHEN_EXTENDED?this._tileSize*sb:this._tileSize}_computeScreenArea(e,t,i,r){this._tilingScheme.ensureMaxLod(e);const s=ab;this._tilingScheme.getExtent(e,t,i,s);const n=lb;return this._toRenderCoords(s,0,3,n[0]),this._toRenderCoords(s,2,3,n[1]),this._toRenderCoords(s,2,1,n[2]),this._toRenderCoords(s,0,1,n[3]),this._computeTriangleScreenArea([n[0],n[1],n[2]],r)+this._computeTriangleScreenArea([n[2],n[1],n[3]],r)}_computeTriangleScreenArea(e,t){const i=this._camera.frustum[dh.NEAR];let r=0,s=-1,n=-1;for(let t=0;t<3;++t)Ul(i,e[t])>0?(r++,-1===s&&(s=t)):-1===n&&(n=t);if(0===r)return this._computeTriangleScreenAreaInside(e,t);if(1===r){const r=hb,n=(s+1)%3,a=(s+2)%3,o=s;Ti(r[0],e[n]),Ti(r[1],e[a]),db(r[2],e[a],e[o],i);const l=this._computeTriangleScreenAreaInside(r,t);return db(r[1],e[n],e[o],i),l+this._computeTriangleScreenAreaInside(r,t)}if(2===r){const r=hb,s=n;Ti(r[0],e[s]);const a=(n+1)%3,o=(n+2)%3;return db(r[1],e[s],e[a],i),db(r[2],e[s],e[o],i),this._computeTriangleScreenAreaInside(r,t)}return 0}_computeTriangleScreenAreaInside(e,t){for(let i=0;i<3;i++)this._camera.projectToRenderScreen(e[i],cb),this._camera.renderToScreen(cb,nb[i]),He(t,nb[i],t);return Eh(nb[0],nb[1],nb[2])}_toRenderCoords(e,t,i,r){return ob[0]=e[t],ob[1]=e[i],ob[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(ob,this._tilingScheme.spatialReference,r),r}}const rb=2,sb=5,nb=[J(),J(),J(),J()],ab=je(),ob=we(),lb=[we(),we(),we(),we()],cb=ie(),hb=[we(),we(),we()];function db(e,t,i,r){const s=Ul(r,t),n=Ul(r,i),a=Math.abs(n-s);fi(e,t,Math.abs(n)/a),Mi(e,e,i,Math.abs(s)/a)}const ub=[we(),we(),we(),we()],pb=[[0,3],[2,3],[2,1],[0,1]];let mb=class extends pe{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=je();return Hl(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new r,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new Y}initialize(){this.addHandles([U((()=>[this.tilingScheme,this.tileSize]),(()=>this._reset()),q),U((()=>[this.tileSize,this.cameraOnSurface?.location,this.tilingScheme,this.viewState?.contentCamera,this.focus?.location]),(()=>this._setDirty()),j)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(jo.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=M(this._frameWorker)}addClient(){const e=ge();return this._clients.add(e),1===this._clients.size&&this._setDirty(),y((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(qo))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=jo.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=jo.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new ib({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map((t=>new Rh(t[0],t[1],t[2],e)))}_purgeHorizonTiles(e){if(e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),!(e.length>fb))return e.toArray();ke(_b);for(let t=0;t<e.length;t++)if(He(_b,e.data[t].measures.screenRect,_b),Be(_b)>gb)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!Ge(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==Oh.INVISIBLE&&(i.measures.shouldSplit?(t.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===Oh.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([ae({constructOnly:!0})],mb.prototype,"scheduler",void 0),e([ae({constructOnly:!0})],mb.prototype,"renderCoordsHelper",void 0),e([ae({constructOnly:!0})],mb.prototype,"tilingSchemeOwner",void 0),e([ae({constructOnly:!0})],mb.prototype,"cameraOnSurface",void 0),e([ae({constructOnly:!0})],mb.prototype,"focus",void 0),e([ae({constructOnly:!0})],mb.prototype,"viewState",void 0),e([ae({constructOnly:!0})],mb.prototype,"terrain",void 0),e([ae()],mb.prototype,"tiles",void 0),e([ae()],mb.prototype,"tileSize",void 0),e([ae({readOnly:!0})],mb.prototype,"tilingScheme",null),e([ae()],mb.prototype,"filterExtent",null),e([ae({readOnly:!0})],mb.prototype,"_filterExtentRect",null),e([ae({readOnly:!0})],mb.prototype,"_rootTileIds",null),e([ae({value:!1})],mb.prototype,"suspended",null),e([ae({readOnly:!0})],mb.prototype,"updating",null),mb=e([le("esri.views.3d.layers.support.FeatureTileTree3D")],mb);const _b=je(),gb=10,fb=50;let yb=class extends pe{constructor(){super(...arguments),this._propertiesPool=new fh({camera:Ic},this),this._lastSeenCameraProjectionValues=new Ic,this.mode=yh.ANIMATING,this._cssCamera=new Ic,this._camera=new Ic,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new di,this.viewingMode=Mt.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Wp({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new fh({camera:Ic},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Mt.Global){const e=Gt(this.spatialReference).radius;this.camera=new Ic({eye:xe(4*e,0,0),center:xe(e,0,0),up:xe(0,0,1)})}else this.camera=new Ic({eye:xe(0,0,100),center:xe(0,0,0),up:xe(0,1,0)})}get animation(){return this.cameraController instanceof ff&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==xb&&xb.copyFrom(e),xb.computeUp(this.viewingMode),this.events.emit("before-camera-change",xb);const t=this._camera;if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,xb)&&(this._lastSeenCameraProjectionValues.copyFrom(xb),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(xb)&&(this._camera=this._propertiesPool.get("camera").copyFrom(xb),this._cameraChanged=!t.almostEquals(xb),this._cameraChanged)){const e=fe((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===yh.IDLE}get updating(){return this.mode!==yh.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=null!=e?e.clone():null}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return this.viewingMode===Mt.Global}get isLocal(){return this.viewingMode===Mt.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(wb),this.addHandles(H((()=>e.state===_f.Finished||e.state===_f.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),wb),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=_f.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==_f.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();xb.copyFrom(this._get("camera")),e(xb),this.camera=xb,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Lc.TOP]!==t.padding[Lc.TOP]||e.padding[Lc.RIGHT]!==t.padding[Lc.RIGHT]||e.padding[Lc.BOTTOM]!==t.padding[Lc.BOTTOM]||e.padding[Lc.LEFT]!==t.padding[Lc.LEFT]}};e([ae()],yb.prototype,"mode",void 0),e([ae({readOnly:!0,type:At})],yb.prototype,"animation",null),e([ae({type:Ic})],yb.prototype,"cssCamera",null),e([ae()],yb.prototype,"_cssCamera",void 0),e([ae({type:Ic})],yb.prototype,"camera",null),e([ae()],yb.prototype,"_camera",void 0),e([ae({readOnly:!0})],yb.prototype,"pixelRatio",null),e([ae()],yb.prototype,"rasterPixelRatio",void 0),e([ae()],yb.prototype,"contentPixelRatio",void 0),e([ae({readOnly:!0})],yb.prototype,"alignPixelEnabled",null),e([ae({readOnly:!0})],yb.prototype,"updating",null),e([ae({})],yb.prototype,"_contentCamera",void 0),e([ae({type:Ic})],yb.prototype,"contentCamera",null),e([ae({readOnly:!0})],yb.prototype,"fixedContentCamera",null),e([ae({readOnly:!0})],yb.prototype,"constraints",void 0),e([ae({readOnly:!0})],yb.prototype,"events",void 0),e([ae({readOnly:!0})],yb.prototype,"isGlobal",null),e([ae({readOnly:!0})],yb.prototype,"isLocal",null),e([ae({readOnly:!0})],yb.prototype,"viewingMode",void 0),e([ae({readOnly:!0})],yb.prototype,"spatialReference",void 0),e([ae()],yb.prototype,"navigating",null),e([ae()],yb.prototype,"stationary",null),e([ae()],yb.prototype,"_cameraChanged",void 0),e([ae()],yb.prototype,"cameraController",null),yb=e([le("esri.views.3d.state.ViewState")],yb);const vb=yb,xb=new Ic,wb="ViewStateHandles";class bb{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new Y,this._tolerance=Fc,this._tmpRay=Sl(),this._tmpRegion=je(),this._validateHUDIntersector=Nc(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Rb(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,Rb(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=Vc.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(Mb,i,r),Mb[0]+=.0466,Mb[1]-=.0123,Wc(e,Mb,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Uc(r)&&r.intersector!==jc.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=Fc){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===jc.TERRAIN?1:t.type===jc.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===jc.TERRAIN?1:t.type===jc.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return Gc(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Mt.Local||null==e||vi(t,e.origin,_i(Al.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(null==e)return null;const s=null!=t?t.mode:"absolute-height",n=t?.offset??0,a="on-the-ground"!==s?n+i:0,o=a/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===s){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,a,Ab)){const e=Nh(this._view,Ab);return e.z??=0,e.z-=n,e}return null}const l=this._view.state.camera,c=re(Al.get());l.projectToRenderScreen(e.origin,c);const h=new Ob(null,this._forEachLayer),d=this._view.slicePlane,u=null!=d?kc(d):null,p=Nc(this.viewingMode);p.options.store=Vc.MIN,p.options.verticalOffset=o;const m=e.origin,_=vi(Al.get(),m,e.direction);p.reset(m,_,l),p.point=c;const g=r?"type"in r&&"graphics"===r.type?e=>e.layerUid!==r.uid:e=>e.graphicUid!==r.uid:null;switch(s){case"relative-to-scene":{const e=e=>(!g||g(e))&&!!e.lastValidElevationBB;p.intersect(h.layers,c,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===jc.I3S||e.type===jc.TERRAIN||e.type===jc.TILES3D){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,c)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,c)}}))}if(p.results.min.getIntersectionPoint(Ab)){const e=Nh(this._view,Ab);return e.z=i,e}return null}computeIntersection(e,t,i,r){if(null==e)return;const s=this._view.state.camera,n=re(Al.get());s.projectToRenderScreen(e.origin,n);const a=new Ob(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const o=e.origin,l=vi(Al.get(),e.origin,e.direction);t.reset(o,l,s),t.intersect(a.layers,n,this._tolerance);const c=this._view.slicePlane,h=null!=c?kc(c):null;t.intersect(a.sliceableLayers,n,this._tolerance,h);const d=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerUid,s=Array.isArray(i),c=s?i:[i];s&&(t.options.filteredLayerUids=[]);let u=!1;for(const e of c)a.filterLayerUid(e)?u=!0:s&&t.options.filteredLayerUids.push(e);if(t.options.isFiltered=!u,e.isGround&&d||!t.options.isFiltered){const i=e.slicePlaneEnabled?h:null;e.intersect(t,i,o,l,n,r)}}));const u=Al.get(),p=this._view.basemapTerrain;if(i&&i.enableDraped&&null!=p.spatialReference&&t.results.ground.getIntersectionPoint(u)){const e=p.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,r=Al.get();this._view.renderCoordsHelper.fromRenderCoords(u,r,p.spatialReference),r[2]=this._view.elevationProvider?.getElevation(u[0],u[1],u[2],i,"ground")??0,e.intersect(t,r,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Xe(this._tmpRegion,Ye);const i=this._view.state.camera,r=[],s=this._tmpRegion,n=e=>{const t=new Pb(e);i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),Qe(s,t.screenPoint)};e.sortResults(t.all),null!=t.min.dist&&n(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&n(e);if(null!=t.max.dist&&t.max.target.object!==t.min.target.object&&n(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const a=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-Cb),c=Math.max(0,s[1]-Cb),h=Math.min(ze(s)+2*Cb,a-l),d=Math.min(Be(s)+2*Cb,o-c);if(h<=0||d<=0)return;const u=new Uint8Array(h*d*4);this._view._stage.renderer.readHUDVisibility(l,c,h,d,u);let p=!0;const m=null==e.results.max.dist;let _=0;for(const t of r)for(const i of Tb){const r=4*(Math.min(t.screenPoint[0]+i[0],a)-s[0]+(Math.min(t.screenPoint[1]+i[1],o)-s[1])*h);if(!(r<0||r>=u.length)&&u[r]){p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),e.options.store===Vc.ALL&&e.results.all.splice(_++,0,t.result);break}}}}const Cb=1,Tb=(()=>{const e=[],t=Cb;for(let i=-t;i<=t;i++)for(let r=-t;r<=t;r++)e.push([r+t,i+t]);return e})();class Pb{constructor(e){this.result=e,this.screenPoint=ie()}}let Sb;function Rb(e){return Sb&&Sb.viewingMode===e||(Sb=Nc(e)),Sb}class Ob{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return null==e?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function Eb(e){return"object"==typeof e&&"intersect"in e}const Ab=we(),Mb=ie();let Db=class extends(di.EventedMixin(pe)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=D(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,s){if(this._cacheEnabled&&null!=this.lastElevationQuery){const n=this.lastElevationQuery;if(e===n.x&&t===n.y&&i===n.z&&Yt(r,n.spatialReference)&&s===n.queryContext)return n.result}let n=null;return n=Ib(n,this._im,e,t,i,r,s),null==n&&(n=Ib(n,this._ground,e,t,i,r,s)),"scene"===s&&(n=Ib(n,this._scene,e,t,i,r,s)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}getSphereElevationBounds(e,t){const i=new jh,r=r=>{if(r.getSphereElevationBounds){const s=r.getSphereElevationBounds(e,t);null!=s&&i.expandElevationRangeValues(s.elevationRangeMin,s.elevationRangeMax)}};for(const e of[this._im,this._ground,this._scene])e.forEach(r);return i}getRootElevationBounds(){const e=new jh;for(const t of[this._im,this._ground,this._scene])t.forEach((t=>{if(t.getRootElevationBounds){const i=t.getRootElevationBounds();null!=i&&e.expandElevationRangeValues(i.elevationRangeMin,i.elevationRangeMax)}}));return e}async queryElevation(e,t,i,r,s,n=null,a=0){const o=this._getElevationQuery(r);try{const l=await o.queryElevation(e,t,n,a);return"scene"===s?Ib(l,this._scene,e,t,i,r,s):l}catch(n){return p(n),this.getElevation(e,t,i,r,s)}}register(e,t){this.addHandles(t.on("elevation-change",(e=>this.emit("elevation-change",e))),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){const t=this._cachedQuery;if(null!=t&&Yt(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});const{wkid:i,wkt:r,wkt2:s,latestWkid:n}=e,a=new Gl(this.view.resourceController.scheduler,new Uh({wkid:i,wkt:r,wkt2:s,latestWkid:n}),(()=>this.view.map?.ground),{maximumAutoTileRequests:4});return this._cachedQuery=a,a}};function Ib(e,t,i,r,s,n,a){for(const o of t){const t=o.getElevation(i,r,s,n,a);null!=t&&(e=null!=e?Math.max(t,e):t)}return e}e([ae({constructOnly:!0})],Db.prototype,"view",void 0),e([ae()],Db.prototype,"spatialReference",null),Db=e([le("esri.views.3d.support.CombinedElevationProvider")],Db);class Lb{static isValidProfile(e){return e in Lb.profiles}static getDefaultProfile(){return b("esri-iPhone")?"low":"medium"}static apply(e,t){const i=Lb.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxNumberOfDrawCalls=i.graphics3D.maxNumberOfDrawCalls,t.graphics3D.maxTotalNumberOfVertices=i.graphics3D.maxTotalNumberOfVertices,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods,t.graphics3D.uncompressedTextureDownsamplingEnabled=i.graphics3D.uncompressedTextureDownsamplingEnabled;const r=t.sceneService.object,s=i.sceneService.object;r.lodFactor=s.lodFactor,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.vtlContentZoom=i.tiledSurface.vtlContentZoom,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.highResolutionAtmosphere=i.highResolutionAtmosphere,t.reflections=i.reflections,t.ambientOcclusion=i.ambientOcclusion,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}}Lb.test={reset(){const e=Fb();for(const t of Object.keys(e))Lb.profiles[t]=e[t]}};const Nb={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function Fb(){const e=!!b("esri-mobile"),t=!!b("ios"),i=$(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,reduceTileLevelDifferences:!0},fadeDuration:$(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Nb.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!b("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+Nb.GalaxyS20:750+Nb.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,reduceTileLevelDifferences:!b("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+Nb.SurfacePro7:1500+Nb.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}!function(e){e.profiles=Fb()}(Lb||(Lb={}));const Vb=Lb,Ub=new qh([0,255,255]),jb=new qh([0,0,0]);let kb=class extends pe{constructor(){super(...arguments),this.color=Ub.clone(),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=jb.clone(),this.shadowDifference=.2}};e([ae({type:qh})],kb.prototype,"color",void 0),e([ae({type:qh})],kb.prototype,"haloColor",void 0),e([ae()],kb.prototype,"haloOpacity",void 0),e([ae()],kb.prototype,"fillOpacity",void 0),e([ae()],kb.prototype,"shadowOpacity",void 0),e([ae({type:qh})],kb.prototype,"shadowColor",void 0),e([ae()],kb.prototype,"shadowDifference",void 0),kb=e([le("esri.views.3d.support.HighlightOptions")],kb);const qb=kb;class zb{constructor(e,t){this.spatialReference=t,this.unitInMeters=Xt(this.spatialReference,Gt(this.spatialReference).metersPerDegree);const i=e&&"portalItem"in e?e.portalItem:void 0;this._geometryServiceURLPromise=zh(i).catch((()=>{throw new a("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(e){const t=await this._geometryServiceURLPromise;let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof eh?e:new eh(e,this.spatialReference))),n=new Hh({geometries:s,outSpatialReference:Uh.WGS84}),a=(await Bh(t,n)).map((e=>"point"===e.type?[e.x,e.y]:void 0)).filter((e=>!!e));return r?a:a[0]}}var Bb;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(Bb||(Bb={}));const Hb=[Bb.ELEVATION,Bb.MAP],Gb={layerUids:new Set,layerViews:[]};let Wb=class extends pe{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};e([ae()],Wb.prototype,"minTotalNumberOfFeatures",void 0),e([ae()],Wb.prototype,"maxTotalNumberOfFeatures",void 0),e([ae()],Wb.prototype,"maxNumberOfDrawCalls",void 0),e([ae()],Wb.prototype,"maxTotalNumberOfVertices",void 0),e([ae()],Wb.prototype,"snapshotAvailable",void 0),e([ae()],Wb.prototype,"polygonLodFactor",void 0),e([ae()],Wb.prototype,"polylineLodFactor",void 0),e([ae()],Wb.prototype,"skipHighSymbolLods",void 0),e([ae()],Wb.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Wb=e([le("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Wb);let $b=class extends pe{constructor(){super(...arguments),this.lodFactor=1}};e([ae()],$b.prototype,"lodFactor",void 0),$b=e([le("esri.views.3d.support.QualitySettings.LoDFactorSettings")],$b);let Qb=class extends pe{constructor(){super(...arguments),this.object=new $b,this.point=new $b,this.integratedMesh=new $b,this.pointCloud=new $b,this.uncompressedTextureDownsamplingEnabled=!1}};e([ae({type:$b})],Qb.prototype,"object",void 0),e([ae({type:$b})],Qb.prototype,"point",void 0),e([ae({type:$b})],Qb.prototype,"integratedMesh",void 0),e([ae({type:$b})],Qb.prototype,"pointCloud",void 0),e([ae()],Qb.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Qb=e([le("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Qb);let Xb=class extends pe{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.reduceTileLevelDifferences=!0}};e([ae()],Xb.prototype,"lodBias",void 0),e([ae()],Xb.prototype,"angledSplitBias",void 0),e([ae()],Xb.prototype,"vtlContentZoom",void 0),e([ae()],Xb.prototype,"reduceTileLevelDifferences",void 0),Xb=e([le("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Xb);let Yb=class extends pe{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e([ae()],Yb.prototype,"pixelRatio",void 0),e([ae()],Yb.prototype,"maxTotalNumberOfFeatures",void 0),Yb=e([le("esri.views.3d.support.QualitySettings.HeatmapSettings")],Yb);let Zb=class extends pe{constructor(){super(...arguments),this.graphics3D=new Wb,this.sceneService=new Qb,this.tiledSurface=new Xb,this.heatmap=new Yb,this.fadeDuration=$(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};e([ae({type:Wb})],Zb.prototype,"graphics3D",void 0),e([ae({type:Qb})],Zb.prototype,"sceneService",void 0),e([ae({type:Xb})],Zb.prototype,"tiledSurface",void 0),e([ae({type:Yb})],Zb.prototype,"heatmap",void 0),e([ae()],Zb.prototype,"fadeDuration",void 0),e([ae()],Zb.prototype,"antialiasingEnabled",void 0),e([ae()],Zb.prototype,"physicallyBasedRenderingEnabled",void 0),e([ae()],Zb.prototype,"highQualityTransparency",void 0),e([ae()],Zb.prototype,"highResolutionAtmosphere",void 0),e([ae()],Zb.prototype,"reflections",void 0),e([ae()],Zb.prototype,"ambientOcclusion",void 0),e([ae()],Zb.prototype,"memoryLimit",void 0),e([ae()],Zb.prototype,"additionalCacheMemory",void 0),e([ae()],Zb.prototype,"frameRate",void 0),e([ae()],Zb.prototype,"maximumPixelRatio",void 0),Zb=e([le("esri.views.3d.support.QualitySettings.QualitySettings")],Zb);const Kb=Zb;let Jb=class extends pe{constructor(){super(...arguments),this.updating=!1}};e([ae({readOnly:!0})],Jb.prototype,"updating",void 0),Jb=e([le("esri.views.3d.support.ResourceControllerMain")],Jb);let eC=class extends Jb{constructor(){super(...arguments),this._immediateTask=zo,this._normalTask=zo,this._updatingObjects=Wh([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=Bo(),this._memoryController=wa(this.view),this._streamDataLoader=new $h,this._streamDataLoader.setup(ba,Ca,this._scheduler),this.addHandles([U((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),q),U((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=X({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(jo.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(jo.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=M(this._frameTask),this._streamDataLoader=D(this._streamDataLoader),this._memoryController=D(this._memoryController),this._scheduler=D(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some((e=>e.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){const t=this._updatingObjects;return t.value=[...t.value,e],y((()=>{t.value=t.value.filter((t=>t!==e))}))}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(W(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.updateBudget(e)&&this._scheduler.frame())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};e([ae()],eC.prototype,"view",void 0),e([ae()],eC.prototype,"_scheduler",void 0),e([ae()],eC.prototype,"_memoryController",void 0),e([ae()],eC.prototype,"_streamDataLoader",void 0),e([ae()],eC.prototype,"_immediateTask",void 0),e([ae()],eC.prototype,"_normalTask",void 0),e([ae()],eC.prototype,"_updatingObjects",void 0),e([ae({readOnly:!0})],eC.prototype,"updating",null),eC=e([le("esri.views.3d.support.ResourceControllerImpl")],eC);class tC{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`,s=this._gltfMemCache.get(r);return null!=s?Promise.resolve(s):this._loadOnce(this._gltfLoading,this._gltfMemCache,r,(t=>Vd(new Ud(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return null!=r?Promise.resolve(r):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,(t=>to(e,t)),t)}async _loadOnce(e,t,i,r,s){m(s);const n=u(s,(()=>this._abortLoad(e,i)));let a=e.get(i);if(a)a.refCount++;else{const t=new AbortController;a={refCount:1,abortController:t,promise:r({...s,signal:t.signal})},e.set(i,a)}try{const r=await a.promise;return t.put(i,r,r.size),e.delete(i),m(s),r}finally{M(n)}}_abortLoad(e,t){const i=e.get(t);null!=i&&--i.refCount>0||(e.delete(t),null!=i&&i.abortController.abort())}}let iC=class extends pe{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(jo.TEXTURE_UNLOAD)??zo}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){const i=this.makeUid(e);let r=this._textureRequests.get(i);if(!r){const e=new sC;e.texture=t(),this._stage&&(e.texture.load(this._stage.renderView.renderingContext),this._stage.add(e.texture)),this._textureRequests.set(i,e),r=e}return r.referenceCount++,new rC(i,r.texture,(()=>this._release(i)))}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return null!=t?`${e}.${t}px`:e}};e([ae()],iC.prototype,"_frameTask",void 0),e([ae()],iC.prototype,"updating",null),iC=e([le("esri.views.3d.support.TextureCollection")],iC);class rC{constructor(e,t,i){this.uid=e,this.texture=t,this.release=i}}class sC{constructor(){this.referenceCount=0}}class nC extends iC{constructor(e,t,i){super(t,i),this._streamDataRequester=e}async fromUrl(e,t,i){m(i);const r=i?.signal,s=this.makeUid(e,t);let n=this._textureRequests.get(s);if(!n){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});n=new sC,n.abortController=i;const a=n;this._textureRequests.set(s,n),n.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return a.texture=r,a.abortController=null,await r.load(this._stage.renderView.renderingContext),this._stage.add(r),new rC(s,r,(()=>this._release(s)))}),(e=>{throw a.abortController=null,e}))}n.referenceCount++;try{return await _(n.textureAsync,r)}catch(e){throw this._release(s),e}}_createTexture(e,t,i){const r={width:t.width,height:t.height,wrap:{s:Hn.CLAMP_TO_EDGE,t:Hn.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(kd(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return new as(t,r)}}class aC{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Ta.SYMBOLOGY),this.objectResourceCache=new tC(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new nC(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const t=Gt(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=An(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=Mn(e.viewingMode,t)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return y();this._graphicsOwners.push(e);const t=U((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),y((()=>{t.remove(),C(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new qi;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([U((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,q),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=D(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;oC.distance=e.centerOnSurfaceInfrequent.distance,oC.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(oC),this.screenSizePerspectiveSettingsLabels.update(oC),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}const oC={distance:0,fovY:0};class lC{constructor(e,t,i=""){this.graphics=e,this._symbol=new zd({symbolLayers:new r([new Bd({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Hd({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})])})}show(e,t){if(null==t)return;this.hide();const i=new eh({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new qd({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){null!=this._graphic&&(this.graphics.remove(this._graphic),this._graphic=null)}}let cC=class extends pe{constructor(e){super(e)}};e([ae({constructOnly:!0})],cC.prototype,"renderCoordsHelper",void 0),e([ae({constructOnly:!0})],cC.prototype,"surface",void 0),e([ae({constructOnly:!0})],cC.prototype,"state",void 0),cC=e([le("esri.views.3d.support.PointOfInterest")],cC);const hC=Array;let dC=class extends cC{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new fh({location:eh,renderLocation:hC},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=we(),this._tmpPoint=new eh}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.addHandles(B((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=D(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){const e=this._camera,t=xi(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Jl(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),ko;const e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);const t=(this._tmpPoint.z??0)>pC&&this.renderCoordsHelper.viewingMode===Mt.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?mC:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{h(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,ko}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(uC,this._estimatedSurfaceAltitude,this._camera.eye),Li(this._get("renderLocation"),uC)||(this._set("renderLocation",Ti(this._propertiesPool.get("renderLocation"),uC)),this.notifyChange("renderLocation"))}};e([ae({constructOnly:!0})],dC.prototype,"scheduler",void 0),e([ae({constructOnly:!0})],dC.prototype,"cache",void 0),e([ae({constructOnly:!0})],dC.prototype,"task",void 0),e([ae()],dC.prototype,"location",null),e([ae({constructOnly:!0})],dC.prototype,"map",void 0),e([ae()],dC.prototype,"renderLocation",void 0),e([ae()],dC.prototype,"scale",null),e([ae()],dC.prototype,"updating",null),dC=e([le("esri.views.3d.support.CameraOnSurface")],dC);const uC=we(),pC=1e5,mC=1e6,_C=Array;let gC=class extends cC{constructor(e){super(e),this._propertiesPool=new fh({location:eh,renderLocation:_C},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=we(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=M(this._frameWorker),this._propertiesPool=D(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,ko}_updateRenderLocation(){const e=yC;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=vC;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(Ti(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=xi(this._camera.eye,e):(fi(e,this._camera.viewForward,this._get("distance")),vi(e,e,this._camera.eye)),Li(this._get("renderLocation"),e)||this._set("renderLocation",Ti(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=Gt(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=mi(i.eye),a=n<s*s,o=xi(i.eye,t);if(a&&o>r/4){const e=s-Math.sqrt(n);return fi(t,i.viewForward,e),vi(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;null!=e&&Ve(e,this.surface?.spatialReference,xC,this.renderCoordsHelper.spatialReference)&&(t[0]=Ft(t[0],xC[0],xC[2]),t[1]=Ft(t[1],xC[1],xC[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Th.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=xi(i,e),s=xi(i,t);if(Math.abs(s-r)/r>fC)return!0}return!1}};e([ae({constructOnly:!0})],gC.prototype,"scheduler",void 0),e([ae({constructOnly:!0})],gC.prototype,"task",void 0),e([ae()],gC.prototype,"distance",void 0),e([ae({constructOnly:!0})],gC.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([ae({readOnly:!0})],gC.prototype,"location",null),e([ae({readOnly:!0})],gC.prototype,"renderLocation",void 0),e([ae()],gC.prototype,"updating",void 0),gC=e([le("esri.views.3d.support.CenterOnSurface")],gC);const fC=.05,yC=we(),vC=we(),xC=je();class wC{constructor(e){this._handles=new qi,this.events=new di,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=D(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this._handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this._handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",bC)}}const bC={},CC=Array;let TC=class extends cC{constructor(e){super(e),this._propertiesPool=new fh({location:eh,renderLocation:CC},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([U((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),U((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.addHandles(this.scheduler.registerTask(jo.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=D(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){const{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,PC);const s=Math.max(0,(Math.acos(gi(PC,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!Ni(e,t)){const e=this._propertiesPool.get("renderLocation");Ti(e,t),this._set("renderLocation",e)}return ko}const n=1-Ft(s/(.5*Math.PI),0,1),a=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(RC);const o=this._propertiesPool.get("renderLocation");return yi(o,t,RC,a),e&&Ni(e,o)||this._set("renderLocation",o),ko}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(ie());if(i[1]=t.aboveGround?t.padding[Lc.BOTTOM]:t.fullHeight-t.padding[Lc.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,SC)){Pi(SC,SC,t.eye);const i=_i(SC,SC);if(this.renderCoordsHelper.intersectInfiniteManifold(Cl(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};e([ae()],TC.prototype,"_dirty",void 0),e([ae({constructOnly:!0})],TC.prototype,"scheduler",void 0),e([ae({constructOnly:!0})],TC.prototype,"centerOnSurface",void 0),e([ae({constructOnly:!0})],TC.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([ae()],TC.prototype,"updating",null),e([ae()],TC.prototype,"location",null),e([ae()],TC.prototype,"renderLocation",void 0),e([ae()],TC.prototype,"worldUnitsPerContentPixel",null),TC=e([le("esri.views.3d.support.pointsOfInterest.Focus")],TC);const PC=we(),SC=we(),RC=we();let OC=class extends pe{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=we();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([U((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),B((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),null==this.surfaceView?.extent||null==this.surfaceView.spatialReference)return void this._set("location",null);const e=Ze(this.surfaceView.extent),t=new eh({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{h(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};e([ae({constructOnly:!0})],OC.prototype,"view",void 0),e([ae({constructOnly:!0})],OC.prototype,"cache",void 0),e([ae()],OC.prototype,"surface",null),e([ae()],OC.prototype,"surfaceView",null),e([ae({readOnly:!0})],OC.prototype,"location",void 0),e([ae({readOnly:!0})],OC.prototype,"renderLocation",null),OC=e([le("esri.views.3d.terrain.StableSurfaceCenter")],OC);let EC=class extends pe{constructor(e){super(e),this._tileGeometryUpdateExtent=ke(),this._tileGeometryUpdateSpatialReference=null,this.events=new di,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(jo.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",AC),ke(this._tileGeometryUpdateExtent),this._set("updating",!1),ko):ko}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,He(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=IC,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,MC,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,DC,t),MC[0]<DC[0]?(r[0]=MC[0],r[2]=DC[0]):(r[0]=DC[0],r[2]=MC[0]),MC[1]<DC[1]?(r[1]=MC[1],r[3]=DC[1]):(r[1]=DC[1],r[3]=MC[1]),Ge(r,e)}};e([ae({constructOnly:!0})],EC.prototype,"state",void 0),e([ae({constructOnly:!0})],EC.prototype,"centerOnSurfaces",void 0),e([ae({constructOnly:!0})],EC.prototype,"renderCoordsHelper",void 0),e([ae({constructOnly:!0})],EC.prototype,"scheduler",void 0),e([ae({constructOnly:!0})],EC.prototype,"surface",void 0),e([ae({readOnly:!0})],EC.prototype,"updating",void 0),EC=e([le("esri.views.3d.support.SurfaceGeometryUpdates")],EC);const AC={},MC=we(),DC=we(),IC=ke();let LC=class extends pe{constructor(e){super(e),this.renderPointOfView=we(),this._pois=new Array,this._debugCenters=new Map,this._tmpRay=Sl(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new fh({renderPointOfView:NC},this)}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=Nc(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Vc.MIN,this._contentIntersector=Nc(e.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,a=this.view.basemapTerrain?.elevationQueryCache,o={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new gC({...o,task:jo.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new gC({...o,task:jo.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new gC({...o,task:jo.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new dC({...o,cache:a,task:jo.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new EC({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new wC({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new OC({cache:a,view:this.view})),this._set("focus",new TC({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new lC(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new lC(l,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new lC(l,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new lC(l,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new lC(l,"green","Focus")),this.addHandles([U((()=>e.contentCamera),(e=>this._cameraChanged(e)),q),U((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),H((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),q),B((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),B((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),H((()=>Th.SHOW_POI),(e=>this._setDebug(e)),k)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return null==e||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,FC,UC)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(FC):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(null==e)return this._surfaceAltitudeAtCenter;const t=e.origin,i=vi(FC,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(FC)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(FC)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=Wc(t,e,VC);if(null==r)return null;const s=r.origin,n=vi(FC,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;Li(this.renderPointOfView,t)||this._set("renderPointOfView",Ti(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this.removeHandles("debug");for(const e of this._pois)this.addHandles(U((()=>e.renderLocation),(t=>this._debugCenters.get(e)?.show(t,e.renderCoordsHelper.spatialReference)),k),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e([ae()],LC.prototype,"centerOnContent",void 0),e([ae()],LC.prototype,"centerOnSurfaceFrequent",void 0),e([ae()],LC.prototype,"centerOnSurfaceInfrequent",void 0),e([ae()],LC.prototype,"cameraOnSurface",void 0),e([ae()],LC.prototype,"focus",void 0),e([ae()],LC.prototype,"renderPointOfView",void 0),e([ae()],LC.prototype,"surfaceOrigin",void 0),e([ae()],LC.prototype,"contentGeometryUpdates",void 0),e([ae()],LC.prototype,"surfaceGeometryUpdates",void 0),e([ae({constructOnly:!0})],LC.prototype,"view",void 0),e([ae()],LC.prototype,"updating",null),LC=e([le("esri.views.3d.support.PointsOfInterest")],LC);const NC=Array,FC=we(),VC=Sl(),UC={exclude:new Set([$c])};class jC{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class kC{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new eu(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const n=2**s;if(Math.floor(t/n)!==this.i||Math.floor(i/n)!==this.j)return r;let a=1/0,o=-1/0;const l=this.samplerData.data.width,c=this.samplerData.data.values,h=.5*tu;let d=(l-1)/n,u=(i-this.j*n)*d,p=(t-this.i*n)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=c[i],n=c[i+1],a=c[i+l],o=c[i+l+1];if(s+n+a+o<h){const i=u-e,l=p-t,c=ri(s,n,a,o,i,l),h=ri(s,n,a,o,i+d,l),m=ri(s,n,a,o,i,l+d),_=ri(s,n,a,o,i+d,l+d);return r.min=Math.min(c,h,m,_),r.max=Math.max(c,h,m,_),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=c[e+t*l];i<h?(a=Math.min(a,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=a,r.max=o,r}}const qC=.5*tu;function zC(e,t,i){if(null==i)return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let s=Ft(r.dy*(r.y1-t),0,i),n=Ft(r.dx*(e-r.x0),0,i);const a=Math.floor(s),o=Math.floor(n),l=r.data.width,c=a*l+o,h=r.data.values,d=h[c],u=h[c+1],p=c+l,m=h[p],_=h[p+1];if(d+m+u+_<qC){s-=a,n-=o;const e=d+(u-d)*n;return e+(m+(_-m)*n-e)*s}}return null}let BC=class extends pe{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if(vt(i.operationalLayerType)&&null!=this.viewSpatialReference){const t=WC(i.fullExtent,this.viewSpatialReference);null!=t&&e.push(et(t))}})),e}};e([ae({readOnly:!0})],BC.prototype,"layerViewsExtent",null),e([ae({readOnly:!0})],BC.prototype,"tiledLayersExtent",null),e([ae({readOnly:!0})],BC.prototype,"stencilEnabledExtents",null),e([ae()],BC.prototype,"viewSpatialReference",void 0),e([ae()],BC.prototype,"tilingScheme",void 0),e([ae()],BC.prototype,"defaultTiledLayersExtent",void 0),e([ae({constructOnly:!0})],BC.prototype,"layers",void 0),e([ae({constructOnly:!0})],BC.prototype,"layerViews",void 0),BC=e([le("esri.views.3d.terrain.ExtentHelper")],BC);let HC=class extends BC{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?iu:ru}};HC=e([le("esri.views.3d.terrain.ExtentHelperGlobal")],HC);let GC=class extends BC{_computeLayerViewsExtent(){const e=ke(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=WC("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);He(e,r,e)}}));const i=Ke(e)?e:null,r=this._get("layerViewsExtent");return Je(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=ke();this.layers.forEach((r=>{if(r.loaded&&yt(r)){const s=Qh(r,t,Mt.Local);if(null==s)return;const{tileInfo:n,fullExtent:a}=s;null!=n&&null!=a&&(Xh(r)||e.compatibleWith(n)&&a.spatialReference.equals(e.spatialReference))&&He(i,a,i)}})),He(i,this.defaultTiledLayersExtent,i);const r=Ke(i)?i:null,s=this._get("tiledLayersExtent");return Je(r,s)?s:r}};function WC(e,t){return null==e||e.spatialReference.equals(t)?e:Le(e,e.spatialReference,t)}function $C(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)i.includes(".glsl")&&delete e[i]}}GC=e([le("esri.views.3d.terrain.ExtentHelperLocal")],GC);const QC=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let XC,YC=class extends pe{constructor(e){super(e),this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=b("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){const e=this.view;this.renderer=new qs({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),e._stage.renderer.plugins.add(this.renderer);const t=()=>this.setDrawTexturesDirty();this._groundIntersector=Nc(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([U((()=>this.renderer.hasHighlights),t),this.renderer.events.on("has-water",(t=>e._stage?.renderer.setParameters({hasOverlayWater:t}))),this.renderer.events.on("content-changed",t),U((()=>e.state.camera.pixelRatio),t),U((()=>e.state.alignPixelEnabled),t),this.renderer.events.on("textures-disposed",(()=>this.surface.requestRender())),U((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),U((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),q),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(jo.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(qo,e.camera,pu.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(pu.BACKGROUND,e)}))]),e._stage.renderer.renderOverlay=e=>this._renderOverlay(e)}destroy(){this.view?._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.renderOverlay=()=>{}),XC&&(XC.hide(),XC=null),this.renderer=D(this.renderer)}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||Th.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return null!=this._spatialReference&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Gt(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return 1.3/this.view.resolutionScale}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}_renderOverlay(e){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._dispatchAnimationUpdate(e),this._drawOverlays(pu.UPDATE,this.view.state)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;null!=e&&null!=t?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new Bc(-20037508.342787,20037508.342787):new Bc(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,zs)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&null!=e.setDrapingExtent&&null!=this._spatialReference&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,pu.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return ko;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,JC),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,JC.stretch);const s=this._updateOverlay(Bs.INNER,JC.inner,r,1*JC.pixelRatioAdjustment,JC.mapUnitsPerPixel),n=ze(JC.inner)/ze(JC.outer),a=this._updateOverlay(Bs.OUTER,JC.outer,r,n*JC.pixelRatioAdjustment,JC.mapUnitsPerPixel);s!==rT.EXTENT&&a!==rT.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(i)),s===rT.NONE&&a===rT.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,s=Math.ceil(1.5*Math.max(i,r));return Math.min(Kr(s),this._maxResolution)}_updateOverlay(e,t,i,r,s){if(0===this.renderer.overlays.length)return rT.NONE;const n=this.renderer.overlays[e],a=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,function(e,t){const i=Th.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}(t,n.extent)&&i===n.resolution)return a===s?rT.NONE:rT.RERENDER_ONLY;Xe(n.extent,t),n.resolution=i;const o=Ze(n.extent);return n.renderLocalOrigin=Hs(o[0],o[1],0,"OV_"+this._latestOriginId++),rT.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Bs.INNER],r=this.renderer.overlays[Bs.OUTER],s=e.extent;this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,Bs.INNER,t),this._setTileOverlayData(s,Bs.OUTER,t)):(this._clearTileOverlayData(Bs.INNER,t),this._clearTileOverlayData(Bs.OUTER,t))}else this._clearTileOverlayData(Bs.INNER,t),this._clearTileOverlayData(Bs.OUTER,t)}overlayPixelSizeInMapUnits(e,t){if(0===this.renderer.overlays.length)return t();const i=this.renderer.overlays[Bs.INNER],r=this.renderer.overlays[Bs.OUTER],s=this._pointIsInExtent(e,i.extent)?i:r;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=ze(r),n=Be(r);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(r[0],a);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);a>t&&(a=t-(e[2]-e[0]))}i.setScale(t,ze(e)/s,Be(e)/n),i.setOffset(t,(a-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){$C(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(qo)}_dispatchAnimationUpdate(e){const t=$(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||null!=this.view.state.forcedAnimationTime||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=$(t/this.surface.view._stage.renderer.animationTimeDilation),r=new Dn(this.view.state.camera,i,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(r)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,iT,t,i);if(null==s)return!1;const n=s.origin,a=vi(KC,s.origin,s.direction);return this._groundIntersector.reset(n,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,a),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,o=Ft(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+a,e.aboveGround?s-a:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=KC;_l(gl(fl,Gt(this.view.spatialReference).radius+o),Cl(e.eye,e.viewForward),t),Pi(t,t,e.eye);const s=zc.normalize(jl(e.viewForward,t,e.viewRight))/e.fovY+.5,n=s<=0||s>=1?.5:r;i=l?n*s:s+n*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),n=rr(0,s,1,0),a=Qi(n,n,e.projectionMatrix)[1],o=Ft(.5+.5*a,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&Fi(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=we();this._findHorizonBasedPointOfInterest(e,s)||Ti(s,r),Th.OVERLAY_SHOW_CENTER?(null==XC&&(XC=new lC(this.view.graphics,"red")),XC.show(s,this._renderSR)):null!=XC&&XC.hide();const n=Math.max(.1,xi(e.eye,s)),a=Ng(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||Wd(s,this._renderSR,s,this._spatialReference);const o=this.surface.extent,l=!this._isSpherical&&this._spatialReference&&this._spatialReference.isGeographic,c=l&&this._spatialReference?1/Gt(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,d=e.perScreenPixelRatio/h*n*c;i.mapUnitsPerPixel=d/this._worldToPCSRatio,i.stretch=this._overlayStretch;let u=t*d/2*i.stretch,p=!1,m=l?90:1/0;this._isSpherical&&o&&this._spatialReference&&(this._spatialReference.isWebMercator?(u/=Math.cos(uu(s[1])),m=o[3]):(p=!0,u/=Gt(this._spatialReference).metersPerDegree,m=90),u>=m&&(u=m,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let _=1;p&&(_=1/Math.max(.2,Math.cos(Math.abs(Vt(s[1])))),u*_>180&&(_=180/u),i.mapUnitsPerPixel*=_);const g=Math.log(2)/12;u=Math.exp(Math.round(Math.log(u)/g)*g);const f=u*_,y=.5*t/(32*f),v=.5*t/(32*u);s[0]=Math.round(s[0]*y)/y,s[1]=Math.round(s[1]*v)/v;const x=i.inner;x[0]=s[0]-f,x[1]=s[1]-u,x[2]=s[0]+f,x[3]=s[1]+u,this._isSpherical&&this._shiftExtentToFitBounds(x,1/0,m);const w=i.outer;if(6*f>ze(o))Xe(w,o);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)w[0]=x[0]-f,w[1]=x[1]-u,w[2]=x[2]+f,w[3]=x[3]+u;else{Wd(e.eye,this._renderSR,KC,this._spatialReference),Wi(ZC,s,KC);let t=-Math.atan2(ZC[1],ZC[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));Xi(ZC,QC[i],2*u),ZC[0]*=_,ZC[2]*=_,Yi(w,x,ZC)}if(this._isSpherical)w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-m),w[3]=Math.min(w[3],m);else{const e=tt(x,o,eT),t=tt(w,o,tT);it(e,t)&&(w[2]=w[0],w[3]=w[1])}const b=Math.abs(x[2]-x[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,b),i.pixelRatioAdjustment=i.mapUnitsPerPixel/b}_drawOverlays(e,t){if(!this.renderer.hasOverlays)return;if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;const i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;const r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.surface.updateTileOverlayParams(pu.UPDATE),i?(this.surface.requestRender(e),e===pu.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(pu.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return null!=e&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Ge(e,t))}_rectInsideRect(e,t){return null!=t&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:it(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),qe(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask(qo)}}};e([ae()],YC.prototype,"_spatialReference",void 0),e([ae({readOnly:!0})],YC.prototype,"running",null),e([ae()],YC.prototype,"_placementDirty",void 0),e([ae()],YC.prototype,"_contentUpdated",void 0),e([ae()],YC.prototype,"_isSpherical",null),e([ae()],YC.prototype,"_worldToPCSRatio",null),e([ae()],YC.prototype,"renderer",void 0),e([ae({constructOnly:!0})],YC.prototype,"view",void 0),e([ae({constructOnly:!0})],YC.prototype,"surface",void 0),e([ae()],YC.prototype,"suspended",null),e([ae()],YC.prototype,"updating",null),e([ae({type:Boolean})],YC.prototype,"rendersOccludedDraped",null),YC=e([le("esri.views.3d.terrain.OverlayManager")],YC);const ZC=tr(),KC=we(),JC=new class{constructor(){this.inner=je(),this.outer=je(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=1.3}},eT=je(),tT=je(),iT=Sl();var rT;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(rT||(rT={}));class sT{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=vu(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=L(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,vu(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(e){return this.outerEdgesOffsetAndLength[2*e]}getEdgeCount(e){return this.outerEdgesOffsetAndLength[2*e+1]}getEdgeVertexIndex(e,t){return this.getEdgeAttributeIndex(e,t)}getEdgeVertexPosition(e,t,i,r){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(e,r),t),vi(t,t,i)}getEdgeNormal(e,t,i){const{typedBuffer:r,typedBufferStride:s}=this.vertexAttributes.normalCompressed;Tu(t,r,this.getEdgeAttributeIndex(e,i),s)}setEdgeNormalFromValues(e,t,i,r,s){this._setNormal(this.getEdgeAttributeIndex(e,t),i,r,s)}setEdgeVertexFromValuesRawPositionUV(e,t,i,r,s,n,a){const o=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(o,i,r,s),this._setUV(o,n,a)}setEdgeVertexFromValuesRawPositionUVNormal(e,t,i,r,s,n,a,o,l,c){const h=this.getEdgeAttributeIndex(e,t);this.vertexAttributes.position.setValues(h,i,r,s),this._setUV(h,n,a),this._setNormal(h,o,l,c)}_getEdgeVertexRaw(e,t){this.vertexAttributes.position.getVec(e,t)}_setNormal(e,t,i,r){const{typedBuffer:s,typedBufferStride:n}=this.vertexAttributes.normalCompressed;Pu(s,e,t,i,r,n)}_setUV(e,t,i){aT(this.vertexAttributes.uv0,e,t,i)}getEdgeAttributeIndex(e,t){return Yh(0<=t&&t<this.getEdgeCount(e)),this.getEdgeFirstVertexIndex(e)+t}}const nT=16384;function aT(e,t,i,r){e.setValues(t,i*nT,r*nT)}class oT{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}}class lT{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=D(this._current),this._next=D(this._next),this._waiting=D(this._waiting),this._delayed=D(this._delayed)}get current(){if(null==this._current)return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=lT.test.fadeMoment;if(null!=this._delayed&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,cT.Immediate),this._delayed=null)),null!=this._next){e=e||performance.now();const t=this._fadeDuration,i=null!=this._current&&this._next.texture===this._current.texture,r=this._next.type!==Gs.FADING,s=e-this._fadeStart>=t;(i||r||s)&&(D(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(null==this._next)return 1;const e=lT.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return null!=this._next||null!=this._delayed}push(e,t=cT.Immediate){this._delayed=D(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),null==this._current)return void(this._current=e);const i=lT.test.fadeMoment||performance.now();return t!==cT.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):null==this._next?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(null!=e&&(D(this._waiting),this._waiting=e))}get _fadeDuration(){return null==this._waiting?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var cT;lT.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(cT||(cT={}));class hT{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,t){this._setUpsampleTile(e,t),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,Gs.FADING,t):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return null!=e?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=Zh(i),{minLevel:s,maxLevel:n}=i.dataLevelRange,a=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+a,l=this._scaleRangeEnabled?Pa:()=>!0;let c=this.tile;const h=c.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=null!=u?u.tile.level:-1,m=null!=u&&p-h>=a,_=r?.tilemapCache,g="vector-tile-3d"===i.type?i.schemaHelper:null;for(;c&&l(c,r,!1)&&c.level>=s;){const i=c.level,r=h-i,l=c.layerInfo[t][e];if(l.data&&r>=a){(!m||i>p)&&this._setUpsampleTile(c),l.dataInvalidated&&(d=c);break}const u=g?.getLevelRowColumn(c.lij)??c.lij;if("unavailable"!==_?.getAvailability(u[0],u[1],c.lij[2])&&i<=n&&!l.data&&!l.dataMissing&&((!d||c.level===s||i%nu==0||h-d.level<a)&&(d=c),r>=o))break;c=c.parent}if(null!=d&&h-d.level<a)if(u)d=null;else{const i=this._findAncestorWithData();null!=i&&(this._setUpsampleTile(i),d=i.layerInfo[t][e].dataInvalidated?i:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e,t){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,Gs.FADING,t)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const dT=new Error("Abstract method called on TileAgent"),uT=new class extends hT{get _desiredMinLevelDelta(){throw dT}get _progressiveLevelModulo(){throw dT}dispose(){}};class pT extends hT{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return au(this.tile.level)-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class mT extends hT{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return nu}}var _T,gT,fT;function yT(e){e.fragment.uniforms.add(new $r("u_colormap",(e=>e.u_colormap)),new Wr("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new Wr("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new Wr("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(Tn`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function vT(e){e.fragment.uniforms.add(new $r("u_transformGrid",(e=>e.u_transformGrid)),new Hr("u_transformSpacing",(e=>e.common.u_transformSpacing)),new Hr("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(Tn`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}!function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(_T||(_T={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(gT||(gT={}));class xT extends Pn{constructor(){super(...arguments),this.scale=1,this.offset=or}}function wT(e){e.attributes.add(Sn.POSITION,"vec2"),e.attributes.add(Sn.UV0,"vec2"),e.vertex.uniforms.add(new Wr("scale",(e=>e.scale))),e.vertex.uniforms.add(new Hr("offset",(e=>e.offset))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add(Tn`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}class bT extends xT{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function CT(e,t){e.include(vT),e.fragment.uniforms.add(new $r("u_image",(e=>e.u_image)),new Ga("u_flipY",(e=>e.common.u_flipY)),new Ga("u_applyTransform",(e=>e.common.u_applyTransform)));const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add(new Hr("u_srcImageSize",(e=>e.common.u_srcImageSize))),e.fragment.code.add(Tn`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(Tn`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(Tn`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}!function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(fT||(fT={}));const TT={normal:fT.Normal,average:fT.Average,lighten:fT.Lighten,lighter:fT.Lighter,screen:fT.Screen,plus:fT.Plus,"color-dodge":fT.ColorDodge,darken:fT.Darken,multiply:fT.Multiply,"color-burn":fT.ColorBurn,overlay:fT.Overlay,"soft-light":fT.SoftLight,"hard-light":fT.HardLight,"vivid-light":fT.VividLight,hue:fT.Hue,saturation:fT.Saturation,luminosity:fT.Luminosity,color:fT.Color,difference:fT.Difference,exclusion:fT.Exclusion,minus:fT.Minus,invert:fT.Invert,reflect:fT.Reflect,"destination-over":fT.DestinationOver,"destination-atop":fT.DestinationAtop,"destination-in":fT.DestinationIn,"destination-out":fT.DestinationOut,"source-atop":fT.SourceAtop,"source-in":fT.SourceIn,"source-out":fT.SourceOut,xor:fT.Xor};function PT(e){e.code.add(Tn`
    float lineFactorAtPosition(float value) {
      float pos = value * ${Tn.float(257)};
      if(pos < 0.5 || pos > ${Tn.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function ST(e,t){const i=t.blendMode;i!==fT.Normal&&(i===fT.Reflect&&e.code.add(Tn`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==fT.ColorDodge&&i!==fT.VividLight||e.code.add(Tn`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==fT.ColorBurn&&i!==fT.VividLight||e.code.add(Tn`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===fT.Overlay&&e.code.add(Tn`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===fT.HardLight&&e.code.add(Tn`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===fT.SoftLight&&e.code.add(Tn`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===fT.VividLight&&e.code.add(Tn`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==fT.Hue&&i!==fT.Saturation&&i!==fT.Color&&i!==fT.Luminosity||(e.code.add(Tn`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==fT.Hue&&i!==fT.Saturation||e.code.add(Tn`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(Tn`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===fT.Multiply?Tn`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Average?Tn`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Lighten?Tn`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Darken?Tn`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Lighter?Tn`return vec4(cl * ol + cb * ob, ol + ob);`:i===fT.Plus?Tn`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===fT.Minus?Tn`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===fT.Screen?Tn`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Difference?Tn`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Invert?Tn`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===fT.DestinationOver?Tn`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===fT.DestinationAtop?Tn`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===fT.DestinationOut?Tn`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===fT.SourceAtop?Tn`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===fT.SourceOut?Tn`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===fT.Xor?Tn`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===fT.DestinationIn?Tn`return vec4(cb * ob * ol, ol * ob);`:i===fT.SourceIn?Tn`return vec4(cl * ol * ob, ol * ob);`:i===fT.Hue?Tn`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Saturation?Tn`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Color?Tn`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Luminosity?Tn`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Exclusion?Tn`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Reflect?Tn`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.ColorDodge?Tn`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.ColorBurn?Tn`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.Overlay?Tn`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.SoftLight?Tn`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.HardLight?Tn`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===fT.VividLight?Tn`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:Tn``}
    }
  `))}var RT,OT,ET;function AT(e,t){const i=t.output===RT.GridComposite,r=t.output===RT.ColorComposite,s=t.output===RT.GroupBackgroundComposite,n=t.output===RT.Composite;i&&e.fragment.include(PT),r&&e.fragment.uniforms.add(new Br("backgroundColor",(e=>e.backgroundColor)));const a=t.baseOpacityMode===OT.Required;a&&e.fragment.uniforms.add(new Wr("baseOpacity",(e=>e.baseOpacity))),n&&e.fragment.uniforms.add(new $r("fboColor",(e=>e.fboTexture)));const o=t.blendMode!==fT.Normal,l=t.premultipliedSource===ET.On;e.fragment.include(ST,t),e.fragment.code.add(Tn`
    vec4 getBackground(vec2 uv) {
      return ${a?Tn`baseOpacity *`:""} ${s?Tn`vec4(0.0, 0.0, 0.0, 0.0)`:r?Tn`vec4(backgroundColor, 1.0)`:i?Tn`vec4(gridColor(uv), 1.0)`:Tn`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${o?Tn`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:Tn`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(n&&!a||s)?Tn`colorLayer * opacity;`:Tn`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}!function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(RT||(RT={})),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(OT||(OT={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(ET||(ET={}));class MT extends bT{constructor(e,t,i,r,s,n){super(e,r,s),this.colormap=t,this.symbolizer=i,this.u_colormap=n,this.backgroundColor=Re,this.fboTexture=null,this.baseOpacity=1}}const DT=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:class extends MT{},ColorizerStretchUniforms:class extends MT{},ColorizerUniforms:MT,build:function(e){const t=new qr;return t.include(wT),t.include(CT,e),t.include(yT,e),t.include(AT,e),t.fragment.code.add(Tn`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),e.colorizerType===_T.Stretch?function(e,t){e.fragment.uniforms.add(new Dr("u_bandCount",(e=>e.symbolizer.u_bandCount)),new os("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new os("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new os("u_factor",(e=>e.symbolizer.u_factor),3),new Wr("u_minOutput",(e=>e.symbolizer.u_minOutput)),new Wr("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new Ga("u_useGamma",(e=>e.symbolizer.u_useGamma)),new os("u_gamma",(e=>e.symbolizer.u_gamma),3),new os("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new Wr("u_opacity",(e=>e.common.u_opacity))),e.fragment.code.add(Tn`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?Tn`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:Tn`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.code.add(Tn`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===gT.Noop?Tn`
        fragColor = applyBackgroundBlend(currentPixel);`:Tn`
        if (currentPixel.a == 0.0) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}(t,e):e.colorizerType===_T.Lut?function(e){e.fragment.code.add(Tn`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}(t):e.colorizerType===_T.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add(new $r("u_image",(e=>e.u_image)),new Dr("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new os("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new os("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new os("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new os("u_weights",(e=>e.symbolizer.u_weights),6),new Hr("u_factor",(e=>e.symbolizer.u_factor)),new Wr("u_minValue",(e=>e.symbolizer.u_minValue)),new Wr("u_maxValue",(e=>e.symbolizer.u_maxValue)),new Hr("u_srcImageSize",(e=>e.common.u_srcImageSize))),i.include(Jr),i.code.add(Tn`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(Tn`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?Tn`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:Tn`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.code.add(Tn`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}(t,e),t}},Symbol.toStringTag,{value:"Module"})),IT={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class LT{constructor(e,t,i=null,r=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=N(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...IT,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||IT}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){null!=e&&e.length>0?this._bandIds&&e.every(((e,t)=>!!this._bandIds?.[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,null!=this._rasterTexture){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?Wn.LINEAR:Wn.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=N(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((null==this._rasterTexture||this._dirty)&&this._updateRasterTexture(e,this.bandIds),null!=this._rasterTexture&&(this._updateColormapTexture(e),this.transformGrid&&null==this._transformGridTexture&&(this._transformGridTexture=Ru(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:r,opacity:s}=this,n=Ou(t,[i,r],[this.source.width,this.source.height],s),a=Eu(e.colormap,e.colormapOffset),o="stretch"===this.symbolizerParameters.type?Au(this.symbolizerParameters):null,l="hillshade"===this.symbolizerParameters.type?Mu(this.symbolizerParameters):null;return new MT(n,a,o||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return"bilinear"===this.interpolation&&null!=e.colormap&&"stretch"===e.type}get memoryUsage(){if(null==this._memoryUsed){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((e=>null!=e?e.descriptor.width*e.descriptor.height*4:0)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=N(this._rasterTexture),this._transformGridTexture=N(this._transformGridTexture),this._colormapTexture=N(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=N(this._rasterTexture));const r=null==t&&null==this.bandIds||null!=t&&null!=this.bandIds&&t.join("")===this.bandIds.join("");if(null!=this._rasterTexture&&r)return;this._rasterTexture=N(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Du(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture=N(this._colormapTexture),this._colormapTexture=Iu(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=Iu(e,i),void(this._colormap=i)):(this._colormapTexture=N(this._colormapTexture),void(this._colormap=null))}}class NT{constructor(){this.waitingAgents=new Y,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=FT.acquire();return t._init(e),t}release(){this.dispose(),VT.delete(this),FT.release(this)}dispose(){this.loadingAgent=N(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Kh(this._data)}static prune(){FT.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Kh(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=I(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){null!=this._upsampleInfo&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e!==t&&null!=t){if(null==this._upsampleInfo)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),Sa(e,t,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){Kh(this._data),this._data=e}}const FT=new _e(NT,null,(()=>{})),VT=new Map;class UT{constructor(e,t){this._texture=e,this._cache=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){if(--this._refCount,0===this._refCount)if(this._cache){const e=`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`;this._cache.put(e,this)}else this.dispose()}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get usedMemory(){return this._texture.usedMemory}}var jT;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"}(jT||(jT={}));class kT{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=je(),this._elevationBounds=nr(),this.layerInfo=[[],[]],this.extentInRadians=je(),this.centerAtSeaLevel=we(),this._center=[we(),vl(),we()],this.up=Oe(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=we(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}static prune(){BT.prune(0),HT.prune(0),NT.prune()}get _isCached(){return!this.isLeaf&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[WT.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??Jh.INTERSECTS;this._frustumVisibility=t===Jh.INSIDE?Jh.INSIDE:t===Jh.OUTSIDE?Jh.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const i=this._frustumVisibility!==Jh.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}init(e,t,i,r,s){this._lij[0]=e,this._lij[1]=t,this._lij[2]=i,this.ellipsoid=Gt(s.tilingScheme.spatialReference),s.tilingScheme.getExtent(e,t,i,this.extent),s.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,s.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[WT.MIDDLE][3]=0,this.elevationLevel=e,r&&r.elevationBounds?Bi(this._elevationBounds,r.elevationBounds):zi(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=s,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(const e of Hb){const t=s.numLayers(e),i=this.layerInfo[e];for(const e of i)e.release();i.length=t;for(let r=0;r<t;r++)i[r]=NT.acquire(this._surface.upsampleInfoPool),e===Bb.ELEVATION&&this.findElevationBoundsForLayer(r,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(s.tilingScheme.pixelSize,su)}dispose(){ed(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of Hb){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[Bb.MAP].reduce(((e,t)=>e+(t instanceof Zd?t.usedMemory/t.referenced:0)),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(null!=this._usedMemory)return this._usedMemory;this._usedMemory=this._baseUsedMemory,this._mapTileMemoryInternal=0;let e=0;for(const{data:t}of this.layerInfo[Bb.MAP])t instanceof Zd?e+=this._getTerrainDataMemory(t):this._mapTileMemoryInternal+=this._getTerrainDataMemory(t);const t=this._cpuImageMemorySize;for(const e of this.layerInfo[Bb.ELEVATION])this._usedMemory+=e.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=this.renderData.texture?.usedMemory??0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===Bb.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===Bb.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof UT?e.texture.usedMemory:e instanceof HTMLImageElement||e instanceof td?this._cpuImageMemorySize:e instanceof LT?e.memoryUsage:e instanceof Zd?e.usedMemory/e.referenced:0}updateScreenDepth(e){const t=this._center[WT.MIDDLE],i=e,r=t[0],s=t[1],n=t[2],a=i[2]*r+i[6]*s+i[10]*n+i[14];this.screenDepth=a<0?0:a/(i[3]*r+i[7]*s+i[11]*n+i[15])}shouldSplit(e,t,i){if(!this.visible)return jT.NONE;if(e.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===Jh.OUTSIDE))return jT.NONE;const r=this.level;Pi(KT,yl(this._center[WT.MIDDLE]),t);let s=mi(KT),n=KT,a=yl(this._center[WT.MIDDLE]);Pi(JT,this._center[WT.TOP],t);const o=mi(JT);o<s&&(s=o,n=JT,a=this._center[WT.TOP]),Pi(eP,this._center[WT.BOTTOM],t);const l=mi(eP);if(l<s&&(s=l,n=eP,a=this._center[WT.BOTTOM]),this._edgeLen2>s&&r<e.maxLod)return jT.SPLIT;const c=Math.sqrt(s),h=e.fovX*c*2,d=this._edgeLen/h,u=()=>{if(r<e.maxLod)return this.elevationLevel=r,jT.NONE;const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/d));return t!==this.elevationLevel?(this.elevationLevel=t,jT.ELEVATION):jT.NONE},p=null!=i?i-r:1/0;if(p<=.5)return u();const m=gi(this.up,KT),_=this._elevationBounds[1]-this._elevationBounds[0],g=_/this.edgeLen;if(e.aboveGround&&m>0&&g<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-g>0)return jT.NONE;const f=null!=i?3-Math.min(p,2):1;if(d*f<e.relativeWidthLimit||r>=e.maxLod)return u();if(r<7)return jT.SPLIT;fi(tP,this.up,m),Pi(tP,tP,n);const y=mi(tP);if(y<=this.radius*this.radius)return jT.SPLIT;fi(tP,tP,this.radius/Math.sqrt(y)),vi(tP,tP,a),Pi(tP,t,tP);const v=Math.min(1,(Math.abs(gi(tP,this.up))+.5*_+this._curvatureHeight)/pi(tP)),x=.1/e.angledSplitBias,w=e.fovY*c*2;return v*(this._edgeLen/w*f)<x*e.relativeHeightLimit?jT.NONE:jT.SPLIT}setChildren(e,t,i,r){ed(!!(e&&t&&i&&r),"Null child passed");const s=this._children;return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of Hb)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const e of Hb){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==uT&&(zT(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(jT.GEOMETRY),this.resetPendingUpdate(jT.TEXTURE_NOFADING),this.resetPendingUpdate(jT.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[Bb.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==uT&&(zT(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Je(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;null!=e?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(jT.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i?.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of Hb){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==uT&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(jT.SPLIT)||e!==Bb.ELEVATION&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){const t=this._pendingUpdates;return this._pendingUpdates|=e,e===jT.SPLIT||e===jT.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),t!==this._pendingUpdates}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),i.tile.lij.toString(),t,e);const s=r.data&&"type"in r.data&&"vector-tile"===r.data.type;return i.dataArrived(this,s),!0}if(r.requestPromise)return!0;I(r.requestAbort),r.requestAbort=new AbortController;const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const n=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(n,n),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this._lij[0]===e[0]&&this._lij[1]===e[1]&&this._lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return mi(Pi(tP,yl(this._center[WT.MIDDLE]),e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,n=null!=s.removeUnordered(i);ed(n,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=null!=i&&"type"in i&&"vector-tile"===i.type,s=this.layerInfo[t][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll((e=>e.dataArrived(this,r))),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this._lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t,i){switch(i&&this.forEachLoadedNeighbor((i=>i.updateRenderData(e,t))),e){case Bb.MAP:return this._updateTexture(t);case Bb.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===Gs.FADING?jT.TEXTURE_NOFADING:jT.TEXTURE_FADING),this.setPendingUpdate(e===Gs.FADING?jT.TEXTURE_FADING:jT.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(jT.GEOMETRY);for(const e of this.layerInfo[Bb.ELEVATION])e.pendingUpdates|=jT.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBounds,t=e[0],i=e[1];zi(e,1/0,-1/0);const r=this.layerInfo[Bb.ELEVATION];let s=!0;for(const t of r)null!=t.elevationBounds&&(e[0]=Math.min(e[0],t.elevationBounds.min),e[1]=Math.max(e[1],t.elevationBounds.max),t.elevationBounds.hasNoDataValues||(s=!1));s&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),t===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,t=.5*(e[0]+e[1]),i=this._center;fi(tP,this.up,t),vi(yl(i[WT.MIDDLE]),this.centerAtSeaLevel,tP),fi(tP,this.up,e[0]),vi(i[WT.TOP],this.centerAtSeaLevel,tP),fi(tP,this.up,e[1]),vi(i[WT.BOTTOM],this.centerAtSeaLevel,tP)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[Bb.ELEVATION][e],r=au(this.level),s=Math.max(this.elevationLevel-r,0),n=i.elevationBounds;if(null!=n&&n.level>=t&&n.level<=s)return;const a=this._surface.layerViewByIndex(e,Bb.ELEVATION),o=Zh(a);if(!Pa(this,o,!1))return;const l=GT;let c=!1;const h=i.data;if(h&&h.level<=s){const e=i.data;l.min=e.samplerData.data.minValue,l.max=e.samplerData.data.maxValue,l.hasNoDataValues=e.samplerData.data.hasNoDataValues,l.level=this.level,c=!0}else{let t,i,n=0;for(let a=this._parent;a&&(!i||n<r)&&(n=this.elevationLevel-a.level,t=i||t,i=a.layerInfo[Bb.ELEVATION][e].data,!(!i&&t&&a.level<=s));a=a.parent);i=i||t,i&&(i.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=i.level,c=!0))}c&&(null==i.elevationBounds&&(i.elevationBounds=new jC),i.elevationBounds.copyFrom(l))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==uT&&(zT(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),n=t.length;r.length=n;for(let e=0;e<n;e++){const i=t[e];r[e]=i>-1?s[i]:NT.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,Gs.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===uT&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of Hb){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==uT&&(i.loadingAgent.setSuspension(t),i.loadingAgent===uT&&this.updateRenderData(e,Gs.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==uT&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=uT,i.data||null!=i.upsampleInfo||this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||xt(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const e=this._surface.layerViewByIndex(r,i);if(id(e)&&"normal"!==e?.layer?.blendMode||xt(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=this._isSuspended(t);for(let s=e;s<i.length;++s){const n=i[s];let a=!1;const o=this._surface.layerViewByIndex(s,t),l=Zh(o);if(n.loadingAgent?Pa(this,l,!1)?(n.loadingAgent!==uT&&n.loadingAgent.setSuspension(r),n.loadingAgent!==uT&&(a=n.loadingAgent.update())):n.dispose():Pa(this,l,!1)&&(n.loadingAgent=qT(this,s,t,r),a=n.loadingAgent.startLoading(),a?n.loadingAgent===uT&&this.setPendingUpdate(jT.GEOMETRY):(zT(n.loadingAgent),n.loadingAgent=uT)),n.loadingAgent===uT&&this.updateRenderData(t,Gs.FADING),!this._hasBlendModes(e,i.length,t)&&a&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,au(this.level)-t),r=Ft(1+(this.maxTesselation>>i),2,this.maxTesselation+1),s=this.getDefaultVerticesPerSide();return Math.max(r,s)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(null!=i)for(const r of i)if($T(r,e)){let i=r,s=e[0]-i.level-1;for(;s>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>s&1,r=e[2]>>s&1;i=i.children[2*t+r],s--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this._lij,r=this.getNeighborLIJ(i,e);return r?QT(i,r)?t(this)?this:null:this._findLIJ(r,t):null}findCorner(e,t){const i=e===rd.NORTH_EAST?1:e===rd.NORTH_WEST?0:e===rd.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner(sd(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===rd.NORTH?[0,1]:e===rd.NORTH_EAST?[1]:e===rd.EAST?[1,3]:e===rd.SOUTH_EAST?[3]:e===rd.SOUTH?[2,3]:e===rd.SOUTH_WEST?[2]:e===rd.WEST?[0,2]:[0],r=e=>{const s=e.children;!t(e)&&s[0]&&i.forEach((e=>r(s[e])))};r(this)}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if(Yh(!nd||i>=0),0===i)return 0;const r=2**i,s=1==(1&e),n=s?0:1,a=t.lij[n+1]*r,o=this._lij[n+1],l=o-a,c=s?r-1-l:l;return nd&&(Yh(a<=o&&o<a+r),Yh(0<=c&&c<r)),c}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.isLoaded;ad.forEach((t=>{const r=this.findNeighborTile(t,i);null!=r&&r!==this&&r.forAllSubtreeOnSide(od(t),(i=>!!i.isLoaded&&(e(i,t),!0)))})),ld.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner(sd(t),(e=>e.isLoaded));Yh(!r||XT(this,r,t)),r?.isLoaded&&e(r,t)}))}getNeighborLIJ(e,t){const i=cd(t)?-1:hd(t)?1:0,r=dd(t)?-1:ud(t)?1:0,s=[e[0],e[1]+i,e[2]+r];return s[1]<0?null:this.surface.isGlobal?this.wrapLIJ(s):s[2]<0?null:s}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return 0===this._lij[2]}get isNorthEnd(){return 0===this._lij[1]}get isSouthEnd(){const e=this.surface.extent,t=e?.[1]??null;return null!=t&&this.extent[1]+Su()>=t}checkGeometryWaterproofness(){pd&&(Yh(this.isLoaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(cd(e)&&t[3]+r>=i[3])return!1;if(hd(e)&&t[1]-r<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&dd(e)&&t[0]-r<=i[0]||!s&&ud(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;Ti(this._lastPOI,e);const i=this._center[WT.MIDDLE],r=e[0]-i[0],s=e[1]-i[1],n=e[2]-i[2];this.distanceToPOI=r*r+s*s+n*n}}function qT(e,t,i,r){const s=i===Bb.ELEVATION?HT.acquire():BT.acquire();return s.init(e,t,i,r),s}function zT(e){e.dispose(),e instanceof pT?HT.release(e):e instanceof mT&&BT.release(e)}const BT=new _e(mT),HT=new _e(pT),GT=new jC;var WT;function $T(e,t){const i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function QT(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function XT(e,t,i){return null!=e&&null!=t&&t!==e&&(e.level>=t.level?YT(e,t,i):YT(t,e,sd(i)))}function YT(e,t,i){Yh(e.level>=t.level);const r=md(i),s=_d(i),n=e.extent,a=t.extent,o=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?a[2]:a[0],s?a[1]:a[3]],c=1e-5*(n[2]-n[0]),h=gd(o[0],l[0],c)||e.surface.isGlobal&&gd(o[0],-l[0],c),d=gd(o[1],l[1],c);if(h&&d)return!0;if(e.level===t.level)return Yh(!1),!1;if(!h&&!d)return Yh(!1),!1;const u=h?ZT(a[1],a[3],n[1],n[3],c):ZT(a[0],a[2],n[0],n[2],c);return Yh(u),u}function ZT(e,t,i,r,s){return e-s<=i&&i<=r&&r<=t+s}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(WT||(WT={}));const KT=we(),JT=we(),eP=we(),tP=we();class iP{constructor(){this._scales=rr(-1,-1,-1,-1),this._offsets=rr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}function rP(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(Tn`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(Tn`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(Tn`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}var sP;!function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(sP||(sP={}));class nP extends io{constructor(){super(...arguments),this.overlayOpacity=1}}function aP(e,t){const{vertex:i,fragment:r,varyings:s}=e;s.add("vtc","vec2"),i.uniforms.add(new cP("texOffsetAndScale")),r.uniforms.add(new hP("tex")),r.uniforms.add(new lP("textureOpacities"));const n=t.textureFadingEnabled&&!t.renderOccluded;n&&(i.uniforms.add(new cP("nextTexOffsetAndScale")),s.add("nvtc","vec2"),r.uniforms.add(new hP("texNext")),r.uniforms.add(new lP("nextTexOpacities")),r.uniforms.add(new oP("fadeFactor")));const a=t.tileBlendInput===sP.ColorComposite,o=t.tileBlendInput===sP.GridComposite;o&&r.include(PT),a&&r.uniforms.add(new lP("backgroundColor")),i.code.add(Tn`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?Tn`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:Tn``}
  }`),r.code.add(Tn`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||a?Tn`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${a?Tn`backgroundColor`:Tn`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:Tn`return color;`}
    }`),n?r.code.add(Tn`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(Tn`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class oP extends ls{constructor(e){super(e,"float")}}class lP extends ls{constructor(e){super(e,"vec3")}}class cP extends ls{constructor(e){super(e,"vec4")}}class hP extends ls{constructor(e){super(e,"sampler2D")}}class dP extends nP{}const uP=wr(),pP=we(),mP=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:dP,build:function(e){const t=new qr,{vertex:i,fragment:r,varyings:s}=t;t.include(cs),t.include(Ir,e),t.include(Tr,e);const n=()=>{t.include(Wl,e),i.code.add(Tn`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};hs(i,e),t.include(Go,e);const a=e.overlayMode!==Ws.Disabled,o=a&&e.invisible;switch(e.output){case ds.Color:{t.include(aP,e),t.include(ro,e),a&&t.include($s,{...e,pbrMode:e.pbrMode===Rr.Simplified?Rr.TerrainWithWater:Rr.Water});const o=e.overlayMode===Ws.EnabledWithWater;o&&t.include(rP,e),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),n(),e.screenSizePerspective&&us(i);const l=e.receiveShadows&&!e.renderOccluded;l&&t.include(gs,e),e.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),i.code.add(Tn`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${o?Tn`forwardVertexTangent(vnormal);`:Tn``}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${a?Tn`setOverlayVTC(uv);`:""}
          ${e.tileBorders?Tn`forwardTextureCoordinates();`:""}

          ${e.screenSizePerspective?Tn`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${l?Tn`forwardLinearDepth();`:""}

        }
      `),t.include(fs,e),t.include(ro,e),t.include(so,e),t.include(no,e),ys(r,e),ao(r),oo(r),r.uniforms.add(i.uniforms.get("localOrigin"),new Br("viewDirection",((e,t)=>_i(pP,ui(pP,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))))),o&&r.uniforms.add(new $r("ovWaterTex",((e,t)=>t.overlay?.getTexture(Qs.WaterNormal))),new vs("view",((e,t)=>fr(uP,t.camera.viewMatrix,e.origin)))),r.code.add(Tn`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),Sr(r),Lr(r),r.code.add(Tn`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${a?Tn`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${e.invisible?Tn`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${e.pbrMode===Rr.Simplified||e.pbrMode===Rr.TerrainWithWater?Tn`fragColor = vec4(evaluatePBRSimplifiedLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:Tn`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${o?Tn`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${e.screenSizePerspective?Tn`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${e.visualizeNormals?e.spherical?Tn`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:Tn`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${e.tileBorders?Tn`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          fragColor = highlightSlice(fragColor, vpos);
        }
      `)}break;case ds.LinearDepth:o&&t.include($s,e),t.include(ps,e),ms(t),_s(t),i.code.add(Tn`
              void main(void) {
                ${o?Tn`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),r.code.add(Tn`
              void main() {
                ${o?Tn`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case ds.Shadow:case ds.ShadowHighlight:case ds.ShadowExcludeHighlight:t.include(ps,e),ms(t),_s(t),i.code.add(Tn`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(Tn`void main() {
outputDepth(linearDepth);
}`);break;case ds.Normal:o&&t.include($s,e),s.add("vnormal","vec3"),us(i),n(),i.code.add(Tn`
        void main(void) {
          ${o?Tn`setOverlayVTC(getUV0());`:""}
          gl_Position = transformPosition(proj, view, position);
          vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
        }
      `),r.code.add(Tn`
        void main() {
          ${o?Tn`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
          vec3 normal = normalize(vnormal);
          if (gl_FrontFacing == false) {
            normal = -normal;
          }
          fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
        }
      `);break;case ds.Highlight:a&&t.include($s,e),i.code.add(Tn`
          void main() {
            ${a?Tn`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),t.include(Wo,e),r.code.add(Tn`
          void main() {
            ${a?Tn`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return e.output===ds.ObjectAndLayerIdColor&&(a?(t.include($s,{...e,pbrMode:Rr.Disabled}),i.code.add(Tn`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),r.code.add(Tn`void main() {
fragColor = getOverlayColorTexel(vtcOverlay);
}`)):(i.code.add(Tn`void main(void) {}`),r.code.add(Tn`void main() {
fragColor = vec4(0.0);
}`))),t}},Symbol.toStringTag,{value:"Module"}));class _P extends Xr{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===Mt.Global}initializeProgram(e){return new Yr(e.rctx,_P.shader.get().build(this.configuration),gP)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,i=t.backfaceCullingEnabled&&!t.renderOccluded;return ea({blending:t.renderOccluded?ta(jn.ONE,jn.ONE_MINUS_SRC_ALPHA):null,culling:i?sa:null,depthTest:t.renderOccluded?null:{func:kn.LESS},depthWrite:t.renderOccluded?null:na,colorWrite:ia,stencilTest:e?xs(mu.IntegratedMeshMaskExcluded):null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}}_P.shader=new Zr(mP,(()=>Promise.resolve().then((()=>mP))));const gP=new Map([[Sn.POSITION,0],[Sn.UV0,1],[Sn.NORMALCOMPRESSED,2]]);class fP{constructor(){this.geometry=new sT,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureRef=new lT((()=>this.tile.surface.fadeDuration)),this.overlay=new iP,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(e,t){this.clear(),this._tile=e,this.geometry.reset(),this.intersectionData=null,this.geometryState=new oT,this._localOrigin=t,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),nd&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)Yh(this.geometry.getEdgeCount(e)===this.geometryState.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(null!=t&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const s=i.level,n=ad[e];if(!t)return Yh(null==i.surface?.rootTiles||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(n)),r;if(t.isLoaded){const i=t,n=i.renderData.geometryState,a=s-i.level;if(Yh(a>=0),0===a){const e=n.numVerticesPerSide-1;return Math.max(e,r)}const o=2**a,l=n.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}Yh(!t.isLeaf);let a=r;return t.forAllSubtreeOnSide(od(n),(e=>e===i||(e.isLoaded?(a=Math.max(a,2**(e.level-s)),!0):(Yh(!e.isLeaf),!1)))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState,i=t=>(t.isLoaded||t.level===e.level)&&t?.intersectsClippingArea,r=t.edgePeerNeighbors,s=t.edgePeerNeighborSamplerVersions;for(let n=0;n<4;++n){const a=e.findNeighborTile(ad[n],i),o=SP(e,a),l=o?.renderData?.geometryState.samplerDataVersion??-1,c=r[n],h=o!==SP(e,c),d=s[n]!==l;nd&&a&&(Yh(e.level>=a.level),Yh(e.level-a.level<=ou)),r[n]=a,(h||d)&&(s[n]=l,this._markEdgeDirty(n));const u=t.edgeResolutions[n],p=this._calculateEdgeResolution(n,a);Yh(Bt(p)),Yh(p>=1),t.edgeResolutions[n]=p,u!==p&&this._markEdgeResolutionDirty(n)}for(let s=0;s<4;++s){const n=e.findNeighborTile(ld[s],i);t.cornerPeerNeighbors[s]=n;const a=SP(e,r[s]),o=SP(e,r[(s+1)%4]),l=SP(e,n);PP[s]=l,PP[(s+1)%4]=o,PP[(s+2)%4]=e,PP[(s+3)%4]=a,Yh(PP.some((t=>t?.isLoaded||t===e)));const c=PP.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);PP.forEach(((e,t)=>{e&&e?.level>c&&(PP[t]=null)})),Yh(PP.some((t=>t?.isLoaded||t===e)));const h=t.cornerNeighborCornerTiles,d=t.cornerNeighborCornerTileSamplerVersions;for(let e=0;e<4;++e){const t=PP[e],i=t?.renderData.geometryState.samplerDataVersion??-1,r=4*s+e,n=h[r]!==t,a=!n&&d[r]!==i;(n||a)&&(h[r]=t,d[r]=i,this._markCornerDirty(s))}nd&&Yh(LP.some((t=>h[4*s+t]?.isLoaded||h[4*s+t]===e)))}nd&&Yh(this.geometryState.edgeResolutions.every((e=>e>0)));for(let e=0;e<4;++e)PP[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;nd&&Yh(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const{tile:t,_vao:i,geometry:r,geometryState:s}=this,n=!i||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=0!==this.dirtyEdgeResolutions,o=s.edgeResolutions.reduce(((e,t)=>e+t+1),0),l=n||a&&o>(r?.maxEdgeVertexCount??0),c=!l&&a,h=!c&&(0!==this.dirtyEdges||a),d=!h&&0!==this.dirtyCorners;l?(this.releaseGeometry(),this._createGeometry(e)):c?t.updateEdgeElevationsAndResolutions():h||d?t.updateEdgeElevations():d?t.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=N(this._vao),this.geometry.release(),!0)}ensureTexture(e,t,i){const r=t?$n.RGBA:$n.RGB;return null==this._texture||this._texture.descriptor.width===e&&this._texture.descriptor.pixelFormat===r||this.releaseTexture(),null==this._texture&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){null!=this._texture&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}get numVerticesPerSideChanged(){return 0!=(this._modifiedFlags&RP)}get samplerDataChanged(){return 0!=(this._modifiedFlags&OP)}get clippingAreaChanged(){return 0!=(this._modifiedFlags&EP)}get wireframeChanged(){return 0!=(this._modifiedFlags&AP)}get dirtyEdges(){return this._modifiedFlags>>MP&15}get dirtyCorners(){return this._modifiedFlags>>DP&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>IP&15}_markCornerDirty(e){const t=1<<e<<DP;this._modifiedFlags|=t}_markEdgeDirty(e){const t=1<<e<<MP;this._modifiedFlags|=t,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const t=1<<e<<IP;this._modifiedFlags|=t,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<DP|15<<MP|15<<IP}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),r=Math.max(i,5);let s=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(s=null);const n=this.geometryState;let a=!1;n.numVerticesPerSide!==r&&(this._modifiedFlags|=1,n.numVerticesPerSide=r,n.samplerDataVersion++,a=!0),e.changed&&(this._modifiedFlags|=2,n.samplerData=e.samplerData,n.samplerDataVersion++,a=!0),T(n.clippingArea,s)||(this._modifiedFlags=4,n.clippingArea=s,a=!0);const o=t.surface.wireframe;return n.wireframe!==o&&(this._modifiedFlags=8,n.wireframe=o,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometry.vertexAttributes,i=this.geometry.indices,r=e.gl;this._vao=new Ko(e,gP,{geometry:Xo(t.layout)},{geometry:el.createVertex(e,r.STATIC_DRAW,t.buffer)},el.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=cT.Immediate){null!=e&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[Bb.ELEVATION],i=t.length,r=new Array(i);let s=0,n=0,a=!1;for(let o=0;o<i;o++){const i=t[o];if(null!=i.upsampleInfo){const t=i.upsampleInfo.tile,l=t.layerInfo[Bb.ELEVATION][o].data,c=l&&l.samplerData;e&&e[s]===c||(a=!0),r[s++]=c,n=Math.max(n,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,Bb.ELEVATION);if(Pa(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(a=!0),r[s++]=t.samplerData,n=this.tile.level}}}null!=e&&e.length!==s&&(a=!0);const o=s>0,l=o?r:null;return o&&(r.length=s),{changed:a,samplerData:l,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){return{hasTexture:null!=this._texture}}checkGeometryWaterproofness(){if(!nd)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||0===e.level)return void Yh(e?.isLoaded);const t=e.surface.extent;if(null!=t&&!e.intersectsExtent(t))return;const i=ad.map(((i,r)=>null!=t&&(r<2?-1:1)*(e.extent[3-r]-t[3-r])<0)),r=e.level;Yh(0===this.dirtyCorners),Yh(0===this.dirtyEdges),Yh(0===this.dirtyEdgeResolutions),Yh(!this.numVerticesPerSideChanged),Yh(!this.samplerDataChanged),Yh(!this.clippingAreaChanged),Yh(!this.wireframeChanged);const s=ld.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.isLoaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),n=this.geometryState;for(let t=0;t<4;++t){const i=n.cornerPeerNeighbors[t],r=s[t];Yh(r===i,`Tile[${e.lij}].corner[${t}] out of date: cur=[${i?.lij}] exp=[${r?.lij}]`)}ad.forEach(((t,s)=>{if(i[s])return;const n=e.findNeighborTile(t,(e=>(e.level===r||e?.isLoaded)&&e?.intersectsClippingArea));if(!n){const i=!e.surface.updatingRootTiles&&null!=e.surface.rootTiles&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(t);return void Yh(!i)}Yh(n.isLoaded||n.level===e.level),Yh(n===this.geometryState.edgePeerNeighbors[s]);const a=r-n.level;if(!n.isLoaded)return Yh(!n.isLeaf),void Yh(0===a);const o=n.renderData;Yh(function(e,t,i){if(null==e||null==t)return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&i===rd.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&i===rd.WEST)return!0}const r=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(i){case rd.NORTH:return gd(e.extent[3],t.extent[1],r);case rd.SOUTH:return gd(e.extent[1],t.extent[3],r);case rd.EAST:return gd(e.extent[2],t.extent[0],r)||gd(e.extent[2],-t.extent[0],r);case rd.WEST:return gd(e.extent[0],t.extent[2],r)||gd(e.extent[0],-t.extent[2],r)}}(e,n,t)),Yh(a>=0);const l=2**a;if(a<0)return void Yh(!1);const c=e.renderData,h=c.geometry,d=c.localOrigin,u=h.getEdgeCount(s),p=h.numVerticesPerSide-1,m=o.geometry;if(!m)return void Yh(!1);const _=o.localOrigin,g=this.geometryState.edgePeerNeighbors[s];if(g?.isLoaded){const e=g.renderData;Yh(c.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion),Yh(this.geometryState.edgePeerNeighborSamplerVersions[s]===e.geometryState.samplerDataVersion)}const f=(s+2)%4,y=m.getEdgeCount(f),v=u-1,x=y-1;Yh(v*l===x,`Tile[${e.lij}]:e${s},res=${v} edgeRes mismatch with Neighbor[${n.lij}]:e${f},res=${x} (expected:${v*l})`);const w=e.extent,b=t===rd.NORTH||t===rd.SOUTH,C=y-1,T=C>>a,P=u-1;if(T<1)return void Yh(1===P);Yh(T===P),Yh(Bt(T));const S=m.numVerticesPerSide-1;Yh(a>0||T===Math.max(S,p));const R=e.getNeighborEdgeStartVertexIndex(s,n);Yh(0<=R&&R<l);const O=R*T;Yh(0<=O&&O<=C-T);let E=0,A=O;h.getEdgeVertexPosition(s,yP,d,0),h.getEdgeVertexPosition(s,vP,d,u-1);const M=xi(yP,vP),D=Math.max(TP,1e-4*M);for(let i=0;i<=T;++i){h.getEdgeVertexPosition(s,yP,d,E),m.getEdgeVertexPosition(f,vP,_,A);const r=i/T,a=b?w[0]+r*(w[2]-w[0]):t===rd.WEST?w[0]:w[2],l=b?t===rd.SOUTH?w[1]:w[3]:w[1]+r*(w[3]-w[1]),p=e.surface.extent;if(null==p||rt(p,a,l)){const t=Di(yP,vP),i=Ii(yP)-Ht.radius,r=Ii(vP)-Ht.radius,g=t<D;if(!g){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${s}[${E}/${u}] and [${n.lij}].edge${f}[${A}/${y}]`),null!=p&&console.warn("  surface extent= ",p," x,y=",a,",",l);const v=we();Pi(v,c.localOrigin,o.localOrigin),Ii(v)>0&&console.warn(`   localOrigins: ${c.localOrigin} vs ${o.localOrigin} d=${Ii(v)} [${v}]`),(()=>{const t=be(yP),i=be(vP);e.updateEdgeElevations(),n.updateEdgeElevations(),h.getEdgeVertexPosition(s,yP,d,E),m.getEdgeVertexPosition(f,vP,_,A);const r=we();Ci(r,yP,t),Ii(r)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${yP} d=${Ii(r)} [${r}]`),Ci(r,vP,i),Ii(r)>0&&console.warn(`  XXX Neighbor[${n.lij}] edge out of date: ${i} vs ${vP} d=${Ii(r)} [${r}]`)})();const x=h.getEdgeCount(s),w=m.getEdgeCount(y);Yh(g,`Mismatch in tile [${e.lij}].edge[${s}][${E}/${x}] vs neighbor [${n.lij}].edge[${f}][${A}/${w}] ${fd(yP)} vs ${fd(vP)}  dist=${t} h(t|n|d)=${i}|${r}|${r-i}`)}h.getEdgeNormal(s,xP,E),m.getEdgeNormal(f,wP,A),_i(bP,xP),_i(CP,wP);const v=gi(bP,CP),x=1-v<.01||e===n;if(!x){const t=we();Ci(t,xP,wP);const i=()=>`Mismatch in tile edge normal ${yd(e.lij)} (${E}/${u-1}) edge ${s} vs neighbor ${yd(n.lij)}  (${A}/${y-1}) nedge ${f} :${fd(xP)} vs ${fd(wP)}  dot = ${v} : ${fd(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),n.updateEdgeElevations();const t=we(),i=we();h.getEdgeNormal(s,t,E),m.getEdgeNormal(f,i,A),Ni(xP,t)||console.warn("Missing update in tile normal: ",fd(xP)," => ",fd(t)),Ni(wP,i)||console.warn("Missing update in neighbor normal: ",fd(wP)," => ",fd(i))}Yh(x,i())}}E+=1,A+=1}}))}}const yP=we(),vP=we(),xP=we(),wP=we(),bP=we(),CP=we(),TP=1,PP=[null,null,null,null];function SP(e,t){return t?.isLoaded||t===e?t:null}const RP=1,OP=2,EP=4,AP=8,MP=4,DP=8,IP=12,LP=[0,1,2,3];function NP(e){e.tile.intersectsClippingArea&&(VP(e),FP(e))}function FP(e,t=!1){const{geometry:i,geometryState:r,tile:s,localOrigin:n}=e,{level:a,extent:o,extentInRadians:l,ellipsoid:c}=s,h=c.radius,d=l[0],u=l[2],p=l[1],m=l[3],{samplerData:_}=r,g=o[0],f=o[2],y=o[1],v=o[3],x=jP(e),{boundingBox:w,vertexAttributes:b}=i,C=n[0],T=n[1],P=n[2],S=b.position,R=S.typedBuffer,O=S.typedBufferStride,E=b.uv0;for(let n=0;n<4;++n){const l=1===n||3===n,c=r.edgeResolutions[n];Yh(Bt(c));const b=c+1,S=SP(s,r.edgePeerNeighbors[n]);if(sS(s,S,n)){XP(e,n,S);continue}const A=null!=S;Yh(!A||S.level===s.level),Yh(!A||Ra(s,S)<=0);const M=S?.renderData,D=M?.geometryState;if(nd){const e=s.surface;if(!S&&e&&!e.updatingRootTiles){const t=ad[n],i=s.findNeighborTile(t,(e=>e.isLoaded||e.isLeaf||e.level===s.level));i?i.intersectsClippingArea&&(Yh(!i.isLoaded),Yh(!i.isLeaf),Yh(i.level===a)):Yh(null==e?.rootTiles||!s.shouldHaveNeighbor(t))}}const I=1===n?o[2]:o[0],L=S?.extent,N=L&&l?1===n?L[0]:L[2]:I,F=0===n?o[3]:o[1],V=1===n?1:0,U=0===n?1:0,j=1===n?u:d,k=0===n?m:p,q=Math.sin(j),z=Math.cos(j),B=Math.sin(k),H=Math.cos(k),G=D?.samplerData,W=A?(e,t,i)=>.5*(zC(e,t,_)+zC(i,t,G)):(e,t,i)=>zC(e,t,_),$=i.outerEdgesOffsetAndLength[2*n+0],Q=t&&b>3?b-3:1,X=null!=_&&_.some((e=>null!=e)),Y=null!=G&&G.some((e=>null!=e)),Z=X||Y,K=1/c,J=$;Yh(!L||gd(L[2]-L[0],o[2]-o[0])),(()=>{const e=1===n?-1:3===n?1:0,t=0===n?-1:2===n?1:0,r=(o[2]-o[0])*K,s=e*r,a=t*r,c=l?e*((u-d)*K):0,p=l?0:t*K,m=U,S=l?j+c:j,M=l?Math.sin(S):q,D=l?Math.cos(S):z,L=l?j-c:j,$=l?Math.sin(L):q,X=l?Math.cos(L):z,Y=l?k:x(m+p),ee=l?B:Math.sin(Y),te=l?H:Math.cos(Y),ie=l?k:x(m-p),re=l?B:Math.sin(ie),se=l?H:Math.cos(ie);let ne=0,ae=0,oe=0;{const e=0*K,t=l?I:g*(1-e)+f*e,i=l?N:t,r=l?y*(1-e)+v*e:F,s=l?j:d*(1-e)+u*e,n=l?q:Math.sin(s),a=l?z:Math.cos(s),o=l?x(e):k,c=l?Math.sin(o):B,p=l?Math.cos(o):H,m=h+W(t,r,i);ne=a*p*m,ae=n*p*m,oe=c*m}let le=0,ce=0,he=0;{const e=1*K,t=l?I:g*(1-e)+f*e,i=l?N:t,r=l?y*(1-e)+v*e:F,s=l?j:d*(1-e)+u*e,n=l?q:Math.sin(s),a=l?z:Math.cos(s),o=l?x(e):k,c=l?Math.sin(o):B,p=l?Math.cos(o):H,m=h+W(t,r,i);le=a*p*m,ce=n*p*m,he=c*m}for(let e=1;e<b-1;e+=Q){let t=0,r=0,o=0;{const i=(e+1)*K,s=l?I:g*(1-i)+f*i,n=l?N:s,a=l?y*(1-i)+v*i:F,c=l?j:d*(1-i)+u*i,p=l?q:Math.sin(c),m=l?z:Math.cos(c),_=l?x(i):k,w=l?Math.sin(_):B,b=l?Math.cos(_):H,C=h+W(s,a,n);t=m*b*C,r=p*b*C,o=w*C}const c=t,p=r,m=o,b=le,S=ce,L=he;le=c,ce=p,he=m;{const t=J+e,i=t*O,r=b-C,s=S-T,n=L-P;R[i]=r,R[i+1]=s,R[i+2]=n,oS(r,s,n,w);const a=e*K;aT(E,t,l?V:a,l?a:U)}const Q=ne,Y=ae,ie=oe;ne=b,ae=S,oe=L;const de=b,ue=S,pe=L,me=1/Math.sqrt(de*de+ue*ue+pe*pe),_e=pe*me;let ge=0,fe=0,ye=0;if(Z&&_e*_e<.999){let t=0,i=0,r=0;{const e=0===n?-1:1;t=e*(c-Q),i=e*(p-Y),r=e*(m-ie)}{const o=e*K,c=l?I:g*(1-o)+f*o,p=l?N:c,m=l?y*(1-o)+v*o:F,w=l?j:d*(1-o)+u*o,b=l?q:Math.sin(w),C=l?z:Math.cos(w),T=l?x(o):k,P=l?Math.sin(T):B,S=l?Math.cos(T):H;let R=de,O=ue,E=pe;if(A){const e=h+zC(p-s,m-a,G),t=l?S:se;R=(l?X:C)*t*e,O=(l?$:b)*t*e,E=(l?P:re)*e}{const e=h+zC(c+s,m+a,_),o=l?S:te,d=(l?D:C)*o*e,u=(l?M:b)*o*e,p=(l?P:ee)*e;A||(R=2*de-d,O=2*ue-u,E=2*pe-p);const g=3===n?-1:1,f=g*(R-d),y=g*(O-u),v=g*(E-p);ge=r*y-i*v,fe=t*v-r*f,ye=i*f-t*y;const x=1/Math.sqrt(ge*ge+fe*fe+ye*ye);ge*=x,fe*=x,ye*=x}}}else ge=de*me,fe=ue*me,ye=pe*me;i.setEdgeNormalFromValues(n,e,ge,fe,ye)}})()}}function VP(e){YP(e)}function UP(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function jP(e){const{tile:t}=e;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius,r=t=>function(e,t,i,r){return UP(e*(1-r)+t*r,i)}(e[1],e[3],i,t);return r}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function kP(e,t){e.tile.intersectsClippingArea&&(zP(e),qP(e,!1))}function qP(e,t){const{geometry:i,geometryState:r,tile:s,localOrigin:n}=e,{surface:a,extent:o}=s,{clippingArea:l,samplerData:c}=r,h=null!=l?l:iS,d=o[0],u=o[2],p=o[1],m=o[3],_=[m>h[3],u>h[2],p<h[1],d<h[0]],g=s.horizontalScale,f=BP(a.isWebMercatorOnPlateCarree,s.ellipsoid.radius,g),{minu:y,minv:v,maxu:x,maxv:w,boundingBox:b}=i,C=Math.max(d,h[0]),T=Math.min(u,h[2]),P=Math.max(p,h[1]),S=Math.min(m,h[3]),R=n[0],O=n[1],E=n[2];for(let n=0;n<4;++n){const o=1===n||3===n,l=r.edgeResolutions[n];Yh(Bt(l));const h=l+1,A=_[n],M=SP(s,r.edgePeerNeighbors[n]);if(!A&&sS(s,M,n)){XP(e,n,M);continue}const D=null!=M&&!A,I=M?.renderData,L=I?.geometryState;if(nd&&(Yh(!D||M.level===s.level),Yh(!D||Ra(s,M)<=0),s&&!M&&!a.updatingRootTiles)){const e=ad[n],t=s.findNeighborTile(e,(e=>e.isLoaded||e.isLeaf||e.level===s.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&(Yh(!t.isLoaded),Yh(!t.isLeaf),Yh(t.level===s.level)):Yh(null==a?.rootTiles||!s.shouldHaveNeighbor(e)))}const N=Ft(1===n?u:d,C,T),F=Ft(0===n?m:p,P,S),V=L?.samplerData,U=t&&h>3?h-3:1,j=Ft(1===n?1:0,y,x),k=Ft(0===n?1:0,v,w),q=D?(e,t)=>.5*(zC(e,t,V)+zC(e,t,c)):(e,t)=>zC(e,t,c),z=(u-d)/l,B=o?1===n?z:-z:0,H=o?0:0===n?z:-z,G=-B,W=-H;let $=0,Q=0,X=0;{const e=0/l,t=o?N:Ft(d*(1-e)+u*e,C,T),i=o?Ft(p*(1-e)+m*e,P,S):F,r=q(t,i);$=t*g,Q=f(i),X=r}let Y=0,Z=0,K=0;{const e=1/l,t=o?N:Ft(d*(1-e)+u*e,C,T),i=o?Ft(p*(1-e)+m*e,P,S):F,r=q(t,i);Y=t*g,Z=f(i),K=r}for(let e=1;e<h-1;e+=U){const t=e/l,r=Y,s=Z,a=K;{const l=o?j:Ft(t,y,x),c=o?Ft(t,v,w):k,h=r-R,d=s-O,u=a-E;oS(r,d,u,b),i.setEdgeVertexFromValuesRawPositionUV(n,e,h,d,u,l,c)}{const t=(e+1)/l,i=o?N:Ft(d*(1-t)+u*t,C,T),r=o?Ft(p*(1-t)+m*t,P,S):F,s=q(i,r);Y=i*g,Z=f(r),K=s}const h=Y,_=K,A=$,M=Q,I=X;$=r,Q=s,X=a;let L=0,U=0,z=0;if(o){const e=Z-s,i=_-a,o=M-s,l=I-a,h=Ft(p*(1-t)+m*t,P,S),d=N+G,u=d*g-r,f=zC(d,h,c)-a,y=3===n?-1:1;if(L=y*(-o+e)*f,U=y*u*(-l+i),z=-y*u*(-o+e),D){const t=N+B,s=t*g-r;L=(-o+e)*(f-(zC(t,h,V)-a)),U=(u-s)*(-l+i),z=-(u-s)*(-o+e)}}else{const e=h-r,i=_-a,o=A-r,l=I-a,p=Ft(d*(1-t)+u*t,C,T),m=F+W,g=zC(p,m,c)-a,y=f(m)-s,v=2===n?-1:1;if(L=v*y*(-l+i),U=v*(-o+e)*g,z=-v*y*(-o+e),D){const t=p,r=F+H,n=f(r)-s;L=(-y+n)*(-l+i),U=(-o+e)*(-g+(zC(t,r,V)-a)),z=-(-y+n)*(-o+e)}}const J=1/Math.sqrt(L*L+U*U+z*z);i.setEdgeNormalFromValues(n,e,L*J,U*J,z*J)}}}function zP(e,t){YP(e)}function BP(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function HP(e,t,i){const{numVerticesPerSide:r,vertexAttributes:s,maxEdgeVertexCount:n}=e,a=r-1,o=s.count,l=2*(r-3)*(r-3),c=4*(a+n-3),h=LP.reduce(((t,i)=>t+(a+e.getEdgeCount(i)-3)),0),d=t.reduce(((e,t)=>e+a*(2*(t.latitudeResolution-1)+1)),0),u=3*(i?2:1),p=(l+c+d)*u,m=o>=65536?new Uint32Array(p):new Uint16Array(p);for(let e=0;e<p;++e)m[e]=0;e.indices=m,e.indexCount=(l+h+d)*u,e.poleIndicesStartIndex=l*u,e.edgeIndicesStartIndex=(l+d)*u,i?(function(e){const{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=i-2;let l=0;for(let e=0;e<i-3;++e){const r=e*o;for(let s=0;s<i-3;++s){const i=e*o+s,c=i+1,h=c+o,d=h-1,u=r+s,p=u+1,m=p+o;cS(u,p,m,m-1,a,n)?(hS(t,l,i,c,h),l+=6,hS(t,l,h,d,i)):(hS(t,l,i,c,d),l+=6,hS(t,l,d,h,c)),l+=6}}}(e),function(e,t){const{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:s}=e,n=r-1;let a=s;for(const s of t){const t=s.connectedOuterEdgeOffset;let o=e.getEdgeVertexIndex(t,0),l=1;for(let e=0;e<s.latitudeResolution;++e){const t=0===e?s.rowOffset:o+r;for(let r=0;r<n;r++)hS(i,a,o,o+1,t+r),a+=6,e<s.latitudeResolution-1&&(hS(i,a,o+1,t+r+1,t+r),a+=6),o+=l;o=t,l=1}}}(e,t),WP(e)):(function(e){const{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:s}=r,{typedBuffer:n,typedBufferStride:a}=s,o=t-2,l=t-3,c=t-3;let h=0;for(let e=0;e<l;++e){const t=e*o;for(let e=0;e<c;++e){const r=t+e,s=r+1,l=s+o,c=l-1;cS(r,s,l,c,a,n)?(i[h]=r,i[h+1]=s,i[h+2]=l,i[h+3]=l,i[h+4]=c,i[h+5]=r):(i[h]=r,i[h+1]=s,i[h+2]=c,i[h+3]=c,i[h+4]=s,i[h+5]=l),h+=6}}}(e),function(e,t){const{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:s}=e,n=i-1;let a=s;for(const s of t){let t=e.getEdgeVertexIndex(s.connectedOuterEdgeOffset,0),o=1;for(let e=0;e<s.latitudeResolution;++e){const l=0===e?s.rowOffset:t+i;for(let i=0;i<n;i++){const n=l+i;r[a]=t,r[a+1]=t+1,r[a+2]=n,e<s.latitudeResolution-1?(r[a+3]=t+1,r[a+4]=n+1,r[a+5]=n,a+=6):a+=3,t+=o}t=l,o=1}}}(e,t),GP(e))}function GP(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let i=0;i<4;++i){const r=aS[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;Yh(h===s-1);const d=1===i||2===i,u=d?1:2,p=d?2:1,m=e.getEdgeFirstVertexIndex(i),_=1,g=r.vertex0Index,f=r.stride;for(;o<c-1||l<h-1;){const e=g+l*f,i=m+o*_,r=o<c-1,d=l<h-1,y=r&&(!d||(r?0+s*(o+.5)/(c-1):0)<=(d?1+n*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+_:e+f;t[a]=e,t[a+u]=i,t[a+p]=v,a+=3}}e.indexCount=a}function WP(e){const{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,s=i-1,n=s-2;let a=r;for(let i=0;i<4;++i){const r=aS[i];let o=0,l=0;const c=e.getEdgeCount(i),h=r.count;Yh(h===s-1);const d=1===i||2===i,u=d?1:3,p=d?3:1,m=e.getEdgeFirstVertexIndex(i),_=1,g=r.vertex0Index,f=r.stride;for(;o<c-1||l<h-1;){const e=g+l*f,i=m+o*_,r=o<c-1,d=l<h-1,y=r&&(!d||(r?0+s*(o+.5)/(c-1):0)<=(d?1+n*(l+.5)/(h-1):0));y?++o:++l;const v=y?i+_:e+f;t[a]=e,t[a+u]=i,t[a+u+1]=i,t[a+p]=v,t[a+p+1]=v,t[a+5]=e,a+=6}}e.indexCount=a}function $P(e){const{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:s,edgeVerticesStartIndex:n}=t,a=s-2;let o=n;for(let e=0;e<4;++e){{const t=0===e||2===e,i=(0===e?a-1:0)*a+(1===e?a-1:0),r=(t?0:1)*a+(t?1:0),s=aS[e];s.vertex0Index=i,s.stride=r,s.count=a}{const i=r[e]+1;t.outerEdgesOffsetAndLength[2*e+0]=o,t.outerEdgesOffsetAndLength[2*e+1]=i,o+=i}}}function QP(e){$P(e),e.geometryState.wireframe?WP(e.geometry):GP(e.geometry)}function XP(e,t,i){const r=(t+2)%4,{geometryState:s,geometry:n,tile:a,localOrigin:o}=e,l=a.level-i.level,c=1===t||3===t,h=s.edgeResolutions[t];Yh(Bt(h));const d=h+1,{boundingBox:u,minu:p,minv:m,maxu:_,maxv:g,vertexAttributes:f}=n,y=Ft(1===t?1:0,p,_),v=Ft(0===t?1:0,m,g),x=i.renderData,w=x.geometryState,b=x.geometry,C=b.getEdgeCount(r),T=a.getNeighborEdgeStartVertexIndex(t,i)*h,P=h*2**l;Yh(w.edgeResolutions[r]===P),Yh(C-1===P);const S=x.localOrigin[0]-o[0],R=x.localOrigin[1]-o[1],O=x.localOrigin[2]-o[2],E=n.getEdgeFirstVertexIndex(t),A=f.position,M=A.typedBuffer,D=A.typedBufferStride,I=f.normalCompressed,L=I.typedBuffer,N=I.typedBufferStride,F=f.uv0,V=b.vertexAttributes,U=b.getEdgeFirstVertexIndex(r),j=V.position.typedBuffer,k=V.position.typedBufferStride,q=V.normalCompressed.typedBuffer,z=V.normalCompressed.typedBufferStride;for(let e=1;e<d-1;++e){const t=E+e,i=U+(T+e),r=t*D,s=i*k,n=j[s]+S,a=j[s+1]+R,o=j[s+2]+O;M[r]=n,M[r+1]=a,M[r+2]=o,oS(n,a,o,u);const l=t*N,d=i*z;L[l]=q[d],L[l+1]=q[d+1];const f=e/h;aT(F,t,c?y:Ft(f,p,_),c?Ft(f,m,g):v)}}function YP(e){const{geometry:t,geometryState:i,localOrigin:r,tile:s}=e,{clippingArea:n,samplerData:a}=i,{minu:o,minv:l,maxu:c,maxv:h,boundingBox:d,vertexAttributes:u}=t,{surface:p,ellipsoid:m,extent:_,extentInRadians:g,horizontalScale:f}=s,y="local"===p.view?.viewingMode,v=m.radius;let x=0,w=0,b=0;const C=y?(()=>{const e=n,t=null!=e&&(_[3]>e[3]||_[2]>e[2]||_[1]<e[1]||_[0]<e[0]),i=BP(p.isWebMercatorOnPlateCarree,v,f);return(r,s,n)=>{const a=0===r?_[0]:_[2],o=0===s?_[1]:_[3],l=t?Ft(a,e[0],e[2]):a,c=t?Ft(o,e[1],e[3]):o,h=n;x=l*f,w=i(c),b=h}})():(e,t,i)=>{const r=g[0===t?1:3],s=g[0===e?0:2],n=Math.cos(r),a=Math.sin(r),o=Math.sin(s),l=Math.cos(s),c=v+i;x=l*n*c,w=o*n*c,b=a*c};let T=0,P=0,S=0,R=0,O=0,E=0,A=0,M=0,D=0;const I=y&&p.isWebMercatorOnPlateCarree,L=(e,t,i,r,s)=>{let n=0,a=0,o=0;if(y){const e=t*f,s=I?(Math.PI/2-2*Math.atan(Math.exp(-i/v)))*v:i*f;n=e-x,a=s-w,o=r-b}else{const s=jP(e),l=e.tile,c=l.extent,h=l.extentInRadians,d=(t-c[0])/(c[2]-c[0]),u=(i-c[1])/(c[3]-c[1]),p=h[0]*(1-d)+h[2]*d,m=s(u),_=Math.cos(m),g=Math.sin(m),f=Math.sin(p),y=Math.cos(p),C=v+r;n=y*_*C-x,a=f*_*C-w,o=g*C-b}switch(s){case 0:A+=n,M+=a,D+=o;break;case 1:R-=n,O-=a,E-=o;break;case 2:A-=n,M-=a,D-=o;break;case 3:R+=n,O+=a,E+=o}},N=n??iS,F=_[0],V=_[2],U=_[1],j=_[3],k=[j>N[3],V>N[2],U<N[1],F<N[0]],q=Math.max(F,N[0]),z=Math.min(V,N[2]),B=Math.max(U,N[1]),H=Math.min(j,N[3]),G=e=>Math.max(N[0],Math.min(N[2],e)),W=e=>Math.max(N[1],Math.min(N[3],e)),$=e=>{const t=i.cornerNeighborCornerTiles;T=0,P=0,S=1,R=0,O=0,E=0,A=0,M=0,D=0;let r=1/0;for(let i=0;i<4;++i){const s=t[4*e+i];r=Math.min(r,s?.level??1/0)}for(let i=0;i<4;++i){const s=t[4*e+i];rS[i]=s?.level===r?s:null}let s=1,n=0;for(let e=0;e<4;++e){const t=rS[e];t&&(s=Math.max(s,t?.renderData.geometryState.numVerticesPerSide),n=t.extent[2]-t.extent[0])}const a=n,o=s;Yh(o>1);const l=a/o;for(let e=0;e<4;++e){const t=rS[(e+3)%4],i=rS[e%4];if(!t&&!i)continue;const r=0===e?1:1===e?2:2===e?3:0,s=0===e?2:1===e?3:2===e?0:1;if(t&&i){const n=eS[e][0]*l,a=eS[e][1]*l,o=t.extent,c=G(o[0===r||1===r?2:0]+n),h=W(o[0===r||3===r?3:1]+a),d=i.extent,u=G(d[0===s||1===s?2:0]+n),p=W(d[0===s||3===s?3:1]+a),m=t.renderData,_=i.renderData,g=zC(c,h,m.geometryState.samplerData),f=zC(u,p,_.geometryState.samplerData);L(m,c,h,.5*(g+f),e)}else{const n=t??i,a=t?r:s,o=n.extent,c=eS[e],h=G(o[0===a||1===a?2:0]+c[0]*l),d=W(o[0===a||3===a?3:1]+c[1]*l),u=n.renderData,p=zC(h,d,u.geometryState.samplerData);L(u,h,d,p,e)}}if(!y){const e=Math.sqrt(x*x+w*w+b*b);T=x/e,P=w/e,S=b/e}if(y||S*S<.999){const e=Math.sqrt(R*R+O*O+E*E);R/=e,O/=e,E/=e;const t=Math.sqrt(A*A+M*M+D*D);A/=t,M/=t,D/=t,T=E*M-O*D,P=R*D-E*A,S=O*A-R*M;const i=1/Math.sqrt(T*T+P*P+S*S);T*=i,P*=i,S*=i}},Q=i.cornerNeighborCornerTiles;for(let e=0;e<4;++e){const n=e,p=(e+1)%4,m=0===e||1===e?1:0,_=0===e||3===e?1:0,g=Ft(m,o,c),f=Ft(_,l,h),y=t.getEdgeFirstVertexIndex(n),v=t.getEdgeCount(n),R=0===e||3===e?v-1:0,O=t.getEdgeFirstVertexIndex(p),E=t.getEdgeCount(p),A=0===e||1===e?E-1:0;let M=-1;for(let t=0;t<4;++t){const i=Q[4*e+t],r=Q[4*e+M];i&&(-1===M||Ra(r,i)>0)&&(M=t)}const D=M,I=Q[4*e+D];if(I!==s){const t=s.level-I.level,n=2**t,a=[I.lij[0]+t,I.lij[1]*n,I.lij[2]*n],o=[a[1]+n===s.lij[1],0===e&&(1===D||0===D&&I!==Q[4*e+3])||1===e&&(0===D||1===D&&I!==Q[4*e+2]),a[1]===s.lij[1]+1,2===e&&(3===D||2===D&&I!==Q[4*e+1])||3===e&&(2===D||3===D&&I!==Q[4*e+0])],l=o.reduce(((e,t)=>e+(t?1:0)),0);Yh(1===l||2===l);let c=-1,h=-1;const p=I.renderData;if(1===l){const t=o.findIndex((e=>e));Yh(0<=t&&t<=3),c=(t+2)%4;const r=i.edgeResolutions[t];h=s.getNeighborEdgeStartVertexIndex(t,I)*r+r*(0===t&&0===e||1===t&&0===e||2===t&&1===e||3===t&&3===e?1:0)}else{Yh(o[1]||o[3]),c=o[1]?3:1;const t=p.geometryState.edgeResolutions[c];h=0===e||3===e?0:t}const m=p.geometry;{const e=y+R,t=O+A,i=m.getEdgeFirstVertexIndex(c)+h,s=m.vertexAttributes,n=p.localOrigin;{const a=s.position,o=a.typedBuffer,l=i*a.typedBufferStride,c=o[l]+n[0]-r[0],h=o[l+1]+n[1]-r[1],p=o[l+2]+n[2]-r[2];oS(c,h,p,d);const m=u.position,_=m.typedBuffer;{const t=e*m.typedBufferStride;_[t]=c,_[t+1]=h,_[t+2]=p}{const e=t*m.typedBufferStride;_[e]=c,_[e+1]=h,_[e+2]=p}}const a=u.uv0;aT(a,e,g,f),aT(a,t,g,f);{const r=s.normalCompressed.typedBuffer,n=i*s.normalCompressed.typedBufferStride,a=u.normalCompressed,o=a.typedBuffer;{const t=e*a.typedBufferStride;o[t]=r[n],o[t+1]=r[n+1]}{const e=t*a.typedBufferStride;o[e]=r[n],o[e+1]=r[n+1]}}}}else{let i;i=k[n]||k[p]?zC(Ft(F*(1-m)+V*m,q,z),Ft(U*(1-_)+j*_,B,H),a):ZP(Q,e),C(m,_,i),$(e);const s=x-r[0],o=w-r[1],l=b-r[2];oS(s,o,l,d),t.setEdgeVertexFromValuesRawPositionUVNormal(n,R,s,o,l,g,f,T,P,S),t.setEdgeVertexFromValuesRawPositionUVNormal(p,A,s,o,l,g,f,T,P,S)}}for(let e=0;e<4;++e)rS[e]=null}function ZP(e,t){const i=4*t,r=LP.reduce(((t,r)=>Math.min(t,e[i+r]?.level??1/0)),1/0);nd&&(Yh(!e[i+0]||!e[i+2]||XT(e[i+0],e[i+2],rd.SOUTH_WEST)),Yh(!e[i+1]||!e[i+3]||XT(e[i+1],e[i+3],rd.NORTH_WEST)));let s=0,n=0;for(let t=0;t<4;++t){const a=e[i+t];if(a&&a.level===r){const e=0===t||1===t,i=0===t||3===t,r=a.extent,o=r[e?0:2],l=r[i?1:3],c=a.renderData?.geometryState?.samplerData;n+=zC(o,l,c),s++}}const a=s?n/s:0;return Yh(null!=a),a}function KP(e){const{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:s}=i,n=r.position.typedBuffer;t.vertexBuffers.geometry.setSubData(n,s,s,n.length)}function JP(e){const{vao:t,geometry:i}=e,{indices:r,indexCount:s,edgeIndicesStartIndex:n}=i;t.indexBuffer.setSubData(r,n,n,s)}const eS=[[0,1],[1,0],[0,-1],[-1,0]],tS=new class{constructor(){this.sinLonLUT=new Array(su+1),this.cosLonLUT=new Array(su+1),this.sinLatLUT=new Array(su+1),this.cosLatLUT=new Array(su+1)}update(e,t,i){const r=t[0],s=t[2];for(let t=0;t<=e;t++){const n=t/e,a=r*(1-n)+s*n;this.sinLonLUT[t]=Math.sin(a),this.cosLonLUT[t]=Math.cos(a);const o=i(n);this.sinLatLUT[t]=Math.sin(o),this.cosLatLUT[t]=Math.cos(o)}}},iS=We(-1/0,-1/0,1/0,1/0),rS=[null,null,null,null];function sS(e,t,i){if(!t)return!1;const r=Ra(e,t);return r>0||0===r&&i>=2}class nS{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(e){return Yh(0<=e&&e<this.count),this.vertex0Index+this.stride*e}}const aS=[new nS,new nS,new nS,new nS];function oS(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function lS(e){const{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function cS(e,t,i,r,s,n){const a=e*s,o=n[a],l=n[a+1],c=n[a+2],h=t*s,d=n[h],u=n[h+1],p=n[h+2],m=i*s,_=n[m],g=n[m+1],f=n[m+2],y=r*s,v=n[y],x=n[y+1],w=n[y+2];return(d-v)*(d-v)+(u-x)*(u-x)+(p-w)*(p-w)>(o-_)*(o-_)+(l-g)*(l-g)+(c-f)*(c-f)}function hS(e,t,i,r,s){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=s,e[t+4]=s,e[t+5]=i}class dS extends kT{constructor(e,t,i,r,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=je(),this._baseUsedMemory=900,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=s.view.renderSpatialReference,a=s.spatialReference,o=null!=n&&Zt(n)&&null!=a&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const{isWebMercatorOnPlateCarree:l}=s,c=this._extentInRenderSR,h=this.extent;if(l){const e=xe(h[0],h[1],0);Wd(e,Uh.WebMercator,e,Uh.PlateCarree);const t=xe(h[2],h[3],0);Wd(t,Uh.WebMercator,t,Uh.PlateCarree),c[0]=e[0],c[1]=e[1],c[2]=t[0],c[3]=t[1]}else for(let e=0;e<4;++e)c[e]=h[e]*o;this.centerAtSeaLevel[0]=.5*(c[0]+c[2]),this.centerAtSeaLevel[1]=.5*(c[1]+c[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(c[2]-c[0],c[3]-c[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBounds[0]-this.elevationBounds[1]),n=Math.max(r,s);this._center[WT.MIDDLE][3]=n}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5];let l=!0;for(let t=0;t<6;t++){const c=e[t],h=c[0],d=c[1],u=c[2],p=c[3];if(h*(h>0?i:n)+d*(d>0?r:a)+u*(u>0?s:o)+p>=0)return Jh.OUTSIDE;l=l&&h*(h<0?i:n)+d*(d<0?r:a)+u*(u<0?s:o)+p<=0}return l?Jh.INSIDE:Jh.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return xu(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,t,i,r){return uS[0]=1/t[0],uS[1]=1/t[1],uS[2]=1/t[2],In(this._aabb(),e,uS,i,r)}createGeometry(){(function(e,t){const{tile:i,geometryState:r,geometry:s}=e,{extent:n,surface:a}=i,{wireframe:o}=r,l=n[0],c=n[1],h=n[2]-l,d=n[3]-c,{numVerticesPerSide:u,clippingArea:p}=r,m=null!=p?Math.max(0,(p[0]-l)/h):0,_=null!=p?Math.max(0,(p[1]-c)/d):0,g=null!=p?Math.min(1,(p[2]-l)/h):1,f=null!=p?Math.min(1,(p[3]-c)/d):1,y=(u-2)**2,v=lS(r),x=y+4*v,w=a.renderer.tileGeometryCache.acquire(x),{boundingBox:b}=s;vu(b),s.numVerticesPerSide=u,s.vertexAttributes=w,s.maxEdgeVertexCount=v,s.minu=m,s.minv=_,s.maxu=g,s.maxv=f,function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{samplerData:n,clippingArea:a,numVerticesPerSide:o}=r,{surface:l,extent:c,ellipsoid:h}=t,{isWebMercatorOnPlateCarree:d}=l,u=null!=a?a:iS,p=c[0],m=c[1],_=c[2],g=c[3],f=Math.max(p,u[0]),y=Math.min(_,u[2]),v=Math.max(m,u[1]),x=Math.min(g,u[3]),w=h.radius,b=t.horizontalScale,C=o-1,T=o-2,{minu:P,minv:S,maxu:R,maxv:O,boundingBox:E,vertexAttributes:A}=i,M=A.position,D=A.uv0,{typedBuffer:I,typedBufferStride:L}=A.normalCompressed,N=s[0],F=s[1],V=s[2],U=M.typedBuffer,j=M.typedBufferStride;let k=0;const q=Ft(m,v,x),z=d?(Math.PI/2-2*Math.atan(Math.exp(-q/w)))*w:q*b,B=1/C,H=Ft(m*(1-B)+g*B,v,x);let G=z,W=d?(Math.PI/2-2*Math.atan(Math.exp(-H/w)))*w:H*b;for(let e=1;e<=T;e++){const t=e/C,i=Ft(m*(1-t)+g*t,v,x),r=Ft(t,S,O),s=W,a=(e-1)/C,o=Ft(m*(1-a)+g*a,v,x),l=G,c=(e+1)/C,h=Ft(m*(1-c)+g*c,v,x),u=d?(Math.PI/2-2*Math.atan(Math.exp(-h/w)))*w:h*b,A=Ft(c,S,O);G=W,W=u;const M=Ft(p,f,y);let q=M*b,z=zC(M,i,n);const B=1/C,H=Ft(B,P,R),$=Ft(p*(1-H)+_*H,f,y);let Q=H,X=$,Y=$*b,Z=zC($,i,n);if(1===e){const e=Y-N,t=G-F,i=Z-V,s=0*j;U[s]=e,U[s+1]=t,U[s+2]=i,oS(e,t,i,E),aT(D,k,Ft(B,P,R),r)}for(let t=1;t<=T;t++){const a=Y,c=Z,d=(t+1)/C,m=Ft(d,P,R),g=Ft(p*(1-d)+_*d,f,y),v=X;X=g;{const a=k+1,o=a*j;if(1===e||t===T){const l=g*b,c=zC(g,i,n);if(1===e&&t<T){const e=l-N,t=s-F,i=c-V;U[o]=e,U[o+1]=t,U[o+2]=i,oS(e,t,i,E),aT(D,a,m,r)}Y=l,Z=c}else Y=U[o]+N,Z=U[o+2]+V}const x=Y,w=Z,S=q,O=z;q=a,z=c;const M=(k-T)*j,B=1===e?zC(v,o,n):U[M+2]+V,H=zC(v,h,n);if(e<T){const e=k+T,t=e*j,i=a-N,r=u-F,s=H-V;U[t]=i,U[t+1]=r,U[t+2]=s,oS(i,r,s,E);const n=Q;Q=m,aT(D,e,n,A)}{const e=x-S,t=l-u,i=t*(w-O),r=e*(B-H),s=-t*e,n=i*i+r*r+s*s;if(0===n)Pu(I,k,0,0,1,L);else{const e=1/Math.sqrt(n);Pu(I,k,i*e,r*e,s*e,L)}}++k}}}(e),s.edgeVerticesStartIndex=y,$P(e),kP(e),HP(s,[],o),e.intersectionData=null})(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(zP(e),qP(e,!0),KP(e),e.intersectionData=null)}updateEdgeElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(kP(e),KP(e),e.intersectionData=null)}updateEdgeElevationsAndResolutions(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(QP(e),kP(e),KP(e),JP(e),e.intersectionData=null)}get horizontalScale(){return this._horizontalScaleFactor}}const uS=we();class pS{constructor(){this.extent=tr(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let mS=class extends pe{constructor(){super(...arguments),this._queries=new Y({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Y({initialSize:30}),this._queryPool=new _e(pS)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();Zi(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};e([ae()],mS.prototype,"updating",null),mS=e([le("esri.views.3d.terrain.ScaleRangeQueries")],mS);class _S extends kT{constructor(e,t,i,r,s){super(),this._convexHull=new Array(24),this._boundingSphere=vl(),this._baseUsedMemory=1816,this.init(e,t,i,r,s)}init(e,t,i,r,s){super.init(e,t,i,r,s);const n=this.ellipsoid.radius,a=this.extentInRadians[0],o=this.extentInRadians[1],l=this.extentInRadians[2],c=this.extentInRadians[3],h=jt(o,c,.5),d=jt(a,l,.5),u=0===e?0:Math.min(Math.abs(o),Math.abs(c));this._edgeLen=(l-a)*Math.cos(u)*n,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=n-Math.sqrt(n*n-this._edgeLen2/4),function(e,t,i,r){const s=Math.cos(i);e[0]=Math.cos(t)*s*r,e[1]=Math.sin(t)*s*r,e[2]=Math.sin(i)*r}(this.centerAtSeaLevel,d,h,this.ellipsoid.radius),_i(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])ui(yl(e[WT.MIDDLE]),0,0,0),ui(e[WT.TOP],0,0,0),ui(e[WT.BOTTOM],0,0,0),e[WT.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const s=e[WT.MIDDLE],n=this.convexHull;let a=0;for(let e=0;e<8;++e)a=Math.max(a,(i=n,r=3*e,fS((t=yl(s))[0],t[1],t[2],i[r],i[r+1],i[r+2])));e[WT.MIDDLE][3]=Math.sqrt(a)}var t,i,r}_calculateFrustumVisibilityStatus(e){if(!ah(e,this._boundingSphere))return Jh.OUTSIDE;if(this.lij[0]<10)return Jh.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let s=0;s<uh;s++){const n=s===dh.NEAR,a=e[s],o=a[0],l=a[1],c=a[2],h=a[3]-(n?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+c*t[i+2]+h<0){if(d=!0,!r)break}else r=!1}if(!d)return Jh.OUTSIDE}return r?Jh.INSIDE:Jh.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){(function(e,t){const{tile:i,geometry:r,geometryState:s}=e,{extentInRadians:n,surface:a}=i,{isWebMercator:o,renderer:l}=a,{numVerticesPerSide:c,wireframe:h}=s,d=c-1,u=(c-2)**2,p=o&&(t===Xs.HAS_SOUTH_POLE||t===Xs.HAS_BOTH_POLES),m=o&&(t===Xs.HAS_NORTH_POLE||t===Xs.HAS_BOTH_POLES),_=6*((p?1:0)+(m?1:0))*c,g=lS(s),f=u+_+4*g,y=l.tileGeometryCache.acquire(f);r.numVerticesPerSide=c,r.vertexAttributes=y,r.maxEdgeVertexCount=g;const{boundingBox:v}=r;vu(v);const x=jP(e);tS.update(d,n,x),function(e){const{tile:t}=e;if(!t.intersectsClippingArea)return;const{geometry:i,geometryState:r,localOrigin:s}=e,{numVerticesPerSide:n,samplerData:a}=r,o=n-2,l=n-1,{vertexAttributes:c,boundingBox:h}=i,d=c.position,u=c.uv0,{typedBuffer:p,typedBufferStride:m}=c.normalCompressed,{extent:_}=t,g=_[0],f=_[2],y=_[1],v=_[3],x=t.ellipsoid.radius,w=s[0],b=s[1],C=s[2],T=d.typedBuffer,P=d.typedBufferStride,S=1/l;let R=0;if(1<=o){const e=S,t=y*(1-e)+v*e,i=tS.sinLatLUT[1],r=tS.cosLatLUT[1];for(let s=1;s<=o;s++){const n=s*S,o=g*(1-n)+f*n,l=tS.sinLonLUT[s],c=tS.cosLonLUT[s],d=x+zC(o,t,a),p=d*c*r-w,m=d*l*r-b,_=d*i-C;oS(p,m,_,h);const y=(s-1)*P;T[y]=p,T[y+1]=m,T[y+2]=_,aT(u,s-1,n,e)}}for(let e=1;e<=o;e++){const t=e*S,i=y*(1-t)+v*t,r=tS.sinLatLUT[e],s=tS.cosLatLUT[e],n=e+1,c=n*S,d=y*(1-c)+v*c,_=tS.sinLatLUT[n],O=tS.cosLatLUT[n],E=tS.sinLonLUT[0],A=tS.cosLonLUT[0],M=x+zC(g,i,a);let D=A*s*M-w,I=E*s*M-b,L=r*M-C;const N=R*P;let F=T[N],V=T[N+1],U=T[N+2];for(let t=1;t<=o;t++){const n=t*S,v=g*(1-n)+f*n,E=tS.sinLonLUT[t],A=tS.cosLonLUT[t];let M=0,N=0,j=0;if(t<o){const e=(R+1)*P;M=T[e],N=T[e+1],j=T[e+2]}else{const e=tS.sinLonLUT[l],t=tS.cosLonLUT[l],n=x+zC(f,i,a);M=t*s*n-w,N=e*s*n-b,j=r*n-C}const k=D,q=I,z=L;D=F,I=V,L=U,F=M,V=N,U=j;const B=M-k,H=N-q,G=j-z;let W=0,$=0,Q=0;if(e>1){const e=(R-o)*P;W=T[e],$=T[e+1],Q=T[e+2]}else{const e=tS.sinLatLUT[0],t=tS.cosLatLUT[0],i=x+zC(v,y,a);W=A*t*i-w,$=E*t*i-b,Q=e*i-C}const X=x+zC(v,d,a),Y=A*O*X-w,Z=E*O*X-b,K=_*X-C;if(e<o){const e=R+o,t=e*P;T[t]=Y,T[t+1]=Z,T[t+2]=K,oS(Y,Z,K,h),aT(u,e,n,c)}const J=W-Y,ee=$-Z,te=Q-K;let ie=A*s,re=E*s,se=r;se*se<.999&&(ie=G*ee-H*te,re=B*te-G*J,se=H*J-B*ee);const ne=1/Math.sqrt(ie*ie+re*re+se*se);Pu(p,R,ie*ne,re*ne,se*ne,m),++R}}}(e),r.poleVerticesStartIndex=u;const w=function(e,t,i){const{tile:r,localOrigin:s,geometry:n}=e,{extent:a,ellipsoid:o}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:d}=n,u=c-1,p=s[0],m=s[1],_=s[2],g=o.radius,f=a[1],y=a[3],v=[];let x=d;const w=(e,t)=>{const i=t*c;oS(-p,-m,e*g-_,l),v.push({connectedRowOffset:i,connectedOuterEdgeOffset:1===e?0:2,rowOffset:x,latitudeResolution:6});const r=UP(-1===e?f:y,g),s=e*Math.PI/2-r,n=.99*(1===e?1:-1),a=g+0,{position:o,uv0:d}=h,{typedBuffer:w,typedBufferStride:b}=h.normalCompressed;for(let e=1;e<=6;++e){const t=r+s*(e/6),i=Math.cos(t),c=Math.sin(t);for(let e=0;e<=u;e++){const t=e/u,r=tS.sinLonLUT[e],s=tS.cosLonLUT[e]*i,h=r*i,g=c,f=s*a-p,y=h*a-m,v=g*a-_;oS(f,y,v,l),o.setValues(x,f,y,v),aT(d,x,t,n),Pu(w,x,s,h,g,b),++x}}};return t&&w(-1,0),i&&w(1,u),v}(e,p,m);r.edgeVerticesStartIndex=u+_,$P(e),NP(e),HP(r,w,h),e.intersectionData=null})(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),nd&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=yl(e),i=this.elevationBounds,r=this.ellipsoid.radius,s=i[1];if(0===this.level)ui(t,0,0,0),e[3]=r+s;else{const s=this.extentInRadians,n=.5*(s[0]+s[2]),a=s[1],o=s[3];yS(xS,n,a,r),yS(wS,n,o,r),vi(t,xS,wS);const l=.5*(i[0]+i[1]);fi(t,t,(r+l)/Ii(t));const c=this.convexHull;let h=0;const d=(e,t)=>{const i=e[0]-c[3*t],r=e[1]-c[3*t+1],s=e[2]-c[3*t+2];return Math.sqrt(i*i+r*r+s*s)};for(let e=0;e<8;++e){const i=d(t,e);h=Math.max(h,i)}const u=h;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBounds,r=this._getPatchType(),s=this.surface.isWebMercator,n=s&&r===Xs.HAS_NORTH_POLE,a=s&&r===Xs.HAS_SOUTH_POLE,o=a||n,l=Math.PI/2,c=e[0],h=e[2],d=a?-l:e[1],u=n?l:e[3],p=.5*(c+h),m=i[0],_=t+(o?Math.min(0,m-1):m),g=(e,t,i)=>yS(e,t,i,_),f=we(),y=we(),v=we(),x=we();g(f,c,d),g(y,c,u),g(v,h,u),g(x,h,d);const w=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};w(f,0),w(y,1),w(v,2),w(x,3);const b=i[1],C=t+(o?Math.max(0,b+1):b),T=we(),P=we(),S=we();yS(P,p,u,_),yS(S,p,d,_),vi(T,P,S),_i(T,T);const R=we(),O=we(),E=(e,t)=>{Ci(O,e,t),_i(O,O);const i=-gi(e,R)/gi(O,R);Yh(i>=0),fi(O,O,i),vi(e,e,O)};if(2**this.lij[0]>2*this.lij[1]){const e=S,t=we();wi(t,vS,e),_i(t,t),wi(R,e,t),_i(R,R),Yh(gd(gi(R,e)/Ii(e),0)),E(f,y),E(x,v),w(f,0),w(x,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=P,t=we();wi(t,vS,e),_i(t,t),wi(R,t,e),_i(R,R),E(y,f),E(v,x),w(y,1),w(v,2)}const A=(e,t)=>{const i=C/gi(t,T);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};A(4,f),A(5,y),A(6,v),A(7,x)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?Xs.HAS_BOTH_POLES:Xs.HAS_NORTH_POLE:i?Xs.HAS_SOUTH_POLE:Xs.REGULAR}intersectsRay(e,t,i,r){const s=this._boundingSphere,n=s[3]+i,a=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],c=s[2]-e[2],h=(o*t[0]+l*t[1]+c*t[2])/a,d=t[0]*h-o,u=t[1]*h-l,p=t[2]*h-c;return d*d+u*u+p*p<n*n}getDefaultVerticesPerSide(){return this.level<gS.length?gS[this.level]+1:2}updateCornerElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(VP(e),FP(e,!0),KP(e),e.intersectionData=null),this._updateBoundingVolumes()}updateEdgeElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(NP(e),KP(e),e.intersectionData=null),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){var e;(e=this.renderData).tile.intersectsClippingArea&&(QP(e),NP(e),KP(e),JP(e),e.intersectionData=null),this._updateBoundingVolumes()}_checkBVs(){if(!nd)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=yl(e),r=we(),s=this.ellipsoid.radius,n=this.elevationBounds;n[1],n[0];const a=s+n[0],o=this._center[WT.MIDDLE][3],l=this.convexHull,c=(e,t)=>{for(let i=0;i<3;++i)e[i]=l[3*t+i]};{const e=we(),t=we(),i=we(),r=we(),s=we(),n=(n,a,o,l)=>{c(t,n),c(i,a),c(r,o),Ci(t,t,i),Ci(r,r,i),wi(e,t,r),_i(e,e);const h=gi(e,i);c(s,l);const d=gi(e,s),u=Math.abs(d-h);Yh(gd(u,0),`Non coplanar ${n},${a},${o},${l} diff = ${u}`)};n(0,1,2,3),n(4,5,6,7),n(0,1,4,5),n(1,2,5,6),n(2,3,6,7),n(3,0,7,4)}const h=Lu(24),d=we(),u=we(),p=we(),m=we(),_=(e,t,i,r)=>{c(d,t),c(u,i),c(p,r),Ci(d,d,u),_i(d,d),Ci(p,p,u),_i(p,p),wi(m,d,p),_i(m,m);const s=gi(m,u);((e,t,i)=>{const r=4*e;for(let e=0;e<3;++e)h[r+e]=t[e];h[r+3]=i})(e,m,s)};_(0,0,1,2),_(1,1,0,4),_(2,1,5,2),_(3,3,2,6),_(4,4,0,3),_(5,4,6,5);const g=(e,t,i,r)=>{const s=4*e;return h[s]*t+h[s+1]*i+h[s+2]*r-h[s+3]},f=(e,t,i,r)=>g(e,t,i,r)>=-1,y=(e,t)=>f(e,t[0],t[1],t[2]),v=2**this.lij[0]>2*this.lij[1],x=(e,r,s)=>Math.sqrt(fS(e,r,s,i[0],i[1],i[2]))<t,w=e=>x(e[0],e[1],e[2]),b=this.extentInRadians,C=.5*(b[0]+b[2]),T=b[1],P=b[3],S=we(),R=we();yS(S,C,P,a),yS(R,C,T,a);const O=v?"Upper":"Lower";let E=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const i=3*t,r=f(e,l[i],l[i+1],l[i+2]);E&&=r,Yh(r,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}Yh(y(e,R),`Tile[${this.lij}] (${O}) bottom mid outside of plane ${e}`),Yh(y(e,S),`Tile[${this.lij}] (${O}) top mid outside of plane ${e}`)}Yh(E,"Not all convex hull points are inside  convex hull polyhedron"),Yh(w(R),`Tile[${this.lij}] (${O}) bottom mid outside of bounding sphere`),Yh(w(S),`Tile[${this.lij}] (${O}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=x((A=l)[M=3*e],A[M+1],A[M+2]);Yh(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}var A,M;for(let e=0;e<6;++e)for(let t=0;t<8;++t){const i=3*t;f(e,l[i],l[i+1],l[i+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const{extentInRadians:D}=this,I=Math.max(D[2]-D[0],D[3]-D[1]),L=Math.round(I*s),{renderData:N}=this;if(!N)return;const{geometry:F,geometryState:V,localOrigin:U}=N,j=F.vertexAttributes?.position;if(!j)return;const k=we(),q=F.numVerticesPerSide-2,{indices:z,indexCount:B,edgeVerticesStartIndex:H,poleVerticesStartIndex:G}=F;if(!z)return;const W=new Set;for(let e=0;e<B;++e){const a=z[e];if(W.has(a))continue;W.add(a);const l=a<G,c=a>=H;let h=!1,d=-1;if(c){let e=H;for(let t=0;t<4;++t){const i=V.edgeResolutions[t];if(a===e||a===e+i-1){h=!0;break}if(e+=i,a<e){d=t;break}}}const u=c?V.edgePeerNeighbors[d]:null,p=c&&u&&Ra(this,u)>0;j.getVec(a,r),vi(k,r,U);const m=Ii(k)-s;let _=0,y=!1;const v=n[0]-m,x=m-n[1],w=v>1,b=x>1,C=w||b,T=()=>{const e=l?"internal":c&&!h?"edge":h?"corner":"pole";return`Tile[${this.lij}].vertex[${a}]:${e}`+(w?"(below)":b?"(above)":"")+(p?"(Neighbor)":"")},P=Di(k,i);if(P>=t+0){const e=P-t;C||(console.error(`${T()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${m.toFixed(0)} / [${n[0].toFixed(0)}..${n[1].toFixed(0)}] (${(e/t).toFixed(0)})`),y=!0)}for(let e=0;e<6;++e)if(!f(e,k[0],k[1],k[2])){const i=g(e,k[0],k[1],k[2]),r=a%q,s=(a-r)/q;0===e&&v||5===e&&x||(console.error(`${T()} (${r},${s})|${q}] is out of the bounding trapezoid plane ${e} h=${Math.round(m)} / [${Math.round(n[0])}..${Math.round(n[1])}] dist=${Math.round(i)} radii = ${Math.round(t)}/${Math.round(o)}} : maxL = ${L}`),++_)}if(y||_>0)break}}get convexHull(){return this._convexHull}}const gS=[128,64,64,32,16,8,8,4];function fS(e,t,i,r,s,n){const a=r-e,o=s-t,l=n-i;return a*a+o*o+l*l}const yS=(e,t,i,r)=>{const s=Math.cos(t),n=Math.sin(t),a=Math.cos(i),o=Math.sin(i);e[0]=r*a*s,e[1]=r*a*n,e[2]=r*o},vS=[0,0,1],xS=we(),wS=we();let bS=class extends pe{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};e([ae()],bS.prototype,"fovX",void 0),e([ae()],bS.prototype,"fovY",void 0),e([ae()],bS.prototype,"relativeWidthLimit",void 0),e([ae()],bS.prototype,"relativeHeightLimit",void 0),e([ae()],bS.prototype,"maxLod",void 0),e([ae()],bS.prototype,"angledSplitBias",void 0),e([ae()],bS.prototype,"aboveGround",void 0),e([ae()],bS.prototype,"frustum",void 0),bS=e([le("esri.views.3d.terrain.SplitLimits")],bS);const CS=Yo().vec3f(Sn.POSITION).vec2i16(Sn.UV0).vec2i16(Sn.NORMALCOMPRESSED,{glNormalized:!0});class TS{constructor(e){this._storage=new Ys(((t,i)=>e.newCache(t,i)),"TileGeometry")}acquire(e){const t=4*Math.ceil(e/4),i=this._storage,r=function(e){return e.toString()}(t),s=i.pop(r);if(s)return s;const n=CS.createBuffer(t);return n.release=()=>i.put(r,n),n}clear(){this._storage.clear()}destroy(){this._storage.destroy()}}class PS extends pa{constructor(){super(...arguments),this.blendMode=fT.Normal}}e([ua({count:fT.COUNT})],PS.prototype,"blendMode",void 0);class SS extends PS{constructor(){super(...arguments),this.output=RT.Composite,this.baseOpacityMode=OT.NotRequired,this.premultipliedSource=ET.Off}}var RS;e([ua({count:RT.COUNT})],SS.prototype,"output",void 0),e([ua({count:OT.COUNT})],SS.prototype,"baseOpacityMode",void 0),e([ua()],SS.prototype,"premultipliedSource",void 0),function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(RS||(RS={}));const OS=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return RS},build:function(e){const t=new qr;if(t.include(wT),e.background===RS.Only){const i=e.output===RT.ColorComposite;return i?t.fragment.uniforms.add(new Br("backgroundColor",(e=>e.backgroundColor))):t.fragment.include(PT),t.fragment.code.add(Tn`
    void main() {
      fragColor = vec4(${i?Tn`backgroundColor`:Tn`gridColor(uv)`}, 1.0);
    }
  `),t}return t.include(AT,e),t.fragment.uniforms.add(new $r("tex",(e=>e.texture))),t.fragment.uniforms.add(new Wr("opacity",(e=>e.opacity))),t.fragment.code.add(Tn`void main() {
vec4 bgColor = getBackground(uv);
fragColor = blendLayers(bgColor, texture(tex, uv), opacity);
}`),t}},Symbol.toStringTag,{value:"Module"}));class ES extends xT{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Re}}class AS extends Xr{initializeProgram(e){return new Yr(e.rctx,AS.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:ta(jn.ONE,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia})}}AS.shader=new Zr(OS,(()=>Promise.resolve().then((()=>OS))));class MS extends SS{constructor(){super(...arguments),this.background=RS.BelowLayer}}e([ua()],MS.prototype,"background",void 0);class DS{constructor(e,t,i,r,s,n){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=rr(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=xe(r,s,n)}destroy(){this.texture.release()}}class IS{constructor(){this._renderParams={reshuffleManager:new ku,context:null,drawPhase:1,state:new Uu({viewpoint:new i({targetGeometry:new eh(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new Kd(new Vu(0,0,0,0),0,0,0,512,512,4096,4096)}dispose(){this._renderParams=null}renderBackground(e,t,i,r,s,n,a,o,l,c){const h=this._backgroundTile;this._updateRenderParameters(e,t,h,i,s,n,a,o,l,c),this._renderParams.stencilSymbols=!1,i.drawBackground(this._renderParams,h,r)}renderContent(e,t,i,r,s,n,a,o,l,c,h,d){this._stencilSymbols(e,t,i,r,s,n,a,Math.round(1/o),l,c,h,d);let u=1;i.stencilRef=u++,e.setStencilFunction(kn.EQUAL,i.stencilRef,255),this._render(e,t,i,s,n,a,o,l,c,h,d),r.forAll((t=>{t.sourceLayerInfo.data.stencilRef=u++,this._renderSymbols(e,t.sourceLod,t.sourceLayerInfo.data,s,n,a,Math.round(1/o),t.offset,c,h,d)}))}_stencilSymbols(e,t,i,r,s,n,a,o,l,c,h,d){let u=1;i.stencilRef=u++,e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(Qn.KEEP,Qn.KEEP,Qn.REPLACE),e.setStencilWriteMask(255),e.setStencilFunction(kn.ALWAYS,i.stencilRef,255),this._stencilTileSymbols(e,t,i,s,n,a,o,l,c,h,d);for(const t of r.toArray()){const{sourceLod:i,offset:r,sourceLayerInfo:l}=t;l.data.stencilRef=u++,e.setStencilFunction(kn.ALWAYS,l.data.stencilRef,255),this._stencilTileSymbols(e,i,l.data,s,n,a,o,r,c,h,d)}e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!0),e.setColorMask(!0,!0,!0,!0)}_renderSymbols(e,t,i,r,s,n,a,o,l,c,h){e.setStencilFunction(kn.EQUAL,i.stencilRef,255),this._render(e,t,i,r,s,n,a,o,l,c,h,ju.SYMBOL)}_render(e,t,i,r,s,n,a,o,l,c,h,d){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,h),this._renderParams.stencilSymbols=!1,r.drawTile(this._renderParams,i,s,d)}_stencilTileSymbols(e,t,i,r,s,n,a,o,l,c,h){this._updateRenderParameters(e,t,i,r,n,a,o,l,c,h),this._renderParams.stencilSymbols=!0,i.triangleCount=0,r.drawSymbols(this._renderParams,i,s)}_updateRenderParameters(e,t,i,r,s,n,a,o,l,c){"type"in i&&"vector-tile"===i.type&&!i.stage&&i.attachWithContext(e);const h=t[0]-s.getLevelShift(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=l*c,d.displayLevel=h,d.requiredLevel=h;const u=s.getScale(t[0]),[p,m]=s.getOffset(t,n*u),_=.125*n*u/o,g=i.transforms.displayViewScreenMat3;g[0]=_,g[4]=-_,g[6]=-1-p-a[0]*n*2,g[7]=1+m+(1-a[1])*n*2-2,d.state.size[0]=o/c,d.state.size[1]=o/c,d.state.pixelRatio=c}}class LS extends Xr{initializeProgram(e){return new Yr(e.rctx,LS.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:ta(jn.ONE,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia})}}LS.shader=new Zr(DT,(()=>Promise.resolve().then((()=>DT))));class NS extends SS{constructor(){super(...arguments),this.colorizerType=_T.Stretch,this.stretchType=gT.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}e([ua({count:_T.COUNT})],NS.prototype,"colorizerType",void 0),e([ua({count:gT.COUNT})],NS.prototype,"stretchType",void 0),e([ua()],NS.prototype,"applyColormap",void 0),e([ua()],NS.prototype,"requireBilinearWithNN",void 0);class FS{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new Ao(this._rctx,new Lo(e),new Do(Xn.DEPTH24_STENCIL8,e));return this._fbos.set(e,i),i}}class VS{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new IS,this._bindParameters=new Vs(null,null),this._blendLayersTechniqueConfig=new MS,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=va(this._rctx,xa)}dispose(){this._fbos.forEach(N),this._fbos=null,this._vtFBO=N(this._vtFBO),this._vaoQuad=N(this._vaoQuad),this._vectorTileHelper=N(this._vectorTileHelper),this._backgroundTechnique=L(this._backgroundTechnique),this._applyOpacityTechnique=L(this._applyOpacityTechnique),this._blendLayersTechnique=L(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,i,r=ET.Off,s=RS.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=s,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(AS,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const i=this._getBlendLayersTechnique(fT.Normal,t?RT.ColorComposite:RT.GridComposite,OT.NotRequired,ET.Off,RS.Only),r=this._rctx.bindTechnique(i,this._bindParameters,e);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(qn.TRIANGLE_STRIP,0,No(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r,s=ET.On){t===RT.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=e.baseOpacity<1?OT.Required:OT.NotRequired,a=this._getBlendLayersTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawRasterData(e,t,i,r,s=ET.Off){if(null==e.texture)return;const n=e.baseOpacity<1?OT.Required:OT.NotRequired;e.fboTexture=t===RT.GroupBackgroundComposite||r===fT.Normal&&n===OT.NotRequired&&s===ET.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(r,t,n,s),o=this._rctx.bindTechnique(a,this._bindParameters,e);this._render(o)}drawImageryTileData(e,t,i,r,s){const n=s.sourceLayerInfo.data;if(!n.source)return;if(s.tile.surface.layerViewByIndex(s.layerIndex,Bb.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;const a=e.baseOpacity<1?OT.Required:OT.NotRequired;e.fboTexture=r===fT.Normal&&a===OT.NotRequired?null:this.switch(i).colorTexture;const o=this._getRasterColorizerTechnique(n,t,r,a);n.opacity=e.opacity;const l=n.getUniforms();l.scale=s.scale,l.offset=s.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const c=this._rctx.bindTechnique(o,null,l);this._render(c)}_getRasterColorizerTechnique(e,t,i,r){const s=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(s.type);return null==this._rasterColorizerConfig&&(this._rasterColorizerConfig=new NS,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?gT.Noop:gT.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(LS,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,i,r,s,n,a,o){const l=this._rctx,c=s.sourceLayerInfo.data,h=s.tile.surface.layerViewByIndex(s.layerIndex,Bb.MAP),d=e.baseOpacity<1?OT.Required:OT.NotRequired,u=d===OT.Required||e.opacity<1||r!==fT.Normal||t!==RT.Composite,p=u?ET.On:ET.Off,m=this._getBlendLayersTechnique(r,t,d,p);l.setPipelineState(m.getPipeline());let _=null,g=null;u?(g=this.currentFBO(i),null==this._vtFBO&&(this._vtFBO=new FS(this._rctx)),_=this._vtFBO.get(i),l.bindFramebuffer(_),this._clearCurrentFBO()):o&&l.clearSafe(Yn.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.renderBackground(l,s.sourceLod,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/s.scale),s.offset,a,n,h.contentZoom),c&&this._vectorTileHelper.renderContent(l,s.sourceLod,c,s.vtlNeighborInfos,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/s.scale),s.offset,a,n,h.contentZoom)}catch(e){A.getLogger("esri.views.3d.terrain").warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return null==_||(l.bindFramebuffer(g),e.texture=_.colorTexture,e.offset=or,e.scale=1,this.drawRasterData(e,t,i,r,p),o)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,Fo.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(Bn.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,Fo.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clearSafe(Yn.COLOR_BUFFER_BIT|Yn.DEPTH_BUFFER_BIT|Yn.STENCIL_BUFFER_BIT)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new FS(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class US{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}}class jS{constructor(e,t,i,r,s,n){this.start=e,this.end=t,this.blendMode=i,this.opacity=r,this.output=s,this.baseOpacity=n}}class kS{constructor(e,t,i,r){this._rctx=e,this.tileSize=t,this._techniques=i,this._cache=r,this._passParameters=new ES,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new VS(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=N(this._composition),this._backgroundTexture=L(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,n=0,a=this.tileSize,o=!1,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;GS.clear(),WS.length=0;const d=e.layerInfo[Bb.MAP];let u=0,p=null;for(;u<d.length;u++){const t=i.layerViewByIndex(u,Bb.MAP),m=t.layer.opacity,_=t.fullOpacity;if(l=l||wt(t.layer),id(t)){let e="normal"!==t.layer.blendMode;if(xt(t.layer.parent)){const i=zS(t.layer.parent);null!=i&&""!==i&&(e=BS(t.layer.parent)||e)}e&&(h=e,o=!1)}if(0===m&&!h){d[u].pendingUpdates&=~(jT.TEXTURE_NOFADING&jT.TEXTURE_FADING);continue}++n;const g=vd(t),f=qS(e,u,g);if(f){if(d[u].pendingUpdates&=~(jT.TEXTURE_NOFADING&jT.TEXTURE_FADING),xt(t.layer.parent)){const e=zS(t.layer.parent);null!=e&&""!==e&&HS(t.layer.parent,u)}g?a=Math.max(a,this.tileSize*c):1===r&&1===_&&(t.isOpaque||this._dataToTexture(f)&&f.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s,null===p&&(p=u)}}const m=a/this.tileSize,_=this._ensureBackgroundTexture(this.tileSize);0!==s&&null!==p?1===s&&!h&&this._useLayerTexture(e,p)||this._composeMapLayers(e,t,u-1,l,a,m,!o||h,GS,h):this._useBackgroundTexture(e,n,_)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=or,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,null!=this.backgroundColor),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useBackgroundTexture(e,t,i){let r=cT.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=cT.Delayed);const s=e.renderData;null==s.textureReference&&(r=cT.Immediate),s.setTextureReference(new DS(i,Gs.FADING,QS,e.surface.baseOpacity,0,1),r)}_useLayerTexture(e,t){const i=e.surface.layerViewByIndex(t,Bb.MAP),r=wt(i.layer),s=r?e.surface.baseOpacity:1,n=r?1:e.surface.baseOpacity,a=i.fullOpacity,o=qS(e,t,!1);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new DS(o.sourceLayerInfo.data,Gs.FADING,o,s,n,a)),!0)}_composeMapLayers(e,t,i,r,s,n,a,o,l){this._composition.ensureBuffer(s);const c=e.surface.baseOpacity;let h=!1,d=Wn.LINEAR_MIPMAP_LINEAR,u=!1,p=0;for(let t=i;t>=0;t--){const i=e.surface.layerViewByIndex(t,Bb.MAP),m=vd(i),_=qS(e,t,m),g=i.layer.opacity;if(!_||0===g&&!l)continue;const f=!wt(i.layer)&&!h;f&&(h=!0);let y=!1;o.forEach((e=>{e.start===t&&(e.output=r?RT.Composite:a&&f?this.backgroundIsGrid?RT.GridComposite:RT.ColorComposite:RT.Composite,e.baseOpacity=f?c:1,WS.push(e),this._composition.openGroup(s),y=!0)})),this._passParameters.baseOpacity=f&&!y&&c<1?c:1;const v=0===p,x=y?RT.GroupBackgroundComposite:a&&v?this.backgroundIsGrid?RT.GridComposite:RT.ColorComposite:RT.Composite,w=TT[id(i)?i.layer.blendMode:"normal"];for(this._passParameters.opacity=g,xd(_)?u=this._composition.drawVectorData(this._passParameters,x,s,w,_,n,this.tileSize,u):wd(_)?(this._composition.drawImageryTileData(this._passParameters,x,s,w,_),this._hasNearestInterpolation(_)&&(d=Wn.NEAREST)):this._dataToTexture(_)&&(this._passParameters.texture=_.sourceLayerInfo.data.texture,this._passParameters.offset=_.offset,this._passParameters.scale=_.scale,this._composition.drawRasterData(this._passParameters,x,s,w));WS.length>0&&WS[WS.length-1].end===t;){const e=WS.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=or,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,e.output,s,TT[e.blendMode])}p++}const m=e.renderData,_=l||h&&c<1,g=m.ensureTexture(s,_,(()=>this._buildTexture(s,_,d)));this._composition.copyFBOToTexture(g),this._composition.unbind(),m.setTextureReference(new DS(g,t,QS,h?1:c,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if(bd(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return Cd(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,i=Wn.LINEAR_MIPMAP_LINEAR){if(null==e)return null;const r=new Lo;r.wrapMode=Hn.CLAMP_TO_EDGE,r.samplingMode=i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=$n.RGB);const s=this._rctx;let n;if("number"==typeof e){r.width=r.height=e;const t=`${e} ${r.pixelFormat}`;n=this._cache.pop(t),n?n.retain():n=new UT(new Fo(s,r),this._cache)}else if(Td(e)){r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=$n.RGB);const t=`${e} ${r.pixelFormat}`;n=this._cache.pop(t),n?(n.retain(),n.texture.setData(e.image)):n=new UT(new Fo(s,r,e.image),this._cache),e.release()}else try{r.width=e.width,r.height=e.height,n=new UT(new Fo(s,r,e))}catch(e){n=new UT(Oa(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=s.bindTexture(n.texture,Fo.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(a,Fo.TEXTURE_UNIT_FOR_UPDATES),n}get test(){return{backgroundTexture:this._backgroundTexture}}}function qS(e,t,i){$S.layerIndex=t,$S.vtlNeighborInfos.clear();const r=e.layerInfo[Bb.MAP][t];if(zi($S.offset,0,0),$S.tile=e,$S.scale=1,$S.sourceLod=e.lij,$S.sourceLayerInfo=r,$S.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor(((i,s)=>{if(i.level!==e.level)return;const n=i.layerInfo[Bb.MAP][t];if(!Pd(n)||r.data===n.data)return;const a=$S.vtlNeighborInfos.pushNew();a.offset=XS[s],a.sourceLod=i.lij,a.sourceLayerInfo=n})),$S;const s=r.upsampleInfo;if(s){const e=s.tile.layerInfo[Bb.MAP][t];return $S.tile=s.tile,Bi($S.offset,s.offset),$S.scale=s.scale,$S.sourceLod=s.tile.lij,$S.sourceLayerInfo=e,$S}return i?$S:null}function zS(e){return e.uid}function BS(e){let t="normal"!==e.blendMode;return xt(e.parent)&&(t=BS(e.parent)||t),t}function HS(e,t){xt(e.parent)&&HS(e.parent,t);const i=zS(e);if(null!=i&&""!==i){const r=GS.get(i);r?r.start=t:GS.set(i,new jS(t,t,e.blendMode,e.opacity,RT.Composite,1))}}const GS=new Map,WS=new Array,$S=new class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Y({allocator:e=>e||new US})}},QS={offset:[0,0],scale:1},XS=new Array;XS[rd.NORTH]=[0,-1],XS[rd.NORTH_EAST]=[-1,-1],XS[rd.EAST]=[-1,0],XS[rd.SOUTH_EAST]=[-1,1],XS[rd.SOUTH]=[0,1],XS[rd.SOUTH_WEST]=[1,1],XS[rd.WEST]=[1,0],XS[rd.NORTH_WEST]=[1,-1];const YS=1e-6;class ZS{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class KS{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positions=r,this._rayDirection=we(),this.bspNodeTree=new Array;const s=i-t,n=s<=iR?new Uint16Array(s):new Uint32Array(s);this.indices=n;for(let e=0;e<s;++e)n[e]=e;{const a=function(e,t,i,r,s){const n=i-t,a=new Float32Array(6*n);for(let i=0;i<n;++i){const n=3*(i+t),o=e[n]*s,l=e[n+1]*s,c=e[n+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],n=r[c+e];a[6*i+e]=Math.min(t,s,n),a[6*i+3+e]=Math.max(t,s,n)}}return a}(e,t,i,r.data,r.stride),o=Ft(Math.log2(s/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return wu(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)eR[e]=t[r+0+e],tR[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)eR[e]=Math.min(eR[e],t[i+0+e]),tR[e]=Math.max(tR[e],t[i+3+e])}return wu(eR[0],eR[1],eR[2],tR[0],tR[1],tR[2])}(n,a,e,t),s=t-e;if(s<=40){const i=new ZS(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:c,midValue:h}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),d=function(e,t,i,r,s,n){let a=i,o=r;for(;a<o;){const i=e[a];t[6*i+s+3]<=n?++a:(--o,e[a]=e[o],e[o]=i)}let l=a;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=n?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:a,mid:l}}(n,a,e,t,c,h),u=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*s?void 0:l(e,t,i+1)},p=new ZS(r,c,h,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,s,0),this.triangleVertexIndices=function(e,t,i,r){const s=r-i;let n=0;for(let e=i;e<r;++e)for(let i=0;i<3;++i)n=Math.max(t[3*e+i],n);const a=n<=iR?new Uint16Array(3*s):new Uint32Array(3*s);for(let r=0;r<s;++r){const s=3*(e[r]+i);for(let e=0;e<3;++e){const i=t[s+e];a[3*r+e]=i}}return a}(n,e,t,i)}}intersectRayTriangleRange(e,t){if(e>=t)return;const i=this.triangleVertexIndices,r=this.positions.data,s=this.positions.stride,n=this._rayOrigin,a=n[0],o=n[1],l=n[2],c=this._rayDirection,h=c[0],d=c[1],u=c[2];for(let n=e,c=3*e;n<t;++n){const e=i[c]*s,t=r[e],p=r[e+1],m=r[e+2],_=i[c+1]*s,g=r[_],f=r[_+1],y=r[_+2],v=i[c+2]*s;c+=3;const x=g-t,w=f-p,b=y-m,C=r[v]-t,T=r[v+1]-p,P=r[v+2]-m,S=d*P-T*u,R=u*C-P*h,O=h*T-C*d,E=x*S+w*R+b*O;if(Math.abs(E)<=Number.EPSILON)continue;const A=a-t,M=o-p,D=l-m,I=A*S+M*R+D*O;if(E>0){if(I<0||I>E)continue}else if(I>0||I<E)continue;const L=M*b-w*D,N=D*x-b*A,F=A*w-x*M,V=h*L+d*N+u*F;if(E>0){if(V<0||I+V>E)continue}else if(V>0||I+V<E)continue;const U=(C*L+T*N+P*F)/E;if(U>=0){const e=this.indices[n]+this.firstTriangleIndex,t=Ln(x,w,b,C,T,P,JS);this._callback(U,t,e,!1)}}KS.numFacesTested+=t-e}intersectRay(e,t,i){KS.numFacesTested=0;const r=xe(e[0],e[1],e[2]),s=xe(t[0],t[1],t[2]),n=s[0]-r[0],a=s[1]-r[1],o=s[2]-r[2];if(n*n+a*a+o*o<YS)return;this._rayOrigin=r;const l=this._rayDirection;l[0]=n,l[1]=a,l[2]=o;const c=this.triangleVertexIndices.length/3;this._callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,t,i){const r=this._rayOrigin,s=this._rayDirection;if(!function(e,t,i){const r=t,s=i;let n=0,a=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=YS)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]<=-YS){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>a)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-YS)return!1;const e=(i-r[t])/s[t];n=Math.max(n,e)}else if(s[t]>=YS){const e=(i-r[t])/s[t];a=Math.min(a,e)}if(n>a)return!1}}return!0}(e.aabb,r,s))return;const n=e.axis,a=e.d;if(r[n]<a||s[n]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[n]>a||s[n]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}KS.numFacesTested=0;const JS=we(),eR=[1/0,1/0,1/0],tR=[-1/0,-1/0,-1/0],iR=65535;class rR extends rs{constructor(){super(...arguments),this.output=ds.Color,this.overlayMode=Ws.Disabled,this.tileBlendInput=sP.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=Rr.Simplified}}e([ua({count:ds.COUNT})],rR.prototype,"output",void 0),e([ua({count:Ws.COUNT})],rR.prototype,"overlayMode",void 0),e([ua({count:sP.COUNT})],rR.prototype,"tileBlendInput",void 0),e([ua()],rR.prototype,"spherical",void 0),e([ua()],rR.prototype,"doublePrecisionRequiresObfuscation",void 0),e([ua()],rR.prototype,"receiveShadows",void 0),e([ua()],rR.prototype,"hasSlicePlane",void 0),e([ua()],rR.prototype,"backfaceCullingEnabled",void 0),e([ua()],rR.prototype,"textureFadingEnabled",void 0),e([ua()],rR.prototype,"renderOccluded",void 0),e([ua()],rR.prototype,"hasScreenSpaceReflections",void 0),e([ua()],rR.prototype,"hasCloudsReflections",void 0),e([ua()],rR.prototype,"invisible",void 0),e([ua()],rR.prototype,"tileBorders",void 0),e([ua()],rR.prototype,"visualizeNormals",void 0),e([ua()],rR.prototype,"screenSizePerspective",void 0),e([ua()],rR.prototype,"receiveAmbientOcclusion",void 0),e([ua({count:Rr.COUNT})],rR.prototype,"pbrMode",void 0),e([ua({constValue:Nr.Compressed})],rR.prototype,"normalType",void 0),e([ua({constValue:Pr.Compressed})],rR.prototype,"textureCoordinateType",void 0),e([ua({constValue:!1})],rR.prototype,"highStepCount",void 0),e([ua({constValue:!1})],rR.prototype,"useCustomDTRExponentForWater",void 0),e([ua({constValue:!1})],rR.prototype,"useFillLights",void 0),e([ua({constValue:!0})],rR.prototype,"hasColorTexture",void 0);const sR=bu();var nR;!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(nR||(nR={}));let aR=class extends Wa{get _isGlobal(){return this._stage.viewingMode===Mt.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,s){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=r,this.type=jc.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new rR,this._passParameters=new dP,this._drawParameters=new Zs,this._renderDataPool=new _e(fP),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Aa,this._transparencyState=nR.Opaque,this._castShadows=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=Nn.Occlude,this.produces=new Map([[ns.OPAQUE_TERRAIN,()=>this._produces()],[ns.TRANSPARENT_TERRAIN,()=>this._produces()],[ns.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileTextureCache=new Ys(((e,t)=>s.newCache(e,t)),"TileTexture"),this.tileGeometryCache=new TS(s)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(U((()=>this._overlayRenderer.rendersOccludedDraped),(e=>{this.renderOccludedFlags=e?Ks:Nn.Occlude,this.setNeedsRender()}),q))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?Ba:Ha}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===nR.TransparentWithDraped||e===nR.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return $c}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,null!=this._tileRenderer&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,jT.TEXTURE_FADING)}updateTileTexture(e,t){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(e,t===jT.TEXTURE_FADING?Gs.FADING:Gs.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[Bb.ELEVATION])t.pendingUpdates&=~jT.GEOMETRY;e.resetPendingUpdate(jT.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return Re;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=pu.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=pu.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=pu.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new kS(this._rctx,this._tileSize,this._techniques,this._tileTextureCache),this.updateTileBackground(),this._emptyTex=Oa(this._rctx)}uninitializeRenderContext(){this._emptyTex=N(this._emptyTex),this._tileRenderer=N(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==nR.Opaque)return;const s=oR,n=lR;Pi(s,r,i),ui(n,1/s[0],1/s[1],1/s[2]);const a=e.results.min,o=e.results.max,l=e.results.ground,c=e.options.store===Vc.MIN,h=!!e.results.ground.target,d=Qc(e.verticalOffset),u=e.tolerance;let p,m=c&&null!=a.dist?a.dist:1/0;const _=h=>{const _=h.renderData;if(!_?.vao)return;const g=_.geometry;Cu(sR,g.boundingBox);const f=_.localOrigin;null!=d&&(d.localOrigin=f,d.applyToAabb(sR));const y=sR;if(cR[0]=i[0]-f[0],cR[1]=i[1]-f[1],cR[2]=i[2]-f[2],!In(y,cR,n,u,m))return;const v=(e,t,i)=>{e.set(this.type,h,t,i,Cr),m=c&&null!=a.dist?a.dist:1/0},x=(n,c)=>{if(null!=c&&n>=0&&(e.options.backfacesTerrain||gi(c,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,n))){if((null==l.dist||n<l.dist)&&v(l,n,c),e.options.isFiltered)return;e.options.store===Vc.ALL&&(null==p?(p=qc(e.ray),v(p,n,c),e.results.all.push(p)):n<p.dist&&v(p,n,c)),(null==a.dist||n<a.dist)&&v(a,n,c),e.options.store!==Vc.MIN&&(null==o.dist||n>o.dist)&&v(o,n,c)}},w=hR;Pi(w,r,f);const{indices:b,indexCount:C}=g,T=g.vertexAttributes,P=T.getField(Sn.POSITION,Nu),S=new zu(P.typedBuffer,3,T.stride/4),R=C/3;if(!d&&R>200){const e=h.renderData;null==e.intersectionData&&(e.intersectionData=new KS(b,0,R,S)),e.intersectionData.intersectRay(cR,w,x)}else Fn(cR,w,0,R,b,S,null,d,x)},g=this._rootTiles;null!=g&&(()=>{const t=this._tileIterator;t.reset(g);const r=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||r&&e.intersectsClippingArea)||null==d&&!e.intersectsRay(i,s,u,m)||h&&this._useStencilForTile(e)?t.skipSubtree():_(e)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._visiblePatchesByOrigin.values())for(const i of t)null!=i.renderData?.textureReference&&e.queriesForTile(i);e.process(),t.madeProgress()}}prepareTechnique(e){const t=b("enable-feature:terrain-shadows")&&e.bindParameters.shadowMap.enabled;if(t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0),e.bindParameters.slot===ns.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&Ks))return null}else{const t=this.transparency===nR.Opaque?ns.OPAQUE_TERRAIN:ns.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}if(this.transparency===nR.Empty)return null;switch(e.output){case ds.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=e.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=e.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=e.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,this._updateTechnique(ds.Color,e.bindParameters.slot===ns.OCCLUDED_TERRAIN);case ds.Shadow:case ds.ShadowExcludeHighlight:return this._castShadows?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ds.Shadow,!1)):null;case ds.LinearDepth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ds.LinearDepth,!1);case ds.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ds.Normal,!1);case ds.ObjectAndLayerIdColor:return this._updateTechnique(ds.ObjectAndLayerIdColor,!1);case ds.Highlight:return this._overlayRenderer.hasHighlights?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(ds.Highlight,!1)):null}return null}renderNode(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case ds.Color:{const i=e.bindParameters.slot===ns.OCCLUDED_TERRAIN?Qs.Occluded:Qs.Color;this._renderMaterialPass(e,t,i);break}case ds.LinearDepth:case ds.Normal:this._renderAuxiliaryPass(e,t,Qs.Color,this._visiblePatchesByOrigin);break;case ds.Highlight:this._renderAuxiliaryPass(e,t,Qs.Highlight,this._visiblePatchesByOrigin);break;case ds.Shadow:case ds.ShadowExcludeHighlight:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case ds.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,Qs.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(null==this._tileRenderer)return;const t=this._tileRenderer;let i;if(null!=e){const t=qh.toUnitRGBA(e);i=xe(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,Gs.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?sP.GridComposite:null!=t.backgroundColor?sP.ColorComposite:sP.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Ea.NONE){const e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(const i of e)Ma(this.renderOrder,i,t);e.sort(((e,t)=>Da(e[0],t[0],this.renderOrder))),this._visiblePatchesByOrigin=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(null!=e){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}const r=i.localOrigin;if(this._castShadows){let t=this._allPatchesByOrigin.get(r);t||(t=[],this._allPatchesByOrigin.set(r,t)),t.push(e)}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(r);s||(s=[],this._visiblePatchesByOrigin.set(r,s)),s.push(e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,r){const s=e.rctx;this._passParameters.overlayContent=i,s.bindTechnique(t,e.bindParameters,this._passParameters);const n=this._stencilEnabledLayerExtents.length>0;r.forEach((r=>{this._drawParameters.origin=r[0].renderData.localOrigin,t.program.bindDraw(this._drawParameters,e.bindParameters,this._passParameters);for(let s=0;s<r.length;s++)this._renderPatch(e,t,r[s],qn.TRIANGLES,n,i)})),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bindParameters,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;const s=e.bindParameters.camera,n=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=An(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const a=this._stencilEnabledLayerExtents.length>0,o=i===Qs.Occluded;o&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",Re),n.setUniform4fv("texOffsetAndScale",ir));const l=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:Re;this._techniqueConfiguration.tileBlendInput===sP.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?qn.LINES:qn.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const h=this._visiblePatchesByOrigin;for(const r of h.values()){const s=r[0].renderData.localOrigin;t.program.bindDraw(new Zs(s),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const s of r){const r=s.renderData,l=r.textureReference;if(null!=l){if(!o){n.setUniform4fv("texOffsetAndScale",l.offsetAndScale),n.bindTexture("tex",l.texture.texture);const e=r.textureFadeFactor,t=e<1?r.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=t&&e<1?(n.setUniform1f("fadeFactor",e),n.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),n.setUniform3fv("nextTexOpacities",t.opacities),n.bindTexture("texNext",t.texture.texture)):n.setUniform1f("fadeFactor",1),r.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",l.opacities)}this._renderPatch(e,t,s,c,a,i),s.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,s,n){const a=i.renderData,o=a.vao,l=o?.indexBuffer;if(!o||null==l)return void(nd&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const c=t.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,a.overlay),s&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));const h=a.geometry.indexCount;e.rctx.bindVAO(o),c.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniques.releaseAndAcquire(_P,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};e([ae({readOnly:!0})],aR.prototype,"_isGlobal",null),e([ae()],aR.prototype,"renderOccludedFlags",void 0),e([ae({value:!1})],aR.prototype,"renderingDisabled",null),e([ae({value:!0})],aR.prototype,"visible",null),e([ae()],aR.prototype,"renderPatchBorders",null),e([ae()],aR.prototype,"visualizeNormals",null),e([ae()],aR.prototype,"cullBackFaces",null),e([ae({value:Ea.FRONT_TO_BACK})],aR.prototype,"renderOrder",null),e([ae()],aR.prototype,"wireframe",null),aR=e([le("esri.views.3d.terrain.TerrainRenderer")],aR);const oR=we(),lR=we(),cR=we(),hR=we();class dR{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let uR=class extends pe{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",(()=>this._update())),U((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!yt(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return null!=Qh(e,t,i)}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||Xh(t))))),e)if(e.isResolved()){const t=Qh(e,this.viewSpatialReference,this.viewingMode);if(null!=t){const e=new Hu(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Mt.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Hu.makeWebMercatorAuxiliarySphere(t):Me(e.spatialReference)&&(e=Hu.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(U((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Mt.Global){const e=this.extentHelper.viewSpatialReference,t=Me(e)||Qt(e)||Wt(e);e.isWebMercator?this.tilingScheme=Hu.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Hu.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;null==e||Je(e,this.extent)||(this.tilingScheme=Hu.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};e([ae()],uR.prototype,"tilingScheme",void 0),e([ae({readOnly:!0})],uR.prototype,"extent",void 0),e([ae({value:!1})],uR.prototype,"tilingSchemeLocked",void 0),e([ae({constructOnly:!0})],uR.prototype,"viewSpatialReference",void 0),e([ae({constructOnly:!0})],uR.prototype,"layers",void 0),e([ae({constructOnly:!0})],uR.prototype,"extentHelper",void 0),e([ae({constructOnly:!0})],uR.prototype,"viewingMode",void 0),uR=e([le("esri.views.3d.terrain.TilingSchemeLogic")],uR);class pR{constructor(){this.offset=nr(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}var mR;let _R=mR=class extends(di.EventedMixin(pe)){constructor(e){super(e),this._scaleRangeQueries=new mS,this._iteratorPool=new _e(Aa,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Ia,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new dR,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=we(),this._eyePosSurfaceSR=we(),this._splitLimits=new bS,this._frustum=ih(),this._viewProjectionMatrix=wr(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new rl,this._frameTask=zo,this._allTiles=new Y,this._upsampleInfoPool=new _e(pR),this._shouldEmitChangeEvent=!1,this._rootTilesExtent=je(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=Uh.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new jC(1/0,-1/0),this.rootTileElevationBounds=new jC(1/0,-1/0),this._sebProjectorMap=new Map,this._sebProjectorCache=Lh(),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new YC({...e,surface:this}),this._isGlobal=!e.view?.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?_S:dS}initialize(){const e=this.view,t=e.resourceController;this._lercDecoder=Xd(t);const i=t.memoryController;this._tileCache=new Ys(((e,t)=>i.newCache(e,t)),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Qd(i.newCache("elevation-query"));const r=this.overlayManager;this._renderer=new aR(r.renderer,e._stage,this._allTiles,Gt(e.spatialReference).radius,i),this.addHandles([U((()=>r.renderer.isEmpty),(()=>this._evaluateTransparency())),U((()=>this.renderer.visible),(e=>this.suspended=!e))],"overlayManager"),this.addHandles([U((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?Gs.UNFADED:Gs.IMMEDIATE)}),j),U((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?Gs.UNFADED:Gs.IMMEDIATE)),j),U((()=>this.backgroundColor),((e,t)=>{e?.equals(t)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(e))}),q),U((()=>this.snapLevel),(()=>this._viewChanged=!0),q),U((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),U((()=>Th.TERRAIN_TILE_TREE_SHOW_TILES),(t=>{t&&!this._treeDebugger?import("../chunks/TerrainTileTree3DDebugger.js").then((({TerrainTileTree3DDebugger:t})=>{!this._treeDebugger&&Th.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new t({view:e}))})):t||(this._treeDebugger=D(this._treeDebugger))}),k)]);const{spatialReference:s}=e;var n,a;this._extentHelper=(n=this.viewingMode,a={layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:s},n===Mt.Global?new HC(a):new GC(a));const o=new Gd({getCollections:()=>e.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),l=new uR({layers:o,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:s});this._set("tilingSchemeLogic",l),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(Ta.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(Ta.BASEMAP);const c=t.scheduler;this._frameTask=c.registerTask(jo.TERRAIN_SURFACE,this),this.addHandles([U((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),k),U((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),q),U((()=>this.extent),(()=>this._updateRootTiles()),k),e.on("resize",(()=>this._viewChangeUpdate())),U((()=>{const t=e.state;return[this._lodBias,this.lodSnapping,e.quality,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),j),U((()=>e.qualitySettings?.fadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),k),U((()=>e.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?Rr.Simplified:Rr.Disabled),k),U((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),q)]),this.addHandles(e.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._lercDecoder=L(this._lercDecoder),this._removeAllTiles(),this._set("tilingSchemeLogic",D(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",D(this.overlayManager)),this._tileCache=D(this._tileCache),kT.prune(),this._treeDebugger=D(this._treeDebugger),this._renderer=D(this._renderer),this._iteratorPool=D(this._iteratorPool),this._upsampleMapCache=D(this._upsampleMapCache),this._elevationQueryCache=D(this._elevationQueryCache),this._set("view",null),this._extentHelper=D(this._extentHelper),this._upsampleInfoPool=D(this._upsampleInfoPool),Jd(),VT.size>0&&(console.log(`${VT.size} live TilePerLayerInfo allocations:`),VT.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===Js.ON){const e=this.view,t=this.tilingScheme,i=e.pointsOfInterest?.cameraOnSurface?.scale;if(t&&i){const r=e.state.contentCamera;let s=cc(e,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,a=t.levelAtScale(i)-n,o=Math.min(a+e.qualitySettings.tiledSurface.lodBias,this._splitLimits.maxLod||1/0);return o<=0?null:o}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Js.ON:Js.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(null==t||null==e)return null;const i=je(),r=Hl(t,i,e)?i:null,s=this._get("extent");return Je(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=tt(this.groundExtent,this._userClippingExtent,je()),t=this._get("extent");return Je(e,t)?t:e}get groundExtent(){return null!=this._tilingSchemeExtent?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return null!=this._rootTiles}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===nR.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this._rootTiles;if(!s?.length)return null;if(0===s[0].layerInfo[Bb.ELEVATION].length)return null;let n=this._elevationProjectorCache.get(r);if(void 0===n&&(n=Ah(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,n)),null==n)return A.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;const a=ui(fR,e,t,i);return n(a,0,a,0),CR(s,a[0],a[1])}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[Bb.ELEVATION].length:0;if(r?.length&&0!==s)for(let s=0;s<t;++s){const t=3*s;i(s,CR(r,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getScale(e){if(!this.tilingScheme)return null;if(!Ue(e,fR,this.spatialReference))return A.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(null!=t)for(const e of t)if(e?.containsPoint(fR)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;fR[0]>e[2]&&(i+=1),fR[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}_ensureSEBProject(e){const t=this._sebProjectorMap.get(e);if(t)return t;const i=Ah(e,this._tilingSchemeSpatialReference,this._sebProjectorCache)??null;return this._sebProjectorMap.set(e,i),i}getSphereElevationBounds(e,t){const i=this._ensureSEBProject(t);if(null==i)return A.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;wl(e,yR);const r=yl(yR);i(r,0,r,0);const s=new jh,n=e=>{if(e&&st(e.extent,yR))if(e.isLeaf||e.rendered)s.expandElevationRangeValues(e.elevationBounds[0],e.elevationBounds[1]);else for(const t of e.children)n(t)},a=this._rootTiles;if(null!=a)for(const e of a)n(e);return s}getRootElevationBounds(){return new jh(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!Ue(e,yl(yR),this.spatialReference))return A.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;yR[3]=t;let i=null;const r=e=>{if(e&&st(e.extent,yR)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(null!=s)for(const e of s)r(e);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+a,n+a,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?t?nR.Empty:nR.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?nR.Opaque:nR.Semitransparent,s=i!==r;return s&&(this._renderer.transparency=r,this.view?._stage?.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;ed(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??Uh.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&Zt(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._sebProjectorMap.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())}_acquireTile(e,t,i,r){const s=this._tileCache.pop(mR._tileMemcacheKey);return s?(s.init(e,t,i,r,this),s):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=vR;let r=t.rootTilesInExtent(e,i,5*lu);if(null!=this._rootTiles){if(r.length>lu)return void A.getLogger(this).warn(cu);const e=this._rootTiles.map((e=>e.lij)),t=P(e,r,QT);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>QT(t,e.lij)))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>lu&&(A.getLogger(this).warn(hu),r=t.rootTilesInExtent(e,i,lu)),this._setRootTiles(r.map((e=>this._newRootTile(e))));Je(i,this._rootTilesExtent)||(this._rootTilesExtent=je(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.isLoaded&&e.intersectsClippingArea));e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(Ra);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===jT.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(jT.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),null!=e){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(jT.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(null==e)return;const t=La(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const n=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();if(e.updateClippingStatus(n)&&e.resetPendingUpdate(jT.GEOMETRY)&&this._updateTileGeometryState(e),e.computeVisibility(),e.updateScreenDepth(a),e.renderData){const t=e.elevationBounds;r=Math.min(t[0],r),s=Math.max(t[1],s)}}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new jC(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;null!=i&&i.forEach((({elevationBounds:i})=>{e=Math.min(e,i[0]),t=Math.max(t,i[1])}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new jC(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=ph(this._splitLimits.frustum??ih(),t.frustum):this._splitLimits.frustum=null,ph(this._frustum,e.frustum),ur(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),Ti(this._eyePosRenderSR,t.eye),Wd(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor((e=>{this._layerViews[Bb.MAP].some(vd)&&e.setPendingUpdate(jT.TEXTURE_FADING),this._pendingTilesToUpdate.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(jT.TEXTURE_FADING)?jT.TEXTURE_FADING:!!e.resetPendingUpdate(jT.TEXTURE_NOFADING)&&jT.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;const e=wR.extent;ke(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>He(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),wR.spatialReference=this.spatialReference,this.emit("elevation-change",wR),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),nd&&this._checkTileInvariant(),!e.hasProgressed)return ko}_checkTileInvariant(){const e=new Map;this._allTiles.forAll((t=>e.set(t,new Set))),this._allTiles.forAll((t=>{if(ed(t.rendered===t.isLeaf,` rendered ${t.rendered} != ${t.isLeaf} leaf`),!t.isLeaf){const e=e=>0===e.unmergableChildCount&&0===e.maxLevelDeltaNeighborCount,i=t.children.reduce(((t,i)=>t+(e(i)?0:1)),0);if(ed(t.unmergableChildCount===i,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${i}`),t.hasPendingUpdate(jT.MERGE)){ed(!t.hasPendingUpdate(jT.SPLIT),"Tile can be both split and merge at the same time");for(const e of t.children)ed(e.isLeaf||e.hasPendingUpdate(jT.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){const e=t.renderData?.geometryState.edgePeerNeighbors[i];if(null!=e){{const r=t.level-e.level<=ou;r||(console.log(`tile level delta [${t.lij.toString()}] vs [${e.lij.toString()}] > ${ou}  (edge[${i}])`),ed(r,`tile level delta [${t.level}] vs [${e.level}] > ${ou}`))}ed(t.level-e.level<=ou,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${e.lij.toString()}]`)}}const r=t.level-ou,s=e=>e.isLeaf||e.level===t.level,n=t.findNeighborTile(ad[i],s);if(null!=n){if(t.isLeaf&&t.level>=ou){let i=n;for(;t.level-i.level<ou;)i=i.parent;if(!QT([r,t.lij[1]>>ou,t.lij[2]>>ou],i.lij)){const r=e.get(i);ed(!r.has(t),"Cannot already have neighbor"),r.add(t)}}ed(n.rendered||n.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),ed(t.level-n.level<=ou,`Tile level delta [${t.level}] vs [${n.level}] > ${ou}`)}}})),this._allTiles.forAll((t=>{const i=t.maxLevelDeltaNeighborCount,r=e.get(t);ed(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)}))}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=new TR(this._allTiles.length);t.pushAll(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;this._allTiles.forAll((e=>{e.maxLevelDeltaNeighborCount=0,e.unmergableChildCount=0}));const n=this._viewProjectionMatrix;for(;!t.empty;){const e=t.pop(),a=e.parent,o=null!=a&&a.hasPendingUpdate(jT.MERGE),l=o?jT.MERGE:e.shouldSplit(r,s,i),c=l===jT.SPLIT;e.isLeaf?PR(e,c):t.pushAll(e.children),o?(e.resetPendingUpdate(jT.SPLIT),e.isLeaf||e.setPendingUpdate(jT.MERGE),this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(n)):c?(e.resetPendingUpdate(jT.MERGE),e.isLeaf&&e.setPendingUpdate(jT.SPLIT)):(e.resetPendingUpdate(jT.SPLIT)&&e.updateAgentSuspension(),l===jT.ELEVATION&&e.updateAgents(Bb.ELEVATION),e.isLeaf||(e.setPendingUpdate(jT.MERGE),e.resetPendingUpdate(jT.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(Na(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Yh(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){const e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter((e=>e.isLoaded&&e.intersectsClippingArea));if(0===t.length)return void e.clear();const i=(i,r)=>{!r?.isLoaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(Ra);const r=t.length;for(let s=0;s<r;++s){const r=t[s];Yh(r.isLoaded),Yh(r.intersectsClippingArea);const n=r.renderData;n.updateNeighborData();const a=n.dirtyEdgeResolutions,o=n.geometryState,l=e=>{const t=ld[e];i(r,o.cornerPeerNeighbors[e]?.findCorner(sd(t),(e=>e.isLoaded)))};for(let t=0;t<4;++t)if(a&1<<t){const s=n.geometryState.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide(od(ad[t]),(t=>!(!t.isLoaded||!t.intersectsClippingArea||(Yh(e.has(t)||Ra(r,t)<0),i(r,t),0)))),l((t+1)%4),l(t)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,nd&&pd&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let n=!1;const a=!this._allTiles.some((s=>{if(!i&&!r&&!s.visible)return e.done;let a=s;if(s.hasPendingUpdate(jT.MERGE)){if(!t||s.unmergableChildCount>0)return e.done;for(s.resetPendingUpdate(jT.MERGE);null!=a.parent&&0===a.parent.unmergableChildCount&&a.parent.resetPendingUpdate(jT.MERGE);)a=a.parent;this._mergeTile(a),n=!0,e.madeProgress()}else if(s.resetPendingUpdate(jT.SPLIT)){let t=!0;const i=s.level;if(i>=ou){const e=e=>e.isLeaf||i-e.level<ou;for(let r=0;r<4;++r){const n=s.findNeighborTile(ad[r],e);null!=n&&i-n.level===ou&&(t=!1,nd&&(Yh(n.isLeaf),Yh(n.hasPendingUpdate(jT.SPLIT))))}}t?(this._splitTile(s),e.madeProgress(),n=!0):s.setPendingUpdate(jT.SPLIT)}return e.done}));if(n&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),a){if(!i){i=!0;continue}if(!n)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(jT.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done))),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(pu.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*du}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Ft(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){null!=this._rootTiles&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return;const t=e.children.slice();e.unsetChildren();for(let e=0;e<4;++e)this._purgeTile(t[e])}_purgeTile(e){e.isLeaf?RR(e):this._purgeDescendantTiles(e),this._allTiles.removeUnordered(e),this._unloadTile(e),this._tileCache.put(mR._tileMemcacheKey,e)}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){ed(e.isLeaf,"Tile that is already split should not be split again!"),ed(e.rendered,"Tile marked to split is not rendered"),RR(e);const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2],s=e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e));this._allTiles.pushArray(s),e.updateAgentSuspension(),ed(e.rendered,"parent should be rendered"),this._unloadTile(e),s.forEach((e=>this._loadTile(e))),s.forEach((e=>this._pendingTilesToUpdate.add(e))),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),s.forEach((e=>PR(e,e.hasPendingUpdate(jT.SPLIT)))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){bR.spatialReference=this.spatialReference,bR.extent=e.extent,bR.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",bR)}_createTile(e,t,i,r){ed(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(jT.SPLIT),s}get _shortBatches(){return this.view.state.mode!==yh.IDLE}_mergeTile(e){ed(!e.hasPendingUpdate(jT.SPLIT),"_mergeTile sanity check"),ed(!e.isLeaf,"Cannot merge a leaf"),e.isLeaf||(this._purgeDescendantTiles(e),ed(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),PR(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,t,i){const r=new kC(e.lij,e.extent,i);e.dataArrived(t,Bb.ELEVATION,r);const s=[e],n=e.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){const e=a.next();e.findElevationBoundsForLayer(t,n),e.computeElevationBounds()}0===n&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=qo){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(let e=this.view.allLayerViews.length-1;e>=0;e--){const s=this.view.allLayerViews.items[e];if(i.add(s.uid),Sd(s)||Rd(s))if(this._basemapLayerViewHandles.has(s.uid)&&!Rd(s)){const e=this._layerClassFromLayerView(s),i=this._getLayerIdxByUID(e,s.uid);null!=i&&((i<r||null==r)&&(t=!0),r=i)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=0===this.view.map?.ground?.opacity;for(const t of this.view.allLayerViews.items)if(Od(t)&&!wt(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}_hasCompositeBlendMode(){for(const t of this.view.allLayerViews.items)if((id(t)||Rd(t))&&((e=TT[t.layer.blendMode])===fT.DestinationOver||e===fT.DestinationAtop||e===fT.DestinationIn||e===fT.DestinationOut||e===fT.SourceAtop||e===fT.SourceIn||e===fT.SourceOut||e===fT.Xor))return!0;var e;return!1}_layerClassFromLayerView(e){return Ed(e)?Bb.ELEVATION:Bb.MAP}_registerTiledLayerView(e){const t=[];if((id(e)||Rd(e))&&t.push(U((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(Gs.UNFADED)}))),!Rd(e)){const i=this._layerClassFromLayerView(e);t.push(U((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push(U((()=>e.fullOpacity),(()=>this._updateTileTextures(Gs.UNFADED)))),t.push(U((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);null!=t&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!Sd(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===Bb.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const e of Hb){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let n=i.length!==s;const a=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);a[t]=l,t!==l&&(n=!0),l>-1&&(o[l]=t)}if(n){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(o,a,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===Bb.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(Bb.MAP),e===Gs.IMMEDIATE?this.renderer.updateTileTexture(t,jT.TEXTURE_NOFADING):t.updateRenderData(Bb.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=pu.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||vd(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,m(r),h(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return t===Bb.ELEVATION?Ed(i)?this._requestElevationTileData(e,i,r):Promise.reject():Od(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{if(l(i))return;const s=this._layerIndexByUid[Bb.ELEVATION].get(t.uid);null!=s?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,s,r)):A.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",Bb.ELEVATION,e.lij.toString())},s=i=>{h(i)||(this._dataMissing(e,Bb.ELEVATION,t,i),this.requestUpdate())};if(Ad(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:tu,signal:i.signal}).then((e=>{if(!l(i))return this._frameTask.schedule((()=>r(e)),i.signal,s);A.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),s).finally((()=>{--this._asyncWorkItems}));const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:tu},i.signal))).then((e=>{e?r(new Yd(e)):s(new Error("LERC decoding failed"))}),s).finally((()=>{--this._asyncWorkItems}))}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,Kh(s),l(i)||(this._dataMissing(e,Bb.MAP,t,r),this.requestUpdate())},s=e=>t=>r(t,e),n=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),l(i)?Kh(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),a=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(vd(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(n,a)}if(Md(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,a);if(Dd(t)&&Ad(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(l(i))return A.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(o());n(e)}),a);let c=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);$d(t.layer)&&t.layer.refreshTimestamp&&(c+=`${c.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const h=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(c,h,i).then(n,a)}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(Bb.MAP,t.uid);null!=r?e.dataArrived(r,Bb.MAP,i):(Kh(i),A.getLogger(this).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i,r){const s=this._getLayerIdxByUID(t,i.uid);null!=s?e.dataMissing(s,t,r):A.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}get usedMemory(){return this.tilingScheme?(null==this._usedMemory&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce(((e,t)=>e+t.usedMemory),0)):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return null!=r&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(null==e||null==this._rootTiles)return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this._rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=t[0],r=t[1]>>i,s=t[2]>>i;let n;if(this._rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(n=e,!0))),n){let e=1<<t[0]-1;for(;n.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!n.children[i])return null;n=n.children[i],e>>=1}return ed(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{null!=e._rootTiles&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){xR.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&xR.push(e)}));const t=xR.toArray();return Ma(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}checkAllTilesWaterproofness(){if(!pd)return;const e=this._rootTiles;if(null==e)return;const t=e=>e?.renderData?.geometry?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometry&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometry||(e.renderData.geometry.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometry),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.isLeaf)for(const t of e.children)s(t)};for(const t of e)r(t),s(t)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&0===e[2]}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){Id(e)}enableWaterproofnessChecks(e){Ld(e)}};_R._tileMemcacheKey="TerrainTileMemcache",e([ae()],_R.prototype,"_renderer",void 0),e([ae({constructOnly:!0})],_R.prototype,"_scaleRangeQueries",void 0),e([ae({constructOnly:!0})],_R.prototype,"view",void 0),e([ae({constructOnly:!0})],_R.prototype,"overlayManager",void 0),e([ae()],_R.prototype,"_hasPendingUpdates",void 0),e([ae()],_R.prototype,"_asyncWorkItems",void 0),e([ae()],_R.prototype,"_allTilesDirty",void 0),e([ae()],_R.prototype,"_allTilesSorted",void 0),e([ae()],_R.prototype,"_viewChanged",void 0),e([ae()],_R.prototype,"_splitLimits",void 0),e([ae({readOnly:!0})],_R.prototype,"_watchUpdatingTracking",void 0),e([ae()],_R.prototype,"_frameTask",void 0),e([ae({readOnly:!0})],_R.prototype,"snapLevel",null),e([ae({readOnly:!0})],_R.prototype,"lodSnapping",null),e([ae()],_R.prototype,"_userClippingExtent",null),e([ae()],_R.prototype,"_rootTilesExtent",void 0),e([ae({readOnly:!0})],_R.prototype,"extent",null),e([ae({readOnly:!0})],_R.prototype,"groundExtent",null),e([ae({readOnly:!0})],_R.prototype,"_tilingSchemeExtent",null),e([ae({readOnly:!0})],_R.prototype,"updating",null),e([ae({readOnly:!0})],_R.prototype,"running",null),e([ae(Fa)],_R.prototype,"updatingProgress",void 0),e([ae({readOnly:!0})],_R.prototype,"updatingProgressValue",null),e([ae()],_R.prototype,"_maxNumUpdating",void 0),e([ae()],_R.prototype,"baseOpacity",null),e([ae()],_R.prototype,"hasCompositeBlendMode",void 0),e([ae({readOnly:!0})],_R.prototype,"viewingMode",null),e([ae()],_R.prototype,"maxTextureScale",void 0),e([ae({readOnly:!0})],_R.prototype,"ready",null),e([ae({value:Ea.FRONT_TO_BACK})],_R.prototype,"renderOrder",null),e([ae({readOnly:!0})],_R.prototype,"rootTiles",null),e([ae()],_R.prototype,"_rootTiles",void 0),e([ae({readOnly:!0})],_R.prototype,"spatialReference",null),e([ae({type:qh})],_R.prototype,"backgroundColor",null),e([ae({value:!1})],_R.prototype,"slicePlaneEnabled",null),e([ae({readOnly:!0})],_R.prototype,"tilingScheme",void 0),e([ae({readOnly:!0})],_R.prototype,"tilingSchemeLocked",null),e([ae({readOnly:!0})],_R.prototype,"tilingSchemeLogic",void 0),e([ae()],_R.prototype,"wireframe",null),e([ae({value:!1})],_R.prototype,"suspended",null),e([ae()],_R.prototype,"fadeDuration",null),e([ae()],_R.prototype,"visibleElevationBounds",void 0),e([ae()],_R.prototype,"rootTileElevationBounds",void 0),e([ae()],_R.prototype,"_layerViewsDirty",void 0),e([ae()],_R.prototype,"renderPatchBorders",null),e([ae()],_R.prototype,"visualizeNormals",null),e([ae()],_R.prototype,"renderingDisabled",null),_R=mR=e([le("esri.views.3d.terrain.TerrainSurface")],_R);const gR=_R,fR=we(),yR=vl(),vR=je(),xR=new Y,wR=new $l("ground"),bR={spatialReference:null,extent:null,scale:0};function CR(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}return zC(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class TR{constructor(e){this.capacity=e,this._head=0,this._tail=0,this._data=new Array(e)}push(e){const t=this._tail;if(!(t<this.capacity))throw new Error("Queue full");this._data[t]=e,this._tail=t+1}pushAll(e){const t=e.length;if(0===t)return;const i=this._tail;if(!(i+t<=this.capacity))throw new Error("Queue full");for(let r=0;r<t;++r)this._data[i+r]=e[r];this._tail=i+t}pop(){const e=this._head;if(e<this._tail){const t=this._data[e];return this._head=e+1,t}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}}function PR(e,t){!e.isLeaf||e.level<ou||ER(e,(e=>{t&&SR(e);const i=OR(e);if(e.maxLevelDeltaNeighborCount++,i){let t=e.parent;for(;t;){const e=OR(t);if(t.unmergableChildCount++,!e)break;t=t.parent}}}))}function SR(e){if(e.hasPendingUpdate(jT.SPLIT))return;let t=e.parent;for(;t&&t.resetPendingUpdate(jT.MERGE);)t=t.parent;e.resetPendingUpdate(jT.MERGE),e.isLeaf&&e.setPendingUpdate(jT.SPLIT),e.level<ou||ER(e,(e=>{SR(e)}))}function RR(e){e.level<ou||ER(e,(e=>{if(e.maxLevelDeltaNeighborCount--,0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount){let t=e.parent;for(;t&&(t.unmergableChildCount--,OR(t));)t=t.parent}}))}function OR(e){return 0===e.maxLevelDeltaNeighborCount&&0===e.unmergableChildCount}function ER(e,t){if(e.level<ou)return;const i=e.level-ou,r=e.lij[1]>>ou,s=e.lij[2]>>ou,n=e=>e.isLeaf||e.level===i;for(let a=0;a<4;++a){const o=e.findNeighborTile(ad[a],n);if(!o||o.level!==i)continue;const l=o.lij;l[1]===r&&l[2]===s||t(o)}}class AR{constructor(e,t,i,r){this.operation=e,this.geometry=t,this.states=i,this.sync=r}}let MR=class extends pe{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach((({geometry:e,operation:i,states:n},a)=>{let o=!1;if(i===en.UPDATE){const i=s.get(a);if(i){if(n&tn.TRANSFORMATION){const t=this.model.getObject(r);this.model.updateRenderGeometryTransformation(t,e,i)&&(o=!0)}o||t.updates.push({renderGeometry:i,updateType:n})}else il(!1,"ModelDirtySet.commitLayer: invalid update")}if(i===en.REMOVE||o){const e=s.get(a);e?(t.removes.push(e),s.delete(a)):i===en.REMOVE&&il(!1,"ModelDirtySet.commitLayer: invalid remove")}if(i===en.ADD||o){const i=this.model.getObject(r);if(null!=i){const r=this.model.getRenderGeometry(i,e);t.adds.push(r),s.set(a,r)}}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}commitSyncUpdates(e,t){const i=this._dirtyGeomRecords.get(e);i&&i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach((({geometry:e,operation:i,states:n,sync:a},o)=>{let l=!1;if(i===en.UPDATE&&a){const i=s.get(o);if(i){if(n&tn.TRANSFORMATION){const t=this.model.getObject(r);this.model.updateRenderGeometryTransformation(t,e,i)&&(l=!0)}l||t.updates.push({renderGeometry:i,updateType:n})}else il(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}}))}))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e)))))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,en.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(tn.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(tn.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(tn.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,null,en.UPDATE,tn.GEOMETRY,i)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const e of t.geometries)this._geometryAdded(t,e,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const e of t.geometries)this._geometryRemoved(t,e,i)}transformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i.geometry,t,en.UPDATE,tn.TRANSFORMATION)}))}shaderTransformationChanged(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((t=>{t.objectShaderTransformationChanged(e.shaderTransformation)}))}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,en.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,en.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r,s=tn.NONE,n=!1){i=i??this._getParentLayerId(e);const a=e.id,o=t.id,l=this._ensureDirtyRecord(i,a),c=l.get(o);if(c){const e=c.operation;e===en.REMOVE&&r===en.ADD&&c.states!==tn.NONE?c.operation=en.UPDATE:e===en.REMOVE&&r===en.ADD||e===en.ADD&&r===en.REMOVE?l.delete(o):e!==en.UPDATE||r!==en.REMOVE&&r!==en.UPDATE?(il((e===en.REMOVE||e===en.ADD)&&r===en.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=s):(c.operation=r,c.states|=s),c.sync=c.sync||n}else l.set(o,new AR(r,t,s,n));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return he(this._dirtyGeomRecords,(e=>he(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:ye}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const n=[];i.forEach((e=>{const t=e.operation;n[t]||(n[t]=[]),n[t].push(e.geometry.id)}));for(let i=0;i<n.length;i++)if(n[i]){t+=" "+e[i-1]+": ";for(let e=0;e<n[i].length;e++)t+=n[i][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)},commit:t=>e._dirtyGeomRecords.forEach(((i,r)=>e.commitLayer(r,t)))}}};e([ae({constructOnly:!0})],MR.prototype,"model",void 0),e([ae()],MR.prototype,"dirty",void 0),MR=e([le("esri.views.3d.webgl-engine.lib.ModelDirtySet")],MR);const DR=MR;let IR=class extends pe{constructor(){super(...arguments),this.dirtySet=new DR({model:this}),this._content=new Map,this._originFactory=new rn(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;il(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),Gu(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),Gu(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(const t of e)t&&(il(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)t&&(il(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const i=new sn(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,LR);const{localOrigin:r}=t;return i.localOrigin=null!=r?r:this._originFactory.getOrigin(yl(i.boundingSphere)),i}updateRenderGeometryTransformation(e,t,i){if(null==e)return!1;i.transformation=e.getCombinedStaticTransformation(t,LR);const r=this._originFactory.getOrigin(yl(i.boundingSphere));return i.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<Zu.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};e([ae({constructOnly:!0})],IR.prototype,"dirtySet",void 0),IR=e([le("esri.views.3d.webgl-engine.parts.Model")],IR);const LR=wr();class NR{constructor(e){this._totalCount=e,this._componentCountCache=-1,this._indexRanges=[0,e]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return 0===this._indexRanges.length}isVisible(e){if(e<0||e>=this._totalCount)return!1;if(this.allVisible())return!0;{const t=this._indexRanges;let i=0,r=t.length/2;if(e<t[2*i]||e>t[2*r]+t[2*r+1])return!1;for(;r-i>0;){const s=Math.floor(.5*(i+r)),n=t[2*s];if(e<n){if(r-i==1)return!1;r=s}else{if(e<n+t[2*s+1])return!0;if(r-i==1)return!1;i=s+1}}return!1}}get componentCount(){if(-1===this._componentCountCache){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];this._componentCountCache=t}return this._componentCountCache}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}(e),this._componentCountCache=-1}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1],a=e[s],o=e[n];t[r]=a,t[r+1]=o-a}return t}}let FR=class{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const i=this.count;this.visibility=new NR(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return null==this.cachedGeometryRanges&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return null==this.highlightCounts?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return null==this.highlightCounts?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((null==this.cachedHighlightRanges||null==this.cachedDefaultRanges)&&null!=this.highlightCounts){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const r=[],s=[];let n=i.length,a=i.length;return t.forEachComponent((t=>(e[t]>0?(n!==t-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[t])),n=t):(a!==t-1&&(s.length&&s.push(i[a+1]-s[s.length-1]),s.push(i[t])),a=t),!0))),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[a+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}};class VR{constructor(e,t,i,r,s,n){this.transform=e,this.toMapSpace=t,this.obb=i,this.components=r,this.renderable=s,this.intersectionGeometry=n,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=D(this.intersectionGeometry),this.renderable=D(this.renderable),this.components=D(this.components)}}function UR(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let n=e.data;const a=kR(n),o=i/a|0,l=i-a*o,c=(t-1)/a|0,h=n,d=r===s;if(!(i<h.length*a)&&d){const e=o+1,t=Math.ceil(h.length*S),i=c+1;let r=Math.max(e,t);r=Math.min(r,i),n=new Uint32Array(r),n.set(h)}return o<n.length&&(n[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(n[o],l,d)),e.data=n,e}function jR(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=kR(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,n=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],n)===e}(i,r,t,s):!e.isVisibleBit}function kR(e){return 8*e.BYTES_PER_ELEMENT}class qR{constructor(e,t,i){this.viewingMode=e,this.positionData=t,this._components=i,this._planetCenter=we(),this._planetNorth=we(),this._componentIndicesForBsp=null,this._componentBspNodes=[],this._aabb=[0,0,0,0,0,0],this._indices=t.indices?Ku(t.indices):Ju(t.positions.length/3),this._positions=t.positions,this._componentIntersectionData=new Array(i.count)}destroy(){this._positions=null,this._indices=null,this._componentIntersectionData.length=0,this._perComponentAabbs=null}getComponentAabb(e,t){const i=this._ensureComponentAabbs();for(let r=0;r<6;r++)t[r]=i[6*e+r];return t}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,n,a,o){const{position:l}=a,c=Ci(WR,e,l),h=Ci($R,t,l),d=bo(QR,a.rotationScale);Oi(c,c,d),Oi(h,h,d);const u=wo(XR,d),p=new zu(this._positions,3),m=this._indices,_=this._components.offsets,g=Vn(c,h,BR);if(this.viewingMode===Mt.Global){const e=this._planetCenter;Ai(e,l),Oi(e,e,d);const t=this._planetNorth;ui(t,0,0,1),Oi(t,t,d),_i(t,t)}const f=Ti(YR,c),y=Ti(ZR,h),v=Ci(KR,h,c);_i(v,v),this._intersectComponents((e=>{const t=this.getComponentAabb(e,HR);if(null!=s){const t=s[e];null==r||o?(c[2]=f[2]-t,h[2]=y[2]-t):r.componentOffset=t}if(null==r||o||r.applyToAabb(t),!Un(t,c,g,i))return;const a=_[e]/3,l=_[e+1]/3,d=(t,i,r)=>n(e,t,Oi(i,i,u),r);(null==r||o)&&l-a>200?(null==this._componentIntersectionData[e]&&(this._componentIntersectionData[e]=new KS(this._indices,a,l,p)),this._componentIntersectionData[e].intersectRay(c,h,d)):Fn(c,h,a,l,m,p,void 0,r,d)}),o,c,h)}_intersectComponents(e,t,i,r){const s=this._components.pickability,n=this._components.visibility;if(this._components.visibility.componentCount<aO){const t=t=>(jR(s,t)&&e(t),!0);return void n.forEachComponent(t)}0===this._componentBspNodes.length&&this._generateComponentBspRoot();const a=this._componentIndicesForBsp,o=(t,i)=>{for(let o=t;o<i;++o)r=a[o],jR(s,r)&&n.isVisible(r)&&e(r);var r};if(t){let e=0;for(;e>=0;){const t=this._componentBspNodes[e],r=t.plane;if(!r||-1===t.child0&&-1===t.child1){o(t.minComponentIndexIndex,t.maxComponentIndexIndex);break}{o(t.minMidComponentIndexIndex,t.maxMidComponentIndexIndex);const s=gi(r,i)-r[3];if(s<0){if(-1===t.child0){o(t.minComponentIndexIndex,t.minMidComponentIndexIndex);break}e=t.child0}else{if(!(s>0))break;if(-1===t.child1){o(t.maxMidComponentIndexIndex,t.maxComponentIndexIndex);break}e=t.child1}}}}else{const e=oO;Ci(e,r,i),_i(e,e);const t=this._componentBspNodes,s=r=>{const n=t[r],a=n.plane;if(!a||-1===n.child0&&-1===n.child1)o(n.minComponentIndexIndex,n.maxComponentIndexIndex);else{const t=gi(a,i)-a[3],r=gi(a,e);n.minComponentIndexIndex<n.minMidComponentIndexIndex&&(t<=0||r<0)&&(-1!==n.child0?s(n.child0):o(n.minComponentIndexIndex,n.minMidComponentIndexIndex)),o(n.minMidComponentIndexIndex,n.maxMidComponentIndexIndex),n.maxMidComponentIndexIndex<n.maxComponentIndexIndex&&(t>=0||r>0)&&(-1!==n.child1?s(n.child1):o(n.maxMidComponentIndexIndex,n.maxComponentIndexIndex))}};s(0)}}_generateComponentBspRoot(){const e=this._components.count,t=new Uint16Array(e);this._componentIndicesForBsp=t;for(let i=0;i<e;++i)t[i]=i;const i=this._ensureComponentAabbs(),r=this._planetCenter,s=this._planetNorth,n=tO;Ai(n,r),_i(n,n),wi(iO,s,n);const a=this._aabb,o=a[2],l=[];let c=0;const h=this._componentBspNodes;h.length=0;const d=(e,t)=>{const r=6*e,s=i[r],n=i[r+1],a=i[r+2],o=i[r+3],l=i[r+4],c=i[r+5],h=ui(rO,.5*(s+o),.5*(n+l),.5*(a+c)),d=.5*(o-s),u=.5*(l-n),p=.5*(c-a),m=Math.sqrt(d*d+u*u+p*p),_=t,g=t[3],f=gi(_,h)-g;return Math.abs(f)>m?Math.sign(f):0},u=this.viewingMode===Mt.Local;let p=!1;if(!u){const e=ui(rO,.5*(a[0]+a[3]),.5*(a[1]+a[4]),.5*(a[2]+a[5])),t=Di(r,e);p=o>.5*t}const m=(e,n,a,o,c)=>{const _=h.length;let g;if(p||a>=nO||n-e<sO)g=new zR(e,n,n,n,null);else{((e,r,s)=>{let n=1/0,a=1/0,o=1/0,l=-1/0,c=-1/0,h=-1/0;for(let e=r;e<s;++e){const r=6*t[e];n=Math.min(n,i[r]),l=Math.max(l,i[r+3]),a=Math.min(a,i[r+1]),c=Math.max(c,i[r+4]),o=Math.min(o,i[r+2]),h=Math.max(h,i[r+5])}e[0]=n,e[1]=a,e[2]=o,e[3]=l,e[4]=c,e[5]=h})(GR,e,n);const o=GR[0],c=GR[1],h=GR[2],p=GR[3],f=GR[4],y=p-o,v=f-c,x=tr(),w=x;if(u)y>=v?(ui(w,1,0,0),x[3]=-.5*(o+p)):(ui(w,0,1,0),x[3]=-.5*(c+f));else{const e=JR,t=eO;ui(e,.5*(o+p),.5*(c+f),h),Ci(e,e,r),_i(e,e),wi(t,e,s),_i(t,t),y>=v?Ti(w,t):(wi(w,t,e),_i(w,w)),x[3]=gi(w,r)}let b,C;{let i=e,r=n;for(;i<r;){const e=t[i];d(e,x)<0?++i:(--r,t[i]=t[r],t[r]=e)}b=i;let s=i;for(r=n;s<r;){const e=t[r-1];d(e,x)>0?--r:(t[r-1]=t[s],t[s]=e,++s)}C=r}g=new zR(e,b,C,n,x),b>=e+sO&&l.push((()=>m(e,b,a+1,_,!0))),n>=C+sO&&l.push((()=>m(C,n,a+1,_,!1)))}if(h.push(g),-1!==o){const e=h[o];c?e.child0=_:e.child1=_}};for(l.push((()=>m(0,e,0,-1,!1)));c<l.length;)(0,l[c])(),++c}_computePerComponentAabbs(){const e=this._components.count,t=ss(6*e),i=this._indices,r=this._positions,s=this._components.offsets;let n=0,a=1/0,o=1/0,l=1/0,c=-1/0,h=-1/0,d=-1/0;for(let u=0;u<e;u++){const e=s[u],p=s[u+1];let m=1/0,_=1/0,g=1/0,f=-1/0,y=-1/0,v=-1/0;for(let t=e;t<p;t++){const e=3*i[t],s=r[e],n=r[e+1],a=r[e+2];m=Math.min(m,s),_=Math.min(_,n),g=Math.min(g,a),f=Math.max(f,s),y=Math.max(y,n),v=Math.max(v,a)}t[n++]=m,t[n++]=_,t[n++]=g,t[n++]=f,t[n++]=y,t[n++]=v,a=Math.min(a,m),o=Math.min(o,_),l=Math.min(l,g),c=Math.max(c,f),h=Math.max(h,y),d=Math.max(d,v)}return this._aabb[0]=a,this._aabb[1]=o,this._aabb[2]=l,this._aabb[3]=c,this._aabb[4]=h,this._aabb[5]=d,t}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}}class zR{constructor(e,t,i,r,s){this.minComponentIndexIndex=e,this.minMidComponentIndexIndex=t,this.maxMidComponentIndexIndex=i,this.maxComponentIndexIndex=r,this.plane=s,this.child0=-1,this.child1=-1}}const BR=we(),HR=bu(),GR=[0,0,0,0,0,0],WR=we(),$R=we(),QR=Oo(),XR=Oo(),YR=we(),ZR=we(),KR=we(),JR=we(),eO=we(),tO=we(),iO=we(),rO=we(),sO=5,nO=10,aO=7,oO=we();let lO=class{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}};class cO{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}}class hO{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}}function dO(e){return e?uO(e,1/0,-1/0):{near:1/0,far:-1/0}}function uO(e,t,i){return e.near=t,e.far=i,e}function pO(e,t){null!=t&&(e.near=Math.min(e.near,t.near),e.far=Math.max(e.far,t.far))}function mO(e,t){return e.near<=t&&t<=e.far}const _O={near:0,far:0},gO=new Y({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),fO=dO(),yO=we(),vO=we(),xO=new Y({deallocator:null}),wO=new Y({deallocator:null});function bO(e,t,i){i.length=0;const r=t.length-3;CO(yO,t,r);const s=Ul(e,yO);s<=0&&(i.push(yO[0]),i.push(yO[1]),i.push(yO[2]));let n=0,a=s;for(;n<r;n+=3){CO(vO,t,n);const r=Ul(e,vO);a*r<0&&(yi(yO,vO,yO,r/(r-a)),TO(i,yO)),r<=0&&TO(i,vO),a=r,Ti(yO,vO)}a*s<0&&(CO(vO,t,r),yi(yO,vO,yO,s/(s-a)),TO(i,yO))}function CO(e,t,i){return ui(e,t.data[i],t.data[i+1],t.data[i+2])}function TO(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function PO(e,t,i,r){sp(OO,e.quaternion),Ci(EO,t,e.center),Vi(EO,EO,OO);const s=e.halfSize,n=8*((EO[0]<-s[0]?-1:EO[0]>s[0]?1:0)+3*(EO[1]<-s[1]?-1:EO[1]>s[1]?1:0)+9*(EO[2]<-s[2]?-1:EO[2]>s[2]?1:0)+13),a=SO[n];if(0===a)return a;Co(RO,e.quaternion),To(RO,RO,e.halfSize);const o=(t,i)=>{const r=SO[n+i+1];return ui(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),Oi(t,t,RO),vi(t,e.center,t)};return i.length=0,TO(i,o(AO,0)),TO(i,o(MO,1)),TO(i,o(EO,2)),TO(i,o(DO,3)),r(i),1===a||(i.length=0,TO(i,AO),TO(i,DO),TO(i,o(EO,4)),TO(i,o(IO,5)),r(i),2===a||(i.length=0,TO(i,AO),TO(i,IO),TO(i,o(EO,6)),TO(i,MO),r(i))),a}const SO=(()=>{const e=new Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),RO=Oo(),OO=np(),EO=we(),AO=we(),MO=we(),DO=we(),IO=we();class LO{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=dO(),{eye:r,frustum:s,viewForward:n}=e;t.forAll((e=>{const t=null!=e.offsetObb?e.offsetObb:e.obb,a=gi(Ci(EO,t.center,r),n),o=t.projectedRadius(n);if(mO(i,a-o)&&mO(i,a+o))return;const l=function(e,t){let i=0;for(let r=0;r<4;r++){const s=e.intersectPlane(t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return fO.far=a+o,fO.near=a-o,void pO(i,fO);const c=gO.pushNew();c.near=a-o,c.far=a+o,c.mask=l,c.object=e}));for(let e=0;e<gO.length;e++){const t=gO.data[e];if(mO(i,t.near)&&mO(i,t.far))continue;fO.far=t.far,fO.near=1/0;const a=PO(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,r,xO,(e=>{let i=wO;for(let r=0;r<4&&e.length>0;r++){if(0==(t.mask&1<<r))continue;bO(s[r],e,i);const n=e;e=i,i=n}for(let t=0;t<e.length;t+=3){ui(yO,e.data[t],e.data[t+1],e.data[t+2]);const i=gi(Ci(yO,yO,r),n);fO.near=Math.min(fO.near,i)}}));0===a&&(fO.near=0),pO(i,fO)}return gO.length=0,i}(e,this._objects.visibleObjects):null}}class NO{constructor(){this.externalColor=tr(),this.externalColorMixMode=tp.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}class FO extends ls{constructor(e,t){super(e,"int",hp.Draw,((i,r,s)=>i.setUniform1i(e,t(r,s))))}}var VO;!function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"}(VO||(VO={}));function UO(e,t){lp(e/429496.7296*.5+.5,t)}function jO(e,t){switch(t.componentData){case VO.Varying:return function(e,t){const{vertex:i,fragment:r}=e;i.include(es),i.uniforms.add(new Fr("componentColorTex",(e=>e.componentParameters.texture.texture))),e.attributes.add(Sn.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const s=t.output===ds.ObjectAndLayerIdColor;s&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(lo),i.constants.add("elevationScale","float",858993.4592),i.constants.add("stride","float",b("enable-feature:objectAndLayerId-rendering")?3:2),i.code.add(Tn`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),i.code.add(Tn`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?Tn`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
          }`:Tn`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),r.code.add(Tn`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?Tn`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}(e,t);case VO.Uniform:return function(e){const{vertex:t,fragment:i}=e;t.uniforms.add(new nn("externalColor",(e=>e.componentParameters.externalColor))),i.uniforms.add(new FO("externalColorMixMode",(e=>e.componentParameters.externalColorMixMode))),e.varyings.add("vExternalColor","vec4"),t.code.add(Tn`float readElevationOffset() {
return 0.0;
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),i.code.add(Tn`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}`)}(e);case VO.COUNT:return;default:ni(t.componentData)}}var kO,qO;function zO(e,t){const i=e.vertex;switch(i.code.add(Tn`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case kO.None:i.code.add(Tn`#define vertexDiscardByOpacity(_opacity_) {}`);break;case kO.Opaque:i.code.add(Tn`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case kO.Transparent:i.code.add(Tn`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case kO.COUNT:break;default:ni(t.vertexDiscardMode)}}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}(kO||(kO={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(qO||(qO={}));class BO extends pa{constructor(){super(...arguments),this.output=ds.Color,this.textureCoordinateType=Pr.None,this.componentData=VO.Uniform,this.cullFace=_u.Back,this.vertexDiscardMode=kO.None,this.doubleSidedMode=co.WindingOrder,this.alphaDiscardMode=gu.Opaque,this.integratedMeshMode=qO.None,this.transparencyPassType=aa.NONE,this.ellipsoidMode=Va.Earth,this.pbrMode=Rr.Disabled,this.normalType=Nr.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}}function HO(e,t){e.include($o,t),e.fragment.include(ho);const i=e.fragment;i.uniforms.add(new nn("baseColor",(e=>e.baseColor))),i.uniforms.add(new uo("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(Tn`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(Tn`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(Tn`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function GO(e,t){const i=e.fragment;switch(t.doubleSidedMode){case co.None:i.code.add(Tn`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case co.View:e.include(ws,t),i.code.add(Tn`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case co.WindingOrder:i.code.add(Tn`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:ni(t.doubleSidedMode);case co.COUNT:}switch(t.normalType){case Nr.Attribute:case Nr.Compressed:e.include(Vr,t),i.code.add(Tn`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Nr.ScreenDerivative:e.include(ws,t),i.code.add(Tn`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Nr.Ground:t.spherical?(e.include(ws,t),i.code.add(Tn`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):i.code.add(Tn`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),i.code.add(Tn`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:ni(t.normalType);case Nr.COUNT:}}function WO(e,t){const i=e.fragment;if(!t.hasColorTexture||t.output!==ds.Color&&t.alphaDiscardMode===gu.Opaque)i.code.add(Tn`vec4 readBaseColorTexture() { return vec4(1.0); }`);else{e.include(Ur,t);const r=t.textureCoordinateType===Pr.Atlas;i.uniforms.add(new Fr("baseColorTexture",(e=>e.texture))),r?(e.include(jr),i.code.add(Tn`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);
}`)):i.code.add(Tn`vec4 readBaseColorTexture() {
return texture(baseColorTexture, vuv0);
}`)}}e([ua({count:ds.COUNT})],BO.prototype,"output",void 0),e([ua({count:Pr.COUNT})],BO.prototype,"textureCoordinateType",void 0),e([ua({count:VO.COUNT})],BO.prototype,"componentData",void 0),e([ua({count:_u.COUNT})],BO.prototype,"cullFace",void 0),e([ua({count:kO.COUNT})],BO.prototype,"vertexDiscardMode",void 0),e([ua({count:co.COUNT})],BO.prototype,"doubleSidedMode",void 0),e([ua({count:gu.COUNT})],BO.prototype,"alphaDiscardMode",void 0),e([ua({count:qO.COUNT})],BO.prototype,"integratedMeshMode",void 0),e([ua({count:aa.COUNT})],BO.prototype,"transparencyPassType",void 0),e([ua({count:Va.COUNT})],BO.prototype,"ellipsoidMode",void 0),e([ua({count:Rr.COUNT})],BO.prototype,"pbrMode",void 0),e([ua({count:Nr.COUNT})],BO.prototype,"normalType",void 0),e([ua()],BO.prototype,"spherical",void 0),e([ua()],BO.prototype,"doublePrecisionRequiresObfuscation",void 0),e([ua()],BO.prototype,"hasVertexColors",void 0),e([ua()],BO.prototype,"hasNormals",void 0),e([ua()],BO.prototype,"hasSlicePlane",void 0),e([ua()],BO.prototype,"hasColorTexture",void 0),e([ua()],BO.prototype,"receiveAmbientOcclusion",void 0),e([ua()],BO.prototype,"receiveShadows",void 0),e([ua()],BO.prototype,"blendingEnabled",void 0),e([ua()],BO.prototype,"hasScreenSpaceReflections",void 0),e([ua()],BO.prototype,"hasPolygonOffset",void 0),e([ua()],BO.prototype,"hasMetallicRoughnessTexture",void 0),e([ua()],BO.prototype,"hasEmissionTexture",void 0),e([ua()],BO.prototype,"hasOcclusionTexture",void 0),e([ua()],BO.prototype,"hasNormalTexture",void 0),e([ua()],BO.prototype,"hasOccludees",void 0),e([ua()],BO.prototype,"multipassEnabled",void 0),e([ua()],BO.prototype,"cullAboveGround",void 0),e([ua()],BO.prototype,"hasCloudsReflections",void 0),e([ua()],BO.prototype,"snowCover",void 0),e([ua()],BO.prototype,"objectAndLayerIdColor",void 0),e([ua({constValue:!1})],BO.prototype,"occlusionPass",void 0),e([ua({constValue:hp.Draw})],BO.prototype,"pbrTextureBindType",void 0),e([ua({constValue:!0})],BO.prototype,"hasSliceHighlight",void 0),e([ua({constValue:!1})],BO.prototype,"hasSliceInVertexProgram",void 0),e([ua({constValue:!1})],BO.prototype,"useCustomDTRExponentForWater",void 0),e([ua({constValue:!1})],BO.prototype,"hasVertexTangents",void 0),e([ua({constValue:!0})],BO.prototype,"supportsTextureAtlas",void 0),e([ua({constValue:!1})],BO.prototype,"highStepCount",void 0),e([ua({constValue:!1})],BO.prototype,"instancedDoublePrecision",void 0),e([ua({constValue:!1})],BO.prototype,"hasModelTransformation",void 0),e([ua({constValue:!0})],BO.prototype,"useFillLights",void 0),e([ua({constValue:!1})],BO.prototype,"objectAndLayerIdColorInstanced",void 0);const $O=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new qr;t.include(ws,e),t.include(Vr,e),t.include($o,e),t.include(Tr,e),t.include(gs,e),t.include(jO,e),t.include(po,e),t.include(bs,e),t.include(WO,e),t.include(zO,e);const{vertex:i,fragment:r}=t;e.pbrMode!==Rr.Normal&&e.pbrMode!==Rr.Schematic||(t.include(kr,e),e.hasNormalTexture&&t.include(mo,e));const s=e.output===ds.Shadow||e.output===ds.ShadowHighlight||e.output===ds.ShadowExcludeHighlight;s&&e.componentData===VO.Varying?i.code.add(Tn`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):i.code.add(Tn`#define discardShadows(castShadows) {}`);const n=e.integratedMeshMode===qO.ColorOverlay||e.integratedMeshMode===qO.ColorOverlayWithWater,a=n&&e.output===ds.Color&&e.pbrMode===Rr.WaterOnIntegratedMesh;return n&&(t.include(ro,e),t.include(an,e),e.spherical?i.code.add(Tn`
      const float invEllipsoidRadius = ${Tn.float(1/(e.ellipsoidMode===Va.Earth?Ht.radius:e.ellipsoidMode===Va.Mars?Kt.radius:Jt.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):i.code.add(Tn`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),a&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add(Tn`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${e.output===ds.ObjectAndLayerIdColor?Tn`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${Tn.float(Cs)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${e.output===ds.ObjectAndLayerIdColor?Tn`forwardObjectAndLayerIdColor();`:""}
      ${a?e.spherical?Tn`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:Tn`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${n?Tn`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),e.output===ds.Alpha&&(r.include(Qr),t.include(Ts,e),t.include(HO,e),n&&r.uniforms.add(new $r("ovColorTex",((e,t)=>on(e,t)))),r.code.add(Tn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassEnabled?Tn`terrainDepthTest(vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?Tn`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        fragColor = vec4(materialColor.a);
      }
    `)),e.output===ds.Color&&(r.include(Qr),t.include(Ts,e),t.include(HO,e),t.include(GO,e),t.include(ro,e),e.receiveShadows?(t.include(_o,e),r.code.add(Tn`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(Tn`float evaluateShadow() { return 0.0; }`),n&&r.uniforms.add(new $r("ovColorTex",((e,t)=>on(e,t)))),r.code.add(Tn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.multipassEnabled?Tn`terrainDepthTest(vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?Tn`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),e.pbrMode===Rr.Normal||e.pbrMode===Rr.Schematic||e.pbrMode===Rr.Simplified?(Lr(r),r.code.add(Tn`
        ${e.pbrMode===Rr.Normal?Tn`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),e.hasNormalTexture?r.code.add(Tn`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(Tn`vec3 shadingNormal = normalVertex;`),r.code.add(Tn`${e.spherical?Tn`vec3 normalGround = normalize(positionWorld());`:Tn`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(Tn`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        ${e.pbrMode===Rr.Simplified?Tn` float ssao = 1.0 - evaluateAmbientOcclusionInverse();`:Tn` float ssao = 1.0 - occlusion * evaluateAmbientOcclusionInverse();`}
        ${e.snowCover?Tn`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1.1), snow);
                ssao = mix(ssao, 0.5 * ssao, snow);
                shadingNormal = mix(shadingNormal, surfaceNormal, snow);`:""}

        ${n?Tn` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        ${e.pbrMode===Rr.Simplified?Tn` vec4 shadedColor = vec4(evaluatePBRSimplifiedLighting(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround), materialColor.a);`:"vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);"}
        `)):(e.receiveShadows?r.code.add(Tn`float shadow = evaluateShadow();`):e.spherical?(oo(r),r.code.add(Tn`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(Tn`float shadow = 0.0;`),a&&r.uniforms.add(new $r("ovNormalTex",((e,t)=>t.overlay?.getTexture(Qs.WaterNormal)))),e.snowCover&&r.code.add(Tn`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`),r.code.add(Tn`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${n?Tn` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${a?Tn`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(Tn`
        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.transparencyPassType===aa.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `)),(e.output===ds.LinearDepth||s)&&(t.include(ps,e),r.code.add(Tn`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===ds.Normal&&(t.include(GO,e),r.code.add(Tn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material to influence ambient occlusion,
        // see the ssao fragment shader
        float alpha = ${e.normalType===Nr.Ground?"0.0":"1.0"};
        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===ds.ObjectAndLayerIdColor&&t.fragment.code.add(Tn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?Tn`fragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),e.output===ds.Highlight&&(t.include(Wo),r.code.add(Tn`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?Tn`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  fragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),t}},Symbol.toStringTag,{value:"Module"}));class QO extends Xr{initializeConfiguration(e,t){t.spherical=e.viewingMode===Mt.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Yr(e.rctx,QO.shader.get().build(this.configuration),XO)}_setPipelineState(e){const t=this.configuration,i=t.integratedMeshMode!==qO.None,r=e===aa.NONE,s=e===aa.FrontFace;return ea({blending:t.output!==ds.Color&&t.output!==ds.Alpha||!t.blendingEnabled?null:r?oa:la(e),culling:ca(t.cullFace),depthTest:{func:ha(e)},depthWrite:r||s?na:null,colorWrite:ia,stencilWrite:i||t.hasOccludees?Ps:null,stencilTest:i?Ss(mu.IntegratedMeshMaskExcluded):t.hasOccludees?Rs:null,polygonOffset:r||s?t.hasPolygonOffset?{factor:2,units:2}:null:da})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}QO.shader=new Zr($O,(()=>Promise.resolve().then((()=>$O))));const XO=new Map([[Sn.POSITION,0],[Sn.NORMAL,1],[Sn.NORMALCOMPRESSED,1],[Sn.COLOR,2],[Sn.UV0,3],[Sn.UVREGION,4],[Sn.COMPONENTINDEX,5]]);class YO extends Pn{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class ZO{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function KO(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=e;else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function JO(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}class eE{constructor(e){this._low=we(),this._high=we(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){Ti(this._low,Ti(tE,e));const t=Ci(tE,e,this._low);Ti(this._high,t)}get(e){return vi(e,this._low,this._high)}getLowScaled(e){return fi(e,this._low,1)}}const tE=Ro();class iE extends YO{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=rr(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Se(go),this.emissiveFactor=xe(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new nE,this.componentParameters=new aE,this.textureAlphaCutoff=Os,this.alphaDiscardMode=gu.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=Va.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new BO;const i=new eE(e.position),r=ap(e.rotationScale);bo(r,r),this.transformNormalGlobalFromModel=Eo(wo(r,r)),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=L(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return null!=this.baseColorTexture?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return null!=this.metallicRoughnessTexture?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return null!=this.emissionTexture?this.emissionTexture.glTexture:null}get textureOcclusion(){return null!=this.occlusionTexture?this.occlusionTexture.glTexture:null}get textureNormal(){return null!=this.normalTexture?this.normalTexture.glTexture:null}prepareTechnique(e,t,i,r){const s=this._techniqueConfiguration;s.hasVertexColors=r.colors,s.hasNormals=r.hasNormals,s.textureCoordinateType=r.textureCoordinates,s.hasMetallicRoughnessTexture=null!=this.metallicRoughnessTexture,s.hasEmissionTexture=null!=this.emissionTexture,s.hasOcclusionTexture=null!=this.occlusionTexture,s.hasNormalTexture=null!=this.normalTexture,s.transparencyPassType=t.identifier===ln.Material&&null!=i.transparencyPassType?i.transparencyPassType:aa.NONE,s.multipassEnabled=t.identifier===ln.Material&&i.multipassEnabled,s.cullAboveGround=t.identifier===ln.Material&&i.multipassTerrain.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?co.View:co.None,s.hasColorTexture=null!=this.baseColorTexture;const n=this._computeWhichMaterialPass();if(s.blendingEnabled=n===rE.Transparent||n===rE.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return null!=e.overlay?.getTexture(Qs.ColorNoRasterImage)}(i)?function(e){return null!=e.overlay?.getTexture(Qs.WaterNormal)}(i)?qO.ColorOverlayWithWater:qO.ColorOverlay:qO.NoOverlay:qO.None,s.hasPolygonOffset=this.polygonOffsetEnabled,s.pbrMode=s.integratedMeshMode===qO.ColorOverlayWithWater?Rr.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?b("enable-feature:im-shading")&&this.isIntegratedMesh?Rr.Simplified:Rr.Schematic:Rr.Normal:Rr.Disabled,s.normalType=r.needsNormals?s.hasNormals?Nr.Compressed:Nr.ScreenDerivative:Nr.Ground,s.hasSlicePlane=null!=i.slicePlane&&this.commonMaterialParameters.hasSlicePlane,t.identifier===ln.ShadowMap)s.output=ds.Shadow,s.vertexDiscardMode=kO.None;else if(t.identifier===ln.Highlight)s.output=ds.Highlight,s.vertexDiscardMode=kO.None;else{switch(n===rE.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?kO.Opaque:kO.Transparent:s.vertexDiscardMode=kO.None,s.output=t.output,s.receiveAmbientOcclusion=!1,s.receiveShadows=!1,t.output){case ds.Color:s.receiveAmbientOcclusion=null!=i.ssao,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.hasScreenSpaceReflections=null!=i.ssr.lastFrameColor,s.hasCloudsReflections=null!=i.cloudsFade.data;break;case ds.Alpha:s.hasOccludees=i.hasOccludees;break;case ds.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(QO,s,this._technique),this._setClean(),this._technique}hasSnowCover(e){return null!=e.weather&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(0===this.objectOpacity)return;const r=i.renderable.geometry,s=i.components,n=i.renderable.meta.cameraDepthSquared,a=s.geometryRanges,o=s.highlightRanges,l=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case rE.Opaque:e.materialOpaque.submitDraw(this,r,a,n);break;case rE.Transparent:e.materialTransparent.submitDraw(this,r,a,n);break;case rE.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,r,a,n),e.materialTransparent.submitDraw(this,r,a,n);break;case rE.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,r,a,n),function(e){return null!=e.overlay?.getTexture(Qs.Highlight)}(t)&&e.highlightIntegratedMesh.submitDraw(this,r,a,n)}const c=this.componentParameters.castShadows!==sE.None;c&&e.shadowMap.submitDraw(this,r,a,n),null!=o&&(e.highlight.submitDraw(this,r,o,n),c&&e.highlightShadowMap.submitDraw(this,r,o,n)),c&&null!=l&&e.defaultShadowMap.submitDraw(this,r,l,n)}_computeWhichMaterialPass(){return this.isIntegratedMesh?rE.IntegratedMesh:this.objectOpacity<1?rE.Transparent:this.componentParameters.opaqueOverride===sE.All?rE.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===gu.Blend||this.alphaDiscardMode===gu.MaskBlend?rE.Transparent:this.componentParameters.transparent===sE.None?rE.Opaque:this.componentParameters.transparent===sE.All?rE.Transparent:rE.OpaqueAndTransparent}}var rE,sE;e([KO({vectorOps:Ki})],iE.prototype,"baseColor",void 0),e([KO()],iE.prototype,"usePBR",void 0),e([KO()],iE.prototype,"hasParametersFromSource",void 0),e([KO({vectorOps:Ui})],iE.prototype,"mrrFactors",void 0),e([KO({vectorOps:Ui})],iE.prototype,"emissiveFactor",void 0),e([KO({dispose:!0})],iE.prototype,"baseColorTexture",void 0),e([KO({dispose:!0})],iE.prototype,"metallicRoughnessTexture",void 0),e([KO({dispose:!0})],iE.prototype,"emissionTexture",void 0),e([KO({dispose:!0})],iE.prototype,"occlusionTexture",void 0),e([KO({dispose:!0})],iE.prototype,"normalTexture",void 0),e([KO()],iE.prototype,"objectOpacity",void 0),e([JO()],iE.prototype,"commonMaterialParameters",void 0),e([JO()],iE.prototype,"componentParameters",void 0),e([KO()],iE.prototype,"textureAlphaCutoff",void 0),e([KO()],iE.prototype,"alphaDiscardMode",void 0),e([KO()],iE.prototype,"isIntegratedMesh",void 0),e([KO()],iE.prototype,"polygonOffsetEnabled",void 0),e([KO()],iE.prototype,"ellipsoidMode",void 0),e([KO()],iE.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(rE||(rE={}));class nE extends ZO{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=_u.Back,this.hasSlicePlane=!0}}e([KO()],nE.prototype,"doubleSided",void 0),e([KO()],nE.prototype,"cullFace",void 0),e([KO()],nE.prototype,"hasSlicePlane",void 0);class aE extends ZO{constructor(){super(...arguments),this.externalColor=rr(1,1,1,1),this.externalColorMixMode=tp.Multiply,this.castShadows=sE.All}get transparent(){return this.externalColor[3]<1?sE.All:sE.None}get opaqueOverride(){return this.externalColorMixMode===tp.Replace&&1===this.externalColor[3]?sE.All:sE.None}get visible(){return this.externalColor[3]>0?sE.All:sE.None}get type(){return VO.Uniform}}e([KO({vectorOps:Ki})],aE.prototype,"externalColor",void 0),e([KO()],aE.prototype,"externalColorMixMode",void 0),e([KO()],aE.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(sE||(sE={}));class oE extends ZO{constructor(){super(...arguments),this.texture=null,this.transparent=sE.None,this.opaqueOverride=sE.None,this.castShadows=sE.None}get type(){return VO.Varying}}e([KO()],oE.prototype,"texture",void 0),e([KO()],oE.prototype,"transparent",void 0),e([KO()],oE.prototype,"opaqueOverride",void 0),e([KO()],oE.prototype,"castShadows",void 0);class lE{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}class cE{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0;const i=new Lo(this.textureWidth,1);i.samplingMode=Wn.NEAREST,i.wrapMode=Hn.CLAMP_TO_EDGE,this._texture=new Fo(this._rctx,i),this._data=new Fu(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,s,n){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,r),this._data.set(a,2,s),this._data.set(a,3,n)}setDataElement(e,t,i,r){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new Fu(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class hE{constructor(e,t=1){this.textureBuffer=new cE(e,t),this._indexManager=new lE(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class dE{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new hE(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}const uE=()=>A.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class pE{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._visible=new Y,this._hidden=new Y,this._renderSubmit=new LO(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=b("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new dE(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){il(0===this._hidden.length&&0===this._visible.length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll((e=>e.destroy())),this._hidden.forAll((e=>e.destroy())),this._visible.clear(),this._hidden.clear()}createObject(e){const t=e.geometry,i=new FR(this._componentBufferManager,Ku(t.componentOffsets)),r=this._createRenderable(e,i),s=new qR(this._viewingMode,t.positionData,i),n=new VR(e.transform,e.toMapSpace,e.obb.clone(),i,r,s);return(n.visible?this._visible:this._hidden).push(n),n}destroyObject(e){const t=e;(t.visible?this._visible:this._hidden).removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(t?(this._hidden.removeUnordered(i),this._visible.push(i)):(this._visible.removeUnordered(i),this._hidden.push(i)),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=Ei(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount;return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material,s=i.components,n=s.materialDataBuffer,a=s.materialDataIndices,o=new NO,l=n.textureBuffer,c=new Uint8Array(4),h=new Uint32Array(c.buffer);let d=0,u=0,p=0,m=s.verticalOffsets,_=1/0,g=-1/0,f=!1,y=!1,v=0;for(let e=0;e<s.count;e++){t(e,o),d+=+(o.externalColor[3]<1),u+=+(o.externalColorMixMode===tp.Replace&&1===o.externalColor[3]),p+=+o.castShadows,ip(o.externalColor,o.externalColorMixMode,c),c[2]=254&c[2]|+o.castShadows,l.setData(a[e],0,c[0],c[1],c[2],c[3]),f||=e>0&&v!==h[0],v=h[0],y||=0!==o.elevationOffset,y&&null==m&&(m=new Array(e).fill(0)),null!=m&&(m[e]=o.elevationOffset),_=Math.min(_,o.elevationOffset),g=Math.max(g,o.elevationOffset),UO(o.elevationOffset,c),l.setData(a[e],1,c[0],c[1],c[2],c[3]);const i=o.objectAndLayerIdColor;null!=i&&l.setData(a[e],2,i[0],i[1],i[2],i[3]),o.pickable!==jR(s.pickability,e)&&(s.pickability=UR(s.pickability,s.count,e,o.pickable))}s.verticalOffsets=y?m:null,i.offsetObb=y?rp(i.obb,_,g,this._viewingMode,i.offsetObb??i.obb.clone()):null,f||y||this._hasObjectAndLayerId?(r.componentParameters=new oE,r.componentParameters.castShadows=_E(p,s.count),r.componentParameters.transparent=_E(d,s.count),r.componentParameters.opaqueOverride=_E(u,s.count),r.componentParameters.texture=l,l.updateTexture()):(r.componentParameters=new aE,r.componentParameters.castShadows=o.castShadows?sE.All:sE.None,r.componentParameters.externalColor=o.externalColor,r.componentParameters.externalColorMixMode=o.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const s=e,n=s.components.verticalOffsets;if(r||null==n)return i;const a=n[t];if(this._viewingMode===Mt.Local||0===a)return i[2]+=a,i[5]+=a,i;const o=Xc(a);return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}expandRangeWithComponentObjectElevationRange(e,t,i,r){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==t||r.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);const s=e,n=s.components,a=n.count,o=n.verticalOffsets,l=s.intersectionGeometry,c=this._viewingMode===Mt.Local,h=l.getComponentAabbs(),d=gE;let u=1/0,p=-1/0;for(let e=0;e<a;e++){const n=6*e,a=o?.[e]??0;let l=1/0,m=-1/0;if(c)l=h[n+2]+a+t,m=h[n+5]+a+t;else{if(d[0]=h[n],d[1]=h[n+1],d[2]=h[n+2],d[3]=h[n+3],d[4]=h[n+4],d[5]=h[n+5],0!==a){const e=Xc(a);e.localOrigin=s.transform.position,e.applyToAabb(d)}const e=Math.max(Math.abs(d[3]),Math.abs(d[0])),o=Math.max(Math.abs(d[4]),Math.abs(d[1])),l=t+d[5]+i;r.expandElevationRangeValues(t+d[2],Math.sqrt(e*e+o*o+l*l)-i)}r.expandElevationRangeValues(l,m),u=Math.min(u,l),p=Math.max(p,m)}this._elevationRangeCacheVerticalOffset=t,this._elevationRangeCacheMin=u,this._elevationRangeCacheMax=p}intersect(e,t,i,r,s,n,a){const o=e,{transform:l}=o,{position:c}=l;return null!=s&&(s.localOrigin=c),o.intersectionGeometry.intersect(t,i,r,s,o.components.verticalOffsets,n,l,a??!1)}addEdges(e,t,i,r){const s=e,{indices:n,positions:a}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(s,a,n,o,i,r)}async extractEdgeInformation(e,t,i){const r=e,s=r.components.visibility;if(s.allInvisible())return{buffer:dp.createBuffer(0),origin:[0,0,0]};const{indices:n,positions:a}=r.intersectionGeometry,o=r.components.offsets,l=up.createBuffer(a.length/3);jd(l.position.typedBuffer,a,l.position.typedBufferStride,3),ep(l.position,l.position,r.transform.rotationScale),this._setComponentIndices(l.componentIndex,n,o);const c=l.count,h=this._computeVisibilityIndices(n,s,o,c);return{origin:be(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:h,indicesLength:h.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const n=i[s],a=i[s+1];for(let i=n;i<a;i++){const s=t?t[i]:i;e.set(s,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=i[t]-i[e],!0)));const n=R(e)?new Array(s):2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(s):new Uint32Array(s);let a=0;return t.forEachComponentRange(((t,r)=>{const s=i[t],o=i[r];for(let t=s;t<o;t++)n[a++]=e?e[t]:t;return!0})),n}addComponentHighlight(e,t){const i=e.components;null==i.highlightCounts&&(i.highlightCounts=new Uint32Array(i.count+1)),0==i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(null==i.highlightCounts)return void uE().warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else uE().warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;null!=t.highlightCounts&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,n=el.createVertex(i,Gn.STATIC_DRAW,r.vertices.data),a=r.indices?el.createIndex(i,Gn.STATIC_DRAW,r.indices):null,o=Xo(Ua(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],n=t.materialDataIndices[e];if(null!=r.indices)for(let e=i;e<s;e++)l[r.indices[e]]=n;else for(let e=i;e<s;e++)l[e]=n}const c=el.createVertex(i,Gn.STATIC_DRAW,l.buffer),h=new iE(e.transform,e.toMapSpace),d=new vp(i,XO,{data:o,componentIndices:mE},{data:n,componentIndices:c},a),u=new cO(d,qn.TRIANGLES,s,null!=a),p={cameraDepthSquared:.5,gpuMemoryEstimate:n.usedMemory+c.usedMemory+(null!=a?a.usedMemory:0)};return new lO(h,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const mE=Xo(Yo().u16(Sn.COMPONENTINDEX));function _E(e,t){return e===t?sE.All:0===e?sE.None:sE.Some}const gE=bu();class fE extends Pn{constructor(){super(...arguments),this.opacity=1}}const yE=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:fE,build:function(e){const t=new qr;return t.include(qa),t.fragment.uniforms.add(new $r("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new Wr("opacity",(e=>e.opacity))),t.fragment.code.add(Tn`
    void main() {
      fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};
    }`),t}},Symbol.toStringTag,{value:"Module"}));var vE;!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(vE||(vE={}));class xE extends pa{constructor(){super(...arguments),this.alphaMode=vE.None,this.hasOpacityFactor=!1}}e([ua({count:vE.COUNT})],xE.prototype,"alphaMode",void 0),e([ua()],xE.prototype,"hasOpacityFactor",void 0);class wE extends Xr{initializeProgram(e){return new Yr(e.rctx,wE.shader.get().build(this.configuration),Rn)}initializePipeline(){switch(this.configuration.alphaMode){case vE.None:return ea({colorWrite:ia});case vE.Alpha:return ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia});case vE.PremultipliedAlpha:case vE.COUNT:return ea({blending:ta(jn.ONE,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia})}}}wE.shader=new Zr(yE,(()=>Promise.resolve().then((()=>yE))));class bE extends Pn{}const CE=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:bE,build:function(){const e=new qr;return e.include(qa),e.fragment.uniforms.add(new $r("tex",(e=>e.texture))),e.fragment.code.add(Tn`void main() {
fragColor = vec4(1.0 - texture(tex, uv).a);
}`),e}},Symbol.toStringTag,{value:"Module"}));class TE extends Xr{initializeProgram(e){return new Yr(e.rctx,TE.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}TE.shader=new Zr(CE,(()=>Promise.resolve().then((()=>CE))));class PE extends Pn{}const SE=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:PE,build:function(){const e=new qr;return e.include(qa),e.fragment.uniforms.add(new $r("colorTexture",(e=>e.colorTexture)),new $r("alphaTexture",(e=>e.alphaTexture)),new $r("frontFaceTexture",(e=>e.frontFaceTexture))),e.fragment.code.add(Tn`void main() {
vec4 srcColor = texture(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture(alphaTexture, uv).r;
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb / srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),e}},Symbol.toStringTag,{value:"Module"}));class RE extends Xr{initializeProgram(e){return new Yr(e.rctx,RE.shader.get().build(),Rn)}initializePipeline(){return ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia})}}RE.shader=new Zr(SE,(()=>Promise.resolve().then((()=>SE))));class OE{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new xE,this._passParameters=new fE,this._oitParameters=new PE,this._hudParameters=new bE}compositeOIT(e,t,i,r){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=r;const s=this._techniqueRepository.acquire(RE);this._rctx.bindTechnique(s,e,this._oitParameters),this._rctx.screen.draw(),s.release()}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._techniqueRepository.acquire(TE);this._rctx.bindTechnique(i,e,this._hudParameters),this._rctx.screen.draw(),i.release()}composite(e,t,i=vE.None,r=1){this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;const s=this._techniqueRepository.acquire(wE,this._configuration);this._rctx.bindTechnique(s,e,this._passParameters),this._rctx.screen.draw(),s.release()}}const EE=100;function AE(e,t,i){return cp(t,e)*(i[1]-i[0])+i[0]}function ME(e,t,i){if(!i.visible)return;if(!ah(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=FE;i.geometries.forEach((i=>{ur(s,r,i.transformation);const n=si(s);DE(e,t,i.boundingInfo,s,n)}))}function DE(e,t,i,r,s){if(null==i)return;Ri(yl(NE),i.center,r);const{eye:n,viewForward:a}=t,o=a[0]*(NE[0]-n[0])+a[1]*(NE[1]-n[1])+a[2]*(NE[2]-n[2]);if(NE[3]=i.radius*s,!(o-NE[3]>e.near&&o+NE[3]<e.far)&&ah(t.frustum,NE))if(i.radius>EE&&i.getChildren())for(const n of i.getChildren())DE(e,t,n,r,s);else kE.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function IE(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}const LE=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],NE=vl(),FE=wr(),VE=dO(),UE=new class{constructor(){this._items=new Y({allocator:e=>e||{object:null,distance:0,near:0,far:0},deallocator:e=>(e.object=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().object=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.object.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===xp.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.object,r.near,r.far)}}},jE=new class{constructor(){this._view=wr(),this._viewProj=wr(),this._frustum=ih(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),hr(this._view,e.viewMatrix),ur(this._viewProj,e.projectionMatrix,this._view),ph(this._frustum,e.frustum);const i=this._view,r=i[2],s=i[6],n=i[10],a=i[14];t.forAll((e=>{e.materialReference&&e.forEachGeometry&&e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,i=r*t[0]+s*t[1]+n*t[2]+a,o=i-t[3],l=i+t[3];this._geometries.push(e),this._near.push(-l),this._far.push(-o)}))}));const o=new hO;if(0===this._geometries.length)return o;for(let e=0;e<this._geometries.length;++e)this._near[e]>o.far&&(o.far=this._near[e]),this._near[e]>2&&this._far[e]<o.near&&(o.near=this._far[e]);const l=this._looseRange;l.near=Math.max(.5*o.near,2),l.far=2*o.far;let c=0,h=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<o.near&&(this._near[e]>=l.near?o.near=this._near[e]:this._nearCandidates[c++]=e),this._far[e]>o.far&&(this._far[e]<=l.far?o.far=this._far[e]:this._farCandidates[h++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return o;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let e=0;e<this._nearCandidates.length;++e){const t=this._nearCandidates[e];if(this._near[t]<o.near){const e=this._geometries[t],i=e.boundingInfo;this._includeNearBoundingInfoRec(i,e.shaderTransformation,o)}}for(let e=0;e<this._farCandidates.length;++e){const t=this._farCandidates[e];if(this._far[t]>o.far){const e=this._geometries[t],i=e.boundingInfo;this._includeFarBoundingInfoRec(i,e.shaderTransformation,o)}}return this._reset(),o}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,i){if(null==e)return;const r=e.center;Ri(yl(NE),r,t);const s=si(t),n=NE[0],a=NE[1],o=NE[2],l=e.radius*s,c=this._frustum;if(c[0][0]*n+c[0][1]*a+c[0][2]*o+c[0][3]>l||c[1][0]*n+c[1][1]*a+c[1][2]*o+c[1][3]>l||c[2][0]*n+c[2][1]*a+c[2][2]*o+c[2][3]>l||c[3][0]*n+c[3][1]*a+c[3][2]*o+c[3][3]>l)return;const h=this._view[2]*n+this._view[6]*a+this._view[10]*o+this._view[14],d=h+l;if(!(-(h-l)<2||-d>=i.near))if(-d>this._looseRange.near)i.near=-d;else{if(l>EE){const r=e.getChildren();if(void 0!==r){for(const e of r)this._includeNearBoundingInfoRec(e,t,i);return}}kE.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,i){if(null==e)return;let r=e.radius;const s=e.center;Ri(yl(NE),s,t);const n=si(t),a=NE[0],o=NE[1],l=NE[2];r*=n;const c=this._frustum;if(c[0][0]*a+c[0][1]*o+c[0][2]*l+c[0][3]>r||c[1][0]*a+c[1][1]*o+c[1][2]*l+c[1][3]>r||c[2][0]*a+c[2][1]*o+c[2][2]*l+c[2][3]>r||c[3][0]*a+c[3][1]*o+c[3][2]*l+c[3][3]>r)return;const h=this._view[2]*a+this._view[6]*o+this._view[10]*l+this._view[14]-r;if(!(-h<=i.far))if(-h<this._looseRange.far)i.far=-h;else{if(r>EE){const r=e.getChildren();if(void 0!==r){for(const e of r)this._includeFarBoundingInfoRec(e,t,i);return}}kE.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}},kE=new class{constructor(){this._modelViewProj=wr(),this._clipPosition=[tr(),tr(),tr(),tr(),tr(),tr(),tr(),tr()]}unionDepthRangeWithAABB(e,t,i,r,s){const n=this._modelViewProj;ur(n,t,i);let a=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],a=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=n[0]*i+n[4]*a+n[8]*o+n[12],t[1]=n[1]*i+n[5]*a+n[9]*o+n[13],t[2]=n[2]*i+n[6]*a+n[10]*o+n[14],t[3]=n[3]*i+n[7]*a+n[11]*o+n[15]}for(let t=0;t<12;++t){const i=this._clipPosition[LE[t][0]],r=this._clipPosition[LE[t][1]],s=this._clipPosition[LE[t][2]],n=this._clipTriangle(i,r,s);let o=!0;for(let e=0;e<n.length;++e)if(n[e][3]>=2){o=!1;break}if(!o){a=!0;for(let t=0;t<n.length;++t){const i=n[t][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return a}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void il(!1)}_intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),Ji(tr(),e,t,r)}_clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],n=t[(i+1)%t.length];this._inside(n,e)?(this._inside(s,e)||r.push(this._intersect(s,n,e)),r.push(n)):this._inside(s,e)&&r.push(this._intersect(s,n,e))}}return r}};class qE{}class zE extends Pn{constructor(){super(...arguments),this.textures=new qE}}const BE=J(),HE=se(),GE=tr();let WE=class extends pe{constructor(){super(...arguments),this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new zE,this.events=new di,this.attributeLocations=new Map([[Sn.POSITION,0]]),this._tmpScreenPoint=J(),this._tmpRenderPoint=se()}get updating(){return null==this._imageSources&&null!=this._imageLoadTask&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};null!=this._magnifier&&this.addHandles(U((()=>this._magnifier?.version),t)),t()}get enabled(){return null!=this._validMagnifier}get _validMagnifier(){return null!=this._magnifier&&this._magnifier.visible&&null!=this._magnifier.position&&this._magnifier.size>0?this._magnifier:null}get _factor(){return null!=this._magnifier&&this._magnifier.factor||1}destroy(){this._magnifier=null,null!=this._imageLoadTask&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(null==i)return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),null==this._resources)return;const n=this._passParameters.textures,a=Math.ceil(1/this._factor*s);n.input.resize(a,a),te(i.position,this._tmpScreenPoint);const o=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),l=t.camera.fullWidth,c=t.camera.fullHeight,h=.5*a,d=.5*a;o[0]=Ft(o[0],h,l-h-1),o[1]=Ft(o[1],d,c-d-1);const u=Math.floor(o[0]-h),p=Math.floor(o[1]-d),m=this._resources.program;m.bindTexture("textureInput",n.input),e.gl.copyTexImage2D(n.input.descriptor.target,0,n.input.descriptor.pixelFormat,u,p,a,a,0),this._passParameters.magnifier=i,e.useProgram(m),m.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(qn.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(null==e)return;const t=e.maskUrl,i=e.overlayUrl;null==this._imageLoadTask||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),null==this._imageSources&&null==this._imageLoadTask&&(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:Lt((async e=>{const r=null==t||null==i?qu(e):null,s=null!=t?wp(t,{signal:e}):r.then((e=>e.mask)),n=null!=i?wp(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await n},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(null!=this._resources){if(this._passParameters.textures.size!==t){const i=this._createTextureResources(e,t);if(null==i)return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=i}return}const i=this._createTextureResources(e,t);null!=i&&(this._resources={program:this._createProgram(e),vao:va(e,ja,this.attributeLocations,0,1),pipelineState:ea({blending:ta(jn.ONE,jn.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:ia})},this._passParameters.textures=i)}_disposeResources(){null!=this._resources&&(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(null==this._imageSources)return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Lo;i.internalFormat=$n.RGBA,i.wrapMode=Hn.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!kd(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result;const r=new Fo(e,i,this._imageSources.overlay);i.pixelFormat=i.internalFormat=$n.ALPHA,i.preMultiplyAlpha=!1;const s=new Fo(e,i,this._imageSources.mask);return i.pixelFormat=i.internalFormat=$n.RGBA,i.flipped=!1,{input:new Fo(e,i),mask:s,overlay:r,size:t}}_createProgram(e){return new Yr(e,function(){const e=new qr;return e.attributes.add(Sn.POSITION,"vec2"),e.vertex.uniforms.add(new Gr("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,r=e.magnifier.offset.x*i,s=e.magnifier.offset.y*i;te(e.magnifier.position,BE);const n=t.camera.screenToRender(BE,HE),a=Math.ceil(i*e.magnifier.size),o=t.camera.fullWidth,l=t.camera.fullHeight;return $i(GE,(n[0]+r)/o*2-1,(n[1]-s)/l*2-1,a/o*2,a/l*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.code.add(Tn`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add(new $r("textureInput",(e=>e.textures.input))),e.fragment.uniforms.add(new $r("textureMask",(e=>e.textures.mask))),e.fragment.uniforms.add(new $r("textureOverlay",(e=>e.textures.overlay))),e.fragment.uniforms.add(new Ga("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new Ga("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(Tn`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}(),this.attributeLocations)}};e([ae()],WE.prototype,"_imageSources",void 0),e([ae()],WE.prototype,"_imageLoadTask",void 0),e([ae({readOnly:!0})],WE.prototype,"updating",null),WE=e([le("esri/views/3d/webgl-engine/lib/MagnifierHelper")],WE);class $E{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Fu(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,s,n=null,a=null,o=null){if(!(e&&t&&i&&r))return;if(this._layerUidToId.set(r,i),this._layerUidToPopupEnabled.set(r,s),!s)return;let l=this._layerUidToGraphicsUidToObjectId.get(r);l||(l=new Map,this._layerUidToGraphicsUidToObjectId.set(r,l)),l.set(t,{objectId:e,attributeNodeId:n,attributeIndex:a,subLayerId:o})}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return rr(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===t)return A.getLogger(this).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(!1===t)return this.colorZero;let i=this._uidToRenderColor.get(e.layerUid);i||(i=new Map,this._uidToRenderColor.set(e.layerUid,i));let r=i.get(e.graphicUid);if(!r){for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");i.set(e.graphicUid,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new Fu(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(i.layerUid);let s=null;r?(s=r.get(i.graphicUid),s||A.getLogger(this).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid)):A.getLogger(this).warn("getColorMapping: no entry found for layerUid "+i.layerUid);const n=this._layerUidToId.get(i.layerUid);n||A.getLogger(this).warn("no layerId found for uid "+i.layerUid),s&&n&&e.set(t,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:s.objectId,lid:n,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",oid:s.objectId,lid:n})}return e}}class QE extends _a{constructor(e,t,i){super(e,i),this.attachment=t,this.name=""}dispose(){this.attachment.dispose()}get usedMemory(){return this.attachment.usedMemory}}class XE extends QE{constructor(e,t,i){super(e,t,i),this.attachment=t,this.type=ga.COLOR}}class YE extends QE{constructor(){super(...arguments),this.type=ga.DEPTH}}class ZE{constructor(e,t){this._last=new Y,this._incarnation=0,this._cache=new Ys(e,t)}destroy(){this._last?.forAll((e=>e.dispose())),this._last=null,this._cache.destroy()}set interactive(e){e&&!this._last?this._last=new Y:e||(this._last?.forAll((e=>e.dispose())),this._last=null)}clean(){this._last?.filterInPlace((e=>!(e.incarnation<this._incarnation&&(this._cache.put(e.key,e),1))))}frame(){++this._incarnation}pop(e){if(this._last){const t=this._last.find((t=>t.key===e));if(t)return this._last.removeUnordered(t),t}return this._cache.pop(e)}put(e){e.incarnation=this._incarnation,this._last?this._last.push(e):this._cache.put(e.key,e)}get usedMemory(){return this._last?.reduce(((e,t)=>e+t.usedMemory),0)??0}}class KE{constructor(e){this.rctx=e,this._acquired=new Set,this._cache=new ZE(e.newCache,"FBOCache"),this._depthCache=new ZE(e.newCache,"DepthAttachmentCache"),this._colorCache=new ZE(e.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback&&this.debugCallback()}frameEnd(){const e=this.debugCallback;e&&this._acquired.forEach((t=>t.type===ga.FBO&&e(t.name,t.fbo)))}get usedMemory(){return Array.from(this._acquired.values()).reduce(((e,t)=>e+("getTexture"in t?t.getTexture()?.usedMemory??0:t.usedMemory)),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(e){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=e}acquire(e,t,i,r=ma.RGBA){const s=JE(r,e,t);let n=this._cache.pop(s);return n?(n.retain(),n.setName(i)):n=new ya(s,i,new Ao(this.rctx,{...oA[r],width:e,height:t}),(e=>{e??=fa.DEPTH_STENCIL_TEXTURE;const t=this._acquireDepth(e,n.fbo.width,n.fbo.height,`${n.name} depth`);return n.attachDepth(t),t.release(),n}),((i,r)=>{r??=ma.RGBA;const s=this._acquireColor(r,e,t,`${n.name} color ${i}`);return n.attachColor(s,i),n}),(()=>{this.debugCallback&&this.debugCallback(n.name,n.fbo),this._acquired.delete(n),n.detachAll(),this._cache.put(n)})),this.rctx.unbindTexture(n.fbo.colorTexture),this.rctx.bindFramebuffer(n.fbo),this._trackHandle(n)}acquireDepth(e,t,i,r){return this._acquireDepth(e,t,i,r)}_acquireDepth(e,t,i,r){const s=JE(e,t,i),n=this._depthCache.pop(s);if(n)return n.retain(),n.name=r,this._trackHandle(n);const a=e===fa.DEPTH_STENCIL_TEXTURE?new YE(s,new Fo(this.rctx,{...cA[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)})):new YE(s,new Io(this.rctx,{...cA[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._depthCache.put(a)}));return a.name=r,this._trackHandle(a)}_acquireColor(e,t,i,r){const s=JE(e,t,i),n=this._colorCache.pop(s);if(n)return n.retain(),n.name=r,this._trackHandle(n);const a=new XE(s,new Fo(this.rctx,{...oA[e],width:t,height:i}),(()=>{this._acquired.delete(a),this._colorCache.put(a)}));return a.name=r,this._trackHandle(a)}_trackHandle(e){return this._acquired.add(e),e}}function JE(e,t,i){return`${e}x${t}x${i}`}const eA=new Lo;eA.pixelFormat=$n.RED,eA.internalFormat=Zn.R8,eA.wrapMode=Hn.CLAMP_TO_EDGE;const tA=new Lo;tA.pixelFormat=$n.RG,tA.internalFormat=Zn.RG8,tA.wrapMode=Hn.CLAMP_TO_EDGE;const iA=new Lo;iA.internalFormat=Zn.RGBA4,iA.dataType=Kn.UNSIGNED_SHORT_4_4_4_4,iA.wrapMode=Hn.CLAMP_TO_EDGE;const rA=new Lo;rA.wrapMode=Hn.CLAMP_TO_EDGE;const sA=new Lo;sA.wrapMode=Hn.CLAMP_TO_EDGE,sA.samplingMode=Wn.LINEAR_MIPMAP_LINEAR,sA.hasMipmap=!0,sA.maxAnisotropy=8;const nA=new Lo;nA.pixelFormat=$n.RED,nA.dataType=Kn.HALF_FLOAT,nA.internalFormat=Zn.R16F,nA.samplingMode=Wn.NEAREST;const aA=new Lo;aA.dataType=Kn.HALF_FLOAT,aA.internalFormat=Zn.RGBA16F,aA.samplingMode=Wn.NEAREST;const oA={[ma.RED]:eA,[ma.RG]:tA,[ma.RGBA4]:iA,[ma.RGBA]:rA,[ma.RGBA_MIPMAP]:sA,[ma.R16F]:nA,[ma.RGBA16F]:aA},lA=new Lo;lA.pixelFormat=$n.DEPTH_STENCIL,lA.dataType=Kn.UNSIGNED_INT_24_8,lA.samplingMode=Wn.NEAREST,lA.wrapMode=Hn.CLAMP_TO_EDGE;const cA={[fa.DEPTH_STENCIL_TEXTURE]:lA,[fa.DEPTH16_BUFFER]:new Do(Xn.DEPTH_COMPONENT16,4)};var hA;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(hA||(hA={}));class dA{constructor(e,t,i=hA.FrontToBack){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new Y({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r){const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=r,s.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0}prepare(e,t){return this._draws.map((i=>i.material.prepareTechnique(this._techniqueRepository,e,t,i.geometry.parameters)))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.length;for(let a=0;a<n;a++){const n=i[a];n===s&&n.configuration.transparencyPassType===aa.NONE||(r.bindTechnique(n,t,e),s=n);const o=this._draws.data[a],l=o.geometry;r.bindVAO(l.vao),this._previouslyBoundDraw.get(n)!==o.material&&(n.program.bindDraw(o.material,t,e),this._previouslyBoundDraw.set(n,o.material));const c=o.geometryRanges,h=c.length;if(0!==o.indexType){const e=uA.get(o.indexType);for(let t=0;t<h;t+=2){const i=c[t],s=c[t+1];r.drawElements(l.primitiveType,s,o.indexType,i*e)}}else for(let e=0;e<h;e+=2){const t=c[e],i=c[e+1];r.drawArrays(l.primitiveType,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===hA.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.byteSize-i.geometry.vao.byteSize}))}get count(){return this._draws.length}}const uA=new Map;uA.set(Jn.UNSIGNED_BYTE,1),uA.set(Jn.UNSIGNED_SHORT,2),uA.set(Jn.UNSIGNED_INT,4);let pA=class extends $a{constructor(){super({}),this._passes=null,this.produces=new Map([[ns.OPAQUE_MATERIAL,e=>this._produces(e)],[ns.TRANSPARENT_MATERIAL,e=>!!(this._passes&&this._passes.materialTransparent.count>0)&&this._produces(e)],[ns.INTEGRATED_MESH,e=>this._produces(e)]]),this._materialPassParameters=new cn,this._shadowPassParameters=new hn,this._highlightPassParameters=new dn,this._systems=new Set}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx,i=e.techniqueRepository;this._passes={materialOpaque:new dA(t,i),materialTransparent:new dA(t,i,hA.BackToFront),materialIntegratedMesh:new dA(t,i),shadowMap:new dA(t,i),highlight:new dA(t,i),highlightIntegratedMesh:new dA(t,i),highlightShadowMap:new dA(t,i),defaultShadowMap:new dA(t,i)}}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e){return 0!==this._systems.size&&null!==this._passes&&(e===ds.Highlight?this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0:e!==ds.ShadowHighlight||this._passes.highlight.count>0)}prepareRender(e){if(0!==this._systems.size&&null!==this._passes){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this._context.techniqueRepository.frameUpdate()}}prepareTechniques(e){if(0===this._systems.size)return null;const t=e.output===ds.Shadow||e.output===ds.ShadowHighlight||e.output===ds.ShadowExcludeHighlight?this._shadowPassParameters:e.output===ds.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bindParameters;return this._updateParameters(i.camera,t,i.slot===ns.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e,((t,i)=>t.prepare(i,e.bindParameters)))}renderNode(e,t){this._invoke(e,((i,r)=>i.dispatch(r,e.bindParameters,t)))}_invoke(e,t){if(null===this._passes)return null;switch(e.bindParameters.slot){case ns.OPAQUE_MATERIAL:switch(e.output){case ds.Color:case ds.LinearDepth:case ds.Normal:case ds.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case ds.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case ds.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case ds.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case ds.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case ns.TRANSPARENT_MATERIAL:switch(e.output){case ds.Color:case ds.Alpha:case ds.LinearDepth:case ds.Normal:case ds.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case ns.INTEGRATED_MESH:switch(e.output){case ds.Color:case ds.LinearDepth:case ds.Normal:case ds.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case ds.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){const t=new hO;return this._systems.forEach((i=>pO(t,i.queryShadowCasterDepthRange(e)))),t}_updateParameters(e,t,i){const r=e.viewInverseTransposeMatrix;ui(mA,r[3],r[7],r[11]),gA.set(mA),Ti(t.transformWorldFromViewTH,gA.high),Ti(t.transformWorldFromViewTL,gA.low),Ti(t.slicePlaneLocalOrigin,mA),xo(t.transformViewFromCameraRelativeRS,e.viewMatrix),hr(t.transformProjFromView,e.projectionMatrix),t.identifier===ln.Material&&(this._materialPassParameters.transparent=i,wo(_A,t.transformViewFromCameraRelativeRS),bo(t.transformNormalViewFromGlobal,_A))}};pA=e([le("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],pA);const mA=we(),_A=Oo(),gA=new eE;class fA{constructor(e){this._context=e,this._nodes=new Y}destroy(){this._nodes.forEach((e=>this.remove(e))),this._nodes.clear()}add(e){this._nodes.push(e)}remove(e){this._nodes.remove(e)?.destroy()}produces(e){return this._nodes.some((({produces:t})=>t===e))}require(e,t){return null==t?this._nodes.reduce(((t,{consumes:i})=>t+(i.required.includes(e)?1:0)),0):this._nodes.reduce(((i,{consumes:r,produces:s})=>i+(r.required.includes(e)&&s===t?1:0)),0)}render(e,t){const i=e.name,r=this._nodes.filter((({produces:e})=>e===i));return 0===r.length||(t.set(i,e),r.forEach((r=>{const s=new Array;for(const e of r.consumes.required){const i=t.get(e);if(!i)return;s.push(i)}try{const n=r.doRender(s,this._context);n&&n!==e&&(e.release(),e=n,t.set(i,e))}catch(e){A.getLogger(r).errorOnce(e)}}))),e}}class yA{constructor(e){this._context=e,this._renderPlugins=new Y,this._slots=new Array,this._renderVersion=Wh(0);for(let e=0;e<ns.MAX_SLOTS;++e)this._slots[e]=[]}destroy(){this._renderPlugins.forEach((e=>e.destroy())),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(e,t){const i=()=>{if(t?.aborted)throw e.uninitializeRenderContext(),o();this._renderPlugins.push(e),e.produces.forEach(((t,i)=>{this._slots[i].push(e)})),this._context.requestRender(),this._renderVersion.value++},r=e.initializeRenderContext(this._context,t);if(g(r))return r.then(i);i()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this._context.requestRender(),this._renderVersion.value++}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>{i.updateAnimation&&(t=i.updateAnimation(e)||t)})),t}renderFeatureChanged(){this._renderPlugins.forAll((e=>{e.renderFeatureChanged&&e.renderFeatureChanged()}))}prepare(e){this._context.renderContext.bindParameters.slot=e,this._slots[e].forEach((t=>{const i=t.produces.get(e);i&&i(ds.Color)&&(Qa(t)&&t.prepareTechnique(this._context.renderContext),Xa(t)&&t.prepareTechniques(this._context.renderContext))}))}_getRenderables(e){this._context.renderContext.bindParameters.slot=e;const t=this._context.renderContext.output??ds.Color,i=new Map;return this._slots[e].forEach((r=>{const s=r.produces.get(e);if(s&&s(t)&&(!r.isDecoration||this._context.renderContext.bindParameters.decorations!==fu.OFF))if(Qa(r)){const e=r.prepareTechnique(this._context.renderContext);null!=e&&i.set(r,e)}else if(Xa(r)){const e=r.prepareTechniques(this._context.renderContext);null!=e&&i.set(r,e)}else i.set(r,null)})),i}render(e,t=null,i=null){return this._getRenderables(e).forEach(((e,r)=>i=r.renderNode(this._context.renderContext,e,t,i))),i}queryDepthRange(e){const t=new hO;return this._renderPlugins.forAll((i=>{const r=i.queryDepthRange?.(e);pO(t,r)})),t}get updating(){return this._renderVersion.value>=0&&this._renderPlugins.some((e=>e.running))}produces(e,t=ds.Color){return this._slots[e].some((i=>{const r=i.produces.get(e);return!!r&&r(t)}))}consumes(e){return this._renderPlugins.some((t=>t.consumes().required.includes(e)))}getMaterialRenderer(e){return this._renderPlugins.find((t=>t.materialReference===e))}removeEmptyMaterialRenderers(){this._renderPlugins.filterInPlace((e=>!e.materialReference||0!==e.numGeometries||(e.destroy(),!1)))}get hasDecorations(){return this._renderPlugins.some((e=>e.isDecoration))}get hasOccludees(){return this._renderPlugins.some((e=>e.hasOccludees))}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),Nn.None)}get usedMemory(){return this._renderPlugins.reduce(((e,t)=>null!==t.materialReference?e:e+(t.usedMemory??0)),0)}get test(){return{plugins:this._renderPlugins}}}let vA=class extends za{constructor(e){super(e),this._context=null,this.opacity=1,this.alphaMode=vE.None,this._blitConfiguration=new xE,this._blitParameters=new fE,this.produces=new Map([[ns.BLIT,()=>null!=this._context]])}consumes(){return Ya}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){this._context=null}destroy(){}renderNode(e,t,i,r){const s=i?.get("composite-color")?.getTexture();if(!this._context||!s)return r;const n=this._context.techniqueRepository.acquire(wE,this._blitConfiguration);return n?.compiled?(e.rctx.bindFramebuffer(r?.fbo),this._blitParameters.texture=s,this._blitParameters.opacity=this.opacity,e.rctx.bindTechnique(n,e.bindParameters,this._blitParameters),e.rctx.screen.draw(),n.release(),r):(this._context.requestRender(),r)}};e([ae()],vA.prototype,"_context",void 0),e([ae()],vA.prototype,"opacity",void 0),e([ae()],vA.prototype,"alphaMode",void 0),vA=e([le("esri.views.3d.webgl-engine.effects.blit.Blit")],vA);class xA extends Pn{}const wA=32,bA=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:xA,blurSize:.4,build:function(){const e=new qr,{outputs:t,fragment:i}=e;return e.include(qa),i.uniforms.add(new Fr("textureInput",(e=>e.input))),i.constants.add("sampleArea","int",Math.ceil(4.5)),t.add("fragGrid","vec2"),i.code.add(Tn`
    void main() {
      float red = 0.0;
      float green = 1.0;
      int cellSize = ${Tn.int(wA)};
      vec2 texelSize = 1.0 / vec2(textureSize(textureInput, 0));
      vec2 offset = floor(gl_FragCoord.xy) * vec2(float(cellSize));

      for(int x = -sampleArea; x < cellSize + sampleArea; x += 2) {
        for(int y = -sampleArea; y < cellSize + sampleArea; y += 2) {
          vec2 coord = (offset + vec2(float(x), float(y))) * texelSize;
          vec4 value = texture(textureInput, coord);
          float mx = floor(max(value.g, value.b));

          red = max(red, ceil(value.r));
          green = min(green, mx);
          if(red == 1.0 && green == 0.0) {
            fragGrid = vec2(red, green);
            return;
          }
        }
      }
      fragGrid = vec2(red, green);
    }`),e},gridCellPixelSize:wA,outlineSize:9},Symbol.toStringTag,{value:"Module"})),CA=tr(),TA=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(Sn.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(Sn.UV0,"vec2"),t.uniforms.add(new $r("coverageTex",(e=>e.coverageTexture)),new Hr("coverageRounding",(e=>e.coverageRounding))),r.add(Tn`void main() {
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),i.uniforms.add(new $r("tex",(e=>e.blurTexture)),new $r("highlightTexture",(e=>e.highlightTexture)),new Gr("uColor",(e=>e.color)),new Gr("haloColor",(e=>e.haloColor)),new Gr("opacities",(e=>$i(CA,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)))),i.constants.add("inner","float",1-8.6/9),s.add(Tn`void main() {
vec4 blurredHighlightValue = texture(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture(highlightTexture, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float outlineFactor = smoothstep(0.0, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
fragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class PA extends Xr{initializeProgram(e){return new Yr(e.rctx,PA.shader.get().build(),Rn)}initializePipeline(){return ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia})}}PA.shader=new Zr(TA,(()=>Promise.resolve().then((()=>TA))));class SA extends Pn{constructor(){super(...arguments),this.blurSize=nr()}}const RA=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:SA,build:function(){const e=new qr,{attributes:t,varyings:i,vertex:r,fragment:s}=e;return t.add(Sn.POSITION,"vec2"),t.add(Sn.UV0,"vec2"),i.add("blurCoordinate","vec3"),r.uniforms.add(new $r("coverageTex",(e=>e.coverageTexture)),new Hr("coverageRounding",(e=>e.coverageRounding))),r.code.add(Tn`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture(coverageTex, uv0 * coverageRounding);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), cov.g);
}`),s.uniforms.add(new fo("blurSize",(e=>e.blurSize)),new Fr("tex",(e=>e.blurInputTexture))),s.code.add(Tn`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture(tex, uv);
if (blurCoordinate.z == 1.0) {
fragColor = center;
} else {
vec4 sum = center * 0.204164;
sum += texture(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture(tex, uv - blurSize * 3.294215) * 0.093913;
fragColor = sum;
}
}`),e}},Symbol.toStringTag,{value:"Module"}));class OA extends Xr{initializeProgram(e){return new Yr(e.rctx,OA.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:ia})}}OA.shader=new Zr(RA,(()=>Promise.resolve().then((()=>RA))));class EA extends Xr{initializeProgram(e){return new Yr(e.rctx,EA.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:ia})}}EA.shader=new Zr(bA,(()=>Promise.resolve().then((()=>bA))));class AA extends Pn{constructor(){super(...arguments),this.color=rr(1,0,1,1),this.haloColor=rr(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.coverageRounding=ar(1,1)}}let MA=class extends za{constructor(e){super(e),this._context=null,this._passParameters=new AA,this._downsampleDrawParameters=new xA,this._blurDrawParameters=new SA,this._blurColorFormat=b("mac")?ma.RGBA:ma.RGBA4,this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0},this.produces=new Map([[ns.HIGHLIGHT,()=>!0]])}consumes(){return Za}initializeRenderContext(e){this._context=e,null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(OA)),null==this._downsampleTechnique&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(EA)),null==this._applyTechnique&&(this._applyTechnique=this._context.techniqueRepository.acquire(PA)),this.addHandles([U((()=>this.view.highlightOptions.color),(e=>{this._passParameters.color=ki(e??Ub),this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color),this._context.requestRender()}),j),U((()=>this.view.highlightOptions.haloColor),(e=>{this._passParameters.haloColor=null!=e?ki(e):this._passParameters.color,this._context.requestRender()}),j),U((()=>this.view.highlightOptions.haloOpacity),(e=>{this._passParameters.haloOpacity=e??1,this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity,this._context.requestRender()}),j),U((()=>this.view.highlightOptions.fillOpacity),(e=>{this._passParameters.fillOpacity=e??.25,this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity,this._context.requestRender()}),j)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=L(this._blurTechnique),this._downsampleTechnique=L(this._downsampleTechnique),this._applyTechnique=L(this._applyTechnique),this._grid.coverage=L(this._grid.coverage),this._grid.vao=N(this._grid.vao)}renderNode(e,t,i,r){const s=i?.get("highlight")?.getTexture();if(!this._context||!s)return;if(!(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled))return void this._context.requestRender();const n=e.bindParameters.camera,a=n.fullWidth,o=n.fullHeight,l=n.pixelRatio,c=Math.ceil(a/l),h=Math.ceil(o/l),d=this._context.fbos,u=d.rctx;this._gridUpdateResources(s),this._gridComputeCoverage(s,e.bindParameters),this._passParameters.highlightTexture=s,this._passParameters.coverageTexture=this._grid.coverage?.getTexture();const{width:p,height:m}=s.descriptor;zi(this._passParameters.coverageRounding,p/(Math.ceil(p/wA)*wA),m/(Math.ceil(m/wA)*wA));const _=this._grid.vao;u.bindVAO(_);const g=d.acquire(c,h,"highlight blur",this._blurColorFormat);u.setClearColor(0,0,0,0),u.clearSafe(Yn.COLOR_BUFFER_BIT),u.setViewport(0,0,c,h),this._blurDrawParameters.blurInputTexture=s,zi(this._blurDrawParameters.blurSize,1/c,0);const f=u.bindTechnique(this._blurTechnique,e.bindParameters,this._passParameters,this._blurDrawParameters);u.drawArrays(this._blurTechnique.primitiveType,0,No(_,"geometry"));const y=d.acquire(c,h,"highlight blur",this._blurColorFormat);u.setClearColor(0,0,0,0),u.clearSafe(Yn.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=g.getTexture(),zi(this._blurDrawParameters.blurSize,0,1/h),f.bindDraw(this._blurDrawParameters,e.bindParameters,this._passParameters),u.drawArrays(this._blurTechnique.primitiveType,0,No(_,"geometry")),u.bindFramebuffer(r?.fbo),u.setViewport4fv(n.fullViewport),this._passParameters.blurTexture=y.getTexture(),u.bindTechnique(this._applyTechnique,e.bindParameters,this._passParameters),u.drawArrays(this._applyTechnique.primitiveType,0,No(_,"geometry")),g.release(),y.release()}_gridUpdateResources(e){if(!this._context)return;const t=this._context.fbos.rctx,i=this._grid,r=Math.ceil(e.descriptor.height/wA),s=Math.ceil(e.descriptor.width/wA);if(i.vao&&i.verticalCellCount===r&&i.horizontalCellCount===s)return;i.verticalCellCount=r,i.horizontalCellCount=s;const n=r+1,a=s+1,o=1/r,l=1/s,c=new Float32Array(24*n*a);let h=0;for(let e=0;e<n;e++)for(let t=0;t<a;t++)c[h++]=(t-.5)*l*2-1,c[h++]=(e-.5)*o*2-1,c[h++]=t*l,c[h++]=e*o,c[h++]=(t+.5)*l*2-1,c[h++]=(e-.5)*o*2-1,c[h++]=t*l,c[h++]=e*o,c[h++]=(t-.5)*l*2-1,c[h++]=(e+.5)*o*2-1,c[h++]=t*l,c[h++]=e*o,c[h++]=(t-.5)*l*2-1,c[h++]=(e+.5)*o*2-1,c[h++]=t*l,c[h++]=e*o,c[h++]=(t+.5)*l*2-1,c[h++]=(e-.5)*o*2-1,c[h++]=t*l,c[h++]=e*o,c[h++]=(t+.5)*l*2-1,c[h++]=(e+.5)*o*2-1,c[h++]=t*l,c[h++]=e*o;i.vao?.dispose(),i.vao=new Ko(t,Rn,{geometry:xa},{geometry:el.createVertex(t,Gn.STATIC_DRAW,c)})}_gridComputeCoverage(e,t){if(!this._context)return;const i=this._context.fbos.rctx,r=this._grid,s=e.descriptor,n=Math.ceil(s.width/wA),a=Math.ceil(s.height/wA);this._downsampleDrawParameters.input=e,r.coverage?.release(),r.coverage=this._context.fbos.acquire(n,a,"highlight coverage",ma.RG),i.bindTechnique(this._downsampleTechnique,t,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,n,a),i.screen.draw()}get test(){return{coverage:this._grid.coverage}}};e([ae()],MA.prototype,"_context",void 0),e([ae()],MA.prototype,"view",void 0),MA=e([le("esri.views.3d.webgl-engine.effects.highlight.Highlight")],MA);class DA extends pa{constructor(){super(...arguments),this.receiveShadows=!0}}e([ua()],DA.prototype,"receiveShadows",void 0);const IA=wr(),LA=we(),NA=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new qr;t.include(_o,e),t.include(bp),t.include(qa);const i=t.fragment;return i.include(es),i.include(Qr),i.uniforms.add(new $r("defaultDepthTex",((e,t)=>t.shadowMap.getSnapshot(un.ExcludeHighlight))),new $r("highlightDepthTex",((e,t)=>t.shadowMap.getSnapshot(un.Highlight))),new $r("depthMap",((e,t)=>t.linearDepth?.getTexture())),new $r("highlightTexture",(e=>e.highlight)),new Gr("uColor",(e=>e.shadowColor)),new Hr("nearFar",((e,t)=>t.camera.nearFar)),new Wr("opacity",(e=>e.shadowOpacity)),new Wr("occludedOpacity",(e=>e.occludedShadowOpacity)),new Wr("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new Br("lightingMainDirectionView",((e,t)=>_i(LA,Ri(LA,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix)))),new zr("inverseViewMatrix",((e,t)=>vr(IA,fr(IA,t.camera.viewMatrix,t.camera.center))))),i.constants.add("unoccludedHighlightFlag","vec4",Qo),i.code.add(Tn`
    vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, ivec2 iuv) {
      float leftPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(-1, 0), 0), nearFar);
      float rightPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(1, 0), 0), nearFar);
      float bottomPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, -1), 0), nearFar);
      float topPixelDepth = linearDepthFromRGBA(texelFetch(depthMap, iuv + ivec2(0, 1), 0), nearFar);

      bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
      bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);

      vec3 fragCoordHorizontal = pickLeft
                                  ? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
                                  : vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
      vec3 fragCoordVertical = pickBottom
                                  ? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
                                  : vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);

      vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
      vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);

      vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
      // Flip normal depending on triangle winding order for consistency
      return pickLeft == pickBottom ? normal : -normal;
    }

    void main(void) {
      vec4 highlightInfo = texture(highlightTexture, uv);
      float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
      if (visiblyHighlighted > ${Tn.float(.99999)}) {
        discard;
      }

      ivec2 iuv = ivec2(uv * vec2(textureSize(depthMap, 0)));
      float depth = rgba2float(texelFetch(depthMap, iuv, 0));
      // 0.0 is the clear value of depthMap, which means nothing has been drawn there and we should discard
      if (depth == 0.0) {
        discard;
      }

      float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        discard;
      }

      vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
      vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;

      mat4 shadowMatrix;
      float linearDepth = -currentPixelDepth;
      int i = chooseCascade(linearDepth, shadowMatrix);
      if (i >= numCascades) {
        discard;
      }

      vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
        discard;
      }

      ivec2 texSize = textureSize(highlightDepthTex, 0);
      ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));

      float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
      bool shadowHighlight = depthHighlight < lvpos.z;
      if (!shadowHighlight) {
        discard;
      }

      float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
      bool shadowDefault = depthDefault < lvpos.z;

      vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, iuv);
      bool shaded = dot(normal, lightingMainDirectionView) < ${Tn.float(.025)};

      float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
      fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class FA extends io{constructor(){super(...arguments),this.shadowColor=rr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class VA extends Xr{constructor(e){super(e,new DA,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,VA.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:ra(jn.SRC_ALPHA,jn.ONE,jn.ONE_MINUS_SRC_ALPHA,jn.ONE_MINUS_SRC_ALPHA),colorWrite:ia,depthTest:null,depthWrite:null})}get primitiveType(){return qn.TRIANGLE_STRIP}}VA.shader=new Zr(NA,(()=>Promise.resolve().then((()=>NA))));let UA=class extends za{constructor(e){super(e),this._maxOpacity=1,this._passParameters=new FA,this._shadowDifference=.2,this._context=null,this.produces=new Map([[ns.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return Za}initializeRenderContext(e){this._context=e,this.addHandles([U((()=>this.view.highlightOptions.shadowOpacity),(e=>{this._passParameters.shadowOpacity=e??.4,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),j),U((()=>this.view.highlightOptions.shadowDifference),(e=>{this._shadowDifference=e??.2,this._updateOccludedShadowOpacity(),this._updateMaxOpacity()}),j),U((()=>this.view.highlightOptions.shadowColor),(e=>{this._passParameters.shadowColor=ki(e??jb),this._updateMaxOpacity()}),j)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&null==this._technique&&(this._technique=this._context.techniqueRepository.acquire(VA))}renderNode(e,t,i,r){const s=i?.get("highlight")?.getTexture();if(!this._context||!s||!this._isVisible)return;if(!this._technique?.compiled)return void this._context.requestRender();const n=e.bindParameters;if(!n.shadowMap.enabled||!n.linearDepth)return;this._passParameters.highlight=s,this._passParameters.origin=n.camera.center;const a=e.rctx;a.bindFramebuffer(r?.fbo),a.bindTechnique(this._technique,n,this._passParameters),a.screen.draw()}updateParameters(e,t){this._passParameters.opacityElevation=1-kt(4e4,5e4,e.relativeElevation);const i=this.viewingMode===Mt.Global?_i(jA,e.center):ui(jA,0,0,1),r=gi(i,t);this._passParameters.dayNightTerminator=kt(0,1,Ft(30*r,0,1)),this._isVisible&&this.enable()}get _isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=.001953125}};e([ae()],UA.prototype,"_context",void 0),e([ae()],UA.prototype,"view",void 0),e([ae()],UA.prototype,"viewingMode",void 0),UA=e([le("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],UA);const jA=we(),kA=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr;return e.include(qa),e.fragment.uniforms.add(new $r("edgesTexture",(e=>e.inputTexture)),new $r("areaTexture",(e=>e.areaTexture)),new $r("searchTexture",(e=>e.searchTexture))),e.fragment.code.add(Tn`
    #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
    #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

    vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset, vec2 resolution) {
      return texture(tex, coord + offset.x * resolution, 0.0);
    }

    float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
      e.r = bias + e.r * scale;
      return 255.0 * texture( searchTex, e, 0.0 ).r;
    }

    float searchLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${Tn.int(8)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x += 0.25 * resolution.x;
      texcoord.x += resolution.x;
      texcoord.x += 2.0 * resolution.x;
      texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
      return texcoord.x;
    }

    float searchRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 0.0, 1.0 );
      for ( int i = 0; i < ${Tn.int(8)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 2.0, 0.0 ) * resolution;
        if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
      }
      texcoord.x -= 0.25 * resolution.x;
      texcoord.x -= resolution.x;
      texcoord.x -= 2.0 * resolution.x;
      texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
      return texcoord.x;
    }

    float searchUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${Tn.int(8)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord += vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y -= 0.25 * resolution.y;
      texcoord.y -= resolution.y;
      texcoord.y -= 2.0 * resolution.y;
      texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
      return texcoord.y;
    }

    float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end, vec2 resolution ) {
      vec2 e = vec2( 1.0, 0.0 );
      for ( int i = 0; i < ${Tn.int(8)}; i ++ ) {
        e = texture( edgesTex, texcoord, 0.0 ).rg;
        texcoord -= vec2( 0.0, 2.0 ) * resolution;
        if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
      }
      texcoord.y += 0.25 * resolution.y;
      texcoord.y += resolution.y;
      texcoord.y += 2.0 * resolution.y;
      texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
      return texcoord.y;
    }

    vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
      vec2 texcoord = float( ${Tn.int(16)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
      texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
      texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
      return texture( areaTex, texcoord, 0.0 ).rg;
    }

    void main() {
      vec2 size = vec2(textureSize(edgesTexture, 0));
      vec2 resolution = 1.0 / size;
      vec2 pixelCoord = uv * size;
      vec4 offsets[2];
      offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
      offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
      vec4 maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${Tn.int(8)} );

      ivec4 subsampleIndices = ivec4(0.0);
      vec4 weights = vec4(0.0);
      vec2 e = texture( edgesTexture, uv ).rg;
      if ( e.g > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.x = searchLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x, resolution );
        coords.y = offsets[1].y;
        d.x = coords.x;
        float e1 = texture( edgesTexture, coords, 0.0 ).r;
        coords.x = searchRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y, resolution );
        d.y = coords.x;
        d = d * size.x - pixelCoord.x;
        vec2 sqrt_d = sqrt( abs(d) );
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ), resolution).r;
        weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
      }

      if ( e.r > 0.0 ) {
        vec2 d;
        vec2 coords;
        coords.y = searchUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z, resolution );
        coords.x = offsets[0].x;
        d.x = coords.y;
        float e1 = texture( edgesTexture, coords, 0.0 ).g;
        coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w, resolution );
        d.y = coords.y;
        d = d * size.y - pixelCoord.y;
        vec2 sqrt_d = sqrt(abs(d));
        coords.y -= 1.0 * resolution.y;
        float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0), resolution).g;
        weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

        // for some reason the following lines are necessary to prevent
        // texture lookup precision issues on some Intel integrated graphics chips
        vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
        weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
      }
      fragColor = weights;
    }`),e}},Symbol.toStringTag,{value:"Module"}));class qA extends Xr{initializeProgram(e){return new Yr(e.rctx,qA.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:ia})}}qA.shader=new Zr(kA,(()=>Promise.resolve().then((()=>kA))));const zA=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr;return e.include(qa),e.fragment.uniforms.add(new $r("blendWeightsTexture",(e=>e.inputTexture)),new $r("colorTexture",(e=>e.color))),e.fragment.code.add(Tn`void main() {
vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
vec4 offsets = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets.zw).g;
a.a = texture(blendWeightsTexture, offsets.xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}
}`),e}},Symbol.toStringTag,{value:"Module"}));class BA extends Xr{initializeProgram(e){return new Yr(e.rctx,BA.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:ia})}}BA.shader=new Zr(zA,(()=>Promise.resolve().then((()=>zA))));const HA=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new qr;return e.include(qa),e.fragment.uniforms.add(new $r("colorTexture",(e=>e.color))),e.outputs.add("fragEdges","vec2"),e.fragment.code.add(Tn`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      vec2 resolution = 1.0 / vec2(textureSize(colorTexture, 0));
      vec4 offsets[3];
      offsets[0] = vec4(uv.x - resolution.x, uv.y, uv.x, uv.y + resolution.y);
      offsets[1] = vec4(uv.x + resolution.x, uv.y, uv.x, uv.y - resolution.y);
      offsets[2] = vec4(uv.x - 2.0 * resolution.x, uv.y, uv.x, uv.y + 2.0 * resolution.y);

      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture(colorTexture, uv).rgb;

      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${Tn.float(.05)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges *= step(maxDelta, float(${Tn.float(2)}) * delta.xy);

      fragEdges = edges;
    }
  `),e}},Symbol.toStringTag,{value:"Module"}));class GA extends Xr{initializeProgram(e){return new Yr(e.rctx,GA.shader.get().build(),Rn)}initializePipeline(){return ea({colorWrite:ia})}}GA.shader=new Zr(HA,(()=>Promise.resolve().then((()=>HA))));class WA extends Pn{}let $A=class extends za{constructor(e){super(e),this._context=null,this._areaTexture=null,this._searchTexture=null,this._isEnabled=!1,this._smaaParameters=new WA,this.produces=new Map([[ns.ANTIALIASING,()=>this._isEnabled&&null!=this._context]])}consumes(){return Ya}get updating(){return null!=this._abortController}initializeRenderContext(e){this._context=e,this.addHandles([U((()=>this.view.qualitySettings.antialiasingEnabled),(()=>this.renderFeatureChanged()),j)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(eo.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable(),this._context=null}async enable(){if(this._isEnabled||!this._context||this._abortController)return;if(this._edgeTechnique??=this._context.techniqueRepository.acquire(GA),this._blendTechnique??=this._context.techniqueRepository.acquire(qA),this._blurTechnique??=this._context.techniqueRepository.acquire(BA),this._areaTexture&&this._searchTexture)return void(this._isEnabled=!0);this._abortController=new AbortController;const e=this._abortController.signal;try{const t=await import("../chunks/SMAAData.js");await this._loadTextures(this._context,t,e),this._context?.requestRender()}catch{}this._abortController=null}async _loadTextures(e,t,i){if(m(i),!e)throw o();const[r,s]=await Promise.allSettled([wp(t.areaTexture,{signal:i}),wp(t.searchTexure,{signal:i})]);m(i),"fulfilled"===r.status&&"fulfilled"===s.status&&(this._areaTexture=QA(e.fbos.rctx,Wn.LINEAR,$n.RGB,r.value),this._searchTexture=QA(e.fbos.rctx,Wn.NEAREST,$n.LUMINANCE,s.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=N(this._areaTexture),this._searchTexture=N(this._searchTexture)}disable(){this._abortController=I(this._abortController),this._isEnabled=!1}destroy(){this.disable(),this._disposeTextures()}renderNode(e,t,i,r){const s=i?.get("composite-color")?.getTexture();if(!(this._isEnabled&&this._context&&i&&s))return r;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),r;const n=s.descriptor.width,a=s.descriptor.height,o=this._context.fbos,l=e.rctx;l.setViewport(0,0,n,a);const c=o.acquire(n,a,"smaa edges",ma.RG);l.setClearColor(0,0,0,1),l.clear(Yn.COLOR_BUFFER_BIT),this._smaaParameters.color=s,l.bindTechnique(this._edgeTechnique,null,this._smaaParameters),l.screen.draw();const h=o.acquire(n,a,"smaa blend");return l.setClearColor(0,0,1,1),l.clear(Yn.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(this._blendTechnique,null,this._smaaParameters),l.screen.draw(),l.bindFramebuffer(r?.fbo),c.release(),l.setClearColor(0,1,0,1),l.clear(Yn.COLOR_BUFFER_BIT),this._smaaParameters.inputTexture=h.getTexture(),l.bindTechnique(this._blurTechnique,null,this._smaaParameters),l.screen.draw(),h.release(),r}};function QA(e,t,i,r){const s=new Lo;return s.pixelFormat=i,s.wrapMode=Hn.CLAMP_TO_EDGE,s.width=r.width,s.height=r.height,s.samplingMode=t,new Fo(e,s,r)}e([ae()],$A.prototype,"view",void 0),e([ae()],$A.prototype,"_context",void 0),e([ae()],$A.prototype,"_abortController",void 0),e([ae({readOnly:!0})],$A.prototype,"updating",null),$A=e([le("esri.views.3d.webgl-engine.effects.smaa.SMAA")],$A);class XA{constructor(){this._step=tM,this._dilation=1,this._firstIdleTime=$(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=$(performance.now())):this._firstIdleTime=$(0),b("disable-feature:high-quality-idle"))this._dilation=1;else{const e=t?performance.now()-this._firstIdleTime:0;if(e>=ZA+KA)return this._step=$(1/0),void(this._dilation=1);this._dilation=e>=ZA?JA:1}const i=Ft(e/YA,tM,iM);this._step===1/0?this._step=$(i):this._step=$(this._step*eM+i*(1-eM))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=$(0)}}const YA=.5,ZA=$(12e4),KA=$(1e4),JA=10,eM=.9,tM=$(1e3),iM=$(1e3/30);class rM{constructor(e,t){this._fbos=e,this.compositingHelper=t,this._width=4,this._height=4,this._clearColor=tr()}dispose(){this._color=L(this._color),this.releaseBuffers()}get framebuffer(){return this.color.attachDepth(this.depth),this.color.fbo}get colorTexture(){return this.color.getTexture()}get depthTexture(){return this.depth.attachment}initializeFrame(e,t,i){this._fbos.interactive=i===pn.Default;const r=this._fbos.rctx;this._width=e.fullWidth,this._height=e.fullHeight,Mo(this,r.parameters.maxTextureSize);const s=this._color;return this._color=null,this.releaseBuffers(),Zi(this._clearColor,t),s}releaseBuffers(){this._color?.detachDepth(),this._depth=L(this._depth)}renderHUDVisibility(e,t,i){return e?.fbo.width===this._width&&e?.fbo.height===this._height||(e?.release(),e=this._fbos.acquire(this._width,this._height,"hud visibility",ma.RGBA4)),e.attachDepth(i||this.depth),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(sM),t(),e.detachDepth(),e}compositeToHUDVisibility(e,t){this._fbos.rctx.bindFramebuffer(e.hudVisibility?.fbo),this.compositingHelper.compositeHUD(e,t)}renderOITPass(e,t,i){let r,s;const{_width:n,_height:a}=this;switch(t){case aa.Color:r=this._fbos.acquire(n,a,i?"oit hud color":"oit color",ma.RGBA16F),s=[0,0,0,0];break;case aa.Alpha:r=this._fbos.acquire(n,a,i?"oit hud alpha":"oit alpha",ma.R16F),s=[1,1,1,1];break;case aa.FrontFace:r=this._fbos.acquire(n,a,i?"oit hud front":"oit front"),s=[0,0,0,0]}return i?r.acquireDepth(fa.DEPTH16_BUFFER):r.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(r.fbo),this._fbos.rctx.clearFramebuffer(s,i,i),e(),r.detachDepth(),r}compositeToFramebuffer(e,t,i,r){this.bindFbo(),this.compositingHelper.composite(e,t,i,r)}compositeTransparentOntoOpaque(e,t,i,r,s){s?(this._fbos.rctx.bindFramebuffer(s.fbo),this._fbos.rctx.setClearColor(0,0,0,1e-13),this._fbos.rctx.clearSafe(Yn.COLOR_BUFFER_BIT)):this.bindFbo(),this.compositingHelper.compositeOIT(e,t.getTexture(),i.getTexture(),r.getTexture())}renderDepthDetached(e){this._bindTarget(this.color),e(),this._bindTarget(this.color,this.depth)}renderToCachedFBO(e,t,i,r,s=ma.RGBA,n=fa.DEPTH16_BUFFER,a=this._width,o=this._height,l=null){return e?.fbo.width===a&&e?.fbo.height===o||(e=L(e)),e=e??this._fbos.acquire(a,o,t,s),l?.forEach((t=>e.acquireColor(t.attachment,t.format))),null!=n&&e.acquireDepth(n),this._fbos.rctx.bindFramebuffer(e.fbo),this._fbos.rctx.clearFramebuffer(r,!0,!0),i(),e}renderToTargets(e,t,i,r,s=!1,n=!1){this._bindTarget(t,i),this._fbos.rctx.clearFramebuffer(r,s,n),e(),t.detachDepth()}bindFbo(){const e=null==this._color;if(this._bindTarget(this.color,this.depth),e){const e=this._fbos.rctx;e.setClearStencil(0),e.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),e.clearSafe(Yn.COLOR_BUFFER_BIT|Yn.DEPTH_BUFFER_BIT|Yn.STENCIL_BUFFER_BIT)}}_bindTarget(e,t){e.attachDepth(t),this._fbos.rctx.bindFramebuffer(e.fbo)}get width(){return this._width}get height(){return this._height}get color(){return this._ensureColor()}_ensureColor(){return this._color||(this._color=this._fbos.acquire(this._width,this._height,"composite-color")),this._color}updateColor(e,t){const i=this._ensureColor();i.attachDepth(this.depth),i.setName(t),this._color=e(i)}get depth(){return this._depth||(this._depth=this._fbos.acquireDepth(fa.DEPTH_STENCIL_TEXTURE,this._width,this._height,"depth")),this._depth}}const sM=[0,1,0,1],nM=wr(),aM=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastMaxSamples:255,build:function(e){const t=new qr,i=t.fragment;return i.include(es),i.include(Qr),t.include(bp),t.include(qa),t.include(_o,e),i.uniforms.add(new $r("shadowMap",((e,t)=>t.shadowMap.depthTexture)),new $r("depthMap",((e,t)=>t.linearDepth?.getTexture())),new zr("inverseViewMatrix",((e,t)=>vr(nM,fr(nM,t.camera.viewMatrix,t.camera.center)))),new Hr("nearFar",((e,t)=>t.camera.nearFar))),i.constants.add("sampleValue","float",.00392156862745098),t.outputs.add("sampleCount","float"),i.code.add(Tn`void main(void) {
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
ivec2 texSize = textureSize(shadowMap, 0);
ivec2 uvShadow = ivec2(cascadeCoordinates(i, texSize, lvpos) * vec2(texSize));
float depthShadow = readShadowMapDepth(uvShadow, shadowMap);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
sampleCount = sampleValue;
}`),t}},Symbol.toStringTag,{value:"Module"}));class oM extends Pn{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=sr(lM),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}}const lM=rr(.01,0,.25,1),cM=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:oM,build:function(e){const t=new qr,i=t.fragment;i.include(es),i.include(Qr),t.include(bp),t.include(qa);const{visualization:r,bandsEnabled:s}=e;i.constants.add("inverseSampleValue","float",255),i.uniforms.add(new $r("shadowCastMap",(e=>e.shadowCastMap)),new Wr("sampleScale",(e=>e.sampleScale)),new Wr("opacityFromElevation",(e=>e.opacityFromElevation)),new Gr("uColor",(e=>e.color)));const n=r===dl.Gradient,a=r===dl.Threshold;return n&&s?i.uniforms.add(new Wr("bandSize",(e=>e.bandSize))):a&&i.uniforms.add(new Wr("threshold",(e=>e.threshold))),i.code.add(Tn`
    void main(void) {
      float record = texture(shadowCastMap, uv).r;
      float pixelSamples = record * inverseSampleValue;
      if (pixelSamples < 1.0) {
        discard;
      }

      float strength = pixelSamples * sampleScale;

      ${a?Tn`
          if (strength <= threshold) {
            discard;
          }`:""}

      ${n&&s?Tn`strength = ceil(strength / bandSize) * bandSize;`:""}

      fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?Tn`* strength`:""});
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class hM extends Xr{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,hM.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:oa,colorWrite:ia,depthTest:null,depthWrite:null})}get primitiveType(){return qn.TRIANGLE_STRIP}}hM.shader=new Zr(cM,(()=>Promise.resolve().then((()=>cM))));const dM=1/512;let uM=class extends pe{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new oM(this._data),this._techniqueConfig=new ul,this._enabled=!1,this._vao=va(t)}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=N(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(hM,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,No(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>dM}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;er(e,t)||(Zi(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};e([ae()],uM.prototype,"opacityFromElevation",null),uM=e([le("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],uM);class pM extends Xr{constructor(e){super(e,new DA,(()=>this.destroy()))}initializeProgram(e){return new Yr(e.rctx,pM.shader.get().build(this.configuration),Rn)}initializePipeline(){return ea({blending:ra(jn.ONE,jn.ONE,jn.ONE,jn.ONE),colorWrite:ia,depthTest:null,depthWrite:null})}get primitiveType(){return qn.TRIANGLE_STRIP}}pM.shader=new Zr(aM,(()=>Promise.resolve().then((()=>aM))));let mM=class extends pe{constructor(e,t,i,r,s,n){super({}),this.fbos=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new io,this._cachedLightDirections=[],this._depthRange=_O,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new Vs(new mn(e,i.viewingMode),null),this._bindParameters.shadowMap.enabled=!0,this._vao=va(this._rctx),this._accumulationRenderer=new uM(t,this._rctx,this,n);const a=this._stage.view.resourceController.scheduler;this.addHandles([a.registerTask(jo.SHADOW_ACCUMULATOR,this),U((()=>i.renderView),(e=>{this.removeHandles(gM),null!=e&&this.addHandles(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),gM)}),j),U((()=>this._previewing),(()=>this._requestRenderIfEnabled()),q)],this._shadowAccumulatorKey)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=N(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=N(this._fbo),this._vao=N(this._vao),this._accumulationTechniqueCached=L(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo?.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(null==this._accumulationTechniqueCached){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new pM(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return null!=this._fbo&&this._sampleCount>0}get canAccumulate(){return null!==this._bindParameters.linearDepth?.getTexture()&&this._depthRange!==_O&&this._opacityFromElevation>dM}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(T(t,e,Ni))return;const i=Math.min(255,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r)t[r]=Ti(t[r]??we(),e[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this._bindParameters.linearDepth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(_M,this._sampleCount-this._progress);for(let e=0;e<s;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(void 0!==e.enabled){const t=null!=this._fbo;e.enabled!==t&&(e.enabled?this._enable():this._disable())}void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,$n.RED,Kn.UNSIGNED_BYTE,fM),fM[0]/this._progress)}_enable(){this._progress=0;const e=new Lo;e.pixelFormat=$n.RED,e.internalFormat=Zn.R8,e.wrapMode=Hn.CLAMP_TO_EDGE,this._fbo=new Ao(this._rctx,e),this._requestRender()}_disable(){this._fbo=N(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Yn.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,No(this._vao,"geometry"))}_updateCamera(e){const t=this._fbo;if(null==t)return;const i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-kt(4e4,5e4,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};e([ae()],mM.prototype,"_progress",void 0),e([ae()],mM.prototype,"_sampleCount",void 0),e([ae()],mM.prototype,"_fbo",void 0),e([ae()],mM.prototype,"_depthRange",void 0),e([ae()],mM.prototype,"_previewing",void 0),e([ae()],mM.prototype,"_accumulationRenderer",void 0),e([ae()],mM.prototype,"_isRefining",null),e([ae()],mM.prototype,"_isActive",null),e([ae()],mM.prototype,"canAccumulate",null),e([ae()],mM.prototype,"_isDoneAccumulating",null),e([ae()],mM.prototype,"_opacityFromElevation",null),e([ae()],mM.prototype,"running",null),mM=e([le("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],mM);const _M=6,gM="renderView",fM=new Uint8Array(1),yM=ot();class vM{constructor(){this._plane=ot()}get isEnabled(){return!ht(this.plane,yM)}get plane(){return this._plane}set plane(e){lt(e||yM,this._plane)}}class xM{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const t=this._originData.get(e.id)||new wM(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}release(e){e.refCount--,0===e.refCount&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach((t=>{hr(t.viewMatrix,e),function(e,t){const i=e[0],r=e[1],s=e[2];t[12]+=i*t[0]+r*t[4]+s*t[8],t[13]+=i*t[1]+r*t[5]+s*t[9],t[14]+=i*t[2]+r*t[6]+s*t[10],t[14]+=i*t[3]+r*t[7]+s*t[11]}(t.origin.vec3,t.viewMatrix)}))}}class wM{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=wr()}}class bM extends Es{constructor(e,t){super(),this.distanceFalloffFactor=e,this.transparency=t,this.transformNormalViewFromGlobal=Oo()}}class CM extends As{constructor(){super(...arguments),this.transformNormalViewFromGlobal=Oo(),this.slicePlaneLocalOrigin=we(),this.transformNormalGlobalFromModel=Oo()}}function TM(e){const t=Tn`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}const PM=ar(.5,-4e-4);function SM(e,t){const i=e.vertex;i.include(TM),i.constants.add("depthBias","vec2",PM),i.uniforms.add(new Hr("inverseViewport",((e,t)=>t.inverseViewport))),t.legacy?(i.uniforms.add(new zr("proj",((e,t)=>t.camera.projectionMatrix))),i.code.add(Tn`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(i.uniforms.add(new is("transformNormalViewFromGlobal",(e=>e.transformNormalViewFromGlobal)),new zr("transformProjFromView",(e=>e.transformProjFromView))),i.code.add(Tn`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),i.code.add(Tn`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function RM(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(Tn`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(Tn`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function OM(e,t){const i=e.vertex;t.silhouette?(i.code.add(Tn`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(Tn`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
vec3 viewNormalA = _modelToViewNormal(data.normal);
vec3 viewNormalB = _modelToViewNormal(data.normal2);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(Tn`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
vec3 worldNormalA = _modelToWorldNormal(data.normal);
vec3 worldNormalB = _modelToWorldNormal(data.normal2);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(Tn`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos, ComponentData data) {
return false;
}`)}function EM(e,t){const i=e.vertex;i.include(es),e.include(Ir,t),i.uniforms.add(new Wr("distanceFalloffFactor",(e=>e.distanceFalloffFactor))),i.code.add(Tn`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add(new Fr("componentDataTex",(e=>e.componentDataTexture))),e.attributes.add(Sn.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentVerticalOffsetFieldOffset","float",2),i.constants.add("componentFieldCount","float",3),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("verticalOffsetScale","float",858993.4592),i.code.add(Tn`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
      float texSize = float(textureSize(componentDataTex, 0).x);
      float colIndex = mod(fieldIndex, texSize);
      float rowIndex = floor(fieldIndex / texSize);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      vec3 normal;
      vec3 normal2;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
      vec3 normal = normalModel();
      vec3 normal2 = ${t.silhouette?Tn`decompressNormal(normal2Compressed)`:Tn`normal`};

      vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);
      vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);
      float verticalOffset = (rgba2float(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) - 0.5) * verticalOffsetScale;

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        normal, normal2,
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),t.legacy?i.code.add(Tn`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add(new Ms("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel))),i.code.add(Tn`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(Sn.NORMAL2COMPRESSED,"vec2"),i.code.add(Tn`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(normalize(data.normal + data.normal2));
}`)):i.code.add(Tn`vec3 worldNormal(ComponentData data) {
return _modelToWorldNormal(data.normal);
}`),t.legacy?i.code.add(Tn`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(i.include(Ds,t),i.uniforms.add(new is("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new Ms("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new Is("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL)),new Is("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new Br("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new Br("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH))),i.code.add(Tn`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${t.spherical?Tn`normalize(transformWorldFromModelTL + rotatedModelPosition);`:Tn`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),i.uniforms.add(new zr("transformProjFromView",((e,t)=>t.camera.projectionMatrix))),i.code.add(Tn`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),i.code.add(Tn`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}var AM,MM;function DM(e,t){const i=e.vertex;switch(e.attributes.add(Sn.SIDENESS,"vec2"),t.mode===AM.MIXED?i.code.add(Tn`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(Tn`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case AM.MIXED:i.code.add(Tn`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case AM.SKETCH:i.code.add(Tn`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case AM.SOLID:i.code.add(Tn`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case AM.COUNT:break;default:ni(t.mode)}}function IM(e,t){const i=e.vertex;switch(e.include(DM,t),t.mode){case AM.SOLID:i.code.add(Tn`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case AM.SKETCH:i.uniforms.add(new uo("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add(Tn`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case AM.MIXED:i.uniforms.add(new uo("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add(Tn`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function LM(e,t){e.include(DM,t);const{vertex:i,fragment:r}=e;var s;switch(((s=t).mode===AM.SKETCH||s.mode===AM.MIXED)&&(i.uniforms.add(new Fr("strokesTexture",(e=>e.strokesTexture.texture))),i.uniforms.add(new uo("strokesLog2Resolution",(e=>Math.log2(e.strokesTexture.resolution))),new uo("strokeVariants",(e=>e.strokesTexture.variants))),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add(new Fr("strokesTexture",(e=>e.strokesTexture.texture)),new uo("strokesNormalizationScale",(e=>e.strokesTexture.normalizationScale))),i.code.add(Tn`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) / vec2(textureSize(strokesTexture, 0));
vStrokeUV.x += variantOffset;
}`),e.fragment.include(es),r.code.add(Tn`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case AM.SOLID:i.code.add(Tn`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(Tn`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case AM.SKETCH:i.code.add(Tn`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(Tn`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case AM.MIXED:e.varyings.add("vType","float"),i.code.add(Tn`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(Tn`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"}(AM||(AM={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.SILHOUETTE=1]="SILHOUETTE"}(MM||(MM={}));const NM=nr();class FM extends ls{constructor(e){super(e,"mat4")}}const VM=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new qr,{vertex:i,fragment:r}=t;return e.legacy&&i.uniforms.add(new FM("model"),new FM("localView")),t.include(SM,e),t.include(EM,e),t.include(IM,e),t.include(DM,e),t.include(LM,e),t.include(fs,e),t.include(OM,e),t.include(RM,e),t.include(Ts,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),e.multipassEnabled&&t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add(new Hr("pixelToNDC",((e,t)=>zi(NM,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new Gr("viewport",((e,t)=>t.camera.fullViewport)),new Wr("pixelRatio",((e,t)=>t.camera.pixelRatio))),t.attributes.add(Sn.POSITION0,"vec3"),t.attributes.add(Sn.POSITION1,"vec3"),t.attributes.add(Sn.VARIANTOFFSET,"float"),t.attributes.add(Sn.VARIANTSTROKE,"float"),t.attributes.add(Sn.VARIANTEXTENSION,"float"),i.code.add(Tn`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      ${e.multipassEnabled?"vViewPos = viewPos;":""}

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${e.antialiasing?Tn`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:Tn`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${e.mode===AM.SKETCH?Tn`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:e.mode===AM.MIXED?Tn`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0, component)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(component), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),r.code.add(Tn`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.multipassEnabled?"terrainDepthTest(vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      fragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class UM extends Xr{initializeProgram(e){return new Yr(e.rctx,UM.shader.get().build(this.configuration),pp)}initializePipeline(e){return e.blendMinMax?ea({blending:ra(jn.ONE,jn.ONE,jn.ZERO,jn.ONE,zn.ADD,e.blendMinMax.MAX),depthTest:{func:kn.LEQUAL},colorWrite:ia}):ea({depthTest:{func:kn.LEQUAL},depthWrite:na,colorWrite:ia})}}UM.shader=new Zr(VM,(()=>Promise.resolve().then((()=>VM))));class jM extends rs{constructor(){super(...arguments),this.mode=AM.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.spherical=!1}}e([ua({count:AM.COUNT})],jM.prototype,"mode",void 0),e([ua()],jM.prototype,"hasSlicePlane",void 0),e([ua()],jM.prototype,"silhouette",void 0),e([ua()],jM.prototype,"legacy",void 0),e([ua()],jM.prototype,"antialiasing",void 0),e([ua()],jM.prototype,"doublePrecisionRequiresObfuscation",void 0),e([ua()],jM.prototype,"multipassEnabled",void 0),e([ua()],jM.prototype,"cullAboveGround",void 0),e([ua()],jM.prototype,"spherical",void 0),e([ua({constValue:!1})],jM.prototype,"occlusionPass",void 0),e([ua({constValue:Nr.Compressed})],jM.prototype,"normalType",void 0);const kM={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},qM={solid:AM.SOLID,sketch:AM.SKETCH,uber:AM.MIXED};class zM{constructor(e,t,i){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new jM,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[Tp.TRANSPARENT]:{[Tp.TRANSPARENT]:new Y,[Tp.OPAQUE]:new Y},[Tp.OPAQUE]:{[Tp.TRANSPARENT]:new Y,[Tp.OPAQUE]:new Y}},this._renderablesDirty=!1,this._drawParameters=new CM,this._settings={...kM,...i},this.key=zM.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const r=this._settings.strokesTexture.variants;this.writerSettings={variants:r,reducedPrecision:Th.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=qM[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=L(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables();const i=this._sortedRenderables[t];i[Tp.TRANSPARENT].forAll(e),i[Tp.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.multipassEnabled=!!e.multipassEnabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(UM,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),t,e)}bindSilhouetteEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),t,e)}renderRegularEdges(e,t,i,r,s){this._render(e,t,t.regular.vao,i,r,s)}renderSilhouetteEdges(e,t,i,r,s){this._render(e,t,t.silhouette.vao,i,r,s)}_render(e,t,i,r,s,n){n>0&&(this._bindDraw(e,t,r,s),this._rctx.bindVAO(i),this._rctx.drawArraysInstanced(qn.TRIANGLE_FAN,0,4,n))}_bindDraw(e,t,i,r){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{const e=new eE(t.transform.position),i=wo(BM,bo(BM,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=i;const s=r.camera.viewInverseTransposeMatrix;ui(this._drawParameters.slicePlaneLocalOrigin,s[3],s[7],s[11])}e.bindDraw(this._drawParameters,r,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[Tp.TRANSPARENT][Tp.TRANSPARENT].clear(),this._sortedRenderables[Tp.TRANSPARENT][Tp.OPAQUE].clear(),this._sortedRenderables[Tp.OPAQUE][Tp.TRANSPARENT].clear(),this._sortedRenderables[Tp.OPAQUE][Tp.OPAQUE].clear(),this._renderables.forEach((e=>{e.objectTransparency!==Tp.INVISIBLE&&e.edgeTransparency!==Tp.INVISIBLE&&this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform?"origin"in t.transform?e.transform.origin.origin.id<t.transform.origin.origin.id?-1:e.transform.origin.origin.id>t.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[Tp.TRANSPARENT][Tp.TRANSPARENT].sort(e),this._sortedRenderables[Tp.TRANSPARENT][Tp.OPAQUE].sort(e),this._sortedRenderables[Tp.OPAQUE][Tp.TRANSPARENT].sort(e),this._sortedRenderables[Tp.OPAQUE][Tp.OPAQUE].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const BM=op();function HM(e,t){if(!e)return null;const i=e.length/2,r=WM*i,s=new Array(i);let n=0;const a=t===GM.PRESSURE;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[n++]=a?Math.min(r,1-(1-i)*$M):Math.min(r,i*$M)}return s}var GM;!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(GM||(GM={}));const WM=.1,$M=.5;class QM{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=N(this.texture)}}const XM=[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}];function YM(e){let t=null;for(const i of e){const e=i.type;if(eD(i))if(null==t)t=e;else if(t!==e)return"uber"}return null!=t?t:"uber"}function ZM(e){let t=Tp.INVISIBLE;for(const{material:i}of e)if(JM(i)){if(i.color[3]*i.opacity<1)return Tp.TRANSPARENT;t=Tp.OPAQUE}return t}function KM(e){let t=Tp.INVISIBLE;for(const{material:i}of e)if(JM(i)){switch(i.objectTransparency){case Tp.TRANSPARENT:case Tp.INVISIBLE:return Tp.TRANSPARENT;case Tp.OPAQUE:if(i.opacity<1)return Tp.TRANSPARENT}t=Tp.OPAQUE}return t}function JM(e){return e.size*e.color[3]*e.opacity>0}function eD(e){return e.size*e.color[3]>0}function tD(e,t,i,r){for(let s=0;s<e.length;s++){const n=e[s].index,a=t[s],o=t[s+1];if(r)for(let e=a;e<o;e++){const t=r[e];i.set(t,n)}else for(let e=a;e<o;e++)i.set(e,n)}}let iD=class extends pe{constructor(e){super(e),this._updatingHandles=new rl,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=we(),this._localOrigins=new xM(new rn(e.renderSR))}initialize(){this._worker=new Pp(this.schedule),this._componentColorManager=new dE(this.rctx,3);const e=mp.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=el.createVertex(this.rctx,Gn.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=N(this._strokesTexture),this._componentColorManager=D(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=N(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",mD))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,i,r,s,n){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let a;const o=new sD(new Promise((e=>a=e)),e.obb.center,e.obb.radius);this._perObjectData.set(e,o);const l=await this._updatingHandles.addPromise(this._addComponentGeometry(e.transform,o,t,i,r,s,n));return this.setNeedsRender(),a(),l}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void A.getLogger(this).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(e);let n;s?.renderables.length>0&&this._perObjectDataEvictionCache.add(s);const a=e.boundingVolumeWorldSpace.bounds,o=new sD(new Promise((e=>n=e)),yl(a),bl(a));this._perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometries[r];if(s.material.supportsEdges){if(t){if(!T(t,s.transformation))return!1}else t=s.transformation;if(i||null==s.localOrigin){if(null!=i?.localOrigin&&null!=s.localOrigin&&i.localOrigin.id!==s.localOrigin.id)return!1}else i=s}}return!0}(e))l.push(this._addObjectMergedGeometries(e,o,t,i,r));else for(let s=0;s<e.geometries.length;s++){const n=e.geometries[s];n.material.supportsEdges&&l.push(this._addGeometry(e,o,n,t[0],i,r))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),n()}fastUpdateObject3DEdgesTransform(e){if(this.destroyed)return!1;const t=this._perObjectData.get(e);if(!t)return!1;const{geometries:i}=e,{renderables:r}=t;if(0===i.length||0===r.length)return!0;if(r.length>1)return!1;const[s]=r,n=s.transform;if(!(n instanceof oD))return!1;const[a]=i;if(a.localOrigin!==n.origin.origin)return!1;const o=wr(),l=this._computeModelTransformWithLocalOrigin(e,a,o);return s.transform=new oD(o,l),this.setNeedsRender(),!0}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(null==i)return;const r=t instanceof Array?e=>t[e]:()=>t;i.renderables.forEach((e=>{const t=e.components.meta.length;for(let i=0;i<t;i++){const t=r(i),s=e.components.meta[i],n=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(n,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return null!=t?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof Wu,n=!!i.hasSlicePlane,a=YM(t),o=zM.getKey(a,n,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=l&&(l.renderables.forEach((e=>{if(o!==e.rendererKey){const t=this._renderers.get(e.rendererKey),i=this._acquireRenderer(a,n,s);t.removeRenderable(e),--t.refCount,e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=i&&(i.renderables.forEach((e=>{const i=e.components.meta;for(let r=0;r<i.length;r++)e.components.meta[r].verticalOffset=t?.[r]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender())}async updateObjectVisibility(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));null!=i&&(i.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}removeObject(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this._perObjectData.get(e);if(!t)throw new Error("no object");return await t.loaded,null==t.loaded?null:t}render(e,t){if(null==this._componentColorManager)return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=we(),s=new eE;let n=0,a=0;if(this._renderers.forEach((i=>{if(0===i.refCount)return this._renderers.delete(i.key),void i.dispose();let r=!0,s=!0;i.forEachRenderable((t=>{t.visible&&(n+=t.statistics.averageEdgeLength,a++,r&&t.regular&&(i.updateTechnique(e,!1),r=!1),s&&t.silhouette&&(i.updateTechnique(e,!0),s=!1))}),t)})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===a)return;const o=new bM(40*n/a,t);ui(r,i[3],i[7],i[11]),s.set(r),Ti(o.transformWorldFromViewTH,s.high),Ti(o.transformWorldFromViewTL,s.low),xo(o.transformViewFromCameraRelativeRS,e.camera.viewMatrix),wo(pD,o.transformViewFromCameraRelativeRS),bo(o.transformNormalViewFromGlobal,pD),o.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,o),this._renderSilhouetteEdges(t,e,o)}))}_updateTransparency(e){const t=ZM(e.components.meta),i=KM(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){e.getCombinedShaderTransformation(t,i);const r=null!=t.localOrigin?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire(ui(this._tmpModelPosition,i[12],i[13],i[14]));return t.localOrigin=r.origin,function(e,t){const i=-e[0],r=-e[1],s=-e[2],n=t[3],a=t[7],o=t[11],l=t[15];t[0]+=n*i,t[1]+=n*r,t[2]+=n*s,t[4]+=a*i,t[5]+=a*r,t[6]+=a*s,t[8]+=o*i,t[9]+=o*r,t[10]+=o*s,t[12]+=l*i,t[13]+=l*r,t[14]+=l*s}(r.origin.vec3,i),r}_updateComponentBuffer(e){const{meta:t,buffer:i}=e,r=new Uint8Array(4);for(let e=0;e<t.length;e++){const s=t[e].material,n=t[e].index,a=Ft(Math.round(8*s.size),0,255),o=Ft(s.extensionLength,-128,127)+128,l="solid"===s.type?_p.SOLID:_p.SKETCH,c=255*s.opacity,h=s.color,d=255*h[0],u=255*h[1],p=255*h[2],m=255*h[3];i.textureBuffer.setData(n,0,d,u,p,m),i.textureBuffer.setData(n,1,a,o,l,c),UO(t[e].verticalOffset,r),i.textureBuffer.setData(n,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(e){if(null==this._componentColorManager)return null;const t=new Array,i=this._componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],n=i.acquireIndex();t.push({index:n,verticalOffset:0,material:s})}const r=new nD(i,t);return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,n=s.length){return this._worker.process({data:t,indices:s,indicesLength:n,writerSettings:e,skipDeduplicate:i},this._workerAbort.signal,r)}_createRenderable(e,t,i,r,s){const n=t=>null!=this._verticesBufferObject?new aD(new Ko(this.rctx,pp,{vertices:gp,instances:t===MM.REGULAR?fp.glLayout:yp.glLayout},{vertices:this._verticesBufferObject,instances:el.createVertex(this.rctx,Gn.STATIC_DRAW,t===MM.REGULAR?e.regular.instancesData.buffer:e.silhouette.instancesData.buffer)}),t===MM.REGULAR?e.regular.lodInfo:e.silhouette.lodInfo):null,a=e.regular.lodInfo.lengths.length>0?n(MM.REGULAR):null,o=e.silhouette.lodInfo.lengths.length>0?n(MM.SILHOUETTE):null,l=(a?.vao.usedMemory??0)+(o?.vao.usedMemory??0);return new lD(a,o,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:e.averageEdgeLength},i,ZM(t.meta),KM(t.meta),t,r)}async _addGeometry(e,t,i,r,s,n){if(i.edgeIndicesLength<=0)return;const a=i.attributes.get(Sn.POSITION),o=wr(),l=this._computeModelTransformWithLocalOrigin(e,i,o),c=new uD(a,o,l);return this._addPositionData(t,c,i.edgeIndicesLength,r,s,n)}async _addPositionData(e,t,i,r,s,n=!1){if(null==e.loaded)return;const a=this._createComponentBuffers([r]);if(null==a)return;const o=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=t,h=t.position.indices,d=t.position,u=d.data.length/d.size,p=up.createBuffer(u);for(let e=0;e<u;e++)p.position.set(e,0,d.data[e*d.size]),p.position.set(e,1,d.data[e*d.size+1]),p.position.set(e,2,d.data[e*d.size+2]);tD(a.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,p,!1,n,h,i));if(null==e.loaded)return;const _=this._createRenderable(m,a,new oD(l,c),o.key,!1);e.renderables.push(_),o.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,i,r,s,n,a){if(null==t.loaded)return 0;const o=this._createComponentBuffers(n);if(null==o)return 0;const l=YM(n),c=this._acquireRenderer(l,a.hasSlicePlane||!1,!1),h=up.createBuffer(i.length/3);jd(h.position.typedBuffer,i,h.position.typedBufferStride,3),tD(o.meta,s,h.componentIndex,r);const d=c.writerSettings,u=await this._updatingHandles.addPromise(this._extractEdges(d,h,!0,!1,r));if(null==t.loaded)return 0;const p=this._createRenderable(u,o,e,c.key,!0);return t.renderables.push(p),c.addRenderable(p),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,i,r,s){const n=new Map;let a=0,o=null,l=0;const c=e.geometries.filter((e=>{if(e.edgeIndicesLength<=0||!e.material.supportsEdges)return!1;!o&&e.localOrigin&&(o=e);const t=e.attributes.get(Sn.POSITION);return l+=t.data.length/t.size,a+=e.edgeIndicesLength,!0}));if(0===c.length)return;const h=l>=65536?Uint32Array:Uint16Array,d=a?new h(a):null,u=[];let p=0;c.forEach((e=>{const t=e.attributes.get(Sn.POSITION),i=t.indices;let r=n.get(t.data);if(null==r){r=u.length/3;for(let e=0;e<t.data.length;e+=t.size)u.push(t.data[e]),u.push(t.data[e+1]),u.push(t.data[e+2]);n.set(t.data,r)}for(let t=0;t<e.edgeIndicesLength;t++)d[p++]=r+i[t]}));const m=o||e.geometries[0],_=wr(),g=this._computeModelTransformWithLocalOrigin(e,m,_);for(let t=0;t<e.geometries.length;t++)e.geometries[t].localOrigin=g.origin;const f=new uD(new Bu(u,d,3),_,g);await this._updatingHandles.addPromise(this._addPositionData(t,f,d.length,i[0],r,s))}_acquireRenderer(e,t,i){const r=zM.getKey(e,t,i);let s=this._renderers.get(r);return null==this._strokesTexture&&(this._strokesTexture=function(e){const t=256,i=new Uint8Array(262144),r=1024,s=Math.log2(t)+1,n=XM.length;let a=(s-1)*n*r;for(const{distance:e,pressure:t}of XM){let o=e,l=t,c=a;for(let e=0;e<s;e++){0!==e&&(o=HM(o,GM.DISTANCE),l=HM(l,GM.PRESSURE));for(let e=0;e<256;e++){const t=.5+(o?o[e%o.length]/16:0),r=l?l[e%l.length]:1;lp(t,i,c),lp(r,i,c+131072),c+=4}c-=r*(n+1)}a+=r}const o=new Fo(e,new Lo(t),i);return new QM(t,16,8,n,o)}(this.rctx)),s||(s=new zM(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:i,spherical:this.viewingMode===Mt.Global}),this._renderers.set(r,s)),++s.refCount,s}_removeRenderable(e){rD(e.regular),rD(e.silhouette);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=we(),s=e=>{Ci(r,e.center,t);const s=gi(r,i),n=e.radius,a=s<-n?1/0:s<n?0:s-n;e.renderables.forEach((e=>e.distanceToCamera=a))};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){const r=e.bindRegularEdges(i,t),s=i.transparency,n=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!cD(s)||!s.visible)return;const a=dD(s.regular.lod.lengths,s.distanceToCamera,n);e.renderRegularEdges(r,s,i,t,a)}),s)}_renderSilhouetteEdges(e,t,i){const r=e.bindSilhouetteEdges(i,t),s=i.transparency,n=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!hD(s)||!s.visible)return;const a=dD(s.silhouette.lod.lengths,s.distanceToCamera,n);e.renderSilhouetteEdges(r,s,i,t,a)}),s)}get test(){return{hasRenderedPrimitives:e=>{let t=!1;const i=e.perScreenPixelRatio,r=(e,r)=>e.forEachRenderable((e=>{e.visible&&!t&&(cD(e)&&(t=dD(e.regular.lod.lengths,e.distanceToCamera,i)>0),!t&&hD(e)&&(t=dD(e.silhouette.lod.lengths,e.distanceToCamera,i)>0))}),r);return this._renderers.forEach((e=>{t||(r(e,Tp.OPAQUE),r(e,Tp.TRANSPARENT))})),t},getObjectData:e=>this._perObjectData.get(e)}}};function rD(e){null!=e&&(e.vao.vertexBuffers.instances.dispose(),e.vao.disposeVAOOnly(),e.vao=null)}e([ae({constructOnly:!0})],iD.prototype,"rctx",void 0),e([ae({constructOnly:!0})],iD.prototype,"renderSR",void 0),e([ae({constructOnly:!0})],iD.prototype,"viewingMode",void 0),e([ae({constructOnly:!0})],iD.prototype,"techniqueRepository",void 0),e([ae({constructOnly:!0})],iD.prototype,"setNeedsRender",void 0),e([ae({constructOnly:!0})],iD.prototype,"schedule",void 0),e([ae({readOnly:!0})],iD.prototype,"_updatingHandles",void 0),e([ae({readOnly:!0})],iD.prototype,"updating",null),iD=e([le("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],iD);class sD{constructor(e,t,i){this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)})),this.center=be(t)}}class nD{constructor(e,t){this.buffer=e,this.meta=t}}class aD{constructor(e,t){this.vao=e,this.lod=t}}class oD{constructor(e,t){this.modelMatrix=e,this.origin=t}}class lD{constructor(e,t,i,r,s,n,a,o){this.regular=e,this.silhouette=t,this.statistics=i,this.transform=r,this.edgeTransparency=s,this.objectTransparency=n,this.components=a,this.rendererKey=o,this.distanceToCamera=0,this.visible=!0}}function cD(e){return null!=e.regular}function hD(e){return null!=e.silhouette}function dD(e,t,i){const r=t*i,s=O(e,r,!0);return-1===s?r<e[0]?e.length:0:e.length-s}class uD{constructor(e,t,i){this.position=e,this.modelTransform=t,this.origin=i}}const pD=Oo(),mD=()=>Promise.reject();class _D{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){Sp||(this._currentQuery=this._queryPool.pop(),null!=this._currentQuery&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||null==this._currentQuery||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(null==t)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){null!=this._currentQuery&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){null!=this._currentQuery&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{null!=e&&this._timer.deleteQuery(e)}))}}var gD;!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.LINEAR_DEPTH="linear depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.OPAQUE="opaque",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.ENVIRONMENT="environment",e.LASER_LINES="laser lines",e.OCCLUDED="occluded",e.ANTIALIASING="antialiasing",e.HIGHLIGHTS="highlights",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(gD||(gD={}));const fD="Total";class yD{constructor(e){this._rctx=e,this._startTimeStampCPU=$(0),this._lastTimeStampCPU=$(0),this._totalCPUTime=new Z(fD),this._cpuTimeSamplers=new Map(Object.values(gD).map((e=>[e,new Z(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new Z("GPU"),this._gpuTimeSamplers=new Map(Object.values(gD).map((e=>[e,new Z(e)]))),this._totalTime=$(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return null!=this._gpuTimerPool}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return $(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(null==this._gpuTimerPool){const e=[...Object.values(gD),fD];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return null==i?null:new _D(i,t)}(this._rctx,e)}if(null==this._gpuTimerPool)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let e=!1;return{hasGPUTimerSupport:!0,remove:()=>{e||(e=!0,--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=N(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=$(performance.now()),this._gpuTimerPool&&this._gpuTimerPool.start()}advance(e){const t=$(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,this._gpuTimerPool){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(t),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){const e=this._gpuTimerPool.stop(gD.FINISH);this._gpuTimeSamplers.get(gD.FINISH).record(e),this._rctx.gl.flush()}const e=$(performance.now()-this._startTimeStampCPU);this._totalTime=$(this._totalTime+e),this._totalCPUTime.record(e),this._gpuTimerPool&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}class vD{constructor(e,t,i,r,s,n,a,o){this._stage=e,this._techniqueRepository=r,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=a,this._requestRender=o,this._needsTransparentPass=!1,this._pluginsHas={hudElements:!1,water:!1},this._hasOverlayWater=!1,this.renderOverlay=e=>{},this._isRendering=!1,this._backgroundColor=rr(0,0,0,1),this._sliceHelper=new vM,this._state=Wh(yh.IDLE),this._highQualityTransparencyEnabled=!0,this._terrainTransparency=nR.Opaque,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new XA,this._reprojectionMatrixVersion=Wh(0),this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new Map,this._releaseGeometryLinearDepth=e=>{e?.release()},this._geometryLinearDepthFormat=fa.DEPTH16_BUFFER,this._debugLinearDepth=!1,this.fboCache=new KE(s),this._renderStateFeatures=Wh(yo(!b("disable-feature:high-quality-idle"),e.view.qualityProfile)),this._offscreen=new rM(this.fboCache,this._compositingHelper),this.performanceInfo=new yD(this._rctx),this._shadowMap=new mn(this.fboCache,e.viewingMode),this._highlight=new MA({view:e.view}),this._shadowHighlight=new UA({view:e.view,viewingMode:e.viewingMode}),this._shadowAccumulator=new mM(this.fboCache,r,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(e.camera,e.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{const r=this._stage.view.qualitySettings.maximumPixelRatio;e.shadowMap.start(e.camera,t,i,!0,r),this._renderShadowCascades(ds.Shadow,e.shadowMap),e.shadowMap.finish(),e.camera.setGLViewport(this._rctx),this._prepare(e.camera,e.contentCamera)}),o),this._ssao=new vo({view:this._stage.view}),this._renderContext=new _n(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper),this._nodes=new fA(this._renderContext),this._plugins=new yA({renderContext:this._renderContext,techniqueRepository:r,textureRepository:i,materialRepository:t,requestRender:o,controller:e,fbos:this.fboCache,isFeatureEnabled:e=>this.isFeatureEnabled(e)}),this.renderPassManager=new pA,this._plugins.add(this.renderPassManager),this._smaa=new $A({view:this._stage.view}),this._plugins.add(this._smaa),this._blit=new vA({opacity:1,alphaMode:vE.None}),this._plugins.add(this._blit),this._plugins.add(this._ssao),this._plugins.add(this._highlight),this._plugins.add(this._shadowHighlight),this._handles=[U((()=>this._stage.view.state.camera),(()=>o()),j),U((()=>Th.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(Tp.TRANSPARENT):()=>{},o()}),k),U((()=>this._stage.view.environment.background?.color),(e=>{const t=e?ki(e):ir;$i(this._backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),o()}),j)]}destroy(){this._handles.forEach((e=>e.remove())),this._gpuTimerHandle=M(this._gpuTimerHandle),this._nodes.destroy(),this._offscreen.dispose(),this._shadowMap.dispose(),this._highlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=D(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),Cp.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(e=null,t=!b("disable-feature:high-quality-idle")){this._renderStateFeatures.value=yo(t,e),this._plugins.renderFeatureChanged(),this._requestRender()}isFeatureEnabled(e,t=this._state.value){return this._renderStateFeatures.value.get(t,e)??!1}setFeatureEnabled(e,t,i){this._renderStateFeatures.mutate((r=>r.set(t,e,i))),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(eo.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(eo.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(ns.OPAQUE_MATERIAL,ds.Highlight)||this._plugins.produces(ns.TRANSPARENT_MATERIAL,ds.Highlight)||this._plugins.produces(ns.DRAPED_MATERIAL,ds.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===fu.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(eo.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=L(this._bindParameters.ssr.lastFrameColor),this._bindParameters.multipassTerrain.linearDepth=L(this._bindParameters.multipassTerrain.linearDepth),this._bindParameters.multipassGeometry.linearDepth=L(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.linearDepth=L(this._bindParameters.linearDepth),this._bindParameters.hudVisibility=L(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){if(null==this._edgeView){const e=this._stage.view.resourceController;this._edgeView=new iD({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:RD(e)}),this._handles.push(U((()=>this._edgeView?.updating),(()=>this._requestRender()),q)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&xr(this._bindParameters.ssr.reprojectionMatrix,Cr)}set _reprojectionMatrix(e){E(this._bindParameters.ssr.reprojectionMatrix,e)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.qualitySettings?.reflections&&this._ssrEnabled!==e.qualitySettings.reflections&&(this._ssrEnabled=e.qualitySettings.reflections,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),null!=e.environment){null!=e.environment.weather&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible);const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:r,updates:s}=e;if(0===i.length&&0===r.length&&0===s.length)return;const n=gn(e);let a=!1;n.forEach(((i,r)=>{if(t.done)return;let s=this._plugins.getMaterialRenderer(r);if(null==s&&i.adds.length>0){const e=new fn({material:r});e.initializeRenderContext(this._plugins._context),s=e,this._plugins.add(s)}s&&(s.modify(i),0===s.numGeometries&&(a=!0)),i.removes.forEach((t=>e.removes.removeUnordered(t))),i.adds.forEach((t=>e.adds.removeUnordered(t))),i.updates.forEach((t=>e.updates.removeUnordered(t))),t.madeProgress()})),a&&this._plugins.removeEmptyMaterialRenderers(),this._updateHasFlags(),this._requestRender()}_updateHasFlags(){const e=this._pluginsHas;e.hudElements=this._plugins.produces(ns.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(ns.HUD_MATERIAL)||this._plugins.produces(ns.LABEL_MATERIAL),e.water=this._plugins.produces(ns.DRAPED_WATER,ds.Normal),this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?M(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(e,t,i=pn.Default,r=fu.ON){this._isRendering=!0,this.performanceInfo.startFrame(),this.fboCache.frameStart(),this._disposeBindBuffers();const s=this._offscreen,{camera:n,contentCamera:a,mode:o,alignPixelEnabled:l}=e;this._state.value=o,this._bindParameters.overlay=this.renderOverlay(t),this.performanceInfo.advance(gD.OVERLAY),this._renderContext.time=t,this._bindParameters.transparencyPassType=aa.NONE,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=r,this._bindParameters.mainColor=this._bindParameters.mainDepth=null;const c=ot(this._sliceHelper.plane);r===fu.OFF&&(this._sliceHelper.plane=null),n.setGLViewport(this._rctx);const h=s.initializeFrame(n,this._backgroundColor,i);this.hasReflections?this._bindParameters.ssr.lastFrameColor=h:h?.release(),this._prepare(n,a),this._plugins.prepareRender(),this.performanceInfo.advance(gD.PREPARE);const d=this._computeDepthRange(n);this._renderShadowMap(n,this._bindParameters.lighting.mainLight.direction,d),this.performanceInfo.advance(gD.SHADOW_MAP),this._ensureBindParameters(n,a);const u=this._plugins.produces(ns.OPAQUE_TERRAIN)&&(this._terrainTransparency===nR.Semitransparent||this._terrainTransparency===nR.TransparentWithDraped),p=this._highQualityTransparency&&u;this._prepareShaders(p,this._needsTransparentPass),this._pluginInput.set("normals",this._renderNormals()),this.performanceInfo.advance(gD.NORMALS),this._renderSSAO(),this.performanceInfo.advance(gD.SSAO),this._renderLinearDepth(),this.performanceInfo.advance(gD.LINEAR_DEPTH),this._renderShadowAccumulation(d,n,a),this.performanceInfo.advance(gD.ACCUMULATED_SHADOWS),this._ensureBindParametersSSR(t),this._renderContext.output=ds.Color,s.bindFbo(),this._bindParameters.mainColor=s.colorTexture,this._bindParameters.mainDepth=s.depthTexture,this._renderOpaqueGeometry(),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"opaque-color"),this._plugins.render(ns.ENVIRONMENT_OPAQUE),this.performanceInfo.advance(gD.OPAQUE),this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo),this._renderTerrainLinearDepth(p),this._setMultipassTerrain(p),this._renderEdges(Tp.OPAQUE),this.performanceInfo.advance(gD.OPAQUE_EDGES),s.bindFbo(),this._plugins.render(ns.VOXEL),this.performanceInfo.advance(gD.VOXEL),this._renderHiddenTransparentEdges(),this._needsTransparentPass&&(this._oitEnabled?this._renderOITPass(xD.Geometry):this._renderTransparentMaterial()),this._offscreen.updateColor((e=>this._invokeRenderNodes(e)),"transparent-color"),this.performanceInfo.advance(gD.TRANSPARENT);const m=this._renderGeometryLinearDepth(p);this._renderHUDVisibility(m),p||this._plugins.render(ns.LINE_CALLOUTS),this.performanceInfo.advance(gD.HUD_VISIBILITY);const _=i===pn.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(gD.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(Tp.TRANSPARENT,m),this._releaseGeometryLinearDepth(m),this.performanceInfo.advance(gD.TRANSPARENT_EDGES);const g=u?this._renderTransparentTerrain():null;g&&this._bindParameters.hudVisibility&&(p?this._renderLineCallouts(Jo.Occluded):s.compositeToHUDVisibility(this._bindParameters,g.getTexture()),this._renderHUD(Jo.Occluded,s.color),this.performanceInfo.advance(gD.HUD_OCCLUDED)),this.performanceInfo.advance(gD.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),g&&(s.compositeToFramebuffer(this._bindParameters,g.getTexture(),vE.PremultipliedAlpha,1),g.release(),p&&(this._renderEdges(Tp.OPAQUE),this.performanceInfo.advance(gD.OPAQUE_EDGES),this._needsTransparentPass&&(this._oitEnabled?this._renderOITPass(xD.Geometry):this._renderTransparentMaterial()),this.performanceInfo.advance(gD.TRANSPARENT),this._renderEdges(Tp.TRANSPARENT),this.performanceInfo.advance(gD.TRANSPARENT_EDGES))),this._bindParameters.ssao=L(this._bindParameters.ssao),p&&this._renderLineCallouts(Jo.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),s.bindFbo(),this._plugins.render(ns.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.render(ns.ENVIRONMENT_TRANSPARENT),this.performanceInfo.advance(gD.ENVIRONMENT),this._renderLaserlines(),this.performanceInfo.advance(gD.LASER_LINES),this._renderOccluded(),this.performanceInfo.advance(gD.OCCLUDED);let f=this._renderHighlightPrepass();f&&this._renderShadowHighlights(f,this._bindParameters);const y=this._magnifierEnabled&&i===pn.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null,v=i!==pn.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"screenshot"):null,x=this._renderComposite(y??v,f)??v;return this.performanceInfo.advance(gD.ANTIALIASING),this._renderHUD(Jo.NotOccluded,x),this.performanceInfo.advance(gD.HUD),f&&(this._renderHighlights(x,f,this._bindParameters),f=L(f)),this.performanceInfo.advance(gD.HIGHLIGHTS),this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters),x!==v&&(this._rctx.bindFramebuffer(v?.fbo),this._compositingHelper.composite(this._bindParameters,y?.getTexture(),vE.None)),i===pn.Default&&y?.release(),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),this._offscreen.releaseBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=c,this._isRendering=!1,this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),i!==pn.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),{screen:v,oid:_}}_prepareShaders(e,t){this._renderContext.output=ds.Color,this._prepareOpaqueGeometry(),this._setMultipassTerrain(e),this._plugins.prepare(ns.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),e||this._plugins.prepare(ns.LINE_CALLOUTS),t&&this._prepareTransparencySlots(),this._plugins.prepare(ns.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._plugins.prepare(ns.ENVIRONMENT_TRANSPARENT),this._plugins.prepare(ns.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(!b("enable-feature:objectAndLayerId-rendering"))return;const e=this._renderContext.output,t=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");return t.acquireDepth(fa.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0),this._renderAllGeometry(ds.ObjectAndLayerIdColor),this._rctx.bindFramebuffer(t.fbo),this.fboCache.rctx.clearFramebuffer(void 0,!0,!0),this._bindParameters.hudRenderStyle=Jo.NotOccluded,this._plugins.render(ns.HUD_MATERIAL),this._renderContext.output=e,t}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===pu.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0,r=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),s=Math.max(e,r);this._animationTimestep.frame(s,i)}}readDepthPixels(e,t,i){const r=this._bindParameters.linearDepth?.fbo;if(r?.colorTexture)return void r.readPixels(t[0],t[1],t[2],t[3],$n.RGBA,Kn.UNSIGNED_BYTE,i);const s=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(fa.DEPTH16_BUFFER);this._rctx.bindFramebuffer(s.fbo),this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const n=Yn.COLOR_BUFFER_BIT|Yn.DEPTH_BUFFER_BIT|Yn.STENCIL_BUFFER_BIT;this._rctx.clearSafe(n),this._renderAllGeometry(ds.LinearDepth),s.fbo.readPixels(t[0],t[1],t[2],t[3],$n.RGBA,Kn.UNSIGNED_BYTE,i),s.release()}readHUDVisibility(e,t,i,r,s){this._bindParameters.hudVisibility?.fbo.readPixels(e,t,i,r,$n.RGBA,Kn.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassEnabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderEdges(e,t){const i=this._edgeView;if(i?.shouldRender()){const{width:r,height:s,depth:n}=this._offscreen,a=this.fboCache.acquire(r,s,"edges"),o=()=>i.render(this._bindParameters,e);this._offscreen.renderToTargets(o,a,t??n,bD),this._offscreen.compositeToFramebuffer(this._bindParameters,a.getTexture(),vE.Alpha,1),a.release()}}_renderShadowMap(e,t,i){const r=this._shadowMap;r.enabled&&(r.start(e,t,i,this.isFeatureEnabled(eo.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,t),this._needsShadowHighlight?(this._renderShadowCascades(ds.ShadowHighlight,this._shadowMap),r.moveSnapshot(un.Highlight),this._renderShadowCascades(ds.ShadowExcludeHighlight,this._shadowMap),r.copySnapshot(un.ExcludeHighlight),this._renderShadowCascades(ds.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(ds.Shadow),r.finish(),e.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap){for(const i of t.cascades)i.camera.setGLViewport(this._rctx),this._prepare(i.camera,i.camera),this._renderAllGeometry(e)}get _needsLinearDepth(){return this._plugins.consumes(ds.LinearDepth)||!!this._nodes.require("linear-depth")||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,"linear-depth",(()=>this._renderAllGeometry(ds.LinearDepth)),[0,0,0,0],ma.RGBA,fa.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=L(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=ds.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,"terrain depth",(()=>this._renderTransparentTerrain()),[-1e10,-1e10,-1e10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=e}else this._bindParameters.multipassTerrain.linearDepth=L(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(e){if(!e)return void(this._bindParameters.multipassGeometry.linearDepth=L(this._bindParameters.multipassGeometry.linearDepth));const t=this._renderContext.output;this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",(()=>this._renderOpaqueGeometryAndTransparentMaterial(ds.LinearDepth)),[1,1,1,1],ma.RGBA,this._geometryLinearDepthFormat),this._renderContext.output=t;const i=this._bindParameters.multipassGeometry.linearDepth.depth;return i?.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),i}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return _O;const t=function(e,t,i){let r=0;if(!t.some((e=>!!e.materialReference&&(r+=e.numGeometries,r>=1e4))))return jE.compute(e,t);const s=dO();return i.forAll((t=>pO(s,function(e,t){if(!t.visible)return;const i=dO(),r=t.getSpatialQueryAccelerator();return r?function(e,t,i){const r=t.eye,s=t.viewForward,n=t.frustum,a=e=>e.visible,o=i.objectCount;if(o<500)uO(VE,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,xp.DepthOrder.FRONT_TO_BACK,VE,((i,r)=>{ME(e,t,i),VE.far=e.near,r.setRange(VE)}),n,a),uO(VE,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,xp.DepthOrder.BACK_TO_FRONT,VE,((i,r)=>{ME(e,t,i),VE.near=e.far,r.setRange(VE)}),n,a);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,xp.DepthOrder.FRONT_TO_BACK,n,a,r),c=i.findClosest(s,xp.DepthOrder.BACK_TO_FRONT,n,a,r);l&&c&&(IE(e,t,l.boundingVolumeWorldSpace.bounds),IE(e,t,c.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){UE.clear(),i.forAll((e=>{e.visible&&0!==e.geometries.length&&UE.add(e)})),UE.empty||(UE.sort(t),uO(VE,t.near,Math.min(e.near,t.far)),UE.forEachInDepthRange(VE,xp.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&ME(e,t,i)})),uO(VE,Math.max(e.far,t.near),t.far),UE.forEachInDepthRange(VE,xp.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t)))),s}(e,this._plugins.plugins,this._stage.layers);return pO(t,this._plugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderNormals(){let e=(this._plugins.produces(ns.SSAO)?1:0)+this._nodes.require("normals");if(0===e)return;const t=this._offscreen.renderToCachedFBO(null,"normals",(()=>this._renderGeometryForSSAO(ds.Normal)),[0,0,0,0],ma.RGBA,fa.DEPTH_STENCIL_TEXTURE);for(;--e>0;)t.retain();return t}_renderSSAO(){const e=this._pluginInput.get("normals");this._plugins.produces(ns.SSAO)&&e&&(this._bindParameters.ssao=this._plugins.render(ns.SSAO,this._pluginInput),e.detachDepth(),e.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(e){this._renderContext.output=e,this._plugins.prepare(ns.TRANSPARENT_TERRAIN),this._renderOpaqueGeometryAndTransparentMaterial(e),this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(e){this._renderContext.output=e,this._plugins.prepare(ns.TRANSPARENT_MATERIAL),this._plugins.prepare(ns.TRANSPARENT_NO_SSAO_DEPTH),this._renderOpaqueGeometry(),this._renderTransparentMaterial()}_renderGeometryForSSAO(e){this._renderContext.output=e,this._plugins.render(ns.INTEGRATED_MESH),this._plugins.render(ns.OPAQUE_TERRAIN),this._plugins.render(ns.OPAQUE_MATERIAL),this._plugins.render(ns.TRANSPARENT_MATERIAL),this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(ns.INTEGRATED_MESH),this._plugins.prepare(ns.OPAQUE_TERRAIN),this._plugins.prepare(ns.OPAQUE_MATERIAL),this._plugins.prepare(ns.OPAQUE_NO_SSAO_DEPTH),this._plugins.prepare(ns.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(ns.INTEGRATED_MESH),this._plugins.render(ns.OPAQUE_TERRAIN),this._plugins.render(ns.OPAQUE_MATERIAL),this._plugins.render(ns.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(ns.TRANSPARENT_MATERIAL),this._plugins.render(ns.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(!this._plugins.produces(ns.TRANSPARENT_TERRAIN))return;const e=()=>this._plugins.render(ns.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==ds.Color)return void e();const{width:t,height:i,depth:r}=this._offscreen,s=this.fboCache.acquire(t,i,"transparent terrain");return this._offscreen.renderToTargets(e,s,r,[0,0,0,0]),s}_renderHUDVisibility(e){this._plugins.produces(ns.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,(()=>this._plugins.render(ns.OCCLUSION_PIXELS)),e),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=L(this._bindParameters.hudVisibility)}_renderLineCallouts(e){if(this._bindParameters.hudRenderStyle=e,e===Jo.Occluded){const e=()=>{this._plugins.render(ns.LINE_CALLOUTS)},{width:t,height:i,color:r}=this._offscreen,s=this.fboCache.acquireDepth(fa.DEPTH16_BUFFER,t,i,"line callouts");this._offscreen.renderToTargets(e,r,s,void 0,!0,!0),s.release()}else this._plugins.render(ns.LINE_CALLOUTS)}_renderLaserlines(){if(this._plugins.render(ns.LASERLINES),this._plugins.produces(ns.LASERLINES_CONTRAST_CONTROL)){const e=this._offscreen,{width:t,height:i,depth:r}=e,s=this.fboCache.acquire(t,i,"laser lines"),n=()=>this._plugins.render(ns.LASERLINES_CONTRAST_CONTROL);e.renderToTargets(n,s,r,bD),e.compositeToFramebuffer(this._bindParameters,s.getTexture(),vE.PremultipliedAlpha,1),s.release()}}_renderHUD(e,t){if(this._pluginsHas.hudElements)if(this._oitEnabled){const i=this._renderOITPass(xD.HUD,e);this._rctx.bindFramebuffer(t?.fbo),this._compositingHelper.composite(this._bindParameters,i.getTexture(),vE.PremultipliedAlpha),i.release()}else if(e===Jo.Occluded){const t=()=>this._renderHUDElements(e),{width:i,height:r,color:s}=this._offscreen,n=this.fboCache.acquireDepth(fa.DEPTH16_BUFFER,i,r,"hud");this._offscreen.renderToTargets(t,s,n,void 0,!0,!0),n.release()}else this._rctx.bindFramebuffer(null),t?.acquireDepth(fa.DEPTH16_BUFFER),this._rctx.bindFramebuffer(t?.fbo),this._renderHUDElements(e),t?.detachDepth()}_renderHUDElements(e){this._bindParameters.hudRenderStyle=e,this._plugins.prepare(ns.LINE_CALLOUTS_HUD_DEPTH),this._plugins.prepare(ns.HUD_MATERIAL),this._plugins.prepare(ns.LABEL_MATERIAL),this._plugins.render(ns.LINE_CALLOUTS_HUD_DEPTH),this._plugins.render(ns.HUD_MATERIAL),this._plugins.render(ns.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(ns.SHADOW_HIGHLIGHT)&&this._plugins.produces(ns.OPAQUE_MATERIAL,ds.ShadowHighlight)}_renderHighlightPrepass(){if(!this.hasHighlights)return;const e=this._offscreen.renderToCachedFBO(null,"highlight",(()=>{this._renderAllGeometry(ds.Highlight),this._rctx.clearSafe(Yn.DEPTH_BUFFER_BIT),this._renderHUDElements(Jo.Both)}),[0,0,0,0],ma.RGBA4,fa.DEPTH_STENCIL_TEXTURE);return e.detachDepth(),e}_renderShadowHighlights(e,t){this.hasHighlights&&t.decorations!==fu.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor((t=>(this._pluginInput.set("highlight",e),this._plugins.render(ns.SHADOW_HIGHLIGHT,this._pluginInput,t),t)),"transparent-color")}_renderHighlights(e,t,i){this.hasHighlights&&i.decorations!==fu.OFF&&(this._pluginInput.set("highlight",t),this._plugins.produces(ns.HIGHLIGHT)&&this._plugins.render(ns.HIGHLIGHT,this._pluginInput,e))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(e,t,i){this._needsShadowCast&&this._bindParameters.linearDepth?.getTexture()&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,e,t,i)}_prepareTransparencySlots(){this._renderContext.output=ds.Alpha,this._bindParameters.transparencyPassType=aa.Alpha,this._plugins.prepare(ns.TRANSPARENT_MATERIAL),this._renderContext.output=ds.Color,this._bindParameters.transparencyPassType=aa.Color,this._plugins.prepare(ns.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=aa.FrontFace,this._plugins.prepare(ns.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=aa.NONE}_renderOITPass(e,t=Jo.Both){const i=e===xD.HUD,r=i?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null,s=i?()=>this._renderHUDElements(t):()=>this._renderTransparentMaterial(),n=this._renderContext.output;this._renderContext.output=ds.Alpha,this._bindParameters.transparencyPassType=aa.Alpha;const a=this._offscreen.renderOITPass(s,aa.Alpha,i);this._renderContext.output=ds.Color,this._bindParameters.transparencyPassType=aa.Color;const o=this._offscreen.renderOITPass(s,aa.Color,i);this._bindParameters.transparencyPassType=aa.FrontFace;const l=this._offscreen.renderOITPass(s,aa.FrontFace,i);return this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,o,a,l,r),r?.detachDepth(),l.release(),o.release(),a.release(),this._bindParameters.transparencyPassType=aa.NONE,this._renderContext.output=n,r}_renderOccluded(){let e=0;CD.clear(),this._plugins.plugins.forAll((t=>{t.materialReference&&t.queryRenderOccludedState(Nn.OccludeAndTransparentStencil)&&(e|=Nn.OccludeAndTransparentStencil,CD.push(t))}));const t=this._offscreen,i=(i,r,s,n,a)=>{if(0==(e&r))return;const{width:o,height:l,depth:c}=t,h=this.fboCache.acquire(o,l,"tmp color");t.renderToTargets(s,h,c,[0,0,0,0],n,a),t.compositeToFramebuffer(this._bindParameters,h.getTexture(),vE.PremultipliedAlpha,i),h.release()},r=(e,t)=>{this._bindParameters.slot=e,t.forAll((e=>{if(Qa(e)){const t=e.prepareTechnique(this._renderContext);t&&e.renderNode(this._renderContext,t)}}))};0!==CD.length&&(r(ns.OCCLUDER_MATERIAL,CD),i(.5,Nn.OccludeAndTransparentStencil,(()=>r(ns.TRANSPARENT_OCCLUDER_MATERIAL,CD)),!1,!1)),CD.clear(),this._plugins.plugins.forAll((t=>{if(!t.materialReference)return;const i=t.queryRenderOccludedState(Nn.OccludeAndTransparent),r=t.queryRenderOccludedState(Nn.Transparent),s=t.queryRenderOccludedState(Nn.Opaque);(i||r||s)&&(e|=i?Nn.OccludeAndTransparent:r?Nn.Transparent:Nn.Opaque,CD.push(t))}));const s=this._plugins.renderOccludedFlags;if(e|=s,!e)return;const n=e=>{this._renderContext.renderOccludedMask=e,s>Nn.Occlude&&this._plugins.render(ns.OCCLUDED_TERRAIN),r(ns.OPAQUE_MATERIAL,CD),r(ns.TRANSPARENT_MATERIAL,CD),r(ns.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,CD),this._renderContext.renderOccludedMask=yn};this._renderContext.output=ds.Color,i(.5,Nn.OccludeAndTransparent,(()=>n(Nn.OccludeAndTransparent)),!0,mu.OutlineVisualElementMask),i(.5,Nn.Transparent,(()=>n(Nn.Transparent)),!0,mu.OutlineVisualElementMask),i(1,Nn.Opaque,(()=>n(Nn.Opaque)),!0,mu.OutlineVisualElementMask),CD.clear()}_invokeRenderNodes(e){this._updatePluginInput();const t=this._nodes.render(e,this._pluginInput);return this._releaseAfterRenderNode("normals",e.name),t}_renderComposite(e,t){this._offscreen.updateColor((e=>(this._pluginInput.set("highlight",t),this._updatePluginInput(),e=this._nodes.render(e,this._pluginInput),this._pluginInput.set(e.name,e),this._pluginInput.delete("highlight"),this._releaseAfterRenderNode("normals","composite-color"),e)),"composite-color");const i=this._plugins.produces(ns.ANTIALIASING);return this._plugins.render(i?ns.ANTIALIASING:ns.BLIT,this._pluginInput,e)}_releaseAfterRenderNode(e,t){const i=this._pluginInput.get(e);if(!i)return;let r=this._nodes.require(i.name,t);for(;r--;)i.release()&&this._pluginInput.delete(e)}_updatePluginInput(){this._pluginInput.set("linear-depth",this._bindParameters.linearDepth)}_prepare(e,t){this._needsTransparentPass=this._plugins.produces(ns.TRANSPARENT_MATERIAL,ds.Color),this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParameters(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Cr:(vr(PD,this._bindParameters.camera.viewMatrix),vr(TD,this._bindParameters.camera.projectionMatrix),ur(SD,PD,TD),ur(SD,this._renderContext.lastFrameCamera.viewMatrix,SD),ur(SD,this._renderContext.lastFrameCamera.projectionMatrix,SD),this._reprojectionMatrix=SD);const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._ssrEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Cr,this._ssrEnableTime=null}addRenderNode(e){this._nodes.add(e),this._requestRender()}removeRenderNode(e){this._nodes.remove(e),this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{this._renderStateFeatures.value=yo(),this._plugins.renderFeatureChanged(),this._requestRender()},getFramebufferTexture:e=>{switch(e){case wD.Color:return this._offscreen.colorTexture;case wD.LinearDepth:return this._bindParameters.linearDepth?.getTexture();case wD.ShadowMap:return this._shadowMap.depthTexture;case wD.HudVisibility:return this._bindParameters.hudVisibility?.getTexture()}},debugLinearDepth:e=>{this._debugLinearDepth=e,this._requestRender()}}}}var xD,wD;e([ae({readOnly:!0})],vD.prototype,"fullResolutionAtmosphere",null),e([ae()],vD.prototype,"_smaa",void 0),e([ae()],vD.prototype,"_blit",void 0),e([ae()],vD.prototype,"_edgeView",void 0),e([ae()],vD.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(xD||(xD={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.ShadowMap=2]="ShadowMap",e[e.HudVisibility=3]="HudVisibility"}(wD||(wD={}));const bD=[0,0,0,0],CD=new Y,TD=wr(),PD=wr(),SD=wr();function RD(e){return t=>e.immediate.schedule(t)}class OD{constructor(e){this._rctx=e,this._vao=function(e,t=ja,i=Rn){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new Ko(e,i,{geometry:t},{geometry:el.createVertex(e,Gn.STATIC_DRAW,r)})}(e)}destroy(){this._vao=N(this._vao)}draw(){null!=this._vao&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(qn.TRIANGLES,0,3))}get test(){return{cachedWebGLObjects:ED(this._vao?.glName)+ED(this._vao?.indexBuffer?.glName)+ED(this._vao?.vertexBuffers.geometry)}}}function ED(e){return null!=e?1:0}class AD extends Rp{constructor(e,t,i){super(e,t),this.gl=e,this.newCache=i,this._appleAmdDriverHelper=null,this._refCount=1,this.screen=new OD(this)}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){super.dispose(),this._appleAmdDriverHelper?.dispose(),this.screen.destroy()}bindTechnique(e,t,i,r,s){return this.useProgram(e.program),this.setPipelineState(e.getPipeline(!!s)),e.program.bindPass(i,t),r&&e.program.bindDraw(r,t,i),e.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new Op(this),this._appleAmdDriverHelper.run())}get test(){return{cachedWebGLObjects:this.programCache.test.cachedWebGLProgramObjects+this.screen.test.cachedWebGLObjects+(this._appleAmdDriverHelper?.test.cachedWebGLObjects??0)}}}function MD(e){return!!e.frameUpdate}let DD=class extends pe{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new di,this._frameTask=e.view.resourceController.scheduler.registerTask(jo.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Zu.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return null==this._textureTechnique&&(this._textureTechnique=this._techniqueRepository.acquire(vn,new xn)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",pu.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(null==t)return il(void 0!==t),null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),r=new ID(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),t.glTexture?(this._updateGLTexture(r,t.glTexture),MD(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._rctx),s=i=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,i),MD(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r);return g(i)?i.then(s,(e=>(this._loadingCount--,r.loadingPromise=null,h(e)||A.getLogger(this).error(e),null))):s(i)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",pu.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};e([ae()],DD.prototype,"_loadingCount",void 0),e([ae()],DD.prototype,"_frameTask",void 0),e([ae()],DD.prototype,"updating",null),DD=e([le("esri.views.3d.webgl-engine.lib.TextureRepository")],DD);class ID{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(A.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}let LD=class extends pe{constructor(){super(...arguments),this._passParameters=new ND,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=I(this._resourcesTask),this._passParameters.waveNormal=N(this._passParameters.waveNormal),this._passParameters.wavePerturbation=N(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=Lt((async t=>{await Promise.allSettled([this._loadImageResource(e,nl("esri/images/materials/water/normals.jpg"),(e=>this._passParameters.waveNormal=e),t),this._loadImageResource(e,nl("esri/images/materials/water/perturbation.jpg"),(e=>this._passParameters.wavePerturbation=e),t)])}))),this._resourcesTask.finished?yu.LOADED:yu.LOADING}async _loadImageResource(e,t,i,r){try{const s=await wp(t,{signal:r});m(r);const n=new Lo(s.width,s.height);n.pixelFormat=$n.RGB,n.samplingMode=Wn.LINEAR_MIPMAP_LINEAR,n.hasMipmap=!0,n.maxAnisotropy=8,i(new Fo(e,n,s))}catch(e){A.getLogger(this).error("Failed to load water material normal texture.",e)}}};e([ae()],LD.prototype,"_resourcesTask",void 0),e([ae({type:Boolean,readOnly:!0})],LD.prototype,"updating",null),LD=e([le("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],LD);class ND extends Pn{}class FD{constructor(e,t,i){this.parameters=e,this.frameHasDecorations=t,this.fbos=i}}class VD{constructor(e,t,i){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(pu.BACKGROUND);const t=c();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},s=this._renderScreenshot(e,r,t);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderFunctions.renderOverlay(e,i.disableDecorations?fu.OFF:fu.ON,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:n}=e,a=this._ensureScreenshotEncodeCanvas();let o=Ep(i,r,a);this._rctx.gl.readPixels(0,0,i,r,$n.RGBA,Jn.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(a,o,{...e,region:void 0});const l=Ep(s.width,s.height,a);return Rc(o,l,!0,n.region.x,r-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),n=Ep(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,$n.RGBA,Jn.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(s,n,e)}_renderScreenshot(e,t,i){const r=e.parameters.camera,s={width:t.framebufferWidth,height:t.framebufferHeight};Mo(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let n=!1;const a=t.disableDecorations&&e.frameHasDecorations,o=s.width!==r.fullWidth||s.height!==r.fullHeight,l=t.ignorePadding&&r.pixelRatio!==t.pixelRatio,c=o||a||l||t.objectAndLayerIdColor;let h=null,d=null;if(c){const e=r.clone();if(t.ignorePadding){const i=sr(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=s.width,e.fullHeight=s.height,e.pixelRatio=t.pixelRatio;const a=r.fovX-e.fovX,o=r.fovY-e.fovY;a<0&&a<o?e.fovX=r.fovX:o<0&&o<a&&(e.fovY=r.fovY);const l={camera:e,contentCamera:e,mode:yh.IDLE,alignPixelEnabled:!0,contentPixelRatio:e.pixelRatio};this._forceCameraHook(l),n=!0;const c=this._renderFunctions.renderScene(l,i,t.objectAndLayerIdColor?pn.ObjectAndLayerID:pn.Screenshot,t.disableDecorations?fu.OFF:fu.ON);d=c.screen,h=c.oid}this._rctx.bindFramebuffer(d?.fbo);const u=this._readbackScreenshot(t,(()=>{this._rctx.bindFramebuffer(null),d?.release()}));let p=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),h?.release()};this._rctx.bindFramebuffer(h?.fbo),p=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null)}if(c&&!this._rctx.contextAttributes.alpha)for(let e=3;e<u.data.length;e+=4)u.data[e]=255;if(p&&!this._rctx.contextAttributes.alpha)for(let e=3;e<p.data.length;e+=4)p.data[e]=255;return n&&this._forceCameraHook(e.parameters),[u,p]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let UD=class extends pe{constructor(e){super({}),this.events=new di,this.waterTextures=new LD,this._magnifierHelper=new WE,this.objectAndLayerIdRenderHelper=b("enable-feature:objectAndLayerId-rendering")?new $E:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),this.addHandles([U((()=>this.waterTextures?.updating),(()=>this.requestRender()),k),U((()=>e.view.qualityProfile),(e=>this.renderer?.updateRenderFeatures(e)),j),this._magnifierHelper.events.on("request-render",(()=>this.requestRender()))]);const{memoryController:t}=e.view.resourceController;this.stippleTextures=Xu(this._rctx,t),this.markerTextures=function(e,t){return new $u((t=>Qu(t,e)),(e=>e),t)}(this._rctx,t),this._shaderTechniques=new wn({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this.stippleTextures,waterTextureRepository:this.waterTextures,markerTextureRepository:this.markerTextures}),this._textures=new DD(e,this._shaderTechniques,this._rctx),this.addHandles(this._textures.events.on("changed",(e=>this.requestRender(e)))),this._materialRepository=new bn(this._textures,this._shaderTechniques,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new OE(this._rctx,this._shaderTechniques),this.renderer=new vD(e,this._materialRepository,this._textures,this._shaderTechniques,this._rctx,this._compositingHelper,this._magnifierHelper,(e=>this.requestRender(e)));const i={renderScene:(e,t,i,r)=>this.renderer.render(e,t,i,r),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(t,i,r)=>e.options.screenshot.renderOverlay(t,i,r)};this._screenshotManager=new VD(this._rctx,i,(e=>this.events.emit("force-camera-for-screenshot",e))),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=M(this._frameTask),this._shaderTechniques=D(this._shaderTechniques),this._componentObjects=D(this._componentObjects),this._screenshotManager=D(this._screenshotManager),this.renderer.destroy(),this._textures=D(this._textures),this._magnifierHelper.destroy(),this.waterTextures.destroy(),this.markerTextures.destroy(),this.stippleTextures.destroy(),this._canvas=null,this._container=null,this._rctx=D(this._rctx)}requestRender(e=pu.UPDATE){this._needsRender=!0,e===pu.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating||this._magnifierHelper.updating}get textureRepository(){return this._textures}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,s,n=s){const a=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),o=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(r,a,o);let l=Number.MAX_VALUE;for(let e=0;e<a[2]*a[3];e++){const t=AE(4*e,o,r.nearFar);l>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(l=t)}if(e){const s=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);null!=s&&l>s&&s!==r.nearFar[0]&&s!==r.nearFar[1]&&(l=s)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){$C(),await this._shaderTechniques.reloadAll(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=pu.BACKGROUND,s=!1;const n={preRender:({time:s})=>{i=this.updating,r=this._needsUpdate?pu.UPDATE:pu.BACKGROUND,e.commitSyncLayers();const n=$(s-this._lastAnimationUpdate);if(n>this.renderer.animationTimestep||null!=t.forcedAnimationTime||i||this._needsRender){const e=$(n/this.renderer.animationTimeDilation),i=new Dn(t.camera,e,t.forcedAnimationTime);this.renderer.updateAnimation(i)&&this.requestRender(pu.BACKGROUND),this._lastAnimationUpdate=s}},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const i=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(t,e),s=!0,i&&this.renderer.hasReflections&&(this.requestRender(pu.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{const i=this.renderer.hasSlicePlane||this._magnifierHelper.enabled||this.renderer.hasDecorations||this.renderer.hasHighlights,r=new FD(t,i,this.renderer.fboCache);this._textures.update(),this._screenshotManager.update(r,e)},finish:()=>{s&&(this.renderer.finish(t.mode===yh.IDLE?r:pu.UPDATE),s=!1)}};this._frameTask=X(n)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},r=Ap(this._canvas,i);null!=r?(this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&A.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&b("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):A.getLogger(this).error("A WebGL2 context could not be created.")}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8};return new AD(e,i,((e,i)=>t.view.resourceController.memoryController.newCache(e,i)))}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return null!=this.objectAndLayerIdRenderHelper?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return null==this._componentObjects&&(this._componentObjects=new pE(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}};e([ae({type:Boolean,readOnly:!0})],UD.prototype,"updating",null),e([ae()],UD.prototype,"_rctx",void 0),e([ae()],UD.prototype,"_container",void 0),e([ae()],UD.prototype,"_canvas",void 0),e([ae()],UD.prototype,"stippleTextures",void 0),e([ae()],UD.prototype,"markerTextures",void 0),e([ae()],UD.prototype,"waterTextures",void 0),e([ae()],UD.prototype,"_magnifierHelper",void 0),e([ae({readOnly:!0})],UD.prototype,"objectAndLayerIdRenderHelper",void 0),e([ae()],UD.prototype,"_textures",void 0),e([ae({readOnly:!0})],UD.prototype,"renderer",void 0),e([ae()],UD.prototype,"_screenshotManager",void 0),e([ae()],UD.prototype,"componentObjectCollection",null),e([ae()],UD.prototype,"_componentObjects",void 0),e([ae()],UD.prototype,"_needsUpdate",void 0),e([ae()],UD.prototype,"_needsWaterReflectionUpdate",void 0),UD=e([le("esri.views.3d.webgl-engine.parts.RenderView")],UD);let jD=class extends pe{constructor(e){super(e),this._model=new IR,this._layers=new Y,this._asyncChangeSet=new Cn,this._syncChangeSet=new Cn,this._layerSyncSet=new Set}initialize(){this._set("renderView",new UD(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(jo.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(e){this._model.add(e),Gu(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){null!=e&&!this.destroyed&&this._model.remove(e)&&(Gu(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){null!=e&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){null!=e&&(this._model?.removeMany(e),this.renderView?.requestRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return ko}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===Yu.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.modify(s,r?qo:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qo),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==Yu.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===Yu.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qo),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qo),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,qo))}addRenderPlugin(e,t){const i=this.renderer.plugins.add(e,t),r=()=>{Eb(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(g(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(Eb(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get performanceInfo(){return this._model.getStats()}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};jD.DebugSettings={endFrameContentValidation:!1},e([ae({constructOnly:!0})],jD.prototype,"view",void 0),e([ae({constructOnly:!0})],jD.prototype,"options",void 0),e([ae({readOnly:!0})],jD.prototype,"viewingMode",null),e([ae({constructOnly:!0})],jD.prototype,"container",void 0),e([ae({readOnly:!0})],jD.prototype,"updating",null),e([ae({constructOnly:!0})],jD.prototype,"_model",void 0),e([ae()],jD.prototype,"renderView",void 0),e([ae({readOnly:!0})],jD.prototype,"renderer",null),e([ae({readOnly:!0})],jD.prototype,"running",null),jD=e([le("esri.views.3d.webgl-engine.Stage")],jD);let kD=class extends Np{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([ae()],kD.prototype,"components",void 0),kD=e([le("esri.views.ui.3d.DefaultUI3D")],kD);const qD=kD;let zD=class extends(St(Et(Rt(Tt)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new fh({slicePlane:dt},this),this._resourceController=new eC({view:this}),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Yx({view:this}),this.labeler=new ka({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Pt,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new tm,this.environment=new om,this.environmentManager=new ig,this.floors=new r,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new Gp({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new vb,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new qD,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new qb,ne();const t=(e=null)=>{null!=e&&e.type===s.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.addHandles([B((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),U((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new xx({view:this}),this.stateManager=new nv({view:this})}initialize(){this.groundView=new Ot({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.addHandles(B((()=>this.map?.allLayers),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),k),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),k),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>K(e>0?1e3/Math.ceil(e):0)),k),this.updatingHandles.add((()=>this.map?.ground),e,j),this.updatingHandles.add((()=>this.map?.ground?.opacity),(()=>this._updateDefaultHitTestOptions()),j),this.addHandles(U((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),q))}destroy(){this.destroyed||(this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=D(this.sharedSymbolResources),this._set("labeler",D(this.labeler)),this._set("deconflictor",D(this.deconflictor)),this._resourceController=D(this._resourceController),this._set("stateManager",D(this.stateManager)),this._set("inputManager",D(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",D(this.environmentManager)),this._set("environment",D(this.environment)),this.groundView=D(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;const e=this.map;let t=this._userClippingArea||V(e,"clippingArea");return!this._userClippingArea&&!V(e,"clippingEnabled")||null==t?(this._clippingArea=null,null):t instanceof Jc?this.spatialReference&&(t=BD(t,this.spatialReference),null==t)?(A.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),null==t.intersection(this._groundAndLayersExtent)&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(A.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&null!=e?A.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Mt.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return null==t||null==e||t.spatialReference.equals(e)?t:BD(t,e)}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||Uh.WGS84,i=BD(this.clippingArea,t);null!=i&&(e=null!=e?e.intersection(i):i);const r=this._get("dataExtent");return null!=e&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||Uh.WGS84;let t;const i=i=>{const r=BD(i,e);null!=r&&(null!=t?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new Jc({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{null==e.fullExtent||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(null==t)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}castEnvironment(e){return e?e instanceof om?e:e instanceof li?this.environment?.cloneWithWebsceneEnvironment(e)??om.fromWebsceneEnvironment(e):de(om,e):new om}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(null==this.state||this.state.stationary)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){Vb.isValidProfile(e)&&(Vb.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||Vb.getDefaultProfile()}set slicePlane(e){if(null!=this._stage&&this._stage.renderer.setParameters({slicePlane:e}),null==e)return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");lt(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&this.stateManager.preinit(this.spatialReference)}get resolution(){return null!=this.spatialReference?gt(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?Ae.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||Sd(r))return;++i,e+=r.updatingProgress}}else++i}));for(const t of this._updatingObjects)if(null!=t&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of this._updatingObjectsWithProgress)null!=t&&t.updating&&(++i,e+=t.updatingProgress);const r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some((e=>!e.isFulfilled()))||this.textures?.updating),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const e=this._predeterminedViewingMode;if(null!=e)return Dt(e);const t=this.spatialReference;return t?null!=this.defaultsFromMap?.viewingMode&&t.equals(this.defaultsFromMap.spatialReference)?Dt(this.defaultsFromMap.viewingMode):Lp(t,Mt.Global)?"global":"local":"global"}set viewingMode(e){this.ready?A.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new Fd(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return A.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=Dp(e)?Ip(this,e):e;return Fh(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return A.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=(null==e.z?kh(this.elevationProvider,e):null)??0;return Ue(e,HD,this.renderSpatialReference,t),this.state.camera.projectToScreen(HD,GD),ee(GD[0],GD[1])}pixelSizeAt(e){return this.ready?e?(Ue(e,HD,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(HD)):0:(A.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,(()=>this.pixelSizeAt(e))):1}hitTest(e,t){if(!this.ready)return A.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Dp(e)?Ip(this,e):e;return Vh(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return async function(e,t){const{results:i,ground:r}=await Gh(e,t),s=(!r.layer||!ft(r.layer.type))&&r.mapPoint,n=[],a=function(e){const t=new Map;for(const i of e.allLayerViews){const e=i.layer.uid;t.set(e,i)}return t}(e),o=s?function(e,t){const i=new Set,r=[];for(let t=e.basemapTerrain.numLayers(Bb.MAP)-1;t>=0;t--){const s=e.basemapTerrain.layerViewByIndex(t,Bb.MAP);i.add(s.layer.uid),r.push(s)}const s=e.basemapTerrain.overlayManager.renderer.layers;for(const{uid:e}of s){const s=t.get(e);s&&(i.add(e),r.push(s))}return r.reverse(),{layerUids:i,layerViews:r}}(e,a):Gb;let l=0,c=0;const h=()=>{const e=o.layerViews[c];s&&e&&"fetchPopupFeaturesAtLocation"in e&&n.push({mapPoint:r.mapPoint,layerView:e}),++c};let d=null;for(;l<i.length||c<o.layerViews.length;){const e=i[l];if(e&&"graphic"!==e.type)++l;else if(e){const t=e.layer?.uid,i=o.layerUids.has(t)&&e.distance===r.distance,s=a.get(e.layer?.uid);if(d??=e.mapPoint,c<o.layerViews.length&&(i||(e.distance??0)>r.distance)&&o.layerViews[c]!==s){h();continue}n.push({graphic:e.graphic,layerView:s}),++l}else h()}return d??=r.mapPoint,{hits:n,location:d}}(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(null==e.parent)throw new a("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Oc(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Ec(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t);return[Ec(i[0],this._pixelFormat()),Ec(i[1],this._pixelFormat())]}_completeSettings(e){const t=Ac(e,this);return t.pixelRatio/=this.state.pixelRatio,Mc(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e),takeScreenshotWithObjectAndLayerId:e=>this._takeScreenshotWithObjectAndLayerId(e)}}async takeScreenshotWithObjectAndLayerId(e){if(!b("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t),r=Oc(i[0],t,this._pixelFormat()),s=this._completeSettings(e);return s.format="png",[r,Oc(i[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(null==this._stage.renderView.objectAndLayerIdRenderHelper)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return(e=>{const t=jp[e.type];if(null==t)throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new a(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)})(e)}hasLayerViewModule(e){return(e=>null!=jp[e.type])(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=Dc(this.type);const t=b("safari");if(t&&t<9&&(e=new a("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),null!=e)throw A.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return null!=e?It(e):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(null!=i)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Mt.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Mt.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Mt.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Mt.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!Lp(e,i)||null!=t&&!bt(t)&&(yt(t)&&null==Qh(t,e,i)||Ct(t)&&i===Mt.Global))}_makeSpatialReferenceConstraints(e,t,i){if(null==t)return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return bt(t)&&(r||s)?s&&i!==Mt.Local&&null!==Nd(t.tileInfo,t.fullExtent,e,Mt.Global)?[{spatialReference:r?Uh.WGS84:Uh.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:Uh.WebMercator,viewingMode:i}]:yt(t)||Ct(t)||!r&&!s?yt(t)&&r&&i!==Mt.Global?[{spatialReference:e,viewingMode:i},{spatialReference:Uh.WGS84,viewingMode:Mt.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?Uh.WGS84:Uh.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=null!=this.getSpatialReferenceSupport({spatialReference:e}),i=this._predeterminedViewingMode;return t||(null!=i?A.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Dt(i)} viewing mode.`):e.isGeographic&&A.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}trackGraphicState(e){if(!e.graphic)return A.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&null!=t&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return null!=t?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),y((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}highlight(e){if(Array.isArray(e))return x(e.map((e=>this.highlight(e))));if(r.isCollection(e))return x(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):y()}maskOccludee(e){if(!e)return A.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&null!=t&&Mp(t)&&(i=t.maskOccludee(e))};return null!=t?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),y((()=>{r=!0,null!=i&&(i.remove(),i=null)}))}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){null!=this.graphicsView&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await z((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new a("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new gR({view:this})),this._set("elevationProvider",new Db({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new LC({view:this})),this._set("featureTiles",new mb({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=null!=this.basemapTerrain.extent&&null!=this.basemapTerrain.spatialReference?Fe(nt(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;null!=this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add((()=>Th.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&Th.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):e||!this._featureTreeDebugger||Th.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),j),this.updatingHandles.add((()=>this.clippingArea),e,j),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,j)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new zb(this.map,e));const t=this.state.isGlobal,i=mt(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",_t.create(this.state.viewingMode,i)),t||this.addHandles(U((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;null==e||0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!Ve(e,this.basemapTerrain.spatialReference,WD,t)||(this.renderCoordsHelper.extent=WD)}),q),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Fc/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){null!=e&&e.type===s.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.addHandles(U((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),q),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;const r=e.getContext("2d");return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t===fu.OFF}),r.getImageData(0,0,i.width,i.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t,i)=>this._renderScreenshotOverlay(e,t,i)}},t=new bb(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=n(this.surface);this._stage=new jD({view:this,options:e,container:i}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),k),U((()=>this.magnifier),(e=>this._stage.renderView.magnifier=e),j),this.on("pointer-move",(()=>this._stage?.renderer.resetAnimation())),f(this._stage.renderView.canvas,"webglcontextlost",(e=>this.fatalError=new a("webgl-context-lost",e.statusMessage)))],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Fc/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=D(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new aC({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("../chunks/GraphicsView3D.js")).default;m(e),await z((()=>this.basemapTerrain?.ready),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),null!=this.graphicsView&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=It(this.viewingMode);e===Mt.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(B((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded();const t=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.environment:void 0;t&&Fp(this.environment,t),this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new iC(this._stage,this.resourceController.scheduler));const i=this._resolveWhenReady;this._resolveWhenReady=[],i.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",D(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add($c);for(const e of this.map.allLayers.items)ft(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add($c);for(const e of this.map.allLayers.items)ft(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function BD(e,t){return null!=e&&Ne(e.spatialReference,t)?Fe(e,t):null}zD.type="3d",e([ae()],zD.prototype,"_userClippingArea",void 0),e([ae()],zD.prototype,"_resourceController",void 0),e([ae()],zD.prototype,"_stage",void 0),e([ae({readOnly:!0})],zD.prototype,"deconflictor",void 0),e([ae({readOnly:!0})],zD.prototype,"labeler",void 0),e([ae(Ee(Pt,"analyses"))],zD.prototype,"analyses",void 0),e([ae({type:At,readOnly:!0})],zD.prototype,"animation",null),e([ae({readOnly:!0})],zD.prototype,"basemapTerrain",void 0),e([ae({readOnly:!0})],zD.prototype,"elevationProvider",void 0),e([ae()],zD.prototype,"camera",null),e([ae({type:t})],zD.prototype,"contentCamera",null),e([ae({readOnly:!0})],zD.prototype,"canvas",void 0),e([ae({type:eh})],zD.prototype,"center",null),e([ae({type:Jc})],zD.prototype,"clippingArea",null),e([ae({type:tm})],zD.prototype,"constraints",void 0),e([ae({type:Jc,readOnly:!0})],zD.prototype,"renderDataExtent",null),e([ae({type:Jc,readOnly:!0})],zD.prototype,"dataExtent",null),e([ae({type:Jc,readOnly:!0})],zD.prototype,"_groundAndLayersExtent",null),e([ae({type:om})],zD.prototype,"environment",void 0),e([oe("environment")],zD.prototype,"castEnvironment",null),e([ae({readOnly:!0})],zD.prototype,"environmentManager",void 0),e([ae({type:Jc})],zD.prototype,"extent",null),e([ae()],zD.prototype,"floors",void 0),e([ae()],zD.prototype,"screenCenter",null),e([ae()],zD.prototype,"frustum",null),e([ae({type:Number,readOnly:!0})],zD.prototype,"fullOpacity",void 0),e([ae({readOnly:!0})],zD.prototype,"graphicsView",void 0),e([ae({readOnly:!0})],zD.prototype,"analysisViewManager",void 0),e([ae()],zD.prototype,"groundView",void 0),e([ae({type:Boolean})],zD.prototype,"initialExtentRequired",null),e([ae()],zD.prototype,"_defaultsFromMapSettings",null),e([ae()],zD.prototype,"interacting",null),e([ae()],zD.prototype,"stationary",null),e([ae()],zD.prototype,"navigating",null),e([ae()],zD.prototype,"map",void 0),e([ae({readOnly:!0})],zD.prototype,"mapCoordsHelper",void 0),e([ae()],zD.prototype,"padding",null),e([ae({type:LC,readOnly:!0})],zD.prototype,"pointsOfInterest",void 0),e([ae({type:mb,readOnly:!0})],zD.prototype,"featureTiles",void 0),e([ae()],zD.prototype,"_featureTreeDebugger",void 0),e([ae({type:Boolean})],zD.prototype,"screenSizePerspectiveEnabled",void 0),e([ae({constructOnly:!0})],zD.prototype,"deactivatedWebGLExtensions",void 0),e([ae({constructOnly:!0})],zD.prototype,"debugWebGLExtensions",void 0),e([ae({constructOnly:!0})],zD.prototype,"renderCanvas",void 0),e([ae({constructOnly:!0})],zD.prototype,"state",void 0),e([ae({readOnly:!0})],zD.prototype,"inputManager",void 0),e([ae({readOnly:!0})],zD.prototype,"stateManager",void 0),e([ae({type:["low","medium","high"]})],zD.prototype,"qualityProfile",null),e([ae({type:Kb,get(){let e=this._get("qualitySettings");return e||(e=new Kb,Vb.apply(this.qualityProfile,e)),e}})],zD.prototype,"qualitySettings",void 0),e([ae()],zD.prototype,"slicePlane",null),e([ae({readOnly:!0})],zD.prototype,"typeSpecificPreconditionsReady",null),e([ae({readOnly:!0})],zD.prototype,"renderCoordsHelper",void 0),e([ae({readOnly:!0})],zD.prototype,"sceneIntersectionHelper",void 0),e([ae({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],zD.prototype,"resolution",null),e([ae({type:Number})],zD.prototype,"scale",null),e([ae()],zD.prototype,"heightModelInfo",null),e([ae()],zD.prototype,"spatialReference",void 0),e([ae({type:Boolean,constructOnly:!0})],zD.prototype,"alphaCompositingEnabled",void 0),e([ae({constructOnly:!0})],zD.prototype,"preserveDrawingBufferEnabled",void 0),e([ae({type:Boolean})],zD.prototype,"supersampleScreenshotsEnabled",void 0),e([ae({readOnly:!0})],zD.prototype,"type",void 0),e([ae(),oe((e=>e instanceof Np?e:ue(qD,e)))],zD.prototype,"ui",void 0),e([ae({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],zD.prototype,"updating",null),e([ae()],zD.prototype,"_updatingObjects",null),e([ae()],zD.prototype,"_updatingObjectsWithProgress",null),e([ae({type:Number,readOnly:!0,dependsOn:["updating"]})],zD.prototype,"updatingProgress",void 0),e([ae({type:["global","local"]})],zD.prototype,"viewingMode",null),e([ae({type:i})],zD.prototype,"viewpoint",null),e([ae({type:Number})],zD.prototype,"zoom",null),e([ae({type:qb})],zD.prototype,"highlightOptions",void 0),e([ae({readOnly:!0})],zD.prototype,"quality",null),e([ae({readOnly:!0})],zD.prototype,"resolutionScale",null),e([ae()],zD.prototype,"textures",void 0),zD=e([le("esri.views.SceneView")],zD);const HD=we(),GD=J(),WD=je(),$D=zD;export{sE as C,tv as F,LT as R,Fy as a,$D as default,Vy as g,Uy as r};
