/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import s from"../../core/Error.js";import{a as r,m as o}from"../../chunks/handleUtils.js";import{L as i}from"../../chunks/Logger.js";import{d as a,a as n}from"../../chunks/maybe.js";import{isAborted as p,onAbort as l,createAbortError as m,throwIfAborted as c,debounce as u}from"../../core/promiseUtils.js";import{Q as d}from"../../chunks/Queue.js";import{watch as h,whenOnce as j,sync as y}from"../../core/reactiveUtils.js";import k,{m as f}from"../../core/Accessor.js";import{property as w}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as g}from"../../core/accessorSupport/decorators/subclass.js";import{i as b}from"../../chunks/editableLayers.js";import{g as v,h as S,u as F,k as C}from"../../chunks/layerUtils2.js";import M from"../../views/draw/support/HighlightHelper.js";import U,{f as I,w as _,a as V,c as E,g as x,s as A,i as R,u as L,b as P,d as W,e as D,h as O}from"./CreateFeaturesWorkflow.js";import T from"../../layers/GraphicsLayer.js";import{h as H}from"../../chunks/layerViewUtils.js";import{Edits as G}from"./Edits.js";import{a as B,i as z}from"../../chunks/styleUtils.js";import q from"./Workflow.js";import N from"../FeatureForm/FeatureFormViewModel.js";import Q from"../Sketch/SketchViewModel.js";import Z from"./UpdateWorkflowData.js";import{c as J}from"../../chunks/featureUtils.js";import{g as K}from"../../chunks/templateUtils.js";import"../../geometry.js";import"../../chunks/ensureType.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../config.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../intl.js";import"../../chunks/date.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/messages.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../chunks/asyncUtils.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/infoFor3D.js";import"../../chunks/layerUtils.js";import"../../chunks/utils2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/uuid.js";import"../../chunks/helpMessageUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./CreateFeaturesWorkflowData.js";import"../../chunks/diffUtils.js";import"../../chunks/drapedUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../symbols/support/jsonUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils9.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/_commonjsHelpers.js";import"../../symbols/support/cimSymbolUtils.js";import"../../chunks/utils6.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/mat2df32.js";import"../../chunks/mat2d.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../chunks/GraphicState.js";import"../../chunks/hitTestSelectUtils.js";import"../../chunks/GraphicsCollection.js";import"../../layers/Layer.js";import"../../layers/mixins/BlendLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/UpdatingHandles.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/InteractiveElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DatePickerInput.js";import"../../form/elements/inputs/DateTimeOffsetPickerInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../form/elements/inputs/TimePickerInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../form/elements/RelationshipElement.js";import"../../form/elements/TextElement.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/support/Subtype.js";import"../../chunks/featureFormUtils.js";import"../FeatureForm/FieldInput.js";import"../FeatureForm/EditableInput.js";import"../FeatureForm/InputBase.js";import"../../arcade.js";import"../../chunks/TimeOnly.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/OverrideHelper.js";import"../../chunks/CIMSymbolHelper.js";import"../../chunks/BidiEngine.js";import"../../chunks/fontUtils.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/GeometryUtils.js";import"../../chunks/enums2.js";import"../../chunks/definitions.js";import"../../chunks/HighlightOptions.js";import"../../chunks/shapingUtils.js";import"../../chunks/vec2.js";import"../../chunks/vec2f32.js";import"../../chunks/Rect.js";import"../../chunks/BoundingBox.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../chunks/layerContainerType.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../chunks/spatialRelationships.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../support/timeUtils.js";import"../../chunks/featureLayerUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../chunks/jsonUtils2.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/MD5.js";import"../../layers/mixins/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../chunks/OrderByInfo.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/portalItemUtils.js";import"../../geometry/projection.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../support/popupUtils.js";import"../../chunks/interfaces3.js";import"../FeatureForm/GroupInput.js";import"../FeatureForm/RelationshipInput.js";import"../../chunks/FeatureRelationshipViewModel.js";import"../../chunks/elevationInfoUtils.js";import"../../geometry/Circle.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/InputManager.js";import"../../chunks/PropertiesPool.js";import"../../core/signal.js";import"../../chunks/keybindings.js";import"../../views/interactive/sketch/SketchLabelOptions.js";import"../../views/interactive/sketch/SketchTooltipOptions.js";import"../../views/interactive/sketch/SketchValueOptions.js";import"../../chunks/angularMeasurementUtils.js";import"../../chunks/Cyclical.js";import"../../chunks/quantityUtils.js";import"../../chunks/vec2f64.js";import"../../chunks/projectVectorToVector.js";import"../../chunks/projectPointToVector.js";import"../../chunks/dehydratedPoint.js";import"../../chunks/SnappingManager.js";import"../../chunks/normalizedPoint.js";import"../../chunks/Settings.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/snappingUtils.js";import"../../chunks/plane.js";import"../../chunks/mat3f64.js";import"../../chunks/mat4f64.js";import"../../chunks/quatf64.js";import"../../chunks/mathUtils2.js";import"../../chunks/sphere.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/viewUtils.js";import"../../geometry/geometryEngine.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../chunks/projectVectorToWGS84ComparableLonLat.js";import"../../chunks/geodesicMeasurementUtils.js";import"../../views/interactive/snapping/SnappingOptions.js";import"../../chunks/screenUtils2.js";var $;let X=$=class extends k{constructor(t){super(t),this.attachmentsCapabilities=null,this.editableItem=null,this.edits=null,this.formTemplate=null,this.parent=null,this.relatedRecordCallbacks=null,this.viewModel=null}static async create(t){const e=$._makeConstructorProps(t);return new $(e)}static _makeConstructorProps(t){const{feature:e,parent:r,relatedRecordCallbacks:o,viewModel:i}=t,a=i.editableItems.find((t=>t.layer===e.layer));if(!a)throw new s("no-editableItem-found","The EditorViewModel provided did not have an EditableItem associated with the specified Graphic's layer");const n=I(i.layerInfos,e.sourceLayer),p=a.supports,l=p.includes("create"),m=p.includes("update");return{attachmentsCapabilities:{editing:!0,operations:{add:l||m,update:m,delete:m}},editableItem:a,edits:new G({feature:e}),formTemplate:n?.formTemplate,parent:r,relatedRecordCallbacks:o,viewModel:i}}};t([w()],X.prototype,"attachmentsCapabilities",void 0),t([w({constructOnly:!0})],X.prototype,"editableItem",void 0),t([w()],X.prototype,"edits",void 0),t([w()],X.prototype,"formTemplate",void 0),t([w()],X.prototype,"parent",void 0),t([w()],X.prototype,"relatedRecordCallbacks",void 0),t([w()],X.prototype,"viewModel",void 0),X=$=t([g("esri.widgets.Editor.UpdateRecordWorkflowData")],X);const Y=X;var tt;let et=tt=class extends Y{constructor(t){super(t)}static async create(t){const{feature:e,viewModel:r}=t,{view:o}=r;if(!o)throw new s("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const i=await _(o,e.layer);return new tt({...tt._makeConstructorProps(t),layerView:i})}};t([w()],et.prototype,"layerView",void 0),et=tt=t([g("esri.widgets.Editor.UpdateFeatureWorkflowData")],et);const st=et;var rt;const ot={exit:Symbol()};let it=rt=class extends q{constructor(t){super(t),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:t}=this,{edits:e}=t,{view:i}=t.viewModel,a=e.feature,n=new AbortController;this.addHandles(r(n)),this._updatingHandles.addPromise(V(a,t.viewModel.view.spatialReference,n.signal).then((t=>{p(n)||(this._onFullFeatureLoaded(t),this._initializeFeatureFormViewModel())}),(t=>this.cancel({force:!0,error:new s("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:t}})})))),i&&(this._highlightHelper=new M({view:i}),this.addHandles(o((()=>this._highlightHelper?.removeAll()))))}get editableItem(){return this.data.editableItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editableItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editableItem.layer}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get reliesOnOwnerAdminPrivileges(){const{layer:t}=this.editableItem,e=t.capabilities?.operations.supportsUpdate,s=v(t)?.operations.supportsUpdate;return S(t)&&!t.editingEnabled||!!s&&!e}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(t){this.removeHandles(ot.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:t,fullFeature:e}=this,{attachmentsCapabilities:s,viewModel:r}=t,{attachmentsViewModel:i}=r;i.set({capabilities:s,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles([o((()=>i.fileInfos.removeAll())),h((()=>i.mode),(t=>{switch(t){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}))],ot.exit)}_initializeFeatureFormViewModel(){const{edits:t,formTemplate:e,viewModel:{view:s}}=this.data,r=this._featureFormViewModel=new N({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,highlightHelper:this._highlightHelper,map:s?.map,spatialReference:s.spatialReference,timeZone:s?.timeZone});r.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:t=>r.relationshipId=t.relationshipId};const{initialFeature:o}=t;o&&r.overrideInitialFeature(o),this.addHandles([r.on("value-change",(()=>{t.updateAttributes(r.getValues()),this.fullFeature.attributes=t.feature.attributes})),h((()=>s?.timeZone),(t=>r.timeZone=t))])}_onFullFeatureLoaded(t){this.fullFeature=t;const{edits:e}=this.data;e.updateAttributes(t.attributes),e.trackChanges()}static async create(t){const e=new rt({data:await Y.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(t){const{attachmentsViewModel:e}=t.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};var at;it._onCommitFactory=t=>async e=>{const{edits:s}=e,{feature:r}=s;if(!r)return;const o=r.sourceLayer,i=r.clone();if(!s.attributesModified||s.stagedForDelete){const t=o.objectIdField;if(i.attributes={[t]:r.getAttribute(t)},B()&&z()&&"scene"===o.type&&null!=o.infoFor3D){const t=o.associatedLayer?.globalIdField;null!=t&&i.setAttribute(t,r.getAttribute(t))}}s.geometryModified&&!s.stagedForDelete||(i.geometry=null);const a=s.stagedForDelete?"deleteFeatures":"updateFeatures";await t(o,{[a]:[i]})},t([w()],it.prototype,"editableItem",null),t([w()],it.prototype,"featureFormViewModel",null),t([w()],it.prototype,"fullFeature",void 0),t([w()],it.prototype,"hasPendingEdits",null),t([w()],it.prototype,"layer",null),t([w()],it.prototype,"parent",null),t([w()],it.prototype,"parentLayer",null),t([w()],it.prototype,"shouldShowAttachments",null),t([w()],it.prototype,"shouldAllowAttachmentEditing",null),t([w()],it.prototype,"reliesOnOwnerAdminPrivileges",null),it=rt=t([g("esri.widgets.Editor.UpdateRecordWorkflow")],it);const nt={...ot,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol()};let pt=at=class extends it{constructor(t){super(t),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}initialize(){const{edits:{feature:t},layerView:e}=this.data;E(e)&&(this._layerViewEditSession=e.createInteractiveEditSession(t))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(nt.sketchGraphics);try{const t=this.data.edits.stagedForDelete;await super.commit();const e=this._layerViewEditSession;t?e?.rollback():e?.commit()}catch(t){throw await this._configureSketchViewModel(),new s("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:t})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles(this._featureFormViewModel.on("value-change",(t=>{this._layerViewEditSession?.setAttribute(t.fieldName,t.value)})))}_configureHighlight(){const{edits:t,layerView:e}=this.data;H(e)&&this.addHandles(e.highlight(t.feature),nt.highlights)}async _configureSketchViewModel(){const t=this._sketchViewModel;if(!t)return;const{data:e,_featureFormViewModel:s,_sketchGraphicClone:r}=this,{edits:o,viewModel:i}=e,a=o.feature,{view:n}=i,p=x(a),l=await A({feature:a,featureClone:r,visualVariableAttributes:p,sketchViewModel:t,view:n,onUpdate:({geometry:t,attributes:e},r)=>{if(o.updateAttributes(e),o.updateGeometry(t),s.feature.geometry=t,null!=p.rotation){const{field:t}=p.rotation;s.setValue(t,e[t])}if(null!=p.size){const{field:t}=p.size;s.setValue(t,e[t])}("undo"===r.type||"redo"===r.type||"update"===r.type&&null!=r.toolEventInfo&&R(r.toolEventInfo.type))&&s.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(l,nt.sketchGraphics)}async _initializeSketchViewModel(){const{data:t,_sketchGraphicClone:e}=this,s=t.edits.feature,{geometryUpdatesEnabled:r,layer:i}=t.editableItem,{view:n}=t.viewModel;if(this.removeHandles([nt.highlights,nt.sketchGraphics,nt.sketchViewModel]),!r)return{enter:async()=>{this.hasHandles(nt.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([nt.highlights])};const{viewModel:p}=t,{labelOptions:l,snappingOptions:m,tooltipOptions:c,valueOptions:u}=p,d=new T({elevationInfo:i.elevationInfo,internal:!0,listMode:"hide"}),j=new Q({allowDeleteKey:!1,labelOptions:l,layer:d,snappingOptions:m,tooltipOptions:c,valueOptions:u,updateOnGraphicClick:!1,view:n});return this._sketchViewModel=j,this.addHandles([h((()=>[p.labelOptions,p.snappingOptions,p.tooltipOptions]),(([t,e,s])=>j.set({labelOptions:t,snappingOptions:e,tooltipOptions:s})))]),n?.map.add(d),this.addHandles(o((()=>{n?.destroyed||n?.map.remove(d),d.destroy(),this._sketchViewModel=a(j)})),nt.sketchViewModel),await L(e,this._webStyleCache,"2d"===n?.type?n.scale:null),this.addHandles([await P(j,s,e)]),{enter:async()=>{this.hasHandles(nt.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([nt.sketchGraphics]),viewModel:j}}_onFullFeatureLoaded(t){super._onFullFeatureLoaded(t),this._sketchGraphicClone=W(t);const{edits:e}=this.data;e.updateGeometry(t.geometry),e.trackChanges()}static async create(t){const e=new at({data:await st.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}get test(){return{graphicClone:this._sketchGraphicClone}}};var lt;t([w()],pt.prototype,"_layerViewEditSession",void 0),t([w()],pt.prototype,"_sketchGraphicClone",void 0),t([w()],pt.prototype,"_sketchViewModel",void 0),pt=at=t([g("esri.widgets.Editor.UpdateFeatureWorkflow")],pt);const mt="esri.widgets.Editor.UpdateWorkflow";let ct=lt=class extends q{constructor(t){super(t),this._workflowStack=new d(f),this._sketchStack=new d(f),this.type="update"}get activeEditableItem(){return this.activeWorkflow?.data.editableItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get activeWorkflow(){return this._workflowStack.last()}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return!!this.activeEditableItem?.supports.includes("update")}get hasPendingEdits(){return Array.from(this._workflowStack).some((t=>t.hasPendingEdits))}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditableItem?.hasInvalidFormTemplate}get hasUnsupportedFields(){return!!this.activeEditableItem?.hasUnsupportedFields}async back(t=(()=>Promise.resolve(!0))){const{activeWorkflow:e}=this;if(null==e?.featureFormViewModel.relationshipId)if(e){if(e.hasPendingEdits&&!await t())return;e.hasPreviousStep?await e.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.featureFormViewModel.relationshipId=null}async cancelActiveWorkflow(t){await(this.activeWorkflow?.cancel(t)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((t=>t.commit())),await super.commit()}static create(t){const{viewModel:e,startAt:s,addAttachmentsCallback:r,applyEditsCallback:o}=t,i=new lt({data:new Z({addAttachmentsCallback:r,applyEditsCallback:o,viewModel:e}),onCommit:async()=>{}});return i._set("steps",this._createWorkflowSteps(i,s)),i}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(t){try{const e=await this._createNestedCreateFeaturesWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new s("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(t){try{const e=await this._createNestedUpdateWorkflow(t);await this._pushWorkflow(e)}catch(t){throw new s("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:t}=this;if(!t)throw new s("editor:nothing-to-delete","There is no feature to delete");dt(t)?await t.deleteAndCommit():await t.cancel(),1===this.nestedWorkflowCount?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack((t=>t.cancel({force:!0})))}async _createNestedCreateFeaturesWorkflow(t){const{relatedLayer:e}=t,{addAttachmentsCallback:r,applyEditsCallback:o,viewModel:i}=this.data;if(!b(e))throw new s("editor:unsupported-layer","Editing is not supported on the provided layer");const a=this._getCreationInfoForNestedCreateFeaturesWorkflow(t),n=a.template||a.initialFeature?"creating-features":"awaiting-feature-creation-info",p="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return U.create({addAttachmentsCallback:r,applyEditsCallback:o,creationInfo:a,isNested:!0,parent:p,startAt:n,viewModel:i})}_getCreationInfoForNestedCreateFeaturesWorkflow(t){const{relatedLayer:r}=t;if(!b(r)||F(r))throw new s("editor:unsupported-layer","Editing is not supported on the provided layer");const o={layer:r,maxFeatures:1},i=this._makeRelatedRecordAttributes(t),a=K(r);return a?.length>0?(o.attributeOverrides=i,1===a.length&&(o.template=a[0])):o.initialFeature=new e({sourceLayer:r,attributes:i}),o}async _createNestedUpdateWorkflow(t){const e=C(t.sourceLayer)?it:pt,{applyEditsCallback:s,viewModel:r}=this.data,o="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,i=await e.create({feature:t,parent:o,viewModel:r,applyEdits:s,relatedRecordCallbacks:{addRelatedRecord:async t=>await this.startCreatingRelatedRecord(t),editRelatedRecord:async({relatedFeature:t})=>await this.startUpdating(t)}});return await j((()=>!i.updating)),i}async _drainWorkflowStack(t){const e=this._workflowStack,s=[];for(;e.length>0;){const r=e.pop();this._sketchStack.pop();const o=t(r).then((()=>r.destroy()));this._updatingHandles.addPromise(o),s.push(o)}await Promise.all(s)}_makeRelatedRecordAttributes(t){const{parentFeature:e,relatedLayer:s,relationshipId:r}=t;if(!J(e))return;const o=s.relationships?.find((t=>t.id===r));if(!o)return void ut("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===o.role)return void ut("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const i=e.sourceLayer;o.relatedTableId!==i.layerId&&ut("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const a=i.relationships?.find((t=>t.id===r));if(!a)return void ut("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const n=e.getAttribute(a.keyField);return n||ut("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[o.keyField]:n}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new s("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(t){const e=this._workflowRequiresSketchViewModel(t);this.activeWorkflow?.exit({removeSketchHandles:e});const r=this._sketchStack,o=await(t?.start()),i=r.peek();o?(i?.exit(),r.push(o)):r.push(this._cloneSketchController(i)),this._workflowStack.push(t);const a=await this._reconcileWorkflowStack();if(a.failureCount>0)throw new s("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",a)}async _reconcileWorkflowStack(){const t=this._workflowStack,e=this._sketchStack;try{const s=t.peek();return await(s?.enter()),await(e.peek()?.enter()),{activeWorkflow:s,failureCount:0}}catch(s){t.pop().destroy(),e.pop();const{activeWorkflow:r,failureCount:o}=await this._reconcileWorkflowStack();return{activeWorkflow:r,failureCount:o+1}}}_cloneSketchController(t){return{enter:t?.enter??(async()=>{}),exit:t?.exit??(async()=>{}),viewModel:t?.viewModel}}_workflowRequiresSketchViewModel(t){const{type:e}=t;return"update-feature"===e||"create-features"===e&&!C(t.data.creationInfo?.layer)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:r}=t;return D(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:e}=r.viewModel,s=r.viewModel.view;let i=null;t.addHandles(o((()=>{i=n(i)})),this.id),r.rootFeature=null,r.candidates=[];const a=s.on("immediate-click",(async o=>{o.stopPropagation(),e.location=o.mapPoint,e.visible=!0,i?.abort();const{editableItems:a}=r.viewModel;i=new AbortController;const n=await new Promise(((t,e)=>{l(i?.signal,(()=>e(m()))),t(O(a,s,o,i?.signal))}));c(i),r.candidates=n.filter((t=>"fulfilled"===t.status)).flatMap((t=>t.value)),e.visible=1===r.candidates.length,0!==r.candidates.length&&(1===r.candidates.length?(r.rootFeature=r.candidates[0],t.go("editing-existing-feature").catch((()=>{})).then((()=>e.visible=!1))):t.next())}));s.focus(),t.addHandles(a,this.id)},async tearDown(){0===r.candidates.length&&(r.viewModel.spinnerViewModel.visible=!1),t.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){r.rootFeature=null;const{view:e}=r.viewModel;if(!e)return;const s=new M({view:e});t.addHandles([h((()=>r.rootFeature),((t,e)=>{s.remove(e),s.add(t)}),y),o((()=>s.removeAll()))],this.id)},async tearDown(){t.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:e,viewModel:r}=t.data;if(!e)throw new s("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await t.startUpdating(e),r.spinnerViewModel.visible=!1;const o=u((async()=>{await j((()=>!t.updating)),t.previous()}));t.addHandles([h((()=>t.nestedWorkflowCount),((t,e)=>{0===t&&0!==e&&o()}),y)],this.id)},async tearDown(){await t.cancelAll(),t.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}})})}};t([w()],ct.prototype,"activeEditableItem",null),t([w()],ct.prototype,"activeFeatureFormViewModel",null),t([w()],ct.prototype,"activeSketchViewModel",null),t([w()],ct.prototype,"activeWorkflow",null),t([w()],ct.prototype,"nestedWorkflowCount",null),t([w()],ct.prototype,"shouldShowAttachments",null),t([w()],ct.prototype,"shouldAllowAttachmentEditing",null),t([w()],ct.prototype,"hasPendingEdits",null),t([w()],ct.prototype,"helpMessage",null),t([w()],ct.prototype,"reliesOnOwnerAdminPrivileges",null),t([w()],ct.prototype,"hasInvalidFormTemplate",null),t([w()],ct.prototype,"hasUnsupportedFields",null),ct=lt=t([g(mt)],ct);const ut=(t,e)=>i.getLogger(mt).warn(`editor:${t}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),dt=t=>!!t&&/update-/.test(t.type),ht=ct;export{ht as default};
