/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import s from"../../core/Accessor.js";import r from"../../core/Collection.js";import{watch as t,initial as i,when as o}from"../../core/reactiveUtils.js";import{g as n,property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/Logger.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{g as l}from"../../chunks/featureReductionUtils.js";import m from"./support/ActiveLayerInfo.js";import{o as y}from"../../chunks/locale.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../config.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/messages.js";import"../../core/Error.js";import"../../chunks/handleUtils.js";import"../../core/promiseUtils.js";import"../../chunks/maybe.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../chunks/assets.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../core/Evented.js";import"../../chunks/ensureType.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/asyncUtils.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../chunks/enumeration.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../core/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/timeUtils.js";import"../../chunks/EffectView.js";import"../../chunks/parser.js";import"../../chunks/utils3.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/jsonUtils.js";import"../../chunks/ExportImageParameters.js";import"../../chunks/scaleUtils.js";import"../../chunks/commonProperties2.js";import"../../TimeExtent.js";import"../../chunks/layerContainerType.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/floorFilterUtils.js";import"../../chunks/sublayerUtils.js";import"../../chunks/layerUtils2.js";import"../../chunks/pixelRangeUtils.js";import"../../renderers/support/jsonUtils.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/compilerUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../chunks/Version.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/UnknownTimeZone.js";import"../../chunks/OverrideHelper.js";import"../../chunks/colorUtils2.js";import"../../chunks/vec4.js";import"../../chunks/vec4f64.js";import"../../chunks/CIMSymbolHelper.js";import"../../chunks/BidiEngine.js";import"../../chunks/fontUtils.js";import"../../chunks/OptimizedGeometry.js";import"../../chunks/GeometryUtils.js";import"../../chunks/enums2.js";import"../../chunks/utils6.js";import"../../chunks/definitions.js";import"../../chunks/HighlightOptions.js";import"../../chunks/shapingUtils.js";import"../../chunks/mat2d.js";import"../../chunks/mat2df32.js";import"../../chunks/vec2.js";import"../../chunks/vec2f32.js";import"../../chunks/Rect.js";import"../../chunks/BoundingBox.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../chunks/quantizationUtils.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../chunks/rendererConversion.js";import"../../chunks/utils2.js";import"../../chunks/basemapUtils.js";import"../../Basemap.js";import"../../chunks/loadAll.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../support/BasemapStyle.js";import"../../chunks/writeUtils.js";import"../../symbols/support/cimSymbolUtils.js";import"../../symbols/support/symbolUtils.js";import"../../chunks/utils9.js";import"../../chunks/projector.js";import"../../chunks/widgetUtils.js";import"../../chunks/jsxFactory.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/webStyleSymbolUtils.js";import"../../chunks/devEnvironmentUtils.js";import"../../renderers/support/utils.js";import"../../chunks/numberUtils.js";import"../../chunks/themeUtils.js";import"../smartMapping/support/utils.js";const c="state",u="all-layer-views",h="legend-properties",d=r.ofType(m),j=new Set(["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.OrientedImageryLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer"]),L="view.basemapView.baseLayerViews",b="view.groundView.layerViews",f="view.basemapView.referenceLayerViews",k=[L,b,"view.layerViews",f];let I=class extends s{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new r,this.activeLayerInfos=new d,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(t((()=>this.view),(()=>this._viewHandles()),i),"view"),this.addHandles(y((()=>this._refresh())))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.view?.ready?"ready":"disabled"}_viewHandles(){this.removeHandles(c),this.view&&this.addHandles(t((()=>this.state),(()=>this._stateHandles()),i),c)}_stateHandles(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([u,h]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);const s=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],s?.parent&&s.parent.children.remove(s)}_watchPropertiesAndAllLayerViews(){const{view:e}=this;if(!e)return;const{allLayerViews:s}=e;s.length&&this._refresh(),this.addHandles(s.on("change",(e=>this._allLayerViewsChangeHandle(e))),u),this.addHandles(t((()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible]),(()=>this._propertiesChangeHandle())),h)}_allLayerViewsChangeHandle(e){e.removed.forEach((e=>this._destroyViewActiveLayerInfo(e.uid))),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){const s=this.view;if(e.length<2||!s)return;const r=[];e.forEach((s=>{if(!s.parent){const t=s.layer.parent,i=t&&"uid"in t&&this._layerViewByLayerId[t.uid],o=i&&this._activeLayerInfosByLayerViewId[i.uid];o&&e.includes(o)&&(r.push(s),s.parent=o,o.children.add(s),this._sortActiveLayerInfos(o.children))}})),e.removeMany(r);const t={};s.allLayerViews.forEach(((e,s)=>t[e.layer.uid]=s)),e.sort(((e,s)=>{const r=t[e.layer.uid]||0;return(t[s.layer.uid]||0)-r}))}_generateLayerViews(){const e=[];return k.filter(this._filterLayerViews,this).map((e=>n(this,e))).filter((e=>null!=e)).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const s=!this.basemapLegendVisible&&(e===L||e===f),r=!this.groundLegendVisible&&e===b;return!s&&!r}_collectLayerViews(e,s){const r=t=>(t&&t.forEach((t=>{s.push(t),r(t[e])})),s);return r}_filterLayerViewsByLayerInfos(e){const s=this.layerInfos;return!s||!s.length||s.some((s=>this._hasLayerInfo(s,e)))}_hasLayerInfo(e,s){const r=this._isLayerUIDMatching(e.layer,s.layer.uid);return r&&(this._layerInfosByLayerViewId[s.uid]=e),r}_isLayerUIDMatching(e,s){return e&&(e.uid===s||this._hasLayerUID(e.layers,s))}_hasLayerUID(e,s){return e&&e.some((e=>this._isLayerUIDMatching(e,s)))}_isLayerViewSupported(e){return!!j.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(t((()=>[e.legendEnabled,e.layer?.legendEnabled]),(()=>this._layerActiveHandle(e))),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}_buildActiveLayerInfo(e){const s=e.layer,r=e.uid,n=this._layerInfosByLayerViewId[r];let a=this._activeLayerInfosByLayerViewId[r];if(!a){const t=void 0!==n?.title&&n.layer.uid===s.uid;a=new m({layer:s,layerView:e,title:t?n.title:s.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:n?.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[r]=a}const p=s.parent&&"uid"in s.parent?this._layerViewByLayerId[s.parent?.uid]:null;if(a.parent=this._activeLayerInfosByLayerViewId[p?.uid],!this.hasHandles(r)){const n=[t((()=>s.title),(e=>this._titleHandle(e,a))),t((()=>[s.opacity,"renderer"in s&&s.renderer,"pointSymbol"in s&&s.pointSymbol,"lineSymbol"in s&&s.lineSymbol,"polygonSymbol"in s&&s.polygonSymbol]),(()=>this._constructLegendElements(a))),o((()=>!0===this.view?.stationary),(()=>this._scaleHandle(a)),i),t((()=>e.layer?l(e.layer,e.view):null),(()=>this._constructLegendElements(a))),t((()=>"effect"in s&&s.effect),(()=>this._constructLegendElements(a))),o((()=>this.view?.timeZone),(()=>this._constructLegendElements(a)),i)];if(this.respectLayerVisibility){const r=t((()=>e.legendEnabled),(e=>this._legendEnabledHandle(e,a))),i=t((()=>s.legendEnabled),(e=>this._legendEnabledHandle(e,a)));n.push(r,i)}this.addHandles(n,r)}a.isScaleDriven||this._constructLegendElements(a),this._addActiveLayerInfo(a)}_titleHandle(e,s){s.title=e,this._constructLegendElements(s)}_legendEnabledHandle(e,s){e?this._addActiveLayerInfo(s):this._removeActiveLayerInfo(s)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:s,layer:r}=e;if(this._isLayerActive(s)&&!this.activeLayerInfos.includes(e)){const s=e.parent;if(s)s.children.includes(e)||s.children.push(e),this._sortActiveLayerInfos(s.children);else{const s=this.layerInfos?.some((e=>e.layer.uid===r.uid));r.parent&&"uid"in r.parent&&!s?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const e=[];this._activeLayerInfosWithNoParent.forEach((s=>{const r=s.layer.parent,t=r&&"uid"in r?this._layerViewByLayerId[r?.uid]:null,i=this._activeLayerInfosByLayerViewId[t?.uid];i&&(e.push(s),s.parent=i)})),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach((e=>this._addActiveLayerInfo(e))))}}}_removeActiveLayerInfo(e){const s=e.parent;s?s.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const s=e.layer;"featureCollections"in s&&s.featureCollections?e.buildLegendElementsForFeatureCollections(s.featureCollections):"featureReduction"in s&&s.featureReduction&&"renderer"in s.featureReduction&&("binning"===s.featureReduction.type||"cluster"===s.featureReduction.type)?e.buildLegendElementsForFeatureReduction(s.featureReduction):"renderer"in s&&s.renderer&&!("sublayers"in s)?e.buildLegendElementsForRenderer(s.renderer):"url"in s&&s.url?e.buildLegendElementsForTools():e.children.forEach((e=>this._constructLegendElements(e)))}};e([a({type:d})],I.prototype,"activeLayerInfos",void 0),e([a()],I.prototype,"basemapLegendVisible",void 0),e([a()],I.prototype,"groundLegendVisible",void 0),e([a()],I.prototype,"hideLayersNotInCurrentView",void 0),e([a()],I.prototype,"keepCacheOnDestroy",void 0),e([a()],I.prototype,"respectLayerVisibility",void 0),e([a()],I.prototype,"layerInfos",void 0),e([a({readOnly:!0})],I.prototype,"state",null),e([a()],I.prototype,"view",void 0),I=e([p("esri.widgets.Legend.LegendViewModel")],I);const v=I;export{v as default};
