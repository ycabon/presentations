/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{clone as t}from"../../core/lang.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import{L as r}from"../../chunks/Logger.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import o from"./SearchSource.js";import{substitute as n}from"../../intl.js";import l from"../../core/Error.js";import{m as a}from"../../chunks/maybe.js";import{g as u}from"../../chunks/unitUtils.js";import c from"../../geometry/Polygon.js";import{c as d,s as p}from"../../chunks/geometryUtils2.js";import{F as m}from"../../chunks/FullTextSearch.js";import{f as h}from"../../chunks/date.js";import"../../chunks/ensureType.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/tracking.js";import"../../core/Identifiable.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ObservableBase.js";import"../../core/scheduling.js";import"../../core/promiseUtils.js";import"../../chunks/locale.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../chunks/jsonMap.js";import"../../chunks/writer.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../chunks/zmUtils.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/scaleUtils.js";import"../../core/Clonable.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";const f=/https?:\/\/services.*\.arcgis\.com/i,g=/(?:\{([^}]+)\})/g,y=()=>r.getLogger("esri.widgets.Search.support.layerSearchUtils");function F(e,t){const{filter:i,withinViewEnabled:r}=e,s=t?.extent,o=i?.geometry;return o??(r&&s?s:void 0)}function j(e){return e&&e.includes("*")}async function x(e){e&&await e.load()}function v(e){return!(!e.fullText&&!e.where)}function S(e,t){const i=e?.indexes;return!(!i||!t?.length)&&i.filter((e=>"FullText"===e.indexType)).some((e=>{const i=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>i.includes(e.toLowerCase())))}))}function w({text:e,searchFields:t}){return e.trim().split(" ").filter((e=>!!e.trim())).map((e=>new m({onFields:t,searchTerm:e,searchType:"prefix"})))}function b(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function k(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e.displayField||e.layer.displayField||(t=e.layer,t?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??"");var t}function $(e,t){return!(!e||!t?.length)&&t.every((t=>I(e,t)))}function I(e,t){return!!e.getField(t)}function L(e){return e.replaceAll("'","''")}function E(e,t){const i=t?.where;return i?`(${e}) AND (${i})`:e}function R({searchTerm:e,layer:t,searchFields:i,filter:r,exactMatch:s,query:o,type:n}){const{definitionExpression:l,url:u}=t;let c="";return!o.fullText&&e&&i&&i.forEach((i=>{const o=t.getField(i),l="function"==typeof t.getFieldDomain&&t.getFieldDomain(i),d=l&&"coded-value"===l.type?function({codedValues:e},t,i){return a(e??[],(e=>{const r=e.name,s=i?r:r.toLowerCase();return(i?t:t.toLowerCase())===s?e.code.toString():null}))??null}(l,e,s):null,p=d||e||null;if(null!==p){const e=function({currentTerm:e,field:t,filter:i,exactMatch:r,url:s,type:o}){const n=t?.type,l=t?.name;if("string"===n||"date"===n||"global-id"===n){const t=f.test(s??""),n=t&&function(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}(e)?"N":"";return E(r&&"search"===o?`${l} = ${n}'${e}'`:t?`${l} LIKE ${n}'${e}%'`:`LOWER(${l}) LIKE ${n}'${e.toLowerCase()}%'`,i)}if("oid"===n||"small-integer"===n||"integer"===n||"single"===n||"double"===n){const t=Number(e);return isNaN(t)?null:E(`${l} = ${t}`,i)}return E(`${l} = ${e}`,i)}({currentTerm:p,field:o,filter:r,exactMatch:s,url:u,type:n});e&&(c+=function(e,t){return e?` OR (${t})`:`(${t})`}(c,e))}})),l&&c?`(${l}) AND (${c})`:l||c}function M(e,t,i){const r=e.sourceLayer,{attributes:s}=e,o="function"==typeof r.getFieldDomain&&r.getFieldDomain(i);if(t)return n(t,s);if(i&&s){const e=r.getField(i),t=(l=s)[a=i]??l[Object.keys(l).find((e=>e.toLowerCase()===a.toLowerCase()))];return null==t?"":o&&"coded-value"===o.type?function(e,t){let i=null;const{codedValues:r}=e;return r&&r.length&&r.some((e=>e.code===t&&(i=e.name,!0))),i}(o,t)??"":"date"===e?.type?h(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}var l,a;return""}var U;let C=U=class extends o{constructor(e){super(e),this.displayField=null,this.exactMatch=null,this.orderByFields=null,this.searchFields=null,this.searchTemplate=null,this.suggestionTemplate=null,this.getResults=(e,i)=>function(e,i){const{exactMatch:r=!1,location:s,maxResults:o,spatialReference:n,source:a,sourceIndex:m,suggestResult:h,view:f}=e,{layer:g,filter:E,zoomScale:U}=a,C=f?.scale,_=F(a,f),q=i?.signal;return x(g).then((()=>{const e=g.popupTemplate;return e?e.getRequiredFields(g.fieldsIndex):null})).then((e=>{const{objectIdField:i,returnZ:F}=g,x=T(a);if(!I(g,x))throw y().error("invalid-field: displayField is invalid."),new l("getResults():invalid-field","displayField is invalid.");const D=e&&e.length?e:[x],N=a.outFields||D,A=j(N);if(N.includes(i)||A||N.push(i),g.floorInfo?.floorField&&N.push(g.floorInfo.floorField),!A&&!$(g,N))throw y().error("invalid-field: outField is invalid."),new l("getResults():invalid-field","outField is invalid.");const B=g.createQuery(),{orderByFields:O}=a;if(O&&(B.orderByFields=O),n){B.outSpatialReference=n;const e=1/u(n);e&&(B.maxAllowableOffset=e)}const G="mesh"===g.geometryType||"multipatch"===g.geometryType,V=g.capabilities?.data?.supportsZ&&!G;if(B.returnZ=V&&!1!==F,B.returnGeometry=!0,B.multipatchOption=G?"xyFootprint":null,N&&(B.outFields=N),s)B.geometry=s;else if(h.key)B.objectIds=[h.key];else{const e=a.searchFields||[x];if(!$(g,e))throw y().error("invalid-field: search field is invalid."),new l("getResults():invalid-field","search field is invalid.");k(g)&&(B.num=o),_&&(B.geometry=_);const t=h.text?.trim();if(!t)return[];const i=h.text,{prefix:s="",suffix:n=""}=a,u=L(`${s}${i}${n}`);b(g)&&S(g,e)&&!r&&i&&(B.fullText=w({text:i,searchFields:e}));const c=R({searchTerm:u,layer:g,searchFields:e,filter:E,exactMatch:r,query:B,type:"search"});if(B.where=c,!v(B))return[]}return g.queryFeatures(B,{signal:q}).then((e=>function(e,i,r,s,o,n,l){return e.features.map((e=>function(e,i,r,s,o,n,l){const a=e.clone(),u=e.sourceLayer,m=u?.objectIdField,h=m?e.attributes[m]:null,f=M(e,r.searchTemplate,o);null!=n&&function(e){return null!=e&&null!=e.minScale&&null!=e.maxScale}(u)&&(u.minScale&&u.minScale<n?n=u.minScale:u.maxScale&&u.maxScale>n&&(n=u.maxScale));const g=a.geometry?d(a.geometry,i??void 0,n??void 0):void 0,y="number"==typeof l&&g?p(t(g),i??void 0,l):g,F=e.clone();return null!=y&&(F.geometry=c.fromExtent(y)),{extent:y,target:F,feature:a,key:h,name:f,sourceIndex:s}}(e,i,r,s,o,n,l)))}(e,f,a,m,x,C,U)))}))}({source:this,...e},i),this.getSuggestions=(e,t)=>function(e,t){const{source:i,spatialReference:r,view:s,suggestTerm:o,maxSuggestions:n,sourceIndex:a,exactMatch:u}=e,{layer:c,filter:d}=i,p=t?.signal,m=F(i,s);return x(c).then((()=>{if(!k(c))return[];const e=T(i),t=i.searchFields||[e],s=[];i.suggestionTemplate?i.suggestionTemplate.replaceAll(g,((e,t)=>(s.push(t),e))):s.push(e);const h=j(s);s.includes(c.objectIdField)||h||s.push(c.objectIdField);const f=I(c,e),F=h||$(c,s),x=$(c,t);if(!f)throw y().error("invalid-field: displayField is invalid."),new l("getSuggestions():invalid-field","displayField is invalid.");if(!F)throw y().error("invalid-field: outField is invalid."),new l("getSuggestions():invalid-field","outField is invalid.");if(!x)throw y().error("invalid-field: search field is invalid."),new l("getSuggestions():invalid-field","search field is invalid.");const E=c.createQuery(),{orderByFields:U}=i;if(U&&(E.orderByFields=U),E.outSpatialReference=r,E.returnGeometry=!1,E.num=n,E.outFields=s,m&&(E.geometry=m),!o.trim())return[];const{prefix:C="",suffix:_=""}=i,q=L(`${C}${o}${_}`);b(c)&&S(c,t)&&!u&&o&&(E.fullText=w({text:o,searchFields:t}));const D=R({searchTerm:q,layer:c,searchFields:t,filter:d,exactMatch:u,query:E,type:"suggest"});return E.where=D,v(E)?c.queryFeatures(E,{signal:p}).then((t=>function(e,t,i,r){return e.features.map((e=>function(e,t,i,r){const s=e.sourceLayer,{attributes:o}=e,{objectIdField:n}=s,l=n?o[n]:null;return{text:M(e,t.suggestionTemplate,r),key:l,sourceIndex:i}}(e,t,i,r)))}(t,i,a,e))):[]}))}({source:this,...e},t)}set layer(e){this._set("layer",e),e&&e.load().catch((()=>{}))}get name(){return this._getLayerTitle()??""}set name(e){this._overrideIfSome("name",e)}clone(){return new U({autoNavigate:this.autoNavigate,filter:this.filter,maxResults:this.maxResults,maxSuggestions:this.maxSuggestions,minSuggestCharacters:this.minSuggestCharacters,outFields:this.outFields?t(this.outFields):null,placeholder:this.placeholder,popupEnabled:this.popupEnabled,prefix:this.prefix,resultGraphicEnabled:this.resultGraphicEnabled,resultSymbol:this.resultSymbol?this.resultSymbol.clone():null,suggestionsEnabled:this.suggestionsEnabled,suffix:this.suffix,withinViewEnabled:this.withinViewEnabled,displayField:this.displayField,exactMatch:this.exactMatch,layer:this.layer,searchFields:this.searchFields?t(this.searchFields):null,suggestionTemplate:this.suggestionTemplate,zoomScale:this.zoomScale})}_getFirstStringField(){return this.layer.fieldsIndex?.fields.find((e=>"string"===e.type))?.name??""}_getDisplayField(){return this.displayField||this.layer.displayField||this._getFirstStringField()}_getSearchFieldsString(){const{layer:e,searchFields:t}=this;return e.loaded?`: ${(t||[this._getDisplayField()]).map((t=>{const i=e.getField(t);return i?.alias||t})).join(", ")}`:""}_getLayerTitle(){const{layer:e}=this;if(!e)return;const{title:t}=e;return t?`${t}${this._getSearchFieldsString()}`:void 0}};e([i({json:{read:{source:"field.name"},write:{target:"field.name"}}})],C.prototype,"displayField",void 0),e([i({json:{read:{source:"field.exactMatch"},write:{target:"field.exactMatch"}}})],C.prototype,"exactMatch",void 0),e([i({value:null})],C.prototype,"layer",null),e([i()],C.prototype,"name",null),e([i({type:[String],json:{write:!0}})],C.prototype,"orderByFields",void 0),e([i()],C.prototype,"searchFields",void 0),e([i()],C.prototype,"searchTemplate",void 0),e([i()],C.prototype,"suggestionTemplate",void 0),C=U=e([s("esri.widgets.Search.LayerSearchSource")],C);const _=C;export{_ as default};
