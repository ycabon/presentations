/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Color.js";import i from"../../core/Accessor.js";import{i as s}from"../../core/lang.js";import{c as r}from"../../chunks/asyncUtils.js";import{a as o,d as n}from"../../chunks/maybe.js";import{after as a,throwIfAborted as l}from"../../core/promiseUtils.js";import{watch as u,syncAndInitial as c}from"../../core/reactiveUtils.js";import{c as d,b as h,d as p}from"../../chunks/screenUtils.js";import{c as m,f as v}from"../../chunks/timeUtils.js";import{property as _}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/Logger.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{c as w}from"../../chunks/vec3f64.js";import{l as y}from"../../chunks/earthUtils.js";import{c as g,a as T}from"../../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import j from"../../core/Collection.js";import{r as k}from"../../chunks/collectionUtils.js";import{m as P}from"../../chunks/handleUtils.js";import{t as b}from"../../chunks/throttle.js";import{b as D}from"../../chunks/traversalUtils.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../chunks/ensureType.js";import"../../config.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../core/Error.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../chunks/unitUtils.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/mat4.js";import"../../chunks/mat4f64.js";import"../../chunks/vec2.js";import"../../chunks/vec2f64.js";import"../../chunks/ViewingMode.js";import"../../chunks/_commonjsHelpers.js";import"../../chunks/mathUtils2.js";import"../../chunks/ShaderTechniqueConfiguration.js";import"../../chunks/interfaces5.js";var O;!function(e){e.Disabled="disabled",e.Ready="ready"}(O||(O={}));let S=class extends i{constructor(){super({}),this.color=new t([50,50,50,.7]),this.intervalOptions=new j([m(15,"minutes","milliseconds"),m(30,"minutes","milliseconds"),m(1,"hours","milliseconds"),m(2,"hours","milliseconds"),m(3,"hours","milliseconds")]),this.interval=this.intervalOptions.at(0)}set intervalOptions(e){this._set("intervalOptions",k(e,this._get("intervalOptions")))}};e([_({type:t})],S.prototype,"color",void 0),e([_()],S.prototype,"interval",void 0),e([_({type:j})],S.prototype,"intervalOptions",null),S=e([f("esri.widgets.ShadowCast.DiscreteOptions")],S);const U=S;var C;!function(e){e.Continuous="continuous",e.Hourly="hourly"}(C||(C={}));let z=class extends i{constructor(){super(...arguments),this.color=new t([0,0,255,.7]),this.mode=C.Continuous}};e([_({type:t})],z.prototype,"color",void 0),e([_()],z.prototype,"mode",void 0),z=e([f("esri.widgets.ShadowCast.DurationOptions")],z);const V=z;var A;!function(e){e.PointerMove="pointer-move",e.Main="main"}(A||(A={}));let E=class extends i{constructor(e){super(e),this._screenPoint=null,this._accumulatedShadowTime=null,this._shadowTimeTask=null,this._updateAccumulatedShadowTime=(e,t)=>{this._shadowTimeTask=o(this._shadowTimeTask),this._shadowTimeTask=r((async i=>{const{results:s,ground:r}=await e.hitTest(t);if(0===s.length&&!r.mapPoint)return void(this._accumulatedShadowTime=null);const o=await this.getDuration(t,i);this._accumulatedShadowTime=o}))},this._throttledUpdateAccumulatedShadowTime=b(this._updateAccumulatedShadowTime,300)}initialize(){this.addHandles(u((()=>({enabled:this.enabled,view:this.view})),(({enabled:e,view:t})=>{e&&null!=t?this._startTracking(t):this._stopTracking()}),c))}get screenPoint(){return this.enabled?this._screenPoint:null}get accumulatedShadowTime(){return this.enabled?this._accumulatedShadowTime:null}get testData(){return{setThrottleDelay:e=>{this._throttledUpdateAccumulatedShadowTime.remove(),this._throttledUpdateAccumulatedShadowTime=b(this._updateAccumulatedShadowTime,e)}}}_startTracking(e){if(this.hasHandles(A.Main))return;const t=()=>{this.hasHandles(A.PointerMove)||this.addHandles(e.on("pointer-move",(t=>{const i=d(t.x,t.y);this._screenPoint=i,this._throttledUpdateAccumulatedShadowTime(e,i)})),A.PointerMove)},i=()=>{this.removeHandles(A.PointerMove),this._screenPoint=null,this._accumulatedShadowTime=null};this.addHandles([this._throttledUpdateAccumulatedShadowTime,e.on("pointer-enter",t),e.on("pointer-leave",i),e.on("pointer-down",i),e.on("pointer-drag",i),e.on("pointer-up",t),e.on("click",(t=>{const i=d(t.x,t.y);this._screenPoint=i,this._updateAccumulatedShadowTime(e,i)})),P((()=>{this._shadowTimeTask=o(this._shadowTimeTask)}))],A.Main),t()}_stopTracking(){this.removeHandles(A.Main)}};var M;e([_()],E.prototype,"getDuration",void 0),e([_()],E.prototype,"view",void 0),e([_()],E.prototype,"enabled",void 0),e([_()],E.prototype,"screenPoint",null),e([_()],E.prototype,"accumulatedShadowTime",null),e([_()],E.prototype,"_screenPoint",void 0),e([_()],E.prototype,"_accumulatedShadowTime",void 0),e([_()],E.prototype,"_shadowTimeTask",void 0),E=e([f("esri.widgets.ShadowCast.ShadowTooltipViewModel")],E),function(e){e.Threshold="threshold",e.Duration="duration",e.Discrete="discrete"}(M||(M={})),M.Threshold,M.Duration,M.Discrete;let R=class extends i{constructor(){super(...arguments),this.color=new t([255,0,0,.7]),this.value=m(4,"hours","milliseconds"),this.minValue=0,this.maxValue=m(8,"hours","milliseconds")}};e([_({type:t})],R.prototype,"color",void 0),e([_()],R.prototype,"value",void 0),e([_()],R.prototype,"minValue",void 0),e([_()],R.prototype,"maxValue",void 0),R=e([f("esri.widgets.ShadowCast.ThresholdOptions")],R);const x=R,H=[],N=w(),G=[],F=m(1,"hours","milliseconds");let B=class extends i{constructor(e){super(e),this.view=null,this.tooltip=new E({getDuration:(e,t)=>this.getDuration(e,t)}),this.startTimeOfDay=m(10,"hours","milliseconds"),this.endTimeOfDay=m(16,"hours","milliseconds"),this.visualizationType=M.Threshold,this.thresholdOptions=new x,this.durationOptions=new V,this.discreteOptions=new U,this._running=!0,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this.addHandles([u((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t}),c),u((()=>this._forcePreviewDependencies),(()=>{o(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=r((async e=>{await a(500,e),l(e),this._forcePreview=!1})))}),c),u((()=>({renderer:this.renderer,parameters:this._visualizationParameters})),(e=>L(e.renderer,e.parameters)),c),u((()=>({renderer:this.renderer,parameters:{lightDirections:this._lightDirections}})),(e=>L(e.renderer,e.parameters)),c),u((()=>({renderer:this.renderer,parameters:{enabled:this._running}})),(e=>L(e.renderer,e.parameters)),c),u((()=>({renderer:this.renderer,parameters:{previewing:this._previewing}})),(e=>L(e.renderer,e.parameters)),c)])}destroy(){this.stop(),L(this.renderer,{enabled:!1}),n(this.tooltip)}get state(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?O.Ready:O.Disabled}set date(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(e){this._utcOffset=e}get testData(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}get _previewing(){const{view:e}=this;return null==e?.allLayerViews||this._forcePreview||!e.stationary||e.allLayerViews.some((e=>q(e)&&e.updating))}get _utcOffsetAuto(){const e=this._referencePosition;return null!=e?y(e[0],!1):0}get _dateUTCOffset(){let e=this.date;return e=v(e,-e.getTimezoneOffset(),"minutes"),e=v(e,-this.utcOffset,"hours"),e}get _startDateTimeUTC(){return v(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return v(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return this.view?.environmentManager?.referencePositionWGS84Comparable}get _interval(){const e=this._duration>0?Math.floor(this._duration/255):255,t=this.discreteOptions.interval;switch(this.visualizationType){case M.Threshold:case M.Duration:return e;case M.Discrete:return t>0?t:e}}get _sampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){const{view:e}=this;if(null==e)return H;const t="global"===e.viewingMode?N:this._referencePosition;if(null==t)return H;const i=this._interval,s=g(this._startDateTimeUTC,this._endDateTimeUTC,i,t,e.state.viewingMode),r=s.length;G.length=0;const o=D(0,r,G),n=new Array(r);for(let e=0;e<r;++e)n[e]=s[o[e]];return n}get _tooltipEnabled(){return this.state===O.Ready&&this.visualizationType!==M.Discrete&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case M.Threshold:return this._thresholdVisualizationParameters;case M.Duration:return this._durationVisualizationParameters;case M.Discrete:return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:e,color:i}=this.thresholdOptions,s=this._duration;return{visualization:T.Threshold,color:t.toUnitRGBA(i),threshold:s>0?e/this._duration:0}}get _durationVisualizationParameters(){const{color:e,mode:i}=this.durationOptions,s=this._duration,r=s>0&&i===C.Hourly?F/s:0;return{color:t.toUnitRGBA(e),visualization:T.Gradient,bandsEnabled:r>0,bandSize:r}}get _discreteVisualizationParameters(){return{color:t.toUnitRGBA(this.discreteOptions.color),visualization:T.Gradient,bandsEnabled:!1,bandSize:0}}get _forcePreviewDependencies(){const{view:e}=this;if(null==e)return null;const t=e.slicePlane,i=e.allLayerViews.toArray().filter(q),r=i.map((e=>e.layer)).filter(s),o=i.map((e=>e.visible)),n=r.map((e=>e.visible)),a=r.map((e=>e.opacity)),l=r.filter((e=>"definitionExpression"in e)).map((e=>e.definitionExpression)),u=i.filter((e=>"filter"in e)).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:o,layerVisibilities:n,layerOpacities:a,filters:u,definitionExpressions:l}}get renderer(){const{view:e}=this;if(null==e)return null;const t=e._stage;return null==t?null:t.renderer}start(){this.setRunning(!0)}stop(){this.setRunning(!1)}setRunning(e){this._running=e}async getDuration(e,t){const{view:i,renderer:s}=this;if(null==i||null==s)return 0;const r=i.state.camera.screenToRender(h(e.x,e.y),p()),o=s.readAccumulatedShadow(r),n=this._sampleCount;return 0===n?0:o*n*(this._duration/n)}};function L(e,t){null!=e&&null!=t&&e.setParameters({shadowCastOptions:t})}function q(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":case"integrated-mesh-3dtiles":return!0;case"base-dynamic-3d":case"dimension-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"media-3d":default:return!1;case"group":return e.layerViews.toArray().some((e=>q(e)))}}e([_()],B.prototype,"state",null),e([_()],B.prototype,"view",void 0),e([_()],B.prototype,"tooltip",void 0),e([_({nonNullable:!0})],B.prototype,"date",null),e([_({nonNullable:!0})],B.prototype,"utcOffset",null),e([_({nonNullable:!0})],B.prototype,"startTimeOfDay",void 0),e([_({nonNullable:!0})],B.prototype,"endTimeOfDay",void 0),e([_({nonNullable:!0})],B.prototype,"visualizationType",void 0),e([_({type:x,nonNullable:!0})],B.prototype,"thresholdOptions",void 0),e([_({type:V,nonNullable:!0})],B.prototype,"durationOptions",void 0),e([_({type:U,nonNullable:!0})],B.prototype,"discreteOptions",void 0),e([_()],B.prototype,"_running",void 0),e([_()],B.prototype,"_stopPreviewingTask",void 0),e([_()],B.prototype,"_forcePreview",void 0),e([_()],B.prototype,"_autoRestoreForcePreviewEnabled",void 0),e([_()],B.prototype,"_previewing",null),e([_()],B.prototype,"_utcOffset",void 0),e([_()],B.prototype,"_utcOffsetAuto",null),e([_()],B.prototype,"_dateUTCOffset",null),e([_()],B.prototype,"_startDateTimeUTC",null),e([_()],B.prototype,"_endDateTimeUTC",null),e([_()],B.prototype,"_referencePosition",null),e([_()],B.prototype,"_interval",null),e([_()],B.prototype,"_sampleCount",null),e([_()],B.prototype,"_duration",null),e([_()],B.prototype,"_lightDirections",null),e([_()],B.prototype,"_tooltipEnabled",null),e([_()],B.prototype,"_visualizationParameters",null),e([_()],B.prototype,"_thresholdVisualizationParameters",null),e([_()],B.prototype,"_durationVisualizationParameters",null),e([_()],B.prototype,"_discreteVisualizationParameters",null),e([_()],B.prototype,"_forcePreviewDependencies",null),e([_()],B.prototype,"renderer",null),B=e([f("esri.widgets.ShadowCast.ShadowCastViewModel")],B);const J=B;export{C as D,O as S,M as a,J as default};
