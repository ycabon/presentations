/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as s}from"../../chunks/tslib.es6.js";import"../../intl.js";import e from"../../core/Accessor.js";import r from"../../core/Error.js";import{L as t}from"../../chunks/Logger.js";import{watch as o,initial as i,on as n}from"../../core/reactiveUtils.js";import{property as a}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{U as m}from"../../chunks/UpdatingHandles.js";import l from"../../portal/Portal.js";import{h as c}from"../../chunks/utils20.js";import{createFeatureServices as u}from"../../rest/featureService/utils.js";import h from"../../versionManagement/VersionManagementService.js";import{o as d}from"../../chunks/locale.js";import{f as j}from"../../chunks/messages.js";import"../../chunks/date.js";import"../../chunks/jsonMap.js";import"../../config.js";import"../../chunks/timeZoneUtils.js";import"../../chunks/datetime.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../core/promiseUtils.js";import"../../chunks/maybe.js";import"../../chunks/assets.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/asyncUtils.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/ensureType.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/reader.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../portal/PortalGroup.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../chunks/arcgisLayerUrl.js";import"../../chunks/persistableUrlUtils.js";import"../../rest/featureService/FeatureService.js";import"../../core/Identifiable.js";import"../../chunks/applyEditsUtils.js";import"../../Graphic.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/coordsUtils.js";import"../../chunks/Axis.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec3f64.js";import"../../chunks/common.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../layers/support/fieldUtils.js";import"../../core/sql.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils4.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils5.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../geometry/projection.js";import"../../chunks/projectBuffer.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/editingSupport.js";import"../../chunks/uuid.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils7.js";import"../../chunks/utils8.js";import"../../chunks/EditBusLayer.js";import"../../chunks/infoFor3D.js";import"../../chunks/layerUtils2.js";import"../../chunks/editsZScale.js";import"../../chunks/jsonUtils2.js";let g=class extends e{constructor(s){super(s),this._currentVersionIdentifiers=new Map,this._hasAdvancedEditingUserTypeExtension=new Map,this._initialValidationsFinished=!1,this._portals=new Map,this._serverVersions=new Map,this._updatingHandles=new m,this._userForUrl=new Map,this._validConstructProperties=!0,this.executionError=null,this.featureServices=new Map,this.layers=null,this.loadError=null,this.serviceNames=new Map,this.userInfos=new Map,this.versionInfos=new Map,this.versionManagementServices=new Map}initialize(){const s=async()=>{this.messages=await j("esri/widgets/VersionManagement/t9n/VersionManagement")};s().then((()=>{this.addHandles([o((()=>this.layers),(async()=>{await this._onLayersChange()}),i),n((()=>this.layers),"change",(async()=>{await this._onLayersChange()})),d(s)])}))}destroy(){this._updatingHandles.destroy()}get state(){return this.loadError||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._initialValidationsFinished?"ready":"loading"}async alterVersion(s){if("disabled"===this.state)return void this._logError("execution-error",this.loadError);const{messages:{info:{noAdvancedEditingUserTypeExtension:e,notValidEnterpriseVersion:r}}}=this,t=this.versionManagementServices.get(s.featureServerUrl);if(!t)return void this._logNoVersionManagementServiceFoundError();if(!this._serverVersions.has(s.featureServerUrl)||this._serverVersions.get(s.featureServerUrl)<=11.1)return void this._logError("execution-error",r);if(!this._hasAdvancedEditingUserTypeExtension.get(s.featureServerUrl))return void this._logError("execution-error",e);const o=Object.assign({},s.versionIdentifier),i={...s};delete i.featureServerUrl,delete i.versionIdentifier,this._setExecutionError(),await this._updatingHandles.addPromise(t.alterVersion(o,i).catch((s=>{this._logExecutionError(s)}))),"failed"!==this.state&&await this._updatingHandles.addPromise(this.getVersionInfos(s.featureServerUrl,!0)).catch((s=>{this._logExecutionError(s)}))}async changeVersion(s,e,r){if("disabled"===this.state)return void this._logError("execution-error",this.loadError);const t=this.versionManagementServices.get(s);if(!t)return void this._logNoVersionManagementServiceFoundError();const o=this._currentVersionIdentifiers.get(s)??{name:t.defaultVersionIdentifier.name,guid:t.defaultVersionIdentifier.guid},i={name:e,guid:r};this._setExecutionError(),await this._updatingHandles.addPromise(t.changeVersion(this.featureServices.get(s)?.layers,o,i)).catch((s=>{this._logExecutionError(s)}))&&this._currentVersionIdentifiers.set(s,i)}async createVersion(s){if("disabled"===this.state)return void this._logError("execution-error",this.loadError);const e=s.featureServerUrl,r=this.versionManagementServices.get(e);if(!r)return void this._logNoVersionManagementServiceFoundError();this._setExecutionError();const t=await this._updatingHandles.addPromise(r.createVersion({versionName:s.versionName,access:s.access,description:s.description}));if(s.versionOwner&&s.versionOwner!==this._userForUrl.get(e)){const r={featureServerUrl:e,versionIdentifier:{guid:t.versionIdentifier.guid,name:t.versionIdentifier.name},ownerName:s.versionOwner??this._userForUrl.get(e)};await this._updatingHandles.addPromise(this.alterVersion(r))}"failed"!==this.state&&await this._updatingHandles.addPromise(this.getVersionInfos(e,!0))}async deleteVersion(s,e,r){if("disabled"===this.state)return void this._logError("execution-error",this.loadError);const t=this.versionManagementServices.get(s);if(!t)return void this._logNoVersionManagementServiceFoundError();const o={name:e,guid:r};this._setExecutionError(),await this._updatingHandles.addPromise(t.deleteVersion(o)).catch((s=>{this._logExecutionError(s)}))&&await this.getVersionInfos(s,!0)}async getVersionInfos(s,e){if("disabled"===this.state)return void this._logError("execution-error",this.loadError);const{messages:{info:{noFeatureServiceFound:r}}}=this,t=this.featureServices.get(s)?.featureService;if(!t)return void this._logError("execution-error",r);if(this._setExecutionError(),!t.loaded){await this._updatingHandles.addPromise(t.load()).catch((s=>{this._logExecutionError(s)}));const e=t.url;this._serverVersions.set(e,t.sourceJSON?.currentVersion??0),this._serverVersions.get(e)<=11.1&&this._hasAdvancedEditingUserTypeExtension.set(e,!1),this._portals.get(s)&&this._userForUrl.get(s)?this._hasAdvancedEditingUserTypeExtension.set(e,await c(this._portals.get(s),this._userForUrl.get(s),"advediting")):this._hasAdvancedEditingUserTypeExtension.set(e,!1)}t.versionManagementServiceUrl&&this.versionManagementServices.set(t.url,new h({url:t.versionManagementServiceUrl}));const o=this.versionManagementServices.get(s);if(o){if(o.loaded||await this._updatingHandles.addPromise(o.load()).catch((s=>{this._logExecutionError(s)})),!this.versionInfos.get(s)||e){const e=await this._updatingHandles.addPromise(o.getVersionInfos()).catch((s=>{this._logExecutionError(s)}));this.versionInfos.set(s,e),this._currentVersionIdentifiers.set(s,o.defaultVersionIdentifier)}return this.versionInfos.get(s)}this._logNoVersionManagementServiceFoundError()}_logError(s,e,o){"missing-property"!==s&&"no-feature-services"!==s||this._setLoadError(e),"execution-error"===s&&this._setExecutionError(e),t.getLogger(this).error(new r(s,e,o))}_logExecutionError(s){s instanceof r?this._logError("execution-error",s.message,s.details):this._logError("execution-error",`Error: ${s}`)}_logNoVersionManagementServiceFoundError(){this._logError("execution-error",this.messages.info.noVersionManagementServiceFound)}_setExecutionError(s){this._set("executionError",s)}_setLoadError(s){this._set("loadError",s)}async _onLayersChange(){const{messages:{info:{noFeatureServices:s,noLayersProperty:e}}}=this;if(this._initialValidationsFinished=!1,this._setLoadError(),this._validConstructProperties=!0,!this.layers)return this._logError("missing-property",e),void(this._validConstructProperties=!1);if(this.featureServices=u(this.layers),!this.featureServices.size)return this._logError("no-feature-services",s),void(this._validConstructProperties=!1);for(const s of this.featureServices.keys())if(!this.serviceNames.has(s)){this.serviceNames.set(s,s.split("/").at(-2));const e=new l({authMode:"immediate",url:new URL(s).origin+"/portal"});await e.load(),this._portals.set(s,e);const r=e?.user?.username;r&&this._userForUrl.set(s,r)}this._initialValidationsFinished=!0}};s([a()],g.prototype,"_initialValidationsFinished",void 0),s([a({readOnly:!0})],g.prototype,"executionError",void 0),s([a()],g.prototype,"featureServices",void 0),s([a()],g.prototype,"layers",void 0),s([a()],g.prototype,"loadError",void 0),s([a()],g.prototype,"messages",void 0),s([a()],g.prototype,"serviceNames",void 0),s([a({readOnly:!0})],g.prototype,"state",null),s([a()],g.prototype,"userInfos",void 0),s([a()],g.prototype,"versionInfos",void 0),s([a()],g.prototype,"versionManagementServices",void 0),g=s([p("esri.widgets.VersionManagement.VersionManagementViewModel")],g);const y=g;export{y as default};
