/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import{L as t}from"../../chunks/Logger.js";import{watch as s,sync as a}from"../../core/reactiveUtils.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import r from"../Widget.js";import n from"../../core/Error.js";import{g as l,f as d}from"../../chunks/date.js";import{a as h,g as c}from"../../chunks/locale.js";import u from"./DatePickerViewModel.js";import{g as p}from"../../chunks/globalCss.js";import{l as m}from"../../chunks/legacyIcon.js";import{P as _}from"../../chunks/Popover.js";import{a as y}from"../../chunks/accessibleHandler.js";import{m as v}from"../../chunks/messageBundle.js";import{t as k}from"../../chunks/jsxFactory.js";import{s as g,i as f,a as w}from"../../chunks/widgetUtils.js";import{D,a as b,b as j}from"../../chunks/datetime.js";import"../../config.js";import"../../chunks/messages.js";import"../../chunks/handleUtils.js";import"../../core/promiseUtils.js";import"../../chunks/maybe.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/metadata.js";import"../../chunks/utils.js";import"../../chunks/ObservableBase.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/ensureType.js";import"../../chunks/assets.js";import"../../chunks/asyncUtils.js";import"../../core/Collection.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/domUtils.js";import"../../core/Promise.js";import"../../chunks/uuid.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/projector.js";import"../../chunks/jsxWidgetSupport.js";import"../../chunks/jsonMap.js";import"../../chunks/timeZoneUtils.js";import"./DateTimeElementViewModel.js";function P(e){const t=[/٠/g,/١/g,/٢/g,/٣/g,/٤/g,/٥/g,/٦/g,/٧/g,/٨/g,/٩/g];for(let s=0;s<10;s++)e=e.replace(t[s],s.toString());return Number(e)}function M(e){return new n(`could not parse date input, expecting the following format: ${d(Date.now(),e)}`)}const O={ar:6,"ar-dz":6,"ar-kw":6,"ar-ly":6,"ar-ma":1,"ar-sa":7,"ar-tn":1,bg:1,bs:1,ca:1,cs:1,da:1,de:1,"de-at":1,"de-ch":1,el:1,"en-au":1,"en-ca":7,"en-gb":1,"en-ie":1,"en-il":7,"en-in":7,"en-nz":1,"en-sg":7,es:1,"es-do":7,"es-mx":7,"es-us":7,et:1,fi:1,fr:1,"fr-ca":7,"fr-ch":1,he:7,hr:1,hu:1,id:7,it:1,"it-ch":1,ja:7,ko:7,lt:1,lv:1,nb:1,nl:1,"nl-be":1,pl:1,pt:7,"pt-br":7,ro:1,ru:1,sk:1,sl:1,sr:1,"sr-cyrl":1,sv:1,th:7,tr:1,uk:1,vi:1,"zh-cn":1,"zh-hk":7,"zh-mo":7,"zh-tw":7},I="Locale"in Intl&&"weekInfo"in Intl.Locale.prototype;function x(e){if(e=e.toLowerCase(),O[e])return O[e];if(I)try{const t=new Intl.Locale(e).weekInfo.firstDay;return O[e]=t,t}catch{}const t=h(e);return O[t]?O[t]:7}const N="esri-date-picker",$={base:N,datePicker:`${N}__calendar`,monthPicker:`${N}__month-picker`,dayPicker:`${N}__day-picker`,week:`${N}__week-item`,nearbyMonth:`${N}__day-item--nearby-month`,activeDay:`${N}__day-item--active`,today:`${N}__day-item--today`,selectedDay:`${N}__day-item--selected`,day:`${N}__day-item`,dayHeader:`${N}__day-item--header`,yearPicker:`${N}__year-picker`,selectedYear:`${N}__year-picker-item--selected`,year:`${N}__year-picker-item`,monthDropdown:`${N}__month-dropdown`,date:`${N}__date`,datePickerToggle:`${N}__calendar-toggle`,dateInput:`${N}__input`,dateTextInput:`${N}__text-input`,leadingIcon:`${N}__icon--leading`},C=new Set([" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"]);let S=class extends r{constructor(e,t){super(e,t),this._calendarNode=null,this._inputOrButtonNode=null,this._rootNode=null,this._requestDayPickerFocusOnCreate=!1,this._activeDate=null,this._calendarPopover=new _({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._isOpen=!1,this.dateInputEnabled=!1,this.messages=null,this.commitOnMonthChange=!1,this.viewModel=new u,this.disabled=!1,this.timeZone=void 0,this.toggle=this.toggle.bind(this)}initialize(){this.addHandles(s((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{!this.destroyed&&e&&null!=this.onChange&&this.onChange(t)}),a))}destroy(){this._calendarPopover.destroy()}get _dateTimeFormatOptions(){return{year:"numeric",month:"2-digit",day:"2-digit",timeZone:this.timeZone||void 0}}get value(){return this.viewModel.value}set value(e){this.viewModel.value=e}get isOpen(){return this._isOpen}render(){return k("div",{afterCreate:g,bind:this,class:this.classes($.base,p.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this._renderInputAndButtonMode():this._renderButtonOnlyMode())}toggle(){this._isOpen?this.close():this.open()}open(e=!0){this._activeDate=D.fromJSDate(this.viewModel.value),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=e}close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,e&&this._inputOrButtonNode?.focus()}_renderButtonOnlyMode(){const e=d(this.viewModel.value,this._dateTimeFormatOptions),{disabled:t,_isOpen:s,messages:a}=this;return k("div",{afterCreate:g,"aria-controls":s?this._getCalendarId():null,"aria-expanded":s.toString(),"aria-haspopup":"true","aria-label":a.setDate,"aria-pressed":s.toString(),bind:this,class:this.classes(p.widgetButton,p.select,$.datePickerToggle),"data-node-ref":"_inputOrButtonNode",key:`date-button-${t}`,onclick:this.toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?void 0:0},k("span",{class:$.date},e))}_renderInputAndButtonMode(){const e=d(this.viewModel.value,this._dateTimeFormatOptions),{_isOpen:t,messages:s}=this;return k("div",{class:this.classes($.dateInput)},k("input",{afterCreate:g,"aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":s.setDate,bind:this,class:this.classes($.dateTextInput,p.input),"data-node-ref":"_inputOrButtonNode",key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),k("span",{"aria-hidden":"true",class:this.classes($.leadingIcon,m.calendar)}))}_handleDateInputClick(){this.open(!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this.close():"ArrowDown"===t&&(this.open(),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:s}=e;this._isOpen&&"Tab"===t&&s?this.close():f(t)&&this.toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const s=e.currentTarget;let a;try{a=function(e,t){const s=l(t),a=Date.now(),i=s.formatToParts(a),o=new Set;i.filter((({type:e})=>"literal"===e)).forEach((({value:e})=>o.add(e)));let r=0;const n={};for(;i.length>0;){const{type:t,value:s}=i.shift();for(let a=0;a<s.length;a++,r++){const s=e.charAt(r);if(o.has(s)){r++;break}if("literal"===t)break;n[t]||(n[t]=[]),n[t].push(s)}}const d={};try{d.day=P(n.day.join("")),d.month=P(n.month.join("")),d.year=P((n.year||n.relatedYear).join(""))}catch(e){throw M(t)}if(isNaN(d.day)||isNaN(d.month)||isNaN(d.year))throw M(t);return d}(s.value,this._dateTimeFormatOptions)}catch(e){return t.getLogger(this).warn(e),void(s.value=d(this.viewModel.value,this._dateTimeFormatOptions))}const i=D.fromObject(a);i.isValid?(this.viewModel.value=i.toJSDate(),this._activeDate=i):s.value=d(this.viewModel.value,this._dateTimeFormatOptions)}_handleDatePickerKeydown(e){const{key:t}=e;"Escape"===t&&(this.close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate;if(!e)return null;const t=D.fromJSDate(this.viewModel.value);return k("div",{afterCreate:g,bind:this,class:this.classes($.datePicker,p.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",onfocusout:this._onCalendarFocusOut,onkeydown:this._handleDatePickerKeydown,tabIndex:-1},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_onCalendarFocusOut(e){const t=e.relatedTarget;t&&t instanceof Node&&(this._calendarNode?.contains(t)||this._rootNode?.contains(t))||this.close(!1)}_renderMonthPicker(e){const t=w(this.container),s=t?m.right:m.left,a=t?m.left:m.right,i=b.months("long",{locale:c()}).map(((t,s)=>{const a=e.month-1===s;return k("option",{selected:a,value:s.toString()},t)})),{disabled:o,messages:r}=this;return k("div",{class:$.monthPicker},k("div",{"aria-label":r.goToPreviousMonth,bind:this,class:p.button,key:`previous-month-${o}`,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:o?void 0:0,title:r.goToPreviousMonth},k("span",{"aria-hidden":"true",class:s})),k("select",{"aria-label":r.selectMonth,"aria-live":"assertive",bind:this,class:this.classes($.monthDropdown,p.select),disabled:o,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:r.selectMonth},i),k("div",{"aria-label":r.goToNextMonth,bind:this,class:p.button,key:`next-month-${o}`,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:o?void 0:0,title:r.goToNextMonth},k("span",{"aria-hidden":"true",class:a})))}_renderDayPicker(e,t){const s=this._getWeekLabels(),a=this._getDayId(e),i=this._renderMonth(e,t),{id:o,disabled:r}=this;return k("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":a,"aria-labelledby":`${o}__month-picker ${o}__selected-year`,bind:this,class:$.dayPicker,id:`${o}__day-picker`,key:`day-picker-${r}`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:r?void 0:0},k("div",{class:$.week,role:"row"},s.map((e=>k("div",{"aria-label":e.name,class:this.classes($.day,$.dayHeader),role:"columnheader",title:e.name},e.abbr)))),i)}_getDayId(e){return`${this.id}__${d(e.valueOf(),this._dateTimeFormatOptions)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(){const e=[],t={weekday:"long"},s={weekday:"narrow"};let a=D.now().set({weekday:x(c())});for(let i=0;i<7;i++)e.push({name:d(a.valueOf(),t),abbr:d(a.valueOf(),s)}),a=a.plus({day:1});return e}_handleDayPickerKeydown(e){const{key:t,ctrlKey:s,shiftKey:a}=e;if(!C.has(t))return;let i=this._activeDate;if(i){if("ArrowLeft"===t)i=i.minus({day:1});else if("ArrowRight"===t)i=i.plus({day:1});else if("ArrowUp"===t)i=i.minus({week:1});else if("ArrowDown"===t)i=i.plus({week:1});else if("PageUp"===t){const e=a?"year":"month";i=i.minus({[e]:1})}else if("PageDown"===t){const e=a?"year":"month";i=i.plus({[e]:1})}else if("Home"===t){const e=s?"year":"month";i=i.startOf(e)}else if("End"===t){const e=s?"year":"month";i=i.endOf(e)}else f(t)&&(this.viewModel.value=i.toJSDate(),this.close());this._activeDate=i,e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const s=D.now(),a=e.startOf("month"),i=e.endOf("month");var o,r;let n=a.minus({day:(o=c(),r=a.weekday,(r+7-x(o))%7)});const l=[];for(let o=0;o<6;o++){const o=[];for(let r=0;r<7;r++){const r=n.day,l=n.hasSame(e,"day"),d=n.hasSame(t,"day"),h=this._getDayId(n),c=j.fromDateTimes(a,i),u={[$.nearbyMonth]:!c.contains(n),[$.today]:n.hasSame(s,"day"),[$.activeDay]:l,[$.selectedDay]:d};o.push(k("div",{"aria-label":r.toString(),"aria-selected":l.toString(),bind:this,class:this.classes($.day,u),"data-iso-date":n.toISO(),id:h,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},r)),n=n.plus({day:1})}l.push(k("div",{class:$.week,role:"row"},o))}return l}_renderYearPicker(e){const t={year:"numeric"},s=e,a=d(s.valueOf(),t),i=d(s.plus({year:1}).valueOf(),t),o=d(s.minus({year:1}).valueOf(),t),{disabled:r,messages:n}=this;return k("div",{class:$.yearPicker},k("div",{"aria-label":n.goToPreviousYear,bind:this,class:$.year,key:`previous-year-${r}`,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:r?void 0:0,title:n.goToPreviousYear},o),k("div",{class:this.classes($.year,$.selectedYear),id:`${this.id}__selected-year`},a),k("div",{"aria-label":n.goToNextYear,bind:this,class:$.year,key:`next-year-${r}`,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:r?void 0:0,title:n.goToNextYear},i))}_setMonth(e){const t=e.target,s=Number(t.value)+1;this._activeDate&&(this._activeDate=this._activeDate.set({month:s}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousMonth(){this._activeDate&&(this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this.close();f(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate&&(this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousYear(){this._activeDate=this._activeDate?.minus({year:1})??null}_setNextYear(){this._activeDate=this._activeDate?.plus({year:1})??null}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this.close();f(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=D.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this.close()}};e([i()],S.prototype,"_activeDate",void 0),e([i()],S.prototype,"_calendarPopover",void 0),e([i()],S.prototype,"_isOpen",void 0),e([i()],S.prototype,"_dateTimeFormatOptions",null),e([i()],S.prototype,"dateInputEnabled",void 0),e([i(),v("esri/widgets/support/t9n/DatePicker")],S.prototype,"messages",void 0),e([i()],S.prototype,"value",null),e([i()],S.prototype,"commitOnMonthChange",void 0),e([i({type:u})],S.prototype,"viewModel",void 0),e([i()],S.prototype,"onChange",void 0),e([i()],S.prototype,"disabled",void 0),e([i()],S.prototype,"timeZone",void 0),e([i()],S.prototype,"isOpen",null),e([y()],S.prototype,"_setNextMonth",null),e([y()],S.prototype,"_setPreviousYear",null),e([y()],S.prototype,"_handleSelectedDate",null),S=e([o("esri.widgets.support.DatePicker")],S);const T=S;export{T as default};
