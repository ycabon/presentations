/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import o,{d as s}from"../../../core/Accessor.js";import e from"../../../core/Evented.js";import{m as r,h as i}from"../../../chunks/handleUtils.js";import{L as n}from"../../../chunks/Logger.js";import{d as p,r as a}from"../../../chunks/maybe.js";import{watch as l}from"../../../core/reactiveUtils.js";import{property as c}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import{subclass as m}from"../../../core/accessorSupport/decorators/subclass.js";import{b as u,c as h}from"../../../chunks/layerUtils2.js";import{f as d}from"../../../chunks/layerUtils.js";import{i as y}from"../../../chunks/layerViewUtils.js";import"../../../geometry.js";import{c as j}from"../../../chunks/asyncUtils.js";import g from"../../../core/Collection.js";import{debounce as k,ignoreAbortErrors as b,onAbort as v}from"../../../core/promiseUtils.js";import{c as f}from"../../../chunks/screenUtils.js";import{i as S}from"../../../chunks/coordsUtils.js";import{I as w}from"../../../chunks/mat2df64.js";import{D as _,b as O}from"../../../chunks/drawSurfaces.js";import{c as U,a as D,b as T,d as C}from"../../../chunks/createUtils.js";import{A as M}from"../../../chunks/surfaceCoordinateSystems.js";import{I as x}from"../../../chunks/InteractiveToolBase.js";import{n as I,q as P,i as L,c as A,w as E,o as V}from"../../../chunks/aaBoundingRect.js";import"../../../chunks/widgetUtils.js";import{t as R}from"../../../chunks/jsxFactory.js";import{s as F}from"../../../chunks/keybindings.js";import{getSelectionFromGeometry as H}from"../Selector2D/selectorUtils.js";import $ from"../../../geometry/Point.js";import z from"../../../geometry/Polygon.js";import"../../../core/Handles.js";import"../../../chunks/metadata.js";import"../../../chunks/utils.js";import"../../../chunks/ObservableBase.js";import"../../../chunks/tracking.js";import"../../../core/scheduling.js";import"../../../config.js";import"../../../chunks/ensureType.js";import"../../../core/Error.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../core/JSONSupport.js";import"../../../request.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../chunks/reader.js";import"../../../geometry/SpatialReference.js";import"../../../chunks/unitUtils.js";import"../../../chunks/jsonMap.js";import"../../../chunks/assets.js";import"../../../chunks/writer.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/extentUtils.js";import"../../../chunks/mathUtils.js";import"../../../chunks/vec3.js";import"../../../chunks/vec3f64.js";import"../../../chunks/common.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/Axis.js";import"../../../chunks/diffUtils.js";import"../../../chunks/UpdatingHandles.js";import"../../../chunks/dehydratedFeatureComparison.js";import"../../../chunks/elevationInfoUtils.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/ViewingMode.js";import"../../../chunks/EditGeometryOperations.js";import"../../../chunks/vec2.js";import"../../../chunks/vec2f64.js";import"../../../chunks/vec4.js";import"../../../chunks/vec4f64.js";import"../../../chunks/plane.js";import"../../../chunks/mat3f64.js";import"../../../chunks/mat4f64.js";import"../../../chunks/quatf64.js";import"../../../chunks/mathUtils2.js";import"../../../chunks/geometry2dUtils.js";import"../../../chunks/snappingUtils.js";import"../../../chunks/geodesicConstants.js";import"../../../geometry/support/geodesicUtils.js";import"../../../chunks/sphere.js";import"../../../chunks/mat4.js";import"../../../chunks/normalizedPoint.js";import"../../../chunks/dehydratedPoint.js";import"../../../core/sql.js";import"../../../chunks/timeUtils.js";import"../../../chunks/date.js";import"../../../chunks/locale.js";import"../../../chunks/timeZoneUtils.js";import"../../../chunks/datetime.js";import"../../../rest/support/Query.js";import"../../../TimeExtent.js";import"../../../chunks/enumeration.js";import"../../../chunks/DataLayerSource.js";import"../../../layers/support/Field.js";import"../../../chunks/domains.js";import"../../../layers/support/CodedValueDomain.js";import"../../../layers/support/Domain.js";import"../../../layers/support/InheritedDomain.js";import"../../../layers/support/RangeDomain.js";import"../../../chunks/fieldType.js";import"../../../chunks/FullTextSearch.js";import"../../../core/Clonable.js";import"../../../chunks/spatialRelationships.js";import"../../../rest/support/StatisticDefinition.js";import"../../../chunks/InputManager.js";import"../../../chunks/Queue.js";import"../../../chunks/PropertiesPool.js";import"../../../core/signal.js";import"../../../views/interactive/sketch/SketchLabelOptions.js";import"../../../chunks/SnappingContext.js";import"../../../chunks/SnappingDragPipelineStep.js";import"../../../chunks/hydratedFeatures.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../layers/support/fieldUtils.js";import"../../../intl.js";import"../../../chunks/messages.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../Color.js";import"../../../chunks/colorUtils.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../symbols.js";import"../../../symbols/CIMSymbol.js";import"../../../symbols/Symbol.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils4.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/SimpleLineSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils5.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../chunks/persistableUrlUtils.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../portal/PortalGroup.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/SimpleFillSymbol.js";import"../../../symbols/SimpleMarkerSymbol.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/Scheduler.js";import"../../../chunks/debugFlags.js";import"../../../chunks/RenderState.js";import"../../../chunks/SnappingOperation.js";import"../../../chunks/quantityUtils.js";import"../../../chunks/projectVectorToVector.js";import"../../../chunks/projectBuffer.js";import"../../../chunks/projectPointToVector.js";import"../../../geometry/projection.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";import"../../../chunks/angularMeasurementUtils.js";import"../../../chunks/Cyclical.js";import"../../../geometry/Circle.js";import"../../../geometry/geometryEngine.js";import"../../../chunks/geometryEngineBase.js";import"../../../chunks/_commonjsHelpers.js";import"../../../chunks/hydrated.js";import"../../../chunks/mat2d.js";import"../../../chunks/quat.js";import"../../../chunks/meshVertexSpaceUtils.js";import"../../../geometry/support/MeshGeoreferencedVertexSpace.js";import"../../../chunks/vec32.js";import"../../../chunks/interfaces.js";import"../../../chunks/drawUtils.js";import"../../../chunks/interfaces2.js";import"../../../chunks/jsxWidgetSupport.js";import"../../../chunks/drapedUtils.js";let B=class extends o{constructor(t){super(t),this.coordinates=void 0,this.strokeDash=[],this.strokeWidth=1,this.strokeColor=[0,0,0,1],this.strokeDashColor=[255,255,255,1],this.fillColor=[0,0,0,0],this.visible=!0,this.isDecoration=!0}get _strokeStyle(){const t=this.strokeColor;return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`}get _strokeBackgroundStyle(){const t=this.strokeDashColor;return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`}get _fillStyle(){const t=this.fillColor;return`rgba(${t[0]}, ${t[1]}, ${t[2]}, ${t[3]})`}get _renderCoordinates(){const t=[];if(!this.coordinates)return{coordinates:t,rect:I};const o=P(L(A(I),this.coordinates),2*this.strokeWidth);o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o[2]=Math.ceil(o[2]+.5),o[3]=Math.ceil(o[3]+.5);for(const s of this.coordinates)t.push([Math.floor(s[0]-o[0])+.5,Math.floor(s[1]-o[1])+.5]);return t.reverse(),{coordinates:t,rect:o}}render(){const{coordinates:t,rect:o}=this._renderCoordinates,s=E(o),e=V(o);return R("div",{classes:{"esri-outline-overlay-item":!0},styles:{left:o[0]+"px",top:o[1]+"px",width:s+"px",height:e+"px",visibility:this.visible?"visible":"hidden"}},R("svg",{height:e,styles:{display:"block"},width:s},R("polygon",{fill:this._fillStyle,points:t.map((([t,o])=>`${t},${o}`)).join(" "),stroke:this._strokeBackgroundStyle,"stroke-width":this.strokeWidth}),R("polygon",{fill:"transparent",points:t.map((([t,o])=>`${t},${o}`)).join(" "),stroke:this._strokeStyle,"stroke-dasharray":this.strokeDash.length?this.strokeDash.join(" "):void 0,"stroke-width":this.strokeWidth})))}renderCanvas(){}};t([c()],B.prototype,"coordinates",void 0),t([c()],B.prototype,"strokeDash",void 0),t([c()],B.prototype,"strokeWidth",void 0),t([c()],B.prototype,"strokeColor",void 0),t([c()],B.prototype,"strokeDashColor",void 0),t([c()],B.prototype,"fillColor",void 0),t([c()],B.prototype,"visible",void 0),t([c()],B.prototype,"isDecoration",void 0),t([c({readOnly:!0})],B.prototype,"_strokeStyle",null),t([c({readOnly:!0})],B.prototype,"_strokeBackgroundStyle",null),t([c({readOnly:!0})],B.prototype,"_fillStyle",null),t([c({readOnly:!0})],B.prototype,"_renderCoordinates",null),B=t([m("esri.views.overlay.OutlineOverlayItem")],B);const G=B;let W=class extends(e.EventedMixin(x)){constructor(t){super(t),this._overlayItem=void 0,this.geometryType=null,this.mode=null,this.type="draw-screen"}initialize(){this.drawOperation=this._makeDrawOperation();const t=t=>this.drawOperation.on(t,(o=>{this._updateVisuals(),this.emit(t,o)}));this.addHandles([t("vertex-add"),t("vertex-remove"),t("vertex-update"),t("cursor-update"),t("complete")]),this.finishToolCreation()}destroy(){this.drawOperation=p(this.drawOperation),this._set("view",null)}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centeredToggled(t){this._set("centeredToggled",t),this._updateVisuals()}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set uniformSizeToggled(t){this._set("uniformSizeToggled",t),this._updateVisuals()}get updating(){return this.drawOperation?.updating??!1}get cursor(){return"point"===this.geometryType?"default":"crosshair"}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.destroyed||this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}undo(){this.drawOperation.undo()}reset(){}_makeDrawOperation(){const{view:t}=this;return new _({view:t,manipulators:this.manipulators,geometryType:q(this.geometryType),drawingMode:this.mode,hasZ:!1,defaultZ:0,snapToSceneEnabled:!1,drawSurface:new O,hasM:!1,snappingManager:null,snappingVisualizer:null,graphic:null,cursor:this.cursor})}get coordinates(){const{drawOperation:t}=this;if(!t?.geometryIncludingUncommittedVertices.length)return[];const{coordinateHelper:o}=t,s=t.committableVertex,e=t.committedVertices.slice();null!=s&&e.push(o.pointToArray(s));const r=e.length;switch(this.geometryType){case"circle":case"rectangle":{const o=new M(w,O.spatialReference),s="circle"===this.geometryType?U:D,i="circle"===this.geometryType?T:C;if(1===r&&t.isCompleted){const t=e[0],r=o.makeMapPoint(t[0]+Q,t[1]);return s([t,r],o,!0)?.geometry.rings[0]??[]}if(2===r){const t="rectangle"!==this.geometryType,r=this.centeredToggled!==t,n="rectangle"!==this.geometryType;return(this.uniformSizeToggled!==n?s(e,o,r)?.geometry.rings[0]:i(e,o,r)?.geometry.rings[0])??[]}return[]}}return e}_updateVisuals(){if(!this._overlayItem){const t=new G({strokeDash:[5],strokeDashColor:[255,255,255,255]});this.view.overlay?.addItem(t),this.addHandles(r((()=>{this.view.overlay?.removeItem(t),t?.destroy(),this._overlayItem=void 0}))),this._overlayItem=t}this._overlayItem.coordinates=this.coordinates}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}};function q(t){switch(t){case"polygon":case"point":return t;case"circle":case"rectangle":return"segment"}}t([c({value:!1})],W.prototype,"centeredToggled",null),t([c()],W.prototype,"drawOperation",void 0),t([c({value:!0})],W.prototype,"enabled",null),t([c({value:!1})],W.prototype,"uniformSizeToggled",null),t([c({constructOnly:!0})],W.prototype,"geometryType",void 0),t([c({constructOnly:!0})],W.prototype,"mode",void 0),t([c({readOnly:!0})],W.prototype,"type",void 0),t([c({readOnly:!0})],W.prototype,"updating",null),t([c({constructOnly:!0,nonNullable:!0})],W.prototype,"view",void 0),t([c()],W.prototype,"cursor",null),W=t([m("esri.views.draw.DrawScreenTool")],W);const Q=48;let Z=class extends e.EventedAccessor{constructor(t){super(t),this._processTask=null,this.options=null,this.selection=new g,this.sources=null,this._process=k((async(t,o)=>{const{callback:s,selector:e,completed:r}=t,i=j((async t=>{const{sources:o,selection:i,view:n}=this;if((o?.length||n?.selectionManager.sources.length)&&n){if(e&&null!=o){const s=await H({currentSelection:i,sources:o,selector:e,signal:t,view:n});r&&n.selectionManager?.updateSelection({current:i.toArray(),...s})}s&&s()}else i.removeAll()}));return v(o,(()=>i.abort())),this._processTask=i,i.promise}),100)}initialize(){this._setup()}cancel(){this.removeAllHandles(),this._processTask?.abort()}async _setup(){const{view:t}=this;if(await t.whenReady(),this.destroyed)return;const o=this.options?.createTool??"rectangle",s=this.options?.mode??("polygon"===o?"click":"hybrid");this._tool=new W({view:t,mode:s,geometryType:o}),this.addHandles([this.view.on("key-down",(t=>{if(!t.repeat)switch(t.key){case F.constraint:this._tool.uniformSizeToggled=!0,t.stopPropagation();break;case F.center:this._tool.centeredToggled=!0,t.stopPropagation()}})),this.view.on("key-up",(t=>{switch(t.key){case F.constraint:this._tool.uniformSizeToggled=!1,t.stopPropagation();break;case F.center:this._tool.centeredToggled=!1,t.stopPropagation()}})),this._tool.on(["cursor-update","vertex-add","vertex-remove"],(()=>b(this._process({selector:this._selectionArea})))),this._tool.on("complete",(async t=>{const o=()=>{this.removeAllHandles(),this.emit("complete",{aborted:t.aborted,selection:this.selection.toArray()})};t.aborted?(this._processTask?.abort(),this.selection.removeAll(),o()):await this._process({selector:this._selectionArea,callback:o,completed:!0})}))]),this.addHandles(r((()=>this.view.tools.remove(this._tool)))),this.view.addAndActivateTool(this._tool)}get _selectionArea(){const t=f(),o=this._tool.coordinates,s=this.view.spatialReference,e=o=>{t.x=o[0],t.y=o[1];const{x:s,y:e}=this.view.toMap(t);return[s,e]};if(1===o.length){const[t,r]=e(o[0]);return new $({x:t,y:r,spatialReference:s})}const r=this._tool.coordinates.map(e);if(0!==r.length)return S(r)||r.reverse(),new z({spatialReference:s,rings:[r]})}};t([c()],Z.prototype,"options",void 0),t([c({readOnly:!0})],Z.prototype,"selection",void 0),t([c()],Z.prototype,"sources",void 0),t([c({constructOnly:!0})],Z.prototype,"view",void 0),Z=t([m("esri.widgets.support.Selector2D.SelectionOperation2D")],Z);const N=Z;let J=class extends e.EventedAccessor{constructor(t){super(t),this._operationHandlesGroup=null,this.activeOperation=null,this.sources=null}initialize(){this.addHandles([l((()=>this._sources),(t=>{this.activeOperation&&(this.activeOperation.sources=t)}))])}destroy(){this._operationHandlesGroup=a(this._operationHandlesGroup)}get _sources(){const{sources:t,view:o}=this;return o&&t?.length?t.flatMap((t=>{if(y(t))return t;if(u(t)||h(t)){const s=t.layers||[],e=s.map((t=>{const s=d(o,t)||void 0;return y(s)?s:t}));return e.length?e.toArray():s.length?s.toArray():t}const s=d(o,t)||void 0;return y(s)?s:t})):[]}get layers(){return s(n.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources}set layers(t){s(n.getLogger(this),"layers",{replacement:"Use SelectionToolbar.sources instead."}),this.sources=t}get state(){const{_sources:t,view:o}=this,s=!t?.length&&!o?.selectionManager.sources.length;return this.activeOperation?"active":o?.ready&&!s?"ready":"disabled"}cancel(){"active"===this.state&&(this.activeOperation?.cancel(),this._set("activeOperation",null))}activate(t){const{_sources:o,state:s,view:e}=this,r=!o?.length&&!e?.selectionManager.sources.length;if("disabled"===s||r||!this.view)return;"active"===s&&this.cancel();const n=new N({view:this.view,sources:o,options:t});return this._operationHandlesGroup=i([n.selection.on("change",(t=>this.emit("selection-change",t))),n.once("complete",(t=>this._onOperationComplete(t)))]),this._set("activeOperation",n),n}_onOperationComplete(t){this._operationHandlesGroup=a(this._operationHandlesGroup),this._set("activeOperation",null),this.emit("complete",t)}};t([c()],J.prototype,"_sources",null),t([c({readOnly:!0})],J.prototype,"activeOperation",void 0),t([c()],J.prototype,"layers",null),t([c()],J.prototype,"sources",void 0),t([c({readOnly:!0})],J.prototype,"state",null),t([c()],J.prototype,"view",void 0),J=t([m("esri.widgets.support.SelectionToolbar.SelectionToolbarViewModel")],J);const K=J;export{K as default};
