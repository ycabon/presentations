// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("./cache ./errorsupport ./FeatureSetIterator ./IdSet ./shared ./stats ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/geometryEngineAsync ../../../geometry/SpatialReference ../../../layers/support/FieldsIndex".split(" "),function(r,m,w,u,l,p,v,q,t,x,y){class h{constructor(a){this.featureSetQueryInterceptor=this.recentlyUsedQueries=null;this._idstates=[];this._mainSetInUse=this._wset=this._parent=null;this._maxProcessing=200;this._maxQuery=500;this._totalCount=-1;
this._databaseType=l.FeatureServiceDatabaseType.NotEvaluated;this._databaseTypeProbed=null;this.declaredRootClass="esri.arcade.featureset.support.FeatureSet";this._featureCache=[];this.fields=this.types=this.typeIdField=null;this.globalIdField=this.objectIdField=this.geometryType="";this.spatialReference=null;this.loaded=this._transparent=this.hasZ=this.hasM=!1;this.fsetInfo=this._fieldsIndex=this._loadPromise=null;a?.lrucache&&(this.recentlyUsedQueries=a.lrucache);a?.interceptor&&(this.featureSetQueryInterceptor=
a.interceptor)}optimisePagingFeatureQueries(a){this._parent&&this._parent.optimisePagingFeatureQueries(a)}_hasMemorySource(){return!0}prop(a,b){if(void 0===b)return this[a];void 0!==this[a]&&(this[a]=b);return this}end(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent}_ensureLoaded(){return this.load()}load(){null===this._loadPromise&&(this._loadPromise=this.loadImpl());return this._loadPromise}async loadImpl(){if(!0===this._parent?.loaded)return this._initialiseFeatureSet(),
this;await this._parent?.load();this._initialiseFeatureSet();return this}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.globalIdField=
this.objectIdField=this.typeIdField="",this.spatialReference=new x({wkid:4326}),this.geometryType=l.layerGeometryEsriConstants.point)}getField(a,b){let c;if(b=b||this.fields)a=a.toLowerCase(),b.some(d=>{d&&d.name.toLowerCase()===a&&(c=d);return!!c});return c}getFieldsIndex(){null===this._fieldsIndex&&(this._fieldsIndex=y.fromLayer({timeInfo:this.timeInfo,editFieldsInfo:this.editFieldsInfo,dateFieldsTimeZone:this.dateFieldsTimeZone,datesInUnknownTimezone:this.datesInUnknownTimezone,fields:this.fields}));
return this._fieldsIndex}_maxProcessingRate(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}_maxQueryRate(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}_checkCancelled(a){if(null!=a&&a.aborted)throw new m.FeatureSetError(m.FeatureSetErrorCodes.Cancelled);}nativeCapabilities(){return this._parent.nativeCapabilities()}async _canDoAggregates(a,b,c,d,e){return null===
this._parent?!1:this._parent._canDoAggregates(a,b,c,d,e)}async _getAggregatePagesDataSourceDefinition(a,b,c,d,e,f,g){if(null===this._parent)throw new m.FeatureSetError(m.FeatureSetErrorCodes.NeverReach);return this._parent._getAggregatePagesDataSourceDefinition(a,b,c,d,e,f,g)}async _getAgregagtePhysicalPage(a,b,c){if(null===this._parent)throw new m.FeatureSetError(m.FeatureSetErrorCodes.NeverReach);return this._parent._getAgregagtePhysicalPage(a,b,c)}async databaseType(){if(this._databaseType===l.FeatureServiceDatabaseType.NotEvaluated){if(null!==
r.applicationCache){const a=r.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==a)return a}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;try{this._databaseTypeProbed=this._getDatabaseTypeImpl(),null!==r.applicationCache&&r.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),this._databaseTypeProbed)}catch(a){throw null!==r.applicationCache&&r.applicationCache.clearDatabaseType(this._cacheableFeatureSetSourceKey()),a;}return this._databaseTypeProbed}return this._databaseType}async _getDatabaseTypeImpl(){const a=
[{thetype:l.FeatureServiceDatabaseType.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) \x3d CAST( '2015-01-01' as DATETIME)) AND OBJECTID\x3c0"},{thetype:l.FeatureServiceDatabaseType.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') \x3d TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID\x3c0"},{thetype:l.FeatureServiceDatabaseType.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' \x3d date '2015-01-01 10:10:10') AND OBJECTID\x3c0"}];for(const b of a)if(!0===await this._runDatabaseProbe(b.testwhere))return b.thetype;
return l.FeatureServiceDatabaseType.StandardisedNoInterval}_cacheableFeatureSetSourceKey(){return"MUSTBESET"}async _runDatabaseProbe(a){if(null!==this._parent)return this._parent._runDatabaseProbe(a);throw new m.FeatureSetError(m.FeatureSetErrorCodes.NotImplemented);}isTable(){return this._parent?.isTable()??!1}_featureFromCache(a){if(void 0!==this._featureCache[a])return this._featureCache[a]}_isInFeatureSet(a){return l.IdState.Unknown}_getSet(a){throw new m.FeatureSetError(m.FeatureSetErrorCodes.NotImplemented);
}async _getFeature(a,b,c){this._checkCancelled(c);if(void 0!==this._featureFromCache(b))return this._featureFromCache(b);await this._getFeatures(a,b,this._maxProcessingRate(),c);this._checkCancelled(c);if(void 0!==this._featureFromCache(b))return this._featureFromCache(b);throw new m.FeatureSetError(m.FeatureSetErrorCodes.MissingFeatures);}async _getFeatureBatch(a,b){this._checkCancelled(b);const c=new u([],a,!1,null),d=[];await this._getFeatures(c,-1,a.length,b);this._checkCancelled(b);for(const e of a)void 0!==
this._featureFromCache(e)&&d.push(this._featureFromCache(e));return d}async _getFeatures(a,b,c,d){return"success"}_getFilteredSet(a,b,c,d,e){throw new m.FeatureSetError(m.FeatureSetErrorCodes.NotImplemented);}async _refineSetBlock(a,b,c){if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQueryRate()))return await this._expandPagedSet(a,this._maxQueryRate(),0,0,c),this._refineSetBlock(a,b,c);this._checkCancelled(c);var d=a._candidates.length;this._refineKnowns(a,b);let e=d-a._candidates.length;
if(0===a._candidates.length||e>=b)return a;await this._refineIfParentKnown(a,b-e,c);this._checkCancelled(c);this._refineKnowns(a,b-e);e=d-a._candidates.length;if(e<b&&0<a._candidates.length){d=b-e;const f=this._prepareFetchAndRefineSet(a._candidates);await this._fetchAndRefineFeatures(f,f.length>d?d:a._candidates.length,c);this._checkCancelled(c);this._refineKnowns(a,b-e)}return a}_fetchAndRefineFeatures(a,b,c){return null}_prepareFetchAndRefineSet(a){const b=[];for(let c=0;c<a.length;c++)this._isPhysicalFeature(a[c])&&
b.push(a[c]);return b}_isPhysicalFeature(a){return null===this._parent?!0:this._parent._isPhysicalFeature(a)}_refineKnowns(a,b){let c=0,d=null;const e=[];b=this._maxQueryRate();for(let f=0;f<a._candidates.length&&"GETPAGES"!==a._candidates[f];f++){let g=!1;const k=this._candidateIdTransform(a._candidates[f]);k!==a._candidates[f]&&(g=!0);const n=this._isInFeatureSet(k);if(n===l.IdState.InFeatureSet)!0===g?a._known.includes(k)||(a._known.push(k),c+=1):(a._known.push(a._candidates[f]),c+=1),null===d?
d={start:f,end:f}:d.end===f-1?d.end=f:(e.push(d),d={start:f,end:f});else if(n===l.IdState.NotInFeatureSet)null===d?d={start:f,end:f}:d.end===f-1?d.end=f:(e.push(d),d={start:f,end:f}),c+=1;else if(n===l.IdState.Unknown&&(c+=1,!0===a._ordered))break;if(c>=b)break}null!==d&&e.push(d);for(b=e.length-1;0<=b;b--)a._candidates.splice(e[b].start,e[b].end-e[b].start+1)}_refineIfParentKnown(a,b,c){const d=new u([],[],a._ordered,null);d._candidates=a._candidates.slice(0);return this._parent._refineSetBlock(d,
b,c)}_candidateIdTransform(a){return this._parent._candidateIdTransform(a)}_checkIfNeedToExpandKnownPage(a,b){if(null===a.pagesDefinition)return!1;let c=0;for(let d=a._lastFetchedIndex;d<a._known.length;d++){if("GETPAGES"===a._known[d])return!0;if(void 0===this._featureCache[a._known[d]]&&(c+=1,c>=b))break}return!1}_checkIfNeedToExpandCandidatePage(a,b){if(null===a.pagesDefinition)return!1;let c=0;for(let d=0;d<a._candidates.length;d++){if("GETPAGES"===a._candidates[d])return!0;c+=1;if(c>=b)break}return!1}async _expandPagedSet(a,
b,c,d,e){if(null===this._parent)throw new m.FeatureSetError(m.FeatureSetErrorCodes.NotImplemented);return this._parent._expandPagedSet(a,b,c,d,e)}async _expandPagedSetFeatureSet(a,b,c,d,e){0<a._known.length&&"GETPAGES"===a._known[a._known.length-1]&&(d=1);0===d&&0<a._candidates.length&&"GETPAGES"===a._candidates[a._candidates.length-1]&&(d=2);if(0===d)return"finished";d=await this._getPage(a,d,e);return c+d<b?this._expandPagedSet(a,b,c+d,0,e):"success"}async _getPage(a,b,c){const d=1===b?a._known:
a._candidates;if(a.pagesDefinition.internal.set.length>a.pagesDefinition.resultOffset||!0===a.pagesDefinition.internal.fullyResolved){--d.length;b=0;for(c=0;c<a.pagesDefinition.resultRecordCount&&!(a.pagesDefinition.resultOffset+c>=a.pagesDefinition.internal.set.length);c++)d[d.length]=a.pagesDefinition.internal.set[a.pagesDefinition.resultOffset+c],b++;a.pagesDefinition.resultOffset+=b;c=!1;!0===a.pagesDefinition.internal.fullyResolved&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset&&
(c=!0);!1===c&&d.push("GETPAGES");return b}await this._getPhysicalPage(a,b,c);return this._getPage(a,b,c)}_getPhysicalPage(a,b,c){return null}_clonePageDefinition(a){return null===this._parent?null:this._parent._clonePageDefinition(a)}_first(a){return this.iterator(a).next()}first(a){return this._first(a)}async calculateStatistic(a,b,c,d){await this._ensureLoaded();let e=await this._stat(a,b,"",null,null,c,d);!1===e.calculated&&(e=await this._manualStat(a,b,c,d));return e.result}async _manualStat(a,
b,c,d){let e=null;switch(a.toLowerCase()){case "count":return e=await p.count(this,d),{calculated:!0,result:e};case "distinct":return e=await p.distinct(this,b,c,d),{calculated:!0,result:e};case "avg":case "mean":return e=await p.mean(this,b,d),{calculated:!0,result:e};case "stdev":return e=await p.stdev(this,b,d),{calculated:!0,result:e};case "variance":return e=await p.variance(this,b,d),{calculated:!0,result:e};case "sum":return e=await p.sum(this,b,d),{calculated:!0,result:e};case "min":return e=
await p.min(this,b,d),{calculated:!0,result:e};case "max":return e=await p.max(this,b,d),{calculated:!0,result:e};default:return{calculated:!0,result:0}}}async _stat(a,b,c,d,e,f,g){const k=await this._parent._stat(a,b,c,d,e,f,g);return!1===k.calculated?null===e&&""===c&&null===d?this._manualStat(a,b,f,g):{calculated:!1}:k}_unionAllGeomSelf(a){const b=this.iterator(this._defaultTracker(a)),c=[];return new Promise((d,e)=>{this._unionShapeInBatches(c,b,d,e)})}_unionAllGeom(a){return new Promise((b,c)=>
{const d=this.iterator(this._defaultTracker(a));this._unionShapeInBatches([],d,b,c)})}_unionShapeInBatches(a,b,c,d){b.next().then(e=>{try{null!==e&&null!==e.geometry&&a.push(e.geometry),30<a.length||null===e&&1<a.length?t.union(a).then(f=>{try{null===e?c(f):(a=[f],this._unionShapeInBatches(a,b,c,d))}catch(g){d(g)}},d):null===e?1===a.length?c(a[0]):c(null):this._unionShapeInBatches(a,b,c,d)}catch(f){d(f)}},d)}iterator(a){return new w(this,a)}intersection(a,b=!1){return h._featuresetFunctions.intersection.bind(this)(a,
b)}difference(a,b=!1,c=!0){return h._featuresetFunctions.difference.bind(this)(a,b,c)}symmetricDifference(a,b=!1,c=!0){return h._featuresetFunctions.symmetricDifference.bind(this)(a,b,c)}morphShape(a,b,c="unknown",d=null){return h._featuresetFunctions.morphShape.bind(this)(a,b,c,d)}morphShapeAndAttributes(a,b,c="unknown"){return h._featuresetFunctions.morphShapeAndAttributes.bind(this)(a,b,c)}union(a,b=!1){return h._featuresetFunctions.union.bind(this)(a,b)}intersects(a){return h._featuresetFunctions.intersects.bind(this)(a)}envelopeIntersects(a){return h._featuresetFunctions.envelopeIntersects.bind(this)(a)}contains(a){return h._featuresetFunctions.contains.bind(this)(a)}overlaps(a){return h._featuresetFunctions.overlaps.bind(this)(a)}relate(a,
b){return h._featuresetFunctions.relate.bind(this)(a,b)}within(a){return h._featuresetFunctions.within.bind(this)(a)}touches(a){return h._featuresetFunctions.touches.bind(this)(a)}top(a){return h._featuresetFunctions.top.bind(this)(a)}crosses(a){return h._featuresetFunctions.crosses.bind(this)(a)}buffer(a,b,c,d=!0){return h._featuresetFunctions.buffer.bind(this)(a,b,c,d)}filter(a,b=null){return h._featuresetFunctions.filter.bind(this)(a,b)}orderBy(a){return h._featuresetFunctions.orderBy.bind(this)(a)}dissolve(a,
b){return h._featuresetFunctions.dissolve.bind(this)(a,b)}groupby(a,b){return h._featuresetFunctions.groupby.bind(this)(a,b)}reduce(a,b=null,c){return new Promise((d,e)=>{this._reduceImpl(this.iterator(this._defaultTracker(c)),a,b,0,d,e,0)})}_reduceImpl(a,b,c,d,e,f,g){try{g++,1E3<g?setTimeout(()=>{g=0;this._reduceImpl(a,b,c,d,e,f,g)}):a.next().then(k=>{try{if(null===k)e(c);else{const n=b(c,k,d,this);v.isPromiseLike(n)?n.then(z=>{this._reduceImpl(a,b,z,d+1,e,f,g)},f):this._reduceImpl(a,b,n,d+1,e,f,
g)}}catch(n){f(n)}},f)}catch(k){f(k)}}removeField(a){return h._featuresetFunctions.removeField.bind(this)(a)}addField(a,b,c=null){return h._featuresetFunctions.addField.bind(this)(a,b,c)}sumArea(a,b=!1,c){const d=l.convertSquareUnitsToCode(a);return this.reduce((e,f)=>null===f.geometry?0:b?t.geodesicArea(f.geometry,d).then(g=>e+g):t.planarArea(f.geometry,d).then(g=>e+g),0,c)}sumLength(a,b=!1,c){const d=l.convertLinearUnitsToCode(a);return this.reduce((e,f)=>null===f.geometry?0:b?t.geodesicLength(f.geometry,
d).then(g=>e+g):t.planarLength(f.geometry,d).then(g=>e+g),0,c)}_substituteVars(a,b){if(null!==b){const c={};for(const d in b)c[d.toLowerCase()]=b[d];a.parameters=c}}async distinct(a,b=1E3,c=null,d){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,c);return this.calculateStatistic("distinct",a,b,this._defaultTracker(d))}async min(a,b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);
this._substituteVars(a,b);return this.calculateStatistic("min",a,-1,this._defaultTracker(c))}async max(a,b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,b);return this.calculateStatistic("max",a,-1,this._defaultTracker(c))}async avg(a,b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,b);return this.calculateStatistic("avg",a,-1,this._defaultTracker(c))}async sum(a,
b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,b);return this.calculateStatistic("sum",a,-1,this._defaultTracker(c))}async stdev(a,b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,b);return this.calculateStatistic("stdev",a,-1,this._defaultTracker(c))}async variance(a,b=null,c){await this.load();a=q.WhereClause.create(a,this.getFieldsIndex(),
this.dateFieldsTimeZoneDefaultUTC);this._substituteVars(a,b);return this.calculateStatistic("variance",a,-1,this._defaultTracker(c))}async count(a){await this.load();return this.calculateStatistic("count",q.WhereClause.create("1",this.getFieldsIndex(),this.dateFieldsTimeZoneDefaultUTC),-1,this._defaultTracker(a))}_defaultTracker(a){return a??{aborted:!1}}forEach(a,b){return new Promise((c,d)=>{this._forEachImpl(this.iterator(this._defaultTracker(b)),a,this,c,d,0)})}_forEachImpl(a,b,c,d,e,f){try{f++,
1E3<f?setTimeout(()=>{f=0;this._forEachImpl(a,b,c,d,e,f)},0):a.next().then(g=>{try{if(null===g)d(c);else{const k=b(g);void 0===k||null===k?this._forEachImpl(a,b,c,d,e,f):v.isPromiseLike(k)?k.then(()=>{try{this._forEachImpl(a,b,c,d,e,f)}catch(n){e(n)}},e):this._forEachImpl(a,b,c,d,e,f)}}catch(k){e(k)}},e)}catch(g){e(g)}}convertToJSON(a){const b={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}};for(let c=0;c<this.fields.length;c++)b.layerDefinition.fields.push(l.esriFieldToJson(this.fields[c]));
return this.reduce((c,d)=>{c={geometry:d.geometry?.toJSON(),attributes:{}};for(const e in d.attributes)c.attributes[e]=d.attributes[e];b.featureSet.features.push(c);return 1},0,a).then(()=>b)}castToText(a){return"object, FeatureSet"}queryAttachments(a,b,c,d,e){return this._parent.queryAttachments(a,b,c,d,e)}serviceUrl(){return this._parent.serviceUrl()}subtypes(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map(a=>({name:a.name,code:a.id})):[]}:null}relationshipMetaData(){return this._parent.relationshipMetaData()}get gdbVersion(){return this._parent?
this._parent.gdbVersion:""}schema(){const a=[];for(const b of this.fields)a.push(l.esriFieldToJson(b));return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===l.layerGeometryEsriRestConstants[this.geometryType]?"esriGeometryNull":l.layerGeometryEsriRestConstants[this.geometryType],fields:a}}async convertToText(a,b){if("schema"===a)return await this._ensureLoaded(),JSON.stringify(this.schema());if("featureset"===a){await this._ensureLoaded();const c=[];await this.reduce((d,
e)=>{d={geometry:e.geometry?e.geometry.toJSON():null,attributes:e.attributes};null!==d.geometry&&d.geometry.spatialReference&&delete d.geometry.spatialReference;c.push(d);return 1},0,b);a=this.schema();a.features=c;a.spatialReference=this.spatialReference.toJSON();return JSON.stringify(a)}return this.castToText()}getFeatureByObjectId(a,b){return this._parent.getFeatureByObjectId(a,b)}getOwningSystemUrl(){return this._parent.getOwningSystemUrl()}getIdentityUser(){return this._parent.getIdentityUser()}getRootFeatureSet(){return null!==
this._parent?this._parent.getRootFeatureSet():this}getDataSourceFeatureSet(){return null!==this._parent?this._parent.getDataSourceFeatureSet():this}castAsJson(a=null){return"keeptype"===a?.featureset?this:"none"===a?.featureset?null:{type:"FeatureSet"}}async castAsJsonAsync(a=null,b=null){if("keeptype"===b?.featureset)return this;if("schema"===b?.featureset)return await this._ensureLoaded(),JSON.parse(JSON.stringify(this.schema()));if("none"===b?.featureset)return null;await this._ensureLoaded();
const c=[];await this.reduce((d,e)=>{d={geometry:e.geometry?!0===b?.keepGeometryType?e.geometry:e.geometry.toJSON():null,attributes:e.attributes};null!==d.geometry&&d.geometry.spatialReference&&!0!==b?.keepGeometryType&&delete d.geometry.spatialReference;c.push(d);return 1},0,a);a=this.schema();a.features=c;a.spatialReference=!0===b?.keepGeometryType?this.spatialReference:this.spatialReference?.toJSON();return a}fieldTimeZone(a){return this.getFieldsIndex().getTimeZone(a)}get preferredTimeZone(){return this._parent?.preferredTimeZone??
null}get dateFieldsTimeZone(){return this._parent?.dateFieldsTimeZone??null}get dateFieldsTimeZoneDefaultUTC(){if(this.datesInUnknownTimezone)return"unknown";const a=this.dateFieldsTimeZone??"UTC";return""===a?"UTC":a}get datesInUnknownTimezone(){return this._parent.datesInUnknownTimezone}get editFieldsInfo(){return this._parent?.editFieldsInfo??null}get timeInfo(){return this._parent?.timeInfo??null}set featureSetInfo(a){this.fsetInfo=a}async getFeatureSetInfo(){return this.fsetInfo??await this._parent?.getFeatureSetInfo()??
null}}h._featuresetFunctions={};return h});