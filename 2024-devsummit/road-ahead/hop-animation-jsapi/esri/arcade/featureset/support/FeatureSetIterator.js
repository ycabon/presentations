// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["../../Feature"],function(m){class n{constructor(a,d){this._lastId=-1;this._progress=d;this._parent=a}reset(){this._lastId=-1}async nextBatchAsArcadeFeatures(a,d){a=await this.nextBatch(a);return null===a?a:a.map(b=>m.createFromGraphicLikeObject(b.geometry,b.attributes,this._parent,d))}nextBatch(a){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(e=>this.nextBatch(a),e=>this.nextBatch(a));var d=null,b=!1;const f=[];d=new Promise((e,g)=>{this._parent._getSet(this._progress).then(c=>
{const h=c._known;var l=h.length-1;"GETPAGES"===h[h.length-1]&&--l;if(this._lastId+a>l&&0<h.length&&"GETPAGES"===h[h.length-1])this._parent._expandPagedSet(c,this._parent._maxQueryRate(),0,0,this._progress).then(k=>{b=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(e,g)},k=>{b=!0;this._parent._mainSetInUse=null;g(k)});else{var p=c._candidates;if(l>=this._lastId+a||0===p.length){for(c=0;c<a;c++){l=c+this._lastId+1;if(l>=h.length)break;f[c]=h[l]}this._lastId+=f.length;0===f.length&&(b=!0,
this._parent._mainSetInUse=null,e([]));this._parent._getFeatureBatch(f,this._progress).then(k=>{b=!0;this._parent._mainSetInUse=null;e(k)},k=>{b=!0;this._parent._mainSetInUse=null;g(k)})}else this._parent._refineSetBlock(c,this._parent._maxProcessingRate(),this._progress).then(()=>{b=!0;this._parent._mainSetInUse=null;this.nextBatch(a).then(e,g)},k=>{b=!0;this._parent._mainSetInUse=null;g(k)})}},c=>{b=!0;this._parent._mainSetInUse=null;g(c)})});!1===b&&(this._parent._mainSetInUse=d,b=!0);return d}next(){if(null!==
this._parent._mainSetInUse)return this._parent._mainSetInUse.then(b=>this.next(),b=>this.next());var a=null,d=!1;a=new Promise((b,f)=>{this._parent._getSet(this._progress).then(e=>{const g=e._known;this._lastId<g.length-1?"GETPAGES"===g[this._lastId+1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,0,this._progress).then(c=>{d=!0;this._parent._mainSetInUse=null;return this.next()}).then(b,f):(this._lastId+=1,this._parent._getFeature(e,g[this._lastId],this._progress).then(c=>{d=!0;this._parent._mainSetInUse=
null;b(c)},c=>{d=!0;this._parent._mainSetInUse=null;f(c)})):0<e._candidates.length?this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then(()=>{d=!0;this._parent._mainSetInUse=null;this.next().then(b,f)},c=>{d=!0;this._parent._mainSetInUse=null;f(c)}):(d=!0,this._parent._mainSetInUse=null,b(null))},e=>{d=!0;this._parent._mainSetInUse=null;f(e)})});!1===d&&(this._parent._mainSetInUse=a,d=!0);return a}async count(){if(-1!==this._parent._totalCount)return this._parent._totalCount;
var a=await this._parent._getSet(this._progress);a=await this._refineAllSets(a);this._parent._totalCount=a._known.length;return this._parent._totalCount}async _refineAllSets(a){if(0<a._known.length&&"GETPAGES"===a._known[a._known.length-1])return await this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,1,this._progress),this._refineAllSets(a);if(0<a._candidates.length){if("GETPAGES"===a._known[a._candidates.length-1])return await this._parent._expandPagedSet(a,this._parent._maxQueryRate(),
0,2,this._progress),this._refineAllSets(a);a=await this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress);return 0<a._candidates.length?this._refineAllSets(a):a}return a}}return n});