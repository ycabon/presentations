// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","./PooledArray"],function(g,k){g.RemoveMode=void 0;(function(a){a[a.ALL=0]="ALL";a[a.SOME=1]="SOME"})(g.RemoveMode||(g.RemoveMode={}));class n{constructor(a,b,c){this.name=a;this._storage=b;this.id=`${p++}:`;this.size=0;this.maxSize=-1;this._removeFunc=!1;this._miss=this._hit=0;this._storage.register(this);c&&(this._storage.registerRemoveFunc(this.id,c),this._removeFunc=!0)}destroy(){this._storage.clear(this);this._removeFunc&&this._storage.deregisterRemoveFunc(this.id);this._storage.deregister(this);
this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get storageSize(){return this._storage.size}getSize(a){return this._storage.getSize(this,a)}resetHitRate(){this._hit=this._miss=0}put(a,b,c,d=0){this._storage.put(this,a,b,c,d)}pop(a){a=this._storage.pop(this,a);void 0===a?++this._miss:++this._hit;return a}get(a){a=this._storage.get(this,a);void 0===a?++this._miss:++this._hit;return a}peek(a){return this._storage.peek(this,a)}updateSize(a,b,c){this._storage.updateSize(this,a,
b,c)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}}class q{get size(){return this._size}constructor(a=10485760){this._maxSize=a;this._db=new Map;this._miss=this._hit=this._size=0;this._removeFuncs=new k;this._users=new k}destroy(){this.clearAll();this._removeFuncs.clear();this._users.clear();this._db=null}register(a){this._users.push(a)}deregister(a){this._users.removeUnordered(a)}registerRemoveFunc(a,
b){this._removeFuncs.push([a,b])}deregisterRemoveFunc(a){this._removeFuncs.filterInPlace(b=>b[0]!==a)}get maxSize(){return this._maxSize}set maxSize(a){this._maxSize=Math.max(a,-1);this._checkSize()}getSize(a,b){return this._db.get(a.id+b)?.size??0}put(a,b,c,d,f){b=a.id+b;const e=this._db.get(b);e&&(this._size-=e.size,a.size-=e.size,this._db.delete(b),e.entry!==c&&this._notifyRemove(b,e.entry,e.size,g.RemoveMode.ALL));d>this._maxSize?this._notifyRemove(b,c,d,g.RemoveMode.ALL):void 0===c?console.warn("Refusing to cache undefined entry "):
!d||0>d?(console.warn(`Refusing to cache entry with size ${d} for key ${b}`),this._notifyRemove(b,c,0,g.RemoveMode.ALL)):(this._db.set(b,new r(c,d,1+Math.max(f,-4)- -3)),this._size+=d,a.size+=d,this._checkSize())}updateSize(a,b,c,d){b=a.id+b;const f=this._db.get(b);if(f&&f.entry===c){this._size-=f.size;for(a.size-=f.size;d>this._maxSize;)if(d=this._notifyRemove(b,c,d,g.RemoveMode.SOME),!(null!=d&&0<d)){this._db.delete(b);return}f.size=d;this._size+=d;a.size+=d;this._checkSize()}}pop(a,b){b=a.id+b;
const c=this._db.get(b);if(c)return this._size-=c.size,a.size-=c.size,this._db.delete(b),++this._hit,c.entry;++this._miss}get(a,b){b=a.id+b;a=this._db.get(b);if(void 0===a)++this._miss;else return this._db.delete(b),a.lives=a.lifetime,this._db.set(b,a),++this._hit,a.entry}peek(a,b){(a=this._db.get(a.id+b))?++this._hit:++this._miss;return a?.entry}get performanceInfo(){const a={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+
"%",Entries:this._db.size.toString()},b={},c=[];this._db.forEach((e,h)=>{const l=e.lifetime;c[l]=(c[l]||0)+e.size;this._users.forAll(t=>{const {id:u,name:m}=t;h.startsWith(u)&&(b[m]=(b[m]||0)+e.size)})});const d={};this._users.forAll(e=>{const h=e.name;"hitRate"in e&&"number"===typeof e.hitRate&&!isNaN(e.hitRate)&&0<e.hitRate?(b[h]=b[h]||0,d[h]=Math.round(100*e.hitRate)+"%"):d[h]="0%"});var f=Object.keys(b);f.sort((e,h)=>b[h]-b[e]);f.forEach(e=>a[e]=Math.round(b[e]/2**20)+"MB / "+d[e]);for(f=c.length-
1;0<=f;--f){const e=c[f];e&&(a["Priority "+(f+-3-1)]=Math.round(e/this._size*100)+"%")}return a}resetStats(){this._hit=this._miss=0;this._users.forAll(a=>a.resetHitRate())}clear(a){const b=a.id;this._db.forEach((c,d)=>{d.startsWith(b)&&(this._size-=c.size,this._db.delete(d),this._notifyRemove(d,c.entry,c.size,g.RemoveMode.ALL))});a.size=0}clearAll(){this._db.forEach((a,b)=>this._notifyRemove(b,a.entry,a.size,g.RemoveMode.ALL));this._users.forAll(a=>a.size=0);this._size=0;this._db.clear()}_getHitRate(){return this._hit/
(this._hit+this._miss)}_notifyRemove(a,b,c,d){let f;this._removeFuncs.some(e=>a.startsWith(e[0])?(e=e[1](b,d,c),"number"===typeof e&&(f=e),!0):!1);return f}_checkSize(){this._users.forAll(a=>this._checkSizeLimits(a));this._checkSizeLimits()}_checkSizeLimits(a){const b=a??this;if(!(0>b.maxSize||b.size<=b.maxSize)){for(var c=a?.id,d=!0;d;){d=!1;for(const [f,e]of this._db)if(0===e.lifetime&&(!c||f.startsWith(c))){this._purgeItem(f,e,a);if(b.size<=.9*b.maxSize)return;d||=this._db.has(f)}}for(const [f,
e]of this._db)if(!c||f.startsWith(c))if(this._purgeItem(f,e,a),b.size<=.9*b.maxSize)break}}_purgeItem(a,b,c=this._users.find(d=>a.startsWith(d.id))){this._db.delete(a);if(1>=b.lives){this._size-=b.size;c&&(c.size-=b.size);const d=this._notifyRemove(a,b.entry,b.size,g.RemoveMode.SOME);null!=d&&0<d&&(this._size+=d,c&&(c.size+=d),b.lives=b.lifetime,b.size=d,this._db.set(a,b))}else--b.lives,this._db.set(a,b)}}let p=0;class r{constructor(a,b,c){this.entry=a;this.size=b;this.lives=this.lifetime=c}}g.MemCache=
n;g.MemCacheStorage=q;g.MinPriority=-3;g.NoPriority=-4;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});