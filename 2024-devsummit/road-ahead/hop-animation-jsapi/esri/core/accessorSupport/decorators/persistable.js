// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../Error ../../MD5 ../../multiOriginJSONSupportUtils ../../urlUtils ../../uuid ../metadata ../PropertyOrigin ./property ../../../portal/support/resourceExtension ../../../chunks/persistableUrlUtils".split(" "),function(w,z,A,B,r,C,D,E,F,u,m){function G(b,h,f){const k=D.getPropertyMetadata(h,f);return{type:String,read:(a,g,d)=>{a=m.read(a,g,d);if(k.type===String)return a;if("function"===typeof k.type)return new k.type({url:a})},write:{writer(a,g,d,c){if(c?.resources){var e=null==
a?null:"string"===typeof a?a:a.url;e=m.toJSON(e,{...c,verifyItemRelativeUrls:c?.verifyItemRelativeUrls?{writtenUrls:c.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},m.MarkKeep.NO);var n=k.type!==String&&(!B.isMultiOriginJSONMixin(this)||c?.origin&&this.originIdOf(f)>E.nameToId(c.origin));a={object:this,propertyName:f,value:a,targetUrl:e,dest:g,targetPropertyName:d,context:c,params:b};if(c?.portalItem&&e&&!r.isAbsolute(e))if(n&&b?.contentAddressed)v(a);else if(n){{const {context:l,targetUrl:p,
params:t,value:q,dest:H,targetPropertyName:I}=a;l.portalItem&&(g=l.portalItem.resourceFromPath(p),d=x(q,p,l),c=u.getResourceContentExtension(d),e=r.getPathExtension(g.path),n=t?.compress??!1,c!==e?v(a):(l.resources&&y({...a,resource:g,content:d,compress:n,updates:l.resources.toUpdate}),H[I]=p))}}else J(a);else c?.portalItem&&(null==e||null!=m.itemIdFromResourceUrl(e)||r.isBlobProtocol(e)||n)?v(a):g[d]=e}else g[d]="string"===typeof a?m.toJSON(a,c):a.write({},c)}}}}function v(b){const {targetUrl:h,
params:f,value:k,context:a,dest:g,targetPropertyName:d}=b;if(a.portalItem){var c=m.prefixAndFilenameFromResourceUrl(h),e=x(k,h,a);if(f?.contentAddressed&&"json"!==e.type)a.messages?.push(new z("persistable:contentAddressingUnsupported",`Property "${d}" is trying to serializing a resource with content of type ${e.type} with content addressing. Content addressing is only supported for json resources.`,{content:e}));else{var n=f?.contentAddressed&&"json"===e.type?A.createMD5Hash(e.jsonString):c?.filename??
C.generateUUID(),l=r.join(f?.prefix??c?.prefix,n),p=`${l}.${u.getResourceContentExtension(e)}`;if(f?.contentAddressed&&a.resources&&"json"===e.type&&(c=a.resources.toKeep.find(({resource:q})=>q.path===p)??a.resources.toAdd.find(({resource:q})=>q.path===p))){g[d]=c.resource.itemRelativeUrl;return}var t=a.portalItem.resourceFromPath(p);r.isBlobProtocol(h)&&a.resources&&a.resources.pendingOperations.push(r.blobUrlToBlob(h).then(q=>{t.path=`${l}.${u.getResourceContentExtension({type:"blob",blob:q})}`;
g[d]=t.itemRelativeUrl}).catch(()=>{}));a.resources&&y({...b,resource:t,content:e,compress:f?.compress??!1,updates:a.resources.toAdd});g[d]=t.itemRelativeUrl}}}function J({context:b,targetUrl:h,dest:f,targetPropertyName:k}){b.portalItem&&b.resources&&(b.resources.toKeep.push({resource:b.portalItem.resourceFromPath(h),compress:!1}),f[k]=h)}function y({object:b,propertyName:h,updates:f,resource:k,content:a,compress:g}){f.push({resource:k,content:a,compress:g,finish:d=>{"string"===typeof b[h]?b[h]=d.url:
b[h].url=d.url}})}function x(b,h,f){return"string"===typeof b?{type:"url",url:h}:{type:"json",jsonString:JSON.stringify(b.toJSON(f))}}w.persistable=function(b){const h=b?.origins??[void 0];return(f,k)=>{a:if("resource"===b?.type)var a=G(b,f,k);else{switch(b?.type??"other"){case "other":a={read:!0,write:!0};break a;case "url":const {read:g,write:d}=m.persistableUrlUtils;a={read:g,write:d};break a}a=void 0}for(const g of h){const d=F.propertyJSONMeta(f,g,k);for(const c in a)d[c]=a[c]}}};Object.defineProperty(w,
Symbol.toStringTag,{value:"Module"})});