// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../arrayUtils","../../PooledArray","../../../chunks/quickselect"],function(A,B,u,L){function p(a,b){q(a,0,a.children.length,b,a)}function q(a,b,c,d,e){e||=new v([]);e.minX=Infinity;e.minY=Infinity;e.maxX=-Infinity;e.maxY=-Infinity;for(let f=b,g;f<c;f++)g=a.children[f],r(e,a.leaf?d(g):g);return e}function r(a,b){a.minX=Math.min(a.minX,b.minX);a.minY=Math.min(a.minY,b.minY);a.maxX=Math.max(a.maxX,b.maxX);a.maxY=Math.max(a.maxY,b.maxY)}function G(a,b){return a.minX-b.minX}function H(a,
b){return a.minY-b.minY}function C(a){return(a.maxX-a.minX)*(a.maxY-a.minY)}function w(a){return a.maxX-a.minX+(a.maxY-a.minY)}function D(a,b){return a.minX<=b.minX&&a.minY<=b.minY&&b.maxX<=a.maxX&&b.maxY<=a.maxY}function x(a,b){return b.minX<=a.maxX&&b.minY<=a.maxY&&b.maxX>=a.minX&&b.maxY>=a.minY}function I(a,b,c,d,e){for(b=[b,c];b.length;){c=b.pop();const f=b.pop();if(c-f<=d)continue;const g=f+Math.ceil((c-f)/d/2)*d;L.quickselect(a,g,f,c,e);b.push(f,g,g,c)}}class M{constructor(a=9,b){this._compareMinX=
G;this._compareMinY=H;this._toBBox=c=>c;this._maxEntries=Math.max(4,a||9);this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries));b&&("function"===typeof b?this._toBBox=b:this._initFormat(b));this.clear()}destroy(){this.clear();n.prune();y.prune();l.prune();z.prune()}all(a){this._all(this._data,a)}search(a,b){let c=this._data;const d=this._toBBox;if(x(a,c))for(n.clear();c;){for(let e=0,f=c.children.length;e<f;e++){const g=c.children[e],h=c.leaf?d(g):g;x(a,h)&&(c.leaf?b(g):D(a,h)?this._all(g,b):
n.push(g))}c=n.pop()}}collides(a){let b=this._data;const c=this._toBBox;if(!x(a,b))return!1;for(n.clear();b;){for(let d=0,e=b.children.length;d<e;d++){const f=b.children[d],g=b.leaf?c(f):f;if(x(a,g)){if(b.leaf||D(a,g))return!0;n.push(f)}}b=n.pop()}return!1}load(a){if(!a.length)return this;if(a.length<this._minEntries){for(let b=0,c=a.length;b<c;b++)this.insert(a[b]);return this}a=this._build(a.slice(0,a.length),0,a.length-1,0);if(this._data.children.length)if(this._data.height===a.height)this._splitRoot(this._data,
a);else{if(this._data.height<a.height){const b=this._data;this._data=a;a=b}this._insert(a,this._data.height-a.height-1,!0)}else this._data=a;return this}insert(a){a&&this._insert(a,this._data.height-1);return this}clear(){this._data=new v([]);return this}remove(a){if(!a)return this;let b=this._data,c=null,d=0,e=!1,f;const g=this._toBBox(a);l.clear();for(z.clear();b||0<l.length;){b||(b=l.pop(),c=l.data[l.length-1],d=z.pop()??0,e=!0);if(b.leaf&&(f=B.indexOf(b.children,a,b.children.length,b.indexHint),
-1!==f)){b.children.splice(f,1);l.push(b);this._condense(l);break}e||b.leaf||!D(b,g)?c?(d++,b=c.children[d],e=!1):b=null:(l.push(b),z.push(d),d=0,c=b,b=b.children[0])}return this}toJSON(){return this._data}fromJSON(a){this._data=a;return this}_all(a,b){for(y.clear();a;){if(!0===a.leaf)for(const c of a.children)b(c);else y.pushArray(a.children);a=y.pop()??null}}_build(a,b,c,d){var e=c-b+1,f=this._maxEntries;if(e<=f)return a=new v(a.slice(b,c+1)),p(a,this._toBBox),a;d||(d=Math.ceil(Math.log(e)/Math.log(f)),
f=Math.ceil(e/f**(d-1)));const g=new E([]);g.height=d;e=Math.ceil(e/f);f=e*Math.ceil(Math.sqrt(f));for(I(a,b,c,f,this._compareMinX);b<=c;b+=f){const h=Math.min(b+f-1,c);I(a,b,h,e,this._compareMinY);for(let k=b;k<=h;k+=e)g.children.push(this._build(a,k,Math.min(k+e-1,h),d-1))}p(g,this._toBBox);return g}_chooseSubtree(a,b,c,d){for(;;){d.push(b);if(!0===b.leaf||d.length-1===c)break;let e=Infinity,f=Infinity,g=void 0;for(let h=0,k=b.children.length;h<k;h++){const m=b.children[h],t=C(m),F=(Math.max(m.maxX,
a.maxX)-Math.min(m.minX,a.minX))*(Math.max(m.maxY,a.maxY)-Math.min(m.minY,a.minY))-t;F<f?(f=F,e=t<e?t:e,g=m):F===f&&t<e&&(e=t,g=m)}b=g||b.children[0]}return b}_insert(a,b,c){var d=this._toBBox;c=c?a:d(a);l.clear();d=this._chooseSubtree(c,this._data,b,l);d.children.push(a);for(r(d,c);0<=b;)if(l.data[b].children.length>this._maxEntries)this._split(l,b),b--;else break;this._adjustParentBBoxes(c,l,b)}_split(a,b){const c=a.data[b];var d=c.children.length;const e=this._minEntries;this._chooseSplitAxis(c,
e,d);(d=this._chooseSplitIndex(c,e,d))?(d=c.children.splice(d,c.children.length-d),d=c.leaf?new v(d):new E(d),d.height=c.height,p(c,this._toBBox),p(d,this._toBBox),b?a.data[b-1].children.push(d):this._splitRoot(c,d)):console.log("  Error: assertion failed at PooledRBush._split: no valid split index")}_splitRoot(a,b){this._data=new E([a,b]);this._data.height=a.height+1;p(this._data,this._toBBox)}_chooseSplitIndex(a,b,c){let d,e,f=void 0;d=e=Infinity;for(let h=b;h<=c-b;h++){var g=q(a,0,h,this._toBBox);
const k=q(a,h,c,this._toBBox),m=Math.max(0,Math.min(g.maxX,k.maxX)-Math.max(g.minX,k.minX))*Math.max(0,Math.min(g.maxY,k.maxY)-Math.max(g.minY,k.minY));g=C(g)+C(k);m<d?(d=m,f=h,e=g<e?g:e):m===d&&g<e&&(e=g,f=h)}return f}_chooseSplitAxis(a,b,c){const d=a.leaf?this._compareMinX:G,e=a.leaf?this._compareMinY:H,f=this._allDistMargin(a,b,c,d);b=this._allDistMargin(a,b,c,e);f<b&&a.children.sort(d)}_allDistMargin(a,b,c,d){a.children.sort(d);d=this._toBBox;var e=q(a,0,b,d);const f=q(a,c-b,c,d);let g=w(e)+w(f);
for(let h=b;h<c-b;h++){const k=a.children[h];r(e,a.leaf?d(k):k);g+=w(e)}for(c=c-b-1;c>=b;c--)e=a.children[c],r(f,a.leaf?d(e):e),g+=w(f);return g}_adjustParentBBoxes(a,b,c){for(;0<=c;c--)r(b.data[c],a)}_condense(a){for(let b=a.length-1;0<=b;b--){const c=a.data[b];if(0===c.children.length)if(0<b){const d=a.data[b-1],e=d.children;e.splice(B.indexOf(e,c,e.length,d.indexHint),1)}else this.clear();else p(c,this._toBBox)}}_initFormat(a){const b=["return a"," - b",";"];this._compareMinX=new Function("a",
"b",b.join(a[0]));this._compareMinY=new Function("a","b",b.join(a[1]));this._toBBox=new Function("a","return {minX: a"+a[0]+", minY: a"+a[1]+", maxX: a"+a[2]+", maxY: a"+a[3]+"};")}}const n=new u,y=new u,l=new u,z=new u({deallocator:void 0});class J{constructor(){this.minY=this.minX=Infinity;this.maxY=this.maxX=-Infinity}}class K extends J{constructor(){super(...arguments);this.height=1;this.indexHint=new B.PositionHint}}class v extends K{constructor(a){super();this.children=a;this.leaf=!0}}class E extends K{constructor(a){super();
this.children=a;this.leaf=!1}}A.BBox=J;A.PooledRBush=M;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});