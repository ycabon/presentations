// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../Error ../has ../promiseUtils ./Connection ./connectionRegistry ./RemoteClient ./WorkerOwner".split(" "),function(x,g,y,h,q,r,z,n,A){function B(a){if(a&&a.__esModule)return a;const b=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(a)for(const c in a)if("default"!==c){const d=Object.getOwnPropertyDescriptor(a,c);Object.defineProperty(b,c,d.get?d:{enumerable:!0,get:()=>a[c]})}b.default=a;return Object.freeze(b)}async function l(a,b){const c=new r,{registryTarget:d,
...e}=b;await c.open(a,e);d&&z.register(d,c);return c}async function t(){if(m)return m;u=new AbortController;const a=[];for(let b=0;b<k;b++){const c=A.create(b).then(d=>f[b]=d);a.push(c)}return m=Promise.all(a)}const v=h("host-browser")?Math.min(navigator.hardwareConcurrency-1,h("workers-pool-size")):0;let k=h("esri-mobile")?Math.min(v,3):v;k||=h("safari")&&h("mac")?7:2;let w=0;const f=[];let m=null,u;g.Connection=r;g.RemoteClient=n;g.initialize=function(){t()};g.open=async function(a,b={}){if("string"!==
typeof a)throw new y("workers:undefined-module","modulePath is missing");var c=b.strategy||"distributed";h("host-webworker")&&!h("esri-workers")&&(c="local");if("local"===c){var d=await n.loadWorker(a);d||=await new Promise((e,p)=>x([a],C=>e(B(C)),p));q.throwIfAborted(b.signal);c=b.client||d;d=n.connect(d);return l([d],{...b,client:c})}await t();q.throwIfAborted(b.signal);if("dedicated"===c)return c=w++%k,c=await f[c].open(a,b),l([c],b);if(b.maxNumWorkers&&0<b.maxNumWorkers&&(c=Math.min(b.maxNumWorkers,
k),c<k)){d=Array(c);for(let e=0;e<c;++e){const p=w++%k;d[e]=f[p].open(a,b)}return l(d,b)}c=f.map(e=>e.open(a,b));return l(c,b)};g.openWithPorts=function(a,b){return l(a,{client:b})};g.terminate=function(){m&&(u.abort(),m=null);for(let a=0;a<f.length;a++)f[a]&&f[a].terminate();f.length=0};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});