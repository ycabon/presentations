// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/Error ../../../../../core/Logger ../../../../../core/MapUtils ../../../../../core/mathUtils ../../../../../core/unitUtils ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../core/libs/gl-matrix-2/math/quat ../../../../../core/libs/gl-matrix-2/factories/quatf64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../MeshGeoreferencedVertexSpace ../../../MeshMaterialMetallicRoughness ../../georeference ./buffer ./geometry ./types ./imageutils ../../../../../views/3d/glTF/internal/resourceUtils ../../../../../views/webgl/enums".split(" "),
function(I,P,D,Q,R,S,T,J,U,K,L,u,V,W,M,N,X,h,E,F,k){class Y{constructor(b,a,c){this.params={};this._materialMap=[];this._imageMap=new Map;this._textureMap=new Map;this.gltf={asset:{version:"2.0",copyright:b.copyright,generator:b.generator},extras:{options:a,binChunkBuffer:null,promises:[]}};c&&(this.params=c);this._addScenes(b)}_addScenes(b){this.gltf.scene=b.defaultScene;const a=this.gltf.extras,c=a.options.bufferOutputType===h.BufferOutputType.GLB||a.options.imageOutputType===h.ImageOutputType.GLB;
c&&(a.binChunkBuffer=new N.Buffer(this.gltf));b.forEachScene(e=>{this._addScene(e)});c&&a.binChunkBuffer.finalize()}_addScene(b){this.gltf.scenes||(this.gltf.scenes=[]);const a={};b.name&&(a.name=b.name);b.forEachNode(c=>{a.nodes||(a.nodes=[]);a.nodes.push(...this._addNodes(c))});this.gltf.scenes.push(a)}_addNodes(b){this.gltf.nodes||(this.gltf.nodes=[]);const a={};b.name&&(a.name=b.name);var c=b.translation;L.exactEquals(c,u.ZEROS)||(a.translation=u.clone(c));c=b.rotation;U.exactEquals(c,K.IDENTITY)||
(a.rotation=K.clone(c));c=b.scale;L.exactEquals(c,u.ONES)||(a.scale=u.clone(c));c=this.gltf.nodes.length;this.gltf.nodes.push(a);if(b.mesh&&b.mesh.vertexAttributes.position){b=this._createMeshes(b.mesh);c=[c];if(1===b.length)this._addMesh(a,b[0]);else for(const e of b)b={},this._addMesh(b,e),c.push(this.gltf.nodes.length),this.gltf.nodes.push(b);return c}b.forEachNode(e=>{a.children||(a.children=[]);a.children.push(...this._addNodes(e))});return[c]}_addMesh(b,a){var c;(c=this.gltf).meshes??(c.meshes=
[]);c=this.gltf.meshes.length;this.gltf.meshes.push(a);b.mesh=c}_createMeshes(b){var a=this.gltf.extras;const c=a.options.bufferOutputType===h.BufferOutputType.GLB;a=c?a.binChunkBuffer:new N.Buffer(this.gltf);this.params.origin||(this.params.origin=b.anchor);var {ignoreLocalTransform:e}=this.params,g=e?null:b.transform;const {vertexSpace:m,spatialReference:q}=b,t=m.origin;var d=b.vertexAttributes,f=null;switch(m.type){case "local":f=S.getMetersPerCartesianUnitForSR(q);T.scale(O,g?.localMatrix??J.IDENTITY,
[f,f,f]);f=M.applyTransform(d,O);break;default:f=e?new V({origin:t?u.clone(t):null}):m,f=M.ungeoreferenceByTransform(d,f,g,this.params.origin,{geographic:this.params.geographic,unit:"meters"})}if(null==f)throw new P("Error during gltf export.");d.position&&f.position===d.position&&(f.position=d.position.slice());d.normal&&f.normal===d.normal&&(f.normal=d.normal.slice());d.tangent&&f.tangent===d.tangent&&(f.tangent=d.tangent.slice());X.smoothNormals(b,f);this._flipYZAxis(f);g=a.addBufferView(k.DataType.FLOAT,
h.AttributeType.VEC3,h.TargetBuffer.ARRAY_BUFFER);let l;f.normal&&(l=a.addBufferView(k.DataType.FLOAT,h.AttributeType.VEC3,h.TargetBuffer.ARRAY_BUFFER));let r;d.uv&&(r=a.addBufferView(k.DataType.FLOAT,h.AttributeType.VEC2,h.TargetBuffer.ARRAY_BUFFER));let n;f.tangent&&(n=a.addBufferView(k.DataType.FLOAT,h.AttributeType.VEC4,h.TargetBuffer.ARRAY_BUFFER));let p;d.color&&(p=a.addBufferView(k.DataType.UNSIGNED_BYTE,h.AttributeType.VEC4,h.TargetBuffer.ARRAY_BUFFER));g.startAccessor("POSITION");l&&l.startAccessor("NORMAL");
r&&r.startAccessor("TEXCOORD_0");n&&n.startAccessor("TANGENT");p&&p.startAccessor("COLOR_0");e=f.position.length/3;const {position:G,normal:x,tangent:v}=f,{color:w,uv:H}=d;for(d=0;d<e;++d)g.push(G[3*d]),g.push(G[3*d+1]),g.push(G[3*d+2]),l&&null!=x&&(l.push(x[3*d]),l.push(x[3*d+1]),l.push(x[3*d+2])),r&&null!=H&&(r.push(H[2*d]),r.push(H[2*d+1])),n&&null!=v&&(n.push(v[4*d]),n.push(v[4*d+1]),n.push(v[4*d+2]),n.push(v[4*d+3])),p&&null!=w&&(p.push(w[4*d]),p.push(w[4*d+1]),p.push(w[4*d+2]),p.push(w[4*d+
3]));d=g.endAccessor();d=this._addAccessor(g.index,d);if(l){var y=l.endAccessor();y=this._addAccessor(l.index,y)}if(r){var z=r.endAccessor();z=this._addAccessor(r.index,z)}if(n){var A=n.endAccessor();A=this._addAccessor(n.index,A)}if(p){var B=p.endAccessor();B=this._addAccessor(p.index,B)}let C;f=[];b.components&&0<b.components.length&&b.components[0].faces?(C=a.addBufferView(k.DataType.UNSIGNED_INT,h.AttributeType.SCALAR,h.TargetBuffer.ELEMENT_ARRAY_BUFFER),this._addMeshVertexIndexed(C,b.components,
f,d,y,z,A,B)):this._addMeshVertexNonIndexed(b.components,f,d,y,z,A,B);g.finalize();l&&l.finalize();r&&r.finalize();n&&n.finalize();C&&C.finalize();p&&p.finalize();c||a.finalize();return f}_flipYZAxis({position:b,normal:a,tangent:c}){this._flipYZBuffer(b,3);this._flipYZBuffer(a,3);this._flipYZBuffer(c,4)}_flipYZBuffer(b,a){if(null!=b)for(let c=1,e=2;c<b.length;c+=a,e+=a){const g=b[c];b[c]=b[e];b[e]=-g}}_addMaterial(b){if(null!==b){var a=this._materialMap.indexOf(b);if(-1!==a)return a;this.gltf.materials||
(this.gltf.materials=[]);a={};switch(b.alphaMode){case "mask":a.alphaMode=h.AlphaMode.MASK;break;case "auto":case "blend":a.alphaMode=h.AlphaMode.BLEND}.5!==b.alphaCutoff&&(a.alphaCutoff=b.alphaCutoff);b.doubleSided&&(a.doubleSided=b.doubleSided);a.pbrMetallicRoughness={};var c=e=>{e=e.toRgba();e[0]=(e[0]/255)**2.1;e[1]=(e[1]/255)**2.1;e[2]=(e[2]/255)**2.1;return e};null!=b.color&&(a.pbrMetallicRoughness.baseColorFactor=c(b.color));null!=b.colorTexture&&(a.pbrMetallicRoughness.baseColorTexture=this._createTextureInfo(b.colorTexture,
b.colorTextureTransform));null!=b.normalTexture&&(a.normalTexture=this._createTextureInfo(b.normalTexture,b.normalTextureTransform));b instanceof W?(null!=b.emissiveTexture&&(a.emissiveTexture=this._createTextureInfo(b.emissiveTexture,b.emissiveTextureTransform)),null!=b.emissiveColor&&(c=c(b.emissiveColor),a.emissiveFactor=[c[0],c[1],c[2]]),null!=b.occlusionTexture&&(a.occlusionTexture=this._createTextureInfo(b.occlusionTexture,b.occlusionTextureTransform)),null!=b.metallicRoughnessTexture&&(a.pbrMetallicRoughness.metallicRoughnessTexture=
this._createTextureInfo(b.metallicRoughnessTexture,b.metallicRoughnessTextureTransform)),a.pbrMetallicRoughness.metallicFactor=b.metallic,a.pbrMetallicRoughness.roughnessFactor=b.roughness):(a.pbrMetallicRoughness.metallicFactor=1,a.pbrMetallicRoughness.roughnessFactor=1,D.getLogger("gltf").warnOnce("Meshes exported to GLTF without MeshMaterialMetallicRoughness material will appear different when imported back."));c=this.gltf.materials.length;this.gltf.materials.push(a);this._materialMap.push(b);
return c}}_createTextureInfo(b,a){b={index:this._addTexture(b)};if(!a)return b;b.extensions||(b.extensions={});b.extensions.KHR_texture_transform={scale:a.scale,offset:a.offset,rotation:R.deg2rad(a.rotation)};return b}_addTexture(b){const a=this.gltf.textures??[];this.gltf.textures=a;return Q.getOrCreateMapValue(this._textureMap,b,()=>{const c={sampler:this._addSampler(b),source:this._addImage(b)},e=a.length;a.push(c);return e})}_addImage(b){var a=this._imageMap.get(b);if(null!=a)return a;this.gltf.images||
(this.gltf.images=[]);const c={};if(b.url)c.uri=b.url;else{a=b.data;c.extras=a;for(var e=0;e<this.gltf.images.length;++e)if(a===this.gltf.images[e].extras)return e;e=this.gltf.extras;switch(e.options.imageOutputType){case h.ImageOutputType.GLB:const g=e.binChunkBuffer.addBufferView(k.DataType.UNSIGNED_BYTE,h.AttributeType.SCALAR);F.isEncodedMeshTexture(a)?null!=a.data&&g.writeOutToBuffer(a.data,0):(a=E.imageToArrayBuffer(a).then(({data:m,type:q})=>{c.mimeType=q;return m}),g.writeAsync(a).then(()=>
{g.finalize()}));c.bufferView=g.index;break;case h.ImageOutputType.DataURI:F.isEncodedMeshTexture(a)?D.getLogger("gltf").warnOnce("Image export for basis compressed textures not available."):c.uri=E.imageToDataURI(a);break;default:F.isEncodedMeshTexture(a)?D.getLogger("gltf").warnOnce("Image export for basis compressed textures not available."):e.promises.push(E.imageToArrayBuffer(a).then(({data:m,type:q})=>{c.uri=m;c.mimeType=q}))}}a=this.gltf.images.length;this.gltf.images.push(c);this._imageMap.set(b,
a);return a}_addSampler(b){this.gltf.samplers||(this.gltf.samplers=[]);var a=k.TextureWrapMode.REPEAT;let c=k.TextureWrapMode.REPEAT;if("string"===typeof b.wrap)switch(b.wrap){case "clamp":c=a=k.TextureWrapMode.CLAMP_TO_EDGE;break;case "mirror":c=a=k.TextureWrapMode.MIRRORED_REPEAT}else{switch(b.wrap.vertical){case "clamp":c=k.TextureWrapMode.CLAMP_TO_EDGE;break;case "mirror":c=k.TextureWrapMode.MIRRORED_REPEAT}switch(b.wrap.horizontal){case "clamp":a=k.TextureWrapMode.CLAMP_TO_EDGE;break;case "mirror":a=
k.TextureWrapMode.MIRRORED_REPEAT}}b={wrapS:a,wrapT:c};for(a=0;a<this.gltf.samplers.length;++a)if(JSON.stringify(b)===JSON.stringify(this.gltf.samplers[a]))return a;a=this.gltf.samplers.length;this.gltf.samplers.push(b);return a}_addAccessor(b,a){this.gltf.accessors||(this.gltf.accessors=[]);b={bufferView:b,byteOffset:a.byteOffset,componentType:a.componentType,count:a.count,type:a.type,min:a.min,max:a.max,name:a.name};a.normalized&&(b.normalized=!0);a=this.gltf.accessors.length;this.gltf.accessors.push(b);
return a}_addMeshVertexIndexed(b,a,c,e,g,m,q,t){const d=new Map;for(const f of a){b.startAccessor("INDICES");for(a=0;a<f.faces.length;++a)b.push(f.faces[a]);a=b.endAccessor();a={attributes:{POSITION:e},indices:this._addAccessor(b.index,a),material:this._addMaterial(f.material)};g&&"flat"!==f.shading&&(a.attributes.NORMAL=g);m&&(a.attributes.TEXCOORD_0=m);q&&"flat"!==f.shading&&(a.attributes.TANGENT=q);t&&(a.attributes.COLOR_0=t);const l=d.get(f.name);l?l.primitives.push(a):(a={name:f.name,primitives:[a]},
d.set(f.name,a),c.push(a))}}_addMeshVertexNonIndexed(b,a,c,e,g,m,q){const t={primitives:[]};a.push(t);a={attributes:{POSITION:c}};e&&(a.attributes.NORMAL=e);g&&(a.attributes.TEXCOORD_0=g);m&&(a.attributes.TANGENT=m);q&&(a.attributes.COLOR_0=q);b&&(a.material=this._addMaterial(b[0].material));t.primitives.push(a)}}const O=J.create();I.GLTF=Y;Object.defineProperty(I,Symbol.toStringTag,{value:"Module"})});