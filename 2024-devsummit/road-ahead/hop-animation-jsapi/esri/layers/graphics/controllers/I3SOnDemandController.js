// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/has ../../../core/Logger ../../../core/PooledArray ../../../core/Promise ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../geometry/projection/projectBoundingRect ../../../geometry/support/aaBoundingRect ../dehydratedPoint ../../support/PromiseQueue ../../../views/ViewingMode ../../../views/3d/layers/i3s/I3SClientNodeLoader ../../../views/3d/layers/i3s/I3SFrameTask ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNode ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SStreamDataController ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SViewportQueries ../../../views/3d/layers/support/I3SLayerView ../../../views/3d/support/extentUtils ../../../views/3d/support/index ../../../views/3d/support/MemoryController ../../../views/support/layerViewUtils ../../../views/support/Scheduler".split(" "),
function(h,g,M,r,u,N,v,l,k,aa,O,H,y,P,Q,I,R,S,T,U,q,V,J,z,W,X,Y,A,K,B,Z){function C(a,b){return null!=a&&a.length===b.length&&a.every(c=>0<=D(b,c.name))}function D(a,b){b=b.toLowerCase();for(let c=0;c<a.length;c++)if(a[c].name.toLowerCase()===b)return c;return-1}g=class extends N.EsriPromiseMixin(g){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&
(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const a=this.layerView.view.resourceController.createStreamDataRequester(A.ClientType.I3S_INDEX);return new J.I3SStreamDataController(a,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const a=this.layerView.view.resourceController.createStreamDataRequester(A.ClientType.I3S_DATA);return new J.I3SStreamDataController(a,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return z.getVertexCrs(this.layer)}get crsIndex(){return z.getIndexCrs(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const a=
this._index.rootNode;if(a)return this._updateViewData(),this._index.isNodeVisible(a.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(a){super(a);this.screenSizeFactor=0;this.featureTarget=5E4;this.fixedFeatureTarget=!1;this.updating=!0;this.updatingProgress=1;this.leavesReached=!1;this.scaleVisibilityEnabled=!0;this.worker=null;this._featureLOD=1;this._isIdle=this._stableFeatureLOD=!1;this._cameraDirty=!0;this._invisibleDirty=!1;this._idleStateCallbacks=
null;this._newLoadingNodes=new u({deallocator:null});this._loadedNodeScales=new Map;this._modificationsNodeFilteringArray=new u;this._downloadingCount=0;this._loadingNodes=new Map;this._updatingNodes=new Map;this._progressMaxNumNodes=1;this._requiredAttributes=[];this._requiredAttributesDirty=!0;this._restartNodeLoading=this._disableMemCache=this.disableIDBCache=this._updatesDisabled=!1;this._attributeStorageInfo=this._fields=null;this._idleQueue=new Q.PromiseQueue;this._elevationUpdateNodes=new u({deallocator:null});
this._errorCount=0}initialize(){const {layerView:a,layer:b}=this;this._disableMemCache=!a.loadCachedGPUData||!a.addCachedGPUData;this._lodHandling=new U(a);this._defaultGeometrySchema=b.store.defaultGeometrySchema;this.disableIDBCache=M("disable-feature:idb-cache");"fields"in b&&(this._fields=b.fields,this._attributeStorageInfo=b.attributeStorageInfo);this.addResolvingPromise(Promise.all([b.indexInfo,b.when(),a.when()]).then(([c])=>{if(!this.destroyed&&a&&!a.destroyed&&c){var {view:d,clientGeometry:f}=
a,{resourceController:m}=d;this._setClippingArea(d.clippingArea);this.addHandles([l.watch(()=>d?.pointsOfInterest?.focus?.renderLocation,e=>this._pointOfInterestChanged(e),l.initial),l.watch(()=>d.quality,()=>this._setCameraDirty(),l.sync),l.watch(()=>a.contentVisible,e=>{const n=e?()=>this._updateIdleState(!0):()=>this._updateViewData(),w=e?()=>this._updateIdleState(!1):()=>{};e&&null!=this._index&&this._index.invalidateAllElevationRanges();this._idleStateCallbacks?(e||this.cancelNodeLoading(),this.restartNodeLoading(),
this._idleStateCallbacks.idleBegin=n,this._idleStateCallbacks.idleEnd=w):this._idleStateCallbacks=m.scheduler.registerIdleStateCallbacks(n,w)},l.initial),S.addCallback(a.view.resourceController.scheduler,this),l.watch(()=>a.uncompressedTextureDownsamplingEnabled,()=>this.restartNodeLoading()),l.watch(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty();this._stableFeatureLOD=!1}),l.watch(()=>d.state?.contentCamera,()=>this._setCameraDirty()),l.watch(()=>b.elevationInfo,e=>
this._elevationInfoChanged(e)),l.watch(()=>b.effectiveScaleRange,()=>this._scaleBoundsChanged()),l.watch(()=>a.lodFactor,()=>this._setCameraDirty()),l.watch(()=>a.availableFields,()=>this._requiredFieldsChange()),l.watch(()=>a.holeFilling,e=>null!=this._index&&(this._index.holeFilling=e))]);this._updateScaleHandles();this._viewportQueries=new W(this.crsIndex,d.renderCoordsHelper,d.state.contentCamera,!d.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?d.basemapTerrain:
d.elevationProvider,I.viewingModeFromString(d.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:.5>this._lod});this._clientNodeLoader=new R.I3SClientNodeLoader(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:d.renderCoordsHelper.spatialReference,localMode:"local"===d.viewingMode},d.resourceController.memoryController,this.worker);this._index=new T.I3SIndex(I.viewingModeFromString(d.viewingMode),
b,c,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,r.getLogger(this),a.holeFilling,e=>a.isNodeLoaded(e),e=>a.isNodeReloading(e),e=>this._shouldLoadNode(e),e=>this._enableFromGPUCache(e,q.NodeState.Leaf),e=>this._needsUpdate(e),()=>!this.indexStreamController.busy,e=>a.computeVisibilityObb?.(e)??null,a?.computeNodeFiltering?e=>a.computeNodeFiltering(e):void 0);this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D);this._index.imModificationsChanged(!!a.hasModifications);
this._index.layerFilterChanged(!!a.hasGeometryFilter);if(null!=f){for(const e of f)this._addMesh(e.mesh,e.oid);this.addHandles(f.on("change",e=>{for(const n of e.removed)this._removeMesh(n.oid);for(const n of e.added)this._addMesh(n.mesh,n.oid)}))}this._startNodeLoading()}}));this._tmpPoint=P.makeDehydratedPoint(0,0,0,this.crsIndex)}updateNodeModificationStatus(a){const b=this._index,c=this.layerView;null!=b&&c?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),a.forAll(d=>
{d=b.getNode(d);null!=d&&this._modificationsNodeFilteringArray.push(d)}),c.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading();this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null);this._nodeLoader=null;p.prune();null!=E&&(E.hide(),E=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];
const a=this._attributeStorageInfo,b=this._fields,c=this.layer.objectIdField;return this.layerView.availableFields.map(d=>{const f=D(a,d);d=D(b,d);return 0<=f&&0<=d?{index:f,name:b[d].name,field:b[d],attributeStorageInfo:a[f]}:null}).filter(d=>null!=d&&d.name!==c)}_requiredFieldsChange(){const a=this._getRequiredAttributes();C(this._requiredAttributes,a)||(this._requiredAttributes=a,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0;this.restartNodeLoading()}_setClippingArea(a){const b=
y.create();Y.toBoundingRect(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null}_pointOfInterestChanged(a){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(a),null!=this._index&&(this._index.progressiveLoadPenalty=L.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(a){this._setClippingArea(a);null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),
this._index.invalidateVisibilityCache());this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0;this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()}_addMesh(a,b){null!=this._index&&(a=this._clientNodeLoader.createMeshNodeInfo(a,b),b=this._index.addClientNodeToIndex(a.id,a.mbs),this._clientNodeLoader.addMeshNode(b,a),this._evaluateUpdating(),this.notifyChange("rootNodeVisible"))}_removeMesh(a){a=this._clientNodeLoader.getMeshNodeIndex(a);if(null!=a)if(null!=this._index)this._index.removeClientNodeFromIndex(a,
(b,c)=>{this.layerView.removeNode(c);this._loadedNodeScales.delete(c);this._clientNodeLoader.removeNode(b);this.layerView.deleteCachedNodeData&&null!=b&&this.layerView.deleteCachedNodeData(b);this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(c))},(b,c,d)=>{this._clientNodeLoader.updateNodeIndex(b,c,d);this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(c,d)}),this.notifyChange("rootNodeVisible");else throw Error("delayed removal of client side i3s node geometry not supported yet.");
}updateElevationChanged(a,b){const c=this._index;if(null==c?.rootNode||null==b)return null;this.crsIndex.equals(b)||(H.projectBoundingRect(a,b,x,this.crsIndex),a=x);const d=this._elevationUpdateNodes;d.clear();z.findIntersectingNodes(a,c.rootNode,c,f=>d.push(f.index));d.length&&(d.forAll(f=>c.updateElevationChanged(f)),this._setCameraDirty());return d}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(a){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(a):
null}_elevationInfoChanged(a){null!=this._index&&(this._index.updateElevationInfo(a,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}_updateScaleHandles(){this.removeHandles("scale-bounds");this._areScaleBoundsActive&&this.addHandles(this.layerView.view.basemapTerrain.on("scale-change",a=>this._scaleUpdateHandler(a)),"scale-bounds")}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear();this._updateScaleHandles();this._setCameraDirty()}_scaleUpdateHandler(a){this._updateScaleInBoundingRect(a.extent,
a.spatialReference);this._setCameraDirty()}_updateScaleInBoundingRect(a,b){const c=this._index;null!=c&&null!=c.rootNode&&H.projectBoundingRect(a,b,x,this.crsIndex)&&this._loadedNodeScales.forEach((d,f)=>{d=c.getNode(f);null!=d&&y.intersectsSphere(x,d.serviceMbsInIndexSR)&&this._loadedNodeScales.set(f,this._computeScale(d))})}restartNodeLoading(){this._restartNodeLoading=!0;this.cancelNodeLoading();this._evaluateUpdating()}schedule(a,b){return this._idleQueue.push(a,b)}reschedule(a,b){return this._idleQueue.unshift(a,
b)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const {minScale:a,maxScale:b}=B.extractSafeScaleBounds(this.layer);return this.scaleVisibilityEnabled&&(0<a||0<b)}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}async _loadNodeData(a,b){return 0>a.index?this._clientNodeLoader.loadNodeData(a.id,b):this._nodeLoader.loadNodeData(a,b)}async _loadAttributes(a,b,c){return(0>
a.index?this._clientNodeLoader:this._nodeLoader).loadAttributes(a,b,c)}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(a){this._disableMemCache=this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData?a:!0}runTask(a,b){if(!this.layerView.contentVisible)return this._updateViewData(),this._evaluateUpdating(),-Infinity;if(!this.layerView.visible||null==this._index)return-Infinity;this._processWithErrorLogging(a,b);return this._index.maxPriority}_processWithErrorLogging(a,
b){try{this._process(a,b)}catch(c){50>this._errorCount?r.getLogger(this).error(`Error during processing: ${c} at ${c.stack}`):50===this._errorCount&&r.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(a,b){this._restartNodeLoading&&this._startNodeLoading();null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(a)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&
(a.enabled=!1),a.run(()=>this._processIndex(a)),this._updateFeatureLOD(),a.run(()=>this._processCache(a)),this._isIntegratedMesh&&(a.enabled=!0),a.run(()=>this._processNodes(a,b)),this._idleQueue.runTask(a),a.run(()=>this._prefetchIndex()),b.numIndexLoading+=this._index.indexLoading,b.numNodesLoading+=this._downloadingCount,a.run(()=>this._lodHandling.lodGlobalHandling(a)),this._evaluateUpdating())}_processIndex(a){if(null==this._index)return!1;this._index.dirty&&(this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),
a,b=>this.updateNodeModificationStatus(b)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length)),a=this._index.featureEstimate.leavesReached,this._index.isLoading||a===this._get("leavesReached")||this._set("leavesReached",a));return this._index.load()}_prefetchIndex(){return null==this._index||0<this._loadingNodes.size||0<this._index.updates.add.length?
!1:this._index.prefetch()}_updateFeatureLOD(){if(this.useMaximumNumberOfFeatures&&null!=this._index&&null!=this._viewportQueries){var a=!this._index.isLoading,b=this.featureTarget*this._baseLOD,c=this._index.featureEstimate;c.estimate=c.estimate||b/2;if(500<this._index.indexMissing){if(1E-4>=this._featureLOD)return;this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(a&&c.estimate<b){if(c.leavesReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;this._featureLOD*=Math.min(10,Math.max(b/
c.estimate,1.001));a=this._lod;b=this._index.checkFeatureTarget(b,a);b!==a&&(this._featureLOD=b/this._baseLOD,this._stableFeatureLOD=!0)}else if(c.estimate>1.2*b||a&&c.estimate>b){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(c.estimate/b-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,Math.max(1E-4,this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this._lod);this._index.requestUpdate()}}_processCache(a){const b=this._index;if(null==b)return!1;
for(;0<this._newLoadingNodes.length&&!a.done;){var c=this._newLoadingNodes.pop();for(c=b.getParent(c);null!=c&&!this.layerView.isNodeLoaded(c.index)&&this._isNodeInScaleBounds(c);c=b.getParent(c.index))if(this._enableFromGPUCache(c,q.NodeState.Hole)){a.madeProgress();break}}return a.hasProgressed}_processNodes(a,b){if(null==this._index)return!1;let c=(this._isIdle?100:2)-this._loadingNodes.size;const d=this._index.updates;d.cancel.forEach(this._cancelNode,this);for(d.cancel=[];0<d.remove.length&&
!a.done;)this.layerView.removeNode(d.remove.pop()),a.madeProgress();for(;0<d.update.length&&!a.done;){var f=this._index.getNode(d.update.pop());null!=f&&(this._updateLoadedNode(f),a.madeProgress())}for(;0<d.add.length&&!a.done&&0<c;){--c;f=this._index.getNode(d.add.back());if(null==f||f.cacheState!==q.CacheState.Cached&&!this._hasNodeLoadToken(b))break;d.add.pop();this._loadNode(f);a.madeProgress()}return a.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach(a=>a.abort());this._loadingNodes.clear();
this._updatingNodes.forEach(a=>a.abort());this._updatingNodes.clear()}_cancelNode(a){const b=this._loadingNodes.get(a);b&&(b.abort(),this._loadingNodes.delete(a))}_hasNodeLoadToken(a){return!this._isIdle&&2<=a.numNodesLoading+this._loadingNodes.size?!1:this._downloadingCount<A.maxDownloadSlots&&!this.dataStreamController.busy}_evaluateUpdating(){let a=!1;var b=0;this.layerView&&(this.layerView.contentVisible?(b=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:
0)+2*this._loadingNodes.size,a=!!(0<b||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===b&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(b,this._progressMaxNumNodes),b=1-b/this._progressMaxNumNodes):b=(a=this._cameraDirty)?0:1,this.updating=a,this.updatingProgress=b)}_updateViewData(){if(this._cameraDirty&&null!=this._index&&
null!=this._viewportQueries){var a=this.layerView.view,{contentCamera:b,fixedContentCamera:c}=a.state;this.screenSizeFactor=1/(b.perScreenPixelRatio/2);this._viewportQueries.updateCamera(b,!c||this.isGraphics3D);this._viewportQueries.setPointOfInterest(a.pointsOfInterest.focus.renderLocation);this._viewportQueries.updateScreenSpaceErrorBias(this._lod);this._index.invalidateVisibilityCache();this._index.progressiveLoadPenalty=L.distancePenalty*this._viewportQueries.distCameraToPOI();this._index.requestUpdate();
this._stableFeatureLOD=!1;this._invisibleDirty=!0;this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}}_getProgressiveLoadFactor(){return 1>this.layerView.view.quality?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const a=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(0<a?a:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-K.minQuality)/(.5-K.minQuality)}isGeometryVisible(a){return!!this._index?.isGeometryVisible(a.index)}updateVisibility(a){this._index?.invalidateNodeVisibilityCache(a)}invalidateGeometryVisibility(a){this._index?.invalidateGeometryVisibility(a)}invalidateVisibilityObbs(){this._index?.invalidateVisibilityObbs()}modificationsChanged(){this._index?.imModificationsChanged(!!this.layerView.hasModifications);
this._invisibleDirty=!0}_shouldLoadNode(a){return this._lodHandling.shouldLoadNode(a)&&!this._shouldDropNode(a)&&null!=this._index&&this._index.isGeometryVisible(a.index)?this._isNodeInScaleBounds(a):!1}_shouldDropNode(a){if(null==this._viewportQueries)return!1;const b=this._lodDropFactor;return 1<=b||!this._lodHandling.hasNoVisibleChildren(a)?!1:Math.abs(this._viewportQueries.calcCameraDistanceToCenter(a))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*
b}_startNodeLoading(){this._restartNodeLoading=!1;const a=this._index;if(!this._updatesDisabled&&null!=a&&null!=this._viewportQueries){this._updateViewData();this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var b={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};
this._nodeLoader=new V(this.layer,this.dataStreamController,r.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,b);a.requestUpdate();this._lodHandling.startNodeLoading(c=>this._isNodeInScaleBounds(c),(c,d)=>this._removeNodes(c,d,t.fadeout),a,{maxLodLevel:this._viewportQueries.maxLodLevel});this._evaluateUpdating()}}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),
this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(a){const b=this._index;if(null==b||null==this._viewportQueries)return!1;p.clear();this.layerView.getLoadedNodeIndices(p);const c=0===this._viewportQueries.maxDistance,d=c?()=>!1:f=>this._shouldDropNode(f);p.filterInPlace(f=>{const m=b.getNode(f);return null==m||!b.isGeometryVisible(f)||d(m)||!this._isNodeInScaleBounds(m)});0<p.length&&this._lodHandling.setLodGlobalDirty();this._removeNodes(p,
a,t.pop);if(c&&1>this._lodDropFactor)return!1;if(0===p.length)return!0;p.clear();return!1}markNodeToRemove(a){p.push(a)}removeMarkedNodes(){this._removeNodes(p,Z.noBudget,t.pop)}_removeNodes(a,b,c){const d=a.length;if(0!==d&&!b.done){for(null!=this._index&&this._index.requestUpdate();0<a.length&&!b.done;){const f=a.pop(),m=this._index;c===t.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=m&&m.isGeometryVisible(f)?this.layerView.fadeNode(f,X.FadeDirection.FadeOut,!0):this.layerView.removeNode(f);
b.madeProgress()}if(0<this._loadedNodeScales.size)for(b=a.length;b<d;b++)this._loadedNodeScales.delete(a.data[b])}}_needsUpdate(a){if(a.resources.isEmpty||this._updatingNodes.has(a.index))return!1;a=this.layerView.getLoadedAttributes(a.index);return null!=a&&a!==this._requiredAttributes}async _updateLoadedNode(a){const b=new AbortController;this._updatingNodes.set(a.index,b);this._evaluateUpdating();try{const c=this.layerView.getLoadedAttributes(a.index);let d=null;d=C(c,this._requiredAttributes)?
this.layerView.getAttributeData(a.index):await this._loadAttributes(a,this._requiredAttributes,b.signal);await this.schedule(()=>this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:d},b.signal),b.signal)}catch(c){if(!v.isAbortError(c))return this.layerView.updateAttributes(a.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},b.signal)}this._updatingNodes.delete(a.index);this._evaluateUpdating()}_loadNode(a){if(this._loadingNodes.has(a.index))r.getLogger(this).error("already loading node "+
a.index);else{var b=new AbortController;this._loadingNodes.set(a.index,b);this._evaluateUpdating();this._loadAndAddNode(a,b.signal).then(c=>{c&&null!=this._index&&this._loadingNodes.get(a.index)===b&&(this._loadingNodes.delete(a.index),this._index.requestUpdate())}).catch(c=>{if(!v.isAbortError(c))throw c;}).finally(()=>{this._loadingNodes.get(a.index)===b&&this._loadingNodes.delete(a.index);this._evaluateUpdating()})}}_loadAndAddNode(a,b){return a.cacheState===q.CacheState.Uncached?this._loadUncached(a,
b).then(()=>!1):this._loadCached(a,b).then(c=>{if(c)return!1;a.cacheState=q.CacheState.Uncached;return!0}).catch(c=>v.isAbortError(c)?!1:(a.cacheState=q.CacheState.Uncached,!0))}_enableFromGPUCache(a,b){if(this._disableMemCache||null==this._index)return!1;if(b===q.NodeState.Hole&&!this._index.useNodeAsHole(a.index))return!0;const c=this._loadCachedGPUData(a);if(!c)return!1;this.layerView.addCachedGPUData(a,c,b);this._nodeAdded();return!0}_loadCachedGPUData(a){a=this.layerView.loadCachedGPUData(a.index);
if(null!=a?.attributeInfo&&C(a.attributeInfo.loadedAttributes,this._requiredAttributes))return a;this.layerView.deleteCachedGPUData(a);return null}_nodeAdded(){null!=this._index&&this._index.requestUpdate();this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()}updateLoadStatus(a,b){const c=this._index;null!=c&&c.updateChildrenLoaded(a,b?1:-1)}async _loadCached(a,b){if(this._enableFromGPUCache(a,q.NodeState.Leaf))return!0;const c=this.layerView;if(this.disableIDBCache||!c.loadCachedNodeData||
!c.addCachedNodeData)return!1;const d=(F,G)=>this._nodeLoader.loadTextures(a,F,G),f=(F,G)=>this._clientNodeLoader.loadTextures(a,F,G),m=0<=a.index?d:f,e=await this.schedule(()=>c.loadCachedNodeData(a,b,m),b);if(null==e)return!1;const n=this._requiredAttributes,w=await this.reschedule(()=>this._loadAttributes(a,n,b),b);await this.reschedule(()=>c.addCachedNodeData(a,e,{loadedAttributes:n,attributeData:w},b),b);this._nodeAdded();return!0}_loadUncached(a,b){this._downloadingCount++;return this._loadNodeData(a,
b).catch(c=>{this._downloadingCount--;throw c;}).then(c=>{this._downloadingCount--;return this.schedule(()=>this.layerView.addNode(a,c,b),b)}).then(()=>{this._nodeAdded();a.cacheState=q.CacheState.Cached}).catch(c=>{if(!v.isAbortError(c))throw r.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${a.id}'`,c),a.failed=!0,null!=this._index&&this._index.requestUpdate(),c;})}_updateIdleState(a){a!==this._isIdle&&(this._isIdle=a,this._evaluateUpdating(),a&&this._index&&null!=this._index&&
this._index.resetFailedNodes())}_getScale(a){if(this._loadedNodeScales.has(a.index))return this._loadedNodeScales.get(a.index);const b=this._computeScale(a);this.layerView.isNodeLoaded(a.index)&&this._loadedNodeScales.set(a.index,b);return b}_computeScale(a){this._tmpPoint.x=a.serviceMbsInIndexSR[0];this._tmpPoint.y=a.serviceMbsInIndexSR[1];this._tmpPoint.z=a.serviceMbsInIndexSR[2];return this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,a.serviceMbsInIndexSR[3])}_isNodeInScaleBounds(a){if(!this._areScaleBoundsActive)return!0;
a=this._getScale(a);const {minScale:b,maxScale:c}=B.extractSafeScaleBounds(this.layer);return B.scaleBoundsPredicate(a,b,c)}get test(){const a=this;return{index:this._index,set disableUpdates(b){(a._updatesDisabled=b)?a.cancelNodeLoading():a.requestUpdate()},set disableIDBCache(b){a.disableIDBCache=b},set ignoreServiceObb(b){null!=a._index&&(a._index.ignoreServiceObb=b)},shouldLoadNode:b=>a._shouldLoadNode(b)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty();this._evaluateUpdating();null!=
this._index&&this._index.requestUpdate()}geometryFilterChanged(a){const b=this._index;null!=b&&b.layerFilterChanged(a);this._setCameraDirty()}};h.__decorate([k.property({readOnly:!0})],g.prototype,"isMeshPyramid",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"isGraphics3D",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"useMaximumNumberOfFeatures",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"indexStreamController",null);h.__decorate([k.property({readOnly:!0})],
g.prototype,"dataStreamController",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"crsVertex",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"crsIndex",null);h.__decorate([k.property()],g.prototype,"screenSizeFactor",void 0);h.__decorate([k.property()],g.prototype,"featureTarget",void 0);h.__decorate([k.property()],g.prototype,"fixedFeatureTarget",void 0);h.__decorate([k.property()],g.prototype,"layerView",void 0);h.__decorate([k.property()],g.prototype,"layer",null);h.__decorate([k.property()],
g.prototype,"updating",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"running",null);h.__decorate([k.property()],g.prototype,"updatingProgress",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"leavesReached",void 0);h.__decorate([k.property({constructOnly:!0})],g.prototype,"scaleVisibilityEnabled",void 0);h.__decorate([k.property({constructOnly:!0})],g.prototype,"worker",void 0);h.__decorate([k.property({readOnly:!0,dependsOn:[]})],g.prototype,"rootNodeVisible",null);g=
h.__decorate([O.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],g);const p=new u({deallocator:null});let E;const L={factorIM:.2,factor3dObject:.05,distancePenalty:10},x=y.create();var t;(function(a){a[a.pop=0]="pop";a[a.fadeout=1]="fadeout"})(t||={});return g});