// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../core/arrayUtils ../../../core/Error ../../../core/Evented ../../../core/Logger ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../featureConversionUtils ./BoundsStore ./geometryUtils ./optimizedFeatureQueryEngineAdapter".split(" "),function(n,f,p,g,h,k,l,q,r,t){const u=h.create();class v{constructor(a){this.geometryInfo=a;this._boundsStore=new q.BoundsStore;this._featuresById=new Map;this._markedIds=new Set;this.events=new p;this.featureAdapter=t.optimizedFeatureQueryEngineAdapter}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let a=
0;this._featuresById.forEach(b=>{null!=b.geometry&&b.geometry.coords&&(a+=b.geometry.coords.length)});return{featureCount:this._featuresById.size,vertexCount:a/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(a){if(null==this.fullBounds)return null;const [b,c,d,e]=this.fullBounds;return{xmin:b,ymin:c,xmax:d,ymax:e,spatialReference:r.cleanFromGeometryEngine(a)}}add(a){this._add(a);this._emitChanged()}addMany(a){for(const b of a)this._add(b);this._emitChanged()}upsertMany(a){a=a.map(b=>this._upsert(b));
this._emitChanged();return a.filter(n.isSome)}clear(){this._featuresById.clear();this._boundsStore.clear();this._emitChanged()}removeById(a){a=this._featuresById.get(a);if(!a)return null;this._remove(a);this._emitChanged();return a}removeManyById(a){this._boundsStore.invalidateIndex();for(const b of a)(a=this._featuresById.get(b))&&this._remove(a);this._emitChanged()}forEachBounds(a,b){for(const c of a)(a=this._boundsStore.get(c.objectId))&&b(h.fromRect(u,a))}getFeature(a){return this._featuresById.get(a)}has(a){return this._featuresById.has(a)}forEach(a){this._featuresById.forEach(b=>
a(b))}forEachInBounds(a,b){this._boundsStore.forEachInBounds(a,c=>{b(this._featuresById.get(c))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex();this._markedIds.clear()}sweep(){let a=!1;this._featuresById.forEach((b,c)=>{this._markedIds.has(c)||(a=!0,this._remove(b))});this._markedIds.clear();a&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(a){if(a){var b=a.objectId;if(null==b)g.getLogger("esri.layers.graphics.data.FeatureStore").error(new f("featurestore:invalid-feature",
"feature id is missing",{feature:a}));else{var c=this._featuresById.get(b);this._markedIds.add(b);if(c){a.displayId=c.displayId;var d=this._boundsStore.get(b);this._boundsStore.delete(b)}else if(null!=this.onFeatureAdd)this.onFeatureAdd(a);a.geometry?.coords?.length?(d=l.getBoundsOptimizedGeometry(null!=d?d:k.create(),a.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=d&&this._boundsStore.set(b,d)):this._boundsStore.set(b,null);this._featuresById.set(b,a)}}}_upsert(a){const b=a?.objectId;
if(null==b)return g.getLogger("esri.layers.graphics.data.FeatureStore").error(new f("featurestore:invalid-feature","feature id is missing",{feature:a})),null;const c=this._featuresById.get(b);if(!c)return this._add(a),a;this._markedIds.add(b);const {geometry:d,attributes:e}=a;for(const m in e)c.attributes[m]=e[m];d&&(c.geometry=d,this._boundsStore.set(b,l.getBoundsOptimizedGeometry(k.create(),d,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null));return c}_remove(a){if(null!=this.onFeatureRemove)this.onFeatureRemove(a);
const b=a.objectId;this._markedIds.delete(b);this._boundsStore.delete(b);this._featuresById.delete(b);return a}}return v});