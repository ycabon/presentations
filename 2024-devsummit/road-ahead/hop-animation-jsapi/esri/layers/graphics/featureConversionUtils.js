// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/Logger ../../core/maybe ../../geometry/support/aaBoundingBox ../../geometry/support/aaBoundingRect ../../geometry/support/jsonUtils ./OptimizedFeature ./OptimizedFeatureSet ./OptimizedGeometry".split(" "),function(p,F,pa,qa,da,ra,I,C,sa,z){function v(a,b){return a?b?4:3:b?3:2}function J(a,b,c,d){if(a){if(c)return b&&d?ta:ea;if(b&&d)return ua}else if(b&&d)return ea;return va}function K({scale:a,translate:b},c){return Math.round((c-b[0])/a[0])}function L({scale:a,
translate:b},c){return Math.round((b[1]-c)/a[1])}function D({scale:a,translate:b},c,d){return c*a[d]+b[d]}function M(a){a=a.coords;return{x:a[0],y:a[1]}}function fa(a,b){a.coords[0]=b.x;a.coords[1]=b.y;return a}function N(a){a=a.coords;return{x:a[0],y:a[1],z:a[2]}}function wa(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=b.z;return a}function O(a){a=a.coords;return{x:a[0],y:a[1],m:a[2]}}function xa(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=b.m;return a}function P(a){a=a.coords;return{x:a[0],
y:a[1],z:a[2],m:a[3]}}function ya(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=b.z;a.coords[3]=b.m;return a}function Q(a,b){return a&&b?ya:a?wa:b?xa:fa}function ha(a,b,c,d,e){c=Q(c,d);for(const {geometry:f,attributes:g}of b)b=null!=f?c(new z,f):null,a.push(new C.OptimizedFeature(b,g,null,e?g[e]:void 0));return a}function ia(a,b,c=Q(null!=b.z,null!=b.m)){return c(a,b)}function ja(a,b,c,d){for(const {geometry:e,attributes:f}of b)a.push({attributes:f,geometry:null!=e?R(e,c,d):null});return a}function R(a,
b,c){if(null==a)return null;const d=v(b,c),e=[];for(let f=0;f<a.coords.length;f+=d){const g=[];for(let h=0;h<d;h++)g.push(a.coords[f+h]);e.push(g)}return b?c?{points:e,hasZ:b,hasM:c}:{points:e,hasZ:b}:c?{points:e,hasM:c}:{points:e}}function ka(a,b,c,d,e){c=v(c,d);for(const {geometry:f,attributes:g}of b)b=null!=f?S(new z,f,c):null,a.push(new C.OptimizedFeature(b,g,null,e?g[e]:void 0));return a}function S(a,b,c=v(b.hasZ,b.hasM)){a.lengths[0]=b.points.length;const d=a.coords;let e=0;for(const f of b.points)for(b=
0;b<c;b++)d[e++]=f[b];return a}function T(a,b,c){if(!a)return null;const d=v(b,c),{coords:e,lengths:f}=a;a=[];let g=0;for(const h of f){const k=[];for(let m=0;m<h;m++){const l=[];for(let n=0;n<d;n++)l.push(e[g++]);k.push(l)}a.push(k)}return b?c?{paths:a,hasZ:b,hasM:c}:{paths:a,hasZ:b}:c?{paths:a,hasM:c}:{paths:a}}function la(a,b,c,d,e){c=v(c,d);for(const {geometry:f,attributes:g,centroid:h}of b)b=null!=f?U(new z,f,c):null,d=null!=h?ia(new z,h):null,a.push(new C.OptimizedFeature(b,g,d,e?g[e]:void 0));
return a}function U(a,b,c=v(b.hasZ,b.hasM)){const {lengths:d,coords:e}=a;let f=0;for(const g of b.paths){for(const h of g)for(b=0;b<c;b++)e[f++]=h[b];d.push(g.length)}return a}function V(a,b,c){if(!a)return null;const d=v(b,c),{coords:e,lengths:f}=a;a=[];let g=0;for(const h of f){const k=[];for(let m=0;m<h;m++){const l=[];for(let n=0;n<d;n++)l.push(e[g++]);k.push(l)}a.push(k)}return b?c?{rings:a,hasZ:b,hasM:c}:{rings:a,hasZ:b}:c?{rings:a,hasM:c}:{rings:a}}function W(a,b,c=b.hasZ,d=b.hasM){return ma(a,
b.rings,c,d)}function ma(a,b,c,d){c=v(c,d);const {lengths:e,coords:f}=a;d=0;A(a);for(const g of b){for(const h of g)for(b=0;b<c;b++)f[d++]=h[b];e.push(g.length)}return a}function X(a,b,c,d,e,f){y(a);if(!c){for(const g of b)a.push(new C.OptimizedFeature(null,g.attributes,null,f?g.attributes[f]:void 0));return a}switch(c){case "esriGeometryPoint":return ha(a,b,d,e,f);case "esriGeometryMultipoint":return ka(a,b,d,e,f);case "esriGeometryPolyline":return la(a,b,d,e,f);case "esriGeometryPolygon":for(const {geometry:g,
centroid:h,attributes:k}of b)b=null!=g?W(new z,g,d,e):null,c=f?k[f]:void 0,null!=h?a.push(new C.OptimizedFeature(b,k,fa(new z,h),c)):a.push(new C.OptimizedFeature(b,k,null,c));break;default:G().error("convertToFeatureSet:unknown-geometry",new F(`Unable to parse unknown geometry type '${c}'`)),y(a)}return a}function na(a,b,c,d){a=a&&("coords"in a?a:a.geometry);if(null==a)return null;switch(b){case "esriGeometryPoint":return b=M,c&&d?b=P:c?b=N:d&&(b=O),b(a);case "esriGeometryMultipoint":return R(a,
c,d);case "esriGeometryPolyline":return T(a,c,d);case "esriGeometryPolygon":return V(a,c,d);default:return G().error("convertToGeometry:unknown-geometry",new F(`Unable to parse unknown geometry type '${b}'`)),null}}function Y(a,b,c,d,e){y(a);if(null==c){for(const g of b)a.push({attributes:g.attributes});return a}switch(c){case "esriGeometryPoint":c=M;d&&e?c=P:d?c=N:e&&(c=O);for(var f of b){const {geometry:g,attributes:h}=f;d=null!=g?c(g):null;a.push({attributes:h,geometry:d})}break;case "esriGeometryMultipoint":return ja(a,
b,d,e);case "esriGeometryPolyline":for(const {geometry:g,attributes:h}of b)a.push({attributes:h,geometry:null!=g?T(g,d,e):null});break;case "esriGeometryPolygon":for(const {geometry:g,attributes:h,centroid:k}of b)f=null!=g?V(g,d,e):null,null!=k?(b=M(k),a.push({attributes:h,centroid:b,geometry:f})):a.push({attributes:h,geometry:f});break;default:G().error("convertToFeatureSet:unknown-geometry",new F(`Unable to parse unknown geometry type '${c}'`))}return a}function Z(a,b,c,d,e,f,g=c,h=d){A(a);if(!b?.coords.length)return null;
e=aa[e];const {coords:k,lengths:m}=b;b=v(c,d);const l=v(c&&g,d&&h);c=J(c,d,g,h);if(!m.length)return c(a.coords,k,0,0,K(f,k[0]),L(f,k[1])),A(a,b,0),a;let n,q=0,r,u=0;for(const w of m){if(w<e)continue;let t=0;r=u;h=d=K(f,k[q]);n=g=L(f,k[q+1]);c(a.coords,k,r,q,h,n);t++;q+=b;r+=l;for(let x=1;x<w;x++,q+=b)if(h=K(f,k[q]),n=L(f,k[q+1]),h!==d||n!==g)c(a.coords,k,r,q,h-d,n-g),r+=l,t++,d=h,g=n;t>=e&&(a.lengths.push(t),u=r)}y(a.coords,u);return a.coords.length?a:null}function ba(a,b,c,d,e,f,g){let h=d,k=0;for(let l=
f+c;l<g;l+=c){var m=b[l];const n=b[l+1],q=b[g],r=b[g+1];let u=b[f],w=b[f+1],t=q-u,x=r-w;if(0!==t||0!==x){const B=((m-u)*t+(n-w)*x)/(t*t+x*x);1<B?(u=q,w=r):0<B&&(u+=t*B,w+=x*B)}t=m-u;x=n-w;m=t*t+x*x;m>h&&(k=l,h=m)}h>d&&(k-f>c&&ba(a,b,c,d,e,f,k),e(a,b,a.length,k,b[k],b[k+1]),g-k>c&&ba(a,b,c,d,e,k,g))}function ca(a,b,c,d,e){const {coords:f,lengths:g}=b;c=v(c,d);if(!f.length)return a!==b&&A(a),a;qa.assertIsSome(e);const {originPosition:h,scale:k,translate:m}=e;e=za;e.originPosition=h;d=e.scale;d[0]=k[0]??
1;d[1]=-(k[1]??1);d[2]=k[2]??1;d[3]=k[3]??1;var l=e.translate;l[0]=m[0]??0;l[1]=m[1]??0;l[2]=m[2]??0;l[3]=m[3]??0;if(!g.length){for(d=0;d<c;++d)a.coords[d]=D(e,f[d],d);a!==b&&A(a,c,0);return a}l=0;for(let q=0;q<g.length;q++){const r=g[q];a.lengths[q]=r;for(var n=0;n<c;++n)a.coords[l+n]=D(e,f[l+n],n);n=a.coords[l];let u=a.coords[l+1];l+=c;for(let w=1;w<r;w++,l+=c){n+=f[l]*d[0];u+=f[l+1]*d[1];a.coords[l]=n;a.coords[l+1]=u;for(let t=2;t<c;++t)a.coords[l+t]=D(e,f[l+t],t)}}a!==b&&A(a,f.length,g.length);
return a}function oa(a,b,c,d){let e=0,f=a[d*b],g=a[d*(b+1)];for(let h=1;h<c;h++){const k=f+a[d*(b+h)],m=g+a[d*(b+h)+1],l=(k-f)*(m+g);f=k;g=m;e+=l}return.5*e}function A(a,b=0,c=0){y(a.lengths,c);y(a.coords,b)}function y(a,b=0){a.length!==b&&(a.length=b)}const G=()=>pa.getLogger("esri.layers.graphics.featureConversionUtils"),aa={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},va=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f},ea=(a,b,c,d,e,f)=>{a[c]=
e;a[c+1]=f;a[c+2]=b[d+2]},ua=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f;a[c+2]=b[d+3]},ta=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f;a[c+2]=b[d+2];a[c+3]=b[d+3]},E=[],H=[],za={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};p.convertFromFeature=function(a,b,c,d,e){E[0]=a;[a]=X(H,E,b,c,d,e);y(E);y(H);return a};p.convertFromFeatureSet=function(a,b){const c=new sa,{hasM:d,hasZ:e,features:f,objectIdFieldName:g,spatialReference:h,geometryType:k,exceededTransferLimit:m,transform:l,fields:n}=a;n&&(c.fields=n);
c.geometryType=k??null;c.objectIdFieldName=g??b??null;c.spatialReference=h??null;if(!c.objectIdFieldName)return G().error(new F("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),c;f&&X(c.features,f,k,e,d,c.objectIdFieldName);m&&(c.exceededTransferLimit=m);d&&(c.hasM=d);e&&(c.hasZ=e);l&&(c.transform=l);return c};p.convertFromFeatures=X;p.convertFromGeometry=function(a,b,c){if(null==a)return null;const d=new z;"hasZ"in a&&null==b&&(b=a.hasZ);"hasM"in a&&null==c&&(c=a.hasM);
if(I.isPoint(a))return Q(null!=b?b:null!=a.z,null!=c?c:null!=a.m)(d,a);if(I.isPolygon(a))return W(d,a,b,c);if(I.isPolyline(a))return U(d,a,v(b,c));if(I.isMultipoint(a))return S(d,a,v(b,c));G().error("convertFromGeometry:unknown-geometry",new F(`Unable to parse unknown geometry type '${a}'`))};p.convertFromMultipoint=S;p.convertFromMultipointFeatures=ka;p.convertFromNestedArray=ma;p.convertFromPoint=ia;p.convertFromPointFeatures=ha;p.convertFromPolygon=W;p.convertFromPolyline=U;p.convertFromPolylineFeatures=
la;p.convertToFeature=function(a,b,c,d){H[0]=a;Y(E,H,b,c,d);a=E[0];y(E);y(H);return a};p.convertToFeatureSet=function(a){const {objectIdFieldName:b,spatialReference:c,transform:d,fields:e,hasM:f,hasZ:g,features:h,geometryType:k,exceededTransferLimit:m,uniqueIdField:l,queryGeometry:n,queryGeometryType:q}=a;a=Y([],h,k,g,f);const r=na(n,q,!1,!1);a={features:a,fields:e,geometryType:k,objectIdFieldName:b,spatialReference:c,uniqueIdField:l,queryGeometry:r};d&&(a.transform=d);m&&(a.exceededTransferLimit=
m);f&&(a.hasM=f);g&&(a.hasZ=g);return a};p.convertToFeatures=Y;p.convertToGeometry=na;p.convertToMultipoint=R;p.convertToMultipointFeatures=ja;p.convertToPoint=function(a,b,c){return a?b?c?P(a):N(a):c?O(a):M(a):null};p.convertToPolygon=V;p.convertToPolyline=T;p.deltaDecodeGeometry=function(a,b){if(null==a)return null;const c=a.clone(),d=a.coords;a=a.lengths;let e=0;for(let h=0;h<a.length;h++){const k=a[h];var f=d[b*e],g=d[b*e+1];for(let m=1;m<k;m++)f+=d[b*(e+m)],g+=d[b*(e+m)+1],c.coords[b*(e+m)]=
f,c.coords[b*(e+m)+1]=g;e+=k}return c};p.deltaEncodeGeometry=function(a,b){const c=a.clone(),d=a.coords;a=a.lengths;let e=0;for(let g=0;g<a.length;g++){const h=a[g];let k=d[b*e];var f=d[b*e+1];for(let m=1;m<h;m++){const l=d[b*(e+m)],n=d[b*(e+m)+1];f=n-f;c.coords[b*(e+m)]=l-k;c.coords[b*(e+m)+1]=f;k=l;f=n}e+=h}return c};p.generalizeOptimizedGeometry=function(a,b,c,d,e,f,g=c,h=d){A(a);if(!b?.coords.length)return null;e=aa[e];const {coords:k,lengths:m}=b;b=v(c,d);const l=v(c&&g,d&&h);c=J(c,d,g,h);if(!m.length)return c(a.coords,
k,0,0,k[0],k[1]),A(a,b,0),a;d=0;f*=f;for(const n of m){if(n<e){d+=n*b;continue}g=a.coords.length/l;h=d;const q=d+(n-1)*b;c(a.coords,k,a.coords.length,h,k[h],k[h+1]);ba(a.coords,k,b,f,c,h,q);c(a.coords,k,a.coords.length,q,k[q],k[q+1]);h=a.coords.length/l-g;h>=e?a.lengths.push(h):y(a.coords,g*l);d+=n*b}return a.coords.length?a:null};p.getBoundsOptimizedGeometry=function(a,b,c,d){if(!b?.coords?.length)return null;c=v(c,d);let e=d=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,g=Number.NEGATIVE_INFINITY;
if(b&&b.coords){b=b.coords;for(let h=0;h<b.length;h+=c){const k=b[h],m=b[h+1];d=Math.min(d,k);f=Math.max(f,k);e=Math.min(e,m);g=Math.max(g,m)}}da.is(a)?da.fromRectValues(a,d,e,f,g):ra.fromValues(d,e,f,g,a);return a};p.getQuantizedArea=function(a,b){const {coords:c,lengths:d}=a;let e=a=0;for(let f=0;f<d.length;f++){const g=d[f];e+=oa(c,a,g,b);a+=g}return Math.abs(e)};p.getQuantizedBoundsOptimizedGeometry=function(a,b,c,d){c=v(c,d);const {lengths:e,coords:f}=b;d=b=Number.POSITIVE_INFINITY;let g=Number.NEGATIVE_INFINITY,
h=Number.NEGATIVE_INFINITY,k=0;for(const m of e){let l=f[k],n=f[k+1];b=Math.min(l,b);d=Math.min(n,d);g=Math.max(l,g);h=Math.max(n,h);k+=c;for(let q=1;q<m;q++,k+=c){const r=f[k],u=f[k+1];l+=r;n+=u;0>r&&(b=Math.min(b,l));0<r&&(g=Math.max(g,l));0>u?d=Math.min(d,n):0<u&&(h=Math.max(h,n))}}a[0]=b;a[1]=d;a[2]=g;a[3]=h;return a};p.getSignedQuantizedRingArea=oa;p.quantizeOptimizedFeatureSet=function(a,b){const {geometryType:c,features:d,hasM:e,hasZ:f}=b;if(!a)return b;for(let g=0;g<d.length;g++){const h=
d[g],k=h.weakClone();k.geometry=new z;Z(k.geometry,h.geometry,e,f,c,a);h.centroid&&(k.centroid=new z,Z(k.centroid,h.centroid,e,f,"esriGeometryPoint",a));d[g]=k}b.transform=a;return b};p.quantizeOptimizedGeometry=Z;p.quantizeX=K;p.quantizeY=L;p.removeCollinearVertices=function(a,b,c,d,e){if(!b?.coords?.length)return null;c=aa[c];const {coords:f,lengths:g}=b;b=J(d,e,d,e);d=v(d,e);let h=e=0,k=0,m=0;for(const q of g){h=m;b(a.coords,f,h,e,f[e],f[e+1]);e+=d;var l=f[e];let r=f[e+1],u=l,w=r;var n=r/l;h+=
d;b(a.coords,f,h,e,u,w);e+=d;for(let t=2;t<q;t++){l=f[e];r=f[e+1];const x=r/l,B=n===x||!isFinite(n)&&!isFinite(x);n=B&&isFinite(x)?0<=n&&0<=x||0>=n&&0>=x:0<=w&&0<=r||0>=w&&0>=r;B&&n?(u+=l,w+=r):(u=l,w=r,h+=d);b(a.coords,f,h,e,u,w);e+=d;n=x}h+=d;l=(h-m)/d;l>=c&&(a.lengths[k]=l,m=h,k++)}a.coords.length>m&&(a.coords.length=m);a.lengths.length>k&&(a.lengths.length=k);return a.coords.length&&a.lengths.length?a:null};p.removeZMValues=function(a,b,c,d,e,f){A(a);a.lengths.push(...b.lengths);if(c===e&&d===
f)for(var g=0;g<b.coords.length;g++)a.coords.push(b.coords[g]);else for(g=v(c,d),c=J(c,d,e,f),b=b.coords,d=0;d<b.length;d+=g)c(a.coords,b,a.coords.length,d,b[d],b[d+1]);return a};p.unquantizeOptimizedFeatureSet=function(a){const {transform:b,features:c,hasM:d,hasZ:e}=a;if(!b)return a;for(const f of c)null!=f.geometry&&ca(f.geometry,f.geometry,d,e,b),null!=f.centroid&&ca(f.centroid,f.centroid,d,e,b);a.transform=null;return a};p.unquantizeOptimizedGeometry=ca;p.unquantizeValue=D;p.unquantizeX=function(a,
b){return D(a,b,0)};p.unquantizeY=function(a,b){return D(a,-b,1)};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});