// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../geometry ../../PopupTemplate ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../renderers/support/types ../../core/workers/workers ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../geometry/projection ../../geometry/support/spatialReferenceUtils ../Layer ../graphics/data/FeatureStore ../graphics/data/QueryEngine ../graphics/sources/support/clientSideDefaults ./KnowledgeGraphLayerDataManager ./KnowledgeGraphSublayerBase ../mixins/BlendLayer ../mixins/FeatureReductionLayer ../mixins/RefreshableLayer ../mixins/ScaleRangeLayer ../support/commonProperties ../support/Field ../support/fieldUtils ../../rest/support/FeatureSet ../../rest/support/Query ../../support/popupUtils ../../core/workers/RemoteClient ../../geometry/Extent ../../geometry/Polygon ../../geometry/Polyline ../../geometry/support/typeUtils".split(" "),
function(e,d,v,N,O,P,Q,R,S,T,U,p,w,V,f,W,X,Y,x,l,m,y,z,A,n,q,B,C,D,E,F,G,t,H,I,k,J,K,u,L,M,h){d=class extends D.FeatureReductionLayer(B.KnowledgeGraphSublayerBase(C.BlendLayer(F.ScaleRangeLayer(E.RefreshableLayer(y))))){constructor(a){super(a);this.capabilities=n.createCapabilities(!1,!1);this.displayField=this.definitionExpression="";this.graphType=this.geometryFieldName=this.geometryType=this.elevationInfo=null;this.hasZ=this.hasM=!1;this.labelingInfo=this.labelsVisible=null;this.objectIdField=
q.mockOidFieldName;this.parentCompositeLayer=this.objectType=null;this.popupEnabled=!0;this.popupTemplate=null;this.source={openPorts:()=>this.load().then(()=>{const c=new MessageChannel;new K(c.port1,{channel:c,client:{queryFeatures:(g,r={})=>{g=k.fromJSON(g);return this.queryFeaturesJSON(g,r)}}});return[c.port2]})};this.type="knowledge-graph-sublayer";if("link-chart"===a.parentCompositeLayer.type)this.geometryType="relationship"===a.graphType?"polyline":"point",this.geometryFieldName=q.mockLayoutGeometryFieldName;
else if(a.parentCompositeLayer.dataManager.geographicLookup.get(a.objectType.name)?.geometryType&&"esriGeometryNull"!==a.parentCompositeLayer.dataManager.geographicLookup.get(a.objectType.name)?.geometryType){var b=a.parentCompositeLayer.dataManager.geographicLookup.get(a.objectType.name);this.geometryFieldName=b?.name??null;this.geometryType=b?.geometryType?h.featureGeometryTypeKebabDictionary.fromJSON(b.geometryType):null;(b=(b=b?.name)?a.objectType.properties?.[b]:null)?(this.hasM=b.hasM??!1,this.hasZ=
b.hasZ??!1):this.hasZ=this.hasM=!1}else this.geometryType=null;a.objectType.properties?.forEach(c=>{let g=c.fieldType;"esriFieldTypeOID"===g&&(g="esriFieldTypeInteger");this.fields.push(t.fromJSON({name:c.name,type:g,alias:c.alias,defaultValue:null,editable:c.editable,nullable:c.nullable}))});this.fields.push(t.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}));this._set("fields",[...this.fields]);a.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&
(this.spatialReference=a.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference);this.renderer="link-chart"===a.parentCompositeLayer.type?"relationship"===a.graphType?p.fromJSON(n.createDrawingInfo(h.featureGeometryTypeKebabDictionary.toJSON("polyline")).renderer):p.fromJSON(n.createDrawingInfo(h.featureGeometryTypeKebabDictionary.toJSON("point")).renderer):p.fromJSON(n.createDrawingInfo(h.featureGeometryTypeKebabDictionary.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(a){H.fixRendererFields(a,
this.fieldsIndex);this._set("renderer",a)}createPopupTemplate(a){return J.createPopupTemplate(this,a)}createQuery(){return new k({where:"1\x3d1",outFields:["*"]})}getField(a){for(let b=0;b<this.fields.length;b++)if(this.fields[b].name===a)return this.fields[b];throw Error("Field not found");}getFieldDomain(a,b){return null}async queryFeatures(a,b){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects(a);a=I.fromJSON(await g.executeQuery(c.toJSON(),b?.signal));a.features.forEach(r=>{r.sourceLayer=
this});return a}async queryFeaturesJSON(a,b){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects(a);return await g.executeQuery(c.toJSON(),b?.signal)}async queryFeatureCount(a,b){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects(a);return g.executeQueryForCount(c.toJSON(),b?.signal)}async queryExtent(a={},b){const {resolvedQuery:c,queryEngine:g}=await this._setupQueryObjects({...a,returnGeometry:!0});a=await g.executeQueryForExtent(c.toJSON(),b?.signal);b=null!=a.extent?.xmin&&
null!=a.extent?.xmax&&null!=a.extent?.ymin&&null!=a.extent?.ymax?new u(a.extent):new u;return{count:a.count,extent:b}}async queryObjectIds(a,b){a=k.from(a);if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)var c=this._cachedQueryEngine;else c=await this.parentCompositeLayer.dataManager.getData(a,this,b),c=this.loadQueryEngine(c);return c.executeQueryForIds(a.toJSON(),b?.signal)}loadQueryEngine(a){var b=new z({geometryType:h.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),
hasM:this.hasM,hasZ:this.hasZ});b=new A.QueryEngine({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:h.featureGeometryTypeKebabDictionary.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:b});b.featureStore.addMany(a);return b}async refreshCachedQueryEngine(){const a=await this.parentCompositeLayer.dataManager.getData(new k({where:"1\x3d1",outFields:[q.mockOidFieldName]}),this);this._cachedQueryEngine=
this.loadQueryEngine(a)}async _setupQueryObjects(a,b){a=k.from(a);const c=a.geometry;c&&!c.spatialReference?.isWGS84&&(await l.initializeProjection(c.spatialReference,m.wgs84),a.geometry=c instanceof L?l.project(c,m.wgs84):c instanceof M?l.project(c,m.wgs84):l.project(c.extent,m.wgs84));"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine?b=this._cachedQueryEngine:(b=await this.parentCompositeLayer.dataManager.getData(a,this,b),b=this.loadQueryEngine(b));return{resolvedQuery:a,queryEngine:b}}};
e.__decorate([f.property()],d.prototype,"capabilities",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);e.__decorate([f.property()],d.prototype,"definitionExpression",void 0);e.__decorate([f.property()],d.prototype,"displayField",void 0);e.__decorate([f.property()],d.prototype,"elevationInfo",void 0);e.__decorate([f.property()],d.prototype,"geometryType",void 0);e.__decorate([f.property()],d.prototype,"geometryFieldName",void 0);e.__decorate([f.property()],
d.prototype,"graphType",void 0);e.__decorate([f.property()],d.prototype,"hasM",void 0);e.__decorate([f.property()],d.prototype,"hasZ",void 0);e.__decorate([f.property()],d.prototype,"labelsVisible",void 0);e.__decorate([f.property()],d.prototype,"labelingInfo",void 0);e.__decorate([f.property()],d.prototype,"objectIdField",void 0);e.__decorate([f.property()],d.prototype,"objectType",void 0);e.__decorate([f.property()],d.prototype,"parentCompositeLayer",void 0);e.__decorate([f.property(G.popupEnabled)],
d.prototype,"popupEnabled",void 0);e.__decorate([f.property({type:v,json:{name:"popupInfo",write:!0}})],d.prototype,"popupTemplate",void 0);e.__decorate([f.property({types:w.rendererTypes,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],d.prototype,"renderer",null);e.__decorate([f.property()],d.prototype,"source",void 0);e.__decorate([f.property({json:{read:!1}})],d.prototype,"type",void 0);return d=e.__decorate([x.subclass("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],d)});