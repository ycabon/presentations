// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../core/Collection ../../core/CollectionFlattener ../../core/Error ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/utils ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/PropertyOrigin ../support/Sublayer ../support/sublayerUtils".split(" "),function(r,l,w,C,D,E,x,n,J,K,F,G,d,t,H){function I(g,a){const b=[],c={};if(!g)return b;
g.forEach(e=>{const h=new t;h.read(e,a);c[h.id]=h;null!=e.parentLayerId&&-1!==e.parentLayerId?(e=c[e.parentLayerId],e.sublayers||(e.sublayers=[]),e.sublayers.unshift(h)):b.unshift(h)});return b}function u(g,a){g&&g.forEach(b=>{a(b);b.sublayers&&b.sublayers.length&&u(b.sublayers,a)})}const v=w.ofType(t);r.SublayersOwner=g=>{g=class extends g{constructor(...a){super(...a);this.allSublayers=new C({getCollections:()=>[this.sublayers],getChildrenFunction(b){return b.sublayers}});this.sublayersSourceJSON=
{[d.OriginId.SERVICE]:{},[d.OriginId.PORTAL_ITEM]:{},[d.OriginId.WEB_SCENE]:{},[d.OriginId.WEB_MAP]:{}};this.addHandles(x.watch(()=>this.sublayers,(b,c)=>this._handleSublayersChange(b,c),x.sync))}destroy(){this.allSublayers.destroy()}readSublayers(a,b){if(b&&a){var {sublayersSourceJSON:c}=this,e=d.nameToId(b.origin);if(!(e<d.OriginId.SERVICE||(c[e]={context:b,visibleLayers:a.visibleLayers||c[e].visibleLayers,layers:a.layers||c[e].layers},e>d.OriginId.SERVICE))){this._set("serviceSublayers",this.createSublayersForOrigin("service").sublayers);
var {sublayers:h,origin:k}=this.createSublayersForOrigin("web-document");a=F.getProperties(this);a.setDefaultOrigin(k);this._set("sublayers",new v(h));a.setDefaultOrigin("user")}}}findSublayerById(a){return this.allSublayers.find(b=>b.id===a)}createServiceSublayers(){return this.createSublayersForOrigin("service").sublayers}createSublayersForOrigin(a){const b="web-document"===a?d.nameToId("web-map"):d.nameToId(a);let c=d.OriginId.SERVICE;a=this.sublayersSourceJSON[d.OriginId.SERVICE].layers;let e=
this.sublayersSourceJSON[d.OriginId.SERVICE].context,h=null;var k=[d.OriginId.PORTAL_ITEM,d.OriginId.WEB_SCENE,d.OriginId.WEB_MAP].filter(f=>f<=b);for(var p of k)k=this.sublayersSourceJSON[p],H.isSublayerOverhaul(k.layers)&&(c=p,a=k.layers,e=k.context,k.visibleLayers&&(h={visibleLayers:k.visibleLayers,context:k.context}));p=[d.OriginId.PORTAL_ITEM,d.OriginId.WEB_SCENE,d.OriginId.WEB_MAP].filter(f=>f>c&&f<=b);let m=null;for(var q of p){const {layers:f,visibleLayers:y,context:z}=this.sublayersSourceJSON[q];
f&&(m={layers:f,context:z});y&&(h={visibleLayers:y,context:z})}q=I(a,e);const A=new Map,B=new Set;if(m)for(const f of m.layers)A.set(f.id,f);if(h?.visibleLayers)for(const f of h.visibleLayers)B.add(f);u(q,f=>{m&&f.read(A.get(f.id),m.context);h&&f.read({defaultVisibility:B.has(f.id)},h.context)});return{origin:d.idToName(c),sublayers:new v({items:q})}}read(a,b){super.read(a,b);this.readSublayers(a,b)}_handleSublayersChange(a,b){b&&(b.forEach(c=>{c.parent=null;c.layer=null}),this.removeHandles("sublayers-owner"));
a&&(a.forEach(c=>{c.parent=this;c.layer=this}),this.addHandles([a.on("after-add",({item:c})=>{c.parent=this;c.layer=this}),a.on("after-remove",({item:c})=>{c.parent=null;c.layer=null})],"sublayers-owner"),"tile"===this.type&&this.addHandles(a.on("before-changes",c=>{E.getLogger("esri.layers.TileLayer").error(new D("tilelayer:sublayers-non-modifiable","ISublayer can't be added, moved, or removed from the layer's sublayers",{layer:this}));c.preventDefault()}),"sublayers-owner"))}};l.__decorate([n.property({readOnly:!0})],
g.prototype,"allSublayers",void 0);l.__decorate([n.property({readOnly:!0,type:w.ofType(t)})],g.prototype,"serviceSublayers",void 0);l.__decorate([n.property({value:null,type:v,json:{read:!1,write:{allowNull:!0,ignoreOrigin:!0}}})],g.prototype,"sublayers",void 0);l.__decorate([n.property({readOnly:!0})],g.prototype,"sublayersSourceJSON",void 0);return g=l.__decorate([G.subclass("esri.layers.mixins.SublayersOwner")],g)};r.forEachSublayer=u;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});