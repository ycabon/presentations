// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/math/mat3 ../../../geometry/Point ../../../geometry/projection ../../../geometry/support/webMercatorUtils ../../ElevationLayer ../core/ElevationSourceDefinitions ./utils".split(" "),function(B,O,J,P,Q,w,C,D,R,F,z){async function G(c,b,h=!1){if(h)return c;const {feature:{attributes:{cameraOrientation:m,elevationSource:f,cameraHeight:g,location:a}}}=b;return f&&(F.isConstantElevation(f)||
f.url?.length)?K(c,b):H(c,m&&"number"==typeof a.z?a.z-g:0)}async function K(c,b){const {feature:h,options:m,currentCoveragePolygon:f}=b;var g=h.attributes.elevationSource;if(!g)return c;if(F.isConstantElevation(g)){var {constantElevation:a}=g;return"number"!==typeof a?c:H(c,a)}({url:a}=g);if(!a)return c;var {elevationSample:p}=h;if(!p){b="esri.Graphic"===f?.declaredClass?f.geometry?.extent:f.extent;if(!b)return c;b=b.clone();b.xmin/=2;b.xmax*=2;b.ymin/=2;b.ymax*=2;const {error:x,isSupported:u}=await F.validateElevationSourceURL(a);
if(!u){J.getLogger(g).warn(x);const {location:n,cameraHeight:t,cameraOrientation:q}=h.attributes;return H(c,q&&"number"==typeof n.z?n.z-t:0)}g=new R(a);p=c;try{await g.load(),h.elevationSample=await g.createElevationSampler(b,m),p=c.map(L(h.elevationSample))}catch(n){P.isAbortError(n)||J.getLogger("esri.layers.orientedImagery.transformations.groundToImageUtils").warn(`#updateElevation() failed to update elevation using the provided elevation source URL: ${a}. Please provide a valid elevation source url.`,
n)}finally{g.destroy()}return p}await C.initializeProjection(c[0].spatialReference,p.spatialReference,null,b.options);return c.map(L(p))}function L(c){return b=>{b.z=1;const h=c.queryElevation(C.project(b,c.spatialReference));h?.z&&(b.z=h.z);return b}}function H(c,b){return c.map(h=>{h.z=b;return h})}function S(c,b){const {feature:h,imageProperties:m}=b,{width:f,height:g}=m,{attributes:a}=h;b=z.calculateRotationMatrix("HPR",[a.cameraHeading,a.cameraPitch,a.cameraRoll]);const p=Math.sin(a.imageRotation??
0*E),x=Math.cos(a.imageRotation??0*E),u=f??1,n=g??1,t=[Math.abs(x*u+p*n),Math.abs(x*n-p*u)],q=[-(1/(2*Math.tan(a.horizontalFieldOfView*E/2))),0,.5,0,1/(2*Math.tan(a.verticalFieldOfView*E/2)),.5,0,0,1];let r=new w(a.geometry);r.spatialReference.isWGS84&&4!==a.cameraOrientation?.type&&(r=D.geographicToWebMercator(r));const k=r.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*r.y/6378137))):1,d=Q.mul(Array(9),b,q);return c.map(e=>{var l=new w(e);l.spatialReference.isWGS84&&
(4===a.cameraOrientation?.type?(e=a.cameraOrientation,l=new w(z.geographicToLTP(l,[e.latitude,e.longitude,e.ellipsoidRadius,e.squaredEccentricity]))):l=new w(D.geographicToWebMercator(l)));e=(l.z??0)-(r.z??0);const v=(l.x-r.x)/k,y=(l.y-r.y)/k;l=(d[0]*v+d[1]*y+d[2]*e)/(d[6]*v+d[7]*y+d[8]*e)*t[0];e=(d[3]*v+d[4]*y+d[5]*e)/(d[6]*v+d[7]*y+d[8]*e)*t[1];return{x:x*(l-t[0]/2)+p*(e-t[1]/2)+u/2,y:-p*(l-t[0]/2)+x*(e-t[1]/2)+n/2}})}function T(c,b){var {feature:h}=b;const {attributes:m}=h;h=m.cameraOrientation;
if(!h)throw new O("groundToImageUtils:missing-camera-orientation-parameters","CameraOrientation Parameters are required to perform advanced transformations");let f=new w(m.location);f.spatialReference.isWGS84&&4!==m.cameraOrientation?.type&&(f=D.geographicToWebMercator(f));const g=f.spatialReference.isWebMercator?1/Math.cos(Math.PI/2-2*Math.atan(Math.exp(-1*f.y/6378137))):1;let a;if("esri.layers.orientedImagery.core.CameraOrientationOPK"===h.declaredClass){const {omega:q,phi:r,kappa:k}=h;a=z.calculateRotationMatrix("OPK",
[q,r,k])}else{const {cameraHeading:q,cameraPitch:r,cameraRoll:k}=m;a=z.calculateRotationMatrix("HPR",[q,r,k])}const {principalOffsetPoint:p,focalLength:x,radialDistortionCoefficients:u,affineTransformations:n,tangentialDistortionCoefficients:t}=h;return Promise.all(c.map(async q=>{function r(k){if(k.spatialReference.isWGS84)if(4===m.cameraOrientation?.type){var d=m.cameraOrientation;k=new w(z.geographicToLTP(k,[d.latitude,d.longitude,d.ellipsoidRadius,d.squaredEccentricity]))}else k=new w(D.geographicToWebMercator(k));
d=(k.z??0)-(f.z??0);var e=(k.x-f.x)/g,l=(k.y-f.y)/g;k=(a[0]*e+a[1]*l+a[2]*d)/(a[6]*e+a[7]*l+a[8]*d);d=(a[3]*e+a[4]*l+a[5]*d)/(a[6]*e+a[7]*l+a[8]*d);e=k**2+d**2;var v=0;let y=0,M=0,I=l=0;var A=0;let N=0;u&&(v=u[0]??0,y=u[1]??0,M=u[2]??0);t&&(l=t[0],I=t[1]);p&&(A=p[0]??0,N=p[1]??0);v=1+(v||0)*e+(y||0)*e*e+(M||0)*e*e*e;A=-(x??0)*(k*v+(l||0)*(e+2*k**2)+2*(I||0)*k*d)+A;k=-(x??0)*(d*v+(I||0)*(e+2*d**2)+2*(l||0)*k*d)+N;return{x:Number(n[0])+Number(n[1])*A+Number(n[2])*k,y:Number(n[3])+Number(n[4])*A+Number(n[5])*
k}}if(q.spatialReference.equals(f.spatialReference))return q=new w(q),r(q);await C.initializeProjection(c[0].spatialReference,f.spatialReference,null,b.options);return(q=C.project(q,f.spatialReference))?r(q):null}))}const E=Math.PI/180;B.transformPoints=async function(c,b,h=!1){if(!c)return[];c=c.map(g=>"esri.geometry.Point"===g.declaredClass?g:w.fromJSON(g));const {feature:m}=b;var {attributes:f}=m;isNaN(parseFloat(f.elevation))&&(f=await G([m.geometry],b),m.attributes.elevation=f[0].z);return G(c,
b,h).then(g=>{{const {attributes:a}=b.feature;g=a.isSpherical||360===a.horizontalFieldOfView?{}:a.cameraOrientation?.isAdvanced?T(g,b):Promise.resolve(S(g,b))}return g})};B.updateElevation=G;B.updateElevationUsingElevationSource=K;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});