// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["../../core/mathUtils"],function(T){var aa=T.clampFloat32(-Infinity);class ba{_decode(g){var r=g.buffer;g=g.options;g=g||{};var f=g.inputOffset||0;var l=g.encodedMaskData||null===g.encodedMaskData;var w=new Uint8Array(r,f,10);w=String.fromCharCode.apply(null,w);if("CntZImage"!=w.trim())throw"Unexpected file identifier string: "+w;f+=10;var a=new DataView(r,f,24);var L=a.getInt32(0,!0);var M=a.getInt32(4,!0);var z=a.getUint32(8,!0);var t=a.getUint32(12,!0);var U=a.getFloat64(16,!0);f+=24;if(!l){a=
new DataView(r,f,16);var d={};d.numBlocksY=a.getUint32(0,!0);d.numBlocksX=a.getUint32(4,!0);d.numBytes=a.getUint32(8,!0);d.maxValue=a.getFloat32(12,!0);f+=16;if(0<d.numBytes){l=new Uint8Array(Math.ceil(t*z/8));a=new DataView(r,f,d.numBytes);var n=a.getInt16(0,!0);var u=2;var D=0;do{if(0<n)for(;n--;)l[D++]=a.getUint8(u++);else{var G=a.getUint8(u++);for(n=-n;n--;)l[D++]=G}n=a.getInt16(u,!0);u+=2}while(u<d.numBytes);if(-32768!==n||D<l.length)throw"Unexpected end of mask RLE encoding";d.bitset=l;f+=d.numBytes}else 0===
(d.numBytes|d.numBlocksY|d.maxValue)&&(l=new Uint8Array(Math.ceil(t*z/8)),d.bitset=l)}a=new DataView(r,f,16);var C=l=G=D=u=n=void 0;n=a.getUint32(0,!0);u=a.getUint32(4,!0);D=a.getUint32(8,!0);G=a.getFloat32(12,!0);f+=16;C=u;l=n;C+=0<t%C?1:0;var A=l+(0<z%l?1:0);l=Array(C*A);for(var x=1E9,H=0,E=0;E<A;E++)for(var I=0;I<C;I++){var e=0;a=new DataView(r,f,Math.min(10,r.byteLength-f));var c={};l[H++]=c;var b=a.getUint8(0);e++;c.encoding=b&63;if(3<c.encoding)throw"Invalid block encoding ("+c.encoding+")";
if(2===c.encoding)f++,x=Math.min(x,0);else{if(0!==b&&2!==b){b>>=6;c.offsetType=b;if(2===b)c.offset=a.getInt8(1),e++;else if(1===b)c.offset=a.getInt16(1,!0),e+=2;else if(0===b)c.offset=a.getFloat32(1,!0),e+=4;else throw"Invalid block offset type";x=Math.min(c.offset,x);if(1===c.encoding)if(b=a.getUint8(e),e++,c.bitsPerPixel=b&63,b>>=6,c.numValidPixelsType=b,2===b)c.numValidPixels=a.getUint8(e),e++;else if(1===b)c.numValidPixels=a.getUint16(e,!0),e+=2;else if(0===b)c.numValidPixels=a.getUint32(e,!0),
e+=4;else throw"Invalid valid pixel count type";}f+=e;if(3!=c.encoding)if(0===c.encoding){a=(D-1)/4;if(a!==Math.floor(a))throw"uncompressed block has invalid length";e=new ArrayBuffer(4*a);b=new Uint8Array(e);b.set(new Uint8Array(r,f,4*a));e=new Float32Array(e);for(b=0;b<e.length;b++)x=Math.min(x,e[b]);c.rawData=e;f+=4*a}else 1===c.encoding&&(a=Math.ceil(c.numValidPixels*c.bitsPerPixel/8),e=new ArrayBuffer(4*Math.ceil(a/4)),b=new Uint8Array(e),b.set(new Uint8Array(r,f,a)),c.stuffedData=new Uint32Array(e),
f+=a)}}C=x;r=f;f=null!=g.noDataValue?T.clampFloat32(g.noDataValue):aa;A=g.encodedMaskData;b=g.returnMask;x=0;H=u;E=n;I=Math.floor(t/H);c=Math.floor(z/E);e=2*U;A=A||(d?d.bitset:null);var p;a=new (g.pixelType||Float32Array)(t*z);b&&A&&(p=new Uint8Array(t*z));b=new Float32Array(I*c);for(var m,h,N=0;N<=E;N++){var O=N!==E?c:z%E;if(0!==O)for(var P=0;P<=H;P++){var F=P!==H?I:t%H;if(0!==F){var k=N*t*c+P*I,Q=t-F,q=l[x],y;if(2>q.encoding){if(0===q.encoding)var B=q.rawData;else{m=y=B=void 0;h=q.stuffedData;var J=
q.bitsPerPixel,V=q.numValidPixels,W=q.offset,X=e,ca=b,Y=G,S=(1<<J)-1,Z=0,v=0,da=Math.ceil((Y-W)/X);h[h.length-1]<<=8*(4*h.length-Math.ceil(J*V/8));for(m=0;m<V;m++)0===v&&(B=h[Z++],v=32),v>=J?(y=B>>>v-J&S,v-=J):(v=J-v,y=(B&S)<<v&S,B=h[Z++],v=32-v,y+=B>>>v),ca[m]=y<da?W+y*X:Y;B=b}y=0}else var K=2===q.encoding?0:q.offset;if(A)for(h=0;h<O;h++){if(k&7){var R=A[k>>3];R<<=k&7}for(m=0;m<F;m++)k&7||(R=A[k>>3]),R&128?(p&&(p[k]=1),a[k++]=2>q.encoding?B[y++]:K):(p&&(p[k]=0),a[k++]=f),R<<=1;k+=Q}else if(2>q.encoding)for(h=
0;h<O;h++){for(m=0;m<F;m++)a[k++]=B[y++];k+=Q}else for(h=0;h<O;h++)if(a.fill)a.fill(K,k,k+F),k+=F+Q;else{for(m=0;m<F;m++)a[k++]=K;k+=Q}if(1===q.encoding&&y!==q.numValidPixels)throw"Block and Mask do not match";x++}}}K=p;p={width:t,height:z,pixelData:a,minValue:C,maxValue:G,noDataValue:f};K&&(p.maskData=K);g.returnEncodedMask&&d&&(p.encodedMaskData=d.bitset?d.bitset:null);if(g.returnFileInfo&&(p.fileInfo={fileIdentifierString:w,fileVersion:L,imageType:M,height:z,width:t,maxZError:U,eofOffset:r,mask:d?
{numBlocksX:d.numBlocksX,numBlocksY:d.numBlocksY,numBytes:d.numBytes,maxValue:d.maxValue}:null,pixels:{numBlocksX:u,numBlocksY:n,numBytes:D,maxValue:G,minValue:C,noDataValue:f}},g.computeUsedBitDepths)){d=p.fileInfo;g=u*n;w={};for(L=0;L<g;L++)M=l[L],0===M.encoding?w.float32=!0:1===M.encoding?w[M.bitsPerPixel]=!0:w[0]=!0;g=Object.keys(w);d.bitDepths=g}return Promise.resolve({result:p,transferList:[p.pixelData.buffer]})}}return function(){return new ba}});