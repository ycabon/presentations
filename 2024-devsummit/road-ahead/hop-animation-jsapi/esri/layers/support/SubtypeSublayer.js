// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../PopupTemplate ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../core/Logger ../../core/Clonable ../../core/has ../../core/Error ../../core/Identifiable ../../core/lang ../../core/Loadable ../../core/MultiOriginJSONSupport ../../core/object ../../core/sql ../../core/accessorSupport/decorators/property ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../core/accessorSupport/extensions/serializableProperty/reader ../../form/FormTemplate ./commonProperties ./featureLayerUtils ./FeatureTemplate ./fieldProperties ./fieldUtils ./LabelClass ./labelingInfo ../../rest/support/Query ../../support/popupUtils ../../symbols/support/defaults".split(" "),
function(e,K,y,fa,ha,ia,ja,L,C,M,ka,N,d,la,z,O,t,P,Q,R,F,g,A,S,T,U,V,v,W,G,B,X,Y,Z,aa,ba,D){function w(a){const b=a.json.write;"object"===typeof b?b.ignoreOrigin=!0:a.json.write={ignoreOrigin:!0};return a}function ca(a){switch(a){case "point":case "multipoint":return D.defaultPointSymbol2D.clone();case "polyline":return D.defaultPolylineSymbol2D.clone();case "polygon":case "multipatch":return D.defaultPolygonSymbol2D.clone();default:return null}}function da(a,b){return b?"unique-value"===a?.type&&
"string"===typeof a.field&&a.field.toLowerCase()===b.toLowerCase()&&!a.field2&&!a.field3&&!a.valueExpression:!1}function H(a,b){return null==a?null:b.subtypes?.find(c=>c.code===a)}y={key:"type",base:L,errorContext:"renderer",typeMap:{simple:C,"unique-value":M,"class-breaks":y}};B=B.defineFieldProperties();const I=U.createTypeReader({types:y});let ea=0;d=class extends Q.MultiOriginJSONMixin(d.ClonableMixin(O.IdentifiableMixin(P))){constructor(a){super(a);this.charts=null;this.editingEnabled=!0;this.formTemplate=
this.fieldsIndex=this.fieldOverrides=null;this.id=`${Date.now().toString(16)}-subtype-sublayer-${ea++}`;this.type="subtype-sublayer";this.labelsVisible=!0;this.labelingInfo=null;this.layerType="ArcGISFeatureLayer";this.legendEnabled=!0;this.listMode="show";this.maxScale=this.minScale=0;this.opacity=1;this.parent=null;this.popupEnabled=!0;this.title=this.templates=this.subtypeCode=this.popupTemplate=null;this.visible=!0}get capabilities(){return this.parent?.capabilities}get effectiveCapabilities(){return this.parent?.effectiveCapabilities}get effectiveEditingEnabled(){const {parent:a}=
this;return a?a.effectiveEditingEnabled&&this.editingEnabled:this.editingEnabled}get elevationInfo(){return this.parent?.elevationInfo}writeFieldOverrides(a,b,c){const {fields:f,parent:h}=this;let k;if(f){k=[];let m=0;f.forEach(({name:u,alias:x,editable:l,visible:p})=>{if(p&&(p=h?.fields?.find(E=>E.name===u))){var n={name:u},q=!1;x!==p.alias&&(n.alias=x,q=!0);l!==p.editable&&(n.editable=l,q=!0);k.push(n);q&&m++}});0===m&&k.length===f.length&&(k=null)}else k=t.clone(a);k?.length&&R.setDeepValue(c,
k,b)}get fields(){const {parent:a,fieldOverrides:b,subtypeCode:c}=this;var f=a?.fields;if(!a||!f?.length)return null;const {subtypes:h,subtypeField:k}=a;var m=h?.find(p=>p.code===c);const u=m?.defaultValues;m=m?.domains;const x=[];for(const p of f){f=p.clone();const {name:n}=f;var l=b?.find(q=>q.name===n);f.visible=!b||!!l;if(l){const {alias:q,editable:E}=l;q&&(f.alias=q);!1===E&&(f.editable=!1)}l=u?.[n]??null;f.defaultValue=n===k?c:l;l=m?.[n]??null;f.domain=n===k?null:l?"inherited"===l.type?f.domain:
l.clone():null;x.push(f)}return x}get floorInfo(){return this.parent?.floorInfo}get geometryType(){return this.parent?.geometryType}get effectiveScaleRange(){const {minScale:a,maxScale:b}=this;return{minScale:a,maxScale:b}}get objectIdField(){this.parent||N.getLogger("esri.layers.support.SubtypeSublayer").error(r("objectIdField"));return this.parent?.objectIdField}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(a){X.fixRendererFields(a,this.fieldsIndex);this._override("renderer",
a)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const {parent:a}=this;return a&&!a.isTable&&"mesh"!==a.geometryType?new C({symbol:ca(a.geometryType)}):null}readRendererFromService(a,b,c){if("Table"===b.type)return null;c=I(b.drawingInfo?.renderer,b,c);a=void 0;const {subtypeCode:f}=this;null!=f&&da(c,b.subtypeField)?(b=c.uniqueValueInfos?.find(({value:h})=>{h="number"===typeof h?String(h):h;return h===String(f)}))&&(a=new C({symbol:b.symbol})):"simple"!==c?.type||
c.visualVariables?.length||(a=c);return a}readRenderer(a,b,c){if((a=b?.layerDefinition?.drawingInfo?.renderer)&&!a.visualVariables?.some(f=>"rotationInfo"!==f.type))return I(a,b,c)||void 0}get spatialReference(){return this.parent?.spatialReference}get subtypeField(){return this.parent?.subtypeField}readTemplatesFromService(a,b){a=this.subtypeCode;let c=null;switch(b.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":c="point";break;case "esriGeometryPolyline":c="line";break;case "esriGeometryPolygon":case "esriGeometryMultiPatch":c=
"polygon";break;default:c=null}const f={};var h=H(a,b);if(null!=h){({defaultValues:h}=h);for(const k in h)f[k]=h[k]}f[b.subtypeField]=a;return[new G({name:"New Feature",drawingTool:c,prototype:{attributes:f}})]}readTitleFromService(a,b){a=H(this.subtypeCode,b);return null!=a?a.name:null}get url(){return this.parent?.url}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}async addAttachment(a,b){const {parent:c}=this;if(!c)throw r("addAttachment");if(a.getAttribute(c.subtypeField)!==
this.subtypeCode)throw new z("subtype-sublayer:addAttachment","The feature provided does not belong to this SubtypeSublayer");return c.addAttachment(a,b)}async updateAttachment(a,b,c){const {parent:f}=this;if(!f)throw r("updateAttachment");if(a.getAttribute(f.subtypeField)!==this.subtypeCode)throw new z("subtype-sublayer:updateAttachment","The feature provided does not belong to this SubtypeSublayer");return f.updateAttachment(a,b,c)}async deleteAttachments(a,b){const {parent:c}=this;if(!c)throw r("deleteAttachments");
if(a.getAttribute(c.subtypeField)!==this.subtypeCode)throw new z("subtype-sublayer:deleteAttachments","The feature provided does not belong to this SubtypeSublayer");return c.deleteAttachments(a,b)}async applyEdits(a,b){if(!this.parent)throw r("applyEdits");return this.parent.applyEdits(a,b)}createPopupTemplate(a){let b=this;const {parent:c,fields:f,title:h}=this;if(c){const {displayField:k,editFieldsInfo:m,objectIdField:u}=c;b={displayField:k,editFieldsInfo:m,fields:f,objectIdField:u,title:h}}return ba.createPopupTemplate(b,
a)}createQuery(){if(!this.parent)throw r("createQuery");const a=W.createQuery(this.parent);a.where=F.sqlAnd(`${this.parent.subtypeField}=${this.subtypeCode}`,this.parent.definitionExpression);return a}getField(a){return this.fieldsIndex.get(a)}getFieldDomain(a){return this._getLayerDomain(a)}async queryAttachments(a,b){const c=await this.load();if(!c.parent)throw r("queryAttachments");const f=a.clone();f.where=J(f.where,c.parent.subtypeField,c.subtypeCode);return c.parent.queryAttachments(a,b)}async queryFeatures(a,
b){const c=await this.load();if(!c.parent)throw r("queryFeatures");const f=aa.from(a)??c.createQuery();null!=a&&(f.where=J(f.where,c.parent.subtypeField,c.subtypeCode));return c.parent.queryFeatures(f,b)}_getLayerDomain(a){return(a=this.fieldsIndex.get(a))?a.domain:null}};e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"capabilities",null);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"effectiveCapabilities",null);e.__decorate([g.property({json:{write:{ignoreOrigin:!0}}})],
d.prototype,"charts",void 0);e.__decorate([g.property({type:Boolean,nonNullable:!0,json:{name:"enableEditing",write:{ignoreOrigin:!0}}})],d.prototype,"editingEnabled",void 0);e.__decorate([g.property({type:Boolean,readOnly:!0})],d.prototype,"effectiveEditingEnabled",null);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"elevationInfo",null);e.__decorate([g.property({json:{name:"layerDefinition.fieldOverrides",origins:{service:{read:!1}},write:{ignoreOrigin:!0,allowNull:!0}}})],
d.prototype,"fieldOverrides",void 0);e.__decorate([T.writer("fieldOverrides")],d.prototype,"writeFieldOverrides",null);e.__decorate([g.property({...B.fields,readOnly:!0,json:{read:!1}})],d.prototype,"fields",null);e.__decorate([g.property(B.fieldsIndex)],d.prototype,"fieldsIndex",void 0);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"floorInfo",null);e.__decorate([g.property({type:V,json:{name:"formInfo",write:{ignoreOrigin:!0}}})],d.prototype,"formTemplate",void 0);e.__decorate([g.property({type:String,
clonable:!1,readOnly:!0,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],d.prototype,"id",void 0);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"geometryType",null);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"type",void 0);e.__decorate([g.property(w(t.clone(v.labelsVisible)))],d.prototype,"labelsVisible",void 0);e.__decorate([g.property({type:[Y],json:{name:"layerDefinition.drawingInfo.labelingInfo",origins:{service:{read:!1}},
read:{reader:Z.reader},write:{ignoreOrigin:!0}}})],d.prototype,"labelingInfo",void 0);e.__decorate([g.property({type:["ArcGISFeatureLayer"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],d.prototype,"layerType",void 0);e.__decorate([g.property(w(t.clone(v.legendEnabled)))],d.prototype,"legendEnabled",void 0);e.__decorate([g.property({type:["show","hide"]})],d.prototype,"listMode",void 0);e.__decorate([g.property((()=>{const a=t.clone(v.minScale);a.json.origins.service.read=!1;return w(a)})())],
d.prototype,"minScale",void 0);e.__decorate([g.property((()=>{const a=t.clone(v.maxScale);a.json.origins.service.read=!1;return w(a)})())],d.prototype,"maxScale",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"effectiveScaleRange",null);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"objectIdField",null);e.__decorate([g.property({type:Number,range:{min:0,max:1},nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],d.prototype,"opacity",void 0);e.__decorate([g.property({clonable:!1})],
d.prototype,"parent",void 0);e.__decorate([g.property(w(t.clone(v.popupEnabled)))],d.prototype,"popupEnabled",void 0);e.__decorate([g.property({type:K,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],d.prototype,"popupTemplate",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"defaultPopupTemplate",null);e.__decorate([g.property({types:y,json:{write:{target:"layerDefinition.drawingInfo.renderer",ignoreOrigin:!0}}})],d.prototype,"renderer",null);e.__decorate([A.reader("service","renderer",
["drawingInfo.renderer","subtypeField","type"])],d.prototype,"readRendererFromService",null);e.__decorate([A.reader("renderer",["layerDefinition.drawingInfo.renderer"])],d.prototype,"readRenderer",null);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"spatialReference",null);e.__decorate([g.property({type:Number,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],d.prototype,"subtypeCode",void 0);e.__decorate([g.property({readOnly:!0,json:{read:!1}})],d.prototype,"subtypeField",
null);e.__decorate([g.property({type:[G],json:{name:"layerDefinition.templates",write:{ignoreOrigin:!0}}})],d.prototype,"templates",void 0);e.__decorate([A.reader("service","templates",["geometryType","subtypeField","subtypes","type"])],d.prototype,"readTemplatesFromService",null);e.__decorate([g.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"title",void 0);e.__decorate([A.reader("service","title",["subtypes"])],d.prototype,"readTitleFromService",null);e.__decorate([g.property({readOnly:!0,
json:{read:!1}})],d.prototype,"url",null);e.__decorate([g.property({readOnly:!0})],d.prototype,"userHasUpdateItemPrivileges",null);e.__decorate([g.property({type:Boolean,nonNullable:!0,json:{name:"visibility",write:{ignoreOrigin:!0}}})],d.prototype,"visible",void 0);d=e.__decorate([S.subclass("esri.layers.support.SubtypeSublayer")],d);const J=(a,b,c)=>{const f=new RegExp(`${b}\\s*=\\s*\\d+`);b=`${b}=${c}`;a=a??"";return f.test(a)?a.replace(f,b):F.sqlAnd(b,a)},r=a=>new z(`This sublayer must have a parent SubtypeGroupLayer in order to use ${a}`);
return d});