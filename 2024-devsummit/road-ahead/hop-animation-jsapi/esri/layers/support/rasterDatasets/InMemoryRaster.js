// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../DimensionalDefinition ../RasterInfo ./BaseRaster ./multidimensionalUtils ../rasterFunctions/pixelUtils ../rasterFunctions/stretchUtils ../../../geometry/Extent ../../../geometry/SpatialReference".split(" "),function(l,k,x,y,p,J,K,L,z,A,
B,C,D,u,v,E,F){k=class extends C{constructor(){super(...arguments);this.datasetFormat="MEMORY";this.source=null}get url(){return""}async open(b){await this.init();const c=this.source,{pixelBlocks:g,attributeTable:a,statistics:e,histograms:d,name:h,nativeExtent:m,transform:n}=c,q=g[0],{width:r,height:t,pixelType:G}=q;var f=c.extent??new E({xmin:-.5,ymin:.5,xmax:r-.5,ymax:t-.5,spatialReference:new F({wkid:3857})});const H=c.isPseudoSpatialReference??!c.extent,I={x:f.width/r,y:f.height/t},w={...c.keyProperties};
a&&(w.DataType="Thematic");f=new B({width:r,height:t,pixelType:G,extent:f,nativeExtent:m,attributeTable:a,transform:n,pixelSize:I,spatialReference:f.spatialReference,bandCount:q.pixels.length,keyProperties:w,multidimensionalInfo:c.multidimensionalInfo,statistics:e,isPseudoSpatialReference:H,histograms:d});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(f);this.createRemoteDatasetStorageInfo(f,512,512);this._set("rasterInfo",f);this.updateTileInfo();f.multidimensionalInfo?await this._buildMDimStats(c.pixelBlocks,
f.multidimensionalInfo):await this._buildInMemoryRaster(q,{width:512,height:512},b);f.multidimensionalInfo||(this.source=null);this.datasetName=h}fetchRawTile(b,c,g,a={}){if(!this._pixelBlockTiles){const {rasterInfo:e}=this,[d,h]=e.storageInfo.tileInfo.size,{sliceId:m}=a,{pixelBlocks:n}=this.source;b={pixelBlock:null==m?n[0]:n[m],useBilinear:"thematic"!==e.dataType,tileSize:{width:d,height:h},level:b,row:c,col:g};a=this.rasterJobHandler?this.rasterJobHandler.clipTile(b,a):u.clipTile(b);return Promise.resolve(a)}a=
this._pixelBlockTiles.get(`${b}/${c}/${g}`);return Promise.resolve(a)}async _buildInMemoryRaster(b,c,g){const {rasterInfo:a}=this;var e=a.storageInfo.maximumPyramidLevel??0,d="thematic"!==a.dataType;d=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:b,tileSize:c,maximumPyramidLevel:e,useBilinear:d},g):Promise.resolve(u.split(b,c,e,d));c=null!=a.statistics;e=null!=a.histograms;b=this.ioConfig.skipStatistics||c?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:b},
g):Promise.resolve(v.estimateStatisticsHistograms(b));b=await y.eachAlways([d,b]);if(!b[0].value&&b[1].value)throw new x("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=b[0].value;c||(a.statistics=b[1].value?.statistics);e||(a.histograms=b[1].value?.histograms)}async _buildMDimStats(b,c,g){for(let e=0;e<c.variables.length;e++){const d=c.variables[e];if(!d.statistics){var a=d.dimensions.map(h=>new A({variableName:d.name,dimensionName:h.name,values:[h.values?.[0]??h.extent?.[0]],
isSlice:!0}));a=D.getSliceIndex(a,c);a=null==a?null:b[a];null!=a&&(a=this.rasterJobHandler?await this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:a},g):v.computeStatisticsHistograms(a),d.statistics=a.statistics,d.histograms||(d.histograms=a.histograms))}}}};l.__decorate([p.property({type:String,json:{write:!0}})],k.prototype,"datasetFormat",void 0);l.__decorate([p.property()],k.prototype,"source",void 0);l.__decorate([p.property()],k.prototype,"url",null);return k=l.__decorate([z.subclass("esri.layers.support.rasterDatasets.InMemoryRaster")],
k)});