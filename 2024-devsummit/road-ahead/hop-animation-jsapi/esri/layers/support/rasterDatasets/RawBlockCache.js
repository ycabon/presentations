// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../geometry","./EphemeralBlockCache","../rasterFunctions/rasterProjectionHelper","../../../geometry/Point"],function(g,I,E,w,F){function G(b,a){return(b=h.get(b))?b[a]??null:null}const h=new Map,n=new E;g.decreaseRefCount=function(b,a,c){const d=h.get(b);if(!d)return null==a?n.decreaseRefCount(b,c):0;if(null==a||null==d[a])return n.decreaseRefCount(b,c);a=d[a]?.cache;b=a?.get(c);if(a&&b){b.refCount--;if(0===b.refCount){a.delete(c);for(a=0;a<d.length;a++)d[a]?.cache.delete(c);
b.controller&&b.controller.abort()}return b.refCount}return 0};g.deleteBlock=function(b,a,c){const d=h.get(b);d?null==a||null==d[a]?n.deleteBlock(b,c):d[a]?.cache.delete(c):null==a&&n.deleteBlock(b,c)};g.deleteRaster=function(b){h.delete(b)};g.getBlock=function(b,a,c){const d=h.get(b);if(!d)return null==a?n.getBlock(b,c):null;if(null==a||null==d[a]){for(a=0;a<d.length;a++){var e=d[a]?.cache.get(c);if(e)return e.refCount++,e.block}return n.getBlock(b,c)}if(b=d[a]?.cache.get(c))return b.refCount++,
b.block;for(b=0;b<d.length;b++){if(b===a||!d[b])continue;e=d[b]?.cache;const k=e?.get(c);if(e&&k)return k.refCount++,e.set(c,k),k.block}return null};g.getRasterId=function(b,a){return null==a?b:`${b}?sliceId=${a}`};g.putBlock=function(b,a,c,d,e=null){const k=h.get(b);if(k)if(null==a||null==k[a])n.putBlock(b,c,d,e);else{var r={refCount:1,block:d,isResolved:!1,isRejected:!1,controller:e};d.then(()=>r.isResolved=!0).catch(()=>r.isRejected=!0);k[a]?.cache.set(c,r)}else null==a&&n.putBlock(b,c,d,e)};g.register=
function(b,a){a={extent:null,rasterInfo:a,cache:new Map};const c=h.get(b);if(c)return c.push(a),c.length-1;h.set(b,[a]);return 0};g.unregister=function(b,a){const c=h.get(b);c&&(c[a]=null,c.some(d=>null!=d)||h.delete(b))};g.update=function(b,a,c,d,e,k,r=null){if(b=G(b,a)){a=b.extent;var {cache:x,rasterInfo:y}=b;if(!a||a.xmin!==c.xmin||a.xmax!==c.xmax||a.ymin!==c.ymin||a.ymax!==c.ymax){d=d??0;a=c.clone().normalize();var {spatialReference:z,transform:A}=y,B=new Set;for(let p=0;p<a.length;p++){var f=
a[p];if(f.xmax-f.xmin<=d||f.ymax-f.ymin<=d)continue;var l=w.projectExtent(f,z,r);null!=A&&(l=A.inverseTransform(l));var t=new F({x:d,y:d,spatialReference:f.spatialReference});if(null==e&&(e=w.projectResolution(t,z,f,r),!e))return;const {pyramidLevel:q,pyramidResolution:v,excessiveReading:H}=w.snapPyramid(e,y,k||"closest");if(H)return;({storageInfo:f}=y);var {origin:m}=f;t=Math.max(0,Math.floor((l.xmin-m.x)/v.x));m=Math.max(0,Math.floor((m.y-l.ymax)/v.y));const C=0<q?f.pyramidBlockWidth:f.blockWidth,
D=0<q?f.pyramidBlockHeight:f.blockHeight;f=Math.max(0,Math.floor(t/C)-1);var u=Math.max(0,Math.floor(m/D)-1);t=Math.floor((t+Math.ceil((l.xmax-l.xmin)/v.x-.1)-1)/C)+1;l=Math.floor((m+Math.ceil((l.ymax-l.ymin)/v.y-.1)-1)/D)+1;for(m=u;m<=l;m++)for(u=f;u<=t;u++)B.add(`${q}/${m}/${u}`)}x.forEach((p,q)=>{B.has(q)||(p=x.get(q),(null==p||p.isResolved||p.isRejected)&&x.delete(q))});b.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}}};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});