// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ./bandIndexUtils ./BaseRasterFunction ./ExtractBandFunctionArguments ./pixelUtils".split(" "),function(u,v,q,B,C,w,x,y,z,A){q=class extends y{constructor(){super(...arguments);this.functionName="ExtractBand";this.functionArguments=null;this.rasterArgumentNames=["raster"]}_bindSourceRasters(){const {functionArguments:a,
sourceRasterInfos:c}=this;var b=c[0];const {method:d,bandNames:f,bandWavelengths:e,bandIds:h,missingBandAction:n}=a,r=f?.length&&("name"===d||"id"!==d&&!h?.length),m=e?.length&&("wavelength"===d||"id"!==d&&!h?.length);var g=n===A.MissingBandAction.fail;g=r?this._matchBandNames(b,f):m?this._matchBandWavelengths(b,e,g):this._matchBandIds(b,h,g);if(null==g)return{success:!1,supportsGPU:!1,error:`extract-band-function: Invalid ${r?"band names":m?"band wavelengths":"band ids"} for the imagery data source`};
this.functionArguments.bandIds=g;this.functionArguments.method="id";this.outputPixelType=this._getOutputPixelType("f32");b=b.clone();b.pixelType=this.outputPixelType;b.bandCount=g.length;const {statistics:k,histograms:l}=b;null!=k&&k.length&&(b.statistics=g.map(t=>k[t]||k[k.length-1]));null!=l&&l.length&&(b.histograms=g.map(t=>l[t]||l[l.length-1]));let p=b.keyProperties?.BandProperties;p?.length&&(p=g.map(t=>t>=p.length?p[p.length-1]:p[t]),b.keyProperties={...b.keyProperties,BandProperties:p});this.rasterInfo=
b;return{success:!0,supportsGPU:3>=b.bandCount}}_processPixels(a){a=a.pixelBlocks?.[0];if(null==a)return null;const c=a.pixels.length,b=this.functionArguments.bandIds.map(d=>d>=c?c-1:d);return a.extractBands(b)}_getWebGLParameters(){let a;if(this.isInputBandIdsSwizzled)a=this.swizzledBandSelection.length?this.swizzledBandSelection:[0,1,2];else{a=[...this.functionArguments.bandIds];0===a.length?a=[0,1,2]:3>a.length&&(a[1]=a[1]??a[0],a[2]=a[2]??a[1]);for(let c=0;3>c;c++)a[c]=Math.min(a[c],2)}return{bandIndexMat3:x.getBandMatrix3(a)}}_getInputBandIds(a){const c=
a.length;return this.functionArguments.bandIds.map(b=>b>=c?c-1:b).map(b=>a[b])}_matchBandNames(a,c){a=a.bandInfos.map(({name:d})=>d.toLowerCase());const b=[];for(let d=0;d<c.length;d++){const f=c[d].toLowerCase();let e=a.indexOf(f);-1===e&&"nearinfrared"===f&&(e=a.findIndex(h=>h.startsWith("nearinfrared_1")),-1===e&&(e=a.findIndex(h=>h.startsWith("nearinfrared"))));if(-1===e)return null;b.push(e)}return b}_matchBandIds(a,c,b){const {bandCount:d}=a;return!c?.length||b&&c.some(f=>0>f||f>=d)?null:c}_matchBandWavelengths(a,
c,b){var {bandInfos:d}=a;a=[];for(var f=0;f<d.length;f++){const {minWavelength:e,maxWavelength:h}=d[f];if(!e||!h)return null;a.push({minWavelength:e,maxWavelength:h})}({wavelengthMatchTolerance:d}=this.functionArguments);f=[];for(let e=0;e<c.length;e++){const h=c[e];let n=!1,r=-1,m=Number.MAX_VALUE;for(let g=0;g<a.length;g++){const k=a[g],l=Math.abs(h-(k.minWavelength+k.maxWavelength)/2);h>=k.minWavelength&&h<=k.maxWavelength?l<m&&(n=!0,r=g,m=l):!n&&l<m&&(r=g,m=l)}!n&&d&&m<d&&(n=!0);if(!n&&b)return null;
f.push(r)}return f}};u.__decorate([v.property({json:{write:!0,name:"rasterFunction"}})],q.prototype,"functionName",void 0);u.__decorate([v.property({type:z,json:{write:!0,name:"rasterFunctionArguments"}})],q.prototype,"functionArguments",void 0);u.__decorate([v.property()],q.prototype,"rasterArgumentNames",void 0);return q=u.__decorate([w.subclass("esri.layers.support.rasterFunctions.ExtractBandFunction")],q)});