// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/unitUtils","../../../geometry/Extent","../PixelBlock"],function(G,D,E,F,x){function H(c,a,b){if(!c)return c;const {width:h,height:e}=c,q=a.width/h,n=a.height/e,{xmin:g,ymax:k}=a;if("extent"===b.type){a=(b.xmin-g)/q;var l=(b.xmax-g)/q,p=(k-b.ymax)/n;b=(k-b.ymin)/n;b=[[[a,p],[a,b],[l,b],[l,p],[a,p]]]}else b=b.rings.map(f=>f.map(([m,t])=>[(m-g)/q,(k-t)/n]));a=document.createElement("canvas");a.width=h;a.height=e;const d=a.getContext("2d");d.fillStyle="#f00";
d.beginPath();b.forEach(f=>{d.moveTo(f[0][0],f[0][1]);for(let m=0;m<f.length;m++)d.lineTo(f[m][0],f[m][1]);d.closePath()});d.fill();b=d.getImageData(0,0,h,e).data;a=c.mask;l=h*e;p=new Uint8Array(l);for(let f=0;f<l;f++)if(!a||a[f])p[f]=127<b[4*f+3]?255:0;return new x({pixelType:c.pixelType,width:h,height:e,mask:p,maskIsAlpha:!1,pixels:[...c.pixels]})}function I(c,a,b){const {width:h,height:e}=c,q=new Uint8Array(h*e);var n=a.width/h,g=a.height/e;if(.5>b.width/n||.5>b.height/g)return new x({pixelType:c.pixelType,
width:h,height:e,mask:q,pixels:[...c.pixels]});const {xmin:k,xmax:l,ymin:p,ymax:d}=a,{xmin:f,xmax:m,ymin:t,ymax:C}=b;a=Math.max(k,f);var u=Math.min(l,m);b=Math.max(p,t);var v=Math.min(d,C),r=.5*n,w=.5*g;if(u-a<r||v-b<w||u<k+r||a>l-r||b>d-w||v<p+w)return new x({pixelType:c.pixelType,width:h,height:e,mask:q,pixels:[...c.pixels]});a=Math.max(0,(a-k)/n);u=Math.min(h,Math.max(0,(u-k)/n));v=Math.max(0,(d-v)/g);w=Math.min(e,Math.max(0,(d-b)/g));g=Math.round(a);n=Math.round(u)-1;r=Math.round(v);b=Math.round(w)-
1;if(g===n&&.5<a%1&&.5>u%1||r===b&&.5<v%1&&.5>w%1)return new x({pixelType:c.pixelType,width:h,height:e,mask:q,pixels:[...c.pixels]});if(0===g&&0===r&&n===h&&b===e)return c;a=c.mask;for(u=r;u<=b;u++)for(v=g;v<=n;v++)r=u*h+v,q[r]=a?a[r]:255;return new x({pixelType:c.pixelType,width:h,height:e,mask:q,pixels:[...c.pixels]})}function J(c,a,b){const {width:h,height:e}=c,q=new Uint8Array(h*e),n=a.width/h,g=a.height/e,{xmin:k,ymax:l}=a;({paths:a}=b);b=c.mask;for(let t=0;t<a.length;t++){const C=a[t];for(let u=
0;u<C.length-1;u++){const [v,r]=C[u],[w,A]=C[u+1];let y=Math.floor((l-r)/g),z=Math.floor((l-A)/g);if(z<y){var p=y;y=z;z=p}y=Math.max(0,y);z=Math.min(e-1,z);p=(w-v)/(A-r);for(let B=y;B<=z;B++){var d=B===y?Math.max(r,A):(e+1-B)*g,f=B===z?Math.min(r,A):d-g;d=A===r?Math.floor((v-k)/n):Math.floor((p*(d-r)+v-k)/n);f=A===r?Math.floor((w-k)/n):Math.floor((p*(f-r)+v-k)/n);if(f<d){var m=d;d=f;f=m}m=B*h;d=Math.max(0,d);f=Math.min(h-1,f);for(d=m+d;d<=m+f;d++)q[d]=b?b[d]:255}}}return new x({pixelType:c.pixelType,
width:h,height:e,mask:q,pixels:[...c.pixels]})}D.clip=async function(c,a,b){if("extent"===b.type)return I(c,a,b);const {width:h,height:e}=c,q=new Uint8Array(h*e),{contains:n,intersects:g}=await new Promise((k,l)=>G(["../../../geometry/geometryEngine"],k,l));return g(a,b)?"polyline"===b.type?J(c,a,b):n(b,a)?c:H(c,a,b):new x({pixelType:c.pixelType,width:h,height:e,mask:q,maskIsAlpha:!1,pixels:[...c.pixels]})};D.snapToRaster=function(c,a,b,h=!0){var {spatialReference:e}=c;if(!b.spatialReference.equals(e)){var q=
E.getMetersPerUnitForSR(b.spatialReference),n=E.getMetersPerUnitForSR(e);q!==n&&(q/=n,b={x:b.x*q,y:b.y*q})}const {x:g,y:k}=b;let {xmin:l,xmax:p,ymax:d,ymin:f}="extent"===a.type?a:a.extent;const {xmin:m,ymax:t}=c.extent;h?(l=m+(l>m?g*Math.round((l-m)/g):0),d=t-(d<t?k*Math.round((t-d)/k):0),p=m+(p>m?g*Math.round((p-m)/g):0),f=t-(f<t?k*Math.round((t-f)/k):0),e=new F({xmin:l,ymax:d,xmax:p,ymin:f,spatialReference:e}),c=Math.round(e.width/g),a=Math.round(e.height/k)):(c=Math.floor((p-l)/g+.8),a=Math.floor((d-
f)/k+.8),l=m+(l>m?g*Math.floor((l-m)/g+.1):0),d=t-(d<t?k*Math.floor((t-d)/k+.1):0),e=new F({xmin:l,ymax:d,xmax:l+c*g,ymin:d-a*k,spatialReference:e}));return{extent:e,width:c,height:a}};Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});