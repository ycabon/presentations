// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/has","../../../core/jsonMap","../PixelBlock","./mirror"],function(ca,ha,ma,da,na){function oa(y,r){const {fillNoDataOnly:O}=r,{band:S,width:K,height:P,mask:v,outBand:L}=y;if(O&&!v)L.set(S);else{var {kernelRows:X,kernelCols:T}=r;y=Math.floor(X/2);r=Math.floor(T/2);var Y=L.slice(),U=new Uint32Array(K*P);for(var M=y;M<P-y;M++){var w=M*K;for(var q=r;q<K-r;q++){if(O&&v&&v[w+q])continue;const H=[];for(let Q=0;Q<X;Q++)for(let z=0;z<T;z++){const V=w+q+(Q-y)*K+z-r;v&&!v[V]||
H.push(S[V])}H.length&&(H.sort((Q,z)=>Q-z),v?(Y[w+q]=H[Math.floor((H.length-1)/2)],U[w+q]=H.length):L[w+q]=H[Math.floor((H.length-1)/2)])}}if(v)for(M=y;M<P-y;M++)for(w=M*K,q=r;q<K-r;q++)!U[w+q]||O&&v[w+q]||(L[w+q]=Y[w+q],v[w+q]=255)}}ha=new ma.JSONMap({1:"min",2:"max",3:"mean",4:"stddev",5:"median",6:"majority",7:"minority"},{useNumericKeys:!0});ca.computeFocalStatistics=function(y,r){const {mask:O}=y,{fillNoDataOnly:S}=r;if(S&&!O)return y;const {pixels:K,width:P,height:v,bandMasks:L,pixelType:X}=
y,T=K.length,Y=P*v,U=[],{kernelRows:M,kernelCols:w,statisticsType:q,mirrorEdges:H}=r;if(S&&!O)return y;const Q=r.outputPixelType??X,z=[];for(let Z=0;Z<T;Z++){const ia=K[Z],aa=da.createEmptyBand(Q,Y);S&&aa.set(ia);const ea=(L?.[Z]??O)?.slice()??null,ba={band:ia,width:P,height:v,mask:ea,outBand:aa};switch(q){case "min":case "max":a:{var V=r;const {fillNoDataOnly:N}=V,{band:p,width:d,height:A,mask:c,outBand:B}=ba;if(N&&!c){B.set(p);break a}const {kernelRows:R,kernelCols:D,statisticsType:x}=V,m=Math.floor(R/
2),t=Math.floor(D/2),I="min"===x,E=B.slice(),F=new Uint32Array(d*A);for(let n=m;n<A-m;n++){const e=n*d;for(let a=t;a<d-t;a++){let u=I?Number.MAX_VALUE:-Number.MAX_VALUE,C=0;for(let G=0;G<R;G++)for(let f=0;f<D;f++){const b=e+a+(G-m)*d+f-t;if(!c||c[b])u=I?Math.min(u,p[b]):Math.max(u,p[b]),C++}c?(E[e+a]=0===C?0:u,F[e+a]=C):B[e+a]=0===C?0:u}}if(c)for(let n=m;n<A-m;n++){const e=n*d;for(let a=t;a<d-t;a++)!F[e+a]||N&&c[e+a]||(B[e+a]=E[e+a],c[e+a]=255)}}break;case "mean":case "stddev":a:{var ja=r;const {fillNoDataOnly:N}=
ja,{band:p,width:d,height:A,mask:c,outBand:B}=ba;if(N&&!c){B.set(p);break a}const {statisticsType:R,kernelRows:D,kernelCols:x}=ja,m="stddev"===R,t=d*A,I=new Float64Array(t),E=new Float64Array(t),F=new Uint32Array(t);for(let f=0;f<A;f++){const b=f*d;let g=0,l=0,h=0;for(let k=0;k<x;k++)if(!c||c[b+k])g+=p[b+k],m&&(l+=p[b+k]**2),h++;I[b]=g;E[b]=l;F[b]=h;for(let k=1;k<=d-x;k++){const J=b+k-1,W=J+x;c?(c[J]&&(h--,g-=p[J],m&&(l-=p[J]**2)),c[W]&&(h++,g+=p[W],m&&(l+=p[W]**2))):(g-=p[J],g+=p[W],m&&(l-=p[J]**
2,l+=p[W]**2));I[b+k]=g;F[b+k]=h;m&&(E[b+k]=l)}}const n=new Float64Array(t),e=new Float64Array(t),a=new Uint32Array(t),u=D*d;for(let f=0;f<=d-x;f++){let b=0,g=0,l=0;for(let h=0;h<D;h++){const k=h*d+f;b+=I[k];l+=F[k];m&&(g+=E[k])}n[f]=b;e[f]=g;a[f]=l;for(let h=1;h<=A-D;h++){const k=(h-1)*d+f,J=k+u;b-=I[k];b+=I[J];l-=F[k];l+=F[J];m&&(g-=E[k],g+=E[J]);n[h*d+f]=b;e[h*d+f]=g;a[h*d+f]=l}}const C=Math.floor(D/2),G=Math.floor(x/2);for(let f=C;f<A-C;f++){const b=f*d;for(let g=G;g<d-G;g++){const l=(f-C)*d+
g-G,h=a[l];if(0===h||N&&(!c||c[b+g]))continue;const k=n[l]/h;B[b+g]=m?Math.sqrt((e[l]-n[l]*k)/h):k;c&&(c[b+g]=255)}}}break;case "median":oa(ba,r);break;case "majority":case "minority":a:{var fa=r;const {fillNoDataOnly:N}=fa,{band:p,width:d,height:A,mask:c,outBand:B}=ba;if(N&&!c){B.set(p);break a}const {kernelRows:R,kernelCols:D}=fa,x=Math.floor(R/2),m=Math.floor(D/2),t="majority"===fa.statisticsType,I=R*D,E=B.slice(),F=new Uint32Array(d*A);for(let n=x;n<A-x;n++){const e=n*d;for(let a=m;a<d-m;a++){if(N&&
c&&c[e+a])continue;const u=new Map;for(let b=0;b<R;b++)for(let g=0;g<D;g++){const l=e+a+(b-x)*d+g-m;if(c&&!c[l])continue;const h=p[l];u.set(h,u.has(h)?u.get(h)+1:1)}if(0===u.size)continue;let C=0,G=0,f=t?0:I+1;for(const b of u.keys())G=u.get(b),t===G>f&&(f=G,C=b);c?(E[e+a]=C,F[e+a]=u.size):B[e+a]=C}}if(c)for(let n=x;n<A-x;n++){const e=n*d;for(let a=m;a<d-m;a++)!F[e+a]||N&&c[e+a]||(B[e+a]=E[e+a],c[e+a]=255)}}}H&&!S&&na.mirror(aa,P,v,M,w);U.push(aa);ea&&z.push(ea)}let ka=z[0]??O;z.length!==T&&(z.length=
0);1<T&&L?.length&&(ka=da.combineBandMasks(L));const la=new da({pixelType:Q,width:P,height:v,pixels:U,bandMasks:L&&z.length?z:null,mask:ka});la.updateStatistics();return la};ca.statisticsTypeMap=ha;Object.defineProperty(ca,Symbol.toStringTag,{value:"Module"})});