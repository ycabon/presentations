// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../PixelBlock","../rasterFormats/pixelRangeUtils","../../../renderers/support/stretchRendererUtils"],function(z,C,E,K,L){function F(a,d=256){d=Math.min(d,256);const {size:n,counts:g}=a;a=new Uint8Array(n);var k=g.reduce((b,f)=>b+f/d,0);let q=0;var c=0;let h=0,l=k;for(let b=0;b<n;b++)if(h+=g[b],!(b<n-1&&h+g[b+1]<l)){for(;q<d-1&&l<h;)q++,l+=k;for(;c<=b;c++)a[c]=q;c=b+1}for(k=c;k<n;k++)a[k]=d-1;return a}function G(a,d){a=Math.min(Math.max(a,-100),100);d=Math.min(Math.max(d??
0,-100),100);let n=0,g=0;const k=new Uint8Array(256);for(n=0;256>n;n++)0<a&&100>a?g=(200*n-25500+510*d)/(2*(100-a))+128:0>=a&&-100<a?g=(200*n-25500+510*d)*(100+a)/2E4+128:100===a?(g=200*n-25500+256*(100-a)+510*d,g=0<g?255:0):-100===a&&(g=128),k[n]=255<g?255:0>g?0:g;return k}function M(a,d,n,g){let k=Infinity,q=-Infinity;var c=0,h=0,l=0,b=0;const f=a.length;var p=new Map,e=[];for(let m=0;m<f;m++){const r=a[m];if(!d||d[m]){e.push(r);const t=(p.get(r)??0)+1;p.set(r,t);t>b&&(b=t,l=r);k=r<k?r:k;q=r>q?
r:q;c+=r;h++}}if(0===h)return{statistics:{min:0,max:0,avg:0,stddev:0,mode:0,median:0},histogram:null};c/=h;b=0;for(p=0;p<f;p++)if(!d||d[p])b+=(a[p]-c)**2;p=d?d.filter(m=>m).length:f;b=1>=p?0:Math.sqrt(b/(p-1));e.sort((m,r)=>m-r);p=h>>>1;l={min:k,max:q,avg:c,stddev:b,mode:l,median:h%2?e[Math.floor(p)]:(e[p-1]+e[p])/2};if(!g)return{statistics:l,histogram:null};if(["u8","s8","u4","u2","u1"].includes(n)){h=q-k+1;n=new Uint32Array(h);for(g=0;g<f;g++)d&&!d[g]||n[a[g]-k]++;return{statistics:l,histogram:{min:k-
.5,max:q+.5,size:h,counts:n}}}n=new Uint32Array(256);g=(q-k)/256;if(0===g)return{statistics:l,histogram:{min:k,max:q,size:1,counts:(new Uint32Array(1)).fill(h)}};h=new Uint32Array(257);for(e=0;e<f;e++)d&&!d[e]||h[Math.floor((a[e]-k)/g)]++;for(a=0;255>a;a++)n[a]=h[a];n[255]=h[255]+h[256];return{statistics:l,histogram:{min:k,max:q,size:256,counts:n}}}function H(a){if(!a?.pixels?.length)return null;const {pixels:d,mask:n,bandMasks:g,pixelType:k}=a,q=a.width*a.height,c=d.length,h=[],l=[];let b,f;for(let w=
0;w<c;w++){var p=new Uint32Array(256);var e=d[w],m=g?.[w]??n;if("u8"===k){b=255;f=0;if(m)for(var r=0;r<q;r++){if(m[r]){var t=e[r];b=t<b?t:b;f=t>f?t:f;p[t]++}}else for(m=0;m<q;m++)r=e[m],b=r<b?r:b,f=r>f?r:f,p[r]++;p=p.slice(b,f+1)}else{t=!1;a.statistics||(a.updateStatistics(),t=!0);var x=a.statistics;b=x[w].minValue;f=x[w].maxValue;r=(f-b)/256;if(0===r)for(!x||a.validPixelCount||t||a.updateStatistics(),e=(a.validPixelCount||a.width*a.height)/256,m=0;256>m;m++)p[m]=Math.round(e*(m+1))-Math.round(e*
m);else{t=new Uint32Array(257);for(x=0;x<q;x++)m&&!m[x]||t[Math.floor((e[x]-b)/r)]++;for(e=0;255>e;e++)p[e]=t[e];p[255]=t[255]+t[256]}}r="u8"===k?b-.5:b;t="u8"===k?f+.5:f;h.push({min:r,max:t,size:p.length,counts:p});m=x=e=0;for(var v=0;v<p.length;v++)e+=p[v],x+=v*p[v];x/=e;for(v=0;v<p.length;v++)m+=p[v]*(v-x)**2;p=(t-r)/p.length;l.push({min:b,max:f,avg:(x+("u8"===k?0:.5))*p+b,stddev:Math.sqrt(m/(e-1))*p})}return{statistics:l,histograms:h}}function N(a,d){if(null==d||0===d.length)return a;const n=
Math.max.apply(null,d),{minCutOff:g,maxCutOff:k,outMin:q,outMax:c,histogramLut:h}=a;return g.length===d.length||g.length<=n?a:{minCutOff:d.map(l=>g[l]),maxCutOff:d.map(l=>k[l]),histogramLut:h?d.map(l=>h[l]):null,outMin:q,outMax:c}}function D(a,d){const n=new Float32Array(a);for(let g=0;g<a;g++)n[g]=1<d[g]?2<d[g]?6.5+(d[g]-2)**2.5:6.5+100*(2-d[g])**4:1;return n}const O=[.299,.587,.114];z.computeGammaCorrection=D;z.computeGammaValues=function(a,d,n){const g=[];for(let l=0;l<d.length;l++){var k=0,q=
0,c=0;"min"in d[l]?{min:k,max:q,avg:c}=d[l]:[k,q,c]=d[l];c=c??0;"u8"!==a&&(c=255*(c-k)/(q-k));n&&(c*=O[l]);k=g;q=k.push;if(0>=c||255<=c)c=1;else{var h=0;150!==c&&(h=150>=c?45*Math.cos(.01047*c):17*Math.sin(.021*c));h=Math.log((c+h)/255);0===h?c=1:(c=Math.log(c/255)/h,c=isNaN(c)?1:Math.min(9.9,Math.max(.01,c)))}q.call(k,c)}return g};z.computeStatisticsHistograms=function(a){const {pixels:d,mask:n,pixelType:g,bandMasks:k}=a;var q=d.map((c,h)=>M(c,k?.[h]??n,g,!0));a=q.map(({statistics:c})=>c);q=q.map(({histogram:c})=>
c);return{statistics:a,histograms:q}};z.createContrastBrightnessLUT=G;z.createHistogramEqualizationLUT=F;z.createStretchLUT=function(a){const {minCutOff:d,maxCutOff:n,gamma:g,pixelType:k,rounding:q}=a,c=a.outMin||0,h=a.outMax||255;if(!["u8","u16","s8","s16"].includes(k))return null;const l=d.length;let b,f,p=0;"s8"===k?p=-127:"s16"===k&&(p=-32767);let e=256;["u16","s16"].includes(k)&&(e=65536);var m=[],r=[];const t=h-c;for(b=0;b<l;b++)r[b]=n[b]-d[b],m[b]=0===r[b]?0:t/r[b];let x;const v=[];let w,u;
if(g&&g.length>=l)for(m=D(l,g),b=0;b<l;b++){u=[];for(f=0;f<e;f++)if(0===r[b])u[f]=c;else{var y=f+p;x=(y-d[b])/r[b];w=1;1<g[b]&&(w-=(1/t)**(x*m[b]));y<n[b]&&y>d[b]?(y=w*t*x**(1/g[b])+c,u[f]="floor"===q?Math.floor(y):"round"===q?Math.round(y):y):u[f]=y>=n[b]?h:c}v[b]=u}else for(b=0;b<l;b++){u=[];for(f=0;f<e;f++)y=f+p,y<=d[b]?u[f]=c:y>=n[b]?u[f]=h:(r=(y-d[b])*m[b]+c,u[f]="floor"===q?Math.floor(r):"round"===q?Math.round(r):r);v[b]=u}if(null!=a.contrastOffset)for(a=G(a.contrastOffset,a.brightnessOffset),
b=0;b<l;b++)for(u=v[b],f=0;f<e;f++)u[f]=a[u[f]];return{lut:v,offset:p}};z.estimateStatisticsFromHistograms=function(a){const d=[];for(let q=0;q<a.length;q++){const {min:c,max:h,size:l,counts:b}=a[q];let f=0;var n=0;for(var g=0;g<l;g++)f+=b[g],n+=g*b[g];n/=f;g=0;for(var k=0;k<l;k++)g+=b[k]*(k-n)**2;k=(h-c)/l;d.push({min:c,max:h,avg:(n+.5)*k+c,stddev:Math.sqrt(g/(f-1))*k})}return d};z.estimateStatisticsHistograms=H;z.getStretchCutoff=function(a,d){const {pixelBlock:n,bandIds:g,returnHistogramLut:k,
rasterInfo:q}=d;var c=null;d=null;var h=a.stretchType;"number"===typeof h&&(h=L.stretchTypeFunctionEnum[h]);a.dra?"minMax"===h&&n?.statistics?c=n.statistics.map(y=>[y.minValue,y.maxValue,0,0]):(d=H(n),c=null!=d?d.statistics:null,d=null!=d?d.histograms:null):(c=a.statistics?.length?a.statistics:q.statistics,d="histograms"in a?a.histograms:void 0,d||(d=q.histograms));"percentClip"!==h&&"histogramEqualization"!==h||d?.length||(h="minMax");var l=c?.length||d?.length||q.bandCount;const b=[],f=[];let p,
e,m;c&&!Array.isArray(c[0])&&(c=c.map(y=>[y.min,y.max,y.avg,y.stddev]));const [r,t]=K.getPixelValueRange(q.pixelType);if(!c?.length){c=[];for(e=0;e<l;e++)c.push([r,t,1,1]);"standardDeviation"===h&&(h="minMax")}switch(h){case "none":for(e=0;e<l;e++)b[e]=r,f[e]=t;break;case "minMax":for(e=0;e<l;e++){var x=c[e];b[e]=x[0];f[e]=x[1]}break;case "standardDeviation":({numberOfStandardDeviations:x=2}=a);for(e=0;e<l;e++){var v=c[e];b[e]=v[2]-x*v[3];f[e]=v[2]+x*v[3];b[e]<v[0]&&(b[e]=v[0]);f[e]>v[1]&&(f[e]=v[1])}break;
case "histogramEqualization":C.assertIsSome(d);for(e=0;e<l;e++)b[e]=d[e].min,f[e]=d[e].max;break;case "percentClip":C.assertIsSome(d);for(e=0;e<d.length;e++){c=d[e];v=new Uint32Array(c.size);var w=[...c.counts];20<=w.length&&(w[0]=w[1]=w[2]=w[w.length-1]=w[w.length-2]=0);x=0;l=(c.max-c.min)/c.size;p=-.5===c.min&&1===l?.5:0;for(m=0;m<c.size;m++)x+=w[m],v[m]=x;w=(a.minPercent||0)*x/100;b[e]=c.min+p;for(m=0;m<c.size;m++)if(v[m]>w){b[e]=c.min+l*(m+p);break}w=(1-(a.maxPercent||0)/100)*x;f[e]=c.max+p;for(m=
c.size-2;0<=m;m--)if(v[m]<w){f[e]=c.min+l*(m+2-p);break}f[e]<b[e]&&(c=b[e],b[e]=f[e],f[e]=c)}break;default:for(e=0;e<l;e++)x=c[e],b[e]=x[0],f[e]=x[1]}let u;"histogramEqualization"===h?(C.assertIsSome(d),h=d[0].size||256,a=0,k&&(u=d.map(y=>F(y)))):(h=a.max||255,a=a.min||0);return N({minCutOff:b,maxCutOff:f,outMax:h,outMin:a,histogramLut:u},g)};z.stretch=function(a,d){if(!a?.pixels?.length)return a;const {mask:n,bandMasks:g,width:k,height:q,pixels:c}=a,{minCutOff:h,maxCutOff:l,gamma:b}=d;var f=d.outMin||
0;const p=d.outMax||255,e=k*q,m=d.outputPixelType||"u8";a=a.pixels.map(()=>E.createEmptyBand(m,e));const r=a.length;var t=p-f,x=[],v=[];for(var w=0;w<r;w++)v[w]=l[w]-h[w],x[w]=0===v[w]?0:t/v[w];w=m.startsWith("u")||m.startsWith("s");d=!!d.isRenderer;if(b&&b.length>=r){x=D(r,b);for(var u=0;u<r;u++){var y=g?.[u]??n;for(let B=0;B<e;B++)if(null==y||y[B]){if(0===v[u]){a[u][B]=f;continue}var A=c[u][B];const I=(A-h[u])/v[u];let J=1;1<b[u]&&(J-=(1/t)**(I*x[u]));A<l[u]&&A>h[u]?(A=J*t*I**(1/b[u])+f,a[u][B]=
d?Math.floor(A):w?Math.round(A):A):a[u][B]=A>=l[u]?p:f}}}else for(t=0;t<r;t++)for(v=g?.[t]??n,u=0;u<e;u++)if(null==v||v[u])y=c[t][u],y<l[t]&&y>h[t]?(y=(y-h[t])*x[t]+f,a[t][u]=d?Math.floor(y):w?Math.round(y):y):a[t][u]=y>=l[t]?p:f;f=new E({width:k,height:q,mask:n,bandMasks:g,pixels:a,pixelType:m});f.updateStatistics();return f};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});