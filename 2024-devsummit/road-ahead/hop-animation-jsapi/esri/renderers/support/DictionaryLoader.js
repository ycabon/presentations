// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../request ../../core/Error ../../core/has ../../core/lang ../../core/Logger ../../core/LRUCache ../../core/promiseUtils ../../core/Version ../../layers/support/FieldsIndex ../../support/arcadeOnDemand ../../symbols/CIMSymbol ../../symbols/cim/OverrideHelper ../../symbols/cim/utils".split(" "),function(p,v,q,w,H,x,r,y,z,A,B,t,C,D,E){const F={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};
class G{constructor(a,c,e){this.url=this.fieldMap=this.config=null;this._ongoingRequests=new Map;this._symbolCache=new y.LRUCache(100);this._dictionaryPromise=this._fieldIndex=this._dictionaryVersion=null;this.url=a;this.config=c;this.fieldMap=e}getSymbolFields(){return this._symbolFields}async getSymbolAsync(a,c){this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(c));try{var e=await this._dictionaryPromise}catch(f){if(z.isAbortError(f))return this._dictionaryPromise=null}var d=
this._dictionaryVersion&&this._dictionaryVersion.since(4,0),g={};if(this.fieldMap)for(var h of this._symbolFields){var b=this._getFieldName(this.fieldMap[h]);if(b){const f=a.attributes[b];g[h]=d?f:null!=f?""+a.attributes[b]:""}else g[h]=""}d=null;try{d=e?.(g,c)}catch(f){return null}if(!d||"string"!==typeof d||"invalid"===d)return null;d=d.split(";");e=[];g=[];for(const f of d)if(f)if(f.includes("po:"))b=f.substr(3).split("|"),3===b.length&&(d=b[0],h=b[1],b=b[2],"DashTemplate"===h?b=b.split(" ").map(k=>
Number(k)):"Color"===h?(b=(new v(b)).toRgba(),b=[b[0],b[1],b[2],255*b[3]]):b=Number(b),g.push({primitiveName:d,propertyName:h,value:b,defaultValue:null}));else if(f.includes("|"))for(const k of f.split("|")){if(this._itemNames.has(k)){e.push(k);break}}else this._itemNames.has(f)&&e.push(f);return this._cimPartsToCIMSymbol(a,e,g,null==a.geometry||!a.geometry.hasZ&&"point"===a.geometry.type?!0:!1,c)}async fetchResources(a){if(this._dictionaryPromise)return this._dictionaryPromise;if(this.url){var c=
q(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:null!=a?a.signal:null}),[{data:e}]=await Promise.all([c,t.loadArcade()]);if(!e)throw this._dictionaryPromise=null,new w("esri.renderers.DictionaryRenderer","Bad dictionary data!");var {authoringInfo:d,dictionary_version:g,expression:h,itemsNames:b}=e;c=!1;g&&(this._dictionaryVersion=A.Version.parse(g),c=this._dictionaryVersion.since(4,0));this._refSymbolUrlTemplate=this.url+"/"+e.cimRefTemplateUrl;this._itemNames=
new Set(b);this._symbolFields=d.symbol;e={};if(this.config){const l=this.config;for(var f in l)e[f]=l[f]}if(d.configuration)for(var k of d.configuration)e.hasOwnProperty(k.name)||(e[k.name]=k.value);f=[];if(a?.fields&&this.fieldMap)for(const l of this._symbolFields){const n=this.fieldMap[l];k=a.fields.filter(m=>m.name.toLowerCase()===n?.toLowerCase());0<k.length&&f.push({...k[0],type:c?k[0].type:"esriFieldTypeString"})}0<f.length&&(this._fieldIndex=new B(f));return this._dictionaryPromise=a=t.createDictionaryExpression(h,
null!=a?a.spatialReference:null,f,e).then(l=>{const n={scale:0};return(m,u)=>{if(null==l)return null;m=l.repurposeFeature({geometry:null,attributes:m});n.scale=null!=u?u.scale??void 0:void 0;return l.evaluate({$feature:m,$view:n},l.services)}}).catch(l=>{r.getLogger("esri.renderers.support.DictionaryLoader").error("Creating dictinoary expression failed:",l);return null})}r.getLogger("esri.renderers.support.DictionaryLoader").error("no valid URL!")}async _cimPartsToCIMSymbol(a,c,e,d,g){const h=Array(c.length);
for(let b=0;b<c.length;b++)h[b]=this._getSymbolPart(c[b],g);c=await Promise.all(h);if(g=this.fieldMap){c=x.clone(c);for(const b of c)D.OverrideHelper.applyDictionaryTextOverrides(b,a,g,E.getTextCasing(b))}return new C({data:this._combineSymbolParts(c,e,d)})}async _getSymbolPart(a,c){var e=this._symbolCache.get(a);if(e)return e;if(this._ongoingRequests.has(a))return this._ongoingRequests.get(a).then(d=>d.data);e=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,a);c=q(e,{responseType:"json",query:{f:"json"},
...c});this._ongoingRequests.set(a,c);c.finally(()=>this._ongoingRequests.delete(a));try{const d=await c;this._symbolCache.put(a,d.data);return d.data}catch(d){throw d;}}_combineSymbolParts(a,c,e){if(!a||0===a.length)return null;const d={...a[0]};if(1<a.length){d.symbolLayers=[];for(const g of a)d.symbolLayers.unshift(...g.symbolLayers)}e&&(d.callout=F);return{type:"CIMSymbolReference",symbol:d,primitiveOverrides:c}}_getFieldName(a){if(null!==this._fieldIndex){const c=this._fieldIndex.get(a);return c?
c.name:a}return a}}p.DictionaryLoader=G;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});