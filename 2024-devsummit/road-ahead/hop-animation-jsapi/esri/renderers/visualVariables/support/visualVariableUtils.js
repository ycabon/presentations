// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../Color ../../../Graphic ../../../core/compilerUtils ../../../core/Logger ../../support/lengthUtils ./sizeVariableUtils".split(" "),function(p,w,D,E,F,G,m){function x(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"color"===r.type):a)if("esri.renderers.visualVariables.ColorVariable"!==a.declaredClass)q().warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");else{var d="number"===typeof b,e=d?null:b,f=
e?.attributes,g=d?b:null,k=a.field,{ipData:h,hasExpression:l}=a.cache;b=a.cache.compiledFunc;if(!k&&!l)return(c=a.stops)&&c[0]&&c[0].color;if("number"!==typeof g)if(l){if(null==c?.arcade){q().error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;k=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});e=g.createExecContext(e,k,c.timeZone);b||(b=g.createSyntaxTree(a.valueExpression),b=g.createFunction(b),a.cache.compiledFunc=
b);g=g.executeFunction(b,e)}else f&&(g=f[k]);e=a.normalizationField;f=null!=f&&null!=e?parseFloat(f[e]):void 0;if(null!=g&&(!e||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=v(g,h)))return f=d[0],e=d[1],c=f===e?a.stops[f].color:w.blendColors(a.stops[f].color,a.stops[e].color,d[2],null!=c?c.color:void 0),new w(c)}}function y(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"opacity"===r.type):a)if("esri.renderers.visualVariables.OpacityVariable"!==a.declaredClass)q().warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");
else{var d="number"===typeof b,e=d?null:b,f=e?.attributes,g=d?b:null,k=a.field,{ipData:h,hasExpression:l}=a.cache;b=a.cache.compiledFunc;if(!k&&!l)return(a=a.stops)&&a[0]&&a[0].opacity;if("number"!==typeof g)if(l){if(null==c?.arcade){q().error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;k=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});c=g.createExecContext(e,k,c.timeZone);b||(e=g.createSyntaxTree(a.valueExpression),
b=g.createFunction(e),a.cache.compiledFunc=b);g=g.executeFunction(b,c)}else f&&(g=f[k]);c=a.normalizationField;f=null!=f&&null!=c?parseFloat(f[c]):void 0;if(null!=g&&(!c||d||!isNaN(f)&&0!==f)&&(isNaN(f)||d||(g/=f),d=v(g,h))){c=d[0];f=d[1];if(c===f)return a.stops[c].opacity;c=a.stops[c].opacity;return c+(a.stops[f].opacity-c)*d[2]}}}function z(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(r=>"rotation"===r.type):a)if("esri.renderers.visualVariables.RotationVariable"!==
a.declaredClass)q().warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");else{var d=a.axis||"heading",e="heading"===d&&"arithmetic"===a.rotationType?90:0;d="heading"===d&&"arithmetic"===a.rotationType?-1:1;var f="number"===typeof b?null:b,g=f?.attributes,k=a.field,{hasExpression:h}=a.cache;b=a.cache.compiledFunc;var l=0;if(!k&&!h)return l;if(h){if(null==c?.arcade){q().error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;
k=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});c=g.createExecContext(f,k,c.timeZone);b||(b=g.createSyntaxTree(a.valueExpression),b=g.createFunction(b),a.cache.compiledFunc=b);l=g.executeFunction(b,c)}else g&&(l=g[k]||0);return l="number"!==typeof l||isNaN(l)?null:e+d*l}}function H(a,b,c){const d="number"===typeof b;var e=d?null:b;const f=e?.attributes;var g=d?b:null,{isScaleDriven:k}=a.cache;b=a.cache.compiledFunc;if(k)e=null!=c?c.scale:void 0,c=null!=
c?c.view:void 0,null==e||"3d"===c?(e=c=null,(e=a.stops)?(c=e[0].value,e=e[e.length-1].value):(c=a.minDataValue||0,e=a.maxDataValue||0),c=(c+e)/2):c=e,g=c;else if(!d)switch(a.inputValueType){case m.InputValueType.Expression:if(null==c?.arcade){q().error("Use of arcade expressions requires an arcade context");return}g=c.arcade.arcadeUtils;k=g.getViewInfo({viewingMode:c.viewingMode,scale:c.scale,spatialReference:c.spatialReference});c=g.createExecContext(e,k,c.timeZone);b||(e=g.createSyntaxTree(a.valueExpression),
b=g.createFunction(e),a.cache.compiledFunc=b);g=g.executeFunction(b,c);break;case m.InputValueType.Field:f&&(g=f[a.field]);break;case m.InputValueType.Unknown:g=null}if(!m.isValidNumber(g))return null;if(d||!a.normalizationField)return g;a=f?parseFloat(f[a.normalizationField]):null;return m.isValidNumber(a)&&0!==a?g/a:null}function t(a,b,c){if(a="visualVariables"in a&&a.visualVariables?a.visualVariables.find(e=>"size"===e.type):a)if("esri.renderers.visualVariables.SizeVariable"!==a.declaredClass)q().warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");
else{var d=H(a,b,c);b=A(d,a,b,c,a.cache.ipData);return null===b||void 0===b||isNaN(b)?0:b}}function n(a,b,c){return null==a?null:m.isSizeVariable(a)?t(a,b,c):m.isValidNumber(a)?a:null}function B(a,b,c){return m.isValidNumber(c)&&a>c?c:m.isValidNumber(b)&&a<b?b:a}function A(a,b,c,d,e){switch(b.transformationType){case m.TransformationType.Additive:return d=n(b.minSize,c,d),a+((d||b.minDataValue)??0);case m.TransformationType.Constant:return a=b.stops,a=a?.length&&a[0].size,null==a&&(a=b.minSize),n(a,
c,d);case m.TransformationType.ClampedLinear:e=(a-b.minDataValue)/(b.maxDataValue-b.minDataValue);var f=n(b.minSize,c,d);c=n(b.maxSize,c,d);d=null!=d?d.shape:void 0;a<=b.minDataValue?b=f:a>=b.maxDataValue?b=c:null==f||null==c?b=null:"area"===b.scaleBy&&d?(a=(b="circle"===d)?u*(f/2)**2:f*f,a+=e*((b?u*(c/2)**2:c*c)-a),b=b?2*Math.sqrt(a/u):Math.sqrt(a)):b=f+e*(c-f);return b;case m.TransformationType.Proportional:return e=null!=d?d.shape:void 0,a/=b.minDataValue,f=n(b.minSize,c,d),b=n(b.maxSize,c,d),
d=null,d="circle"===e?2*Math.sqrt(a*(f/2)**2):"square"===e||"diamond"===e||"image"===e?Math.sqrt(a*f**2):a*f,B(d,f,b);case m.TransformationType.Stops:{const [g,k,h]=v(a,e);g===k?b=n(b.stops?.[g].size,c,d):(a=n(b.stops?.[g].size,c,d),b=n(b.stops?.[k].size,c,d),b=a+(b-a)*h)}return b;case m.TransformationType.RealWorldSize:return e=(d?.resolution??1)*G.meterIn[b.valueUnit],f=n(b.minSize,c,d),d=n(b.maxSize,c,d),{valueRepresentation:b}=b,c=null,c="area"===b?2*Math.sqrt(a/u)/e:"radius"===b||"distance"===
b?2*a/e:a/e,B(c,f,d);case m.TransformationType.Identity:return a;case m.TransformationType.Unknown:return null}}function v(a,b){if(b){var c=0,d=b.length-1;b.some((e,f)=>{if(a<e)return d=f,!0;c=f;return!1});return[c,d,(a-b[c])/(b[d]-b[c])]}}const q=()=>F.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),C=new D,u=Math.PI;p.getAllSizes=function(a,b,c){const d=["proportional","proportional","proportional"];for(const e of a)switch(a=e.useSymbolValue?"symbol-value":t(e,b,c),e.axis){case "width":d[0]=
a;break;case "depth":d[1]=a;break;case "height":d[2]=a;break;case "width-and-depth":d[0]=a;d[1]=a;break;case "all":case void 0:case null:d[0]=a;d[1]=a;d[2]=a;break;default:E.neverReached(e.axis)}return d};p.getColor=x;p.getOpacity=y;p.getRotationAngle=z;p.getSize=t;p.getSizeForValue=A;p.getSizeFromNumberOrVariable=n;p.getSizeRangeAtScale=function(a,b,c){const {isScaleDriven:d}=a.cache;if(!(d&&"3d"===c||b))return null;c={scale:b,view:c};b=n(a.minSize,C,c);a=n(a.maxSize,C,c);if(null!=b||null!=a)return b>
a&&(c=a,a=b,b=c),{minSize:b,maxSize:a}};p.getVisualVariableValues=function(a,b,c){if(a.visualVariables){var d=[],e=[],f=[],g=[],k=[];for(const h of a.visualVariables)switch(h.type){case "color":e.push(h);break;case "opacity":f.push(h);break;case "rotation":k.push(h);break;case "size":g.push(h)}e.forEach(h=>{const l=x(h,b,c);d.push({variable:h,value:l})});f.forEach(h=>{const l=y(h,b,c);d.push({variable:h,value:l})});k.forEach(h=>{const l=z(h,b,c);d.push({variable:h,value:l})});g.forEach(h=>{const l=
t(h,b,c);d.push({variable:h,value:l})});return d.filter(h=>null!=h.value)}};p.viewScaleRE=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});