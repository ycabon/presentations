// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["./RectangleBinPack","../webgl/Rect","../../../webgl/enums","../../../webgl/Texture","../../../webgl/TextureDescriptor"],function(w,z,x,A,B){class C{constructor(b,g,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;this.width=b;this.height=g;this._glyphSource=c;this._binPack=new w(b-4,g-4);this._glyphData.push(new Uint8Array(b*g));this._dirties.push(!0);this._textures.push(void 0)}getGlyphItems(b,
g){const c=[],f=this._glyphSource,e=new Set,v=1/256;for(const d of g)e.add(Math.floor(d*v));const k=[];e.forEach(d=>{const a=b+d;this._rangePromises.has(a)?k.push(this._rangePromises.get(a)):(d=f.getRange(b,d).then(()=>{this._rangePromises["delete"](a)},()=>{this._rangePromises["delete"](a)}),this._rangePromises.set(a,d),k.push(d))});return Promise.all(k).then(()=>{let d=this._glyphIndex[b];d||(d={},this._glyphIndex[b]=d);for(const m of g){var a=d[m];if(a){c[m]={sdf:!0,rect:a.rect,metrics:a.metrics,
page:a.page,code:m};continue}var h=f.getGlyph(b,m);if(!h?.metrics)continue;a=h.metrics;let l;if(0===a.width)l=new z(0,0,0,0);else{const n=a.width+6,r=a.height+6;var p=n%4?4-n%4:4,q=r%4?4-r%4:4;1===p&&(p=5);1===q&&(q=5);l=this._binPack.allocate(n+p,r+q);l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=
new w(this.width-4,this.height-4),l=this._binPack.allocate(n+p,r+q));p=this._glyphData[this._currentPage];h=h.bitmap;let y;if(h)for(let t=0;t<r;t++){q=n*t;y=this.width*(l.y+t+1)+l.x;for(let u=0;u<n;u++)p[y+u+1]=h.at(q+u)}}d[m]={rect:l,metrics:a,tileIDs:null,page:this._currentPage};c[m]={sdf:!0,rect:l,metrics:a,page:this._currentPage,code:m};this._dirties[this._currentPage]=!0}return c})}removeGlyphs(b){for(const g in this._glyphIndex){const c=this._glyphIndex[g];if(!c)continue;let f;for(const e in c)if(f=
c[e],f.tileIDs["delete"](b),0===f.tileIDs.size){const v=this._glyphData[f.page],k=f.rect;let d,a;for(let h=0;h<k.height;h++)for(d=this.width*(k.y+h)+k.x,a=0;a<k.width;a++)v[d+a]=0;delete c[e];this._dirties[f.page]=!0}}}bind(b,g,c,f=0){if(!this._textures[c]){var e=new B.TextureDescriptor;e.pixelFormat=x.PixelFormat.ALPHA;e.wrapMode=x.TextureWrapMode.CLAMP_TO_EDGE;e.width=this.width;e.height=this.height;this._textures[c]=new A.Texture(b,e,new Uint8Array(this.width*this.height))}e=this._textures[c];
e.setSamplingMode(g);this._dirties[c]&&e.setData(this._glyphData[c]);b.bindTexture(e,f);this._dirties[c]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0;this._binPack=null;for(const b of this._textures)b&&b.dispose();this._textures.length=0}}return C});