// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["../../../../request","../../../../core/pbf"],function(q,r){class k{constructor(a){this._metrics=[];if(a){for(var b=new Map,d=0;a.next();)switch(a.tag()){case 1:const f=a.getMessage();for(;f.next();)switch(f.tag()){case 3:var c=f.getMessage();let e,g,h,l,m,n,p;for(;c.next();)switch(c.tag()){case 1:e=c.getUInt32();break;case 2:g=c.getBytes();break;case 3:h=c.getUInt32();break;case 4:l=c.getUInt32();break;case 5:m=c.getSInt32();break;case 6:n=c.getSInt32();break;case 7:p=c.getUInt32();break;
default:c.skip()}c.release();e&&(c=g?.length??0,this._metrics[e]={width:h,height:l,left:m,top:n,advance:p,startOffset:d,length:c},b.set(e,g),d+=c);break;default:f.skip()}f.release();break;default:a.skip()}a=new Uint8Array(d);d=this._metrics;for(const [f,e]of b){const {startOffset:g,length:h}=d[f];if(e)for(b=0;b<h;++b)a[g+b]=e[b]}this._allBitmaps=a}else this._allBitmaps=null}getMetrics(a){return this._metrics[a]}getBitmap(a){if(this._allBitmaps&&(a=this._metrics[a],void 0!==a)){var {startOffset:b,
length:d}=a;if(0!==d)return new t(this._allBitmaps,b,d)}}}class u{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(a){return this._ranges[a]}addRange(a,b){this._ranges[a]=b}}class v{constructor(a){this._glyphInfo={};this._baseURL=a}getRange(a,b){const d=this._getFontStack(a);if(d.getRange(b))return Promise.resolve();const c=256*b,f=c+255;if(this._baseURL)return a=this._baseURL.replace("{fontstack}",a).replace("{range}",c+"-"+f),q(a,{responseType:"array-buffer"}).then(e=>{d.addRange(b,
new k(new r(new Uint8Array(e.data),new DataView(e.data))))}).catch(()=>{d.addRange(b,new k)});d.addRange(b,new k);return Promise.resolve()}getGlyph(a,b){if(a=this._getFontStack(a))if(a=a.getRange(Math.floor(b/256)))return{metrics:a.getMetrics(b),bitmap:a.getBitmap(b)}}_getFontStack(a){let b=this._glyphInfo[a];b||=this._glyphInfo[a]=new u;return b}}class t{constructor(a,b,d){this._array=a;this._start=b;this.length=d}at(a){return 0<=a&&a<this.length?this._array[this._start+a]:void 0}}return v});