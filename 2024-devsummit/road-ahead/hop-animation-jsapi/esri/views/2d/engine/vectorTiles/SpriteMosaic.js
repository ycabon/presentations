// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../symbols/cim/rasterizingUtils ./RectangleBinPack ../webgl/Rect ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(r,p,t,u,v,w){class q{constructor(a,c,b=0){this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=a||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");
this._pageWidth=a;this._pageHeight=c;0<b&&(this._maxItemSize=b);this._binPack=new p(a-4,c-4)}destroy(){this.dispose()}dispose(){this._binPack=null;this._mosaicsData.length=0;this._mosaicRects={};for(const a of this._textures)a&&a.dispose();this._textures.length=0}getWidth(a){return a>=this._size.length?-1:this._size[a][0]}getHeight(a){return a>=this._size.length?-1:this._size[a][1]}getPageSize(a){return a>=this._size.length?null:this._size[a]}setSpriteSource(a){this.dispose();this.pixelRatio=a.devicePixelRatio;
if(0===this._mosaicsData.length){this._binPack=new p(this._pageWidth-4,this._pageHeight-4);const c=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));this._mosaicsData[0]=c;this._dirties.push(!0);this._size.push([this._pageWidth,this._pageHeight]);this._textures.push(void 0)}this._sprites=a}getSpriteItem(a,c=!1){var b=this._mosaicRects[a];if(b)return b;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;let d;a&&a.startsWith("dasharray-")?([b,d]=this._rasterizeDash(a),
c=!0):b=this._sprites.getSpriteInfo(a);if(!b?.width||!b.height||0>b.width||0>b.height)return null;const e=b.width,h=b.height,[f,g,k]=this._allocateImage(e,h);if(0>=f.width)return null;this._copy(f,b,g,k,c,d);b={type:"sprite",rect:f,width:e,height:h,sdf:b.sdf,simplePattern:!1,rasterizationScale:b.pixelRatio,page:g};return this._mosaicRects[a]=b}getSpriteItems(a){const c={};for(const b of a)c[b.name]=this.getSpriteItem(b.name,b.repeat);return c}getMosaicItemPosition(a,c){c=(a=this.getSpriteItem(a,c))&&
a.rect;if(!c)return null;c.width=a.width;c.height=a.height;return{tl:[c.x+2,c.y+2],br:[c.x+2+a.width,c.y+2+a.height],page:a.page}}bind(a,c,b=0,d=0){if(!(b>=this._size.length||b>=this._mosaicsData.length)){if(!this._textures[b]){var e=new w.TextureDescriptor;e.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE;e.width=this._size[b][0];e.height=this._size[b][1];this._textures[b]=new v.Texture(a,e,new Uint8Array(this._mosaicsData[b].buffer))}e=this._textures[b];e.setSamplingMode(c);this._dirties[b]&&e.setData(new Uint8Array(this._mosaicsData[b].buffer));
a.bindTexture(e,d);this._dirties[b]=!1}}static _copyBits(a,c,b,d,e,h,f,g,k,m,l){let n=d*c+b;f=g*h+f;if(l)for(f-=h,l=-1;l<=m;l++,n=((l+m)%m+d)*c+b,f+=h)for(g=-1;g<=k;g++)e[f+g]=a[n+(g+k)%k];else for(b=0;b<m;b++){for(d=0;d<k;d++)e[f+d]=a[n+d];n+=c;f+=h}}_copy(a,c,b,d,e,h){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(b>=this._mosaicsData.length)){var f=new Uint32Array(h?h.buffer:this._sprites.image.buffer),g=this._mosaicsData[b];g&&f||console.error("Source or target images are uninitialized!");
q._copyBits(f,h?c.width:this._sprites.width,c.x,c.y,g,d[0],a.x+2,a.y+2,c.width,c.height,e);this._dirties[b]=!0}}_allocateImage(a,c){a+=2;c+=2;var b=Math.max(a,c);if(this._maxItemSize&&this._maxItemSize<b)return b=new t(0,0,a,c),this._mosaicsData.push(new Uint32Array(a*c)),this._dirties.push(!0),this._size.push([a,c]),this._textures.push(void 0),[b,this._mosaicsData.length-1,[a,c]];b=a%4?4-a%4:4;let d=c%4?4-c%4:4;1===b&&(b=5);1===d&&(d=5);b=this._binPack.allocate(a+b,c+d);return 0>=b.width?(this._dirties[this._currentPage]||
(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new p(this._pageWidth-4,this._pageHeight-4),this._allocateImage(a,c)):[b,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(a){var c=a.match(/\[(.*?)\]/);if(!c)return null;c=c[1].split(",").map(Number);a=a.slice(a.lastIndexOf("-")+
1);const [b,d,e]=r.rasterizeDash(c,a);a=new Uint8Array(b.buffer);return[{x:0,y:0,width:d,height:e,sdf:!0,pixelRatio:1},a]}}return q});