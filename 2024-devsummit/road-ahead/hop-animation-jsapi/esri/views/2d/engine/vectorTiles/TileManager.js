// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/LRUCache","../../../../geometry/support/aaBoundingRect","../../tiling/TileCoverage","../../tiling/TileKey"],function(t,v,p,w,q){const x=(a,b)=>a+1/(1<<2*b);class y{constructor(a,b){this._tiles=new Map;this._tileCache=new v.LRUCache(40,c=>c.dispose());this._viewSize=[0,0];this._visibleTiles=new Map;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this._container=b}destroy(){for(const [,a]of this._tiles)a.dispose();this._tiles=
null;this._tileCache.clear();this._tileCache=null}update(a){this._updateCacheSize(a);const b=this.tileInfoView;a=b.getTileCoverage(a.state,0,!0,"smallest");if(!a)return!0;const {spans:c,lodInfo:e}=a,{level:f}=e,d=this._tiles,g=new Set,k=new Set;for(const {row:l,colFrom:m,colTo:z}of c)for(let n=m;n<=z;n++){const r=q.getId(f,l,e.normalizeCol(n),e.getWorldForColumn(n)),u=this._getOrAcquireTile(r);g.add(r);u.processed()?this._addToContainer(u):k.add(new q(r))}for(const [l,m]of d)m.isCoverage=g.has(l);
for(var h of k)this._findPlaceholdersForMissingTiles(h,g);h=!1;for(const [l,m]of d)m.neededForCoverage=g.has(l),m.neededForCoverage||m.isHoldingForFade&&b.intersects(a,m.key)&&g.add(l),m.isFading&&(h=!0);for(const [l]of this._tiles)g.has(l)||this._releaseTile(l);w.pool.release(a);return!h}clear(){this._tiles.clear();this._tileCache.clear();this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(a,b,c,e,f){const d=[0,0],g=[0,0];e.toMap(d,a-c,b+c);e.toMap(g,a+c,b-c);b=p.fromValues(Math.min(d[0],
g[0]),Math.min(d[1],g[1]),Math.max(d[0],g[0]),Math.max(d[1],g[1]));c=p.create();a=[];for(const [,k]of this._visibleTiles)this.tileInfoView.getTileBounds(c,k.key),p.intersects(b,c)&&a.push(k);if(null!=f&&0<f.length){const k=new Set(a.map(h=>h.id));f=f.filter(h=>!k.has(h.tileKey.id)).map(h=>this._visibleTiles.get(h.tileKey.id)).filter(h=>void 0!==h);a.push(...f)}return a}_findPlaceholdersForMissingTiles(a,b){var c=[];for(const [,e]of this._tiles)this._addPlaceholderChild(c,e,a,b);c=c.reduce(x,0);1E-6>
Math.abs(1-c)||this._addPlaceholderParent(a.id,b)}_addPlaceholderChild(a,b,c,e){if(!(b.key.level<=c.level)&&b.hasData()){var f=b.key,d=f.level-c.level;c.row===f.row>>d&&c.col===f.col>>d&&c.world===f.world&&(this._addToContainer(b),e.add(b.id),a.push(b.key.level-c.level))}}_addPlaceholderParent(a,b){const c=this._tiles;for(;;){{const [f,d,g,k]=a.split("/");a=parseInt(f,10);a=0===a?null:`${a-1}/${parseInt(d,10)>>1}/${parseInt(g,10)>>1}/${parseInt(k,10)}`}if(!a||b.has(a))break;const e=c.get(a);if(e&&
e.hasData()){this._addToContainer(e);b.add(e.id);break}}}_getOrAcquireTile(a){let b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))||(b=this.acquireTile(new q(a)));this._tiles.set(a,b);return b}_releaseTile(a){const b=this._tiles.get(a);this.releaseTile(b);this._removeFromContainer(b);this._tiles.delete(a);b.hasData()?this._tileCache.put(a,b,1):b.dispose()}_addToContainer(a){let b;const c=[],e=this._container;if(!e.contains(a)){var f=this._visibleTiles;for(const [,d]of f)this._canConnectDirectly(a,
d)&&c.push(d),null==b&&this._canConnectDirectly(d,a)&&(b=d);if(null!=b){for(const d of c)b.childrenTiles.delete(d),a.childrenTiles.add(d),d.parentTile=a;b.childrenTiles.add(a);a.parentTile=b}else for(const d of c)a.childrenTiles.add(d),d.parentTile=a;f.set(a.id,a);e.addChild(a)}}_removeFromContainer(a){this._visibleTiles.delete(a.id);this._container.removeChild(a);if(null!=a.parentTile){a.parentTile.childrenTiles.delete(a);for(const b of a.childrenTiles)null!=a.parentTile&&a.parentTile.childrenTiles.add(b)}for(const b of a.childrenTiles)b.parentTile=
a.parentTile;a.parentTile=null;a.childrenTiles.clear()}_canConnectDirectly(a,b){a=a.key;let {level:c,row:e,col:f,world:d}=b.key;for(b=this._visibleTiles;0<c;){c--;e>>=1;f>>=1;if(a.level===c&&a.row===e&&a.col===f&&a.world===d)return!0;if(b.has(`${c}/${e}/${f}/${d}`))break}return!1}_updateCacheSize(a){a=a.state.size;if(a[0]!==this._viewSize[0]||a[1]!==this._viewSize[1]){var b=Math.ceil(a[0]/512)+1,c=Math.ceil(a[1]/512)+1;this._viewSize[0]=a[0];this._viewSize[1]=a[1];this._tileCache.maxSize=5*b*c}}}
t.TileManager=y;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});