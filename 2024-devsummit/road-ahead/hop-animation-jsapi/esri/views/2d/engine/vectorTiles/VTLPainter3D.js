// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["../../../../core/maybe","../vtlBrushes","./shaders/VTLMaterialManager","./style/StyleDefinition","../../../webgl/enums"],function(m,n,p,h,k){class q{constructor(a,e){this.spriteMosaic=a;this.glyphMosaic=e;this._brushCache=new Map;this._vtlMaterialManager=new p}dispose(){this._brushCache&&(this._brushCache.forEach(a=>a.dispose()),this._brushCache=null);this._vtlMaterialManager=m.disposeMaybe(this._vtlMaterialManager);this.spriteMosaic.dispose();this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(a,
e,c){c=c.layers;a.renderPass="translucent";for(let d=0;d<c.length;d++){const f=c[d];if(f.type===h.StyleLayerType.SYMBOL){var b=f.getLayoutProperty("visibility");b&&b.getValue()===h.Visibility.NONE||(b=a.displayLevel,void 0!==f.minzoom&&f.minzoom>b+1E-6||void 0!==f.maxzoom&&f.maxzoom<=b-1E-6||(a.styleLayerUID=f.uid,a.styleLayer=f,this._drawWithBrush(a,e,"vtlSymbol")))}}}drawBackground(a,e,c){if(0!==c.backgroundBucketIds.length){var {context:b,displayLevel:d,requiredLevel:f}=a;e.key.level=f;b.setBlendingEnabled(!0);
b.setDepthTestEnabled(!1);b.setStencilTestEnabled(!1);a.renderPass="background";c.backgroundBucketIds.forEach(g=>{g=c.getLayerById(g);if(g.type===h.StyleLayerType.BACKGROUND){var l=g.getLayoutProperty("visibility");l&&l.getValue()===h.Visibility.NONE||void 0!==g.minzoom&&g.minzoom>d+1E-6||void 0!==g.maxzoom&&g.maxzoom<=d-1E-6||(a.styleLayerUID=g.uid,a.styleLayer=g,this._drawWithBrush(a,e,"vtlBackground"))}})}}drawTile(a,e,c,b){const {context:d}=a;c=c.layers;d.setBlendingEnabled(!1);d.setDepthTestEnabled(!0);
d.setDepthWriteEnabled(!0);d.setDepthFunction(k.CompareFunction.LEQUAL);a.renderPass="opaque";for(var f=c.length-1;0<=f;f--){var g=c[f];null!=b&&b!==g.type||this._renderStyleLayer(g,a,e,!1)}d.setDepthWriteEnabled(!1);d.setBlendingEnabled(!0);d.setBlendFunctionSeparate(k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA,k.BlendFactor.ONE,k.BlendFactor.ONE_MINUS_SRC_ALPHA);a.renderPass="translucent";for(f=0;f<c.length;f++)g=c[f],null!=b&&b!==g.type||this._renderStyleLayer(g,a,e,!1);d.setDepthTestEnabled(!1);
d.bindVAO()}_renderStyleLayer(a,e,c,b){if(b||a&&c.layerData.has(a.uid))if(b=a.getLayoutProperty("visibility"),!b||b.getValue()!==h.Visibility.NONE){({renderPass:b}=e);switch(a.type){case h.StyleLayerType.BACKGROUND:if("background"!==b)return;var d="vtlBackground";break;case h.StyleLayerType.FILL:if("opaque"!==b&&"translucent"!==e.renderPass)return;d="vtlFill";break;case h.StyleLayerType.LINE:if("translucent"!==b)return;d="vtlLine";break;case h.StyleLayerType.CIRCLE:if("translucent"!==b)return;d="vtlCircle";
break;case h.StyleLayerType.SYMBOL:if("translucent"!==b)return;d="vtlSymbol"}b=e.displayLevel;void 0!==a.minzoom&&a.minzoom>b+1E-6||void 0!==a.maxzoom&&a.maxzoom<=b-1E-6||({context:b}=e,b.setStencilTestEnabled(!1),b.setStencilWriteMask(0),e.styleLayerUID=a.uid,e.styleLayer=a,this._drawWithBrush(e,c,d))}}_drawWithBrush(a,e,c){this._brushCache.has(c)||this._brushCache.set(c,new n.vtlBrushes[c]);this._brushCache.get(c).drawMany(a,[e])}}return q});