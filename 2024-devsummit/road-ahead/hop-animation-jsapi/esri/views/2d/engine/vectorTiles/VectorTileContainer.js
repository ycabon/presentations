// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../geometry/support/aaBoundingRect ./decluttering/SymbolFader ./style/StyleDefinition ../webgl/enums ../webgl/RenderableTile ../webgl/TileContainer ../../tiling/TileCoverage ../../tiling/TileKey ../../../webgl/enums".split(" "),function(y,z,C,l,t,D,E,F,G,f){function A(a,b){if(a){const c=a.getLayoutProperty("visibility");if(!c||c.getValue()!==l.Visibility.NONE&&(void 0===a.minzoom||a.minzoom<b+1E-6)&&(void 0===a.maxzoom||a.maxzoom>=b-1E-6))return!0}return!1}class H extends E{constructor(a){super(a);
this._backgroundTiles=[]}destroy(){this.removeAllChildren();this._spriteMosaic?.dispose();this._spriteMosaic=null;this._glyphMosaic?.dispose();this._glyphMosaic=null;null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null);this._styleRepository=null;this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(a,b,c,h){this._spriteMosaic=a;
this._glyphMosaic=b;this._styleRepository=c;this._tileInfoView=h;null==this._symbolFader&&(this._symbolFader=new C.SymbolFader(this._styleRepository,this.children));this._symbolFader.styleRepository=c}setSpriteMosaic(a){this._spriteMosaic?.dispose();this._spriteMosaic=a}deleteStyleLayers(a){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(a)}createRenderParams(a){return{...super.createRenderParams(a),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,
hasClipping:!!this._clippingInfos}}doRender(a){!this.visible||a.drawPhase!==t.WGLDrawPhase.MAP&&a.drawPhase!==t.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||super.doRender(a)}addChild(a){super.addChild(a);null!=this._symbolFader?this._symbolFader.addTile(a):a.decluttered=!0;this.requestRender();return a}removeChild(a){null!=this._symbolFader&&this._symbolFader.removeTile(a);this.requestRender();return super.removeChild(a)}renderChildren(a){const {drawPhase:b}=a;b===t.WGLDrawPhase.DEBUG?super.renderChildren(a):
this._doRender(a)}removeAllChildren(){for(let a=0;a<this.children.length;a++){const b=this.children[a];null!=this._symbolFader&&this._symbolFader.removeTile(b);b.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(a=>a.neededForCoverage&&a.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(a){const {context:b}=a;var c=this._styleRepository;if(c){var h=c.layers;0<c.backgroundBucketIds.length&&(a.renderPass="background",
this._renderBackgroundLayers(a,c.backgroundBucketIds));super.renderChildren(a);a.drawPhase===t.WGLDrawPhase.MAP&&this._fade(a.displayLevel,a.state);if((c=this.children.filter(d=>d.visible&&d.hasData()))&&0!==c.length){for(var e of c)e.triangleCount=0;b.setStencilWriteMask(0);b.setColorMask(!0,!0,!0,!0);b.setStencilOp(f.StencilOperation.KEEP,f.StencilOperation.KEEP,f.StencilOperation.REPLACE);b.setStencilTestEnabled(!0);b.setBlendingEnabled(!1);b.setDepthTestEnabled(!0);b.setDepthWriteEnabled(!0);
b.setDepthFunction(f.CompareFunction.LEQUAL);b.setClearDepth(1);b.clear(b.gl.DEPTH_BUFFER_BIT);a.renderPass="opaque";for(e=h.length-1;0<=e;e--)this._renderStyleLayer(h[e],a,c);b.setDepthWriteEnabled(!1);b.setBlendingEnabled(!0);b.setBlendFunctionSeparate(f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA,f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA);a.renderPass="translucent";for(e=0;e<h.length;e++)this._renderStyleLayer(h[e],a,c);b.bindVAO();b.setStencilTestEnabled(!0);b.setBlendingEnabled(!0);
for(const d of c)d.debugInfo.display.triangleCount=d.triangleCount}else b.bindVAO(),b.setStencilTestEnabled(!0),b.setBlendingEnabled(!0)}}_fade(a,b){null!=this._symbolFader&&(this._symbolFader.update(a,b)||this.requestRender())}_renderStyleLayer(a,b,c){const {painter:h,renderPass:e}=b;if(void 0!==a){var d=a.getLayoutProperty("visibility");if(!d||d.getValue()!==l.Visibility.NONE){switch(a.type){case l.StyleLayerType.BACKGROUND:return;case l.StyleLayerType.FILL:if("opaque"!==e&&"translucent"!==b.renderPass)return;
var m="vtlFill";break;case l.StyleLayerType.LINE:if("translucent"!==e)return;m="vtlLine";break;case l.StyleLayerType.CIRCLE:if("translucent"!==e)return;m="vtlCircle";break;case l.StyleLayerType.SYMBOL:if("translucent"!==e)return;m="vtlSymbol"}c=a.type===l.StyleLayerType.SYMBOL?c.filter(k=>k.decluttered):c.filter(k=>k.neededForCoverage);if("vtlSymbol"!==m&&(d=b.displayLevel,0===c.length||void 0!==a.minzoom&&a.minzoom>=d+1E-6||void 0!==a.maxzoom&&a.maxzoom<d-1E-6))return;d=a.uid;b.styleLayerUID=d;b.styleLayer=
a;for(const k of c)if(k.layerData.has(d)){h.renderObjects(b,c,m);break}}}}_renderBackgroundLayers(a,b){const {context:c,displayLevel:h,painter:e,state:d}=a,m=this._styleRepository;var k=!1;for(var q of b)if(m.getLayerById(q).type===l.StyleLayerType.BACKGROUND&&A(m.getLayerById(q),h)){k=!0;break}if(k){k=this._tileInfoView.getTileCoverage(a.state,0,!0,"smallest");var {spans:I,lodInfo:r}=k,{level:u}=r,w=z.create();q=[];if(this._renderPasses){var n=this._renderPasses[0];null!=this._clippingInfos&&(n.brushes[0].prepareState(a),
n.brushes[0].drawMany(a,this._clippingInfos))}n=this._backgroundTiles;var x=0;for(const {row:v,colFrom:J,colTo:K}of I)for(let p=J;p<=K;p++){if(x<n.length){var g=n[x];g.key.set(u,v,r.normalizeCol(p),r.getWorldForColumn(p));this._tileInfoView.getTileBounds(w,g.key,!1);g.x=w[0];g.y=w[3];g.resolution=this._tileInfoView.getTileResolution(u)}else{g=new G(u,v,r.normalizeCol(p),r.getWorldForColumn(p));const B=this._tileInfoView.getTileBounds(z.create(),g),L=this._tileInfoView.getTileResolution(u);g=new D.RenderableTile(g,
L,B[0],B[3],512,512,4096,4096);n.push(g)}g.setTransform(d);q.push(g);x++}c.setStencilWriteMask(0);c.setColorMask(!0,!0,!0,!0);c.setStencilOp(f.StencilOperation.KEEP,f.StencilOperation.KEEP,f.StencilOperation.REPLACE);c.setStencilFunction(f.CompareFunction.EQUAL,0,255);c.setStencilTestEnabled(!0);for(const v of b)b=m.getLayerById(v),b.type===l.StyleLayerType.BACKGROUND&&A(b,h)&&(a.styleLayerUID=b.uid,a.styleLayer=b,e.renderObjects(a,q,"vtlBackground"));F.pool.release(k)}}}y.VectorTileContainer=H;Object.defineProperty(y,
Symbol.toStringTag,{value:"Module"})});