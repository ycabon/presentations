// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../Graphic ../../../../core/MapUtils ../../../../core/pbf ../../../../core/libs/rbush/PooledRBush ./enums ./Feature ./GeometryUtils ./SourceLayerData ./style/StyleLayer".split(" "),function(z,E,A,F,G,B,H,C,I){const J=(a,b)=>{const c=a.vtlSymbol.sourceTile,d=b.vtlSymbol.sourceTile;return c.level!==d.level?c.level-d.level:c.row!==d.row?c.row-d.row:c.col!==d.col?c.col-d.col:a.styleLayerUID-b.styleLayerUID};class D{constructor(a,b,c,d,g){this.tileKey=a;this._tileHandler=this._styleRepository=
this._index=null;this._tileKeyToPBF=new Map;this._tileLayerData=b;this._styleRepository=c;this._tileHandler=d;this._parentLayer=g}static create(a,b,c,d,g){return new D(a,b,c,d,g)}clear(){this._index?.clear();this._tileKeyToPBF.clear()}async queryAttributes(a,b,c,d,g){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return[];null===this._index&&(this._index=new F.PooledRBush(100,K),await this._indexLayers());const e=[];this._queryIndex(e,a,b,c,this.tileKey.level,d);g&&0<
g?.length&&await this._getSymbolsAttributes(e,g);return e}async _indexLayers(){const a=this.tileKey,b=this._styleRepository.layers,c=await this._getTilePayload(a);for(const [g,e]of this._tileLayerData){const h=b[g];var d=c.find(n=>n.sourceName===h.source);if(!d)continue;const {protobuff:k,key:l}=d;e.type!==G.BucketType.SYMBOL&&(d=1<<a.level-l.level,this._indexLayer(h,k,a.level,d,a.row-l.row*d,a.col-l.col*d))}}_indexLayer(a,b,c,d,g,e){const h=a.sourceLayer,k=a.getFeatureFilter(),l=c+1,n=H.getTileMargins(c);
for(b=new A(new Uint8Array(b),new DataView(b));b.next();)switch(b.tag()){case 3:var p=b.getMessage();const r=new C(p);p.release();if(r.name!==h)continue;p=r.getData();var m=r.extent/d;const v=m*e-n,t=m*g-n,x=v+m+2*n,L=t+m+2*n,M=m/512,u=4096/m,y=m*e;for(m*=g;p.nextTag(2);){var f=p.getMessage();const w=new B(f,r);f.release();if(!k||k.filter(w,c)){var q=w.values||{};f=q._minzoom;q=q._maxzoom;f&&f>=10*l||q&&q<=10*c||(f=a.getFeatureInflatedBounds(w,c,r.extent,M),null==f||f[0]>x||f[1]>L||f[2]<v||f[3]<t||
(f[0]=(f[0]-y)*u,f[1]=(f[1]-m)*u,f[2]=(f[2]-y)*u,f[3]=(f[3]-m)*u,this._index.insert(new I.IndexItem(a,w,f,u,y,m))))}}break;default:b.skip()}}async _getSymbolsAttributes(a,b){if(!b||0===b.length)return a;var c=[];b.sort(J);let d=b[0].styleLayerUID;var g=0;for(var e=0;e<b.length;e++)d!==b[e].styleLayerUID&&(c.push({from:g,to:e,styleLayerUID:d,sourceTileKey:b[e].vtlSymbol.sourceTile}),g=e,d=b[e].styleLayerUID);c.push({from:g,to:b.length,styleLayerUID:d,sourceTileKey:b[b.length-1].vtlSymbol.sourceTile});
g=this._styleRepository.layers;e=null;let h;for(const k of c)c=await this._getTilePayload(k.sourceTileKey),h=g[k.styleLayerUID],(e=!!h&&c.find(l=>l.sourceName===h.source))&&this._addSymbolsAttributes(a,b.slice(k.from,k.to).map(l=>l.vtlSymbol),d,e);return a}_addSymbolsAttributes(a,b,c,d){const g=this._styleRepository.layers,e=d.key,h=this.tileKey,k=1<<h.level-e.level;this._getSymbolAttributes(d.protobuff,b,c,k,h.row-e.row*k,h.col-e.col*k).forEach(l=>{const {attributes:n,tilePoint:p}=l;a.push({layerId:g[c].id,
layerIndex:c,graphic:new z({attributes:n,origin:{type:"vector-tile",layerId:g[c].id,layerIndex:c,layer:this._parentLayer}}),tilePoint:p})})}_getSymbolAttributes(a,b,c,d,g,e){const h=[],k=this._styleRepository.layers;let l=0;b.sort((f,q)=>f.featureIndex-q.featureIndex);for(a=new A(new Uint8Array(a),new DataView(a));a.next();)switch(a.tag()){case 3:var n=a.getMessage();const f=new C(n);n.release();if(f.name!==k[c].sourceLayer)continue;n=f.getData();var p=f.extent/d;const q=4096/p,r=p*e;p*=g;let v=0;
for(;n.nextTag(2);){const t=n.getMessage();if(v++===b[l].featureIndex){var m=new B(t,f);const x=m.values;m=m.getGeometry();h.push({attributes:x,tilePoint:null!=m?[q*(m[0][0].x-r),q*(m[0][0].y-p)]:null});l++}t.release();if(l===b.length)return h}break;default:a.skip()}return h}_queryIndex(a,b,c,d,g,e){const h=8*d*(window.devicePixelRatio||1);this._index?.search({minX:b-h,minY:c-h,maxX:b+h,maxY:c+h},k=>{const {layer:l,feature:n}=k;l.isIntersectingFeature(b,c,d,n,g,e,k)&&a.push({layerId:l.id,layerIndex:l.uid,
tilePoint:null,graphic:new z({attributes:n.values,origin:{type:"vector-tile",layerId:k.layer.id,layerIndex:k.layer.uid,layer:this._parentLayer}})})});return a}async _getTilePayload(a){return E.getOrCreateMapValue(this._tileKeyToPBF,a.id,()=>this._tileHandler.fetchTilePBFs(a)).then(b=>b)}}const K=a=>({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]});return D});