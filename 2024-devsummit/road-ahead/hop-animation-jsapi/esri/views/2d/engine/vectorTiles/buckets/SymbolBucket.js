// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../../core/BidiEngine ../../../../../core/maybe ../../../../../core/string ../../../../../geometry/support/TileClipper ../enums ../GeometryUtils ../Placement ../TextShaping ./BaseBucket ../style/StyleDefinition ../style/StyleLayer".split(" "),function(M,N,J,C,O,B,F,I,P,y,K){function Q(b,a){return b.iconMosaicItem&&a.iconMosaicItem?b.iconMosaicItem.page===a.iconMosaicItem.page?0:b.iconMosaicItem.page-a.iconMosaicItem.page:b.iconMosaicItem&&!a.iconMosaicItem?1:!b.iconMosaicItem&&a.iconMosaicItem?
-1:0}class D extends P{constructor(b,a,f,e,n,c,d,k,h){super(a,f,h.getSpriteItems());this.type=O.BucketType.SYMBOL;this._markerMap=new Map;this._glyphMap=new Map;this._glyphBufferDataStorage=new Map;this._isIconSDF=!1;this._sourceTileKey=b;this._iconVertexBuffer=e;this._iconIndexBuffer=n;this._textVertexBuffer=c;this._textIndexBuffer=d;this._placementEngine=k;this._workerTileHandler=h}get markerPageMap(){return this._markerMap}get glyphsPageMap(){return this._glyphMap}get symbolInstances(){return this._symbolInstances}getResources(b,
a,f){const e=this.layer,n=this.zoom;b&&b.setExtent(this.layerExtent);const c=e.getLayoutProperty("icon-image"),d=e.getLayoutProperty("text-field");let k=e.getLayoutProperty("text-transform"),h=e.getLayoutProperty("text-font");const t=[];let g;c&&!c.isDataDriven&&(g=c.getValue(n));let u;d&&!d.isDataDriven&&(u=d.getValue(n));let p;k&&k.isDataDriven||(p=e.getLayoutValue("text-transform",n),k=null);let q;h&&h.isDataDriven||(q=e.getLayoutValue("text-font",n),h=null);for(const l of this._features){var r=
l.getGeometry(b);if(!r||0===r.length)continue;let x;c&&(x=c.isDataDriven?c.getValue(n,l):this._replaceKeys(g,l.values))&&a(x);let w;var m=!1;if(d&&(w=d.isDataDriven?d.getValue(n,l):this._replaceKeys(u,l.values))){w=w.replaceAll("\\n","\n");k&&(p=k.getValue(n,l));switch(p){case y.TextTransform.LOWERCASE:w=w.toLowerCase();break;case y.TextTransform.UPPERCASE:w=w.toUpperCase()}D._bidiEngine.hasBidiChar(w)&&(m="rtl"===D._bidiEngine.checkContextual(w)?"IDNNN":"ICNNN",w=D._bidiEngine.bidiTransform(w,m,
"VLYSN"),m=!0);if(0<w.length){h&&(q=h.getValue(n,l));for(const z of q){var v=f[z];v||=f[z]=new Set;for(const A of w){const E=A.codePointAt(0);null!=E&&v.add(E)}}}}if(x||w)v=e.getLayoutValue("symbol-sort-key",n,l),r={feature:l,sprite:x,label:w,rtl:m,geometry:r,hash:(w?J.numericHash(w):0)^(x?J.numericHash(x):0),priority:v,textFont:q},t.push(r)}this._symbolFeatures=t}processFeatures(b){b&&b.setExtent(this.layerExtent);var a=this.layer;b=this.zoom;const f=a.getLayoutValue("symbol-placement",b),e=f!==
y.SymbolPlacement.POINT,n=a.getLayoutValue("symbol-spacing",b)*F.tilePixelRatio;var c=a.getLayoutProperty("icon-image"),d=a.getLayoutProperty("text-field");const k=c?new K.IconLayout(a,b,e):null;a=d?new K.TextLayout(a,b,e):null;const h=this._workerTileHandler;let t;c&&(t=h.getSpriteItems());this._iconIndexStart=3*this._iconIndexBuffer.index;this._textIndexStart=3*this._textIndexBuffer.index;this._textIndexCount=this._iconIndexCount=0;this._markerMap.clear();this._glyphMap.clear();c=[];d=1;a&&a.size&&
(d=a.size/I.sdfGlyphSize);const g=a?a.maxAngle*B.cDegToRad:0,u=a?a.size*F.tilePixelRatio:0;for(const m of this._symbolFeatures){let v;k&&t&&m.sprite&&(v=t[m.sprite])&&v.sdf&&(this._isIconSDF=!0);v&&k.update(b,m.feature);var p=void 0,q=0,r=m.label;if(r){N.assertIsSome(a);a.update(b,m.feature);p=e&&a.rotationAlignment===y.RotationAlignment.MAP?a.keepUpright:a.writingMode&&a.writingMode.includes(y.TextWritingMode.VERTICAL);let l=.5;switch(a.anchor){case y.SymbolAnchor.TOP_LEFT:case y.SymbolAnchor.LEFT:case y.SymbolAnchor.BOTTOM_LEFT:l=
0;break;case y.SymbolAnchor.TOP_RIGHT:case y.SymbolAnchor.RIGHT:case y.SymbolAnchor.BOTTOM_RIGHT:l=1}let x=.5;switch(a.anchor){case y.SymbolAnchor.TOP_LEFT:case y.SymbolAnchor.TOP:case y.SymbolAnchor.TOP_RIGHT:x=0;break;case y.SymbolAnchor.BOTTOM_LEFT:case y.SymbolAnchor.BOTTOM:case y.SymbolAnchor.BOTTOM_RIGHT:x=1}let w=.5;switch(a.justify){case y.TextJustification.AUTO:w=l;break;case y.TextJustification.LEFT:w=0;break;case y.TextJustification.RIGHT:w=1}const z=a.letterSpacing*I.sdfGlyphSize,A=e?
0:a.maxWidth*I.sdfGlyphSize,E=a.lineHeight*I.sdfGlyphSize,G=m.textFont.map(H=>h.getGlyphItems(H));if((p=(new I.TextShaping(G,A,E,z,l,x,w)).getShaping(r,m.rtl,p))&&0<p.length){q=1E30;r=-1E30;for(const H of p)q=Math.min(q,H.x),r=Math.max(r,H.x);q=(r-q+2*I.sdfGlyphSize)*d*F.tilePixelRatio}}for(let l of m.geometry){r=[];f===y.SymbolPlacement.LINE?(p?.length&&a?.size&&(l=D._smoothVertices(l,a.size*F.tilePixelRatio*(2+Math.min(2,4*Math.abs(a.offset[1]))))),D._pushAnchors(r,l,n,q)):f===y.SymbolPlacement.LINE_CENTER?
D._pushCenterAnchor(r,l):m.feature.type===C.GeometryType.Polygon?D._pushCentroid(r,l):r.push(new F.Anchor(l[0].x,l[0].y));for(const x of r)0>x.x||x.x>F.tileCoordSize||0>x.y||x.y>F.tileCoordSize||e&&0<q&&a?.rotationAlignment===y.RotationAlignment.MAP&&!D._honorsTextMaxAngle(l,x,q,g,u)||(r={shaping:p,line:l,iconMosaicItem:v,anchor:x,symbolFeature:m,textColliders:[],iconColliders:[],textVertexRanges:[],iconVertexRanges:[]},c.push(r),this._processFeature(r,k,a))}}c.sort(Q);this._addPlacedGlyphs();this._symbolInstances=
c}serialize(){var b=14+this.layerUIDs.length;b+=3*this.markerPageMap.size;b+=3*this.glyphsPageMap.size;b+=D._symbolsSerializationLength(this._symbolInstances);b+=this._iconVertexBuffer.array.length;b+=this._iconIndexBuffer.array.length;b+=this._textVertexBuffer.array.length;b+=this._textIndexBuffer.array.length;b=new Uint32Array(b);var a=new Int32Array(b.buffer),f=new Float32Array(b.buffer);const [e,n,c]=this._sourceTileKey.split("/");let d=0;b[d++]=this.type;b[d++]=this.layerUIDs.length;for(let k=
0;k<this.layerUIDs.length;k++)b[d++]=this.layerUIDs[k];b[d++]=this._isIconSDF?1:0;b[d++]=parseFloat(e);b[d++]=parseFloat(n);b[d++]=parseFloat(c);b[d++]=this.markerPageMap.size;for(const [k,[h,t]]of this.markerPageMap)b[d++]=k,b[d++]=h,b[d++]=t;b[d++]=this.glyphsPageMap.size;for(const [k,[h,t]]of this.glyphsPageMap)b[d++]=k,b[d++]=h,b[d++]=t;b[d++]=this._iconVertexBuffer.index/4;b[d++]=this._textVertexBuffer.index/4;d=D.serializeSymbols(b,a,f,d,this._symbolInstances);b[d++]=this._iconVertexBuffer.array.length;
for(f=0;f<this._iconVertexBuffer.array.length;f++)a[d++]=this._iconVertexBuffer.array[f];b[d++]=this._iconIndexBuffer.array.length;for(f=0;f<this._iconIndexBuffer.array.length;f++)b[d++]=this._iconIndexBuffer.array[f];b[d++]=this._textVertexBuffer.array.length;for(f=0;f<this._textVertexBuffer.array.length;f++)a[d++]=this._textVertexBuffer.array[f];b[d++]=this._textIndexBuffer.array.length;for(a=0;a<this._textIndexBuffer.array.length;a++)b[d++]=this._textIndexBuffer.array[a];return b.buffer}static _symbolsSerializationLength(b){let a;
a=1;for(const f of b||[]){a+=5;a+=1;for(const e of f.textColliders)a+=10;for(const e of f.iconColliders)a+=10;a+=1;a+=2*f.textVertexRanges.length;a+=1;a+=2*f.iconVertexRanges.length}return a}static serializeSymbols(b,a,f,e,n){n=n||[];a[e++]=n.length;for(const c of n){a[e++]=c.anchor.x;a[e++]=c.anchor.y;a[e++]=c.symbolFeature.hash;a[e++]=c.symbolFeature.priority;a[e++]=c.symbolFeature.feature.featureIndex;a[e++]=c.textColliders.length+c.iconColliders.length;for(const d of c.textColliders)a[e++]=d.xTile,
a[e++]=d.yTile,a[e++]=d.dxPixels,a[e++]=d.dyPixels,a[e++]=d.hard?1:0,a[e++]=d.partIndex,f[e++]=d.minLod,f[e++]=d.maxLod,a[e++]=d.width,a[e++]=d.height;for(const d of c.iconColliders)a[e++]=d.xTile,a[e++]=d.yTile,a[e++]=d.dxPixels,a[e++]=d.dyPixels,a[e++]=d.hard?1:0,a[e++]=d.partIndex,f[e++]=d.minLod,f[e++]=d.maxLod,a[e++]=d.width,a[e++]=d.height;a[e++]=c.textVertexRanges.length;for(const [d,k]of c.textVertexRanges)a[e++]=d,a[e++]=k;a[e++]=c.iconVertexRanges.length;for(const [d,k]of c.iconVertexRanges)a[e++]=
d,a[e++]=k}return e}_replaceKeys(b,a){return b.replaceAll(/{([^{}]+)}/g,(f,e)=>e in a?a[e]:"")}_processFeature(b,a,f){const {line:e,iconMosaicItem:n,shaping:c,anchor:d}=b,k=this.zoom;var h=this.layer,t=!!n,g=!0;t&&(g=a?.optional||!n);var u=c&&0<c.length,p=u?f?.optional:!0,q;t&&(q=this._placementEngine.getIconPlacement(d,n,a));if(q||g){var r;u&&(r=this._placementEngine.getTextPlacement(d,c,e,f));if(r||p){q&&r||(p||g?p||r?g||q||(r=null):q=null:r=q=null);if(r&&(t=h.hasDataDrivenText?h.textMaterial.encodeAttributes(b.symbolFeature.feature,
k,h):null,this._storePlacedGlyphs(b,r.shapes,k,f.rotationAlignment,t),r.textColliders)){b.textColliders=r.textColliders;for(var m of r.textColliders)if(m.minLod=Math.max(k+B.log2(m.minLod),0),m.maxLod=Math.min(k+B.log2(m.maxLod),25),f=m.angle){g=Math.cos(f);var v=Math.sin(f);u=m.dxPixels*g-m.dyPixels*v;f=m.dxPixels*v+m.dyPixels*g;p=(m.dxPixels+m.width)*g-m.dyPixels*v;r=(m.dxPixels+m.width)*v+m.dyPixels*g;const l=m.dxPixels*g-(m.dyPixels+m.height)*v;t=m.dxPixels*v+(m.dyPixels+m.height)*g;const x=(m.dxPixels+
m.width)*g-(m.dyPixels+m.height)*v;v=(m.dxPixels+m.width)*v+(m.dyPixels+m.height)*g;g=Math.min(u,p,l,x);u=Math.max(u,p,l,x);p=Math.min(f,r,t,v);f=Math.max(f,r,t,v);m.dxPixels=g;m.dyPixels=p;m.width=u-g;m.height=f-p}}if(q&&(h=h.hasDataDrivenIcon?h.iconMaterial.encodeAttributes(b.symbolFeature.feature,k,h):null,this._addPlacedIcons(b,q.shapes,k,n.page,a.rotationAlignment===y.RotationAlignment.VIEWPORT,h),q.iconColliders)){b.iconColliders=q.iconColliders;for(const l of q.iconColliders)if(l.minLod=Math.max(k+
B.log2(l.minLod),0),l.maxLod=Math.min(k+B.log2(l.maxLod),25),b=l.angle)h=Math.cos(b),g=Math.sin(b),m=l.dxPixels*h-l.dyPixels*g,b=l.dxPixels*g+l.dyPixels*h,f=(l.dxPixels+l.width)*h-l.dyPixels*g,a=(l.dxPixels+l.width)*g+l.dyPixels*h,r=l.dxPixels*h-(l.dyPixels+l.height)*g,q=l.dxPixels*g+(l.dyPixels+l.height)*h,t=(l.dxPixels+l.width)*h-(l.dyPixels+l.height)*g,g=(l.dxPixels+l.width)*g+(l.dyPixels+l.height)*h,h=Math.min(m,f,r,t),m=Math.max(m,f,r,t),f=Math.min(b,a,q,g),b=Math.max(b,a,q,g),l.dxPixels=h,l.dyPixels=
f,l.width=m-h,l.height=b-f}}}}_addPlacedIcons(b,a,f,e,n,c){const d=Math.max(f-1,0),k=this._iconVertexBuffer,h=this._iconIndexBuffer,t=this._markerMap;for(const u of a){a=n?0:Math.max(f+B.log2(u.minzoom),d);const p=n?25:Math.min(f+B.log2(u.maxzoom),25);if(p<=a)continue;const q=u.tl,r=u.tr,m=u.bl,v=u.br;var g=u.mosaicRect;const l=u.labelAngle,x=u.minAngle,w=u.maxAngle,z=u.anchor,A=k.index,E=g.x,G=g.y,H=E+g.width;g=G+g.height;const L=k.index;k.add(z.x,z.y,q.x,q.y,E,G,l,x,w,a,p,c);k.add(z.x,z.y,r.x,r.y,
H,G,l,x,w,a,p,c);k.add(z.x,z.y,m.x,m.y,E,g,l,x,w,a,p,c);k.add(z.x,z.y,v.x,v.y,H,g,l,x,w,a,p,c);0<b.iconVertexRanges.length&&b.iconVertexRanges[0][0]+b.iconVertexRanges[0][1]===L?b.iconVertexRanges[0][1]+=4:b.iconVertexRanges.push([L,4]);h.add(A,A+1,A+2);h.add(A+1,A+2,A+3);t.has(e)?t.get(e)[1]+=6:t.set(e,[this._iconIndexStart+this._iconIndexCount,6]);this._iconIndexCount+=6}}_addPlacedGlyphs(){const b=this._textVertexBuffer,a=this._textIndexBuffer,f=this._glyphMap;for(const [e,n]of this._glyphBufferDataStorage)for(const c of n){const d=
b.index,k=c.symbolInstance,h=c.ddAttributes,t=b.index;b.add(c.glyphAnchor[0],c.glyphAnchor[1],c.tl[0],c.tl[1],c.xmin,c.ymin,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,h);b.add(c.glyphAnchor[0],c.glyphAnchor[1],c.tr[0],c.tr[1],c.xmax,c.ymin,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,h);b.add(c.glyphAnchor[0],c.glyphAnchor[1],c.bl[0],c.bl[1],c.xmin,c.ymax,c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,h);b.add(c.glyphAnchor[0],c.glyphAnchor[1],c.br[0],c.br[1],c.xmax,c.ymax,
c.labelAngle,c.minAngle,c.maxAngle,c.minLod,c.maxLod,h);0<k.textVertexRanges.length&&k.textVertexRanges[0][0]+k.textVertexRanges[0][1]===t?k.textVertexRanges[0][1]+=4:k.textVertexRanges.push([t,4]);a.add(d,d+1,d+2);a.add(d+1,d+2,d+3);f.has(e)?f.get(e)[1]+=6:f.set(e,[this._textIndexStart+this._textIndexCount,6]);this._textIndexCount+=6}this._glyphBufferDataStorage.clear()}_storePlacedGlyphs(b,a,f,e,n){const c=Math.max(f-1,0);e=e===y.RotationAlignment.VIEWPORT;let d,k,h,t,g,u,p,q,r,m;for(const v of a)a=
e?0:Math.max(f+B.log2(v.minzoom),c),d=e?25:Math.min(f+B.log2(v.maxzoom),25),d<=a||(k=v.tl,h=v.tr,t=v.bl,g=v.br,u=v.labelAngle,p=v.minAngle,q=v.maxAngle,r=v.anchor,m=v.mosaicRect,this._glyphBufferDataStorage.has(v.page)||this._glyphBufferDataStorage.set(v.page,[]),this._glyphBufferDataStorage.get(v.page).push({glyphAnchor:[r.x,r.y],tl:[k.x,k.y],tr:[h.x,h.y],bl:[t.x,t.y],br:[g.x,g.y],xmin:m.x,ymin:m.y,xmax:m.x+m.width,ymax:m.y+m.height,labelAngle:u,minAngle:p,maxAngle:q,minLod:a,maxLod:d,placementLod:c,
symbolInstance:b,ddAttributes:n}))}static _pushAnchors(b,a,f,e){f+=e;var n=0,c=a.length-1;for(var d=0;d<c;d++)n+=C.Point.distance(a[d],a[d+1]);e=.5*(e||f);if(!(n<=e)){e/=n;f=n/Math.max(Math.round(n/f),1);n=0;c=-f/2;d=a.length-1;for(let h=0;h<d;h++){const t=a[h],g=a[h+1],u=g.x-t.x,p=g.y-t.y,q=Math.sqrt(u*u+p*p);let r;for(;c+f<n+q;){c+=f;var k=(c-n)/q;const m=B.interpolate(t.x,g.x,k);k=B.interpolate(t.y,g.y,k);void 0===r&&(r=Math.atan2(p,u));b.push(new F.Anchor(m,k,r,h,e))}n+=q}}}static _pushCenterAnchor(b,
a){var f=0,e=a.length-1;for(var n=0;n<e;n++)f+=C.Point.distance(a[n],a[n+1]);var c=f/2;let d=0;const k=a.length-1;for(f=0;f<k;f++){var h=a[f];const t=a[f+1];e=t.x-h.x;n=t.y-h.y;const g=Math.sqrt(e*e+n*n);if(c<d+g){c=(c-d)/g;a=B.interpolate(h.x,t.x,c);h=B.interpolate(h.y,t.y,c);b.push(new F.Anchor(a,h,Math.atan2(n,e),f,0));break}d+=g}}static _deviation(b,a,f){return Math.atan2((a.x-b.x)*(f.y-a.y)-(a.y-b.y)*(f.x-a.x),(a.x-b.x)*(f.x-a.x)+(a.y-b.y)*(f.y-a.y))}static _honorsTextMaxAngle(b,a,f,e,n){let c=
0;f/=2;for(var d=new C.Point(a.x,a.y),k=a.segment+1;c>-f;){--k;if(0>k)return!1;c-=C.Point.distance(b[k],d);d=b[k]}c+=C.Point.distance(b[k],b[k+1]);a=[];d=0;const h=b.length;for(;c<f;){var t=b[k];let g;do{++k;if(k===h)return!1;g=b[k]}while(g.isEqual(t));let u=k,p;do{++u;if(u===h)return!1;p=b[u]}while(p.isEqual(g));t=this._deviation(t,g,p);a.push({deviation:t,distToAnchor:c});for(d+=t;c-a[0].distToAnchor>n;)d-=a.shift().deviation;if(Math.abs(d)>e)return!1;c+=C.Point.distance(g,p)}return!0}static _smoothVertices(b,
a){if(0>=a)return b;let f=b.length;if(3>f)return b;const e=[];var n=0,c=0;e.push(0);for(var d=1;d<f;d++){var k=C.Point.distance(b[d],b[d-1]);0<k&&(n+=k,e.push(n),c++,c!==d&&(b[c]=b[d]))}f=c+1;if(3>f)return b;a=Math.min(a,.2*n);n=b[0].x;c=b[0].y;d=b[f-1].x;k=b[f-1].y;var h=C.Point.sub(b[0],b[1]);h.normalize();b[0].x+=a*h.x;b[0].y+=a*h.y;h.assignSub(b[f-1],b[f-2]);h.normalize();b[f-1].x+=a*h.x;b[f-1].y+=a*h.y;e[0]-=a;e[f-1]+=a;h=[];h.push(new C.Point(n,c));const t=.5*a;for(let z=1;z<f-1;z++){let A=
0,E=0,G=0;for(var g=z-1;0<=g;g--){var u=t+e[g+1]-e[z];if(0>u)break;var p=e[g+1]-e[g],q=e[z]-e[g]<t?1:u/p;if(1E-6>q)break;var r=q*q,m=q*u-.5*r*p,v=q*p/a,l=b[g+1],x=b[g].x-l.x,w=b[g].y-l.y;A+=v/m*(l.x*q*u+.5*r*(u*x-p*l.x)-r*q*p*x/3);E+=v/m*(l.y*q*u+.5*r*(u*w-p*l.y)-r*q*p*w/3);G+=v}for(g=z+1;g<f;g++){u=t-e[g-1]+e[z];if(0>u)break;p=e[g]-e[g-1];q=e[g]-e[z]<t?1:u/p;if(1E-6>q)break;r=q*q;m=q*u-.5*r*p;v=q*p/a;l=b[g-1];x=b[g].x-l.x;w=b[g].y-l.y;A+=v/m*(l.x*q*u+.5*r*(u*x-p*l.x)-r*q*p*x/3);E+=v/m*(l.y*q*u+.5*
r*(u*w-p*l.y)-r*q*p*w/3);G+=v}h.push(new C.Point(A/G,E/G))}h.push(new C.Point(d,k));b[0].x=n;b[0].y=c;b[f-1].x=d;b[f-1].y=k;return h}static _pushCentroid(b,a){const f=a.length-1;let e=0,n=0,c=0,d=a[0].x,k=a[0].y;4096<d&&(d=4096);0>d&&(d=0);4096<k&&(k=4096);0>k&&(k=0);for(let h=1;h<f;h++){let t=a[h].x,g=a[h].y,u=a[h+1].x,p=a[h+1].y;4096<t&&(t=4096);0>t&&(t=0);4096<g&&(g=4096);0>g&&(g=0);4096<u&&(u=4096);0>u&&(u=0);4096<p&&(p=4096);0>p&&(p=0);const q=(t-d)*(p-k)-(u-d)*(g-k);e+=q*(d+t+u);n+=q*(k+g+p);
c+=q}e/=3*c;n/=3*c;isNaN(e)||isNaN(n)||b.push(new F.Anchor(e,n))}}D._bidiEngine=new M;return D});