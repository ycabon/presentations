// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/signal ./config ./core ./jobs ./SymbolDeclutterer ./SymbolRepository ./util ../style/StyleDefinition".split(" "),function(e,g,f,h,k,l,m,n,p){class q{constructor(a,c){this.styleRepository=a;this._tileToHandle=new Map;this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]};this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]};this._offsetFromScreenCenter=[0,0];this._completed=!1;this._fading=g.signal(!1);this._symbolRepository=new m.SymbolRepository(4096,
c,()=>new h.VTLUniqueSymbol);this._symbolDeclutterer=new l.SymbolDeclutterer(c,this._symbolRepository,(b,d,r)=>this._createCollisionJob(b,d,r),(b,d)=>{b.allSymbolsFadingOut=!0;b.lastOpacityUpdate=d;n.writeOpacityToBuffers(b,d,!0);b.decluttered=!0;b.requestRender()},(b,d)=>this.styleRepository.getStyleLayerByUID(b.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(d.styleLayerUID).z,b=>{b=this.styleRepository.getStyleLayerByUID(b);return this._zoom+1E-6<b.minzoom||this._zoom-1E-6>=b.maxzoom?
!1:(b=b.getLayoutProperty("visibility"))&&b.getValue()===p.Visibility.NONE?!1:!0})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(a,c,b){this.updateDecluttererViewState();return new k.CollisionJob(a,c,b,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(a){a.decluttered=!1;this._tileToHandle.set(a,a.on("symbols-changed",()=>{this._symbolRepository.add(a);this.restartDeclutter()}));
this._symbolRepository.add(a);this.restartDeclutter()}removeTile(a){const c=this._tileToHandle.get(a);c&&(this._symbolRepository.removeTile(a),this.restartDeclutter(),c.remove(),this._tileToHandle.delete(a))}update(a,c){this._zoom=a;this._viewState={scale:c.scale,rotation:c.rotation,center:[c.center[0],c.center[1]],size:[c.size[0],c.size[1]]};a=[0,0];c.toScreen(a,c.center);const b=[0,0];c.toScreen(b,this._declutterViewState.center);this._offsetFromScreenCenter[0]=a[0]-b[0];this._offsetFromScreenCenter[1]=
a[1]-b[1];this._continueDeclutter();return this._completed}restartDeclutter(){this._completed=!1;this._symbolDeclutterer.restart();this._notifyUnstable()}clear(){this._completed=!1;this._symbolRepository=null;this._symbolDeclutterer.restart();this._tileToHandle.forEach(a=>a.remove());this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==
this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(a){this._symbolRepository.deleteStyleLayers(a)}_continueDeclutter(){if(!this._completed||this.stale)this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),(this._completed=this._symbolDeclutterer.continue(f.declutterBudget))&&this._scheduleNotifyStable()}_scheduleNotifyStable(){null!=
this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle);this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null;this._fading.value=!1},1.5*f.fadeDuration)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null);this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom;this._declutterViewState.center[0]=this._viewState.center[0];this._declutterViewState.center[1]=
this._viewState.center[1];this._declutterViewState.rotation=this._viewState.rotation;this._declutterViewState.scale=this._viewState.scale;this._declutterViewState.size[0]=this._viewState.size[0];this._declutterViewState.size[1]=this._viewState.size[1];this._offsetFromScreenCenter[0]=0;this._offsetFromScreenCenter[1]=0}}e.SymbolFader=q;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});