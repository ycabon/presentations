// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../MemoryBuffer","./enums","../../../../webgl/enums","../../../../webgl/VertexElementDescriptor"],function(E,H,e,l,F){class D{constructor(b){this._locations=new Map;this._key=b}get key(){return this._key}get type(){return this._key&7}defines(){return[]}getStride(){this._layoutInfo||this._buildAttributesInfo();return this._stride}getAttributeLocations(){0===this._locations.size&&this._buildAttributesInfo();return this._locations}getLayoutInfo(){this._layoutInfo||this._buildAttributesInfo();
return this._layoutInfo}getEncodingInfos(){this._propertyEncodingInfo||this._buildAttributesInfo();return this._propertyEncodingInfo}getUniforms(){this._uniforms||this._buildAttributesInfo();return this._uniforms}getShaderHeader(){this._shaderHeader||this._buildAttributesInfo();return this._shaderHeader}getShaderMain(){this._shaderMain||this._buildAttributesInfo();return this._shaderMain}setDataUniforms(b,c,h,k,t){var m=this.getUniforms();for(const a of m){const {name:d,type:n,getValue:f}=a;m=f(h,
c,k,t);if(null!==m)switch(n){case "float":b.setUniform1f(d,m);break;case "vec2":b.setUniform2fv(d,m);break;case "vec4":b.setUniform4fv(d,m)}}}encodeAttributes(b,c,h,k){const t=this.attributesInfo(),m=this.getEncodingInfos(),a=[];let d=0,n=0;for(const p of Object.keys(m)){var f=m[p];const {type:y,precisionFactor:q,isLayout:z}=t[p],A=z?h.getLayoutProperty(p):h.getPaintProperty(p),v=A.interpolator?.getInterpolationRange(c);let x=0;for(const u of f){const {offset:g,bufferElementsToAdd:r}=u;if(0<r){for(f=
0;f<r;f++)a.push(0);d+=n;n=u.bufferElementsToAdd}f=k??A.getValue(v?v[x]:c,b);switch(y){case e.EncodingType.R8_SIGNED:case e.EncodingType.R8_UNSIGNED:a[d]|=this._encodeByte(f*(q||1),8*g);break;case e.EncodingType.R16_SIGNED:case e.EncodingType.R16_UNSIGNED:a[d]|=this._encodeShort(f*(q||1),8*g);break;case e.EncodingType.R8G8_SIGNED:case e.EncodingType.R8G8_UNSIGNED:a[d]|=this._encodeByte(f*(q||1),8*g);a[d]|=this._encodeByte(f*(q||1),8*g+8);break;case e.EncodingType.R16G16_SIGNED:case e.EncodingType.R16G16_UNSIGNED:a[d]|=
this._encodeShort(f*(q||1),8*g);a[d]|=this._encodeShort(f*(q||1),8*g+16);break;case e.EncodingType.R8G8B8A8_SIGNED:case e.EncodingType.R8G8B8A8_UNSIGNED:a[d]|=this._encodeByte(f*(q||1),8*g);a[d]|=this._encodeByte(f*(q||1),8*g+8);a[d]|=this._encodeByte(f*(q||1),8*g+16);a[d]|=this._encodeByte(f*(q||1),8*g+24);break;case e.EncodingType.R8G8B8A8_COLOR:a[d]=this._encodeColor(f);break;case e.EncodingType.R16G16B16A16_DASHARRAY:case e.EncodingType.R16G16B16A16_PATTERN:this._encodePattern(d,a,f);break;default:throw Error("Unsupported encoding type");
}x++}}return a}getAtributeState(b){const c=3+2*b;b=0|this._bit(c);return b|=this._bit(c+1)<<1}_buildAttributesInfo(){const b=[],c={};var h={},k=-1;const t=this.attributesInfo();var m=this.attributes();let a=-1;for(const p of m){a++;m=this.getAtributeState(a);if(m===e.AttributeStatus.UNIFORM||m===e.AttributeStatus.UNUSED)continue;var d=t[p];const y=[];c[p]=y;d=d.type;for(let q=0;q<m;q++){const {dataType:z,bytesPerElement:A,count:v,normalized:x}=D._encodingInfo[d],u=A*v;var n=`${z}-${!0===x}`;let g=
h[n],r=0;!g||4<g.count+v?(k++,g={dataIndex:k,count:0,offset:0},4!==v&&(h[n]=g),b.push({location:-1,name:"a_data_"+k,count:v,type:z,normalized:x}),r=Math.ceil(Math.max(u/4,1))):(n=b[g.dataIndex],n.count+=v,r=Math.ceil(Math.max(n.count*A/4,1))-Math.ceil(Math.max(g.offset/4,1)));y.push({dataIndex:g.dataIndex,offset:g.offset,bufferElementsToAdd:r});g.offset+=u;g.count+=v}}for(const p of b)switch(p.type){case l.DataType.BYTE:case l.DataType.UNSIGNED_BYTE:p.count=4;break;case l.DataType.SHORT:case l.DataType.UNSIGNED_SHORT:p.count+=
p.count%2}this._buildVertexBufferLayout(b);h=0;k=this._layoutInfo.geometry;for(var f of k)this._locations.set(f.name,h++);if(f=this._layoutInfo.opacity)for(const p of f)this._locations.set(p.name,h++);this._buildShaderInfo(b,c);this._propertyEncodingInfo=c}_buildVertexBufferLayout(b){const c={},h=this.geometryInfo();let k=h[0].stride;if(0===b.length)c.geometry=h;else{const t=[];let m=k;for(const a of b)k+=G(a.type)*a.count;for(const a of h)t.push(new F.VertexElementDescriptor(a.name,a.count,a.type,
a.offset,k,a.normalized));for(const a of b)t.push(new F.VertexElementDescriptor(a.name,a.count,a.type,m,k,a.normalized)),m+=G(a.type)*a.count;c.geometry=t}this.opacityInfo()&&(c.opacity=this.opacityInfo());this._layoutInfo=c;this._stride=k}_buildShaderInfo(b,c){let h="\n",k="\n";const t=[];for(var m of b)h+=`attribute ${this._getType(m.count)} ${m.name};\n`;var a=this.attributes();b=this.attributesInfo();m=-1;for(const f of a){m++;const {name:p,type:y,precisionFactor:q,isLayout:z}=b[f];a=q&&1!==q?
` * ${1/q}`:"";const {bytesPerElement:A,count:v}=D._encodingInfo[y];var d=x=>`a_data_${x.dataIndex}${I(v,x.offset,A)}`;switch(this.getAtributeState(m)){case e.AttributeStatus.UNIFORM:a=this._getType(v);var n=`u_${p}`;t.push({name:n,type:a,getValue:(u,g,r,w)=>{r=z?u.getLayoutValue(f,g):u.getPaintValue(f,g);if(y===e.EncodingType.R16G16B16A16_DASHARRAY){u=u.getDashKey(r,u.getLayoutValue("line-cap",g));w=w.getMosaicItemPosition(u,!1);if(null==w)return null;const {tl:B,br:C}=w;return[B[0],C[1],C[0],B[1]]}if(y===
e.EncodingType.R16G16B16A16_PATTERN){w=w.getMosaicItemPosition(r,!f.includes("line-"));if(null==w)return null;const {tl:B,br:C}=w;return[B[0],C[1],C[0],B[1]]}return y===e.EncodingType.R8G8B8A8_COLOR?(w=r[3],[w*r[0],w*r[1],w*r[2],w]):r}});h+=`uniform ${a} ${n};\n`;k+=`${a} ${p} = ${n};\n`;break;case e.AttributeStatus.DATA_DRIVEN:n=d(c[f][0]);k+=`${this._getType(v)} ${p} = ${n}${a};\n`;break;case e.AttributeStatus.INTERPOLATED_DATA_DRIVEN:n=`u_t_${p}`;t.push({name:n,type:"float",getValue:(u,g,r,w)=>
(z?u.getLayoutProperty(f):u.getPaintProperty(f)).interpolator.interpolationUniformValue(r,g)});h+=`uniform float ${n};\n`;const x=d(c[f][0]);d=d(c[f][1]);k+=`${this._getType(v)} ${p} = mix(${x}${a}, ${d}${a}, ${n});\n`}}this._shaderHeader=h;this._shaderMain=k;this._uniforms=t}_bit(b){return(this._key&1<<b)>>b}_getType(b){switch(b){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}throw Error("Invalid count");}_encodeColor(b){const c=255*b[3];return H.i8888to32(b[0]*
c,b[1]*c,b[2]*c,c)}_encodePattern(b,c,h){if(h?.rect){var k=h.rect,t=h.width;h=h.height;c[b]=this._encodeShort(k.x+2,0);c[b]|=this._encodeShort(k.y+2+h,16);c[b+1]=this._encodeShort(k.x+2+t,0);c[b+1]|=this._encodeShort(k.y+2,16)}}_encodeByte(b,c){return(b&255)<<c}_encodeShort(b,c){return(b&65535)<<c}}D._encodingInfo={[e.EncodingType.R8_SIGNED]:{dataType:l.DataType.BYTE,bytesPerElement:1,count:1,normalized:!1},[e.EncodingType.R8_UNSIGNED]:{dataType:l.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:1,
normalized:!1},[e.EncodingType.R16_SIGNED]:{dataType:l.DataType.SHORT,bytesPerElement:2,count:1,normalized:!1},[e.EncodingType.R16_UNSIGNED]:{dataType:l.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:1,normalized:!1},[e.EncodingType.R8G8_SIGNED]:{dataType:l.DataType.BYTE,bytesPerElement:1,count:2,normalized:!1},[e.EncodingType.R8G8_UNSIGNED]:{dataType:l.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:2,normalized:!1},[e.EncodingType.R16G16_SIGNED]:{dataType:l.DataType.SHORT,bytesPerElement:2,count:2,
normalized:!1},[e.EncodingType.R16G16_UNSIGNED]:{dataType:l.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:2,normalized:!1},[e.EncodingType.R8G8B8A8_SIGNED]:{dataType:l.DataType.BYTE,bytesPerElement:1,count:4,normalized:!1},[e.EncodingType.R8G8B8A8_UNSIGNED]:{dataType:l.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!1},[e.EncodingType.R8G8B8A8_COLOR]:{dataType:l.DataType.UNSIGNED_BYTE,bytesPerElement:1,count:4,normalized:!0},[e.EncodingType.R16G16B16A16_DASHARRAY]:{dataType:l.DataType.UNSIGNED_SHORT,
bytesPerElement:2,count:4,normalized:!1},[e.EncodingType.R16G16B16A16_PATTERN]:{dataType:l.DataType.UNSIGNED_SHORT,bytesPerElement:2,count:4,normalized:!1}};const G=b=>{switch(b){case l.DataType.FLOAT:return 4;case l.DataType.INT:return 4;case l.DataType.UNSIGNED_INT:return 4;case l.DataType.SHORT:return 2;case l.DataType.UNSIGNED_SHORT:return 2;case l.DataType.BYTE:return 1;case l.DataType.UNSIGNED_BYTE:return 1}},I=(b,c,h)=>{c/=h;if(1===b)switch(c){case 0:return".x";case 1:return".y";case 2:return".z";
case 3:return".w"}else if(2===b)switch(c){case 0:return".xy";case 1:return".yz";case 2:return".zw"}else if(3===b)switch(c){case 0:return".xyz";case 1:return".yzw"}return""};E.VTLMaterial=D;Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});