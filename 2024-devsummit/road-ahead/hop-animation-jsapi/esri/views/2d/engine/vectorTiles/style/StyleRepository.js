// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["./StyleDefinition","./StyleLayer"],function(k,l){class m{constructor(a){this._style=a;this.backgroundBucketIds=[];this._uidToLayer=new Map;this._layerByName={};this._runningId=0;a.layers||(a.layers=[]);this.version=parseFloat(a.version);if(this.layers=a.layers.map((b,c,f)=>this._create(b,c,f)).filter(b=>!!b))for(a=0;a<this.layers.length;a++){const b=this.layers[a];this._layerByName[b.id]=b;this._uidToLayer.set(b.uid,b);b.type===k.StyleLayerType.BACKGROUND&&this.backgroundBucketIds.push(b.id)}this._identifyRefLayers()}isPainterDataDriven(a){return(a=
this._layerByName[a])?a.isPainterDataDriven():!1}getStyleLayerId(a){return a>=this.layers.length?null:this.layers[a].id}getStyleLayerByUID(a){return this._uidToLayer.get(a)??null}getStyleLayerIndex(a){return(a=this._layerByName[a])?this.layers.indexOf(a):-1}setStyleLayer(a,b){if(a?.id){var c=this._style;null!=b&&b>=this.layers.length&&(b=this.layers.length-1);var f=!0,d;if(d=this._layerByName[a.id]){const e=this.layers.indexOf(d);b||=e;b===e?(f=!1,d=m._recreateLayer(a,d),this.layers[b]=d,c.layers[b]=
a):(this.layers.splice(e,1),c.layers.splice(e,1),d=this._create(a,b,this.layers),this.layers.splice(b,0,d),c.layers.splice(b,0,a))}else d=this._create(a,b,this.layers),!b||b>=this.layers.length?(this.layers.push(d),c.layers.push(a)):(this.layers.splice(b,0,d),c.layers.splice(b,0,a));this._layerByName[a.id]=d;this._uidToLayer.set(d.uid,d);f&&this._recomputeZValues();this._identifyRefLayers()}}getStyleLayer(a){return(a=this._layerByName[a])?{type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,
minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:a.layout,paint:a.paint}:null}deleteStyleLayer(a){const b=this._layerByName[a];b&&(delete this._layerByName[a],this._uidToLayer.delete(b.uid),a=this.layers.indexOf(b),this.layers.splice(a,1),this._style.layers.splice(a,1),this._recomputeZValues(),this._identifyRefLayers())}getLayerById(a){return this._layerByName[a]}getLayoutProperties(a){return(a=this._layerByName[a])?a.layout:null}getPaintProperties(a){return(a=this._layerByName[a])?a.paint:
null}setPaintProperties(a,b){if(a=this._layerByName[a]){var c=m._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:a.layout,paint:b},a),f=this.layers.indexOf(a);this.layers[f]=c;this._style.layers[f].paint=b;this._layerByName[a.id]=c;this._uidToLayer.set(a.uid,c)}}setLayoutProperties(a,b){if(a=this._layerByName[a]){var c=m._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,
minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:b,paint:a.paint},a),f=this.layers.indexOf(a);this.layers[f]=c;this._style.layers[f].layout=b;this._layerByName[a.id]=c;this._uidToLayer.set(a.uid,c)}}setStyleLayerVisibility(a,b){if(a=this._layerByName[a]){var c=a.layout||{};c.visibility=b;b=m._recreateLayer({type:a.typeName,id:a.id,source:a.source,"source-layer":a.sourceLayer,minzoom:a.minzoom,maxzoom:a.maxzoom,filter:a.filter,layout:c,paint:a.paint},a);var f=this.layers.indexOf(a);this.layers[f]=
b;this._style.layers[f].layout=c;this._layerByName[a.id]=b;this._uidToLayer.set(a.uid,b)}}getStyleLayerVisibility(a){return(a=this._layerByName[a])?a.layout?.visibility??"visible":"none"}_recomputeZValues(){const a=this.layers,b=1/(a.length+1);for(let c=0;c<a.length;c++)a[c].z=1-(1+c)*b}_identifyRefLayers(){const a=[],b=[];let c=0;for(const e of this.layers){const h=e.layout;if(e.type===k.StyleLayerType.FILL){var f=e,d=e.source+"|"+e.sourceLayer;d+="|"+(h?.visibility??"");d+="|"+e.minzoom;d+="|"+
e.maxzoom;d+="|"+JSON.stringify(e.filter);if(f.hasDataDrivenFill||f.hasDataDrivenOutline)d+="|"+c;a.push({key:d,layer:e})}else if(e.type===k.StyleLayerType.LINE){f=e;d=e.paint;d=null!=d&&(null!=d["line-pattern"]||null!=d["line-dasharray"]);let g=e.source+"|"+e.sourceLayer;g+="|"+(h?.visibility??"");g+="|"+e.minzoom;g+="|"+e.maxzoom;g+="|"+JSON.stringify(e.filter);g+="|"+(void 0!==h?h["line-cap"]:"");g+="|"+(void 0!==h?h["line-join"]:"");if(f.hasDataDrivenLine||d)g+="|"+c;b.push({key:g,layer:e})}++c}this._assignRefLayers(a);
this._assignRefLayers(b)}_assignRefLayers(a){a.sort((h,g)=>h.key<g.key?-1:h.key>g.key?1:0);let b,c;const f=a.length;for(let h=0;h<f;h++){const g=a[h];if(g.key===b)g.layer.refLayerId=c;else if(b=g.key,c=g.layer.id,g.layer.type===k.StyleLayerType.FILL){if(!g.layer.getPaintProperty("fill-outline-color"))for(var d=h+1;d<f;d++){var e=a[d];if(e.key===b){if(e.layer.getPaintProperty("fill-outline-color")){a[h]=e;a[d]=g;c=e.layer.id;break}}else break}}else if(g.layer.type===k.StyleLayerType.LINE)for(d=g.layer,
e=h+1;e<f;e++){const n=a[e];if(n.key!==b)break;const p=n.layer;if(d.canUseThinTessellation&&!p.canUseThinTessellation||!d.canUseThinTessellation&&(p.getPaintProperty("line-pattern")||p.getPaintProperty("line-dasharray")))d=p,a[h]=n,a[e]=g,c=n.layer.id}}}_create(a,b,c){b=1-1/(c.length+1)*(1+b);c=this._runningId++;switch(a.type){case "background":return new l.BackgroundStyleLayer(k.StyleLayerType.BACKGROUND,a,b,c);case "fill":return new l.FillStyleLayer(k.StyleLayerType.FILL,a,b,c);case "line":return new l.LineStyleLayer(k.StyleLayerType.LINE,
a,b,c);case "symbol":return new l.SymbolStyleLayer(k.StyleLayerType.SYMBOL,a,b,c);case "raster":console.warn(`Unsupported vector tile raster layer ${a.id}`);break;case "circle":return new l.CircleStyleLayer(k.StyleLayerType.CIRCLE,a,b,c)}return null}static _recreateLayer(a,b){switch(a.type){case "background":return new l.BackgroundStyleLayer(k.StyleLayerType.BACKGROUND,a,b.z,b.uid);case "fill":return new l.FillStyleLayer(k.StyleLayerType.FILL,a,b.z,b.uid);case "line":return new l.LineStyleLayer(k.StyleLayerType.LINE,
a,b.z,b.uid);case "symbol":return new l.SymbolStyleLayer(k.StyleLayerType.SYMBOL,a,b.z,b.uid);case "raster":console.warn(`Unsupported vector tile raster layer ${a.id}`);break;case "circle":return new l.CircleStyleLayer(k.StyleLayerType.CIRCLE,a,b.z,b.uid)}return null}}return m});