// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../core/has ../../../../core/promiseUtils ./Rect ./RectangleBinPack ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),function(p,q,l,m,n,r,t){function u(b){const a=new Set;for(const c of b)a.add(Math.floor(c/256));return a}function v(b,a,c){b.has(a)||b.set(a,c().then(()=>{b.delete(a)}).catch(d=>{b.delete(a);q.throwIfNotAbortError(d)}));return b.get(a)}class w{constructor(b,a,c){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=
0;this._glyphCache={};this._textures=[];this._rangePromises=new Map;this._preloadCache={};this.width=b;this.height=a;this._glyphSource=c;this._binPack=new m(b-4,a-4);this._glyphData.push(new Uint8Array(b*a));this._dirties.push(!0);this._textures.push(null);this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const b of this._textures)b&&b.dispose();this._textures.length=0;this._glyphData.length=0}_initDecorationGlyphs(){var b=[117,149,181,207,207,181,149,117];const a=[];var c=[];for(let d=
0;d<b.length;d++){const f=b[d];for(let e=0;11>e;e++){const g=3<=d&&5>d&&3<=e&&8>e?255:0;a.push(f);c.push(g)}}b={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(a)};c={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(c)};this._recordGlyph(b);this._recordGlyph(c)}getTexture(b,a){if(!this._textures[a]){const c=new t.TextureDescriptor;c.pixelFormat=n.PixelFormat.ALPHA;c.wrapMode=n.TextureWrapMode.CLAMP_TO_EDGE;c.width=this.width;c.height=this.height;this._textures[a]=
new r.Texture(b,c,new Uint8Array(this.width*this.height))}this._dirties[a]&&(this._textures[a].setData(this._glyphData[a]),this._dirties[a]=!1);return this._textures[a]}async getGlyphItems(b,a,c){const d=this._getGlyphCache(b);await this._fetchRanges(b,a,c);return a.map(f=>this._getMosaicItem(d,b,f))}bind(b,a,c,d){c=this.getTexture(b,c);c.setSamplingMode(a);b.bindTexture(c,d)}preloadASCIIGlyphCache(b){var a=this._preloadCache[b];if(null!=a)return a;a=this._glyphSource.preloadASCIIRange(b).then(()=>
{const c=this._getGlyphCache(b);for(let d=0;256>d;d++)this._getMosaicItem(c,b,d)});return this._preloadCache[b]=a}_getGlyphCache(b){this._glyphCache[b]||(this._glyphCache[b]={});return this._glyphCache[b]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(b,a,c){const d=[];u(a).forEach(f=>{d.push(this._fetchRange(b,f,c))});await Promise.all(d)}async _fetchRange(b,a,c){if(!(256<a))return v(this._rangePromises,b+a,()=>this._glyphSource.getRange(b,a,c))}_getMosaicItem(b,a,c){if(!b[c]){a=
this._glyphSource.getGlyph(a,c);if(!a?.metrics)return{rect:new l(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:c,sdf:!0};const d=this._recordGlyph(a);b[c]={rect:d,page:this._currentPage,metrics:a.metrics,code:c,sdf:!0};this._invalidate()}return b[c]}_recordGlyph(b){var a=b.metrics;if(0===a.width)a=new l(0,0,0,0);else{const c=a.width+6,d=a.height+6;a=this._binPack.allocate(c,d);a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=
this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new m(this.width-4,this.height-4),a=this._binPack.allocate(c,d));const f=this._glyphData[this._currentPage];b=b.bitmap;let e,g;if(b)for(let h=0;h<d;h++){e=c*h;g=this.width*(a.y+h)+a.x;for(let k=0;k<c;k++)f[g+k]=b[e+k]}p("esri-glyph-debug")&&this._showDebugPage(f)}return a}_showDebugPage(b){const a=document.createElement("canvas"),
c=a.getContext("2d"),d=new ImageData(this.width,this.height),f=d.data;a.width=this.width;a.height=this.height;a.style.border="1px solid black";for(let e=0;e<b.length;++e)f[4*e]=b[e],f[4*e+1]=0,f[4*e+2]=0,f[4*e+3]=255;c.putImageData(d,0,0);document.body.appendChild(a)}}return w});