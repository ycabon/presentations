// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../vectorTiles/style/StyleDefinition","../definitions","./WGLBrush","../../../../webgl/enums"],function(A,B,y,F,q){const C=1/65536;class G extends F{constructor(){super(...arguments);this._fillProgramOptions={id:!1,pattern:!1};this._outlineProgramOptions={id:!1}}dispose(){}drawMany(f,v){const {displayLevel:g,renderPass:b,spriteMosaic:k,styleLayerUID:c}=f;var a=!1;for(var e of v)if(e.layerData.has(c)){var m=e.layerData.get(c);if(0<m.fillIndexCount||0<m.outlineIndexCount){a=!0;
break}}if(a){a=f.styleLayer;var d=a.getPaintProperty("fill-pattern");m=(e=void 0!==d)&&d.isDataDriven;if(e&&!m){var r=d.getValue(g);r=k.getMosaicItemPosition(r,!0)}d=!e&&a.getPaintValue("fill-antialias",g);var w=!0,t=1;if(!e){var x=a.getPaintProperty("fill-color"),l=a.getPaintProperty("fill-opacity");x?.isDataDriven||l?.isDataDriven||(t=a.getPaintValue("fill-color",g),t=a.getPaintValue("fill-opacity",g)*t[3],1<=t&&(w=!1))}w&&"opaque"===b||(x=a.getPaintValue("fill-translate",g),l=a.getPaintValue("fill-translate-anchor",
g),(w||"translucent"!==b)&&this._drawFill(f,c,a,v,x,l,e,r,m),r=!a.hasDataDrivenOutlineColor&&a.outlineUsesFillColor&&1>t,d&&"opaque"!==b&&!r&&this._drawOutline(f,c,a,v,x,l))}}_drawFill(f,v,g,b,k,c,a,e,m){if(!a||m||null!=e){var {context:d,displayLevel:r,state:w,painter:t,pixelRatio:x,spriteMosaic:l,requestRender:n,allowDelayedRender:u}=f;f=g.fillMaterial;var h=t.vectorTilesMaterialManager,H=x>y.vtlHighResCutoff?2:1,z=this._fillProgramOptions;z.pattern=a;h=h.getMaterialProgram(d,f,z);if(u&&null!=n&&
!h.compiled)n();else{d.useProgram(h);null!=e&&({page:e}=e,z=l.getPageSize(e),null!=z&&(l.bind(d,q.TextureSamplingMode.LINEAR,e,y.vtlTextureBindingUnitSprites),h.setUniform2fv("u_mosaicSize",z),h.setUniform1i("u_texture",y.vtlTextureBindingUnitSprites)));h.setUniformMatrix3fv("u_displayMat3",c===B.TranslateAnchor.VIEWPORT?w.displayMat3:w.displayViewMat3);h.setUniform2fv("u_fillTranslation",k);h.setUniform1f("u_depth",g.z+C);k=-1;for(const p of b)if(p.layerData.has(v)&&(p.key.level!==k&&(k=p.key.level,
f.setDataUniforms(h,r,g,k,l)),b=p.layerData.get(v),b.fillIndexCount&&(b.prepareForRendering(d),c=b.fillVAO,null!=c))){d.bindVAO(c);h.setUniformMatrix3fv("u_dvsMat3",p.transforms.displayViewScreenMat3);d.setStencilFunction(q.CompareFunction.EQUAL,p.stencilRef,255);a&&h.setUniform1f("u_patternFactor",p.rangeX/(H*p.width*Math.max(2**(Math.round(r)-p.key.level),1)));if(m){c=b.patternMap;if(!c)continue;for(const [D,E]of c)c=l.getPageSize(D),null!=c&&(l.bind(d,q.TextureSamplingMode.LINEAR,D,y.vtlTextureBindingUnitSprites),
h.setUniform2fv("u_mosaicSize",c),h.setUniform1i("u_texture",y.vtlTextureBindingUnitSprites),d.drawElements(q.PrimitiveType.TRIANGLES,E[1],q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*E[0]))}else d.drawElements(q.PrimitiveType.TRIANGLES,b.fillIndexCount,q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*b.fillIndexStart);p.triangleCount+=b.fillIndexCount/3}}}}_drawOutline(f,v,g,b,k,c){const {context:a,displayLevel:e,state:m,painter:d,pixelRatio:r,spriteMosaic:w,requestRender:t,allowDelayedRender:x}=
f;f=g.outlineMaterial;const l=.75/r,n=d.vectorTilesMaterialManager.getMaterialProgram(a,f,this._outlineProgramOptions);if(x&&null!=t&&!n.compiled)t();else{a.useProgram(n);n.setUniformMatrix3fv("u_displayMat3",c===B.TranslateAnchor.VIEWPORT?m.displayMat3:m.displayViewMat3);n.setUniform2fv("u_fillTranslation",k);n.setUniform1f("u_depth",g.z+C);n.setUniform1f("u_outline_width",l);k=-1;for(const u of b)u.layerData.has(v)&&(u.key.level!==k&&(k=u.key.level,f.setDataUniforms(n,e,g,k,w)),b=u.layerData.get(v),
b.prepareForRendering(a),b.outlineIndexCount&&(c=b.outlineVAO,null!=c&&(a.bindVAO(c),n.setUniformMatrix3fv("u_dvsMat3",u.transforms.displayViewScreenMat3),a.setStencilFunction(q.CompareFunction.EQUAL,u.stencilRef,255),a.drawElements(q.PrimitiveType.TRIANGLES,b.outlineIndexCount,q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*b.outlineIndexStart),u.triangleCount+=b.outlineIndexCount/3)))}}}A.WGLBrushVTLFill=G;Object.defineProperty(A,Symbol.toStringTag,{value:"Module"})});