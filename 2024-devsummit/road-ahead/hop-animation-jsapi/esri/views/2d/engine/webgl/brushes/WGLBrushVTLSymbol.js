// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/libs/gl-matrix-2/factories/vec2f32 ../../vectorTiles/decluttering/config ../../vectorTiles/style/StyleDefinition ../definitions ../GeometryUtils ./WGLBrush ../../../../webgl/enums".split(" "),function(F,G,H,l,C,I,J,q){const K=1/65536;class L extends J{constructor(){super(...arguments);this._iconProgramOptions={id:!1,sdf:!1};this._sdfProgramOptions={id:!1};this._spritesTextureSize=G.create()}dispose(){}drawMany(f,a){const b=f.styleLayer;this._drawIcons(f,b,a);this._drawText(f,
b,a)}_drawIcons(f,a,b){const {context:g,displayLevel:d,painter:r,spriteMosaic:t,state:p,styleLayerUID:y,requestRender:w,allowDelayedRender:z}=f,A=a.iconMaterial;var e=r.vectorTilesMaterialManager;let n;var m=!1;for(var k of b)if(k.layerData.has(y)&&(n=k.layerData.get(y),0<n.iconPerPageElementsMap.size)){m=!0;break}if(m){m=a.getPaintValue("icon-translate",d);k=a.getPaintValue("icon-translate-anchor",d);var u=a.getLayoutValue("icon-rotation-alignment",d);u===l.RotationAlignment.AUTO&&(u=a.getLayoutValue("symbol-placement",
d)===l.SymbolPlacement.POINT?l.RotationAlignment.VIEWPORT:l.RotationAlignment.MAP);var c=u===l.RotationAlignment.MAP;c=a.getLayoutValue("icon-keep-upright",d)&&c;var B=this._iconProgramOptions;B.sdf=n.isIconSDF;e=e.getMaterialProgram(g,A,B);if(z&&null!=w&&!e.compiled)w();else{g.useProgram(e);e.setUniformMatrix3fv("u_displayViewMat3",u===l.RotationAlignment.MAP?p.displayViewMat3:p.displayMat3);e.setUniformMatrix3fv("u_displayMat3",k===l.TranslateAnchor.VIEWPORT?p.displayMat3:p.displayViewMat3);e.setUniform2fv("u_iconTranslation",
m);e.setUniform1f("u_depth",a.z);e.setUniform1f("u_mapRotation",I.degToByte(p.rotation));e.setUniform1f("u_keepUpright",c?1:0);e.setUniform1f("u_level",10*d);e.setUniform1i("u_texture",C.vtlTextureBindingUnitSprites);e.setUniform1f("u_fadeDuration",H.fadeDuration/1E3);m=-1;for(const v of b)if(v.layerData.has(y)&&(v.key.level!==m&&(m=v.key.level,A.setDataUniforms(e,d,a,m,t)),n=v.layerData.get(y),0!==n.iconPerPageElementsMap.size&&(n.prepareForRendering(g),n.updateOpacityInfo(),b=n.iconVAO,null!=b))){g.bindVAO(b);
e.setUniformMatrix3fv("u_dvsMat3",v.transforms.displayViewScreenMat3);e.setUniform1f("u_time",(performance.now()-n.lastOpacityUpdate)/1E3);for(const [D,E]of n.iconPerPageElementsMap)this._renderIconRange(f,e,E,D,v)}}}}_renderIconRange(f,a,b,g,d){const {context:r,spriteMosaic:t}=f;this._spritesTextureSize[0]=t.getWidth(g)/4;this._spritesTextureSize[1]=t.getHeight(g)/4;a.setUniform2fv("u_mosaicSize",this._spritesTextureSize);t.bind(r,q.TextureSamplingMode.LINEAR,g,C.vtlTextureBindingUnitSprites);this._setStencilState(f,
d);r.drawElements(q.PrimitiveType.TRIANGLES,b[1],q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*b[0]);d.triangleCount+=b[1]/3}_drawText(f,a,b){const {context:g,displayLevel:d,glyphMosaic:r,painter:t,pixelRatio:p,spriteMosaic:y,state:w,styleLayerUID:z,requestRender:A,allowDelayedRender:e}=f,n=a.textMaterial;var m=t.vectorTilesMaterialManager,k=!1;for(var u of b)if(u.layerData.has(z)){var c=u.layerData.get(z);if(0<c.glyphPerPageElementsMap.size){k=!0;break}}if(k&&(c=a.getPaintProperty("text-opacity"),
!c||c.isDataDriven||0!==c.getValue(d))){c=a.getPaintProperty("text-color");var B=!c||c.isDataDriven||0<c.getValue(d)[3];c=a.getPaintProperty("text-halo-width");k=a.getPaintProperty("text-halo-color");var v=(!c||c.isDataDriven||0<c.getValue(d))&&(!k||k.isDataDriven||0<k.getValue(d)[3]);if(B||v){c=a.getLayoutValue("text-rotation-alignment",d);c===l.RotationAlignment.AUTO&&(c=a.getLayoutValue("symbol-placement",d)===l.SymbolPlacement.POINT?l.RotationAlignment.VIEWPORT:l.RotationAlignment.MAP);k=c===
l.RotationAlignment.MAP;k=a.getLayoutValue("text-keep-upright",d)&&k;u=.8*3/p;this._glyphTextureSize||(this._glyphTextureSize=G.fromValues(r.width/4,r.height/4));var D=a.getPaintValue("text-translate",d),E=a.getPaintValue("text-translate-anchor",d),h=m.getMaterialProgram(g,n,this._sdfProgramOptions);if(e&&null!=A&&!h.compiled)A();else{g.useProgram(h);h.setUniformMatrix3fv("u_displayViewMat3",c===l.RotationAlignment.MAP?w.displayViewMat3:w.displayMat3);h.setUniformMatrix3fv("u_displayMat3",E===l.TranslateAnchor.VIEWPORT?
w.displayMat3:w.displayViewMat3);h.setUniform2fv("u_textTranslation",D);h.setUniform1f("u_depth",a.z+K);h.setUniform2fv("u_mosaicSize",this._glyphTextureSize);h.setUniform1f("u_mapRotation",I.degToByte(w.rotation));h.setUniform1f("u_keepUpright",k?1:0);h.setUniform1f("u_level",10*d);h.setUniform1i("u_texture",C.vtlTextureBindingUnitGlyphs);h.setUniform1f("u_antialiasingWidth",u);h.setUniform1f("u_fadeDuration",H.fadeDuration/1E3);m=-1;for(const x of b)x.layerData.has(z)&&(x.key.level!==m&&(m=x.key.level,
n.setDataUniforms(h,d,a,m,y)),c=x.layerData.get(z),0!==c.glyphPerPageElementsMap.size&&(c.prepareForRendering(g),c.updateOpacityInfo(),b=c.textVAO,null!=b&&(g.bindVAO(b),h.setUniformMatrix3fv("u_dvsMat3",x.transforms.displayViewScreenMat3),this._setStencilState(f,x),b=(performance.now()-c.lastOpacityUpdate)/1E3,h.setUniform1f("u_time",b),c.glyphPerPageElementsMap.forEach((M,N)=>{this._renderGlyphRange(g,M,N,r,h,v,B,x)}))))}}}}_renderGlyphRange(f,a,b,g,d,r,t,p){g.bind(f,q.TextureSamplingMode.LINEAR,
b,C.vtlTextureBindingUnitGlyphs);r&&(d.setUniform1f("u_halo",1),f.drawElements(q.PrimitiveType.TRIANGLES,a[1],q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3);t&&(d.setUniform1f("u_halo",0),f.drawElements(q.PrimitiveType.TRIANGLES,a[1],q.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3)}_setStencilState(f,a){const {context:b,is3D:g,stencilSymbols:d}=f;b.setStencilTestEnabled(!0);d?(b.setStencilWriteMask(255),b.setStencilFunction(q.CompareFunction.ALWAYS,
a.stencilRef,255)):(b.setStencilWriteMask(0),g?b.setStencilFunction(q.CompareFunction.EQUAL,a.stencilRef,255):b.setStencilFunction(q.CompareFunction.GREATER,255,255))}}F.WGLBrushVTLSymbol=L;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});