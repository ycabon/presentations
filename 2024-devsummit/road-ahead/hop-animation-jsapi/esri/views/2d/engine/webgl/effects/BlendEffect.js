// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../enums ../VertexStream ../shaders/BlendPrograms ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),function(n,p,v,q,w,x,r,g,y,z){const t=()=>v.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class A{constructor(){this._size=[0,0]}dispose(a){this._backBufferTexture=q.disposeMaybe(this._backBufferTexture);this._quad=q.disposeMaybe(this._quad)}draw(a,
c,f,e,k){const {context:b,drawPhase:m}=a;this._setupShader(b);e&&"normal"!==e&&m!==w.WGLDrawPhase.LABEL?this._drawBlended(a,c,f,e,k):(a=r.createProgramTemplate("normal"),(a=b.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes))?(b.useProgram(a),c.setSamplingMode(f),b.bindTexture(c,0),a.setUniform1i("u_layerTexture",0),a.setUniform1f("u_opacity",k),b.setBlendingEnabled(!0),b.setBlendFunction(g.BlendFactor.ONE,g.BlendFactor.ONE_MINUS_SRC_ALPHA),c=this._quad,c.draw(),c.unbind(),
a.dispose()):t().error(new p("mapview-BlendEffect",'Error creating shader program for blend mode "normal"')))}_drawBlended(a,c,f,e,k){const {context:b,state:m,pixelRatio:u,inFadeTransition:B}=a;var {size:h}=m,d=b.getBoundFramebufferObject();let l;null!=d?(l=d.width,h=d.height):(l=Math.round(u*h[0]),h=Math.round(u*h[1]));this._createOrResizeTexture(a,l,h);a=this._backBufferTexture;d.copyToTexture(0,0,l,h,0,0,a);b.setStencilTestEnabled(!1);b.setStencilWriteMask(0);b.setBlendingEnabled(!0);b.setDepthTestEnabled(!1);
b.setDepthWriteEnabled(!1);d=r.createProgramTemplate(e);(d=b.programCache.acquire(d.shaders.vertexShader,d.shaders.fragmentShader,d.attributes))?(b.useProgram(d),a.setSamplingMode(f),b.bindTexture(a,0),d.setUniform1i("u_backbufferTexture",0),c.setSamplingMode(f),b.bindTexture(c,1),d.setUniform1i("u_layerTexture",1),d.setUniform1f("u_opacity",k),d.setUniform1f("u_inFadeOpacity",B?1:0),b.setBlendFunction(g.BlendFactor.ONE,g.BlendFactor.ZERO),c=this._quad,c.draw(),c.unbind(),d.dispose(),b.setBlendFunction(g.BlendFactor.ONE,
g.BlendFactor.ONE_MINUS_SRC_ALPHA)):t().error(new p("mapview-BlendEffect",`Error creating shader program for blend mode ${e}`))}_setupShader(a){this._quad||(this._quad=new x(a,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(a,c,f){({context:a}=a);if(null===this._backBufferTexture||c!==this._size[0]||f!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(c,f);else{const e=new z.TextureDescriptor;e.internalFormat=g.PixelFormat.RGBA;e.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE;e.width=
c;e.height=f;this._backBufferTexture=new y.Texture(a,e)}this._size[0]=c;this._size[1]=f}}}n.BlendEffect=A;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});