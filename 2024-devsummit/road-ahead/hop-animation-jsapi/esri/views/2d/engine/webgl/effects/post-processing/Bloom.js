// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/maybe ../../VertexStream ../../../../../webgl/enums ../../../../../webgl/FramebufferObject ../../../../../webgl/TextureDescriptor".split(" "),function(u,q,v,f,l,r){const w=[1,0],x=[0,1],y=[1,.8,.6,.4,.2],z=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class A{constructor(){this._compositeFBO=this._intensityFBO=null;this._mipsFBOs=Array(5);this._nMips=5;this._kernelSizeArray=[3,5,7,9,11];this._size=[0,0];this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",
attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._quad=q.disposeMaybe(this._quad);this._intensityFBO=q.disposeMaybe(this._intensityFBO);this._compositeFBO=
q.disposeMaybe(this._compositeFBO);if(this._mipsFBOs){for(let d=0;d<this._nMips;d++)this._mipsFBOs[d]&&(this._mipsFBOs[d].horizontal.dispose(),this._mipsFBOs[d].vertical.dispose());this._mipsFBOs=null}}draw(d,c,a){const {width:e,height:t}=c,{context:b,painter:B}=d,{materialManager:m}=B;var h=b.gl;const n=this._programDesc,{strength:C,radius:D,threshold:E}=a;this._quad||(this._quad=new v(b,[-1,-1,1,-1,-1,1,1,1]));this._createOrResizeResources(d,e,t);b.setStencilTestEnabled(!1);b.setBlendingEnabled(!0);
b.setBlendFunction(f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setStencilWriteMask(0);d=this._quad;d.bind();b.bindFramebuffer(this._intensityFBO);a=m.getProgram(n.luminosityHighPass);b.useProgram(a);b.bindTexture(c.colorTexture,0);a.setUniform1i("u_texture",0);a.setUniform3fv("u_defaultColor",[0,0,0]);a.setUniform1f("u_defaultOpacity",0);a.setUniform1f("u_luminosityThreshold",E);a.setUniform1f("u_smoothWidth",.01);a=[Math.round(e/2),Math.round(t/2)];b.setViewport(0,0,a[0],a[1]);b.setClearColor(0,
0,0,0);b.clear(h.COLOR_BUFFER_BIT);d.draw();b.setBlendingEnabled(!1);h=this._intensityFBO.colorTexture;for(let g=0;g<this._nMips;g++){const k=m.getProgram(n.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[g]}]);b.useProgram(k);b.bindTexture(h,g+1);k.setUniform1i("u_colorTexture",g+1);k.setUniform2fv("u_texSize",a);k.setUniform2fv("u_direction",w);b.setViewport(0,0,a[0],a[1]);const p=this._mipsFBOs[g];b.bindFramebuffer(p.horizontal);d.draw();h=p.horizontal.colorTexture;b.bindFramebuffer(p.vertical);
b.bindTexture(h,g+1);k.setUniform2fv("u_direction",x);d.draw();h=p.vertical.colorTexture;a[0]=Math.round(a[0]/2);a[1]=Math.round(a[1]/2)}b.setViewport(0,0,e,t);a=m.getProgram(n.composite,[{name:"nummips",value:5}]);b.bindFramebuffer(this._compositeFBO);b.useProgram(a);a.setUniform1f("u_bloomStrength",C);a.setUniform1f("u_bloomRadius",D);a.setUniform1fv("u_bloomFactors",y);a.setUniform3fv("u_bloomTintColors",z);b.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1);a.setUniform1i("u_blurTexture1",
1);b.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2);a.setUniform1i("u_blurTexture2",2);b.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3);a.setUniform1i("u_blurTexture3",3);b.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4);a.setUniform1i("u_blurTexture4",4);b.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5);a.setUniform1i("u_blurTexture5",5);d.draw();b.bindFramebuffer(c);b.setBlendingEnabled(!0);c=m.getProgram(n.blit);b.useProgram(c);b.bindTexture(this._compositeFBO.colorTexture,
6);c.setUniform1i("u_texture",6);b.setBlendFunction(f.BlendFactor.ONE,f.BlendFactor.ONE);d.draw();d.unbind();b.setBlendFunction(f.BlendFactor.ONE,f.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setStencilTestEnabled(!0)}_createOrResizeResources(d,c,a){({context:d}=d);if(!this._compositeFBO||this._size[0]!==c||this._size[1]!==a){this._size[0]=c;this._size[1]=a;var e=[Math.round(c/2),Math.round(a/2)];this._compositeFBO?this._compositeFBO.resize(c,a):(c=new r.TextureDescriptor(c,a),c.internalFormat=f.PixelFormat.RGBA,
c.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,this._compositeFBO=new l.FramebufferObject(d,c));this._intensityFBO?this._intensityFBO.resize(e[0],e[1]):(c=new r.TextureDescriptor(e[0],e[1]),c.internalFormat=f.PixelFormat.RGBA,c.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,this._intensityFBO=new l.FramebufferObject(d,c));for(c=0;c<this._nMips;c++)this._mipsFBOs[c]?(this._mipsFBOs[c].horizontal.resize(e[0],e[1]),this._mipsFBOs[c].vertical.resize(e[0],e[1])):(a=new r.TextureDescriptor(e[0],e[1]),a.internalFormat=
f.PixelFormat.RGBA,a.wrapMode=f.TextureWrapMode.CLAMP_TO_EDGE,this._mipsFBOs[c]={horizontal:new l.FramebufferObject(d,a),vertical:new l.FramebufferObject(d,a)}),e[0]=Math.round(e[0]/2),e[1]=Math.round(e[1]/2)}}}u.Bloom=A;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});