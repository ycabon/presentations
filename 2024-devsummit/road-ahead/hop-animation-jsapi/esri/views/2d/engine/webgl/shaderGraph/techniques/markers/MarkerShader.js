// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../chunks/tslib.es6 ../../GraphShaderModule ../../graph/glsl ./markerConstants ../shaders/AFeatureShader ../shaders/constants ../shaders/hittestUtils ../shaders/MosaicInfo ../shaders/utils ../shaders/VisualVariableColor ../shaders/VisualVariableOpacity ../shaders/VisualVariableRotation ../shaders/VisualVariableSizeMinMaxValue ../shaders/VisualVariableSizeScaleStops ../shaders/VisualVariableSizeStops ../shaders/VisualVariableSizeUnitValue ../shaders/vvUtils".split(" "),
function(F,f,g,a,D,J,M,h,R,A,S,T,U,V,W,X,Y,G){function w(b,c,e,m){return c.multiply(b.x).add(e.multiply(b.y)).add(m.multiply(b.z))}function K(b){return b.multiply(b).divide(128)}class u extends J.FeatureVertexInput{}f.__decorate([g.location(3,a.Vec4)],u.prototype,"color",void 0);f.__decorate([g.location(4,a.Vec4)],u.prototype,"outlineColor",void 0);f.__decorate([g.location(5,a.Vec2)],u.prototype,"offset",void 0);f.__decorate([g.location(6,a.Vec2)],u.prototype,"textureUV",void 0);f.__decorate([g.location(7,
a.Vec4)],u.prototype,"sizing",void 0);f.__decorate([g.location(8,a.Float)],u.prototype,"placementAngle",void 0);f.__decorate([g.location(9,a.Float)],u.prototype,"sizeRatio",void 0);f.__decorate([g.location(10,a.Vec2)],u.prototype,"zoomRange",void 0);class E extends g.ComputeVertexInput{}f.__decorate([g.location(12,a.Vec2)],E.prototype,"offsetNextVertex1",void 0);f.__decorate([g.location(13,a.Vec2)],E.prototype,"offsetNextVertex2",void 0);f.__decorate([g.location(14,a.Vec2)],E.prototype,"textureUVNextVertex1",
void 0);f.__decorate([g.location(15,a.Vec2)],E.prototype,"textureUVNextVertex2",void 0);class N extends J.FeatureFragmentInput{}class r extends J.AFeatureShader{constructor(){super(...arguments);this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(b,c){var e=K(b.sizing.x),m=K(b.sizing.y),t=K(b.sizing.z),x=b.placementAngle;const H=A.getBit(b.bitset,D.MarkerConstants.bitset.isSDF),I=A.getBit(b.bitset,D.MarkerConstants.bitset.isMapAligned);
var n=A.getBit(b.bitset,D.MarkerConstants.bitset.scaleSymbolsProportionally),y=A.getBitBool(b.bitset,D.MarkerConstants.bitset.colorLocked),v=G.getVisualVariableOpacity(this,b.id);y=G.getVisualVariableColor(this,b.id,b.color,y).multiply(v);v=this.view.displayViewScreenMat3.multiply(new a.Vec3(b.pos.xy,1));t=G.getVisualVariableSize(this,b.id,t).divide(t);e=e.multiply(t);var z=b.offset.xy.multiply(t);n=m.multiply(n.multiply(t.subtract(1)).add(1));n=a.min(n,a.max(e.subtract(.99),new a.Float(0)));m=a.max(n,
new a.Float(1));n=a.min(n,new a.Float(1));x=a.Mat3.fromRotation(x.multiply(M.c256ToRad));const L=G.getVisualVariableRotation(this,b.id);x=this._getViewRotationMatrix(I).multiply(L).multiply(x).multiply(new a.Vec3(z.xy,0));z=this.clip(b.id,b.zoomRange);v=new a.Vec4(v.xy.add(x.xy),z,1);x=b.textureUV.divide(this.mosaicInfo.size);n=b.outlineColor.multiply(n);z=A.getBit(b.bitset,D.MarkerConstants.bitset.overrideOutlineColor);e=b.sizeRatio.multiply(e).multiply(.5);return{glPosition:v,color:y,textureUV:x,
outlineColor:n,outlineSize:m,distanceToPx:e,isSDF:H,overrideOutlineColor:z,...this.maybeRunHittest(b,c,{pos:b.pos,sizeCorrection:t,isMapAligned:I,outlineSize:m,distanceToPx:e,isSDF:H})}}fragment(b){const c=this._getColor(b.textureUV,b);return this.getFragmentOutput(c,b)}hittest(b,c,e){const {pos:m,sizeCorrection:t,isMapAligned:x,outlineSize:H,isSDF:I,distanceToPx:n}=e;var y=new a.Vec3(b.offset.multiply(t),0),v=new a.Vec3(c.offsetNextVertex1.multiply(t),0);e=new a.Vec3(c.offsetNextVertex2.multiply(t),
0);const {viewMat3:z,tileMat3:L}=this.view;var B=z.multiply(L).multiply(new a.Vec3(m,1)),C=this._getViewScreenMatrix(x),p=B.add(C.multiply(y)).xy,k=B.add(C.multiply(v)).xy,l=B.add(C.multiply(e)).xy,d=this.hittestRequest.position;const q=this.hittestRequest.distance;e=h.xyToBarycentric(d.add(new a.Vec2(a.negate(q),a.negate(q))),p,k,l);B=h.xyToBarycentric(d.add(new a.Vec2(0,a.negate(q))),p,k,l);C=h.xyToBarycentric(d.add(new a.Vec2(q,a.negate(q))),p,k,l);v=h.xyToBarycentric(d.add(new a.Vec2(a.negate(q),
0)),p,k,l);y=h.xyToBarycentric(d,p,k,l);const O=h.xyToBarycentric(d.add(new a.Vec2(q,0)),p,k,l),P=h.xyToBarycentric(d.add(new a.Vec2(a.negate(q),q)),p,k,l),Q=h.xyToBarycentric(d.add(new a.Vec2(0,q)),p,k,l);p=h.xyToBarycentric(d.add(new a.Vec2(q,q)),p,k,l);b=b.textureUV.divide(this.mosaicInfo.size);k=c.textureUVNextVertex1.divide(this.mosaicInfo.size);c=c.textureUVNextVertex2.divide(this.mosaicInfo.size);l={color:new a.Vec4(1),outlineColor:new a.Vec4(1),overrideOutlineColor:new a.Float(1),outlineSize:H,
distanceToPx:n,isSDF:I};d=new a.Float(0);d=d.add(h.inTriangle(e).multiply(this._getColor(w(e,b,k,c),l).a));d=d.add(h.inTriangle(B).multiply(this._getColor(w(B,b,k,c),l).a));d=d.add(h.inTriangle(C).multiply(this._getColor(w(C,b,k,c),l).a));d=d.add(h.inTriangle(v).multiply(this._getColor(w(v,b,k,c),l).a));d=d.add(h.inTriangle(y).multiply(this._getColor(w(y,b,k,c),l).a));d=d.add(h.inTriangle(O).multiply(this._getColor(w(O,b,k,c),l).a));d=d.add(h.inTriangle(P).multiply(this._getColor(w(P,b,k,c),l).a));
d=d.add(h.inTriangle(Q).multiply(this._getColor(w(Q,b,k,c),l).a));d=d.add(h.inTriangle(p).multiply(this._getColor(w(p,b,k,c),l).a));return a.step(d,new a.Float(.05)).multiply(h.failHittest(this.hittestRequest))}_getViewRotationMatrix(b){const c=this.view.displayViewMat3,e=this.view.displayMat3,m=(new a.Float(1)).subtract(b);return c.multiply(b).add(e.multiply(m))}_getViewScreenMatrix(b){const c=this.view.viewMat3.multiply(this.view.tileMat3),e=this.view.tileMat3,m=(new a.Float(1)).subtract(b);return c.multiply(b).add(e.multiply(m))}_getColor(b,
c){return a.ifElse(a.equal(c.isSDF,new a.Float(1)),this._getSDFColor(b,c),this._getSpriteColor(b,c))}_getSpriteColor(b,c){return a.texture2D(this.mosaicInfo.texture,b).multiply(c.color)}_getSDFColor(b,c){b=a.texture2D(this.mosaicInfo.texture,b);var e=(new a.Float(.5)).subtract(A.rgba2float(b)).multiply(c.distanceToPx).multiply(M.softEdgeRatio);b=a.clamp((new a.Float(.5)).subtract(e),new a.Float(0),new a.Float(1));b=c.color.multiply(b);var m=c.outlineSize;this.highlight&&(m=a.max(m,c.overrideOutlineColor.multiply(4)));
m=m.multiply(.5);e=a.abs(e).subtract(m);e=a.clamp((new a.Float(.5)).subtract(e),new a.Float(0),new a.Float(1));c=a.mix(c.outlineColor,c.color,c.overrideOutlineColor).multiply(e);return(new a.Float(1)).subtract(c.a).multiply(b).add(c)}}f.__decorate([g.option(S.VisualVariableColor)],r.prototype,"visualVariableColor",void 0);f.__decorate([g.option(T.VisualVariableOpacity)],r.prototype,"visualVariableOpacity",void 0);f.__decorate([g.option(U.VisualVariableRotation)],r.prototype,"visualVariableRotation",
void 0);f.__decorate([g.option(V.VisualVariableSizeMinMaxValue)],r.prototype,"visualVariableSizeMinMaxValue",void 0);f.__decorate([g.option(W.VisualVariableSizeScaleStops)],r.prototype,"visualVariableSizeScaleStops",void 0);f.__decorate([g.option(X.VisualVariableSizeStops)],r.prototype,"visualVariableSizeStops",void 0);f.__decorate([g.option(Y.VisualVariableSizeUnitValue)],r.prototype,"visualVariableSizeUnitValue",void 0);f.__decorate([g.uniform(R.MosaicInfo)],r.prototype,"mosaicInfo",void 0);f.__decorate([f.__param(0,
g.input(u)),f.__param(1,g.input(E))],r.prototype,"vertex",null);f.__decorate([f.__param(0,g.input(N))],r.prototype,"fragment",null);F.MarkerFragmentInput=N;F.MarkerShader=r;F.MarkerVertexInput=u;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});