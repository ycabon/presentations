// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../core/mathUtils ../../../../../../../core/screenUtils ../../../../../../../geometry/GeometryCursor ../../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../../alignmentUtils ../../../definitions ../../../mesh/templates/shapingUtils ../fill/meshWriterUtils ../mesh/loadGeometryEngine ../mesh/MeshWriter ../shaders/constants ./TextParams ../../../../../../webgl/enums".split(" "),function(w,z,h,F,G,A,x,H,l,I,J,y,K,k){const t=[4,4];var q=[16,4];const L=
{topLeft:q,topRight:q,bottomLeft:q,bottomRight:q};q=[4,2];const m=[4,6],B={topLeft:q,topRight:q,bottomLeft:m,bottomRight:m},C={topLeft:q,topRight:m,bottomLeft:q,bottomRight:m},M={topLeft:m,topRight:m,bottomLeft:t,bottomRight:t},N={topLeft:t,topRight:t,bottomLeft:m,bottomRight:m},O={topLeft:m,topRight:t,bottomLeft:m,bottomRight:t},P={topLeft:t,topRight:m,bottomLeft:t,bottomRight:m},D={createComputedParams:a=>a,attributes:{pos:{type:k.DataType.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:k.DataType.UNSIGNED_BYTE,
count:3,pack:"id"},bitset:{type:k.DataType.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:a,mapAligned:b,isLineLabel:d})=>l.packBitset([[y.bitsetTextIsBackground,a],[y.bitsetTextIsMapAligned,!!b],[y.bitsetTextIsLineLabel,!!d]])},zoomRange:{type:k.DataType.UNSIGNED_BYTE,count:2,packPrecisionFactor:x.minMaxZoomPrecisionFactor,packTessellation:({minZoom:a,maxZoom:b})=>[a||0,b||100]},offset:{type:k.DataType.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:a})=>
{const {bottomLeft:b,bottomRight:d,topLeft:e,topRight:c}=a;return[e,c,b,d]}}},textureUV:{type:k.DataType.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:a})=>{const {bottomLeft:b,bottomRight:d,topLeft:e,topRight:c}=a;return[e,c,b,d]}}},color:{type:k.DataType.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:a})=>a},fontSize:{type:k.DataType.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:a})=>h.pt2px(a)},referenceSize:{type:k.DataType.UNSIGNED_BYTE,
count:1,packPrecisionFactor:4,packTessellation:({fontSize:a},{referenceSize:b})=>h.pt2px(b??a)},haloColor:{type:k.DataType.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:a})=>l.processColorInput(a)},haloFontSize:{type:k.DataType.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:a})=>h.pt2px(a)},clipAngle:{type:k.DataType.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:a})=>Math.round(254/360*(a||0))},referenceSymbol:{type:k.DataType.BYTE,count:4,packPrecisionFactor:1,packTessellation:(a,
b)=>{if(!a.referenceBounds)return[0,0,0,0];const d=A.getXDirection(b.horizontalAlignment);b=A.getYDirection(b.verticalAlignment);const {offsetX:e,offsetY:c,size:f}=a.referenceBounds;return[h.pt2px(e),-h.pt2px(c),h.pt2px(f),d+1<<2|b+1]}}}};class Q extends J.MeshWriter{constructor(){super(...arguments);this.vertexSpec=D;this._textMeshParamsPropsInitialized=!1;this.enablePixelBuffering=!0}ensurePacked(a,b,d){super.ensurePacked(a,b,d);if(!this._textMeshParamsPropsInitialized||this._evaluator.hasDynamicProperties)this._textMeshTransformProps=
new K.TextMeshTransformProps(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0}_write(a,b,d){const e=this._getShaping();if(e){var c=b.getDisplayId();if(null!=this.evaluatedMeshParams.placement)return this._writePlacedTextMarkers(a,b,e,d);if(d&&d.nextPath())return d.nextPoint(),this._writeGlyphs(a,c,d.x,d.y,e,0);if("esriGeometryPolygon"===b.geometryType){b=b.readCentroidForDisplay();if(!b)return;const [f,n]=b.coords;return this._writeGlyphs(a,c,f,n,e,0)}if("esriGeometryMultipoint"===
b.geometryType)b.readGeometryForDisplay()?.forEachVertex((f,n)=>this._writeGlyphs(a,c,f,n,e,0));else return d=b.readXForDisplay(),b=b.readYForDisplay(),this._writeGlyphs(a,c,d,b,e,0)}}_writePlacedTextMarkers(a,b,d,e){if(e=e??F.GeometryCursor.fromFeatureSetReaderCIM(b))if(e=G.CIMMarkerPlacementHelper.getPlacement(e,-1,this.evaluatedMeshParams.placement,h.pt2px(1),a.id,I.getGeometryEngine())){b=b.getDisplayId();for(var c=e.next();null!=c;){const f=c.tx,n=-c.ty;c=-c.getAngle();this._writeGlyphs(a,b,
f,n,d,c);c=e.next()}}}_getShaping(){const a=this._textMeshTransformProps,b=this.evaluatedMeshParams;if(!b.glyphs?.glyphs.length)return null;const d=Math.round(h.pt2px(a.fontSize)),e=h.pt2px(a.offsetX),c=h.pt2px(a.offsetY),f=z.clamp(h.pt2px(b.lineWidth),32,512),n=x.magicLabelLineHeight*z.clamp(b.lineHeightRatio,.25,4);return H.shapeGlyphs(b.glyphs,{scale:d/x.glyphSize,angle:a.postAngle,xOffset:e,yOffset:c,horizontalAlignment:b.horizontalAlignment,verticalAlignment:b.verticalAlignment,maxLineWidth:f,
lineHeight:n,decoration:b.decoration,borderLineSizePx:h.pt2px(b.boxBorderLineSize),hasBackground:!!b.boxBackgroundColor,useCIMAngleBehavior:b.useCIMAngleBehavior})}_writeGlyphs(a,b,d,e,c,f,n){const u=this.evaluatedMeshParams;var g=this._textMeshTransformProps;const r=g.fontSize;var p=h.pt2px(g.offsetX),v=h.pt2px(g.offsetY);0!==f&&c.setRotation(f);g=c.bounds;p=d+g.x+p;v=e+g.y-v;g=2*Math.max(g.width,g.height)*(u.minPixelBuffer?u.minPixelBuffer/r:1);c.textBox&&(a.recordStart(this.instanceId,this.attributeLayout,
c.glyphs[0].textureBinding),this.enablePixelBuffering&&a.recordBounds(p,v,g,g),this._writeTextBox(a,b,d,e,c.textBox,n),a.recordEnd());for(const E of c.glyphs){a.recordStart(this.instanceId,this.attributeLayout,E.textureBinding);this.enablePixelBuffering&&a.recordBounds(p,v,g,g);const {texcoords:R,offsets:S}=E;this._writeQuad(a,b,d,e,{texcoords:R,offsets:S,fontSize:r,color:l.processColorInput(u.color),isBackground:!1,referenceBounds:n});a.recordEnd()}0!==f&&c.setRotation(-f)}_writeTextBox(a,b,d,e,
c,f,n){const u=this.evaluatedMeshParams,{fontSize:g}=this._textMeshTransformProps,{boxBackgroundColor:r,boxBorderLineColor:p}=u;f={isBackground:!0,fontSize:g,referenceBounds:f,...n};r&&(this._writeQuad(a,b,d,e,{texcoords:L,offsets:c.main,color:l.processColorInput(r),...f}),p||(this._writeQuad(a,b,d,e,{texcoords:M,offsets:c.top,color:l.processColorInput(r),...f}),this._writeQuad(a,b,d,e,{texcoords:N,offsets:c.bot,color:l.processColorInput(r),...f}),this._writeQuad(a,b,d,e,{texcoords:O,offsets:c.left,
color:l.processColorInput(r),...f}),this._writeQuad(a,b,d,e,{texcoords:P,offsets:c.right,color:l.processColorInput(r),...f})));p&&(this._writeQuad(a,b,d,e,{texcoords:B,offsets:c.top,color:l.processColorInput(p),...f}),this._writeQuad(a,b,d,e,{texcoords:B,offsets:c.bot,color:l.processColorInput(p),...f}),this._writeQuad(a,b,d,e,{texcoords:C,offsets:c.left,color:l.processColorInput(p),...f}),this._writeQuad(a,b,d,e,{texcoords:C,offsets:c.right,color:l.processColorInput(p),...f}))}_writeQuad(a,b,d,e,
c){const f=a.vertexCount();this._writeVertex(a,b,d,e,c);a.indexWrite(f+0);a.indexWrite(f+1);a.indexWrite(f+2);a.indexWrite(f+1);a.indexWrite(f+3);a.indexWrite(f+2)}}w.TextMeshWriter=Q;w.TextVertexSpec=D;Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});