// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../Color ../../../../Graphic ../../../../symbols ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/spatialReferenceUtils ../../../../layers/GraphicsLayer ../../../../symbols/support/cimSymbolUtils ../../../ViewingMode ./manipulations/DragManipulation ../../../input/keys ../../../interactive/InteractiveToolBase ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/editGeometry/interfaces ../../../../symbols/CIMSymbol".split(" "),
function(g,k,r,t,G,u,v,l,H,I,J,w,m,x,y,n,z,A,B,C,D,E,F){const f={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",toggleOpacity:"t",shift:"Shift",primaryKey:B.primaryKey},p=new r("#009AF2");g.ControlPointsTransformTool=class extends C.InteractiveToolBase{constructor(a){super(a);this._isModifierActive=this._isOpacityToggled=!1;this._factor=1;this._initialControlPoints=null;this._graphicsLayer=new y({internal:!0,listMode:"hide",visible:!1,effect:"drop-shadow(0px, 0px, 3px)"});this._undoStack=
[];this._redoStack=[];this._sharedUndoStack=[];this._sharedRedoStack=[];this._highlightHandle=null;this.activeHandle=0}initialize(){this._initialize()}destroy(){const {map:a}=this.view;this._controlPointManipulations.forEach(c=>c.destroy());this._controlPointEditGeometryOperations.forEach(c=>c.destroy());a.removeMany([this._graphicsLayer]);this._graphicsLayer.removeAll();this._graphicsLayer=u.destroyMaybe(this._graphicsLayer);this._sharedRedoStack=this._sharedUndoStack=this._initialControlPoints=
this._redoStack=this._undoStack=this._controlPointEditGeometryOperations=this._graphicsLayer=this._controlPointManipulations=this._controlPointGraphics=this._georeference=null}get _hasValidSpatialReference(){return x.isValid(this.view.spatialReference)}onActivate(){this.visible=!0}onDeactivate(){this.visible=!1}onShow(){this._graphicsLayer.visible=!0}onHide(){this._graphicsLayer.visible=!1}canUndo(){const a=this._undoStack[this._undoStack.length-1];return null!=a?this._controlPointEditGeometryOperations[a].canUndo:
!1}canRedo(){const a=this._redoStack[this._redoStack.length-1];return null!=a?this._controlPointEditGeometryOperations[a].canRedo:!1}undo(){if(0<this._undoStack.length){const a=this._undoStack.pop();this._controlPointEditGeometryOperations[a].undo();this.updateGraphics();this._redoStack.push(a)}}redo(){if(0<this._redoStack.length){const a=this._redoStack.pop();this._controlPointEditGeometryOperations[a].redo();this.updateGraphics();this._undoStack.push(a)}}refresh(){var {mediaElement:a}=this;null!=
a.georeference&&(a=a.georeference,"control-points"===a.type&&null!=a.coords&&(this._georeference=a,this._georeference.controlPoints.forEach(({mapPoint:c},d)=>{d=this._controlPointEditGeometryOperations[d];d.setVertexPosition(d.data.components[0].vertices[0],d.data.coordinateHelper.pointToVector(c))}),this.updateGraphics()))}reset(){this._georeference.controlPoints=this._initialControlPoints;this.refresh();this._sharedUndoStack.length=0;this._sharedRedoStack.length=0}updateGraphics(){const a=this._georeference,
c=a.controlPoints,d=c[0].mapPoint.spatialReference,b=this._hasValidSpatialReference;this._georeference.controlPoints=this._controlPointEditGeometryOperations.map((e,h)=>{e=e.data.geometry;this._controlPointGraphics[h].geometry=e;return{mapPoint:m.project(e,d),sourcePoint:b?c[h].sourcePoint:a.toSource(e)}})}updateActiveHandle(a){if(this.activeHandle!==a){var c=this._controlPointGraphics[this.activeHandle].symbol.clone();n.applyCIMSymbolColor(c,this.view.effectiveTheme.accentColor);this._controlPointGraphics[this.activeHandle].symbol=
c;c=this._controlPointGraphics[a].symbol.clone();n.applyCIMSymbolColor(c,p);this._controlPointGraphics[a].symbol=c;this.activeHandle=a;this.view.surface===document.activeElement&&this.highlightActiveHandle()}}async highlightActiveHandle(){this.removeHighlightActiveHandle();this._highlightHandle=(await this.view.whenLayerView(this._graphicsLayer)).highlight(this._controlPointGraphics[this.activeHandle])}removeHighlightActiveHandle(){this._highlightHandle&&this._highlightHandle.remove()}setSharedUndoStack(a){this._sharedUndoStack=
a}setSharedRedoStack(a){this._sharedRedoStack=a}async _initialize(){const {view:a,mediaElement:c}=this;if(null!=c.georeference){var d=c.georeference;"control-points"===d.type&&null!=d.coords&&(this._georeference=d,this._initialControlPoints=this._georeference.controlPoints,a.map.addMany([this._graphicsLayer]),a.focus(),this.visible=!1,this.finishToolCreation(),await this._loadProjectionEngine(),this._controlPointEditGeometryOperations=this._georeference.controlPoints.map(({mapPoint:b})=>D.EditGeometryOperations.fromGeometry(m.project(b,
a.spatialReference),z.ViewingMode.Local)),this._controlPointGraphics=this._controlPointEditGeometryOperations.map((b,e)=>new t({symbol:new F({data:{type:"CIMSymbolReference",symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,colorLocked:!0,anchorPoint:{x:0,y:-15.75},anchorPointUnits:"Absolute",dominantSizeAxis3D:"Y",size:9,billboardMode3D:"FaceNearPlane",frame:{xmin:0,ymin:0,xmax:84.3,ymax:84.3},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[83.2,32.5],[84.3,
40.7],[83.8,48.9],[81.7,56.9],[78.1,64.3],[73,70.9],[66.9,76.4],[59.7,80.5],[51.9,83.2],[43.7,84.3],[35.4,83.8],[27.4,81.7],[20,78],[13.4,73],[7.9,66.8],[3.8,59.7],[1.1,51.9],[0,43.7],[.5,35.4],[2.6,27.4],[6.3,20],[11.3,13.4],[17.5,7.9],[24.7,3.8],[32.5,1.1],[39.8,.1],[47.1,.3],[54.3,1.8],[61.1,4.5],[67.4,8.4],[72.9,13.3],[77.4,19.1],[80.9,25.5],[83.2,32.5]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[255,255,255,255]}]}}],scaleSymbolsProportionally:!0,respectFrame:!0,
clippingPath:{type:"CIMClippingPath",clippingType:"Intersect",path:{rings:[[[0,0],[84.3,0],[84.3,84.3],[0,84.3],[0,0]]]}},rotation:0},{type:"CIMVectorMarker",enable:!0,anchorPoint:{x:0,y:-11.25},anchorPointUnits:"Absolute",dominantSizeAxis3D:"Y",size:22.5,billboardMode3D:"FaceNearPlane",frame:{xmin:0,ymin:0,xmax:197.7,ymax:294.7},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[98.9,0],[119.4,23.2],[139.4,49.3],[156.8,75.2],[171.2,100.8],[182.4,125.3],[190.6,148.8],[195.7,171.4],[197.7,
192.9],[197.7,195.8],[197.7,200.3],[197.6,202.5],[197.5,204.8],[197.3,207.1],[197,209.4],[196.7,211.7],[196.4,214.1],[196,216.4],[195.5,218.7],[195,221.1],[194.4,223.4],[193.7,225.8],[193,228.1],[192.2,230.5],[191.4,232.8],[190.5,235.1],[189.5,237.5],[188.5,239.7],[187.4,242],[186.2,244.3],[185,246.5],[183.7,248.7],[182.4,250.9],[181,253.1],[179.5,255.2],[178,257.3],[176.4,259.4],[174.7,261.4],[173.1,263.3],[171.3,265.3],[169.5,267.2],[167.7,269],[165.8,270.8],[163.9,272.5],[161.9,274.2],[159.9,275.8],
[157.8,277.4],[155.7,278.9],[153.6,280.4],[151.4,281.7],[149.2,283.1],[147,284.4],[144.8,285.6],[142.5,286.7],[140.3,287.8],[138,288.8],[135.7,289.8],[133.4,290.7],[131,291.5],[128.7,292.3],[126.4,293],[124,293.6],[121.7,294.2],[119.4,294.7],[117,295.2],[114.7,295.6],[112.4,296],[110.1,296.3],[107.8,296.5],[105.5,296.7],[103.3,296.8],[101.1,296.9],[98.8,296.9],[83.1,295.7],[67.8,292],[53.3,285.9],[39.9,277.5],[28.1,267.2],[18,255.1],[10,241.5],[4.2,226.9],[.9,211.5],[0,195.8],[.1,192.9],[2.1,171.4],
[7.2,148.8],[15.4,125.3],[26.6,100.8],[41,75.2],[58.4,49.3],[78.4,23.2],[98.9,0]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e===this.activeHandle?p.toArray():this.view.effectiveTheme.accentColor.toArray()}]}}],scaleSymbolsProportionally:!0,respectFrame:!0,clippingPath:{type:"CIMClippingPath",clippingType:"Intersect",path:{rings:[[[0,0],[197.7,0],[197.7,294.7],[0,294.7],[0,0]]]}},rotation:0}],haloSize:1,scaleX:1,angleAlignment:"Display",angle:0}}}),geometry:b.data.geometry})),
this._graphicsLayer.graphics.addMany([...this._controlPointGraphics]),this._controlPointManipulations=this._controlPointGraphics.map(b=>new A.DragManipulation({tool:this,view:a,graphic:b})),this.addHandles([...this._controlPointManipulations.map((b,e)=>b.createDragPipeline(this._getInfo.bind(this,e),(h,q)=>{"start"===h.action&&(this._undoStack.push(e),this._redoStack=[],this._sharedUndoStack.push({tool:this,operation:q}),this._sharedRedoStack.length=0);this.updateGraphics()})),v.watch(()=>this.view.scale,
()=>this.active?this.updateGraphics():null)]),this._controlPointManipulations.forEach((b,e)=>{b.forEachManipulator(h=>{this.addHandles([h.events.on(["click","grab-changed"],q=>this.updateActiveHandle(e))])})}),this.addHandles([a.on("key-down",b=>{a.activeTool===this&&(b.key!==f.shift||b.repeat||(this._isModifierActive=!0,b.stopPropagation()),b.key!==f.toggleOpacity||b.repeat||(c.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled,b.stopPropagation()),b.key!==f.primaryKey||
b.repeat||(this._factor=10,b.stopPropagation()),this._isModifierActive&&(b.key===f.up&&(this._move(0,this._factor),b.stopPropagation()),b.key===f.down&&(this._move(0,-this._factor),b.stopPropagation()),b.key===f.left&&(this._move(-this._factor,0),b.stopPropagation()),b.key===f.right&&(this._move(this._factor,0),b.stopPropagation())))}),a.on("key-up",b=>{a.activeTool===this&&(b.key===f.shift&&(this._isModifierActive=!1,b.stopPropagation()),b.key===f.primaryKey&&(this._factor=1,b.stopPropagation()))})]))}}async _loadProjectionEngine(){return m.initializeProjection(this._georeference.controlPoints[0].mapPoint.spatialReference,
this.view.spatialReference)}_getInfo(a){return{editGeometryOperations:this._controlPointEditGeometryOperations[a],constraints:this._hasValidSpatialReference?null:{xmin:0,ymin:0,xmax:this._georeference.width,ymax:this._georeference.height}}}_move(a,c){const d=this._controlPointEditGeometryOperations[this.activeHandle],b=[];for(const e of d.data.components)b.push(...e.vertices);a=d.moveVertices(b,a*this.view.resolution,c*this.view.resolution,0,E.AccumulationBehavior.NEW_STEP);this._sharedUndoStack.push({tool:this,
operation:a});this._sharedRedoStack.length=0;this.updateGraphics()}};k.__decorate([l.property()],g.ControlPointsTransformTool.prototype,"_hasValidSpatialReference",null);k.__decorate([l.property()],g.ControlPointsTransformTool.prototype,"activeHandle",void 0);k.__decorate([l.property({constructOnly:!0,nonNullable:!0})],g.ControlPointsTransformTool.prototype,"mediaElement",void 0);k.__decorate([l.property({constructOnly:!0})],g.ControlPointsTransformTool.prototype,"view",void 0);g.ControlPointsTransformTool=
k.__decorate([w.subclass("esri.views.2d.interactive.editingTools.ControlPointsTransformTool")],g.ControlPointsTransformTool);g.keys=f;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});