// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Logger ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../support/GraphicsCollection ../engine/BitmapContainer ./LayerView2D ./graphics/GraphicsView2D ./graphics/HighlightGraphicContainer ./support/ExportStrategy ../../layers/LayerView ../../layers/MapImageLayerView ../../layers/RefreshableLayerView ../../layers/support/MapServiceLayerViewHelper ../../support/drapedUtils".split(" "),
function(f,l,m,n,k,d,D,p,q,r,t,u,v,w,x,y,z,A,B){d=class extends y(z(t.LayerView2DMixin(x))){constructor(){super(...arguments);this._highlightGraphics=new q.GraphicsCollection;this._updateHash=""}fetchPopupFeaturesAtLocation(a,b){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(a,b)}update(a){const b=`${this.exportImageVersion}/${a.state.id}/${a.pixelRatio}/${a.stationary}`;this._updateHash!==b&&(this._updateHash=b,this.strategy.update(a).catch(c=>{m.isAbortError(c)||l.getLogger(this).error(c)}),
a.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(a.state.resolution));this._highlightView.processUpdate(a)}attach(){const {imageMaxWidth:a,imageMaxHeight:b,version:c}=this.layer,e=10.3<=c,C=10<=c;this._bitmapContainer=new r.BitmapContainer;this.container.addChild(this._bitmapContainer);this._highlightView=new u({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});
this.container.addChild(this._highlightView.container);this._popupHighlightHelper=new A.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(g,h)=>B.createQueryGeometry(g,h,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(g,h)=>{this._highlightView.graphicUpdateHandler({graphic:g,property:h})},layerView:this,updatingHandles:this._updatingHandles});this.strategy=new w({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),
imageMaxWidth:a,imageMaxHeight:b,imageRotationSupported:e,imageNormalizationSupported:C,hidpi:!0});this.addAttachHandles(n.watch(()=>this.exportImageVersion,()=>this.requestUpdate()));this.requestUpdate()}detach(){this.strategy.destroy();this.container.removeAllChildren();this._bitmapContainer.removeAllChildren();this._highlightView.destroy();this._popupHighlightHelper.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(a){return this.layer.serviceSupportsSpatialReference(a)}async doRefresh(){this._updateHash=
"";this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(a,b,c,e){return this.layer.fetchImage(a,b,c,{timeExtent:this.timeExtent,floors:this.floors,...e})}fetchImageBitmap(a,b,c,e){return this.layer.fetchImageBitmap(a,b,c,{timeExtent:this.timeExtent,floors:this.floors,...e})}highlight(a){return this._popupHighlightHelper.highlight(a)}};f.__decorate([k.property()],d.prototype,"strategy",void 0);f.__decorate([k.property()],d.prototype,"updating",void 0);return d=
f.__decorate([p.subclass("esri.views.2d.layers.MapImageLayerView2D")],d)});