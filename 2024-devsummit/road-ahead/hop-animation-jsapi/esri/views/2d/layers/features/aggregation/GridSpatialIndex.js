// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../core/unitUtils","./GridCell"],function(f,k,l){function m(a,b){return k.getMetersPerUnitForSR(a)*k.inchesPerMeter*96/b}class p{constructor(a){this._options=a;this._cells=new Map;this._pixelsPerMapUnit=m(a.spatialReference,a.scale)}insert(a){a=a.getCursor();const b={$view:{scale:this._options.scale}};for(;a.next();)this._insertFeature(a,b)}putCellsInBounds(a,b){const [c,d,q,r]=b;b=Math.floor(c*this._pixelsPerMapUnit/this._options.cellSize);var g=Math.floor(d*this._pixelsPerMapUnit/
this._options.cellSize);const t=Math.ceil(q*this._pixelsPerMapUnit/this._options.cellSize),u=Math.ceil(r*this._pixelsPerMapUnit/this._options.cellSize);for(;g<=u;g++)for(let h=b;h<=t;h++){const e=this._cells.get(`${h}.${g}`);if(!e)continue;const n=a.get(e.id);n?e&&!a.has(e.id)&&n.merge(e):a.set(e.id,e.clone())}}putCells(a){for(const b of this._cells.values()){const c=a.get(b.id);c?b&&!a.has(b.id)&&c.merge(b):a.set(b.id,b.clone())}}_insertFeature(a,b){var {featureFilter:c}=this._options;if(null===
c||c.check(a)){c=a.readXWorldSpace()*this._pixelsPerMapUnit;var d=a.readYWorldSpace()*this._pixelsPerMapUnit;this._getCellOrCreate(Math.floor(c/this._options.cellSize),Math.floor(d/this._options.cellSize)).insert(a,b)}}_getCellOrCreate(a,b){const c=l.GridCell.createId(a,b);let d=this._cells.get(c);d||(d=l.GridCell.create(a,b,this._options.fields,1*this._options.cellSize/this._pixelsPerMapUnit),this._cells.set(c,d));return d}}f.GridSpatialIndex=p;f.pixelsPerMapUnit=m;Object.defineProperty(f,Symbol.toStringTag,
{value:"Module"})});