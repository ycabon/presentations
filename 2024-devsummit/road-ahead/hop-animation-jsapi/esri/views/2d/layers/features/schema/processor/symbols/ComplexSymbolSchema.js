// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../../symbols/cim/CIMSymbolHelper","../../../../../../../symbols/cim/defaultCIMValues","../../../../../engine/webgl/shaderGraph/techniques/TechniqueRegistry","../VisualVariablesSchema"],function(m,J,K,u,y){function A(b){return b.minScale||b.maxScale?{minScale:b.minScale??0,maxScale:b.maxScale??0}:null}function n(b){if(null==b)return null;if(Array.isArray(b)){const [a,e,h,k]=b;return[a,e,h,255*k]}return"string"===typeof b?b:{...b,defaultValue:n(b?.defaultValue)}}function B(b){return!!(b.visualVariableSizeMinMaxValue||
b.visualVariableSizeScaleStops||b.visualVariableSizeStops||b.visualVariableSizeUnitValue||b.visualVariableSizeOutlineScaleStops)}function C(b,a,e,{scaleInfo:h,scaleExpression:k}){const f=B(e);return[b.createMeshInfo({params:{size:a.size,scaleX:a.scaleX,anchorX:a.anchorPoint.x,anchorY:a.anchorPoint.y,angle:a.rotation,color:n(a.color)??[0,0,0,0],colorLocked:a.colorLocked,frameHeight:a.frameHeight,scaleInfo:h,offsetX:a.offsetX,offsetY:a.offsetY,outlineColor:n(a.outlineColor)??[0,0,0,0],outlineSize:a.outlineWidth,
referenceSize:a.referenceSize||K.defaultCIMValues.CIMVectorMarker.size,rotateClockwise:a.rotateClockwise,scaleFactor:k??1,sizeRatio:a.sizeRatio,alignment:a.alignment,isAbsoluteAnchorPoint:a.isAbsoluteAnchorPoint,scaleSymbolsProportionally:a.scaleSymbolsProportionally,sprite:a.spriteRasterizationParam,hasSizeVV:f,placement:a.markerPlacement,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,transforms:a.transform,minPixelBuffer:y.getMaxSizeVVSize(e)}})]}function D(b,a,{scaleInfo:e}){return[b.createMeshInfo({params:{color:n(a.color)??
[0,0,0,0],scaleInfo:e,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}})]}function E(b,a,e,{scaleInfo:h}){if(!a.spriteRasterizationParam)throw Error("InternalError: Sprite should always be defined");e=!!a.hasUnresolvedReplacementColor&&(!e||a.colorLocked);e=a.sampleAlphaOnly&&!e;const k=a.spriteRasterizationParam;return[b.createMeshInfo({params:{color:n(a.color)??[0,0,0,0],height:a.height,aspectRatio:a.scaleX,offsetX:a.offsetX,offsetY:a.offsetY,scaleX:1,scaleY:1,angle:a.angle,
applyRandomOffset:a.applyRandomOffset,sampleAlphaOnly:e,scaleProportionally:"CIMHatchFill"===k.resource.type,sprite:k,scaleInfo:h,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}})]}function F(b,a,{scaleInfo:e}){return{params:{color:n(b.color)??[0,0,0,0],width:b.width,referenceWidth:b.referenceWidth,capType:b.cap,joinType:b.join,miterLimit:b.miterLimit,scaleInfo:e,hasSizeVV:a,effects:b.effects?{type:"cim-effect-infos",effectInfos:b.effects}:null}}}function G(b,a,e,h){if(a.spriteRasterizationParam)throw Error("InternalError: Sprite should not be defined");
return[b.createMeshInfo({params:F(a,e,h).params})]}function H(b,a,e,h){const {spriteRasterizationParam:k,scaleDash:f,sampleAlphaOnly:r}=a;if(!k)throw Error("InternalError: Sprite should be defined");return[b.createMeshInfo({params:{...F(a,e,h).params,shouldScaleDash:f??!1,shouldSampleAlphaOnly:r,isSDF:"CIMPictureStroke"!==k.resource.type,sprite:k}})]}function I(b,a,e,{scaleInfo:h}){return[b.createMeshInfo({params:{boxBackgroundColor:n(a.backgroundColor),boxBorderLineColor:n(a.borderLineColor),boxBorderLineSize:a.borderLineWidth??
0,color:n(a.color)??[0,0,0,0],offsetX:a.offsetX,offsetY:a.offsetY,postAngle:a.angle,fontSize:a.size,referenceSize:a.referenceSize,decoration:a.decoration,haloColor:n(a.outlineColor)??[0,0,0,0],haloFontSize:a.outlineSize,lineWidth:a.lineWidth||512,lineHeightRatio:1,horizontalAlignment:a.horizontalAlignment??"center",verticalAlignment:a.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:a.textRasterizationParam,scaleInfo:h,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null,
placement:a.markerPlacement,transforms:a.transform,minPixelBuffer:y.getMaxSizeVVSize(e),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}m.createComplexFillMeshInfos=E;m.createComplexMarkerMeshInfos=C;m.createComplexSimpleFillMeshInfos=D;m.createComplexSimpleLineMeshInfos=G;m.createComplexSymbolInstances=async function(b,a){const {cimResourceManager:e,cimAnalyzer:h,scaleExpression:k}=a.schemaOptions;await Promise.all(J.CIMSymbolHelper.fetchResources(b.symbol,
e,[]));var f=h.analyzeSymbolReference(b,!1);b={scaleInfo:A(b),scaleExpression:k};const r=[];for(const w of f)switch(w.type){case "marker":f=r;var t=f.push;var d=w;var g=b;const {uniforms:p,schemaOptions:L}=a;var {store:c}=L;c=c.ensureInstance(u.Techniques.marker,{geometry:d.isOutline?{...y.noVisualVariables,visualVariableSizeScaleStops:p.visualVariableSizeOutlineScaleStops}:{visualVariableColor:p.visualVariableColor,visualVariableOpacity:p.visualVariableOpacity,visualVariableSizeMinMaxValue:p.visualVariableSizeMinMaxValue,
visualVariableSizeScaleStops:p.visualVariableSizeScaleStops,visualVariableSizeStops:p.visualVariableSizeStops,visualVariableSizeUnitValue:p.visualVariableSizeUnitValue,visualVariableRotation:p.visualVariableRotation}},{zoomRange:!!g.scaleInfo});d=C(c,d,p,g);t.call(f,...d);break;case "fill":f=r;t=f.push;a:{g=w;c=a;d=b;if(!g.spriteRasterizationParam){const {uniforms:x,schemaOptions:M}=c;({store:c}=M);c=c.ensureInstance(u.Techniques.fill,{geometry:{visualVariableColor:g.colorLocked?null:x.visualVariableColor,
visualVariableOpacity:x.visualVariableOpacity}},{zoomRange:!!d.scaleInfo});d=D(c,g,d);break a}const {uniforms:l,schemaOptions:z}=c;({store:c}=z);c=c.ensureInstance(u.Techniques.complexFill,{geometry:{visualVariableColor:g.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity}},{zoomRange:!!d.scaleInfo});d=E(c,g,null!=l.visualVariableColor,d)}t.call(f,...d);break;case "line":f=r;t=f.push;{d=w;g=b;const {uniforms:l,schemaOptions:z}=a;var {store:v}=z;c=d.isOutline?{...y.noVisualVariables,
visualVariableSizeScaleStops:l.visualVariableSizeOutlineScaleStops}:{visualVariableColor:d.colorLocked?null:l.visualVariableColor,visualVariableOpacity:l.visualVariableOpacity,visualVariableSizeMinMaxValue:l.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:l.visualVariableSizeScaleStops,visualVariableSizeStops:l.visualVariableSizeStops,visualVariableSizeUnitValue:l.visualVariableSizeUnitValue};const x={geometry:c};c=!!(c.visualVariableSizeMinMaxValue||c.visualVariableSizeScaleStops||c.visualVariableSizeStops||
c.visualVariableSizeUnitValue);d.spriteRasterizationParam?(v=v.ensureInstance(u.Techniques.texturedLine,x,{zoomRange:!!g.scaleInfo}),d=H(v,d,c,g)):(v=v.ensureInstance(u.Techniques.line,x,{zoomRange:!!g.scaleInfo}),d=G(v,d,c,g))}t.call(f,...d);break;case "text":f=r;t=f.push;d=w;g=b;const {uniforms:q,schemaOptions:N}=a;({store:c}=N);c=c.ensureInstance(u.Techniques.text,{geometry:{visualVariableColor:d.colorLocked?null:q.visualVariableColor,visualVariableOpacity:q.visualVariableOpacity,visualVariableRotation:q.visualVariableRotation,
visualVariableSizeMinMaxValue:q.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:q.visualVariableSizeScaleStops,visualVariableSizeStops:q.visualVariableSizeStops,visualVariableSizeUnitValue:q.visualVariableSizeUnitValue}},{zoomRange:!!g.scaleInfo,referenceSymbol:!1,clipAngle:!1});d=I(c,d,q,g);t.call(f,...d)}return r};m.createComplexTextMeshInfos=I;m.createComplexTexturedLineMeshInfos=H;m.getScaleInfo=A;m.hasSizeVVUniform=B;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});