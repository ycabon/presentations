// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../core/has ../../../../../../core/promiseUtils ./ATileLoadStrategy ./chunks/DrillDownTileSourceChunk ../../support/FeatureSetReaderJSON".split(" "),function(h,l,e,m,k,n){class p{constructor(a,c){this.subscription=a;this._tileIdToResult=new Map;this._controller=new AbortController;e.onAbort(a.options,()=>this._controller.abort());e.onAbort(c,()=>this._controller.abort())}get(a){return this._tileIdToResult.get(a)}set(a,c){this._tileIdToResult.set(a,c)}get options(){return{signal:this._controller.signal}}}
class q extends m.ATileLoadStrategy{constructor(){super(...arguments);this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(a){this._loadStates.has(a.key.id)||this._loadStates.set(a.key.id,new p(a,this._options));const c=this._loadStates.get(a.key.id);let d;try{for await(const b of this._fetchChunkInfos(c,a.tile,0)){const {queryJSON:f,reader:g,sourceTile:r,sourceTileDepth:t,tile:u}=b,v=new k.DrillDownTileSourceChunk(g,f,u,r,t,!1);e.throwIfAborted(a.options);
this._addChunk(v)}}catch(b){d=b}a=new k.DrillDownTileSourceChunk(n.FeatureSetReaderJSON.empty(this._metadata),null,a.tile,null,-1,!0);this._addChunk(a);if(d)throw d;}unload(a){super.unload(a);this._loadStates.delete(a.key.id)}async *_fetchChunkInfos(a,c,d){let b=a.get(c.id);const f=!!b;b||(b=await this._fetchChunkInfo(a,c,d),a.set(c.id,b));if(b.reader.exceededTransferLimit&&d<l("featurelayer-query-max-depth"))for(const g of c.createChildTiles())yield*this._fetchChunkInfos(a,g,d+1);else f||(yield b)}async _fetchChunkInfo(a,
c,d){var b=a.subscription.tile.getQuantizationParameters();b=this._queryInfo.createTileQuery(c,{returnExceededLimitFeatures:!1,quantizationParameters:b});return{reader:await this._fetch(b,a.subscription.options),queryJSON:b.inner.toJSON(),tile:a.subscription.tile,sourceTile:c,sourceTileDepth:d}}}h.DrillDownTileLoadStrategy=q;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});