// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../../core/promiseUtils","./ATileLoadStrategy","./chunks/PagedTileSourceChunk","../../support/FeatureSetReaderJSON"],function(h,f,l,k,m){class n{constructor(a,b){this.subscription=a;this._pages=new Set;this._controller=new AbortController;this._done=!1;f.onAbort(a.options,()=>this._controller.abort());f.onAbort(b,()=>this._controller.abort())}resetAbortController(){this._controller=new AbortController}get pageStart(){let a=-1;for(const b of this._pages.values())a=Math.max(a,
b);return a+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(a,b){this._pages.add(a);this._done=this._done||b}}class p extends l.ATileLoadStrategy{constructor(){super(...arguments);this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(a){this._loadStates.has(a.key.id)||this._loadStates.set(a.key.id,new n(a,this._options));const b=this._loadStates.get(a.key.id);b.resetAbortController();let c;try{await this._fetchPages(b)}catch(d){c=
d}a=new k.PagedTileSourceChunk(m.FeatureSetReaderJSON.empty(this._metadata),null,a.tile,-1,!0);f.isAborted(b.options)||this._addChunk(a);if(c)throw c;}unload(a){super.unload(a);this._loadStates.delete(a.key.id)}async _fetchPages(a){let b=0,c=a.pageStart,d=1;for(;20>b&&!a.done;){var g=[];for(let e=0;e<d;e++)g.push(this._fetchChunk(a,c++));g=await Promise.all(g);for(const e of g)if(0!==e.size()||e.first)a.add(e.page,!e.reader.exceededTransferLimit),f.throwIfAborted(a.options),this._addChunk(e);b++;
d=Math.min(d+1,4)}}async _fetchChunk(a,b){const c=a.subscription.tile,d=this._queryInfo.createPagedTileQuery(c,b);a=await this._fetch(d,a.options);return new k.PagedTileSourceChunk(a,d.inner.toJSON(),c,b,!1)}}h.PagedTileLoadStrategy=p;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});