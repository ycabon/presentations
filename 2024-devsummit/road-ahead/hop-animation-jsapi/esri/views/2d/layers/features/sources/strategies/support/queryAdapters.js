// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../../core/has ../../../../../../../core/workers/Connection ../../../../../../../geometry/support/quantizationUtils ../../../../../../../layers/graphics/featureConversionUtils ../../../../../../../layers/ogc/ogcFeatureUtils ../../../../../../../rest/query/operations/query ../../../support/FeatureSetReaderJSON ../../../support/FeatureSetReaderPBF".split(" "),function(h,p,q,m,k,n,l,e,r){async function t(a){const b=new q;await b.open(a,{});return b}class f{constructor(a,
b){this.service=a;this._metadata=b}destroy(){}}class u extends f{constructor(a,b){super(a,b);this._portsOpen=t(a.source).then(d=>this.client=d)}destroy(){this.client.close();this.client=null}async executeQuery(a,b){await this._portsOpen;a=await this.client.invoke("queryFeatures",a.toJSON(),b);return e.FeatureSetReaderJSON.fromFeatureSet(a,this._metadata)}}class v extends f{async executeQuery(a,b){({data:b}=await l.executeQueryPBFBuffer(this.service.source,a,b));return r.FeatureSetReaderPBF.fromBuffer(b,
this._metadata,!a.quantizationParameters)}}class w extends f{async executeQuery(a,b){const {source:d,capabilities:g,spatialReference:x,objectIdField:y,geometryType:z}=this.service;if(null!=a.quantizationParameters&&!g.query.supportsQuantization){const c=a.clone();a=m.toQuantizationTransform(c.quantizationParameters);c.quantizationParameters=null;({data:b}=await l.executeQuery(d,c,x,b));b=k.convertFromFeatureSet(b,y);k.quantizeOptimizedFeatureSet(a,b);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(b,
this._metadata)}({data:a}=await l.executeQuery(d,a,this.service.spatialReference,b));"esriGeometryPoint"===z&&(a.features=a.features?.filter(c=>null!=c.geometry?(c=c.geometry,Number.isFinite(c.x)&&Number.isFinite(c.y)):!0));return e.FeatureSetReaderJSON.fromFeatureSet(a,this._metadata)}}class A extends f{async executeQuery(a,b){var {capabilities:d}=this.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const g=a.clone();d=m.toQuantizationTransform(g.quantizationParameters);g.quantizationParameters=
null;a=await n.queryOptimizedFeatureSet(this.service.source,a,b);k.quantizeOptimizedFeatureSet(d,a);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(a,this._metadata)}a=await n.queryOptimizedFeatureSet(this.service.source,a,b);return e.FeatureSetReaderJSON.fromOptimizedFeatureSet(a,this._metadata)}}h.SourceAdapter=f;h.createQueryAdapter=function(a,b){switch(a.type){case "memory":return new u(a,b);case "ogc":return new A(a,b);case "feature-service":return a.capabilities.query.supportsFormatPBF&&
p("featurelayer-pbf")?new v(a,b):new w(a,b)}};Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});