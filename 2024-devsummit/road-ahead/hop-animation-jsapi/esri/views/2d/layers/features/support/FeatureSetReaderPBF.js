// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/pbf ../../../../../layers/graphics/OptimizedGeometry ./FeatureSetReader ./FeatureSetReaderPBFHeader".split(" "),function(D,H,I,J,K,x,L,M){function E(a){if(a<=q.small.delta.length)return q.small;if(a<=q.large.delta.length)return q.large;q.large.delta=new Int32Array(Math.round(1.25*a));q.large.decoded=new Int32Array(Math.round(1.25*a));return q.large}function N(a){var c=a.getLength();for(c=
a.pos()+c;a.pos()<c&&a.next();)switch(a.tag()){case 1:return a.getString();case 2:return a.getFloat();case 3:return a.getDouble();case 4:return a.getSInt32();case 5:return a.getUInt32();case 6:return a.getInt64();case 7:return a.getUInt64();case 8:return a.getSInt64();case 9:return a.getBool();default:return a.skip(),null}return null}function A(a,c,e,f){return 0===a*f-e*c&&0<a*e+c*f}const q={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128E3),decoded:new Int32Array(128E3)}};
class B extends L.FeatureSetReader{static fromBuffer(a,c,e=!1){const f=c.geometryType;a:{try{const b=new K(new Uint8Array(a),new DataView(a));for(;b.next();)switch(b.tag()){case 2:b:{for(var g=b.getMessage();g.next();)switch(g.tag()){case 1:var d=g.getMessage();break b;default:g.skip()}d=null}break a;default:b.skip()}}catch(b){a=new H("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:b}),I.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(a)}d=null}a=
d;e=M.parseHeader(a,"esriGeometryPoint"===f,e);return new B(a,e,c)}constructor(a,c,e){super(e);this._isPoints=this._hasNext=!1;this._featureIndex=-1;this._featureOffset=0;this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};this._geometryType=e.geometryType;this._reader=a;this._header=c;this._hasNext=c.hasFeatures;this._isPoints="esriGeometryPoint"===e.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=
0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a}getAttributeHash(){let a="";for(const c of this._header.fields.fields)a+=this._readAttributeAtIndex(c.index)+".";return a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=
a}readGeometryArea(){this._cache.area||this._readGeometry(!0);return this._cache.area}copy(){var a=this._reader.clone();a=new B(a,this._header,this.metadata);this.copyInto(a);return a}next(){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;for(this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*
this._featureIndex+1]}_readServerCentroid(){const a=this._header.centroid[2*this._featureIndex];return 268435455===a?null:new x([],[a,this._header.centroid[2*this._featureIndex+1]])}_readGeometry(a=!1){if(void 0===this._cache.geometry){let c=null;if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;c=new x([],[this._header.centroid[2*this._featureIndex],this._header.centroid[2*this._featureIndex+1]])}else{const e=this._header.offsets.geometry[this._featureIndex],
f=this._reader;if(0===e)return null;f.move(e);try{c=a?this._parseGeometryForDisplay(f):this._parseGeometry(f)}catch(g){return console.error("Failed to parse geometry!",g),null}}return this._cache.geometry=c}return this._cache.geometry}_readAttribute(a,c){const e=this._header.fields.get(a);if(null!=e){var f=this._readAttributeAtIndex(e.index);"esriFieldTypeTimestampOffset"===this.fields.get(a)?.type&&(f=this.parseTimestampOffset(f));a=this._header.fields.isDateField(e.name);return c&&null!=f?a?new Date(f):
f:f}}_readAttributes(){const a={};for(const c of this._header.fields.fields)a[c.name]=this._readAttributeAtIndex(c.index);return a}copyInto(a){super.copyInto(a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext}_readAttributeAtIndex(a){const c=this._reader;c.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]);return N(c)}_readGeometryDeltaDecoded(a=!1){if(void 0===this._cache.unquantGeometry){a=this._readGeometry(a);if(!a)return this._cache.unquantGeometry=
void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=a;var c=E(a.coords.length).decoded;a=a.clone(c);c=a.coords;let e=0;for(const f of a.lengths){for(let g=1;g<f;g++){const d=2*(e+g),b=2*(e+g-1);c[d]+=c[b];c[d+1]+=c[b+1]}e+=f}return this._cache.unquantGeometry=a}return this._cache.unquantGeometry}_parseGeometry(a){a=a.asUnsafe();var c=a.getLength();c=a.pos()+c;const e=[],f=[];for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:var g=a.getUInt32();for(g=a.pos()+g;a.pos()<g;)f.push(a.getUInt32());
break;case 3:g=a.getUInt32();g=a.pos()+g;e.push(a.getSInt64());e.push(a.getSInt64());this.hasZ&&a.getSInt64();for(this.hasM&&a.getSInt64();a.pos()<g;)e.push(a.getSInt64()),e.push(a.getSInt64()),this.hasZ&&a.getSInt64(),this.hasM&&a.getSInt64();break;default:a.skip()}return new x(f,e)}_parseGeometryForDisplay(a){a=a.asUnsafe();var c=a.getLength();c=a.pos()+c;const e=[],f=[];let g=0,d=0;var b=null;let y=0;const O="esriGeometryPolygon"===this.geometryType;for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:b=
a.getUInt32();for(b=a.pos()+b;a.pos()<b;){var z=a.getUInt32();e.push(z);g+=z}b=E(2*g).delta;break;case 3:a.getUInt32();z=2+(this.hasZ?1:0)+(this.hasM?1:0);J.assertIsSome(b);for(const u of e)if(d+z*u>b.length)for(var p=0;p<u;p++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(O){p=this.getAreaSimplificationThreshold(u,this._header.vertexCount);var r=2,n=1,m=a.getSInt32(),k=a.getSInt32();b[d++]=m;b[d++]=k;this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();var h=
a.getSInt32(),l=a.getSInt32();this.hasZ&&a.getSInt32();for(this.hasM&&a.getSInt32();r<u;){var t=a.getSInt32();let C=a.getSInt32();this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();const v=m+h,w=k+l,F=v+t,G=w+C;.5*Math.abs(m*w+v*G+F*k-m*G-v*k-F*w)>=p?(y+=-.5*(v-m)*(w+k),1<n&&A(b[d-2],b[d-1],h,l)?(b[d-2]+=h,b[d-1]+=l):(b[d++]=h,b[d++]=l,n++),m=v,k=w):(t+=h,C+=l);h=t;l=C;r++}3>n?d-=2*n:(y+=-.5*(m+h-m)*(k+l+k),A(b[d-2],b[d-1],h,l)?(b[d-2]+=h,b[d-1]+=l,f.push(n)):(b[d++]=h,b[d++]=l,f.push(++n)))}else{p=
0;r=a.getSInt32();n=a.getSInt32();this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();b[d++]=r;b[d++]=n;p+=1;for(m=1;m<u;m++)k=a.getSInt32(),h=a.getSInt32(),l=r+k,t=n+h,y+=-.5*(l-r)*(t+n),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),2<m&&A(b[d-2],b[d-1],k,h)?(b[d-2]+=k,b[d-1]+=h):(b[d++]=k,b[d++]=h,p+=1),r=l,n=t;f.push(p)}break;default:a.skip()}this._cache.area=y;return f.length?new x(f,b):null}}D.FeatureSetReaderPBF=B;Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});