// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../../core/Evented ../../../../../core/has ../../../../../chunks/rbush ../../../../../geometry/support/aaBoundingRect ../../../../../geometry/support/spatialReferenceUtils ./Tile ../../../tiling/TileCoverage ../../../tiling/TileKey".split(" "),function(n,p,q,g,r,m,t,u){const f={added:[],removed:[]},l=new Set,v=new u(0,0,0,0);class w extends n{constructor(a){super();this._tiles=new Map;this._index=q.rbush(9,p("esri-csp-restrictions")?b=>({minX:b.bounds[0],minY:b.bounds[1],maxX:b.bounds[2],
maxY:b.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);this.tiles=[];this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0;this._tiles.clear();this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}getIntersectingTiles(a){if(!a||0===g.width(a)||0===g.height(a))return[];var b;if(b=r.getInfo(this.tileScheme.spatialReference)){var [c,d]=b.valid;b=a[2]>d?[g.create([a[0],a[1],d,a[3]]),g.create([c,a[1],c+a[2]-d,a[3]])]:a[0]<c?[g.create([c,
a[1],a[2],a[3]]),g.create([d-(c-a[0]),a[1],d,a[3]])]:null}else b=null;return null!=b?[...(new Set([...this.boundsIntersections(b[0]),...this.boundsIntersections(b[1])]))]:this.boundsIntersections(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const b={added:[],removed:[]};for(const c of a.added)if(!this.has(c)){const d=new m.Tile(this.tileScheme,c);this._tiles.set(c,d);this._index.insert(d);b.added.push(d)}for(const c of a.removed)this.has(c)&&
(a=this.get(c),this._tiles.delete(c),this._index.remove(a),b.removed.push(a));this.tiles.length=0;this._tiles.forEach(c=>this.tiles.push(c));(b.added.length||b.removed.length)&&this.emit("update",b)}setViewState(a){if(a=this.tileScheme.getTileCoverage(a,0)){var {spans:b,lodInfo:c}=a,{level:d}=c;if(0<b.length)for(const {row:x,colFrom:y,colTo:z}of b)for(var e=y;e<=z;e++){const h=v.set(d,x,c.normalizeCol(e),c.getWorldForColumn(e)).id;l.add(h);if(!this.has(h)){const k=new m.Tile(this.tileScheme,h);this._tiles.set(h,
k);this._index.insert(k);this.tiles.push(k);f.added.push(k)}}for(d=this.tiles.length-1;0<=d;d--)e=this.tiles[d],l.has(e.id)||(this._tiles.delete(e.id),this.tiles.splice(d,1),this._index.remove(e),f.removed.push(e));(f.added.length||f.removed.length)&&this.emit("update",f);t.pool.release(a);l.clear();f.added.length=0;f.removed.length=0}}}return w});