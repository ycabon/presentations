// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../core/screenUtils ../../../../chunks/rbush ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/boundsUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/spatialReferenceUtils ../../../../symbols/cim/CIMSymbolDrawHelper ../../../../symbols/cim/CIMSymbolHelper ./GraphicStoreItem ./graphicsUtils ./GraphicUpdateMessage".split(" "),function(r,u,p,v,w,x,y,t,z,q,A){function B(a,c){const b=q.graphicGeometryToNumber(a.geometry),d=q.graphicGeometryToNumber(c.geometry);
return b===d?c.zOrder-a.zOrder:b-d}class C{constructor(a,c,b,d,e){this._items=new Map;this._outSpatialReference=a;this._cimResourceManager=c;this._hittestDrawHelper=new y.HittestDrawHelper(c);this._tileInfoView=b;this._store=e;a=b.getClosestInfoForScale(d);this._resolution=this._tileInfoView.getTileResolution(a.level)}items(){return this._items.values()}getItem(a){return this._items.get(a)}async update(a,c,b){const d=[],e=[],f=[],g=new Set,l=[];let k=0;this._store.incrementDisplayIdGeneration();for(const h of a.items){k++;
var m=h.uid;const n=this._items.get(m);a=c(h);g.add(m);n?n.update(h,a,k)&&(e.push(n),l.push(this._updateItem(n,b))):(m=this._store.createDisplayIdForObjectId(m),a=z.GraphicStoreItem.fromGraphic(h,a,k,m),l.push(this._updateItem(a,b)),this._items.set(a.objectId,a),d.push(a))}for(const [h,n]of this._items.entries())g.has(h)||(this._store.releaseDisplayIdForObjectId(h),this._items.delete(h),f.push(n));await Promise.all(l);this._index=null;return new A.GraphicUpdateMessage(d,e,f)}updateLevel(a){this._resolution!==
a&&(this._index=null,this._resolution=a)}hitTest(a,c,b,d,e){a=w.normalizeMapX(a,this._tileInfoView.spatialReference);var f=.5*d*window.devicePixelRatio*b;const g=p.create();g[0]=a-f;g[1]=c-f;g[2]=a+f;g[3]=c+f;b=.5*d*(b+q.pixelBuffer);c=this._searchIndex(a-b,c-b,a+b,c+b);if(!c||0===c.length)return[];a=[];b=p.create();f=p.create();for(var l of c){if(!l.visible)continue;const {projectedGeometry:k,symbolResource:m}=l;this._getSymbolBounds(b,m,k,f,e);f[3]=f[2]=f[1]=f[0]=0;p.intersects(b,g)&&a.push(l)}if(0===
a.length)return[];l=this._hittestDrawHelper;c=[];for(const k of a){const {projectedGeometry:m,symbolResource:h}=k;if(!h)continue;const {textInfo:n,symbolInfo:D}=h;l.hitTest(g,D.cimSymbol.symbol,m,n,e,d)&&c.push(k)}c.sort(B);return c.map(k=>k.objectId)}queryItems(a){return 0===this._items.size?[]:this._searchForItems(a)}clear(){this._items.clear();this._index=null}async _updateItem(a,c){await a.projectAndNormalize(this._outSpatialReference);await c(a);this._getSymbolBounds(a.bounds,a.symbolResource,
a.projectedGeometry,a.size,0)}_searchIndex(a,c,b,d){this._index||(this._index=u.rbush(9,e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})),this._index.load(Array.from(this._items.values())));return this._index.search({minX:a,minY:c,maxX:b,maxY:d})}_searchForItems(a){var c=this._tileInfoView.spatialReference,b=a.bounds,d=x.getInfo(c);if(d&&c.isWrappable){const [e,f]=d.valid;c=1E-5>Math.abs(b[2]-f);d=1E-5>Math.abs(b[0]-e);if(!(c&&d||!c&&!d))return a=a.resolution,a=c?p.create([e,
b[1],e+a*q.pixelBuffer,b[3]]):p.create([f-a*q.pixelBuffer,b[1],f,b[3]]),b=this._searchIndex(b[0],b[1],b[2],b[3]),a=this._searchIndex(a[0],a[1],a[2],a[3]),[...(new Set([...b,...a]))]}return this._searchIndex(b[0],b[1],b[2],b[3])}_getSymbolBounds(a,c,b,d,e){if(!c||!c.symbolInfo.linearCIM||!b)return null;a||=p.create();v.getBoundsXY(a,b);if(!d||0===d[0]&&0===d[1]&&0===d[2]&&0===d[3]){const {textInfo:f,symbolInfo:g}=c;c=g.cimSymbol;d||=[0,0,0,0];e=t.CIMSymbolInflatedSizeHelper.getSymbolInflateSize(d,
c.symbol,this._cimResourceManager,e,f);d[0]=r.pt2px(e[0]);d[1]=r.pt2px(e[1]);d[2]=r.pt2px(e[2]);d[3]=r.pt2px(e[3])}e=this._resolution;d=t.CIMSymbolInflatedSizeHelper.safeSize(d);a[0]-=d*e;a[1]-=d*e;a[2]+=d*e;a[3]+=d*e;return a}}return C});