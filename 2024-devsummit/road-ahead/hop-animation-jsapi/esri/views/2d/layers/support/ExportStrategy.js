// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(k,h,G,n,l,H,I,A,y,B,C,z,D,E,F){const q=y.create(),p=[0,0],v=new F(0,0,0,0);h=class extends h{constructor(f){super(f);this._imagePromise=null;this.bitmaps=[];this.hidpi=!1;this.imageMaxHeight=this.imageMaxWidth=2048;this.imageNormalizationSupported=this.imageRotationSupported=!1;this.update=n.debounce(async(b,c)=>{n.throwIfAborted(c);if(b.stationary&&!this.destroyed){var a=b.state,d=B.getInfo(a.spatialReference);b=this.hidpi?b.pixelRatio:1;var e=this.imageNormalizationSupported&&a.worldScreenWidth&&
a.worldScreenWidth<a.size[0],g=this.imageMaxWidth??0,t=this.imageMaxHeight??0;e?(p[0]=a.worldScreenWidth,p[1]=a.size[1]):this.imageRotationSupported?(p[0]=a.size[0],p[1]=a.size[1]):z.getOuterSize(p,a);d=d&&(a.extent.xmin<d.valid[0]||a.extent.xmax>d.valid[1]);var u=!this.imageNormalizationSupported&&d,w=!(Math.floor(p[0]*b)>g||Math.floor(p[1]*b)>t)&&!u,x=this.imageRotationSupported?a.rotation:0;d=this.container.children.slice();w?(e=e?a.paddedViewState.center:a.center,this._imagePromise&&console.error("Image promise was not defined!"),
this._imagePromise=this._singleExport(a,p,e,a.resolution,x,b,c)):(e=Math.min(g,t),u&&(e=Math.min(a.worldScreenWidth,e)),this._imagePromise=this._tiledExport(a,e,b,c));try{const r=await this._imagePromise??[];n.throwIfAborted(c);c=[];this._imagePromise=null;if(!this.destroyed){this.bitmaps=r;for(const m of d)r.includes(m)||c.push(m.fadeOut().then(()=>{m.remove();m.destroy()}));for(const m of r)c.push(m.fadeIn());await Promise.all(c)}}catch(r){this._imagePromise=null,n.throwIfAbortError(r)}}},5E3);
this.updateExports=n.debounce(async b=>{const c=[];for(const a of this.container.children){if(!a.visible||!a.stage)return;c.push(b(a).then(()=>{a.invalidateTexture();a.requestRender()}))}this._imagePromise=n.eachAlways(c).then(()=>this._imagePromise=null);await this._imagePromise})}destroy(){this.bitmaps.forEach(f=>f.destroy());this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(f,b,c,a,d,e){c=await this.fetchSource(f,Math.floor(b*d),Math.floor(c*d),{rotation:a,
pixelRatio:d,signal:e});n.throwIfAborted(e);const g=new D.Bitmap(null,!0);g.x=f.xmin;g.y=f.ymax;g.resolution=f.width/b;g.rotation=a;g.pixelRatio=d;g.opacity=0;this.container.addChild(g);await g.setSourceAsync(c,e);n.throwIfAborted(e);return g}async _singleExport(f,b,c,a,d,e,g){z.getBBox(q,c,a,b);f=y.toExtent(q,f.spatialReference);return[await this._export(f,b[0],b[1],d,e,g)]}_tiledExport(f,b,c,a){var d=C.create({size:b,spatialReference:f.spatialReference,scales:[f.scale]});const e=new E(d);d=e.getTileCoverage(f);
if(!d)return null;const g=[];d.forEach((t,u,w,x)=>{v.set(t,u,w,0);e.getTileBounds(q,v);const r=y.toExtent(q,f.spatialReference);g.push(this._export(r,b,b,0,c,a).then(m=>{0!==x&&(v.set(t,u,w,x),e.getTileBounds(q,v),m.x=q[0],m.y=q[3]);return m}))});return Promise.all(g)}};k.__decorate([l.property()],h.prototype,"_imagePromise",void 0);k.__decorate([l.property()],h.prototype,"bitmaps",void 0);k.__decorate([l.property()],h.prototype,"container",void 0);k.__decorate([l.property()],h.prototype,"fetchSource",
void 0);k.__decorate([l.property()],h.prototype,"hidpi",void 0);k.__decorate([l.property()],h.prototype,"imageMaxWidth",void 0);k.__decorate([l.property()],h.prototype,"imageMaxHeight",void 0);k.__decorate([l.property()],h.prototype,"imageRotationSupported",void 0);k.__decorate([l.property()],h.prototype,"imageNormalizationSupported",void 0);k.__decorate([l.property()],h.prototype,"requestUpdate",void 0);k.__decorate([l.property()],h.prototype,"updating",null);return h=k.__decorate([A.subclass("esri.views.2d.layers.support.ExportStrategy")],
h)});