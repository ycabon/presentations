// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../analysis/LengthDimension ../../../../core/Accessor ../../../../core/Handles ../../../../core/handleUtils ../../../../core/lang ../../../../core/maybe ../../../../core/memoize ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/support/UpdatingHandles ../../../../layers/graphics/hydratedFeatures ./lengthDimensionConstraintUtils ./lengthDimensionManipulatorUtils ./lengthDimensionUtils ./settings ../images/Factory ../../interactive/SnappingVisualizer3D ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/VerticesVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/ImageMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/coordinateHelper ../../../interactive/editGeometry/EditGeometry ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/snapping/SceneSnappingManagerPool ../../../interactive/snapping/SnappingContext ../../../interactive/snapping/SnappingDragPipelineStep ../../../interactive/snapping/SnappingOperation ../../../interactive/snapping/snappingUtils ../../../../geometry/Point".split(" "),
function(k,l,F,ka,t,M,N,O,P,G,Q,R,H,f,m,la,ma,S,I,T,C,u,h,A,z,U,V,W,X,x,Y,J,Z,aa,ba,ca,da,ea,fa,ha,ia,D){k.LengthDimensionSubTool=class extends N{constructor(a){super(a);this._stagedDimension=null;this._computationManipulators=new Map;this._computationHandles=new O;this._orientationManipulatorTexture=null;this._updatingHandles=new T.UpdatingHandles;this._getSnappingContext=R.memoize(c=>new ea.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:c,editGeometryOperations:new ca.EditGeometryOperations(new ba.EditGeometry("point",
aa.createCoordinateHelper(!0,!1,this.view.spatialReference))),visualizer:new V.SnappingVisualizer3D}));const {view:b}=a;this._snappingManagerResult=da.acquire(b);this.addHandles(this._snappingManagerResult);this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial();this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial();this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial();this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:J.createStipplePatternSimple(2)});
this._constraintSnappingIndicator=new W.LineVisualElement({view:b,attached:!0,width:1,renderOccluded:x.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:J.createStipplePatternSimple(5),isDecoration:!0});const d=F.toUnitRGBA(z.disabledPointColor);this._stagedStartIndicator=new X.VerticesVisualElement({view:b,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:a.view.renderCoordsHelper.spatialReference,color:d,size:2*z.pointRadius,outlineSize:0,renderOccluded:x.RenderOccludedFlag.OccludeAndTransparent,
isDecoration:!0})}initialize(){const {view:a}=this;this._snappingOperation=new ha.SnappingOperation({view:a});const b=!a._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._orientationManipulatorMaterial=new Y.ImageMaterial({transparent:!0,writeDepth:!1,renderOccluded:x.RenderOccludedFlag.Opaque,isDecoration:!0});this.addHandles(f.watch(()=>({accentColor:z.getTransparentAccentColor(a.effectiveTheme),contrastColor:z.getContrastColor(a.effectiveTheme)}),({accentColor:c,
contrastColor:e})=>{const g=this._orientationManipulatorTexture;e=U.getRotateHeadingTexture(a.textures,{accentColor:c,contrastColor:e,preMultiplyAlpha:b});this._orientationManipulatorMaterial.setParameters({textureId:e.texture.id});this._orientationManipulatorTexture=e;g?.release();c=F.toUnitRGBA(c);this._unfocusedOffsetManipulatorMaterial.setParameters({color:c});this._focusedOffsetManipulatorMaterial.setParameters({color:c});this._thinOffsetManipulatorMaterial.setParameters({color:c});this._constraintSnappingIndicator.color=
c},f.initial));const d=f.mapCollection(()=>this.analysisViewData.computations,({computation:c})=>this._createManipulators(c));this.addHandles(P.destroyHandle(d));this.addHandles([f.watch(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:c,stagedComputation:e})=>{null!=e&&null!=c&&(c=C.clonePoint(c,new D),this._applyPointUpdate(e,{endPoint:c}))},f.sync),f.watch(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,
firstGrabbedManipulator:this.firstGrabbedManipulator}),(c,e)=>{const {stagedDimension:g,selectedComputation:v,firstGrabbedManipulator:w}=c;if(g!==e?.stagedDimension||w!==e?.firstGrabbedManipulator)for(const [p,n]of this._computationManipulators)this._updateManipulators(p,n,c);else for(const p of[v,e?.selectedComputation])null!=p&&(e=this._computationManipulators.get(p),null!=e&&this._updateManipulators(p,e,c))},f.syncAndInitial),f.watch(()=>this.analysis.style.lineSize,c=>{this._updateManipulatorStyle(c)},
f.initial),f.watch(()=>this.view.state.camera,()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)}),f.watch(()=>{var c=this._stagedComputation;if(!c)return null;c=c.elevationAlignedStartPoint;const e=I.create();return null!=c&&this.view.renderCoordsHelper.toRenderCoords(c,e)?e:null},c=>{null!=c?(this._stagedStartIndicator.vertices=[c],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]);this.addHandles(this._constraintHandles);
this.addHandles(this._snappingIndicatorHandles);ia.setupSnappingToggleHandles(this,()=>{const c=this._activeComputation;var e=this._stagedComputation;if(null==c||null!=e)e=this._getSnappingContext(this.view.inputManager.latestPointerType??"mouse"),this._updatingHandles.addPromise(H.ignoreAbortErrors(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,e)));if(null!=c){const {start:g,end:v}=this._computationManipulators.get(c);if(g.grabbing||v.grabbing){e=g.grabbing?"start":
"end";const w=this._computeConstraint(c);u.reapplyConstraint(c,e,{constraint:w,view:this.view})}}})}destroy(){this._snappingOperation=Q.destroyMaybe(this._snappingOperation);this._computationHandles.destroy();this._constraintSnappingIndicator.destroy();this._stagedStartIndicator.destroy();this._orientationManipulatorTexture?.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(null!=
this._stagedComputation)return this._stagedComputation;const {selectedComputation:a}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=a?a:null}get _stagedComputation(){const a=this._stagedDimension,b=this.analysisViewData.computations.at(-1)?.computation;return null==a||null==b||b.dimension!==a?null:b}get _constraintHandles(){return[f.when(()=>this.analysisViewData.selectedComputation,a=>{a.previousConstraint=this._computeConstraint(a)},{...f.syncAndInitial,equals:G.equals}),f.watch(()=>
{const a=this._activeComputation;if(null==a)return null;const {measureType:b,orientation:d}=a.dimension;return{measureType:b,orientation:d,computation:a}},(a,b)=>{if(null!=a&&null==b){const {measureType:d,orientation:c,computation:e}=a;switch(e.previousConstraint){case u.LengthDimensionConstraint.Horizontal:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Horizontal,orientation:0};break;case u.LengthDimensionConstraint.Vertical:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Vertical,
orientation:0};break;case u.LengthDimensionConstraint.Direct:e.preConstraintProperties={measureType:t.LengthDimensionMeasureType.Direct,orientation:c};break;default:e.preConstraintProperties={measureType:d,orientation:c}}}null==a&&null!=b&&(b.computation.preConstraintProperties=null)},f.sync)]}get _snappingIndicatorHandles(){return[f.watch(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:a,activeComputation:b})=>{const d=this._constraintSnappingIndicator;
this.removeHandles("snapping-indicator-event-handles");if(null==b)d.attached=!1;else if(b===a)d.attached=!0;else{const {start:c,end:e}=this._computationManipulators.get(b);a=()=>{d.attached=c.grabbing||e.grabbing};a();this.addHandles([c.events.on("grab-changed",a),e.events.on("grab-changed",a)],"snapping-indicator-event-handles")}}),f.watch(()=>{const a=this._activeComputation;return null!=a?{geometry:a.geometry,constraint:a.previousConstraint}:{}},({geometry:a,constraint:b})=>{const d=this._constraintSnappingIndicator;
null!=a&&null!=b&&b!==u.LengthDimensionConstraint.Direct?(d.visible=!0,d.setGeometryFromSegment(a.directSegment)):d.visible=!1})]}removeStaged(){return null!=this._stagedDimension?(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0):!1}onDeactivate(){this.removeStaged();this._resetSnappingState()}onClick(a){const {_stagedDimension:b}=this;if(null==b)return a=this._onUnstagedClick(a),this.analysis.dimensions.add(a),null;this._onStagedClick(a);return b}onPointerMove({mapPoint:a,
pointerType:b}){"touch"!==b&&(b=this._getSnappingContext(b),this._updatingHandles.addPromise(H.ignoreAbortErrors(this._snappingOperation.snap({point:a},this._snappingManager,b))))}onManipulatorSelectionChanged(){null==this.analysisViewData.selectedComputation||this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null)}_onUnstagedClick({mapPoint:a,pointerType:b}){let d=a;"mouse"===b&&(b=this._getSnappingContext(b),d=
this._snappingManager.update({point:a,context:b}));this._stagedDimension=a=new M({startPoint:C.clonePoint(d,new D),endPoint:null,measureType:t.LengthDimensionMeasureType.Horizontal});this._resetSnappingState();return a}_onStagedClick({mapPoint:a,pointerType:b}){const d=this._stagedComputation;if(null!=d){var c=a;"mouse"===b&&(b=this._getSnappingContext(b),c=this._snappingManager.update({point:a,context:b}));a=C.clonePoint(c,new D);this._applyPointUpdate(d,{endPoint:a});this._stagedDimension=null;
this._resetSnappingState()}}_resetSnappingState(){this._snappingManager.doneSnapping();this._snappingOperation.abort();this._snappingOperation.stagedPoint=null}_createManipulators(a){const b=this._setupPointManipulator(a,{isStart:!0}),d=this._setupPointManipulator(a,{isStart:!1}),c=this._setupOffsetManipulator(a),e=this._setupHeadingManipulator(a),g=this._setupRotationManipulator(a),v=this._setupMeasureTypeManipulator(a,t.LengthDimensionMeasureType.Direct),w=this._setupMeasureTypeManipulator(a,t.LengthDimensionMeasureType.Horizontal),
p=this._setupMeasureTypeManipulator(a,t.LengthDimensionMeasureType.Vertical),n=new h.LengthDimensionManipulators({start:b,end:d,offset:c,heading:e,rotation:g,direct:v,horizontal:w,vertical:p});this._setupComputationToManipulatorsSync(a,n);this._computationManipulators.set(a,n);this.manipulators.addMany(n.values());return{manipulators:n,remove:()=>{this._computationHandles.remove(a);this._computationManipulators.delete(a);for(const y of n.values())this.manipulators.remove(y)}}}_setupComputationToManipulatorsSync(a,
b){this._computationHandles.add([f.watch(()=>a.geometry,()=>this._updateManipulators(a,b),{...f.syncAndInitial,equals:G.equals})],a)}_setupPointManipulator(a,b){const {view:d}=this,{dimension:c}=a,e=new h.LengthDimensionPointManipulator(d,{metadata:c});b=h.pointManipulatorHandles(e,{isStart:b.isStart,createSnappingPipelineStep:g=>fa.createSnapDragEventPipelineStep({snappingContext:this._getSnappingContext(g),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:c,
onUpdate:g=>this._applyPointUpdate(a,g),view:d});this._computationHandles.add(b,a);return e}_setupOffsetManipulator(a){var {view:b}=this;const d=h.createOffsetManipulator(b,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:a.dimension});b=h.offsetManipulatorHandles(d,{computation:a,view:b});this._computationHandles.add(b,a);return d}_setupHeadingManipulator(a){var {view:b}=this;const d=
new h.LineOfSightOrientationManipulator(b,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=h.headingManipulatorHandles(d,{computation:a,view:b});this._computationHandles.add(b,a);return d}_setupRotationManipulator(a){var {view:b}=this;const d=new h.LineOfSightOrientationManipulator(b,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=h.rotationManipulatorHandles(d,{computation:a,
view:b});this._computationHandles.add(b,a);return d}_setupMeasureTypeManipulator(a,b){const {view:d}=this,c=h.createMeasureTypeManipulator(d,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:a.dimension});b=h.measureTypeManipulatorHandles(c,{computation:a,manipulatorMeasureType:b,view:d});this._computationHandles.add(b,
a);return c}_updateManipulators(a,b,d={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const {stagedDimension:c,selectedComputation:e,firstGrabbedManipulator:g}=d,{start:v,end:w,offset:p,heading:n,rotation:y}=b;d=e===a;const K=A.isValidComputation(a),{dimension:E}=a;for(var q of b.values()){const r=K&&null==c&&(null==g||q===g);q===p?(q.available=r,q.selected=d):q.available=r&&d}if(K){null!=this._computeConstraint(a)?
b.forEachMeasureTypeManipulator(r=>r.available=!1):b.manipulatorForMeasureType(E.measureType).available=!1;for(const r of[n,y])if(E.measureType!==t.LengthDimensionMeasureType.Direct||0===E.offset)r.available=!1;A.arePointsVerticallyAligned(a)?y.available=!1:n.available=!1;({geometry:q}=a);v.renderLocation=q.directSegment.startRenderSpace;w.renderLocation=q.directSegment.endRenderSpace;var {renderCoordsHelper:B}=this.view;h.updateOffsetManipulatorTransform(p,q,B);n.available&&h.updateHeadingManipulatorTransform(n,
a,B);y.available&&h.updateRotationManipulatorTransform(y,a,B);b.forEachMeasureTypeManipulator((r,ja)=>{r.available&&h.updateMeasureTypeManipulatorTransform(r,a,ja,B)})}}_updateManipulatorStyle(a){const b=h.unfocusedOffsetWidth(a),d=h.focusedOffsetWidth(a);a={lineSizePt:a,material:this._orientationManipulatorMaterial};for(const {offset:c,heading:e,rotation:g}of this._computationManipulators.values())c.radius=d/2,e.update(a),g.update(a);this._unfocusedOffsetManipulatorMaterial.setParameters({width:b});
this._focusedOffsetManipulatorMaterial.setParameters({width:d})}_applyPointUpdate(a,b){const {view:d}=this,c=A.computationToGeometryDependencies(a);"startPoint"in b&&(c.elevationAlignedStartPoint=b.startPoint);"endPoint"in b&&(c.elevationAlignedEndPoint=b.endPoint);const e=A.computeGeometryFromDimension(c,d.renderCoordsHelper);if(null!=e){var g=this._computeConstraint({...c,geometry:e});u.applyConstraint(a,b,{...c,constraint:g,unconstrainedGeometry:e,view:d});a===this._stagedComputation&&this._updateStagedDimensionOffset(a)}}_updateStagedDimensionOffset(a){if(null!=
a.geometry){a.geometry.directSegment.eval(.5,L);var b=this.view.state.camera.computeScreenPixelSizeAt(L);a.dimension.offset=z.initialOffsetPx*b}}_computeConstraint(a){return u.computeConstraint(u.constraintDependencies(a,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new Z.RibbonLineMaterial({width:1,renderOccluded:x.RenderOccludedFlag.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const a=b=>this.analysisViewData.computations.find(({computation:d})=>
d.dimension===b)?.computation;return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=x.RenderOccludedFlag.Occlude;this.manipulators.forEach(({manipulator:b})=>{for(const {geometry:d}of b.renderObjects)d.material.setParameters({renderOccluded:x.RenderOccludedFlag.Occlude})})},getManipulatorsForDimension:b=>this._computationManipulators.get(a(b)),getComputationForDimension:b=>a(b),getConstraintForDimension:b=>{b=a(b);return null!=b?this._computeConstraint(b):null},
stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};l.__decorate([m.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"analysis",void 0);l.__decorate([m.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"analysisViewData",void 0);l.__decorate([m.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"manipulators",void 0);
l.__decorate([m.property({constructOnly:!0})],k.LengthDimensionSubTool.prototype,"parentTool",void 0);l.__decorate([m.property({constructOnly:!0,nonNullable:!0})],k.LengthDimensionSubTool.prototype,"view",void 0);l.__decorate([m.property({readOnly:!0})],k.LengthDimensionSubTool.prototype,"updating",null);l.__decorate([m.property()],k.LengthDimensionSubTool.prototype,"firstGrabbedManipulator",null);l.__decorate([m.property()],k.LengthDimensionSubTool.prototype,"hasGrabbedManipulators",null);l.__decorate([m.property()],
k.LengthDimensionSubTool.prototype,"snappingOptions",null);l.__decorate([m.property()],k.LengthDimensionSubTool.prototype,"_stagedDimension",void 0);l.__decorate([m.property()],k.LengthDimensionSubTool.prototype,"_activeComputation",null);l.__decorate([m.property()],k.LengthDimensionSubTool.prototype,"_stagedComputation",null);k.LengthDimensionSubTool=l.__decorate([S.subclass("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],k.LengthDimensionSubTool);const L=I.create();Object.defineProperty(k,
Symbol.toStringTag,{value:"Module"})});