// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../core/Cyclical ../../../../core/mathUtils ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/plane ../../../../geometry/support/vectorStacks ../../../../layers/graphics/hydratedFeatures ./lengthDimensionUtils ./settings ../../interactive/Manipulator3D ../../interactive/manipulatorUtils ../../interactive/RenderObject ../../interactive/editingTools/dragEventPipeline3D ../../interactive/visualElements/support/Segment ../../support/engineContent/marker ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Material ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/ImageMaterial ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/dragEventPipeline ../../../interactive/interfaces ../../../../geometry/Point".split(" "),
function(m,K,xa,G,L,ea,M,N,O,fa,n,q,ha,A,C,ia,l,u,I,w,z,E,ja,ka,R,la,F,S,T,ma,na,B,x,oa){function U({calloutColor:b,lineSizePt:a,material:c,metadata:d}){return{calloutLength:.25*ka.markerSizePerLineWidth*u.markerLineSizeFraction*N.pt2px(a)+u.orientationCalloutOffsetPx,calloutColor:b,calloutWidth:u.orientationCalloutWidth,customStateMask:D,discScale:u.orientationDiscScale,focusMultiplier:u.orientationFocusMultiplier,material:c,metadata:d}}function V(b){const {cancel:a,computation:c,settingHeading:d,
steps:e,view:f}=b;if(l.isValidComputation(c)){({renderCoordsHelper:b}=f);var {dimension:h,geometry:g}=c,k=q.create(),v=W(q.create(),g,g.directSegment,b);b=X(C.sv3d.get(),{forHeading:d,geometry:g,renderCoordsHelper:b});var r=A.fromPositionAndNormal(v,b,A.create()),p=d?h.orientation??l.headingFromGeometry(g,f.renderCoordsHelper):h.orientation??0;e.next(E.screenToRenderPlane(f,r)).next(t=>{"start"===t.action&&n.copy(k,t.renderStart);const y=A.getNormal(r);t=w.calculateInputRotationTransform(k,t.renderEnd,
v,y);t=p-ea.rad2deg(t);d||(t=Y(t));h.orientation=t});a.next(B.resetProperties(h,["orientation"]))}}function Y(b){const a=L.cyclicalDegrees.normalize(b)%90;return a<u.orientationSnapThresholdDegrees?b-a:90-a<u.orientationSnapThresholdDegrees?b+(90-a):b}function Z(b,a,c,d){var e=n.subtract(C.sv3d.get(),c.endRenderSpace,c.startRenderSpace);n.cross(e,e,d);e=A.fromPositionAndNormal(c.startRenderSpace,e,A.create());const f=A.fromPositionAndNormal(c.startRenderSpace,d,A.create()),h=a.offset;let g=0,k;const v=
new B.EventPipeline;v.next(E.screenToRenderPlane(b,e)).next(r=>{"start"===r.action&&(g=A.signedDistance(f,r.renderStart));const p=(A.signedDistance(f,r.renderEnd)-g)*b.renderCoordsHelper.unitInMeters;a.offset=h+p;k=r});return r=>{v.execute(r);return k}}function aa(b,a){var {directSegment:c}=b;const {renderCoordsHelper:d}=a;var e=l.directUp(C.sv3d.get(),b,d);b=l.directStartToEnd(C.sv3d.get(),b);e=n.cross(C.sv3d.get(),b,e);({viewForward:a}=a.state.camera);0<n.dot(e,a)&&n.scale(e,e,-1);c=c.eval(.5,C.sv3d.get());
return d.headingAtPosition(c,e)}function ba(b,a,c,{forHeading:d}){const {dimension:e,geometry:f}=a;({primaryOffsetAxis:a}=f);a=n.scale(pa,a,0<=e.offset?1:-1);d=X(qa,{forHeading:d,geometry:f,renderCoordsHelper:c});n.cross(d,d,a);d=w.calculateTranslateRotateFromBases(a,d,q.ZEROS,J);b.modelTransform=d;b.renderLocation=W(H,f,f.dimensionSegment,c)}function W(b,a,c,d){const {startRenderSpace:e,endRenderSpace:f}=c;c=l.directStartToEnd(ra,a);a=l.directUp(sa,a,d);a=0<n.dot(c,a);return n.copy(b,a?e:f)}function X(b,
{forHeading:a,geometry:c,renderCoordsHelper:d}){return a?l.directUp(b,c,d):l.dimensionStartToEnd(b,c,{invert:!0})}function P(b){return N.pt2px(b)+u.focusedLinePaddingPx}function ca(b,a){const c=a.material??new ma.ImageMaterial({transparent:!0,writeDepth:!1,textureId:a.texture?.id,renderOccluded:S.RenderOccludedFlag.Opaque,isDecoration:!0}),d=a.focusMultiplier??w.rotateManipulatorDefaults.focusMultiplier,e=a.calloutLength??w.rotateManipulatorDefaults.calloutLength,f=w.rotateManipulatorDefaults.discRadius*
(a.discScale??1),h=f*d,g=(p,t)=>{const y=[0,1,2,2,3,0];return new la.Geometry(t,[[T.VertexAttribute.POSITION,new R.Attribute([e-p,-p,0,e+p,-p,0,e+p,p,0,e-p,p,0],y,3,!0)],[T.VertexAttribute.UV0,new R.Attribute([0,0,1,0,1,1,0,1],y,2,!0)]])};var k=new na.RibbonLineMaterial({width:a.calloutWidth??w.rotateManipulatorDefaults.calloutWidth,color:a.calloutColor,renderOccluded:S.RenderOccludedFlag.OccludeAndTransparent,isDecoration:!0});const v=F.createPolylineGeometry(k,[[0,0,0],[e-f,0,0]]);k=F.createPolylineGeometry(k,
[[0,0,0],[e-h,0,0]]);const r=a.customStateMask??x.ManipulatorStateCustomFlags.None;b.collisionType={type:"disc",direction:[0,0,1],offset:[e,0,0]};b.focusMultiplier=d;b.metadata=a.metadata;b.radius=f;b.renderObjects=[new z.RenderObject(g(f,c),x.ManipulatorStateFlags.Unfocused|r),new z.RenderObject(v,x.ManipulatorStateFlags.Unfocused|r),new z.RenderObject(g(h,c),x.ManipulatorStateFlags.Focused|r),new z.RenderObject(k,x.ManipulatorStateFlags.Focused|r)]}class ta{constructor(b){this.start=b.start;this.end=
b.end;this.offset=b.offset;this.heading=b.heading;this.rotation=b.rotation;this.direct=b.direct;this.horizontal=b.horizontal;this.vertical=b.vertical}manipulatorName(b){return Object.keys(this).find(a=>this.hasOwnProperty(a)&&b===this[a])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(b){for(const a of G.lengthDimensionMeasureType)b(this.manipulatorForMeasureType(a),a)}manipulatorForMeasureType(b){switch(b){case G.LengthDimensionMeasureType.Direct:return this.direct;
case G.LengthDimensionMeasureType.Horizontal:return this.horizontal;case G.LengthDimensionMeasureType.Vertical:return this.vertical}}}class ua extends I.Manipulator3D{constructor(b,a){const c=w.createManipulatorMaterial(K.toUnitRGBA(u.getTransparentAccentColor(b.effectiveTheme))),d=[new z.RenderObject(F.createSphereGeometry(c,1,32,32),D)];super({view:b,renderObjects:d,metadata:a.metadata,available:!1,grabCursor:"crosshair",radius:u.pointRadius,collisionPriority:1});this._themeHandle=M.watch(()=>({color:K.toUnitRGBA(u.getTransparentAccentColor(b.effectiveTheme))}),
e=>c.setParameters(e))}destroy(){this._themeHandle.remove();super.destroy()}}class va extends I.Manipulator3D{constructor(b,{lineSizePt:a,material:c,metadata:d}){super({view:b,autoScaleRenderObjects:!1,collisionPriority:1,metadata:d});this._options={calloutColor:ha.create(),lineSizePt:a,material:c};this._themeHandle=M.watch(()=>K.toUnitRGBA(u.getTransparentAccentColor(b.effectiveTheme)),e=>{this._options.calloutColor=e;ca(this,U({...this._options,metadata:this.metadata}))},M.initial)}update({lineSizePt:b,
material:a}){this._options.lineSizePt=b;this._options.material=a;ca(this,U({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove();super.destroy()}}const pa=q.create(),qa=q.create(),ra=q.create(),sa=q.create(),D=x.ManipulatorStateCustomFlags.Custom1,H=q.create(),Q=q.create(),J=fa.create(),da=new ja.EuclideanSegment;m.DidPointerMoveRecentlyFlag=D;m.LengthDimensionManipulators=ta;m.LengthDimensionPointManipulator=ua;m.LineOfSightOrientationManipulator=va;m.automaticHeadingFromCamera=
aa;m.createMeasureTypeManipulator=function(b,a){const c=[q.fromValues(-.5,0,0),q.fromValues(.5,0,0)],d=F.createPolylineGeometry(a.thinOffsetManipulatorMaterial,c),e=F.createPolylineGeometry(a.unfocusedMaterial,c.map(h=>n.scale(q.create(),h,u.lengthFraction))),f=e.instantiate({material:a.focusedMaterial});return new I.Manipulator3D({view:b,renderObjects:[new z.RenderObject(e,x.ManipulatorStateFlags.Unfocused|D),new z.RenderObject(f,x.ManipulatorStateFlags.Focused|D),new z.RenderObject(d,D)],collisionType:{type:"line",
paths:[c]},radius:P(a.lineSizePt)/2,available:!1,metadata:a.metadata,...w.worldScaledManipulatorSettings})};m.createOffsetManipulator=function(b,a){const c=[q.fromValues(-.5,0,0),q.fromValues(.5,0,0)],d=F.createPolylineGeometry(a.unfocusedMaterial,c.map(f=>n.scale(q.create(),f,u.lengthFraction))),e=d.instantiate({material:a.focusedMaterial});return new I.Manipulator3D({view:b,renderObjects:[new z.RenderObject(d,x.ManipulatorStateFlags.Unfocused|x.ManipulatorStateFlags.Selected|D),new z.RenderObject(e,
x.ManipulatorStateFlags.Focused|D)],collisionType:{type:"line",paths:[c]},radius:P(a.lineSizePt)/2,metadata:a.metadata,available:!1,...w.worldScaledManipulatorSettings})};m.focusedOffsetWidth=P;m.headingManipulatorHandles=function(b,{computation:a,view:c}){return[B.createManipulatorDragEventPipeline(b,(d,e,f)=>{V({cancel:f,computation:a,settingHeading:!0,steps:e,view:c})})]};m.measureTypeManipulatorHandles=function(b,{computation:a,manipulatorMeasureType:c,view:d}){let e=G.LengthDimensionMeasureType.Direct,
f=0,h=0;return[b.events.on("grab-changed",g=>{if("start"===g.action&&l.isValidComputation(a)){var {dimension:k,geometry:v}=a;e=k.measureType;f=k.offset;h=k.orientation;g=n.copy(C.sv3d.get(),b.renderLocation);k.measureType=c;k.offset=l.computeOffsetForPoint(g,c,v,d.renderCoordsHelper);k.orientation=0}}),B.createManipulatorDragEventPipeline(b,(g,k,v)=>{if(l.isValidComputation(a)){var {geometry:r,dimension:p}=a,{renderCoordsHelper:t}=d,y=l.computeSegmentForMeasureType(da,c,a,t);t=l.computeOffsetAxis(C.sv3d.get(),
{measureType:c,directSegment:r.directSegment,renderCoordsHelper:t});g=E.hideManipulatorWhileDragging(g);k.next(g).next(Z(d,p,y,t));v.next(g).next(wa=>{p.measureType=e;p.offset=f;p.orientation=h;return wa})}})]};m.offsetManipulatorHandles=function(b,{computation:a,view:c}){return[B.createManipulatorDragEventPipeline(b,(d,e,f)=>{if(l.isValidComputation(a)&&d.selected){var {geometry:h,dimension:g}=a;d=E.hideManipulatorWhileDragging(d);e.next(d).next(Z(c,g,h.dimensionSegment,h.primaryOffsetAxis));f.next(d).next(B.resetProperties(g,
["offset"]))}})]};m.pointManipulatorHandles=function(b,{isStart:a,createSnappingPipelineStep:c,dimension:d,onUpdate:e,view:f}){const h=a?"startPoint":"endPoint";return[B.createManipulatorDragEventPipeline(b,(g,k,v,r)=>{g=E.hideManipulatorWhileDragging(g);const {snappingStep:p,cancelSnapping:t}=c(r);v=v.next(g).next(B.resetProperties(d,[h,"measureType","orientation"])).next(t);k.next(g).next(E.screenToMap3D(f)).next(...p).next(y=>{y=ia.clonePoint(y.mapEnd,new oa);e("startPoint"===h?{startPoint:y}:
{endPoint:y})})})]};m.rotationManipulatorHandles=function(b,{computation:a,view:c}){return[B.createManipulatorDragEventPipeline(b,(d,e,f)=>{V({cancel:f,computation:a,settingHeading:!1,steps:e,view:c})}),b.events.on("immediate-click",d=>{{const {dimension:g,geometry:k}=a;if(90===g.orientation||270===g.orientation)g.orientation=0,d.stopPropagation();else if(null!=k){var {renderCoordsHelper:e}=c,f=l.computeGeometryFromDimension({...l.computationToGeometryDependencies(a),orientation:90},e),h=l.computeGeometryFromDimension({...l.computationToGeometryDependencies(a),
orientation:270},e);null!=f&&null!=h&&(f=l.headingFromGeometry(f,e),e=l.headingFromGeometry(h,e),h=aa(k,c),f=L.cyclicalDegrees.shortestSignedDiff(h,f),e=L.cyclicalDegrees.shortestSignedDiff(h,e),g.orientation=Math.abs(f)<Math.abs(e)?90:270,d.stopPropagation())}}})]};m.snapOrientationToNearestRightAngle=Y;m.unfocusedOffsetWidth=function(b){return N.pt2px(b)+u.linePaddingPx};m.updateHeadingManipulatorTransform=function(b,a,c){ba(b,a,c,{forHeading:!0})};m.updateMeasureTypeManipulatorTransform=function(b,
a,c,d){const {geometry:e}=a;a=l.computeSegmentForMeasureType(da,c,a,d);d=l.computeOffsetAxis(H,{measureType:c,directSegment:e.directSegment,renderCoordsHelper:d});c=n.sub(Q,a.endRenderSpace,a.startRenderSpace);d=w.calculateTranslateRotateFromBases(c,d,q.ZEROS,J);c=n.length(c);O.scale(d,d,n.set(Q,c,c,c));b.modelTransform=d;b.renderLocation=a.eval(.5,Q)};m.updateOffsetManipulatorTransform=function(b,a,c){const {dimensionSegment:d,primaryOffsetAxis:e}=a,f=l.dimensionStartToEnd(H,a);a=n.exactEquals(f,
q.ZEROS)?O.identity(J):w.calculateTranslateRotateFromBases(f,e,q.ZEROS,J);c=Math.max(n.length(f),u.minLengthMeters/c.unitInMeters);O.scale(a,a,n.set(H,c,c,c));b.modelTransform=a;b.renderLocation=d.eval(.5,H)};m.updateRotationManipulatorTransform=function(b,a,c){ba(b,a,c,{forHeading:!1})};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});