// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../layers/graphics/dehydratedPoint ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../../SnappingVisualizer3D ../geometryUtils ../isSupportedGraphicUtils ../manipulatorUtils ../meshFastUpdateUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(l,p,H,I,J,u,v,w,r,ha,ia,ja,K,L,M,x,N,O,P,Q,R,S,T,U,m,V,W,X,B,Y,C,Z,aa,D,ba,ca,da,z,E,ea){class F{constructor(a){this.allGraphics=a;this.type="graphic-move-start"}}class G{constructor(a,b,c){this.dx=a;this.dy=b;this.allGraphics=c;this.type="graphic-move"}}class A{constructor(a){this.allGraphics=a;this.type="graphic-move-stop"}}l.GraphicMoveTool=class extends I.EventedMixin(Z.InteractiveToolBase){constructor(a){super(a);this._infos=new Map;this.graphics=new H;this.enableZ=!0;this.sketchOptions=
new D;this.type="move-3d";this.tooltip=null;this._updatingHandles=new L.UpdatingHandles;this._translateGraphicZTooltipInfo=this._translateGraphicXYTooltipInfo=this._translateGraphicTooltipInfo=this._latestTooltipInfo=this._moveManipulation=null}initialize(){const {view:a}=this;this.addHandles([this.graphics.on("change",c=>{c.removed.forEach(d=>this.removeHandles(d));this._updateGraphicInfos(c);this._setupFastTransformUpdates(c.added);this._refreshManipulators()}),w.watch(()=>this.sketchOptions.tooltips.effectiveEnabled,
c=>{this.tooltip=c?new da.Tooltip({info:this._latestTooltipInfo,view:a}):u.destroyMaybe(this.tooltip)},w.syncAndInitial)]);const b=this.graphics.toArray();this._updateGraphicInfos({added:b,removed:[]});this._setupFastTransformUpdates(b);this._refreshManipulators();this.finishToolCreation()}destroy(){this.tooltip=u.destroyMaybe(this.tooltip);this._moveManipulation=u.destroyMaybe(this._moveManipulation);this._set("view",null);this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}reset(){}_updateGraphicInfos({added:a,
removed:b}){for(const c of a){if(X.isSupportedGraphic(c)!==Q.SupportedGraphicResult.SUPPORTED)continue;a=new fa(c);const d=this.view.trackGraphicState(a.state);this._infos.set(a.graphic,{info:a,handle:d})}for(const c of b)this._infos.get(c)?.handle.remove(),this._infos.delete(c)}_setupFastTransformUpdates(a){for(const b of a)({info:a}=this._infos.get(b)),this.addHandles(S.meshTransformFastUpdateHandles(a.state),b)}_refreshManipulators(){this.removeHandles("manipulators");this._moveManipulation=u.destroyMaybe(this._moveManipulation);
this.manipulators.removeAll();if(0!==this._infos.size){var a=Array.from(this._infos.values(),({info:b})=>b);this._createManipulators(a);this._createVisualElements(a);this._updateMoveManipulation(a)}}_createManipulators(a){for(const b of a){const c=b.state;b.manipulationXY=new W.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:c});b.manipulationXY.forEachManipulator(d=>this.addHandles([d.events.on("immediate-click",e=>{this.emit("immediate-click",{...e,graphic:c.graphic});e.stopPropagation()}),
d.events.on("grab-changed",({action:e})=>{"start"===e?this._showTooltip(m.ManipulationType.XY):this._hideTooltip()})],"manipulators"));this.addHandles(b.manipulationXY.createDragPipeline((d,e,f,k)=>this._buildDragEventPipeline(a,m.ManipulationType.XY,d,e,f,k)),"manipulators")}this._createMoveManipulation(a)}_createMoveManipulation(a){const b=new m.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?m.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):
U.discRadius});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(e=>{this.addHandles(e.events.on("immediate-click",f=>{b.zManipulation.hasManipulator(e)||1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.at(0)});f.stopPropagation()}),"manipulators")});var c=e=>f=>{this.addHandles([f.events.on("focus-changed",({action:k})=>{"focus"===k?this._showTooltip(e):this._hideTooltip()}),f.events.on("grab-changed",()=>{this._latestTooltipInfo&&
(this._latestTooltipInfo.distance=v.zeroMeters)})],"manipulators")};this._moveManipulation.xyManipulation.forEachManipulator(c(m.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(c(m.ManipulationType.XY_AXIS));this._moveManipulation.zManipulation.forEachManipulator(c(m.ManipulationType.Z));c=()=>this._updateMoveManipulation(a);for(const e of a)this.addHandles([e.state.on("changed",c),w.watch(()=>e.state.displaying,c)],"manipulators");const d=a[a.length-1];this.addHandles(d.state.on("changed",
()=>this._updateMoveManipulationAngle(d)),"manipulators");this.addHandles(b.createDragPipeline((e,f,k,h,n)=>this._buildDragEventPipeline(a,e,f,k,h,n),x.getGraphicEffectiveElevationInfo(d.graphic),d.graphic.geometry.spatialReference,d.graphic),"manipulators");this._updateMoveManipulationAngle(d)}_createVisualElements(a){for(const b of a){const c=T.createVisualElements({view:this.view,graphic:b.graphic,forEachManipulator:d=>{b.manipulationXY?.forEachManipulator(d);this._moveManipulation?.forEachManipulator(d)},
onManipulatorsChanged:()=>J.makeHandle()});null!=c&&(b.geometryRepresentation=c.visualElement,b.geometryRepresentation instanceof B.OutlineVisualElement&&this.addHandles([b.geometryRepresentation.events.on("attachment-origin-changed",()=>{b.state.isDraped||this._updateMoveManipulation(a)}),w.watch(()=>b.state.isDraped,()=>this._updateMoveManipulation(a))],"manipulators"),this.addHandles(c,"manipulators"))}}_updateMoveManipulationAngle(a){this._moveManipulation&&(this._moveManipulation.angle=P.orientation(a.graphic.geometry))}_updateMoveManipulation(a){const b=
M.makeDehydratedPoint(0,0,0,this.view.spatialReference);let c=0,d=!1;const e=this._moveManipulation;if(e){for(const f of a)if(f.state.displaying&&(a=f.state.graphic,this.enableZ&&R.canMoveZ(a)&&(d=!0),a=f.geometryRepresentation instanceof B.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:N.getGraphicAttachmentOrigin(this.view,a),null!=a)){const {x:k,y:h,z:n}=a;b.x+=k;b.y+=h;if(n){let t;(t=b).z??(t.z=0);b.z+=n}c++}0<c?(b.x/=c,b.y/=c,b.z??(b.z=0),b.z/=c,e.location=
b,e.xyManipulation.available=!0,e.xyAxisManipulation.available=!0,e.zManipulation.available=d):e.available=!1}}_buildDragEventPipeline(a,b,c,d,e,f){const k=[],h=[];let n=null,t=null;const y=()=>{for(const g of k)g.dragging=!1;k.length=0;h.length=0;t=n=null;this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(1===a.length&&b===m.ManipulationType.XY){const g=a[0].graphic;({steps:d,cancel:e}=this._buildSnappingPipelineSteps(g,x.getGraphicEffectiveElevationInfo(g),d,e,f))}e=e.next(g=>t?.(g)).next(()=>
{this.emit("graphic-move-stop",new A(h));this.destroyed||y();return null});d=d.next(g=>{if("start"===g.action){k.length=0;h.length=0;for(const q of a)q.dragging||!q.manipulationXY?.hasManipulator(c)&&q.manipulationXY?.grabbing||(k.push(q),h.push(q.graphic),q.dragging=!0);if(0!==h.length&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),n=C.dragGraphicMany(h,this.view.state.viewingMode),t=C.resetGraphicMany(h),this.emit("graphic-move-start",new F(h)),this.destroyed))return null}return 0!==
h.length?g:null}).next(g=>n?.(g)).next(g=>{this._updateMoveTooltip(b,g);return g}).next(g=>{switch(g.action){case "start":case "update":if(g.translationX||g.translationY||g.translationZ){const q=this.view.toScreen(g.mapStart);g=this.view.toScreen(g.mapEnd);this.emit("graphic-move",new G(g.x-q.x,g.y-q.y,h))}break;case "end":this.emit("graphic-move-stop",new A(h)),this.destroyed||y()}return null});return{steps:d,cancel:e}}_showTooltip(a){this._updateMoveTooltip(a);this._latestTooltipInfo&&(this._latestTooltipInfo.distance=
v.zeroMeters)}_hideTooltip(){this.tooltip?.clear();this._latestTooltipInfo=null}_updateMoveTooltip(a,b){const {sketchOptions:c,tooltip:d}=this;switch(a){case m.ManipulationType.XY:this._latestTooltipInfo=this._translateGraphicTooltipInfo??(this._translateGraphicTooltipInfo=new z.TranslateGraphicTooltipInfo({sketchOptions:c}));this._updateMoveTooltipDistance(this._latestTooltipInfo,b,(e,f)=>E.autoDistanceBetweenPoints2D(e,f));break;case m.ManipulationType.XY_AXIS:this._latestTooltipInfo=this._translateGraphicXYTooltipInfo??
(this._translateGraphicXYTooltipInfo=new z.TranslateGraphicXYTooltipInfo({sketchOptions:c}));this._updateMoveTooltipDistance(this._latestTooltipInfo,b,(e,f)=>v.scale(E.autoDistanceBetweenPoints2D(e,f),V.axisConstrainedDragSign(b)));break;case m.ManipulationType.Z:this._latestTooltipInfo=this._translateGraphicZTooltipInfo??(this._translateGraphicZTooltipInfo=new z.TranslateGraphicZTooltipInfo({sketchOptions:c})),this._updateMoveTooltipDistance(this._latestTooltipInfo,b,ea.verticalSignedDistanceBetweenPoints)}this._latestTooltipInfo.sketchOptions=
c;d&&(d.info=this._latestTooltipInfo)}_updateMoveTooltipDistance(a,b,c){if(null!=b&&"end"!==b.action){var {mapStart:d,mapEnd:e}=b;b=c(d,e);a.distance=null!=b?b:v.zeroMeters}}_buildSnappingPipelineSteps(a,b,c,d,e){const f=a.geometry;if(null==f||"point"!==f.type&&"mesh"!==f.type)return{steps:c,cancel:d};const k=("point"===f.type?f:f.anchor).clone(),h=new ba.SnappingContext({elevationInfo:b,pointer:e,editGeometryOperations:aa.EditGeometryOperations.fromGeometry(k,this.view.state.viewingMode),visualizer:new O.SnappingVisualizer3D,
excludeFeature:a}),{snappingStep:n,cancelSnapping:t}=ca.createSnapDragEventPipelineStep({snappingContext:h,snappingManager:this.snappingManager,updatingHandles:this._updatingHandles});d=d.next(t);c=c.next(y=>{k.z=x.getConvertedElevation(this.view,k,x.getGraphicEffectiveElevationInfo(a),{mode:"absolute-height",offset:0});const g=h.coordinateHelper.pointToVector(k);return{...y,snapOrigin:g}}).next(...n);return{steps:c,cancel:d}}};p.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,
"view",void 0);p.__decorate([r.property()],l.GraphicMoveTool.prototype,"graphics",void 0);p.__decorate([r.property({constructOnly:!0,nonNullable:!0})],l.GraphicMoveTool.prototype,"enableZ",void 0);p.__decorate([r.property({constructOnly:!0,type:D})],l.GraphicMoveTool.prototype,"sketchOptions",void 0);p.__decorate([r.property({constructOnly:!0})],l.GraphicMoveTool.prototype,"snappingManager",void 0);p.__decorate([r.property()],l.GraphicMoveTool.prototype,"type",void 0);p.__decorate([r.property()],
l.GraphicMoveTool.prototype,"updating",null);p.__decorate([r.property()],l.GraphicMoveTool.prototype,"tooltip",void 0);l.GraphicMoveTool=p.__decorate([K.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],l.GraphicMoveTool);class fa{constructor(a){this.manipulationXY=this.geometryRepresentation=null;this.dragging=!1;this.state=new Y.GraphicState({graphic:a})}get graphic(){return this.state.graphic}}l.GraphicMoveEvent=G;l.GraphicMoveStartEvent=F;l.GraphicMoveStopEvent=
A;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});