// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../chunks/boundedPlane ../../../../../geometry/support/plane ../../../../../geometry/support/vectorStacks ../../../analysis/Slice/ResizeManipulator ../../../analysis/Slice/sliceToolUtils ../dragEventPipeline3D ../ManipulatorType ./extentUtils ../../../support/geometryUtils/ray ../../../../interactive/dragEventPipeline ../../../../interactive/editGeometry/interfaces ../../../../interactive/editGeometry/operations/UpdateVertices ../../../../interactive/editGeometry/support/editPlaneUtils ../../../../interactive/tooltip/ExtentTooltipInfos".split(" "),
function(v,m,w,h,C,x,D,q,E,r,F,G,A,H,I,B,J,K,L){class M{get zMax(){if(!this._zMaxDirty)return this._zMax;var a=this._editGeometryOperations.data;if(a.geometry.hasZ){const c=a.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const b of a.components)for(const d of b.vertices)a=c.getZ(d.pos)??0,this._zMax=Math.max(a,this._zMax)}else this._zMax=0;this._zMaxDirty=!1;return this._zMax}constructor(a,c,b,d,k){this._tool=a;this._graphicState=c;this._editGeometryOperations=b;this._bounds=d;this._preserveAspectRatioStep=
k;this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}];this._scaleTooltipInfo=null;this._displayBoundsStart=x.create();this._displayBoundsMarginStart=0;this._startScale=w.create();this._endScale=w.create();this._sizeStart=null;this._zMax=0;this._zMaxDirty=!0;const g=this._tool,f=g.view;this.resizeManipulators=this._resizeHandles.map(e=>{const l=new E.ResizeManipulator(f,e);g.addHandles([l.events.on("grab-changed",
y=>this._onResizeGrab(y)),this._createResizeDragPipeline(l,e)]);return l});g.manipulators.addMany(this.resizeManipulators);g.addHandles([g.on("graphic-scale-start",e=>{m.set(this._startScale,e.xScale,e.yScale);m.set(this._endScale,e.xScale,e.yScale)}),g.on("graphic-scale",e=>{m.set(this._endScale,e.xScale,e.yScale)}),g.on("graphic-scale-stop",()=>{m.set(this._startScale,0,0);m.set(this._endScale,0,0)}),this._graphicState.on("changed",()=>{"resize"!==g.inputState?.type&&(this._zMaxDirty=!0)})])}destroy(){this.forEachManipulator(a=>
{this._tool.manipulators.remove(a);a.destroy()})}forEachManipulator(a){this.resizeManipulators.forEach(c=>a(c,G.ManipulatorType.SCALE))}updateManipulators(a,c){this.resizeManipulators.forEach((b,d)=>{r.updateResizeHandle(b,this._resizeHandles[d],a,c)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(a=>a.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){var a=this._tool;const c=this._scaleTooltipInfo??(this._scaleTooltipInfo=new L.ExtentScaleTooltipInfo({sketchOptions:a.sketchOptions}));
a=a.graphic.geometry;if(null==a)return null;a=A.mapPlaneAutoSize2D(this._bounds.mapBounds,this.zMax,a.spatialReference);if(null==a)return null;c.xSize=a[0];c.ySize=a[1];null!=this._sizeStart&&this.resizeManipulators.some(b=>b.dragging)?(c.xScale=a[0].value/this._sizeStart[0].value,c.yScale=a[1].value/this._sizeStart[1].value):(c.xScale=1,c.yScale=1);return c}_onResizeGrab({action:a,screenPoint:c}){const b=this._tool,d=this._bounds;"start"===a&&c&&b.graphic.geometry&&(a=H.fromScreenNormalized(b.view.state.camera,
c),D.intersectRay(d.displayBounds.plane,a,q.sv3d.get())&&(d.backupMapBounds(),x.copy(d.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=d.displayBoundsMargin,this._sizeStart=A.mapPlaneAutoSize2D(d.mapBoundsStart,this.zMax,b.graphic.geometry.spatialReference),b.inputState={type:"resize"}))}_createResizeDragPipeline(a,c){const b=this._tool,d=b.graphic;return I.createManipulatorDragEventPipeline(a,(k,g,f)=>{null!=b.inputState&&(g.next(e=>{"start"===e.action&&b.emit("graphic-scale-start",
{graphic:d,xScale:1,yScale:1});return e}).next(F.screenToRenderPlane(b.view,this._displayBoundsStart.plane)).next(e=>({...e,handle:c})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(e=>{const l={graphic:d,xScale:e.factor1,yScale:e.factor2};switch(e.action){case "start":case "update":b.emit("graphic-scale",l);break;case "end":b.inputState=null,b.emit("graphic-scale-stop",l)}return e}),f.next(()=>{null!=b.inputState&&
b.emit("graphic-scale-stop",{graphic:d,xScale:1,yScale:1});b.cancel()}))})}_resizeDragRenderPlaneToFactors(){const a=this._bounds;return c=>{const b=this._displayBoundsStart,d=c.handle.direction,k=a.displayBoundsMargin,g=this._displayBoundsMarginStart;var f=h.copy(q.sv3d.get(),b.origin);h.scaleAndAdd(f,f,b.basis1,-d[0]);h.scaleAndAdd(f,f,b.basis2,-d[1]);const e=h.subtract(q.sv3d.get(),c.renderEnd,f),l=h.subtract(q.sv3d.get(),c.renderStart,f),y=r.isDiagonalResizeHandle(c.handle);f=r.calculateDiagonalResizeHandleScale(b);
const N=r.calculateDiagonalResizeHandleScale(a.displayBounds)/f;f=(n,z)=>{if(0===n)return 1;let p=h.length(z),t=.5*n*h.dot(z,e)/p;const u=0>t?-1:1;y&&(n=p-.5*n*h.dot(z,l)/p,t+=n*u*N);n=p<1.5*g?1:1E-6;p=Math.max(p-g,1E-6);0<u&&(t-=k);return u*Math.max(t/p*u,n)};return{...c,factor1:f(d[0],b.basis1),factor2:f(d[1],b.basis2)}}}_resizeDragUpdateGeometry(){const a=this._tool,c=this._bounds;return b=>{var d=h.copy(C.create(),c.mapBoundsStart.origin);h.scaleAndAdd(d,d,c.mapBoundsStart.basis1,-b.handle.direction[0]);
h.scaleAndAdd(d,d,c.mapBoundsStart.basis2,-b.handle.direction[1]);const k=m.set(w.create(),c.mapBoundsStart.basis1[0],c.mapBoundsStart.basis1[1]);m.normalize(k,k);const g=[];for(const f of this._editGeometryOperations.data.components)g.push(...f.vertices);d=this._editGeometryOperations.scaleVertices(g,d,k,b.factor1,b.factor2,"start"===b.action?B.AccumulationBehavior.NEW_STEP:B.AccumulationBehavior.ACCUMULATE_STEPS,J.AccumulationType.REPLACE);x.copy(c.mapBoundsStart,c.mapBounds);K.apply(d,c.mapBounds);
a.graphic.geometry=this._editGeometryOperations.data.geometry;return b}}}v.ExtentScale=M;v.scaleEpsilon=1E-6;Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});