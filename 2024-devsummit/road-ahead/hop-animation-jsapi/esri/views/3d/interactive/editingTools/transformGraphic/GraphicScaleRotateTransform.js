// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/colorUtils ../../../../../core/Cyclical ../../../../../core/Evented ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../../RenderObject ../dragEventPipeline3D ../ManipulatorType ../manipulations/config ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TransformTooltipInfos".split(" "),
function(x,B,Z,aa,ba,ca,J,U,H,C,da,ea,F,va,wa,xa,fa,G,ha,w,K,L,M,q,ia,ja,ka,y,la,ma,e,na,Q,oa,pa,qa,A,ra,R){function sa(a,b){var c=w.subtract(q.sv3d.get(),b.renderStart,a.origin);a=w.subtract(q.sv3d.get(),b.renderEnd,a.origin);c=w.length(c);a=w.length(a);return 0===c?0:a/c}function ta(a,b,c,d){const {renderStart:k,renderEnd:g}=a;var n=N(k,d,q.sv3d.get());a=N(g,d,q.sv3d.get());if(w.squaredDistance(n,a)<e.dragThresholdPx*e.dragThresholdPx)return null;const l=w.subtract(q.sv3d.get(),k,c);b=w.cross(q.sv3d.get(),
l,L.getNormal(b));b=w.add(q.sv3d.get(),k,b);c=N(c,d,q.sv3d.get());d=N(b,d,q.sv3d.get());b=w.subtract(q.sv3d.get(),d,n);d=w.subtract(q.sv3d.get(),n,c);n=M.wrap(n,b);d=M.wrap(c,d);return M.distance2(n,a)<M.distance2(d,a)?"rotate":"scale"}function N(a,b,c){b.projectToScreen(a,S);return w.set(c,S[0],S[1],0)}function V(a,b){let c=null,d=1;const k=()=>d;return{start:()=>{d=a.getScale();c=a.getScale;a.getScale=k;b()},update:g=>{d+=((d+1)/2-d)*Math.min(g*e.ringResetAnimationSpeedFactor,1);b();return.01>Math.abs(d-
1)?I.STOP:I.CONTINUE},destroy:()=>{c&&(a.getScale=c);b()}}}function ua(a,b,c){let d=0,k=null;const g=()=>!1;return{start:()=>{k=a.getFocused;a.getFocused=g;d=0;b()},update:n=>{d+=n;return!k?.()||d>=c.delayMs?I.STOP:I.CONTINUE},destroy:()=>{k&&(a.getFocused=k);b()}}}function O(a){switch(a){case "integer":case "long":return 0;default:return null}}var h;(function(a){a.ScaleIn=A.ManipulatorStateCustomFlags.Custom2;a.ScaleOut=A.ManipulatorStateCustomFlags.Custom3;a.RotateLeft=A.ManipulatorStateCustomFlags.Custom4;
a.RotateRight=A.ManipulatorStateCustomFlags.Custom5;a.Unlocked=A.ManipulatorStateCustomFlags.Custom7;a.DelayedFocused=A.ManipulatorStateCustomFlags.Custom8;a.TouchInput=A.ManipulatorStateCustomFlags.Custom12})(h||={});x.GraphicScaleRotateTransform=class extends Z{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(a){this._ringManipulator.location=a}set elevationAlignedLocation(a){this._ringManipulator.elevationAlignedLocation=a}get grabbing(){return this._ringManipulator.grabbing}set interactive(a){this._ringManipulator.interactive=
a}get updating(){return!!this._activeAnimation}constructor(a){super(a);this._activeAnimation=this._scaleRotateDragData=this.mode=null;this._ringIndicatorDelayMs=e.ringIndicatorDelayMs;this._rotateTooltipInfo=this._scaleTooltipInfo=this._absoluteTooltipInfo=null;this.events=new ca;this.getFocused=()=>this._ringManipulator.focused;this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this.adapter.scale:1}initialize(){this._tooltip=new ra.Tooltip({view:this.tool.view});this._createManipulator();
this._updateDragState();this._updateManipulatorTransform();this.addHandles([C.when(()=>!this.sketchOptions.tooltips.effectiveEnabled,()=>this._tooltip.clear(),C.initial),C.watch(()=>{const {adapter:a}=this,{info:b}=this._tooltip;return b===this._absoluteTooltipInfo&&this.getFocused()?[b,a.size,a.orientationClockwise]:[null]},([a])=>{a&&this._updateFocusTooltip()})])}destroy(){this._activeAnimation?.frameTask.remove();this._activeAnimation=null;this.tool.manipulators.remove(this._ringManipulator);
this._ringManipulator=null;this._tooltip=U.destroyMaybe(this._tooltip)}startAnimation(a){this.cancelActiveAnimation();a.start();const b=da.addFrameTask({update:({deltaTime:c})=>{a.update(c)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove();this._activeAnimation=U.destroyMaybe(this._activeAnimation)}forEachManipulator(a){a(this._ringManipulator,ma.ManipulatorType.SCALE_ROTATE)}_createManipulator(){const a=this._createRingManipulator();
this._ringManipulator=a;this.tool.manipulators.add(a);const b=this.tool.graphicState.graphic,c=qa.createManipulatorDragEventPipeline(a,(d,k,g)=>{this._scaleRotateDragData=null;const n=this.adapter.startInteraction(),l={mode:"none",origin:K.clone(d.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l;this._updateDragState();const t=q.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(d.renderLocation,t);k.next(la.screenToRenderPlane(this.tool.view,
L.fromPositionAndNormal(d.renderLocation,t,L.create()))).next(m=>{var f=L.getNormal(m.plane);f=ka.calculateInputRotationTransform(m.renderStart,m.renderEnd,l.origin,f);var p=ba.cyclicalPI.shortestSignedDiff(l.angle,f);l.angleDir=J.clamp(l.angleDir+p,-e.rotateIndicatorDirectionBuffer,e.rotateIndicatorDirectionBuffer);l.angle=f;p=sa(l,m);l.scaleDir=J.clamp(l.scaleDir+(p-this.adapter.scale),-e.scaleIndicatorDirectionBuffer,e.scaleIndicatorDirectionBuffer);this._onScaleChanged();if("none"===l.mode){const u=
this.mode||ta(m,m.plane,l.origin,this.tool.view.state.camera);if(null!=u){switch(u){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:b,angle:0});this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:b,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this.adapter.createUndoRecord()})}l.mode=u}}switch(l.mode){case "rotate":n.state.angle=l.initialAngle+f;break;case "scale":n.state.scale=p,this._onScaleChanged()}this._updateDragState();
this._updateManipulatorTransform();switch(m.action){case "start":case "update":switch(l.mode){case "rotate":this.tool.emit("graphic-rotate",{graphic:b,angle:J.rad2deg(l.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:b,xScale:p,yScale:p})}break;case "end":switch(l.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:J.rad2deg(l.angle)});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:p,yScale:p})}}"end"===m.action&&(this.startAnimation(V(this,
()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),n.done());return m}).next(this._updateTooltipPipelineStep(l));g.next(()=>{n.cancel();if(null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:1,yScale:1})}this.startAnimation(V(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}this._updateFocusTooltip()})});
this.addHandles([c,a.events.on("focus-changed",d=>{"focus"===d.action?this.startAnimation(ua(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),a.events.on("immediate-click",d=>{d.stopPropagation()}),C.watch(()=>this.tool.graphicState?.displaying,d=>this._ringManipulator.available=d,C.initial)])}_updateTooltipPipelineStep(a){return b=>{const {sketchOptions:c}=this,{effectiveEnabled:d,visualVariables:k}=c.tooltips;if(!d)return b;if("end"===
b.action)return this._updateFocusTooltip(),b;var g=this._tooltip;switch(a.mode){case "scale":g.info=this._scaleTooltipInfo??(this._scaleTooltipInfo=new R.TransformScaleTooltipInfo({sketchOptions:c}));const {size:l,scale:t}=this.adapter;var n=k?.size;g=g.info;g.sketchOptions=c;g.scale={value:t};g.size=null!=l?H.createLength(l,"meters"):void 0;g.sizePrecision=O(n?.valueType);g.sizeUnit=n?.unit;break;case "rotate":g.info=this._rotateTooltipInfo??(this._rotateTooltipInfo=new R.TransformRotateTooltipInfo({sketchOptions:c}));
const {orientationClockwise:m,relativeAngleClockwise:f}=this.adapter;n=k?.rotation;const p=O(n?.valueType);g=g.info;g.sketchOptions=c;g.rotation=null!=f?H.createAngle(f,"radians","geographic"):void 0;g.rotationPrecision=p;g.rotationType=n?.rotationType??"geographic";g.orientation=null!=m?H.createAngle(m,"radians","geographic"):void 0;g.orientationPrecision=p}return b}}_updateFocusTooltip(){const {sketchOptions:a,_tooltip:b}=this,{effectiveEnabled:c,visualVariables:d}=a.tooltips;if(c)if(this.getFocused()){const g=
d?.rotation,n=d?.size;var k=this.mode;const {size:l,orientationClockwise:t}=this.adapter,m=null!=t&&(null==k||"rotate"===k);k=null!=l&&(null==k||"scale"===k);b.info=this._absoluteTooltipInfo??(this._absoluteTooltipInfo=new R.TransformAbsoluteTooltipInfo({sketchOptions:a}));const f=b.info;f.sketchOptions=a;f.orientation=m?H.createAngle(t,"radians","geographic"):void 0;f.orientationPrecision=O(g?.valueType);f.rotationType=g?.rotationType??"geographic";f.size=k?H.createLength(l,"meters"):void 0;f.sizeUnit=
n?.unit;f.sizePrecision=O(n?.valueType)}else b.clear()}_onScaleChanged(){this.events.emit("scale-changed");this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(h.DelayedFocused,this.getFocused());this._updateFocusTooltip()}_updateDragState(){this._ringManipulator.updateStateEnabled(h.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode));if(null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case "rotate":this._ringManipulator.updateStateEnabled(h.ScaleIn|
h.ScaleOut,!1);this._ringManipulator.updateStateEnabled(h.RotateLeft,0>this._scaleRotateDragData.angleDir);this._ringManipulator.updateStateEnabled(h.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this._ringManipulator.updateStateEnabled(h.RotateLeft|h.RotateRight,!1),this._ringManipulator.updateStateEnabled(h.ScaleIn,0>this._scaleRotateDragData.scaleDir),this._ringManipulator.updateStateEnabled(h.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this._ringManipulator.updateStateEnabled(h.ScaleIn|
h.ScaleOut|h.RotateLeft|h.RotateRight,!1)}_updateManipulatorTransform(){const a=G.fromRotation(q.sm4d.get(),this.adapter.angle,K.fromValues(0,0,1));if(null!=a){var b=this.getScale();b=G.fromScaling(q.sm4d.get(),w.set(q.sv3d.get(),b,b,b));this._ringManipulator.modelTransform=G.multiply(q.sm4d.get(),b,a)}}_createRingManipulator(){var a=(v,D,P)=>{const W=[],X=Math.ceil(e.geometrySegments*(D-v)/(2*Math.PI));for(let T=0;T<X+1;T++){const Y=v+T*(D-v)/X;W.push(K.fromValues(P*Math.cos(Y),P*Math.sin(Y),0))}return W};
const b=this._createMaterial(1);var c=(v,D,P=b)=>Q.createPathExtrusionGeometry(P,[[-D/2,0],[D/2,0],[D/2,e.ringHeight/2],[-D/2,e.ringHeight/2]],v,[],[],!1),d=a(0,2*Math.PI,e.ringRadius),k=c(d,e.ringThickness),g=[],n=[];const l=[];for(var t=0;2>t;t++){var m=t*Math.PI-Math.PI/4,f=Math.PI/2-e.rotateIndicatorArcLength,p=m+f;m=m+Math.PI/2-f;f=a(p,m,e.innerIndicatorRadius);var u=c(f,e.indicatorThickness);l.push(f);l.push(a(p,m,e.outerIndicatorRadius-e.ringThickness/2));g.push(u);n.push(u.instantiate());
for(u=0;2>u;u++){var E=0===u,r=ha.create();if(E){G.scale(r,r,[1,-1,1]);G.rotate(r,r,-p,[0,0,1]);var z=Math.round(e.rotateIndicatorArrowPlacementPercentage*(f.length-1));r[12]=f[z][0];r[13]=f[z][1];r[14]=f[z][2]}else G.rotate(r,r,m,[0,0,1]),z=Math.round((1-e.rotateIndicatorArrowPlacementPercentage)*(f.length-1)),r[12]=f[z][0],r[13]=f[z][1],r[14]=f[z][2];z=Q.createExtrudedTriangle(b,e.rotateIndicatorArrowTipLength,0,e.rotateIndicatorArrowTipRadius,e.ringHeight);Q.transformInPlace(z,r);(E?g:n).push(z)}}t=
[];for(p=0;2>p;p++)m=p*Math.PI-Math.PI/4,f=Math.PI/2-e.scaleIndicatorArcLength,m=a(m+f,m+Math.PI/2-f,e.outerIndicatorRadius),t.push(c(m,e.indicatorThickness));E=this._createMaterial(.66);p=this._createMaterial(.5);f=this._createMaterial(.33);m=a(0,2*Math.PI,e.ringRadius+e.scaleIndicatorOffset1);u=a(0,2*Math.PI,e.ringRadius+e.scaleIndicatorOffset2);m=c(m,e.indicatorThickness,E);u=c(u,e.indicatorThickness,f);r=a(0,2*Math.PI,e.ringRadius-e.scaleIndicatorOffset1);a=a(0,2*Math.PI,e.ringRadius-e.scaleIndicatorOffset2);
E=c(r,e.indicatorThickness,E);c=c(a,e.indicatorThickness,f);k=[new y.RenderObject(k,h.DelayedFocused),new y.RenderObject(k.instantiate({material:p}),A.ManipulatorStateFlags.None)];this.mode&&"scale"!==this.mode||(k=k.concat([...t.map(v=>new y.RenderObject(v,h.DelayedFocused|h.Unlocked)),new y.RenderObject(m,h.DelayedFocused|h.ScaleIn),new y.RenderObject(u,h.DelayedFocused|h.ScaleIn),new y.RenderObject(E,h.DelayedFocused|h.ScaleOut),new y.RenderObject(c,h.DelayedFocused|h.ScaleOut)]));this.mode&&"rotate"!==
this.mode||(k=k.concat([...n.map(v=>new y.RenderObject(v.instantiate(),h.DelayedFocused|h.Unlocked)),...g.map(v=>new y.RenderObject(v,h.DelayedFocused|h.RotateLeft)),...n.map(v=>new y.RenderObject(v,h.DelayedFocused|h.RotateRight))]));d=[d,...l];return new ja.Manipulator3D({view:this.tool.view,renderObjects:k,autoScaleRenderObjects:!1,worldOriented:!0,radius:e.ringThickness,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:ia.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",
paths:d,direction:K.fromValues(0,0,1)}})}_createMaterial(a){const b=new pa.ColorMaterial({cullFace:na.CullFaceOptions.Back,renderOccluded:oa.RenderOccludedFlag.Transparent,isDecoration:!0});this.addHandles(C.watch(()=>({color:aa.multiplyOpacityToUnitRGBA(this.tool.view.effectiveTheme.accentColor,a)}),c=>b.setParameters(c),C.initial));return b}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:a=>this._ringIndicatorDelayMs=a,tooltip:this._tooltip}}};B.__decorate([F.property({constructOnly:!0})],
x.GraphicScaleRotateTransform.prototype,"tool",void 0);B.__decorate([F.property({constructOnly:!0})],x.GraphicScaleRotateTransform.prototype,"adapter",void 0);B.__decorate([F.property({constructOnly:!0})],x.GraphicScaleRotateTransform.prototype,"sketchOptions",void 0);B.__decorate([F.property()],x.GraphicScaleRotateTransform.prototype,"mode",void 0);B.__decorate([F.property()],x.GraphicScaleRotateTransform.prototype,"_activeAnimation",void 0);B.__decorate([F.property()],x.GraphicScaleRotateTransform.prototype,
"updating",null);x.GraphicScaleRotateTransform=B.__decorate([fa.subclass("esri.views.3d.interactive.editingTools.transformGraphic.GraphicScaleRotateTransform")],x.GraphicScaleRotateTransform);var I;(function(a){a[a.CONTINUE=0]="CONTINUE";a[a.STOP=1]="STOP"})(I||={});const S=ea.createScreenPointArray();Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});