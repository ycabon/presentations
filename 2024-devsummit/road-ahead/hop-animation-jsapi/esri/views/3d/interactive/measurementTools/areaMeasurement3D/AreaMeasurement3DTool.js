// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/memoize ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/support/UpdatingHandles ../../../../../geometry/Point ../../../../../layers/graphics/hydratedFeatures ../../../analysis/support/measurementUtils ../../SnappingVisualizer3D ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DView ../support/PickRequest ../../../../interactive/AnalysisToolBase ../../../../interactive/coordinateHelper ../../../../interactive/dragEventPipeline ../../../../interactive/ManipulatorCollection ../../../../interactive/editGeometry/EditGeometry ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/snapping/SceneSnappingManagerPool ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/snapping/SnappingOperation ../../../../interactive/snapping/snappingUtils ../../../../support/screenUtils".split(" "),
function(e,z,A,r,p,g,d,U,V,B,C,t,l,u,D,v,E,F,G,H,I,J,K,L,M,N,O,P,Q,w){d=class extends G.AnalysisToolBase{constructor(a){super(a);this._updatingHandles=new C.UpdatingHandles;this.polygonState="initial";this.manipulators=new J.ManipulatorCollection;this._getSnappingContext=A.memoize(b=>new N.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:b,editGeometryOperations:new L.EditGeometryOperations(new K.EditGeometry("point",H.createCoordinateHelper(!0,!1,this.view.spatialReference))),
visualizer:new D.SnappingVisualizer3D}))}initialize(){const {view:a,analysisViewData:b,manipulators:c,visible:h}=this;this.measurementView=new E({view:a,analysisViewData:b,toolState:this,manipulators:c,visible:h});const m=M.acquire(a);this._snappingManagerResult=m;this.addHandles(m);this._snappingOperation=new P.SnappingOperation({view:a});this._updatingHandles.add(()=>this.stagedPoint,f=>{this.analysisViewData.stagedPoint=null!=f?l.clonePoint(f,new t):null},p.syncAndInitial);Q.setupSnappingToggleHandles(this,
()=>{const f=this._getSnappingContext(this.view.inputManager.latestPointerType??"mouse");this._updatingHandles.addPromise(r.ignoreAbortErrors(this._snappingOperation.snapAgainNearPreviousMapPoint(this._snappingManager,f)))});this._setupManipulators();this.addHandles([p.watch(()=>this.state,f=>{"measured"===f&&this.finishToolCreation()},p.syncAndInitial),this.analysisViewData.path.on("change",()=>{const f=this.analysisViewData.path;"initial"!==this.polygonState||f.isEmptyPolygon||(this.polygonState=
f.isValidPolygon?"measured":"drawing")})])}destroy(){this.measurementView.destroy();this._set("measurementView",null);this._updatingHandles=z.destroyMaybe(this._updatingHandles)}get _snappingManager(){return this._snappingManagerResult.snappingManager}get state(){return 0===this.analysisViewData.path.numVertices?"ready":this.analysisViewData.path.isValidPolygon&&"editing"!==this.polygonState?"measured":"measuring"}get cursor(){return"ready"===this.state||"drawing"===this.polygonState?"crosshair":
null}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get stagedPoint(){return this._snappingOperation.stagedPoint}set stagedPoint(a){this._snappingOperation.stagedPoint=a}get snappingOptions(){return this._snappingManager.options}finishMeasurement(){const {path:a}=this.analysisViewData;3>a.numVertices?(a.clear(),this.polygonState="initial"):(a.close(),this.polygonState="measured");this._resetSnappingState()}onShow(){this.measurementView.show()}onHide(){this.measurementView.hide()}onDeactivate(){this._resetSnappingState()}onInputEvent(a){switch(a.type){case "immediate-double-click":this._handleImmediateDoubleClick(a);
break;case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}}_setupManipulators(){const a=c=>c.events.on("grab-changed",()=>{this.analysisViewData.path.isValidPolygon&&(this.polygonState=this.manipulators.some(h=>h.manipulator.grabbing)?"editing":"measured")}),b=c=>{this.addHandles([I.createManipulatorDragEventPipeline(c,(h,m,f,q)=>{const x=v.hideManipulatorWhileDragging(h),
n=h.metadata,R=this._snappingManager;q=this._getSnappingContext(q);const {snappingStep:S,cancelSnapping:T}=O.createSnapDragEventPipelineStep({snappingManager:R,snappingContext:q,updatingHandles:this._updatingHandles});f=f.next(x).next(k=>{this.analysisViewData.lastDraggedVertex=null;this.analysisViewData.path.setVertexPosition(n,y);h.location=y;return k}).next(T);m.next(x).next(v.screenToMap3D(this.view)).next(...S).next(k=>{h.location=k.mapEnd;this.analysisViewData.lastDraggedVertex="end"===k.action?
null:n;this.analysisViewData.path.setVertexPosition(n,l.clonePoint(k.mapEnd))});const y=l.clonePoint(this.analysisViewData.path.getVertexPositionAsPoint(n))}),a(c)],c)};this.manipulators.forEach(({manipulator:c})=>{b(c)});this.addHandles([this.manipulators.on("after-add",({item:{manipulator:c}})=>{b(c)}),this.manipulators.on("after-remove",({item:{manipulator:c}})=>this.removeHandles(c))])}_handleImmediateDoubleClick(a){u.isPrimaryPointerAction(a)&&("drawing"===this.polygonState&&this.finishMeasurement(),
a.stopPropagation())}_handleDrag(a){"editing"===this.polygonState&&a.stopPropagation()}_handleImmediateClick(a){if(u.isPrimaryPointerAction(a)){var b=w.createScreenPointFromEvent(a),{pointerType:c}=a;if(this.active)switch(this.polygonState){case "initial":if(this._addVertexAt(b,c)){this.stagedPoint=null;this.polygonState="drawing";a.stopPropagation();return}break;case "drawing":const h=this.measurementView.vertexHandleAt(b,c);if(null==h){if(this._addVertexAt(b,c)){this.stagedPoint=null;a.stopPropagation();
return}}else 0===h.index&&(this.finishMeasurement(),a.stopPropagation())}"mouse"===a.pointerType&&this._hoverAt(b)}}_handlePointerMove(a){"mouse"===a.pointerType&&(a=w.createScreenPointFromEvent(a),this._hoverAt(a))}_handleKeyDown(a){const {path:b}=this.analysisViewData;"Enter"===a.key&&"drawing"===this.polygonState&&3<=b.numVertices&&(this.stagedPoint=null,this.finishMeasurement(),a.stopPropagation())}_hoverAt(a){var {polygonState:b}=this;!this.active||"initial"!==b&&"drawing"!==b?this.stagedPoint=
null:(a=this._pick(a),null!=a?.mapPoint&&(b=this._getSnappingContext("mouse"),this._updatingHandles.addPromise(r.ignoreAbortErrors(this._snappingOperation.snap({point:a.mapPoint},this._snappingManager,b)))))}_addVertexAt(a,b){a=this._pick(a);return null!=a?.mapPoint?({mapPoint:a}=a,b=this._getSnappingContext(b),b=this._snappingOperation.update({point:a},this._snappingManager,b),b=l.clonePoint(b,new t),this.analysisViewData.path.add(b),!0):!1}_pick(a){a=new F.PickRequest(a);return this.measurementView.pick(a)}_resetSnappingState(){this._snappingManager.doneSnapping();
this._snappingOperation.abort();this._snappingOperation.stagedPoint=null}get test(){return{snappingManager:this._snappingManager}}};e.__decorate([g.property({readOnly:!0})],d.prototype,"state",null);e.__decorate([g.property()],d.prototype,"polygonState",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"cursor",null);e.__decorate([g.property()],d.prototype,"measurementView",void 0);e.__decorate([g.property({constructOnly:!0})],d.prototype,"view",void 0);e.__decorate([g.property({constructOnly:!0})],
d.prototype,"analysis",void 0);e.__decorate([g.property({constructOnly:!0})],d.prototype,"analysisViewData",void 0);e.__decorate([g.property({readOnly:!0})],d.prototype,"manipulators",void 0);e.__decorate([g.property()],d.prototype,"updating",null);e.__decorate([g.property()],d.prototype,"stagedPoint",null);e.__decorate([g.property()],d.prototype,"snappingOptions",null);return d=e.__decorate([B.subclass("esri.views.3d.interactive.measurementTools.areaMeasurement3D.AreaMeasurement3DTool")],d)});