// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/reactiveUtils ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/vectorStacks ../../../../layers/graphics/dehydratedPoint ./EngineVisualElement ../../terrain/OverlayRenderer ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Material ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(p,w,l,x,d,k,q,r,m,y,z,A,B,C,D,t,E,F,u,v){class G extends z.EngineVisualElement{constructor(a){super(a);this._maxSize=0;this._position=k.create();this._up=k.create();this._right=k.create();this._renderOccluded=t.RenderOccludedFlag.OccludeAndTransparent;this._color=r.fromValues(1,0,0,1);this._outlineColor=r.fromValues(0,0,0,1);this._outlineSize=0;this._size=32;this._outlineRenderOccluded=t.RenderOccludedFlag.Opaque;this.applyProperties(a)}createObject3DResourceFactory(a){return{view:a,createResources:b=>
this._createObject3DResources(b),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(a){return{view:a,createResources:()=>this._createDrapedResources(),destroyResources:b=>this._destroyDrapedResources(b)}}get renderOccluded(){return this._renderOccluded}set renderOccluded(a){a!==this._renderOccluded&&(this._renderOccluded=a,this._updateQuadMaterial())}get color(){return this._color}set color(a){q.copy(this._color,a);this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(a){q.copy(this._outlineColor,
a);this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(a){const b=0===this._outlineSize!==(0===a);this._outlineSize=a;b?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(a){a!==this._size&&(this._size=a,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(a){this._outlineRenderOccluded=a;this._updateOutlineMaterial()}set geometry({previous:a,center:b,next:c}){this._maxSize=
Math.min(d.distance(b,a),d.distance(b,c))/3;d.normalize(this._up,d.subtract(this._up,a,b));d.normalize(this._right,d.subtract(this._right,c,b));d.copy(this._position,b);this.recreateGeometry()}_createObject3DResources(a){const b=new u.ColorMaterial(this._quadMaterialParameters),c=0===this._outlineSize?void 0:new v.RibbonLineMaterial(this._outlineMaterialParameters);this._createObject3DGeometries(a,b,c);return{quadMaterial:b,outlineMaterial:c,forEach:e=>{e(b);c&&e(c)}}}_createObject3DGeometries(a,
b,c){if(!d.exactEquals(this._up,k.ZEROS)||!d.exactEquals(this._right,k.ZEROS)){b=this._createGeometries(b,c);for(const e of b)a.addGeometry(e);this._updateTransformObject3D(a)}}_createDrapedResources(){const a=new u.ColorMaterial(this._quadMaterialParameters),b=0===this._outlineSize?void 0:new v.RibbonLineMaterial(this._outlineMaterialParameters),c=this._createGeometries(a,b).map(h=>new E.RenderGeometry(h));this._setTransformDraped(c);const e=w.watch(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});
return{quadMaterial:a,outlineMaterial:b,geometries:c,pixelRatioHandle:e}}_destroyDrapedResources(a){a.pixelRatioHandle.remove();a.geometries=[]}_createGeometries(a,b){const {up:c,right:e,corner:h}=this._getVertices();a=this._quadGeometryData(c,e,h,a);if(!b)return[a];b=D.createPolylineGeometry(b,[c,h,e]);return[a,b]}_getVertices(){let a=this._up,b=this._right;const c=d.add(m.sv3d.get(),a,b);this.isDraped&&(a=d.copy(m.sv3d.get(),a),b=d.copy(m.sv3d.get(),b),a[2]=0,b[2]=0,c[2]=0);return{up:a,right:b,
corner:c}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(a=this.object3dResources.object){if(a){var b=this._size*this.view.state.camera.computeScreenPixelSizeAt(this._position);b=Math.min(this._maxSize,b);l.fromTranslation(g,this._position);l.scale(g,g,[b,b,b]);a.transformation=g}}_setTransformDraped(a){if(0!==a.length){var {view:{basemapTerrain:{overlayManager:b},state:{contentPixelRatio:c}}}=this,{_position:e,_size:h}=
this,n=d.copy(m.sv3d.get(),e);n[2]=A.drapedZ;var f=H;f.spatialReference=b.renderer.spatialReference;f.x=n[0];f.y=n[1];f=this.view.overlayPixelSizeInMapUnits(f)*c;f=Math.min(this._maxSize,h*f);l.fromTranslation(g,n);l.scale(g,g,[f,f,1]);for(const I of a)I.transformation=g}}_quadGeometryData(a,b,c,e){return new C.Geometry(e,[[F.VertexAttribute.POSITION,new B.Attribute([0,0,0,...b,...a,...c],[0,1,2,1,2,3],3,!0)]])}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,
polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){this.object3dResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters);this.drapedResources.resources?.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){this.object3dResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters);
this.drapedResources.resources?.outlineMaterial?.setParameters(this._outlineMaterialParameters)}}const g=x.create(),H=y.makeDehydratedPoint(0,0,void 0,null);p.RightAngleQuadVisualElement=G;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});