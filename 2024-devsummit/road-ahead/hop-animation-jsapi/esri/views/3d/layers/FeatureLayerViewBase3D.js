// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../layers/graphics/dehydratedFeatures ../../../layers/graphics/hydratedFeatures ../../../layers/graphics/controllers/FeatureTileController3D ./FeatureLayerViewPerformanceInfo ./FeatureLikeLayerView3D ./LayerView3D ./support/FeatureTileFetcher3DLayerViewContext ../support/EventedSet ../support/updatingProperties ../webgl-engine/lib/UpdatePolicy ../../layers/FeatureLayerView ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(e,n,p,h,g,c,F,G,q,r,t,u,v,w,x,y,z,A,l,B,C,D){c=class extends D(w.FeatureLikeLayerView3D(B(x.LayerView3D(C)))){constructor(a){super(a);this._processorTotal=this._controllerTotal=0;this.suspendResumeExtentMode="data"}initialize(){this.addHandles(h.watch(()=>this._updatingRequiredFieldsPromise,a=>this._updatingHandles.addPromise(a),h.syncAndInitial))}destroy(){this._updatingHandles.removeAll();this._fetcherContext=p.destroyMaybe(this._fetcherContext)}get maximumNumberOfFeatures(){return this.controller?.maximumNumberOfFeatures??
this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(a){this._set("maximumNumberOfFeatures",a);this.controller&&(this.controller.maximumNumberOfFeatures=a)}get maximumNumberOfFeaturesExceeded(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):!1}get updatingProgressValue(){let a=0;if(this.controller?.updating){var b=this.controller.updatingRemaining,d=Math.max(this.controller.updatingTotal,this._controllerTotal);0<d&&(a=(d-b)/d,this._controllerTotal=
d)}b=0;if(this.processor?.updating){d=this.processor.updatingRemaining;const f=Math.max(d,this._processorTotal);0<f&&(b=(f-d)/f,this._processorTotal=f)}return.5*(a+b)}get updatePolicy(){if(!this.controller)return l.UpdatePolicy.ASYNC;switch(this.controller.mode){case "snapshot":const a=E.get(this.layer.geometryType);return null==a||this.controller.serviceDataCount>a?l.UpdatePolicy.ASYNC:l.UpdatePolicy.SYNC;case "tiles":return l.UpdatePolicy.ASYNC}}get hasZ(){const a=this.layer,b=a.capabilities&&a.capabilities.data;
return b&&b.supportsZ?"returnZ"in a&&null!=a.returnZ?a.returnZ:b.supportsZ:!1}get hasM(){const a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsM?"returnM"in a&&null!=a.returnM?a.returnM:!1:!1}setVisibility(a,b){this.processor?.setObjectIdVisibility(a,b)}createQuery(){return super.createQuery()}queryFeatures(a,b){const d=()=>super.queryFeatures(a,b);return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(a),d):d()}beforeSetController(a){a.maximumNumberOfFeatures=
this.maximumNumberOfFeatures}createController(){this._fetcherContext=new y.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const a=new u.FeatureTileController3D({layerView:this,context:this._fetcherContext,graphics:new z.EventedSet,extent:this.clippingExtent});this._updatingHandles.add(()=>a.serviceDataExtent,b=>{this.processor&&(this.processor.dataExtent=b)},h.initial);this.addHandles(h.watch(()=>this.suspended,b=>{b?a.suspend():a.resume()},h.syncAndInitial));
this._updatingHandles.add(()=>this.processor?.displayFeatureLimit,b=>a.displayFeatureLimit=b,h.initial);this.addHandles(h.when(()=>!this.updating,()=>{this._processorTotal=this._controllerTotal=0}));return a}async doRefresh(a){a&&!this.suspended&&this.controller&&this.controller.refetch();this.processor.refreshFilter()}_popupFeatureHasRequiredFields(a,b){if(!super._popupFeatureHasRequiredFields(a,b))return!1;a=r.getObjectId(a,this.layer.objectIdField);if(null==a)return!0;a=this.controller.getMissingAttributesForFeature(a);
if(null==a)return!0;for(const d of b)if(a.has(d))return!1;return!0}get usedMemory(){return(this.processor?.usedMemory??0)+(this.controller?.memoryForUnusedFeatures??0)}get unloadedMemory(){const a=this.controller?.expectedFeatureDiff??0,b=this.processor?.loadedFeatures??0;return(this.processor?.unprocessedMemoryEstimate??0)+a*(this.processor?.usedMemoryPerFeature??0)*(0<b+a?b/(b+a):1)}get ignoresMemoryFactor(){return this.controller?.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(a,b){await this._validateQueryFeaturesMesh(a);
b=await b();if(a?.outStatistics||null==this.graphics3DProcessor)return b;a=this.layer.objectIdField;const d=this.graphics3DProcessor.graphics3DGraphicsByObjectID,f=[];for(const k of b.features)if(k.geometry){const m=d.get(k.attributes[a]);m&&(k.geometry=t.hydrateGeometry(m.graphic.geometry),f.push(k))}else f.push(k);b.features=f;return b}async _validateQueryFeaturesMesh(a){if(a){var b=f=>{throw new n("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${f}'`);
},d=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const f of d)null!=a[f]&&b(f);"returnM"in a&&a.returnM&&b("returnM");"returnCentroid"in a&&a.returnCentroid&&b("returnCentroid");null==a.outSpatialReference||a.outSpatialReference.equals(this.view.spatialReference)||b("outSpatialReference")}}get performanceInfo(){var a=this.controller?.displayFeatureLimit;a=null!=a?a.averageSymbolComplexity:void 0;return new v.FeatureLayerViewPerformanceInfo(super.performanceInfo,this.controller?.performanceInfo?.storedFeatures??
0,this.controller?.performanceInfo?.totalVertices??0,this.maximumNumberOfFeaturesExceeded,this.controller?.mode??"n/a",null!=a?`f:${a.verticesPerFeature},v:${a.verticesPerCoordinate}`:"n/a")}get test(){return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:this.controller?.graphics,...this.getTest()}}};e.__decorate([g.property()],c.prototype,"layer",void 0);e.__decorate([g.property()],c.prototype,"controller",void 0);e.__decorate([g.property()],c.prototype,"_controllerTotal",
void 0);e.__decorate([g.property()],c.prototype,"_processorTotal",void 0);e.__decorate([g.property()],c.prototype,"maximumNumberOfFeatures",null);e.__decorate([g.property()],c.prototype,"maximumNumberOfFeaturesExceeded",null);e.__decorate([g.property(A.updatingProgress)],c.prototype,"updatingProgress",void 0);e.__decorate([g.property({readOnly:!0})],c.prototype,"updatingProgressValue",null);e.__decorate([g.property({readOnly:!0})],c.prototype,"updatePolicy",null);e.__decorate([g.property({readOnly:!0})],
c.prototype,"hasZ",null);e.__decorate([g.property({readOnly:!0})],c.prototype,"hasM",null);e.__decorate([g.property()],c.prototype,"suspendResumeExtentMode",void 0);c=e.__decorate([q.subclass("esri.views.3d.layers.FeatureLayerViewBase3D")],c);const E=new Map([["point",5E3],["polygon",500],["polyline",1E3]]);return c});