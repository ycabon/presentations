// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../layers/graphics/hydratedFeatures ../../../layers/graphics/controllers/FeatureTileController3D ../../../rest/support/Query ../../../symbols/support/utils ./graphics/elevationAlignPointsInFeatures ./graphics/Graphics3DFeatureProcessor ./graphics/QueryEngine ./graphics/queryForSymbologySnapping ./support/HeatmapFeatureProcessor ./support/LayerViewPerformanceInfo ./support/projectExtentUtils ../webgl-engine/lib/UpdatePolicy ../../support/Scheduler".split(" "),
function(n,d,l,k,h,e,E,F,G,p,q,r,t,u,v,w,x,y,z,A,B,C,D){var f;(function(c){c[c.NONE=0]="NONE";c[c.CONTROLLER=1]="CONTROLLER";c[c.CORE=2]="CORE"})(f||={});n.FeatureLikeLayerView3D=c=>{c=class extends c{constructor(){super(...arguments);this._dataUpdatingState=f.NONE;this.controller=null;this.updatePolicy=C.UpdatePolicy.SYNC;this.suspendResumeExtentMode="computed";this.slicePlaneEnabled=!1;this.suspendResumeExtent=this.fullExtentInLocalViewSpatialReference=null;this._controllerCreated=!1;this.supportsHeightUnitConversion=
!0;this.queryEngine=this._pendingController=null}initialize(){const a=this.layer;if("isTable"in a&&a.isTable)this.addResolvingPromise(Promise.reject(new l("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:a})));else{this.addResolvingPromise(this._validateGeometryType());this._updatingHandles.add(()=>this.layer.renderer,g=>this._recreateProcessor(g),h.initial);this.addResolvingPromise((async()=>{this.fullExtentInLocalViewSpatialReference=await B.toViewIfLocal(this);
await this._initializeController()})());this._updatingHandles.add(()=>this.updatePolicy,g=>this.processor.preferredUpdatePolicy=g);var b=()=>this.processor.featureStore;this.queryEngine=new x.QueryEngine({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return b()},hasZ:this.hasZ,hasM:this.hasM},priority:D.TaskPriority.FEATURE_QUERY_ENGINE});this.notifyChange("updating")}}destroy(){this._destroyPendingController();
this.controller=k.destroyMaybe(this.controller);this._set("processor",k.destroyMaybe(this.processor));this.queryEngine=k.destroyMaybe(this.queryEngine);this.loadedGraphics=null}_destroyPendingController(){this._pendingController=k.destroyMaybe(this._pendingController)}get dataUpdating(){return this._dataUpdatingState!==f.NONE}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===
this.processor?.type?this.processor:null}get symbologySnappingSupported(){return this.layer?.renderer?.getSymbols()?.some(u.symbolHasExtrudeSymbolLayer)??!1}get hasAllFeatures(){return this.controller&&"hasAllFeatures"in this.controller?this.controller.hasAllFeatures:!1}get hasAllFeaturesInView(){return this.controller&&"hasAllFeaturesInView"in this.controller?this.controller.hasAllFeaturesInView:!1}get hasFullGeometries(){return this.controller&&"hasFullGeometries"in this.controller?this.controller.hasFullGeometries:
!1}getHit(a){let b;this.loadedGraphics?.forEach(g=>{g.uid===a&&(b=q.hydrateGraphic(g,this.layer))});return b?{type:"graphic",graphic:b,layer:b.layer}:null}whenGraphicBounds(a,b){return this.processor?.whenGraphicBounds(a,b)}computeAttachmentOrigin(a,b){return this.processor?.computeAttachmentOrigin(a,b)}async elevationAlignPointsInFeatures(a,b){const g=this.graphics3DProcessor;if(null==g)throw new l("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");
return v.elevationAlignPointsInFeatures(this.view,this.layer,m=>g.getGraphics3DGraphicByObjectId(m),a,b)}async queryForSymbologySnapping(a,b){return this.symbologySnappingSupported?y.queryForSymbologySnapping(this.graphics3DProcessor,a,b):{candidates:[],sourceCandidateIndices:[]}}queryFeatures(a,b){return this.queryEngine.executeQuery(this._ensureQuery(a),b?.signal)}queryObjectIds(a,b){return this.queryEngine.executeQueryForIds(this._ensureQuery(a),b?.signal)}queryFeatureCount(a,b){return this.queryEngine.executeQueryForCount(this._ensureQuery(a),
b?.signal)}queryExtent(a,b){return this.queryEngine.executeQueryForExtent(this._ensureQuery(a),b?.signal)}_ensureQuery(a){return null==a?this.createQuery():t.from(a)}highlight(a){return this.processor.highlight(a,this.layer.objectIdField)}maskOccludee(a){return this.processor.maskOccludee(a)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const a=super.getSuspendInfo();return this.processor?{...a,...this.processor.suspendInfo}:a}isUpdating(){return!this.processor||
this.processor.destroyed?!1:!(this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}async _initializeController(){const a=this.createController();this._pendingController=a;this._setupDataUpdating(a);await a.when();this._setControllerWhenInitialized(a)}_setupDataUpdating(a){"dataUpdating"in a&&this.addHandles([h.watch(()=>a.dataUpdating,b=>{b&&this._dataUpdatingState===f.NONE?this._dataUpdatingState=f.CONTROLLER:b||this._dataUpdatingState!==
f.CONTROLLER||(this._dataUpdatingState=f.NONE)},h.sync),h.watch(()=>!!this.graphics3DProcessor?.dataUpdating,b=>{b&&this._dataUpdatingState===f.CONTROLLER?this._dataUpdatingState=f.CORE:b||this._dataUpdatingState!==f.CORE||(this._dataUpdatingState=a.dataUpdating?f.CONTROLLER:f.NONE)},h.sync)])}async _setControllerWhenInitialized(a){try{await this.when()}catch(b){}this._controllerCreated=!0;this.notifyChange("updating");!this.isResolved()||this.destroyed?this._destroyPendingController():(await h.whenOnce(()=>
this.view?.basemapTerrain?.ready),this.beforeSetController(a),this._pendingController=null,this.controller=a,this.loadedGraphics=a.graphics,this.notifyChange("updating"))}_updateClippingExtent(a){this.clippingExtent=a;if(!this.controller)return!1;switch(this.controller.type){case "stream":return!1;case "feature-tile-3d":return this.controller.extent=a,!0}}async _validateGeometryType(){switch(this.layer.geometryType){case "multipatch":case "multipoint":throw new l("featurelayerview3d:unsupported-geometry-type",
"Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType});}}_recreateProcessor(a){var b="heatmap"===a?.type;const g="heatmap"===this.processor?.type;a=this.processor;a&&b===g||(b=b?new z.HeatmapFeatureProcessor({owner:this}):new w.Graphics3DFeatureProcessor({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,
updateClippingExtent:m=>this._updateClippingExtent(m)}),this._set("processor",b),a?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(b.initializePromise))}get performanceInfo(){const a=this.controller instanceof r.FeatureTileController3D?this.controller:null;return new A.LayerViewPerformanceInfo(this.processor.usedMemory,this.loadedGraphics?.length,a?.serviceDataCount??-1,a?.maximumNumberOfFeatures??-1,0,this.processor.performanceInfo)}};d.__decorate([e.property()],c.prototype,"loadedGraphics",
void 0);d.__decorate([e.property()],c.prototype,"_dataUpdatingState",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"dataUpdating",null);d.__decorate([e.property()],c.prototype,"suspended",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"legendEnabled",null);d.__decorate([e.property()],c.prototype,"updating",void 0);d.__decorate([e.property()],c.prototype,"controller",void 0);d.__decorate([e.property()],c.prototype,"processor",void 0);d.__decorate([e.property({readOnly:!0})],
c.prototype,"updatePolicy",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"suspendResumeExtentMode",void 0);d.__decorate([e.property({type:Boolean})],c.prototype,"slicePlaneEnabled",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"suspendInfo",void 0);d.__decorate([e.property()],c.prototype,"graphics3DProcessor",null);d.__decorate([e.property()],c.prototype,"heatmapProcessor",null);d.__decorate([e.property()],c.prototype,"symbologySnappingSupported",null);d.__decorate([e.property({readOnly:!0})],
c.prototype,"hasAllFeatures",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"hasAllFeaturesInView",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"hasFullGeometries",null);return c=d.__decorate([p.subclass("esri.views.3d.layers.FeatureLikeLayerView3D")],c)};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});