// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/tslib.es6 ../../../Color ../../../Graphic ../../../core/arrayUtils ../../../core/ByteSizeUnit ../../../core/Collection ../../../core/handleUtils ../../../core/has ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/mat3 ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../core/libs/gl-matrix-2/factories/quatf64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../chunks/vec42 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../core/support/UpdatingHandles ../../../geometry/projection/localLinearScaleFactors ../../../geometry/projection/projectBoundingSphere ../../../geometry/projection/projectBuffer ../../../geometry/projection/projectors ../../../geometry/projection/projectVectorToVector ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/DoubleArray ../../../geometry/support/FloatArray ../../../geometry/support/Indices ../../../chunks/sphere ../../../geometry/support/UByteArray ../../../layers/LayerConstants ../../../layers/graphics/controllers/I3SOnDemandController ../../../layers/support/fieldUtils ../../../layers/support/SceneModification ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeOnDemand ../../../support/basemapUtils ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./I3SMeshViewLabeler ./I3SMeshViewPerformanceInfo ./I3SMeshWorkerHandle ./II3SMeshView3D ./SceneLayerWorker ./graphics/graphicUtils ./graphics/Labeler ./i3s/enums ./i3s/Highlights ./i3s/I3SAsyncElevationUpdater ./i3s/I3SCrossfadeHelper ./i3s/I3SGeometryUtil ./i3s/I3SIntersectionHandler ./i3s/I3SMaterialUtil ./i3s/I3SNode ./i3s/I3SOverrides ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./i3s/IDBMockCache ./i3s/LayerElevationProvider ./support/attributeUtils ./support/symbolColorUtils ../support/debugFlags ../support/ElevationRange ../support/extentUtils ../support/orientedBoundingBox ../support/updatingProperties ../support/buffer/glUtil ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl ../webgl-engine/lib/BasisUtil ../webgl-engine/lib/edgeRendering/interfaces".split(" "),
function(Za,ma,t,$a,ca,wa,ab,bb,cb,na,H,xa,F,db,R,G,eb,ya,za,w,fb,gb,hb,Aa,Ba,ib,D,S,jb,kb,lb,mb,nb,ob,Ca,oa,T,U,Da,pb,qb,V,rb,sb,tb,ub,vb,Ea,wb,xb,yb,Fa,zb,Ab,Ga,r,da,Ha,Bb,K,Cb,Db,Ia,Eb,Fb,W,pa,Gb,qa,x,Hb,Ib,Jb,ra,ea,X,sa,Ja,fa,Kb,Lb,Mb,ha,Ka,ia){function L(h,a){R.isAbortError(h)||H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn("Error while processing edges. Edges on this layer might not display correctly",a,h)}function La(h){if(null==h)return!1;const a=h.metallicRoughness;return a&&0<=a.baseColorTextureId||
a&&0<=a.metallicRoughnessTextureId||0<=h.normalTextureId||0<=h.emissiveTextureId||0<=h.occlusionTextureId}function Ma(h){return null!=h&&ya.isArrayBuffer(h.data)}function Na(h,a){h=1024+h.interleavedVertexData.byteLength+(h.indices?h.indices.byteLength:0)+h.positionData.data.byteLength+h.positionData.indices.byteLength;if(null!=a)for(const b of a)null!=b&&ya.isArrayBuffer(b.data)&&(h+=b.data.byteLength);return h}function Oa(h,a){return a.byteSize>Nb?(H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn(`Node is too big to store in IndexedDB cache: ${h.id} (${a.byteSize} bytes)`),
!1):0<a.byteSize}function Ob(h){if(0!==h.length){var a=new Float64Array(10*h.length),b=0;h.forAll(c=>{let d=c.serviceObbInIndexSR;null==d&&(d=Pb,d.center=V.getCenter(c.serviceMbsInIndexSR),d.halfSize=[c.serviceMbsInIndexSR[3],c.serviceMbsInIndexSR[3],c.serviceMbsInIndexSR[3]]);c=d.data;a[b++]=c[0];a[b++]=c[1];a[b++]=c[2];a[b++]=c[3];a[b++]=c[4];a[b++]=c[5];a[b++]=c[6];a[b++]=c[7];a[b++]=c[8];a[b++]=c[9]});return a}}function Y(h,a){h.forEach(b=>b.opacity=a)}function Pa(h){return a=>{if(h.immediate)return h.immediate.schedule(a);
console.error("Error no immediate schudler");throw Error("cant find immediate scheduler");}}function ta(h,a,b){let c=h.elevationRangeMin,d=h.elevationRangeMax;if(0<b){a.getCorners(ja);for(const f of ja){var e=D.len(f)-b;c=Math.min(c,e);d=Math.max(d,e)}}else{a.getCorners(ja);for(e of ja)b=e[2],c=Math.min(c,b),d=Math.max(d,b)}h.expandElevationRangeValues(c,d)}function Qa(h,a,b){const c=V.getCenter(a);b=0<b?D.len(c)-b:c[2];a=V.getRadius(a);h.expandElevationRangeValues(b-a,b+a)}const Ra=[1,1,1,1];class Qb extends Ia.NodeCrossfadeMetaData{constructor(h,
a,b,c,d,e,f,g,l){super();this.node=h;this.featureIds=a;this.objectHandle=b;this.cachedRendererVersion=c;this.attributeInfo=d;this.material=e;this.textures=f;this.anchorIds=g;this.anchors=l;this.cachedElevationAnchors=null;this.cachedEdgeMaterials=[];this.edgeMemoryUsage=0}}var N;(function(h){h[h.CastShadows=4]="CastShadows";h[h.Pickable=5]="Pickable"})(N||={});const Nb=100*ab.ByteSizeUnit.MEGABYTES;var I;(function(h){h[h.ADD=0]="ADD";h[h.REMOVE=1]="REMOVE";h[h.UPDATE=2]="UPDATE"})(I||={});const Sa=
T.create(),Ta=U.create(),Rb=U.create(),Pb=new fa.Obb,Z=[0,0,0,0],Sb=new $a([0,0,0,0]),Ua=V.fromValues(0,0,0,0);class aa{constructor(h,a){this.mode=h;this.offset=a}}const z=S.create(),O=T.create(),ja=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],P=new sa.ElevationRange;ma.I3SMeshView3D=h=>{h=class extends h{constructor(...a){super(a);this._needsNormals=!0;this._updatingHandles=new lb.UpdatingHandles;this._nodeId2Meta=new Map;this._nodeId2MetaReloading=new Map;this._i3sWasmLoaded=
!1;this._snappingSourcesTrackers=[];this._hasLoadedPBRTextures=!1;this._asyncModuleLoading=0;this._addTasks=new Map;this._currentRenderer=null;this._rendererVersion=0;this._symbologyOverrideFields=this._symbologyOverride=this._symbologyFields=this._rendererFields=this._opacityVariable=this._colorVariable=null;this._symbolInfos=new Map;this._visibleGeometryChangedSchedulerHandle=null;this._hasVertexColors=this._hasComponentData=!1;this._nodeColorOverride=null;this.updating=!0;this.holeFilling="auto";
this.slicePlaneEnabled=this._hasData=this._hasTextures=this._hasColors=!1;this._modifications=[];this.ignoresMemoryFactor=!1;this._layerUrl="";this._cacheKeySuffix=null;this._planetRadiusInGlobalMode=0;this._elevationTask=null;this._filters=[];this._arcade=null;this._tmpAttributeOnlyGraphic=new ca(null,null,{});this._crossfadeHelper=new Ia.I3SCrossfadeHelper(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&
this.i3slayer.uid}get sublayerUid(){return null}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get contentVisible(){return!this.suspended&&this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get updatingProgressValue(){return this._controller?.updatingProgress??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return x.rendererNeedsTextures(this._currentRenderer)?
this._usePBR||this._hasLoadedPBRTextures?K.TextureUsage.AllTexturesPBR:K.TextureUsage.AllTextures:this._usePBR||this._hasLoadedPBRTextures?K.TextureUsage.GeometryTexturesPBR:K.TextureUsage.GeometryTextures}get elevationOffset(){const a=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){const b=za.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference),c=Fa.getMetersPerUnit(a.unit);return(a.offset??0)*c/b}return 0}get elevationInfo(){const a=null!=this.i3slayer?
this.i3slayer.elevationInfo:null;if(null==a)return new aa(r.ElevationMode.Absolute,0);var b=za.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference);const c=Fa.getMetersPerUnit(a.unit);b=(a.offset??0)*c/b;switch(a.mode){case "absolute-height":return new aa(r.ElevationMode.Absolute,b);case "relative-to-ground":return new aa(r.ElevationMode.RelativeToGround,b);case "on-the-ground":return new aa(r.ElevationMode.OnTheGround,0);default:return new aa(r.ElevationMode.Absolute,0)}}get supportedTextureEncodings(){return W.getSupportedEncodings(this.view._stage.renderView.capabilities)}get uncompressedTextureDownsamplingEnabled(){const a=
0===(this.supportedTextureEncodings&K.TextureEncoding.DDS_S3TC);return this.view?.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&a}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){var a=this._nodeId2Meta;const b=new sa.ElevationRange;for(const c of a.values()){if(null==c)continue;({node:{serviceMbsInIndexSR:a}}=c);const [,d,e]=a;b.expandElevationRangeValues(d-e,d+e)}return b.elevationRangeValid?b:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){var a=
na("enable-feature:idb-mock-cache");this._idbCache=a?new Ib.IDBMockCache(this.view,a):new Hb.IDBCache("esri-scenelayer-cache","geometries");this._preLoadBasis();this.addResolvingPromise(this.i3slayer.indexInfo);a=this.view.resourceController;this.i3sOverrides=new Gb.I3SOverrides({view:this.view,layer:this.i3slayer,memoryController:a.memoryController});this._worker=new Ga.I3SMeshWorkerHandle(Pa(a));this.addResolvingPromise(this._worker.promise);a=this.i3slayer.store;this._worker.setLegacySchema(this.uid,
a.defaultGeometrySchema);x.checkSceneLayerValid(this.i3slayer);x.checkSceneLayerCompatibleWithView(this.i3slayer,this.view);this._layerUrl=this.i3slayer.parsedUrl.path;this._controller=new tb({layerView:this,worker:this._worker});this._geoMemoryEstimate=this._texMemoryEstimate=this._gpuMemoryEstimate=0;this._stage=this.view._stage;this._collection=this._stage.renderView.componentObjectCollection;this.resetHighlights();a=a.defaultGeometrySchema;if(this._isIntegratedMesh||!a)this._hasComponentData=
!1;else{const g=a.featureAttributes;this._hasComponentData=!!(g&&g.faceRange&&g.id)}this._hasVertexColors=null!=(a?.vertexAttributes.color??null)&&!this.i3slayer.cachedDrawingInfo?.color;this._isIntegratedMesh||(this._edgeView=this._stage.renderer.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,g=>this._deleteComponentObject(g));const b=this._controller,c=this._nodeId2Meta,d=this._nodeId2MetaReloading;this._intersectionHandler=new Fb.I3SIntersectionHandler({layerUid:this.layerUid,
sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:g=>{const l=b.index;if(l){var m=l.rootNode;m&&l.traverse(m,q=>{var p=q.index;p=c.get(p)||d.get(p);return g(q,p?.objectHandle??null)})}}});this._updatingHandles.add(()=>this.layerUid,g=>this._intersectionHandler.layerUid=g);this._updatingHandles.add(()=>this.sublayerUid,g=>this._intersectionHandler.sublayerUid=g);this._elevationProvider=new Jb.LayerElevationProvider({view:this.view,
layerElevationSource:this,intersectionHandler:this._intersectionHandler});this._hasLoadedPBRTextures=this._usePBR;this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),G.initial);this._updatingHandles.add(()=>this.fullOpacity,g=>this._opacityChange(g));this._updatingHandles.add(()=>this.slicePlaneEnabled,g=>this._slicePlaneEnabledChange(g));this._updatingHandles.add(()=>this.elevationOffset,(g,l)=>{this._reloadAll(l);this._controller.invalidateVisibilityObbs()});this._updatingHandles.add(()=>
this.elevationInfo,(g,l)=>this._elevationInfoChanged(g,l),G.initial);this._updatingHandles.add(()=>!this.suspended&&this.elevationInfo.mode!==r.ElevationMode.Absolute,(g,l)=>{g?this.addHandles(this.view.basemapTerrain.on("elevation-change",({extent:m})=>this._ensureElevationTask().addExtent(m)),"elevation-change"):l&&this.removeHandles("elevation-change")},G.initial);this._updatingHandles.add(()=>this._usePBR,g=>this._updatePBR(g));a=()=>{this._reloadAll();this.clearMemCache()};this._updatingHandles.add(()=>
this.rendererTextureUsage,a);this._updatingHandles.add(()=>this.uncompressedTextureDownsamplingEnabled,a);this._updatingHandles.add(()=>this.contentVisible,g=>this._contentVisibleChanged(g),G.initial);this._updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),G.initial);this._updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),G.initial);this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),G.initial);this.addHandles([G.watch(()=>
X.debugFlags.I3S_TREE_SHOW_TILES,g=>{if(g&&!this._treeDebugger){const l=this._controller.crsIndex;(new Promise((m,q)=>Za(["./support/I3STreeDebugger"],m,q))).then(({I3STreeDebugger:m})=>{!this._treeDebugger&&X.debugFlags.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new m({lv:this,view:this.view,nodeSR:l}))})}else g||X.debugFlags.I3S_TREE_SHOW_TILES||(this._treeDebugger=F.destroyMaybe(this._treeDebugger))},G.initial),G.watch(()=>X.debugFlags.I3S_SHOW_MODIFICATIONS,()=>this._showModifications(),G.initial)]);
this._cacheKeySuffix=x.getCacheKeySuffix(this.i3slayer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(g=>H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn(`Failed to initialize IndexedDB cache: ${g}`));({view:a}=this);const {viewingMode:e,renderCoordsHelper:f}=a;this._planetRadiusInGlobalMode="local"===e?0:f.referenceEllipsoid.radius}destroy(){this._clearAddTasks();this._elevationTask=F.destroyMaybe(this._elevationTask);this.i3sOverrides=F.destroyMaybe(this.i3sOverrides);
this._elevationProvider&&(this._elevationProvider.objectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null);this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const a=this._worker;a&&(a.destroyContext(this.uid).then(()=>a.destroy()),this._worker=null);this._removeAllNodeDataFromStage();this._memCache=F.destroyMaybe(this._memCache);
this._edgeView=this._stage=this._collection=null;this._labeler=F.destroyMaybe(this._labeler);this._treeDebugger=F.destroyMaybe(this._treeDebugger);this._controller=F.destroyMaybe(this._controller);this._highlights.destroy();this._nodeId2Meta.clear();this._nodeId2MetaReloading.clear();this._crossfadeHelper=F.destroyMaybe(this._crossfadeHelper);this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=
null);this._updatingHandles=F.destroyMaybe(this._updatingHandles)}_memEstimateTextureAdded(a){a=a.memoryEstimate;this._gpuMemoryEstimate+=a;this._texMemoryEstimate+=a;return a}_memEstimateTextureRemoved(a){null!=a&&(a=a.memoryEstimate,this._gpuMemoryEstimate-=a,this._texMemoryEstimate-=a)}_memEstimateGeometryAdded(a){a=this._collection.getObjectGPUMemoryUsage(a);this._gpuMemoryEstimate+=a;this._geoMemoryEstimate+=a;return a}_memEstimateGeometryRemoved(a){a=this._collection.getObjectGPUMemoryUsage(a);
this._gpuMemoryEstimate-=a;this._geoMemoryEstimate-=a}isNodeLoaded(a){return this._nodeId2Meta.has(a)}isNodeReloading(a){return this._nodeId2MetaReloading.has(a)}get usedMemory(){let a=null!=this._labeler?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(b=>a+=null!=b?b.node.memory:0);this._nodeId2MetaReloading.forEach(b=>a+=null!=b?b.node.memory:0);return a}get unloadedMemory(){return(null!=this._controller?this._controller.unloadedMemoryEstimate:0)+(null!=this._labeler?this._labeler.unloadedMemoryEstimate:
0)}_labelingChanged(){if(!Bb.areLabelsVisible(this.i3slayer)||!this._supportsLabeling)null!=this._labeler&&(this._labeler.destroy(),this._labeler=null);else if(null==this._labeler){var a=new zb({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides});this._nodeId2Meta.forEach(b=>null!=b&&this._addMetaToLabeler(a,b));this._labeler=a}}_loadAsyncModule(a){++this._asyncModuleLoading;return a.then(b=>{--this._asyncModuleLoading;return b},b=>{--this._asyncModuleLoading;
throw b;})}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)this._i3sWasmLoaded=da.initialize().then(()=>{this._i3sWasmLoaded=!0;this._modificationsChanged();this.notifyUpdate()}),this.notifyUpdate();else if(!0===this._i3sWasmLoaded){var a=this.uid,b=this.i3slayer.spatialReference;this._worker.setModifications(a,this._layerClippingArea,this._modifications,b);var c=Ga.toWasmModification(this._layerClippingArea,this._modifications,b);da.setModificationsSync({context:a,modifications:c,
isGeodetic:b.isGeographic});this._controller.modificationsChanged();var d=this.hasModifications?new db:null;this._nodeId2Meta.forEach((e,f)=>{null==e?(this._nodeId2Meta.delete(f),this._controller.updateLoadStatus(f,!1)):e.node.hasModifications?(this._nodeId2Meta.delete(f),this._nodeId2MetaReloading.set(f,e)):null!=d&&d.push(e.node)});this.notifyChange("elevationRange");null!=d&&this._nodeId2MetaReloading.forEach(e=>d.push(e.node));null!=d&&0<d.length&&(this.updateNodeModificationStatus(d),d.forAll(e=>
{if(e.imModificationImpact!==pa.NodeIMModificationImpact.Culled){const f=this._nodeId2Meta.get(e.index);this._controller.invalidateGeometryVisibility(e.index);null!=f?(this._nodeId2Meta.delete(e.index),this._nodeId2MetaReloading.set(e.index,f),this.notifyChange("elevationRange")):this._nodeId2Meta.has(e.index)&&(this._nodeId2Meta.delete(e.index),this._controller.updateLoadStatus(e.index,!1))}}));this.clearMemCache();this._controller.restartNodeLoading();this._showModifications()}}_showModifications(){null!=
this._modificationGraphics&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null);if(X.debugFlags.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var a={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},b={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(const c of this._modifications){const d=c.geometry;d.spatialReference=this.i3slayer.spatialReference;this._modificationGraphics.push(new ca({geometry:d,
symbol:{...b,color:a[c.type]}}))}this.view.graphics.addMany(this._modificationGraphics)}}_addMetaToLabeler(a,b){a.addNodeMeta(b,(c,d)=>this._createAttributes(c,d))}_contentVisibleChanged(a){a?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(a){a=
this._nodeId2Meta.get(a);if(null!=a?.attributeInfo)return a.attributeInfo.loadedAttributes}getAttributeData(a){a=this._nodeId2Meta.get(a);if(null!=a?.attributeInfo)return a.attributeInfo.attributeData}setAttributeData(a,b){a=this._nodeId2Meta.get(a);null!=a?.attributeInfo&&(a.attributeInfo.attributeData=b,this._attributeValuesChanged(a))}async updateAttributes(a,b,c){const d=this._nodeId2Meta.get(a);null!=d&&(await this.i3sOverrides.applyAttributeOverrides(d.featureIds,b,c,this._controller.requiredAttributes),
d.attributeInfo=b,this._controller.reschedule(()=>this._attributeValuesChanged(d),c).catch(e=>{R.isAbortError(e)||H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn("Error while updating attribute values. Layer might not display correctly.",e)}))}_attributeValuesChanged(a){a.cachedRendererVersion=this._getInvalidRendererVersion();a.filteredIds=null;null!=this._labeler&&this._labeler.setNodeMetaAttributes(a,(b,c)=>this._createAttributes(b,c));this._updateEngineObject(a)}clearMemCache(){null!=this._memCache&&
this._memCache.clear()}getVisibleNodes(){const a=[];this._nodeId2Meta.forEach(b=>null!=b&&a.push(b.node));return a}getVisibleObbs(){const a=[];this._nodeId2Meta.forEach(b=>{null!=b&&(b=this.getNodeComponentObb(b.node),null!=b&&a.push(b))});return a}getNodeComponentObb(a){a=this._nodeId2Meta.get(a.index)??this._nodeId2MetaReloading.get(a.index);return null!=a?this._collection.getComponentObb(a.objectHandle):null}getLoadedNodeIndices(a){this._nodeId2Meta.forEach((b,c)=>a.push(c));this._nodeId2MetaReloading.forEach((b,
c)=>a.push(c))}_preLoadBasis(){!na("disable-feature:i3s-basis")&&0!==(this.supportedTextureEncodings&K.TextureEncoding.Basis)&&this.i3slayer.textureSetDefinitions?.some(a=>a.formats.some(b=>"basis"===b.format||"ktx2"===b.format))&&Ka.loadBasis()}_getVertexBufferLayout(a,b){a={hasTexture:La(a.params.material),hasNormals:b.normal,hasRegions:b.uvRegion};return Lb.glLayout(Mb.createVertexBufferLayout(this._getGeometryParameters(a)))}_getObjectIdField(){return this.i3slayer.objectIdField||sb.fallbackObjectIDAttribute}_getGlobalIdField(){return this.i3slayer.associatedLayer?.globalIdField}_findGraphicNodeAndIndex(a){const b=
ra.attributeLookup(this.i3slayer.fieldsIndex,a.attributes,this._getObjectIdField());let c=null;xa.someMap(this._nodeId2Meta,d=>{if(null==d)return!1;const e=d.featureIds.indexOf(b);if(-1===e)return!1;c={node:d.node,index:e};return!0});return c}_getGraphicIndices(a,b){a=this._nodeId2Meta.get(a.index);if(null==a)return[];const c=[],d=this._getObjectIdField(),e=this.i3slayer.fieldsIndex;for(const f of b)b=ra.attributeLookup(e,f.attributes,d),b=a.featureIds.indexOf(b),-1!==b&&c.push(b);return c}whenGraphicBounds(a){a=
this._findGraphicNodeAndIndex(a);if(!a)return Promise.reject();a=this._getAABB(a.node.index,a.index);return null==a?Promise.reject():Promise.resolve({boundingBox:a,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(a){return null==a.nodeIndex||null==a.componentIndex?null:this._getAABB(a.nodeIndex,a.componentIndex)}_getAABB(a,b){a=this._nodeId2Meta.get(a);if(null==a?.featureIds||b>=a.featureIds.length)return null;b=Eb.boundingBoxCornerPoints(b,this._collection,a.objectHandle,Da.newDoubleArray(24),
0);if(!ob.projectBuffer(b,this.view.renderSpatialReference,0,b,this.view.spatialReference,0,8))return null;a=T.empty();T.expandWithBuffer(a,b,0,8);return a}whenGraphicAttributes(a,b){return x.whenGraphicAttributes(this.i3slayer,a,this._getObjectIdField(),b,()=>[...this._nodeId2Meta.values()].filter(wa.isSome))}getGraphicFromIntersectorTarget(a){if(null==a.nodeIndex||null==a.componentIndex)return null;const b=this._nodeId2Meta.get(a.nodeIndex);return null==b?.featureIds||a.componentIndex>=b.featureIds.length?
null:this._createGraphic(a.componentIndex,b)}_getCacheKey(a){return`${this._layerUrl}/v${23}/${a}${this._cacheKeySuffix}`}_getMemCacheKey(a,b=this.elevationOffset){return a+"#"+b}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(a){return null!=this._memCache?this._memCache.pop(this._getMemCacheKey(a)):null}deleteCachedGPUData(a){null!=a&&this._deleteComponentObject(a)}_cacheGPUData(a,b=this.elevationOffset){if(null==
this._memCache)this._deleteComponentObject(a);else{var c=this._controller.indexDepth-a.node.level;this._memCache.put(this._getMemCacheKey(a.node.index,b),a,a.node.memory,c)}}loadMissingTextures(a,b,c,d){const e=a?.filter((f,g)=>{if(0===(f.usage&this.rendererTextureUsage))return!1;if(null==b)return!0;f=W.selectEncoding(f.encodings,this.supportedTextureEncodings);g=b[g];return null==g?.data||f&&g.encoding!==f.encoding?!0:!1})??[];return 0===e.length?Promise.resolve(!1):c(e,d).then(f=>{let g=0;for(let l=
0;l<a.length;l++)g<f.length&&f[g].id===a[l].id&&(b[l]=f[g],g++);return!0})}loadCachedNodeData(a,b,c){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(a.id),b).then(d=>{if(null==d)return null;if(d.nodeVersion!==a.version)return this._idbCache.remove(this._getCacheKey(a.id)),null;this.elevationInfo.mode===r.ElevationMode.Absolute&&(a.geometryObbInRenderSR=fa.Obb.fromData(d.geometryObbData));return this.loadMissingTextures(d.requiredTextures,d.textureData,c,b).then(e=>{e&&this._idbCache.initialized&&
null!=d.textureData&&(d.byteSize=Na(d.transformedGeometry,d.textureData),d.textureData.every(Ma)&&Oa(a,d)&&this._idbCache.put(this._getCacheKey(a.id),d).catch(f=>H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn(`Failed to update node with textures in IndexedDB cache: ${a.id}: ${f}`)));R.throwIfAborted(b);return d})}):Promise.resolve(null)}addNode(a,b,c){return"geometryData"in b?null==b.geometryBuffer?(this._addNodeMeta(a.index,null),Promise.resolve()):this._addData(a,b.attributeDataInfo,()=>
this._transformNode(a,b,c).then(d=>this._safeReschedule(()=>{if(null==d)return a.hasModifications=!1,this._addCachedNodeData(a,null,c);a.hasModifications=d.transformedGeometry.hasModifications;const {obb:e,componentOffsets:f,featureIds:g,anchorIds:l,anchors:m,transformedGeometry:q}=d;var p=qa.computeGlobalTransformation(a.serviceMbsInIndexSR,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference),u=D.set(z,e.center.x,e.center.y,e.center.z);D.transformMat4(u,u,p);u=new fa.Obb(u,
[e.extents.x,e.extents.y,e.extents.z],ib.fromValues(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w));this.elevationInfo.mode===r.ElevationMode.Absolute&&(a.geometryObbInRenderSR=u);b.geometryData.componentOffsets=f;g&&(b.geometryData.featureIds=Array.from(g));b.geometryData.anchorIds=l;b.geometryData.anchors=m;p={nodeVersion:a.version,geometryData:b.geometryData,requiredTextures:b.requiredTextures,textureData:b.textureData,transformedGeometry:q,globalTrafo:p,geometryObbData:u.data,
byteSize:Na(q,b.textureData)};this._idbCacheEnabled&&this._idbCache.initialized&&Oa(a,p)&&(u=null!=p.textureData?p.textureData.map(y=>Ma(y)?y:null):null,this._idbCache.put(this._getCacheKey(a.id),{...p,textureData:u}).catch(y=>H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn(`Failed to store node in IndexedDB cache: ${a.id}: ${y}`)));return this._addCachedNodeData(a,p,c)},c))):Promise.reject()}getElevationRange(a){const b=new sa.ElevationRange;var {view:c}=this;const {renderCoordsHelper:d}=
c,e=d.referenceEllipsoid.radius,f=this._collection;c=this._controller;const {index:g}=c;if(!g)return b;const {rootNode:l}=g;if(!l)return b;const m=this._nodeId2Meta,q=a[3],p=c.viewportQueries,u=this._planetRadiusInGlobalMode;g.traverse(l,y=>{const {childrenLoaded:E}=y;if(0===E)return!1;var k=p.getAndUpdateVisibilityObbInRenderSR(y),n=null;let v=-1;if(k){if(v=k.radius,!k.intersectSphereWithMBS(a,v))return!1}else(n=p.getServiceMbsInRenderSR(y))&&(v=n[3]);if(0<=v&&q>=1*v)return null!=k?ta(b,k,u):null!=
n&&0<=n[3]&&Qa(b,n,u),!1;P.elevationRangeMin=Infinity;P.elevationRangeMax=-Infinity;if(null!=k||null!=n)if(null!=k?ta(P,k,u):null!=n&&Qa(P,n,u),P.elevationRangeMin>=b.elevationRangeMin&&P.elevationRangeMax<=b.elevationRangeMax)return!1;if(k=m.get(y.index))if({geometryObbInRenderSR:y}=y,!y||y.intersectSphereWithMBS(a)){if(y&&q>0*y.radius)return ta(b,y,u),!1;({objectHandle:y}=k);n=f.getObjectTransform(y);n=d.getAltitude(n.position);f.expandRangeWithComponentObjectElevationRange(y,n,e,b)}return 0<E-
(k?1:0)});return b}computeVisibilityObb(a){return x.computeVisibilityObb(a,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(a,b,c){var d=b.geometryData.geometries??[];const e=Array(d.length);for(var f=0;f<d.length;++f)e[f]=this._getVertexBufferLayout(d[f],b.geometryDescriptor);d=a.serviceMbsInIndexSR;f=this.elevationOffset;var g=this._controller.crsIndex,l=this._controller.crsVertex,
m=this.view.renderSpatialReference;const q=qa.getLocalOrigin(d,f,g),p=qa.computeGlobalTransformation(d,f,g,m);g=Ca.getProjectorName(g,l);l=Ca.getProjectorName(l,m);if(null==g||null==l)return Promise.resolve(null);m=this.i3slayer.normalReferenceFrame;return this._worker.invoke({context:this.uid,geometryBuffer:b.geometryBuffer,geometryData:b.geometryData,geometryDescriptor:b.geometryDescriptor,layouts:e,localOrigin:q,globalTrafo:p,mbs:d,obbData:a.serviceObbInIndexSR?.data,elevationOffset:f,needNormals:this._needsNormals&&
this._controller.isMeshPyramid,normalReferenceFrame:b.normalReferenceFrame??m??"none",indexToVertexProjector:g,vertexToRenderProjector:l},c)}get _supportsNodeCrossFading(){return!this.view?._stage?.renderer.shadowsEnabled}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(0<this.lodCrossfadeinDuration||0<this.lodCrossfadeoutDuration||0<this.lodCrossfadeUncoveredDuration)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&0<this.lodCrossfadeoutDuration}_setNewNodeOpacity(a){this._setNodeOpacity(a,
this.nodeCrossfadingEnabled?0:this.fullOpacity)}addCachedGPUData(a,b,c){this.elevationInfo.mode===r.ElevationMode.Absolute&&(a.geometryObbInRenderSR=this._collection.getComponentObb(b.objectHandle).clone());this._controller.isGeometryVisible(a)?(null!=this._labeler&&this._addMetaToLabeler(this._labeler,b),a=a.index,this._addNodeMeta(a,b),this.updateNodeState(a,c),this._collection.setObjectVisibility(b.objectHandle,!0),this._updateMaterial(b),this._setNewNodeOpacity(b),this.elevationInfo.mode!==r.ElevationMode.Absolute&&
this._ensureElevationTask().schedule(a),this._updateEngineObject(b),this._highlights.objectCreated(b),null!=this._treeDebugger&&this._treeDebugger.update()):this._cacheGPUData(b)}addCachedNodeData(a,b,c,d){return this._addData(a,c,()=>this._addCachedNodeData(a,b,d))}async deleteCachedNodeData(a){if(this._idbCacheEnabled)return this._idbCache.remove(this._getCacheKey(a))}async _addCachedNodeData(a,b,c){if(this.contentVisible&&this._controller.isGeometryVisible(a))if(null==b)this._addNodeMeta(a.index,
null);else{var d=this._addTasks.get(a.index),{geometryData:e,transformedGeometry:f,globalTrafo:g}=b;await this.i3sOverrides.applyAttributeOverrides(e.featureIds,d.attributeInfo,c,this._controller.requiredAttributes);var l=null!=b.textureData?b.textureData.filter(A=>null!=A&&0!==(A.usage&this.rendererTextureUsage)):[];!na("disable-feature:i3s-basis")&&l.some(A=>null!=A&&(A.encoding===K.TextureEncoding.Basis||A.encoding===K.TextureEncoding.KTX2))&&await Ka.loadBasis();a.memory=0;var {componentOffsets:m,
geometries:q,featureIds:p,anchorIds:u,anchors:y}=e,E=this._collection,k=q[0],{layout:n,indices:v,interleavedVertexData:C,positionData:M,hasColors:Tb}=f,{material:ka,geometryParameters:Va}=this._materialParameters(k,n),ba=m||new Uint32Array([0,v?v.length:C.byteLength/n[0].stride]);ba={vertices:{data:C,count:C.byteLength/n[0].stride,layoutParameters:Va},positionData:{positions:pb.compactFloatArray(M.data),indices:qb.compactIndices(M.indices)},indices:v,componentOffsets:ba};var Q=k.transformation?Ba.clone(k.transformation):
Ba.create();Aa.multiply(Q,g,Q);k=Aa.getTranslation(S.create(),Q);Q=gb.fromMat4(hb.create(),Q);var Wa=this.view.renderSpatialReference,Xa=this.view.basemapTerrain.spatialReference,ua=S.create(),va=[1,1,1];mb.localLinearScaleFactors(k,Wa,va,Xa)||H.getLogger("esri.views.3d.layers.I3SMeshView3D").errorOnce("Unsupported coordinate system for IM overlay");oa.projectVectorToVector(k,Wa,ua,Xa);var la=E.createObject({toMapSpace:kb.fromValues(ua[0],ua[1],va[0],va[1]),geometry:ba,obb:fa.Obb.fromData(b.geometryObbData),
transform:{position:k,rotationScale:Q}}),{textures:Ya,texturePromise:Ub}=this._initMaterialAndTextures(la,ka,l,Va.textureCoordinates===ha.TextureCoordinateAttributeType.Atlas);a.memory+=this._memEstimateGeometryAdded(la);a.memory+=Ya.reduce((A,J)=>A+(null!=J?this._memEstimateTextureAdded(J):0),0);l=!!ka.hasParametersFromSource;ba="blend"!==ka.alphaMode&&1<=ka.metallicRoughness.baseColorFactor[3];var B=new Qb(a,p,la,this._getInvalidRendererVersion(),d.attributeInfo,{hasParametersFromSource:l,isOpaque:ba},
Ya,u,y);d.meta=B;!this._hasTextures&&b.requiredTextures?.some(({usage:A})=>0!==(A&K.TextureUsage.ColorTextures))&&(this._hasTextures=!0);this._hasData=!0;this._hasColors=this._hasColors||Tb;this._hasTextures=this._hasTextures||!!a.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var Vb=this.slicePlaneEnabled;return Promise.all([this._addOrUpdateEdgeRendering(B),Ub]).then(([A])=>{null!=A&&A.updateObjectVisibility(B.objectHandle,!1).catch(J=>L(J,this.i3slayer.title));return this._safeReschedule(()=>
{var J=this._addTasks.get(a.index);if(J)if(this._addNodeMeta(a.index,B),J.meta=null,this.contentVisible){E.setObjectVisibility(la,!0);null!=A&&A.updateObjectVisibility(B.objectHandle,!0).catch(Wb=>L(Wb,this.i3slayer.title));B.attributeInfo=J.attributeInfo;J=B.cachedRendererVersion!==this._rendererVersion;var Xb=Vb!==this.slicePlaneEnabled;this._updateElevationOffsets(B);var Yb=B.elevationOffsets;this._updateComponentData(B);var Zb=this._applyFiltersToNode(B);(J||null!=A&&(Xb||Zb||Yb))&&this._addOrUpdateEdgeRendering(B);
null!=this._labeler&&this._addMetaToLabeler(this._labeler,B);this._visibleGeometryChanged(B,I.ADD);this._highlights.objectCreated(B);this._updateMaterial(B);this._setNewNodeOpacity(B);null!=this._treeDebugger&&this._treeDebugger.update()}else this._removeNodeStageData(a.index,this.elevationOffset)},c)}).catch(A=>{null!=d.meta&&(this._cacheGPUData(d.meta),d.meta=null);throw A;})}else this._removeNodeStageData(a.index,this.elevationOffset,this._nodeId2MetaReloading)}_addNodeMeta(a,b){this._removeNodeStageData(a,
this.elevationOffset,this._nodeId2MetaReloading);if(this._nodeId2Meta.has(a)){H.getLogger("esri.views.3d.layers.I3SMeshView3D").error("Removing duplicated node");const c=this._nodeId2Meta.get(a);null!=c&&this._deleteComponentObject(c)}else this._controller.updateLoadStatus(a,!0);null!=b&&(b.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&Y(b.cachedEdgeMaterials,0));this._nodeId2Meta.set(a,b);this.notifyChange("elevationRange")}_updateElevationOffsets(a){const b=this.view.renderSpatialReference,
c=this._controller.crsIndex,d=this.elevationInfo,e=this.view.basemapTerrain,f=e.spatialReference,g=d.mode;if(null==b||null==f||g===r.ElevationMode.Absolute)a.elevationOffsets=null;else{var l=this._collection.getObjectTransform(a.objectHandle);a.elevationOffsets=a.elevationOffsets??[];var m=g===r.ElevationMode.OnTheGround,q=this.view.renderCoordsHelper,p=a.featureIds.length,u=(()=>{if(a.cachedElevationAnchors)return a.cachedElevationAnchors;const k=Da.newDoubleArray(3*p);a.cachedElevationAnchors=k;
for(let n=0;n<p;n++){const v=3*n,C=a.anchorIds?.indexOf(n)??-1;a.anchors&&0<=C?(D.set(z,a.anchors[3*C],a.anchors[3*C+1],a.anchors[3*C+2]),D.add(z,z,V.getCenter(a.node.serviceMbsInIndexSR)),oa.projectVectorToVector(z,c,z,f),k[v]=z[0],k[v+1]=z[1],k[v+2]=q.getAltitude(z)):(this._collection.getComponentAabb(a.objectHandle,n,O,!0),D.set(z,(O[0]+O[3])/2,(O[1]+O[4])/2,O[2]),D.transformMat3(z,z,l.rotationScale),D.add(z,z,l.position),k[v+2]=q.getAltitude(z),oa.projectVectorToVector(z,b,z,f),k[v]=z[0],k[v+
1]=z[1])}return k})(),y=d.offset,E=a.elevationOffsets;e.getElevations(u,p,(k,n)=>{const v=m?u[3*k+2]:0;E[k]=y+(null!=n?n-v:0)})}}_ensureElevationTask(){return null!=this._elevationTask?this._elevationTask:this._elevationTask=new Db.I3SAsyncElevationUpdater(this.view.resourceController.scheduler,a=>{a=this._controller.updateElevationChanged(a,this.view.basemapTerrain.spatialReference);return null!=a?a.filterInPlace(b=>null!=this._nodeId2Meta.get(b)):null},a=>{a=this._nodeId2Meta.get(a);this._nodeElevationAlignmentChanged(a)},
()=>this.elevationInfo?.mode)}_elevationInfoChanged(a,b){const c=a.mode!==r.ElevationMode.Absolute;a=!!b&&b!==a&&b.mode!==r.ElevationMode.Absolute;this._intersectionHandler.updateElevationAlignState(c,this.view.state.viewingMode);c&&!a&&this._controller.removeAllGeometryObbs();this._nodeId2Meta.forEach(d=>this._nodeElevationAlignmentChanged(d))}_nodeElevationAlignmentChanged(a){null!=a&&(this._updateElevationOffsets(a),this._updateComponentData(a),this._updateEdgeRendering(a),null!=this._labeler&&
this._labeler.updateLabelPositions(a),this._updateSnappingSources(a,I.UPDATE))}_safeReschedule(a,b){R.throwIfAborted(b);return this._controller.reschedule(a,b)}_materialParameters(a,b){a=null!=a.params.material?a.params.material:W.defaultMaterial();const c=b.some(e=>"uvRegion"===e.name);b=b.some(e=>"normalCompressed"===e.name);const d=La(a);return{geometryParameters:this._getGeometryParameters({hasTexture:d,hasNormals:b,hasRegions:c}),material:a}}_initMaterialAndTextures(a,b,c,d){const e=this._stage.renderView,
f=c.map(l=>W.createTexture(l,b,d,e));this._stage.addMany(f);let g=null;this._collection.updateMaterial(a,l=>{g=W.configureMaterial(l,b,f,c,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference});this._updateMaterialOverlay(l)});return{textures:f,texturePromise:g}}_getGeometryParameters(a){return{textureCoordinates:a.hasTexture?
a.hasRegions?ha.TextureCoordinateAttributeType.Atlas:ha.TextureCoordinateAttributeType.Default:ha.TextureCoordinateAttributeType.None,colors:this._hasVertexColors,hasNormals:a.hasNormals&&this._needsNormals,needsNormals:this._needsNormals}}_addData(a,b,c){let d=this._addTasks.get(a.index);d?d.attributeInfo=b:(d={...R.createResolver(),attributeInfo:b,meta:null},this._addTasks.set(a.index,d),c().then(d.resolve,d.reject).then(()=>this._addTasks.delete(a.index)).catch(e=>{this._addTasks.delete(a.index);
throw e;}));return d.promise}_clearAddTasks(){this._addTasks.forEach(a=>{null!=a.meta&&(this._cacheGPUData(a.meta),a.meta=null)});this._addTasks.clear()}_clippingAreaChanged(){var a=this.view.renderSpatialReference;const b=this.i3slayer.spatialReference,c=U.create();this._renderClippingArea=Ja.toBoundingRect(this.view.clippingArea,c,a)?c:null;a=U.create();this._layerClippingArea=Ja.toBoundingRect(this.view.clippingArea,a,b)?a:null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea);
this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const a=this.hasGeometryFilter;this._controller.geometryFilterChanged(a);this._applyFilters(a)}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(a){this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(b=>{null!=b&&this._applyFiltersToNode(b)&&(this._addOrUpdateEdgeRendering(b),this._visibleGeometryChanged(b,I.UPDATE))})}getFilters(){const a=
[],b=this._renderClippingArea;null!=b&&a.push((c,d)=>this._boundingRectFilter(c,d,b));return a}addSqlFilter(a,b,c){if(null!=b){const d=b.fieldNames;a.push((e,f)=>this._sqlFilter(e,f,b,d,c))}}_sqlFilter(a,b,c,d,e){const f={},g=this._createLayerGraphic(f),l=this.i3slayer.objectIdField,m=b.featureIds,q=b.attributeInfo?.attributeData;d.every(p=>p===l||null!=q?.[p])&&x.filterInPlace(a,m,p=>{f[l]=m[p];for(const u of d)u!==l&&(f[u]=q?x.getCachedAttributeValue(q[u],p):null);try{return c.testFeature(g)}catch(u){return e(u),
!1}})}_boundingRectNodeTest(a,b){nb.projectBoundingSphere(a.node.serviceMbsInIndexSR,this._controller.crsIndex,Ua,this.view.renderSpatialReference);return x.intersectBoundingRectWithMbs(b,Ua)}_boundingRectFeatureTest(a,b,c){this._collection.getComponentAabb(a.objectHandle,b,Sa);T.toRect(Sa,Ta);return U.intersects(c,Ta)}_boundingRectFilter(a,b,c){var d=this._collection;const e=this._boundingRectNodeTest(b,c);if(e!==x.MbsIntersectResult.INSIDE)if(e===x.MbsIntersectResult.OUTSIDE)a.length=0;else if(d=
d.getComponentCount(b.objectHandle),d.invisible+d.visible===b.featureIds.length){var f=this._transformClippingArea(Rb,c,b.objectHandle);x.filterInPlace(a,b.featureIds,g=>this._boundingRectFeatureTest(b,g,f))}}_transformClippingArea(a,b,c){var d=this._collection.getObjectTransform(c);c=d.position;d=d.rotationScale;a[0]=(b[0]-c[0])/d[0];a[1]=(b[1]-c[1])/d[4];a[2]=(b[2]-c[0])/d[0];a[3]=(b[3]-c[1])/d[4];return a}_addOrUpdateEdgeRendering(a,b=!0){const c=this._edgeView;if(null==c)return Promise.resolve(null);
const d=a.objectHandle;var e=c.hasObject(d);const {hasEdges:f,perFeatureEdgeMaterials:g}=this._getFilteredEdgeMaterials(a),l={hasSlicePlane:this.slicePlaneEnabled};if(f&&e)return this.nodeCrossfadingEnabled&&(e=this.getNodeOpacity(a),Y(g,e)),c.updateAllComponentMaterials(d,g,l,b).catch(m=>L(m,this.i3slayer.title)),c.updateObjectVisibility(d,!0).catch(m=>L(m,this.i3slayer.title)),c.updateAllVerticalOffsets(d,a.elevationOffsets).catch(m=>L(m,this.i3slayer.title)),Promise.resolve(c);if(f&&!e)return this._collection.addEdges(d,
c,g,l).then(m=>{a.edgeMemoryUsage=m;a.node.memory+=m;c.updateAllVerticalOffsets(d,a.elevationOffsets).catch(q=>L(q,this.i3slayer.title));return c});!f&&e&&(a.node.memory-=a.edgeMemoryUsage,a.edgeMemoryUsage=0,c.removeObject(d));return Promise.resolve(null)}_applyFiltersToNode(a){return this._applyFiltersToNodeComponents(a)?(null!=this._labeler&&this._labeler.applyFilterChange(a),!0):!1}_applyFiltersToNodeComponents(a){const b=this._collection;var c=b.getComponentCount(a.objectHandle),d=null!=a.filteredIds;
c=0===c.invisible;b.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!c;this._updateCachedFilteredIds(a);if(d&&a.filteredIds===a.featureIds)return!c;d=this._computeFilteredComponentIndices(a);b.setAllComponentVisibilities(a.objectHandle,d);return!0}_updateCachedFilteredIds(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters}_computeFilteredIds(a){const b=a.featureIds.slice();
for(const c of this._filters)if(c(b,a),0===b.length)break;return b.length===a.featureIds.length?a.featureIds:b}_computeFilteredComponentIndices(a){const b=[],c=a.filteredIds;null!=c&&a.featureIds.forEach((d,e)=>{c[b.length]===d&&b.push(e)});return b}_removeAllNodeDataFromStage(a=this.elevationOffset){this._nodeId2Meta.forEach((b,c)=>this._removeNodeStageData(c,a));this._nodeId2MetaReloading.forEach((b,c)=>this._removeNodeStageData(c,a,this._nodeId2MetaReloading));this._elevationTask=F.destroyMaybe(this._elevationTask)}removeNode(a){const b=
this.elevationOffset;this._removeNodeStageData(a,b);this._removeNodeStageData(a,b,this._nodeId2MetaReloading);null!=this._elevationTask&&this._elevationTask.remove(a)}_removeNodeStageData(a,b,c=this._nodeId2Meta){c.has(a)&&this._controller.updateLoadStatus(a,!1);const d=c.get(a);null==d?c.delete(a):(this._collection.setObjectVisibility(d.objectHandle,!1),null!=this._edgeView&&this._edgeView.hasObject(d.objectHandle)&&this._edgeView.updateObjectVisibility(d.objectHandle,!1).catch(e=>L(e,this.i3slayer.title)),
this._visibleGeometryChanged(d,I.REMOVE),null!=this._labeler&&this._labeler.removeNodeMeta(d),c.delete(a),this._highlights.objectDeleted(d),c===this._nodeId2Meta?(this._cacheGPUData(d,b),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(d)):this._deleteComponentObject(d),null!=this._treeDebugger&&this._treeDebugger.update())}_deleteComponentObject(a){null!=this._edgeView&&this._edgeView.removeObject(a.objectHandle);this._memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);
if(a.textures)for(const b of a.textures)this._memEstimateTextureRemoved(b),this._stage.remove(b)}updateNodeState(a,b){a=this._nodeId2Meta.get(a);null!=a&&this._collection.updateMaterial(a.objectHandle,c=>c.polygonOffsetEnabled=b===pa.NodeState.Hole)}updateNodeIndex(a,b){if(this._nodeId2Meta.has(a)){var c=this._nodeId2Meta.get(a);this._nodeId2Meta.delete(a);this._nodeId2Meta.set(b,c);this.notifyChange("elevationRange")}if(c=this._nodeId2MetaReloading.get(a))this._nodeId2MetaReloading.delete(a),this._nodeId2MetaReloading.set(b,
c)}_invalidateAllSymbols(){this._rendererVersion=x.addWraparound(this._rendererVersion,1);this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return x.addWraparound(this._rendererVersion,-1)}async _rendererChange(a){this._currentRenderer=a;this.notifyChange("rendererTextureUsage");this._rendererVersion=x.addWraparound(this._rendererVersion,1);this._opacityVariable=this._colorVariable=this._rendererFields=null;this._invalidateAllSymbols();a&&(this._rendererFields=await a.getRequiredFields(this.i3slayer.fieldsIndex));
this._updateSymbologyFields();!this._arcade&&a&&"arcadeRequired"in a&&a.arcadeRequired&&(this._arcade=await wb.loadArcade());if(a&&"visualVariables"in a&&a.visualVariables)for(const b of a.visualVariables)"color"===b.type?this._colorVariable=b:"opacity"===b.type?this._opacityVariable=b:H.getLogger("esri.views.3d.layers.I3SMeshView3D").warn(`Unsupported visual variable type for 3D Object Scene Services: ${b.type}`);if(a)for(const b of a.getSymbols())"mesh-3d"!==b.type&&H.getLogger("esri.views.3d.layers.I3SMeshView3D").error(`Symbols of type '${b.type}' are not supported for 3D Object Scene Services.`);
this._controller&&this._controller.requestUpdate()}_getCachedEdgeMaterials(a){this._hasComponentData&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedEdgeMaterials}_getComponentParameters(a){this._hasComponentData&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);const b=a.cachedSymbology;return(c,d)=>{const e=5*c;jb.set(d.externalColor,b[e]/255,b[e+1]/255,b[e+2]/255,b[e+3]/255);if(null!=this._stage.renderView.objectAndLayerIdRenderHelper){const f=
a.featureIds[c],g=xb.isBasemapLayer(this.view.map,this.layerUid);this._stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(f,f,this.layerId,this.layerUid+"_"+this.sublayerId,this.layerPopupEnabledAndHasTemplate&&!g,a.node.resources.attributes,c,this.sublayerId);d.objectAndLayerIdColor=this._stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerUid:this.layerUid+"_"+this.sublayerId})}d.externalColorMixMode=b[e+4]&(1<<N.CastShadows)-1;d.castShadows=0!==(b[e+4]&1<<N.CastShadows);
d.pickable=0!==(b[e+4]&1<<N.Pickable);d.elevationOffset=a.elevationOffsets?.[c]??0}}_getSymbolInfo(a,b){b=a?.getSymbol(b,{arcade:this._arcade});if(!(b instanceof yb))return null;a=b.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);b=x.getSymbolInfo(b);this._symbolInfos.set(a,b);return b}_setSymbologyOverride(a,b){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=b,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=
null!=this._symbologyOverrideFields&&0<this._symbologyOverrideFields.length?null!=this._rendererFields&&0<this._rendererFields.length?ub.fixFields(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasComponentData){var b=this._tmpAttributeOnlyGraphic,c={};b.attributes=c;var d=this._currentRenderer,e=a.attributeInfo?.attributeData,
f=null!=a.featureIds?this.i3slayer.objectIdField:null,g=null!=e&&null!=this._symbologyFields&&0<this._symbologyFields.length,l=null,m=null;if(g&&null!=this._symbologyFields){l=[];m=[];for(var q of this._symbologyFields){var p=e[q];p&&(l.push(q),m.push(p))}}a.cachedSymbology||(a.cachedSymbology=rb.newUByteArray(5*a.featureIds.length));e={color:Z,castShadows:!0,pickable:!0,colorMixMode:ea.ColorMixModeEnum.Multiply,edgeMaterial:null};q=this.fullOpacity;q=this.nodeCrossfadingEnabled?this.getNodeOpacity(a):
q;p=null;var u=ia.Transparency.OPAQUE,y=x.transparentEdgeMaterial,E=0;for(let C=0;C<a.featureIds.length;C++){null!=f&&(c[f]=a.featureIds[C]);if(g&&l)for(var k=0;k<l.length;k++)c[l[k]]=x.getCachedAttributeValue(m[k],C);var n=d?this._getSymbolInfo(d,b):null;let M=k=null;if(d&&"visualVariables"in d){if(this._colorVariable){var v=Ea.getColor(this._colorVariable,b,{color:Sb,arcade:this._arcade});v&&(k=Z,k[0]=v.r/255,k[1]=v.g/255,k[2]=v.b/255,this._opacityVariable||null===v.a||(M=v.a))}this._opacityVariable&&
(M=Ea.getOpacity(this._opacityVariable,b,{arcade:this._arcade}))}n?.material&&(v=n.material,k=null==k||null==M?Ha.overrideColor(k,M,v.color,v.alpha,Ra,Z):Ha.overrideColor(k,M,null,null,Ra,Z));null==k&&(k=Z,k[0]=1,k[1]=1,k[2]=1,k[3]=1);e.pickable=!0;e.castShadows=n?n.castShadows:!0;e.colorMixMode=n?.material?n.material.colorMixMode:ea.ColorMixModeEnum.Multiply;e.edgeMaterial=n?n.edgeMaterial:null;null!=this._symbologyOverride&&(e.color=k,this._symbologyOverride(b,e),k=e.color);null!=this._nodeColorOverride&&
(this._nodeColorOverride(a.node,k),e.colorMixMode=ea.ColorMixModeEnum.Replace);if(null!=e.edgeMaterial){n=0>=k[3]?ia.Transparency.INVISIBLE:1<=k[3]&&(a.material.isOpaque||e.colorMixMode===ea.ColorMixModeEnum.Replace)?ia.Transparency.OPAQUE:ia.Transparency.TRANSPARENT;if(e.edgeMaterial!==p||n!==u)y={...e.edgeMaterial,opacity:q,objectTransparency:n},p=e.edgeMaterial,u=n;a.cachedEdgeMaterials[C]=y}else a.cachedEdgeMaterials[C]=x.transparentEdgeMaterial;a.cachedSymbology[E++]=Math.round(255*k[0]);a.cachedSymbology[E++]=
Math.round(255*k[1]);a.cachedSymbology[E++]=Math.round(255*k[2]);a.cachedSymbology[E++]=Math.round(255*k[3]);a.cachedSymbology[E++]=e.colorMixMode|+e.castShadows<<N.CastShadows|+e.pickable<<N.Pickable}}}_getFilteredEdgeMaterials(a){var b=this._getCachedEdgeMaterials(a);this.nodeCrossfadingEnabled||Y(b,this.fullOpacity);const c=a.filteredIds;if(null==c)return{hasEdges:b.some(f=>f!==x.transparentEdgeMaterial),perFeatureEdgeMaterials:b};let d=0,e=!1;b=b.map((f,g)=>{if(a.featureIds[g]!==c[d])return x.transparentEdgeMaterial;
e=e||f!==x.transparentEdgeMaterial;d++;return f});return{hasEdges:e,perFeatureEdgeMaterials:b}}_updateComponentData(a){if(this._hasComponentData){var b=a.objectHandle;a=this._getComponentParameters(a);this._collection.setComponentData(b,a);this._stage.renderView.requestRender()}}_reloadAll(a=this.elevationOffset){this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(a){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading();
this._nodeId2Meta.forEach(b=>{null!=b&&(this._collection.updateMaterial(b.objectHandle,c=>c.objectOpacity=a),Y(b.cachedEdgeMaterials,a),this._updateEdgeRendering(b))})}_updateMaterial(a){this._collection.updateMaterial(a.objectHandle,b=>{b.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled;b.usePBR=this._usePBR;this._updateMaterialOverlay(b)})}_updateMaterialOverlay(a){}_updateEngineObject(a){this._updateComponentData(a);this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);this._visibleGeometryChanged(a,
I.UPDATE)}_slicePlaneEnabledChange(a){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=a);null!=this._labeler&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(b=>{null!=b&&(this._collection.updateMaterial(b.objectHandle,c=>c.commonMaterialParameters.hasSlicePlane=a),this._updateEdgeRendering(b,!1))})}_updatePBR(a){this._nodeId2Meta.forEach(b=>{null!=b&&this._collection.updateMaterial(b.objectHandle,c=>c.usePBR=a)});this._hasLoadedPBRTextures=!0}get _usePBR(){return this._needsNormals&&
this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(a,b=!0){null!=this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,b)}_forAllNodes(a){this._nodeId2Meta.forEach(a)}_ignoreClientNodeOverriddenFeatures(a){return this.i3sOverrides.hasGeometryChanges?(b,c,d)=>0<=d.node.index&&this.i3sOverrides.featureHasGeometryChanges(b)?r.ForAllFeaturesReturnType.CONTINUE:a(b,c,d):a}_forAllFeatures(a,b,c){xa.someMap(this._nodeId2Meta,d=>{if(null==d)return!1;
if(null!=b)switch(b(d)){case r.ForAllFeaturesReturnType.EXIT:return!0;case r.ForAllFeaturesReturnType.SKIP:return!1}let e=r.ForAllFeaturesReturnType.CONTINUE;switch(c){case r.ForAllFeaturesMode.ALL:e=this._forAllFeaturesOfNode(d,a);break;case r.ForAllFeaturesMode.VISIBLE_ONLY:e=this._forAllVisibleFeaturesOfNode(d,a);break;case r.ForAllFeaturesMode.QUERYABLE:e=this._forAllQueryableFeaturesOfNode(d,a)}return e===r.ForAllFeaturesReturnType.EXIT})}_forAllFeaturesOfNode(a,b){let c=r.ForAllFeaturesReturnType.CONTINUE;
const d=a.featureIds;for(let e=0;e<d.length&&(c=b(d[e],e,a),c!==r.ForAllFeaturesReturnType.EXIT);e++);return c}_forAllVisibleFeaturesOfNode(a,b){let c=r.ForAllFeaturesReturnType.CONTINUE;const d=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,e=>{c=b(d[e],e,a);return c===r.ForAllFeaturesReturnType.CONTINUE});return c}_forAllQueryableFeaturesOfNode(a,b){b=this._ignoreClientNodeOverriddenFeatures(b);if(null==this._renderClippingArea)return this._forAllFeaturesOfNode(a,b);var c=
this._boundingRectNodeTest(a,this._renderClippingArea);if(c===x.MbsIntersectResult.OUTSIDE)return r.ForAllFeaturesReturnType.CONTINUE;if(c===x.MbsIntersectResult.INSIDE)return this._forAllFeaturesOfNode(a,b);c=r.ForAllFeaturesReturnType.CONTINUE;const d=a.featureIds,e=x.getClipRect(this._renderClippingArea,this._collection.getObjectTransform(a.objectHandle));for(let f=0;f<d.length;f++){if(!this._boundingRectFeatureTest(a,f,e))continue;const g=b(d[f],f,a);if(g===r.ForAllFeaturesReturnType.EXIT)return g}return c}_createAttributes(a,
b){const c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=b.attributeInfo?.attributeData;if(null!=b)for(const d of Object.keys(b))c[d]=x.getCachedAttributeValue(b[d],a);return c}_createGraphic(a,b){return this._createLayerGraphic(this._createAttributes(a,b))}highlight(a){"number"===typeof a?a=[a]:a instanceof ca?a=[a]:a instanceof bb&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof ca){const b=this.i3slayer.fieldsIndex,c=this._getObjectIdField();a=a.map(f=>
ra.attributeLookup(b,f.attributes,c));const {set:d,handle:e}=this._highlights.acquireSet();this._highlights.setFeatureIds(d,a);return e}if("number"===typeof a[0]){const {set:b,handle:c}=this._highlights.acquireSet();this._highlights.setFeatureIds(b,a);return c}}return cb.makeHandle()}resetHighlights(){F.destroyMaybe(this._highlights);this._highlights=new Cb({collection:this._collection,forAllFeatures:a=>this._forAllFeatures(a,null,r.ForAllFeaturesMode.ALL),forAllFeaturesOfNode:(a,b)=>this._forAllFeaturesOfNode(a,
b)})}_visibleGeometryChanged(a,b){if(this._elevationProvider){var c=this.getNodeComponentObb(a.node);c&&this._elevationProvider.objectChanged(c);null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=eb.schedule(()=>{this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle=null}));this._updateSnappingSources(a,b)}}get performanceInfo(){return new Ab.I3SMeshViewPerformanceInfo(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/
1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}get test(){const a=this,b=c=>{this._nodeColorOverride=c;this._invalidateAllSymbols()};return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const c=[];a._forAllFeatures(d=>{c.push(d);return r.ForAllFeaturesReturnType.CONTINUE},null,r.ForAllFeaturesMode.VISIBLE_ONLY);c.sort((d,
e)=>d-e);return c},get numNodes(){return a._nodeId2Meta.size},get loadedNodes(){return Array.from(a._nodeId2Meta.keys()).sort((c,d)=>c-d)},setNodeColorOverride:b,setNodeColoring:c=>{switch(c){case "client-nodes":b((d,e)=>{0>d.index?(e[0]=1,e[1]=0,e[2]=0):(e[0]=1,e[1]=1,e[2]=1)});break;default:b(null)}}}}getNodeOpacityByIndex(a){a=this._nodeId2Meta.get(a);return this.getNodeOpacity(a)}getNodeOpacity(a){return null!=a?this._collection.getMaterial(a.objectHandle).objectOpacity:0}isNodeFullyFadedIn(a){return this._crossfadeHelper.isNodeFullyFadedIn(a)}getNodeCrossfadeMetaData(a){return this._nodeId2Meta.get(a)}markNodeToRemove(a){this._controller&&
this._controller.markNodeToRemove(a)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(a){this._nodeId2Meta.forEach(a)}fadeNode(a,b,c){if(this.nodeCrossfadingEnabled){var d=this._nodeId2Meta.get(a);null!=d&&this._crossfadeHelper.fadeNode(a,d,b,c)}}setNodeOpacityByIndex(a,b){a=this._nodeId2Meta.get(a);null!=a&&this._setNodeOpacity(a,b)}_setNodeOpacity(a,b){this._collection.updateMaterial(a.objectHandle,c=>c.objectOpacity=b);this._setNodeEdgeOpacity(a,b)}_setNodeEdgeOpacity(a,
b){null!=this._edgeView&&a.cachedEdgeMaterials&&(Y(a.cachedEdgeMaterials,b),a=a.objectHandle,this._edgeView.hasObject(a)&&this._edgeView.updateAllComponentOpacities(a,b).catch(c=>L(c,this.i3slayer.title)))}get hasModifications(){return this._isIntegratedMesh&&null!=this._layerClippingArea||this._modifications&&0<this._modifications.length}updateNodeModificationStatus(a){var b=a.length;if(this.hasModifications&&!(0>=b)&&!0===this._i3sWasmLoaded){b=this.uid;var c=Ob(a);if(c){da.filterObbsForModificationsSync({context:b,
buffer:c.buffer});const d=new Float64Array(c.buffer);a.forAll((e,f)=>{f=da.interpretObbModificationResults(d[f]);e.imModificationImpact=f;f!==pa.NodeIMModificationImpact.Unmodified&&this._controller.invalidateGeometryVisibility(e.index)})}}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||null!=this._labeler&&this._labeler.updating||this._crossfadeHelper?.updating||
this._i3sWasmLoaded instanceof Promise||0<this._asyncModuleLoading||null!=this._elevationTask&&this._elevationTask.running}trackSnappingSources(a){const b={events:a,fetchEdgeLocations:async(c,d,e)=>{c=this._nodeId2Meta.get(c);if(null==c)throw Error("invalid-node");const {origin:f,buffer:g}=await this._collection.extractEdgeInformation(c.objectHandle,d,e);this._snappingLocationsApplyElevation(c,g,f);return{type:"components",objectIds:c.featureIds,locations:g,origin:f}},remove:()=>wa.removeUnordered(this._snappingSourcesTrackers,
b)};this._snappingSourcesTrackers.push(b);this._nodeId2Meta.forEach((c,d)=>{null!=c&&(c=this._controller.getRenderMbs(c.node))&&a.add(d,c)});return b}_snappingLocationsApplyElevation(a,b,c){if(a.elevationOffsets&&this.elevationInfo.mode!==r.ElevationMode.Absolute){var d=b.position0,e=b.position1;b=b.componentIndex;var f=S.create(),g=S.create(),l=(m,q)=>{D.add(m,m,c);this.view.renderCoordsHelper.worldUpAtPosition(m,g);D.add(m,m,D.scale(g,g,q));D.subtract(m,m,c)};for(let m=0;m<d.count;m++){const q=
a.elevationOffsets[b.get(m)];d.getVec(m,f);l(f,q);d.setVec(m,f);e.getVec(m,f);l(f,q);e.setVec(m,f)}}}_updateSnappingSources(a,b){const {index:c}=a.node;a=this._controller.getRenderMbs(a.node);if(null!=a)for(const d of this._snappingSourcesTrackers)b!==I.REMOVE&&b!==I.UPDATE||d.events.remove(c),b!==I.ADD&&b!==I.UPDATE||d.events.add(c,a)}};t.__decorate([w.property()],h.prototype,"_hasLoadedPBRTextures",void 0);t.__decorate([w.property()],h.prototype,"_asyncModuleLoading",void 0);t.__decorate([w.property()],
h.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);t.__decorate([w.property()],h.prototype,"view",void 0);t.__decorate([w.property()],h.prototype,"i3slayer",void 0);t.__decorate([w.property()],h.prototype,"_controller",void 0);t.__decorate([w.property()],h.prototype,"_labeler",void 0);t.__decorate([w.property()],h.prototype,"updating",void 0);t.__decorate([w.property()],h.prototype,"suspended",void 0);t.__decorate([w.property()],h.prototype,"contentVisible",null);t.__decorate([w.property({readOnly:!0})],
h.prototype,"legendEnabled",null);t.__decorate([w.property()],h.prototype,"holeFilling",void 0);t.__decorate([w.property(Kb.updatingProgress)],h.prototype,"updatingProgress",void 0);t.__decorate([w.property()],h.prototype,"updatingProgressValue",null);t.__decorate([w.property()],h.prototype,"hasTexturesOrVertexColors",null);t.__decorate([w.property()],h.prototype,"rendererTextureUsage",null);t.__decorate([w.property()],h.prototype,"elevationOffset",null);t.__decorate([w.property()],h.prototype,"elevationInfo",
null);t.__decorate([w.property({type:Boolean})],h.prototype,"slicePlaneEnabled",void 0);t.__decorate([w.property()],h.prototype,"supportedTextureEncodings",null);t.__decorate([w.property()],h.prototype,"uncompressedTextureDownsamplingEnabled",null);t.__decorate([w.property({type:[vb]})],h.prototype,"_modifications",void 0);t.__decorate([w.property({readOnly:!0})],h.prototype,"clientGeometry",null);t.__decorate([w.property()],h.prototype,"elevationRange",null);t.__decorate([w.property()],h.prototype,
"fullExtent",null);t.__decorate([w.property()],h.prototype,"_elevationTask",void 0);t.__decorate([w.property({readOnly:!0})],h.prototype,"_usePBR",null);return h=t.__decorate([fb.subclass("esri.views.3d.layers.I3SMeshView3D")],h)};ma.makeScheduleFunction=Pa;Object.defineProperty(ma,Symbol.toStringTag,{value:"Module"})});