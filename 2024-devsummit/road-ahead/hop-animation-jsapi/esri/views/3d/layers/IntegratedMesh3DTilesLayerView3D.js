// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/mat3 ../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../core/libs/gl-matrix-2/math/mat4 ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../geometry/ellipsoidUtils ../../../geometry/projection/computeTranslationToOriginAndRotation ../../../geometry/projection/localLinearScaleFactors ../../../geometry/projection/projectVectorToVector ../../../geometry/support/buffer/BufferView ../../../layers/ILyr3DWasmPerSceneView ../../../symbols/support/unitConversionUtils ../../ViewingMode ./IntegratedMesh3DTilesViewPerformanceInfo ./interfaces ./LayerView3D ./Lyr3DWasm ./i3s/LayerElevationProvider ./support/lyr3dTypeConversions ./support/Tiles3DIntersectionHandler ../support/ElevationRange ../support/orientedBoundingBox ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/collections/Component/Material/ComponentMaterial ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/attributes/TextureCoordinateAttribute.glsl ../webgl-engine/core/shaderLibrary/util/EllipsoidMode ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Normals ../webgl-engine/lib/Texture ../webgl-engine/lib/VertexAttribute ../webgl-engine/materials/internal/bufferWriterUtils ../../layers/LayerView".split(" "),
function(Q,R,U,ca,S,V,F,Ca,da,W,J,X,Y,Z,K,ea,fa,ha,ia,ja,v,e,aa,ka,la,ma,na,C,oa,D,pa,qa,ra,sa,ta,ua,ba,va,L,G,wa,xa,M,ya,za){var p;(function(a){a[a.API=1]="API";a[a.VerboseAPI=2]="VerboseAPI";a[a.Error=3]="Error"})(p||={});class Aa{constructor(){this.isVisible=!1;this.components=[];this.cpuMemoryUsage=this.vboMemoryUsage=this.texMemoryUsage=0;this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}F=class extends na.LayerView3D(za){constructor(){super(...arguments);
this.type="integrated-mesh-3dtiles";this._wasmLayerId=-1;this.ignoresMemoryFactor=!0;this.unloadedMemory=0;this.drapeTargetType=ma.DrapeTargetType.WithoutRasterImage;this._lyrHandleToObjects=new Map;this._initialCullFace=new Map;this._suspendedHandle=null;this._dbgFlags=new Set}initialize(){this._dbgFlags.add(p.Error);this._dbg(p.VerboseAPI,"Tiles3DLayerView3D initialize() called");if(!this._canProjectWithoutEngine())throw new R("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",
{});const a=C.addLayerViewToWasm(this).then(b=>{this._intersectionHandler=new pa.Tiles3DIntersectionHandler(this);this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler);this._updatingHandles.add(()=>this.slicePlaneEnabled,k=>this._slicePlaneEnabledChange(k));this._elevationProvider=new oa.LayerElevationProvider({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler});this.view.elevationProvider.register("im",this._elevationProvider);this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);
this._wasmLayerId=b;this._suspendedHandle=S.watch(()=>this.suspended,k=>{const q=C.getLyr3DWasm(this.view);q&&q.setEnabled(this,!k)},S.initial);this.addHandles([S.watch(()=>this.layer.elevationInfo,k=>this._elevationInfoChanged(k))])}).catch(b=>{C.removeLayerViewFromWasm(this);this._wasmLayerId=-1;if(b===e.invalidLayerView)throw new R("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(b===e.wasmFailedToInit)throw new R("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",
{});});this.addResolvingPromise(a)}destroy(){this._dbg(p.VerboseAPI,"Tiles3DLayerView3D destroy() called");C.removeLayerViewFromWasm(this);this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null);this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),
this._elevationProvider=null);this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this);this._lyrHandleToObjects.forEach(a=>this.freeObject(a));this._lyrHandleToObjects.clear();this._initialCullFace.clear();this._updatingHandles=ca.destroyMaybe(this._updatingHandles)}_slicePlaneEnabledChange(a){this.objects.forEach(b=>{const k=this._collection.getMaterial(b);k.commonMaterialParameters.hasSlicePlane=a;k.commonMaterialParameters.cullFace=a?G.CullFaceOptions.None:this._initialCullFace.get(b)})}_elevationInfoChanged(a){const b=
a?.offset??0;a=a?.unit?aa.getMetersPerUnit(a?.unit):1;const k=C.getLyr3DWasm(this.view);k&&k.setLayerOffset(this,b*a)}get _obbs(){return this.objects.map(a=>this._collection.getComponentObb(a))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let a=0;this._lyrHandleToObjects.forEach(b=>{a+=b.totalMemory()});return a}get performanceInfo(){let a=0,b=0,k=0,q=0,n=0,l=0;this._lyrHandleToObjects.forEach(f=>{f.isVisible?(a+=f.texMemoryUsage,b+=f.vboMemoryUsage,n++):(k+=f.texMemoryUsage,q+=f.vboMemoryUsage,
l++)});return new la.IntegratedMesh3DTilesViewPerformanceInfo(this.usedMemory,n,l,Math.round(b/1048.576)/1E3,Math.round(a/1048.576)/1E3,Math.round(q/1048.576)/1E3,Math.round(k/1048.576)/1E3)}_canProjectWithoutEngine(){if(this.view.state.viewingMode===ka.ViewingMode.Local){const a=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(3857!==a&&32662!==a)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){const a=
this.layer.elevationInfo?.offset??0,b=this.layer.elevationInfo?.unit?aa.getMetersPerUnit(this.layer.elevationInfo.unit):1;return a*b}get elevationRange(){const a=this.fullExtent;return a?.zmin&&a?.zmax?new qa.ElevationRange(a.zmin,a.zmax):null}getElevationRange(a){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((a,b)=>a.concat(b.components),[])}isUpdating(){const a=C.getLyr3DWasm(this.view);return 0>this._wasmLayerId||
null==a?!1:a.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(a){const b=a.meshData;if(null==b.data)throw Error("meshData.data undefined");b.desc=JSON.parse(b.desc);if(null==b.desc)throw Error("meshData.desc undefined");const k=K.fromArray(b.desc.origin);let q=0;const n=[],l=new Map,f=new Aa;this._lyrHandleToObjects.set(a.handle,f);b.desc.prims.forEach(m=>{this._dbg(p.VerboseAPI,JSON.stringify(m));if(null==D.primTypeConversion[m.ptype]||null==
b.data)this._dbg(p.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+m.ptype+"). Skipping primitive.");else{var w=this.view.basemapTerrain.spatialReference;if("global"===this.view.viewingMode){var t=Y.create();ha.computeTranslationToOriginAndRotation(fa.SphericalECEFSpatialReferenceLike,k,t,w);var g=W.fromMat4(J.create(),t);t=W.invert(J.create(),g)}else t=g=J.IDENTITY;var r=Y.create();X.translate(r,r,k);r=X.getTranslation(K.create(),r);var h=b.desc?.materials&&null!=m.materialId?b.desc.materials[m.materialId]:
null,A=null!=h?h.lightingModel:e.Lyr3DLightingModel.Unlit,d=A!==e.Lyr3DLightingModel.Unlit,{positionView:u,positionAttr:y,normalsView:B,normalsAttr:H,colorAttr:N,texCoord0Attr:O,indicesView:I}=this.getBufferViews(m,b.data.buffer,g,d);if(null!=y&&null!=u&&null!=I){d={colors:null!=N,textureCoordinates:null!=O?ba.TextureCoordinateAttributeType.Default:ba.TextureCoordinateAttributeType.None,hasNormals:null!=B,needsNormals:d};var Ba=y.data.length/y.size;m=(c,x)=>c&&c.data.length/c.size!==Ba?(this._dbg(p.Error,
`${x} !== numPos. Skipping primitive.`),!1):!0;if(m(O,"numTexcoord")&&m(N,"numColors")&&m(H,"normals")){var E=sa.createVertexBufferLayout(d),z=K.create();m=ra.compute(y);Z.add(z,m.center,k);m.center=z;if(g!==J.IDENTITY)for(let c=0;c<u.count;c++)u.getVec(c,z),Z.transformMat3(z,z,g),u.setVec(c,z);var T=E.createBuffer(y.data.length);g=new Map([[M.VertexAttribute.POSITION,y]]);null!=O&&g.set(M.VertexAttribute.UV0,O);null!=N&&g.set(M.VertexAttribute.COLOR,N);null!=H&&g.set(M.VertexAttribute.NORMALCOMPRESSED,
H);g.forEach((c,x)=>{null!=c&&ya.writeDefaultAttribute(x,c,null,null,T,0)});g=new Uint32Array([0,I.typedBuffer.length]);g={vertices:{data:T.buffer,count:T.byteLength/E.stride,layoutParameters:d},positionData:{positions:u.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:g};f.cpuMemoryUsage+=u.count;f.cpuMemoryUsage+=I.count;q+=g.vertices.count;d=this.view.renderSpatialReference;E=K.create();z=[1,1,1];ia.localLinearScaleFactors(r,d,z,w)||this._dbg(p.Error,"Unsupported coordinate system for IM overlay");
ja.projectVectorToVector(r,d,E,w);var P=this._collection.createObject({toMapSpace:ea.fromValues(E[0],E[1],z[0],z[1]),geometry:g,obb:m,transform:{position:r,rotationScale:t}});h&&this._collection.updateMaterial(P,c=>{c.baseColor=h.baseColorFactor;c.usePBR=A===e.Lyr3DLightingModel.Pbr;c.hasParametersFromSource=!1;c.baseColorTexture=this._getTexture(h.baseColorTex,b,l);c.usePBR&&(c.mrrFactors=[h.metallicFactor,h.roughnessFactor,0],c.emissiveFactor=h.emissiveFactor??[0,0,0],c.metallicRoughnessTexture=
this._getTexture(h.metalTex,b,l),c.emissionTexture=this._getTexture(h.emissiveTex,b,l),c.occlusionTexture=this._getTexture(h.occlusionTex,b,l),c.normalTexture=this._getTexture(h.normalTex,b,l));c.objectOpacity=0;c.alphaDiscardMode=G.AlphaDiscardMode.Mask;var x=[];c.baseColorTexture&&x.push(c.baseColorTexture.loadPromise);c.usePBR&&c.metallicRoughnessTexture&&x.push(c.metallicRoughnessTexture.loadPromise);c.usePBR&&c.emissionTexture&&x.push(c.emissionTexture.loadPromise);c.usePBR&&c.occlusionTexture&&
x.push(c.occlusionTexture.loadPromise);c.usePBR&&c.normalTexture&&x.push(c.normalTexture.loadPromise);x=Promise.all(x);n.push(x);x.then(()=>{c.alphaDiscardMode=D.alphaModeConversion[h.alphaMode];c.objectOpacity=1;f.texMemoryUsage+=c.baseColorTexture?.glTexture?.usedMemory||0;c.usePBR&&(f.texMemoryUsage+=c.metallicRoughnessTexture?.glTexture?.usedMemory||0,f.texMemoryUsage+=c.emissionTexture?.glTexture?.usedMemory||0,f.texMemoryUsage+=c.occlusionTexture?.glTexture?.usedMemory||0,f.texMemoryUsage+=
c.normalTexture?.glTexture?.usedMemory||0)});c.commonMaterialParameters.doubleSided=h.isDoubleSided;c.commonMaterialParameters.cullFace=h.faceCulling?D.faceCullingConversion[h.faceCulling]:G.CullFaceOptions.Back;this._initialCullFace.set(P,c.commonMaterialParameters.cullFace);c.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled;c.componentParameters.castShadows=ta.ComponentParameterSummary.All;c.textureAlphaCutoff=h.alphaCutoff??.1;c.alphaDiscardMode=D.alphaModeConversion[h.alphaMode];
c.isIntegratedMesh=!0;c.polygonOffsetEnabled=!1;c.hasOccludees=!1;c.ellipsoidMode=va.getEllipsoidMode(this.view.spatialReference)});f.components.push(P);f.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(P)}}}});await Promise.all(n);l.forEach(m=>{f.textures.push(m)});return{vertexCount:q,vbMemUsage:f.vboMemoryUsage,ibMemUsage:0,texMemUsage:f.texMemoryUsage}}freeRenderable(a){const b=this._lyrHandleToObjects.get(a);b&&(this.freeObject(b),this._lyrHandleToObjects.delete(a))}freeObject(a){a.components.forEach(b=>
{a.textures.forEach(k=>{this._stage.remove(k)});this._collection.destroyObject(b);this._initialCullFace.delete(b)})}setRenderableVisibility(a,b){if(a=this._lyrHandleToObjects.get(a))a.isVisible=b,a.components.forEach(k=>{this._collection.setObjectVisibility(k,b);this._elevationProvider.objectChanged(this._collection.getComponentObb(k))})}_getTexture(a,b,k){let q=null;if(a&&b.desc?.images&&b.data?.buffer){const l=b.desc.images[a?.imageId];q=k.get(l);if(!q&&l){const f=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,
m=1<f;a=D.wrapModeConversion[a.wrapMode??e.Lyr3DUvWrapMode.None];let w=l.alpha?4:3;var n=new Uint8Array(b.data.buffer,l.data.byteOffset,l.data.byteCount);let t=null,g=b=null;switch(l.format){case e.Lyr3DImageFormat.Raw:l.pixelFormat===e.Lyr3DPixelFormat.R8?(t=n.buffer,w=1,b=""):l.pixelFormat===e.Lyr3DPixelFormat.Rgb8?(t=n.buffer,w=3,b=""):l.pixelFormat===e.Lyr3DPixelFormat.Rgba8&&(t=n.buffer,w=4,b="");break;case e.Lyr3DImageFormat.Dxt1:t=n.buffer;w=3;b=G.TextureEncodingMimeType.DDS_ENCODING;break;
case e.Lyr3DImageFormat.Dxt5:t=n.buffer;w=4;b=G.TextureEncodingMimeType.DDS_ENCODING;break;case e.Lyr3DImageFormat.Png:b="image/png";g=document.createElement("img");break;case e.Lyr3DImageFormat.Jpeg:b="image/jpeg";g=document.createElement("img");break;case e.Lyr3DImageFormat.Etc2:b="image/ktx";g=document.createElement("img");break;case e.Lyr3DImageFormat.Astc:this._dbg(p.Error,"Astc texture not supported");break;case e.Lyr3DImageFormat.Pvrtc:this._dbg(p.Error,"Pvrtc texture not supported")}g&&b&&
(n=new Blob([n],{type:b}),g.src=URL.createObjectURL(n),t=g);t&&null!=b&&(q=new xa.Texture(t,{mipmap:m,maxAnisotropy:f,encoding:b,wrap:a,components:w,noUnpackFlip:!0,width:l.mip0Width,height:l.mip0Height}),this._stage.add(q),k.set(l,q))}}return q?new ua.RenderTexture(this.view._stage.renderView.textureRepository,q.id):null}getBufferViews(a,b,k,q){let n,l,f,m,w,t,g;a.atrbs.forEach(A=>{const d=A.view,u=d.byteOffset+d.byteCount,y=[...Array(d.byteCount/D.lyr3DTypeToByteSize[d.type]).keys()].map(B=>B);
try{switch(A.sem){case e.Lyr3DVtxAtrbSemantic.Position:3!==d.ncomp||d.type!==e.Lyr3DType.F32?this._dbg(p.Error,"[Unsupported Feature] Unsupported view for Position ("+d+")"):(n=new v.BufferViewVec3f(b,d.byteOffset,void 0,u),l=new L.Attribute(n.typedBuffer,y,3));break;case e.Lyr3DVtxAtrbSemantic.Normal:if(3!==d.ncomp||d.type!==e.Lyr3DType.F32)this._dbg(p.Error,"[Unsupported Feature] Unsupported view for Normal ("+d+")");else if(q){const B=new v.BufferViewVec3f(b,d.byteOffset,void 0,u),H=wa.compressAndTransformNormals(B.typedBuffer,
k);w=new v.BufferViewInt16(H);t=new L.Attribute(w.typedBuffer,y,2)}break;case e.Lyr3DVtxAtrbSemantic.TexCoord:2!==d.ncomp||d.type!==e.Lyr3DType.F32?this._dbg(p.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+d+")"):void 0===m&&(m=new L.Attribute((new v.BufferViewVec2f(b,d.byteOffset,void 0,u)).typedBuffer,y,2));break;case e.Lyr3DVtxAtrbSemantic.Color:4===d.ncomp?(d.type===e.Lyr3DType.F32&&(g=new v.BufferViewVec4f(b,d.byteOffset,void 0,u)),d.type===e.Lyr3DType.U8&&(g=new v.BufferViewVec4u8(b,
d.byteOffset,void 0,u)),d.type===e.Lyr3DType.U16&&(g=new v.BufferViewVec4u16(b,d.byteOffset,void 0,u))):3===d.ncomp&&(d.type===e.Lyr3DType.F32&&(g=new v.BufferViewVec3f(b,d.byteOffset,void 0,u)),d.type===e.Lyr3DType.U8&&(g=new v.BufferViewVec3u8(b,d.byteOffset,void 0,u)),d.type===e.Lyr3DType.U16&&(g=new v.BufferViewVec3u16(b,d.byteOffset,void 0,u)));null==g?this._dbg(p.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+d+")"):f=new L.Attribute(g.typedBuffer,y,d.ncomp);break;case e.Lyr3DVtxAtrbSemantic.FeatureIndex:break;
default:this._dbg(p.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+A.sem+"). Skipping vertex attribute.")}}catch(B){this._dbg(p.VerboseAPI,"Error Creating buffer ("+B+"). Skipping vertex attribute.")}});if(a.index){var r=a.index.view;const A=r.byteOffset+r.byteCount;switch(a.index.view.type){case e.Lyr3DType.U16:var h=new v.BufferViewUint16(b,r.byteOffset,void 0,A);break;case e.Lyr3DType.U32:h=new v.BufferViewUint32(b,r.byteOffset,void 0,A);break;default:this._dbg(p.Error,"[Unsupported Feature] index type not supported ("+
r.type+").")}}if(null==h&&null!=n)for(a=n.count,65535>a?(h=new Uint16Array(a),h=new v.BufferViewUint16(h)):(h=new Uint32Array(a),h=new v.BufferViewUint32(h)),r=0;r<a;r++)h.set(r,r);return{positionView:n,positionAttr:l,colorAttr:f,texCoord0Attr:m,indicesView:h,normalsView:w,normalsAttr:t}}_dbg(a,b){this._dbgFlags.has(a)&&(a===p.Error?U.getLogger(this).error(b):U.getLogger(this).warn(b))}};Q.__decorate([V.property()],F.prototype,"layer",void 0);Q.__decorate([V.property()],F.prototype,"elevationOffset",
null);return F=Q.__decorate([da.subclass("esri.views.3d.layers.Tiles3DLayerView3D")],F)});