// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/projection/projectBuffer ./elevationAlignmentUtils ../../support/debugFlags ../../support/ElevationProvider ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/VertexAttribute".split(" "),function(u,A,B,
C,x,D,I,E,y,J,F,z){function G(b,d,h,g,e){let f=!1;var a=b.transformation;d=d.requiresSampledElevationInfo;m[0]=a[12];m[1]=a[13];m[2]=a[14];b.invalidateBoundingInfo();var n=b.getMutableAttribute(z.VertexAttribute.POSITION);a=n.data;n=n.size;const q=a.length/n;b=new J.SamplePosition(b.mapPositions,h);let c=0,r=0;for(let v=0;v<q;v++){t[0]=a[c];t[1]=a[c+1];t[2]=a[c+2];g(b,k);d&&(r+=k.sampledElevation);if(y.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)a[c]=b.array[b.offset],a[c+1]=b.array[b.offset+1],a[c+2]=
k.z,I.projectBuffer(a,h,c,a,e.spatialReference,c,1),a[c]-=m[0],a[c+1]-=m[1],a[c+2]-=m[2],f=!0;else{l[0]=a[c]+m[0];l[1]=a[c+1]+m[1];l[2]=a[c+2]+m[2];e.setAltitude(l,k.z);a[c]=l[0]-m[0];a[c+1]=l[1]-m[1];a[c+2]=l[2]-m[2];const w=.01/e.unitInMeters;if(Math.abs(t[0]-a[c])>=w||Math.abs(t[1]-a[c+1])>=w||Math.abs(t[2]-a[c+2])>=w)f=!0}c+=n;b.offset+=3}return{update:f,averageGeometrySampledElevation:r/q}}const K=B.create(),l=x.create(),m=x.create(),t=x.create(),p=B.create(),H=x.create(),k=new E.SampleElevationInfo;
u.perLodInstanceElevationAligner=function(b,d,h,g,e){var f=b.graphics3DSymbolLayer.lodRenderer;if(null==f)return 0;h=d.centerPointInElevationSR;g(h,k);d="absolute-height"!==d.mode?k.sampledElevation:0;g=f.instanceData;b=b.instanceIndex;g.getGlobalTransform(b,p);f=C.set(H,p[12],p[13],p[14]);y.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(l[0]=h.x,l[1]=h.y,l[2]=k.z,D.computeTranslationToOriginAndRotation(h.spatialReference,l,p,e.spatialReference)&&g.setGlobalTransform(b,p)):e.setAltitudeOfTransformation(k.z,
p);e=.01/e.unitInMeters;(y.debugFlags.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(p[12]-f[0])>=e||Math.abs(p[13]-f[1])>=e||Math.abs(p[14]-f[2])>=e)&&g.setGlobalTransform(b,p);return d};u.perObjectElevationAligner=function(b,d,h,g,e,f){b=b.stageObject;const a=d.centerPointInElevationSR;h=0;b.usesVerticalDistanceToGround?(g(a,k),E.updateVertexPointGroundDistance(b,k.verticalDistanceToGround),h=k.sampledElevation):(g(a,k),"absolute-height"!==d.mode&&(h=k.sampledElevation));d=A.copy(K,f??b.transformation);
g=C.set(H,d[12],d[13],d[14]);y.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(l[0]=a.x,l[1]=a.y,l[2]=k.z,D.computeTranslationToOriginAndRotation(a.spatialReference,l,d,e.spatialReference)&&(f?A.copy(f,d):b.transformation=d)):e.setAltitudeOfTransformation(k.z,d);e=.01/e.unitInMeters;if(Math.abs(d[12]-g[0])>=e||Math.abs(d[13]-g[1])>=e||Math.abs(d[14]-g[2])>=e)f?A.copy(f,d):b.transformation=d;return h};u.perVertexElevationAligner=function(b,d,h,g,e){b=b.stageObject;const f=b.geometries;let a=0;for(const n of f){if(!F.isGeometryWithMapPositions(n))continue;
const {update:q,averageGeometrySampledElevation:c}=G(n,d,h,g,e);a+=c;q&&b.geometryVertexAttributeUpdated(n,z.VertexAttribute.POSITION)}return a/f.length};u.sharedGeometryElevationAligner=function(b,d,h,g,e){b=b.stageObject;const f=b.geometries;if(0===f.length)return 0;let a=0,n=null,q=0,c=!1;for(const r of f){if(!F.isGeometryWithMapPositions(r))continue;const v=r.attributes.get(z.VertexAttribute.POSITION);if(v!==n){const {update:w,averageGeometrySampledElevation:L}=G(r,d,h,g,e);q=L;n=v;c=w}c&&b.geometryVertexAttributeUpdated(r,
z.VertexAttribute.POSITION);a+=q}return a/f.length};Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});