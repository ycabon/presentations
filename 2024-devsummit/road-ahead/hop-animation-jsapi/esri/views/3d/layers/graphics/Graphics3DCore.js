// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../core/Logger ../../../../symbols ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/has ../../../../core/Error ../../../../core/handleUtils ../../../../core/MapUtils ../../../../core/maybe ../../../../core/MemCache ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection ../../../../geometry/projection/projectBuffer ../../../../geometry/projection/projectVectorToVector ../../../../geometry/projection/projectXYZToVector ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/PromiseQueue ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../support/basemapUtils ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./defaultSymbolComplexity ./DisplayFeatureLimit ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicsCorePerformanceInfo ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolMemory ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/UpdatePolicy ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/WebGLLayer ../../../layers/support/popupUtils ../../../support/Scheduler ../../../support/Yield ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(f,g,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,N,Wa,v,Xa,aa,O,Ya,C,ba,P,t,ca,Q,A,w,da,h,ea,J,D,F,fa,R,S,T,E,ha,ia,ja,G,K,U,V,ka,la,ma,W,X,na,oa,x,H,pa,qa,ra,sa,ta,ua,va,wa,Y,xa,ya,za,Aa,Ba,Ca,Da,u,Ea,Fa,Ga,I,Ha,Ia,Ja,Z,Ka,La){var L;const M=F.create(),n=E.create();f.Graphics3DCore=L=class extends aa{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){this._spatialIndex||(this._spatialIndex=new ya.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,
hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return null!=this.currentRenderer&&"dictionary"===this.currentRenderer.type?u.UpdatePolicy.ASYNC:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||
this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this.running)}get dataUpdating(){return!!(0<this._graphicsWaitingForSymbol.size||0<this._pendingUpdates.size||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.running||0<this._loadingSymbols)}get running(){return 0<this._pendingUpdates.size||
!!this._spatialIndex?.updating||this._dataUpdateQueue.running||this._updateQueue.running}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings,b=a?.graphics3D.maxTotalNumberOfFeatures??0;const c=
a?.graphics3D.maxNumberOfDrawCalls??0,d=a?.graphics3D.maxTotalNumberOfVertices??0,e=this.averageSymbolComplexity;a=Math.max(a?.graphics3D.minTotalNumberOfFeatures??0,Math.min(b,Math.ceil(d/Math.max(1,e?.verticesPerFeature??1)),e&&0<e.drawCallsPerFeature&&0<c?c/e.drawCallsPerFeature:b));return(b=this._get("displayFeatureLimit"))&&b.maximumTotalNumberOfVertices===d&&b.averageSymbolComplexity===e&&b.maximumNumberOfFeatures===a?b:new na.DisplayFeatureLimit(d,a,e)}get averageSymbolComplexity(){const a=
X.averageSymbolComplexities(this._symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||null!=b&&(a.estimated&&(b.verticesPerFeature>=a.verticesPerFeature||b.verticesPerCoordinate>=a.verticesPerCoordinate||b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.verticesPerFeature===a.verticesPerFeature&&b.verticesPerCoordinate===a.verticesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}get usedMemory(){const a=null!=this.averageSymbolComplexity&&this.labelsEnabled?
this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,b=this._getSymbolComplexitiesUsed().reduce((k,m)=>k+m.memory.resourceBytes,0),c=this.owner.view._stage.renderer,d=this.owner.view.basemapTerrain.overlayManager.renderer,e=Array.from(this._symbols.values()).reduce((k,m)=>k+(m?.symbolLayers.reduce((l,q)=>l+(q?.materials.reduce((z,r)=>r?z+(c.plugins.getMaterialRenderer(r)?.usedMemory??0)+d.getMemoryForMaterial(r):z,0)??0),0)??0),0);return this._usedMemory+a+b+e}get usedMemoryPerGraphic(){return this._usedMemory&&
this._numberOfGraphics?this._usedMemory/this._numberOfGraphics*(this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves))):null!=this.averageSymbolComplexity?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):
this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(a){if("web-style"===a.type)return a.clone();var b=this._symbolConversionCache.get(a.id);if(null!=b)return b;b=W.to3D(a,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(a)});const c=b.symbol||null;null==c&&b.error&&v.getLogger(this).error(b.error.message);this._symbolConversionCache.set(a.id,c);return c}_getSymbolComplexitiesUsedOrRenderer(a){if(null==a)return[];
var b=a.getSymbols(),c="backgroundFillSymbol"in a?a.backgroundFillSymbol:null;if(!c&&!b?.length)return[];a=[];c=this._getSymbolComplexityUsedOrRenderer(c);null!=c&&a.push(c);for(const d of b)b=this._getSymbolComplexityUsedOrRenderer(d),null!=b&&a.push(b);return a}_getSymbolComplexityUsedOrRenderer(a){if(null==a)return null;const b=this._symbols.get(a.id);if(null!=b)return b.complexity;a=this._getConvertedSymbol(a);return null!=a?X.defaultSymbolComplexity(a):null}_getSymbolComplexitiesUsed(){const a=
[];this._symbols.forEach(b=>{null!=b&&a.push(b.complexity)});return a}get _objectIdField(){return this.layer.objectIdField}constructor(a){super(a);this._propertiesPool=new Ca.PropertiesPool({computedExtent:Ia},this);this.currentRenderer=this.computedExtent=null;this.rendererHasGeometryOperations=!1;this._graphicStateTracking=null;this.graphics3DGraphics=new Map;this.stage=this.stageLayer=null;this._graphicsDrapedUids=new Set;this._graphicsBySymbol=new Map;this._symbolConversionCache=new Map;this._symbols=
new Map;this._graphicsWithoutSymbol=new Map;this._graphicsWaitingForSymbol=new Map;this._graphicsUpdateId=0;this._frameTaskHandle=I.ImmediateTask;this._dataUpdateQueue=new U.PromiseQueue;this._updateQueue=new U.PromiseQueue;this._suspendSymbolCleanup=!1;this._spatialIndex=this._filterVisibility=this._scaleVisibility=this._initializeAbortController=this._elevationInfoChangeAbortController=this._rendererChangeAbortController=this._arcadeOnDemand=null;this.extentPadding=0;this._sharedSymbolResourcesOwnerHandle=
this._stageLayerElevationProvider=this._viewElevationProvider=this._objectStates=this._labeler=this._deconflictor=this._featureStore=this._updatingPendingLoadedGraphicsChange=null;this._whenGraphics3DGraphicRequests={};this._pendingUpdates=new Map;this._pendingRemoves=this._pendingAdds=this._numberOfGraphicsProvidingElevation=this._numberOfGraphics=0;this._applyPendingRemovesFirst=!1;this._loadingSymbols=0;this._pendingUpdatesPool=new Q({allocator:b=>b||new Ma,deallocator:b=>{b.clear();return b}});
this._geometryWarningLogged=this._symbolWarningLogged=!1;this._objectIdInvisibleSet=new Set;this._whenSymbolRemoved=new Q;this.preferredUpdatePolicy=u.UpdatePolicy.SYNC;this._forcedUpdatePolicy=null;this.elevationFeatureExpressionEnabled=!0;this.layer=this.owner=null;this.graphicSymbolSupported=!0;this.getRenderingInfoWithoutRenderer=!1;this.setUidToIdOnAdd=!0;this.hasM=this.hasZ=null;this._usedMemory=0;this._startCreateGraphics=this._visible=!1;this._unusedSymbolsCache=a.owner.view.resourceController.memoryController.newCache("graphics-3d-unused-symbols",
b=>b.destroy());this.symbolCreationContext=new ra.Graphics3DSymbolCreationContext(a.owner.view.resourceController.scheduler,(b,c)=>this._updateQueue.push(b,c))}initialize(){this._featureStore=new pa.Graphics3DFeatureStore({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:c=>this.graphics3DGraphics.forEach(c)});const a=
(c,d,e)=>this.spatialIndex.queryGraphicUIDsInExtent(c,d,e),{componentFactories:b}=this;null!=b.elevationAlignment&&(this._elevationAlignment=b.elevationAlignment(this,a));null!=b.scaleVisibility&&(this._scaleVisibility=b.scaleVisibility(this,a));null!=b.filterVisibility&&(this._filterVisibility=b.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,
x.VisibilityFlag.FILTER,c(G.getObjectId(d.graphic,this._objectIdField)))),setAllFeaturesVisibility:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,x.VisibilityFlag.FILTER,c)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(c=>c.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,x.VisibilityFlag.FILTER,!0))}));null!=b.deconflictor&&(this._deconflictor=b.deconflictor(this));null!=b.labeler&&null!=this._scaleVisibility&&(this._labeler=b.labeler(this,
this._scaleVisibility));null!=b.objectStates&&(this._objectStates=b.objectStates(this));this._initializeAbortController=new AbortController;this._initializePromise=this._initializeAsync()}async _initializeAsync(){const a=this._initializeAbortController?.signal,b=this.owner.view;this._viewElevationProvider=new oa.ViewElevationProvider(this._viewSpatialReference,b);this._initializeStage(b,this.layer.uid);var c=b.sharedSymbolResources;this.symbolCreationContext.sharedResources=c;this._sharedSymbolResourcesOwnerHandle=
c.addGraphicsOwner(this.owner);null!=this.currentRenderer&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=b.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=this.owner;this.symbolCreationContext.localOriginFactory=new Da.GridLocalOriginFactory(b.renderSpatialReference);this.symbolCreationContext.elevationProvider=
b.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=d=>this.notifyGraphicGeometryChanged(d);this.symbolCreationContext.notifyGraphicVisibilityChanged=d=>this.notifyGraphicVisibilityChanged(d);c=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(c,this._viewSpatialReference,a,v.getLogger(this));A.throwIfAborted(a);this.symbolCreationContext.screenSizePerspectiveEnabled=
b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled;this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods;if("drapeSourceType"in this.owner){const {owner:d}=this;this.symbolCreationContext.drapeSourceRenderer=b.basemapTerrain.overlayManager.registerGeometryDrapeSource(d);
this.addHandles(ba.makeHandle(()=>b.basemapTerrain.overlayManager.unregisterDrapeSource(d)))}this.addHandles([w.watch(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null)),w.watch(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view?.screenSizePerspectiveEnabled],()=>{const d=b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=
d,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),w.watch(()=>this.owner.slicePlaneEnabled,d=>this._slicePlaneEnabledChange(!!d)),w.watch(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),w.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,d=>this._physicalBasedRenderingChange(d)),w.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,d=>this._skipHighSymbolLoDsChange(d)),w.when(()=>b.basemapTerrain?.tilingScheme,
d=>{d.spatialReference.equals(this.symbolCreationContext.overlaySR)||null==b.basemapTerrain.spatialReference||(this.symbolCreationContext.overlaySR=b.basemapTerrain.spatialReference);this.hasHandles("loaded-graphics")?this.recreateAllGraphics():this.addHandles([w.on(()=>this.owner?.loadedGraphics,"change",e=>{this._graphicsCollectionChanged(e);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],
"loaded-graphics")},{initial:!0}),w.watch(()=>this.effectiveUpdatePolicy,d=>{null!=this.stageLayer&&(this.stageLayer.updatePolicy=d);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC;d===u.UpdatePolicy.SYNC&&this.runTask(I.noBudget)},w.syncAndInitial)]);this._frameTaskHandle=b.resourceController.scheduler.registerTask(I.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this.addHandles(w.watch(()=>this.layer.featureReduction,()=>this._deconflictor.featureReductionChange()));
this.notifyChange("averageSymbolComplexity");this.rendererChange(this.owner.renderer).catch(()=>{});this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._unusedSymbolsCache.destroy();this._abortInitialize();this._abortRendererChange();this._abortElevationInfoChange();this._frameTaskHandle.remove();this._frameTaskHandle=I.ImmediateTask;this._dataUpdateQueue.cancelAll();
this._updateQueue.cancelAll();this.owner.view?.deconflictor?.removeGraphicsOwner(this);this.owner.view?.labeler?.removeGraphicsOwner(this);this._elevationAlignment=t.destroyMaybe(this._elevationAlignment);this._scaleVisibility=t.destroyMaybe(this._scaleVisibility);this._filterVisibility=t.destroyMaybe(this._filterVisibility);this._labeler=this._deconflictor=null;this._objectStates=t.destroyMaybe(this._objectStates);this.clear();this._featureStore=t.destroyMaybe(this._featureStore);this._updatingPendingLoadedGraphicsChange=
t.removeMaybe(this._updatingPendingLoadedGraphicsChange);this._graphicStateTracking=t.destroyMaybe(this._graphicStateTracking);this.stage&&(this.stageLayer=t.destroyMaybe(this.stageLayer),this.stage=null);this._set("owner",null);for(const a in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[a].reject(new C("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null;this._sharedSymbolResourcesOwnerHandle=t.removeMaybe(this._sharedSymbolResourcesOwnerHandle);
this._propertiesPool=t.destroyMaybe(this._propertiesPool);this._pendingUpdatesPool=null;this._symbolConversionCache.clear();this._objectIdInvisibleSet.clear();this._spatialIndex=t.destroyMaybe(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted();null!=this._graphicStateTracking&&this._graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(a=>a.destroy());this._spatialIndex?.clear();this.graphics3DGraphics.clear();this._usedMemory=this._numberOfGraphics=0;this._updateLayerVisibility();
this._symbols.forEach(t.destroyMaybe);this._symbols.clear();this._graphicsBySymbol.clear();this._graphicsWithoutSymbol.clear();this._graphicsWaitingForSymbol.clear();this._pendingUpdates.clear();this._pendingUpdatesPool.clear();this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1;this.notifyChange("dataUpdating");this.notifyChange("running");this.notifyChange("updatingRemaining");this._featureStore.events.emit("changed")}_initializeStage(a,b){this.stage=a._stage;this.stageLayer=
new Fa.WebGLLayer(this.stage,{pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},b);a=this.stageLayer.events;a.on("transformationChanged",c=>this.notifyGraphicGeometryChanged(c.graphicUid));a.on("shaderTransformationChanged",c=>this.notifyGraphicGeometryChanged(c.graphicUid));a.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.graphicUid));a.on("geometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));a.on("geometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.graphicUid));
a.on("attributesChanged",c=>Ea.affectsGeometry(c.attribute)&&this.notifyGraphicGeometryChanged(c.object.graphicUid))}notifyGraphicGeometryChanged(a){null!=this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicGeometry(a)}notifyGraphicVisibilityChanged(a){null!=this._graphicStateTracking&&null!=a&&(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicVisibility(a)}_updateLayerVisibility(){var a=this._numberOfGraphics>
10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)}getGraphics3DGraphicById(a){return null!=a?this.graphics3DGraphics.get(a):void 0}getGraphics3DGraphicByObjectId(a){return this.owner.layer?.objectIdField?
this._findGraphics3DGraphicByObjectId(a):null}_getGraphicObjectID(a,b=this.owner.layer?.objectIdField){return G.getObjectId(a,b)}get graphics3DGraphicsByObjectID(){const a=this.owner.layer?.objectIdField;if(a){var b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);null!=d&&b.set(d,c)}});return b}}get labelsEnabled(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}async updateLabelingInfo(a){const b=this._deconflictor&&this._deconflictor.labelingInfoChange(a);
a=this._labeler&&this._labeler.labelingInfoChange(a);await Promise.allSettled([b,a])}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange();this._labeler&&this._labeler.visibilityInfoChange()}get symbolUpdateType(){if(0<this._pendingUpdates.size)return"unknown";let a=0,b=0;return P.someMap(this._symbols,(c,d)=>{if(null!=c){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this._graphicsBySymbol.has(d)&&(b+=c.fast,a+=c.slow)}return!1})?"unknown":0<=b&&0===a?"fast":0<=a&&
0===b?"slow":"mixed"}runTask(a){this._dataUpdateQueue.runTask(a);this._updateQueue.runTask(a);this._applyPendingUpdates(a);this.notifyChange("running");this.running||this.notifyChange("dataUpdating");this.notifyChange("updatingRemaining");if(!a.hasProgressed)return Ha.Yield}setObjectIdVisibility(a,b){b?this._objectIdInvisibleSet.delete(a):this._objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);null!=a&&this._updateUserVisibility(a)}_findGraphics3DGraphicByObjectId(a){return P.findInMap(this.graphics3DGraphics,
b=>this._getGraphicObjectID(b.graphic)===a)}_updateUserVisibility(a){if(null==a)return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(null==c||!this._objectIdInvisibleSet.has(c));return a.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,x.VisibilityFlag.USER,b)}_whenGraphics3DGraphic(a){var b=this.graphics3DGraphics.get(a.uid);if(b)return Promise.resolve(b);if(b=this._whenGraphics3DGraphicRequests[a.uid])return b.promise;b=A.createResolver();this._whenGraphics3DGraphicRequests[a.uid]=
b;return b.promise}async _boundsForGraphics3DGraphic(a,b){const c=this._viewSpatialReference,d=this.owner.view.renderSpatialReference,e=this.owner.view.basemapTerrain.spatialReference;a=await a.getProjectedBoundingBox((m,l,q)=>R.projectBuffer(m,d,l,m,c,l,q),(m,l,q)=>R.projectBuffer(m,e,l,m,c,l,q),this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:null!=b?!!b.useViewElevation:!1,minDemResolution:null!=b?b.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:
null,b?.signal);if(!a)return null;b=a.boundingBox;if(a.requiresDrapedElevation){var k=this.symbolCreationContext.elevationProvider;k&&(E.center(b,M),k=k.getElevation(M[0],M[1],0,c,"ground")??0,b[2]=Math.min(b[2],k),b[5]=Math.max(b[5],k))}return{boundingBox:b,screenSpaceObjects:a.screenSpaceObjects}}async whenGraphicBounds(a,b){await w.whenOnce(()=>this.owner?.loadedGraphics);const c=this.owner.layer?.objectIdField;var d=this.owner.loadedGraphics.find(e=>e===a?!0:null!=c&&null!=e.attributes&&a.attributes&&
e.attributes[c]===a.attributes[c]);if(!d)throw new C("internal:graphic-not-part-of-view","Graphic is not part of this view");d=await this._whenGraphics3DGraphic(d);return this._boundsForGraphics3DGraphic(d,b)}computeAttachmentOrigin(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;D.set(y,0,0,0);a=0;if(0<c.render.num){if(!S.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,
B,b))return null;D.add(y,y,B);a++}if(0<c.draped.num){const [d,e]=c.draped.origin;c=this._viewElevationProvider.getElevation(d,e,"ground")??0;D.set(B,d,e,c);if(!S.projectVectorToVector(B,this._viewElevationProvider.spatialReference,B,b))return null;D.add(y,y,B);a++}1<a&&D.scale(y,y,1/a);return new Ja({x:y[0],y:y[1],z:y[2],spatialReference:b})}getSymbolLayerSize(a,b){var c=this._symbols.get(a.id);if(null==c)throw new C("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);
if(-1===a)throw new C("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);if(null==c)throw new C("internal:missing-size","Symbol layer has no valid size");return c}_graphicsCollectionChanged(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))}graphicUpdateHandler(a){const b=a.graphic.uid,c=this.graphics3DGraphics.get(b);if(null!=c||null!=this._graphicsWithoutSymbol.get(b))switch(a.property){case "visible":this._graphicUpdateVisibleHandler(c);
break;case "geometry":this._graphicUpdateGeometryHandler(c,a);break;case "symbol":this._graphicUpdateSymbolHandler(c,a);break;case "origin-transform":this._graphicUpdateTransformHandler(c,a)}}_graphicUpdateGeometryHandler(a,b){this._graphicUpdateGeometryOrTransformHandler(a,b,()=>null!=b.newValue&&null!=a&&a.graphics3DSymbol.updateGeometry(a,b.newValue));const c=b.graphic.geometry;null!=c&&this._expandComputedExtent(c)}_graphicUpdateTransformHandler(a,b){const c=b.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(a,
b,()=>null!=b.newValue&&null!=a&&null!=c&&a.graphics3DSymbol.updateTransform(a,c.spatialReference,b.newValue,b.action))}_graphicUpdateGeometryOrTransformHandler(a,b,c){if(null==b.graphic.geometry)this._recreateGraphic(b.graphic);else if(null==a){if(a=b.graphic.symbol?.id)if(a=this._symbols.get(a),null!=a&&a.loadStatus===xa.LoadStatus.LOADING)return;this._recreateGraphic(b.graphic)}else c()||this._recreateGraphic(a.graphic)}_graphicUpdateSymbolHandler(a,b){var c=b.graphic;const d=null!=a?a.graphics3DSymbol:
null!=b.oldValue?this._symbols.get(b.oldValue.id):null;if(null==d||null==b.newValue)this._recreateGraphic(c);else{var e=d.symbol;b=this._getConvertedSymbol(b.newValue);if(null!=b&&(b.type!==e.type||"web-style"===b.type)||"web-style"===e.type)this._recreateGraphic(c);else{var k=this._graphicsBySymbol.get(e.id);if(k&&1!==k.size)this._recreateGraphic(c);else if(k=J.diff(e,b),null==k)this._updateSymbolMapping(e.id,b);else if(k={diff:k,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(k),
J.isEmpty(k.diff)){var m=this._getRenderingInfo(c);if(null==m)this._recreateGraphic(c);else{c=d.extentPadding;for(const l of k.symbolStatePatches)l();c!==d.extentPadding&&this._recomputeExtentPadding();if(null!=a)for(const l of k.graphics3DGraphicPatches)l(a,m);this._updateSymbolMapping(e.id,b)}}else this._recreateGraphic(c)}}}_graphicUpdateVisibleHandler(a){this._updateUserVisibility(a)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(a){this._suspendSymbolCleanup=
!0;this.remove(a);this.add(a);this._suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&this._cleanupSymbols()}_recreateGraphic(a){this.recreateGraphics([a])}_beginGraphicUpdate(a){const b=this._graphicsUpdateId;this._graphicsUpdateId++;this._graphicsWaitingForSymbol.set(a.uid,b);1===this._graphicsWaitingForSymbol.size&&this.notifyChange("dataUpdating");return b}_endGraphicUpdate(a){a&&(this._graphicsWaitingForSymbol.delete(a.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),
this.notifyChange("dataUpdating")))}_recomputeExtentPadding(){let a=0;this._symbols.forEach(b=>{null!=b&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)}_expandComputedExtent(a){var b=a.spatialReference;G.computeAABB(a,n);a=this._viewSpatialReference;var c=L.tmpVec;!ia.equals(b,a)&&T.projectXYZToVector(n[0],n[1],0,b,c,a)&&(n[0]=c[0],n[1]=c[1],T.projectXYZToVector(n[3],n[4],0,b,c,a),n[3]=c[0],n[4]=c[1]);if(isFinite(n[0])&&isFinite(n[3])&&isFinite(n[1])&&isFinite(n[4])){b=this.computedExtent;
c=null;var d=isFinite(n[2])&&isFinite(n[5]),e=d&&(null==b?.zmin||n[2]<b.zmin);d=d&&(null==b?.zmax||n[5]>b.zmax);if(b){if(n[0]<b.xmin||n[1]<b.ymin||n[3]>b.xmax||n[4]>b.ymax||e||d)c=this._propertiesPool.get("computedExtent"),c.xmin=Math.min(n[0],b.xmin),c.ymin=Math.min(n[1],b.ymin),c.xmax=Math.max(n[3],b.xmax),c.ymax=Math.max(n[4],b.ymax),c.spatialReference=a}else c=this._propertiesPool.get("computedExtent"),c.xmin=n[0],c.ymin=n[1],c.xmax=n[3],c.ymax=n[4],c.spatialReference=a;c&&(e&&(c.zmin=n[2]),d&&
(c.zmax=n[5]),this._set("computedExtent",c))}}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}async elevationInfoChange(){this._abortElevationInfoChange();const a=new AbortController;this._elevationInfoChangeAbortController=a;const b=H.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await H.createContext(b,
this._viewSpatialReference,a.signal,v.getLogger(this));A.throwIfAborted(a.signal);this._elevationInfoChangeAbortController=null;this._labeler?.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,e)=>{c.globalPropertyChanged("elevationInfo",d)?d.forEach(k=>{const m=k.graphic;k=k.labelLayers;for(const l of k)l.graphics3DSymbolLayer.updateGraphicElevationContext(m,l)}):this._recreateSymbol(e)});this.updateStageLayerElevationProvider();this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){if(this._stageLayerElevationProvider){if(this.layer.elevationInfo&&
"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=t.disposeMaybe(this._stageLayerElevationProvider)}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this._numberOfGraphicsProvidingElevation&&(this._stageLayerElevationProvider=new Aa.StageLayerElevationProvider({layer:this.layer,
stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear();null!=this._filterVisibility&&this._filterVisibility.clear();this._labeler?.reset();this._deconflictor?.clear();this._elevationAlignment?.clear();this.stageLayer?.invalidateSpatialQueryAccelerator();this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=
t.disposeMaybe(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0;this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(a=!1){if(this._startCreateGraphics){var {loadedGraphics:b,view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&b?.length?b.toArray():null;!a&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&
!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(a?this.add(d):this.recreateGraphics(d))}}_recreateSymbol(a){var b=this._graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,e)=>{const k=d.usedMemory;this._conditionalRemove(d,e);this._spatialIndex?.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(e,k);this._updateLayerVisibility();this._featureStore.events.emit("changed")}),
this._graphicsBySymbol.set(a,new Map));b=this._symbols.get(a);t.destroyMaybe(b);this._symbols.delete(a);this.add(c)}_recreateGraphicsForSymbol(a){if(a=this._graphicsBySymbol.get(a)){const b=[];a.forEach(c=>b.push(c.graphic));this.recreateGraphics(b)}}_conditionalRemove(a,b){this._graphicsDrapedUids.delete(b);this._objectStates?.removeGraphic(a);this._labeler?.removeGraphic(a);this._deconflictor?.removeGraphic(a);null!=this._graphicStateTracking&&this._graphicStateTracking.removeGraphic(a)}add(a){a&&
0!==a.length&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(a)===u.UpdatePolicy.ASYNC?this._addDelayed(a):this._addImmediate(a),this.notifyChange("dataUpdating")):v.getLogger(this).error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(a){if(this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const b of a)if(null!=b.geometry&&"mesh"===b.geometry.type&&
!b.geometry.loaded)return u.UpdatePolicy.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,v.getLogger(this)),u.UpdatePolicy.SYNC);this._cleanupSymbols();this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()}_addDelayed(a){for(const b of a){a=b.uid;let c=this._pendingUpdates.get(a);c?c.add?c.state!==p.NEW&&c.abortController?.abort():
this._pendingAdds++:(c=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(a,c));c.add=b}this.notifyChange("running");this.notifyChange("updatingRemaining");this.notifyChange("dataUpdating")}remove(a){this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("dataUpdating")}_removeImmediate(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()}_removeDelayed(a){for(const c of a){a=
c.uid;var b=this._pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this._pendingUpdates.delete(a),b.state===p.LOADING&&b.abortController?.abort(),this._pendingAdds--):(b=this._pendingUpdatesPool.pushNew(),b.remove=c,this._pendingUpdates.set(a,b),this._pendingRemoves++,this._applyPendingRemovesFirst=!0)}0===this._pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining");this.notifyChange("dataUpdating")}_finishPendingUpdates(){this._pendingUpdatesPool.clear();
this._cleanupSymbols();(this._pendingAdds||this._pendingRemoves)&&v.getLogger(this).warn("pendingAdds/Removes in inconsistent state!");this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1}_applyPendingUpdates(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;if(0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update(),a.madeProgress();else{if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const [b,c]of this._pendingUpdates){if(a.done){this._applyPendingRemovesFirst=
!0;break}if(c.remove&&!c.add&&(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,this._pendingUpdates.delete(b),0===this._pendingRemoves))break}}for(const [b,c]of this._pendingUpdates){if(a.done)break;c.add&&c.state===p.NEW&&this._processPendingUpdateNew(c);let d=this.effectiveUpdatePolicy;!c.remove||c.add&&c.state!==p.READY||(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,d=u.UpdatePolicy.SYNC);if(c.add)switch(c.state){case p.READY:this._addGraphic(c.add,
c.renderingInfo,d);c.add=null;this._pendingAdds--;a.madeProgress();break;case p.REJECTED:c.add=null,this._pendingAdds--}null==c.remove&&null==c.add&&this._pendingUpdates.delete(b)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("dataUpdating"))}}_processPendingUpdateNew(a){if(a.add){var b=a.add.geometry;null==b||"mesh"!==b.type||b.loaded?this._processPendingUpdateNewRenderingInfo(a):this._processPendingUpdateNewMesh(a,b)}else a.state=p.READY}async _processPendingUpdateNewMesh(a,
b){a.state=p.LOADING;a.abortController=new AbortController;const c=a.abortController.signal;try{await b.load({signal:c})}catch(d){return this._processPendingUpdateNewError(a,d)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)}_processPendingUpdateNewError(a,b){a.abortController=null;A.isAbortError(b)?a.state=p.NEW:a.state=p.REJECTED}async _processPendingUpdateNewRenderingInfo(a){if(null==this.layer.renderer||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,
v.getLogger(this));else{a.state=p.LOADING;a.abortController=new AbortController;var b=null;try{b=await this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(c){a.abortController=null;A.isAbortError(c)?a.state=p.NEW:a.state=p.REJECTED;return}null==b?.symbol?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,v.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=b}a.state=p.READY}_addGraphic(a,
b,c){this._graphicsWithoutSymbol.set(a.uid,a);if(null!=b?.symbol&&G.hasGeometry(a)){if(null!=this.stage.renderView.objectAndLayerIdRenderHelper&&this.setUidToIdOnAdd){const r=la.isBasemapLayer(this.owner.view.map,this.layer.uid);this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(a.objectId,a.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled&&!r&&Ga.hasPopupTemplate(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}var d=this.getOrCreateGraphics3DSymbol(b.symbol,
b.renderer);if(null!=d){this._expandComputedExtent(a.geometry);var e=this._beginGraphicUpdate(a),k=new qa.Graphics3DGraphicCreationContext(a,b,this.layer),m=!1,l=r=>{r===d.symbol.id&&(m=!0)};this._whenSymbolRemoved.push(l);var q=()=>{--this._loadingSymbols;if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(l);if(this._graphicsWaitingForSymbol.get(a.uid)!==e||m||d.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const r=
this._createGraphics3DGraphic(d,k);this._spatialIndex&&null!=r&&this._spatialIndex.add(r);--d.referenced;this._endGraphicUpdate(a)}this._featureStore.events.emit("changed");this._labeler&&this.owner.view.labeler.setDirty()}},z=r=>{--this._loadingSymbols;this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),m||(A.isAbortError(r)?this.add([a]):d.destroyed||this._endGraphicUpdate(a)))};++this._loadingSymbols;c===u.UpdatePolicy.ASYNC?d.load(()=>this._dataUpdateQueue.push(q,null),r=>this._dataUpdateQueue.push(()=>
z(r),null)):d.load(q,z)}}}_removeGraphic(a){a=a.uid;const b=this.graphics3DGraphics.get(a);if(b){b.graphics3DSymbol.onRemoveGraphic(b);const c=b.usedMemory,d=b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex?.remove(b);this._graphicsBySymbol.get(b.graphics3DSymbol.symbol.id)?.delete(a);this._graphicsWithoutSymbol.delete(a);this._removeGraphics3DGraphic(a,c,d);b.destroy();this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(a),this._graphicsWaitingForSymbol.delete(a),
0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("dataUpdating"))}_hasLabelingContext(a){if(a instanceof Z||a instanceof Ka){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1}_hasValidSymbolCreationContext(a){return a instanceof Z&&!this._hasLabelingContext(a)?(v.getLogger(this).error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):
!0}_getRenderingInfo(a,b){const c=a.geometry;if(null==c)return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!fa.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&
null!=a.symbol)return b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?K.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||null!=this.currentRenderer)?this.owner.getRenderingInfo(a,this.currentRenderer,this._arcadeOnDemand):{symbol:a.symbol||ma.getDefaultSymbol3D(a.geometry)};return null==a?.symbol?
(b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a}_getRenderingInfoAsync(a,b){if(null==a.geometry)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,v.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&null!=a.symbol)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,v.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),
null;a=this.rendererHasGeometryOperations?K.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,this.currentRenderer,this._arcadeOnDemand,b)}_createGraphics3DSymbol(a,b){if(!this._hasValidSymbolCreationContext(a))return null;a=this._getConvertedSymbol(a);if(!a)return null;let c;null!=b&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=W.to3D(b.backgroundFillSymbol,{ignoreDrivers:!0}),null!=b.symbol&&"web-style"!==b.symbol.type&&"cim"!==b.symbol.type&&(c=b.symbol.symbolLayers));
const d=sa.make(a,this.symbolCreationContext,c);d.load(()=>{const e=d.extentPadding;e>this.extentPadding&&this._set("extentPadding",e);this.notifyChange("averageSymbolComplexity")},()=>{});return d}getOrCreateGraphics3DSymbol(a,b){var c=this._symbols.get(a.id);void 0===c&&(c=this._unusedSymbolsCache.pop(a.id),c=null!=c?c:a instanceof La?new ta.Graphics3DWebStyleSymbol(a,d=>this._dataUpdateQueue.push(d,null),d=>this._createGraphics3DSymbol(d,b)):this._createGraphics3DSymbol(a,b),this._symbols.set(a.id,
c));null!=c&&++c.referenced;return c}trackGraphicState(a){null==this._graphicStateTracking&&(this._graphicStateTracking=new va.GraphicStateTracking(this));return this._graphicStateTracking.add(a)}_addGraphics3DGraphic(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this._numberOfGraphics++;a.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()}_removeGraphics3DGraphic(a,b,c=!1){this._usedMemory-=
b;this.graphics3DGraphics.delete(a);this._numberOfGraphics--;c&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());this._updateLayerVisibility()}_createGraphics3DGraphic(a,b){const c=b.graphic;this._graphicsWithoutSymbol.delete(c.uid);if(!this._symbols.has(a.symbol.id))return this.add([c]),null;if(this.graphics3DGraphics.has(c.uid))return null;b=a.createGraphics3DGraphic(b);if(null==b)return null;this._addGraphics3DGraphic(b);a=a.symbol.id;this._graphicsBySymbol.has(a)||
this._graphicsBySymbol.set(a,new Map);this._graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&this._graphicsDrapedUids.add(c.uid);b.centroid=null;null!=c.geometry&&"point"!==c.geometry.type&&(b.centroid=wa.computeCentroid(c.geometry,this._viewSpatialReference));this._updateUserVisibility(b);null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(b);null!=this._filterVisibility&&({defaultVisibility:a}=this._filterVisibility,b.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,x.VisibilityFlag.FILTER,
a),a||this._filterVisibility.reapply());this._deconflictor?.addGraphic(b);this._labeler?.addGraphic(b);this._objectStates?.addGraphic(b);this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stageLayer,this.owner);null!=this._graphicStateTracking&&this._graphicStateTracking.addGraphic(b);if(a=this._whenGraphics3DGraphicRequests[c.uid])delete this._whenGraphics3DGraphicRequests[c.uid],a.resolve(b);return b}_abortRendererChange(){this._rendererChangeAbortController&&
(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}async rendererChange(a){this._abortRendererChange();if(a!==this.currentRenderer)if(this._validateRenderer(a),null==a&&this._currentRendererChange(null,!1),V.isSupportedRenderer3D(a))if(null!=a&&a.arcadeRequired){var b=new AbortController;this._rendererChangeAbortController=b;const {arcadeUtils:c}=await this._ensureArcade();A.throwIfAborted(b);const d=c.hasGeometryOperations(a);d&&(await c.enableGeometryOperations(),
A.throwIfAborted(b));this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?await this._updateQueue.push(()=>this._currentRendererChange(a,d),b.signal):this._currentRendererChange(a,d);this._rendererChangeAbortController=null}else this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?(this._rendererChangeAbortController=b=new AbortController,await this._updateQueue.push(()=>this._currentRendererChange(a,!1),b.signal),this._rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,
!1)}async _ensureArcade(){null==this._arcadeOnDemand&&(this._arcadeOnDemand=await ka.loadArcade());return this._arcadeOnDemand}_currentRendererChange(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=this._arcadeOnDemand;b=this.symbolCreationContext.renderer;if(a!==b)if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),null==a)this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=J.diff(b,a);this._updateUnchangedSymbolMappings(c,
a,b);this.symbolCreationContext.renderer=a;null!=c&&("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,a,b)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}}_diffHasSymbolChange(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "uniqueValueGroups":case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1}_applySymbolSetDiff(a,
b,c){a=a||[];b=b||[];const d=[];for(const e of b){const k=this._graphicsBySymbol.get(e.id);k&&k.forEach((m,l)=>{var q=m.graphic,z=this.layer instanceof ja?this.layer:null;const r=this._arcadeOnDemand;if(e!==c.defaultSymbol||c.getSymbol(K.hydrateGraphic(q,z),{arcade:r})!==c.defaultSymbol)z=m.usedMemory,a.length||c.defaultSymbol?d.push(q):this._graphicsWithoutSymbol.set(l,q),q=this.graphics3DGraphics.get(l),this._conditionalRemove(q,l),m.destroy(),k.delete(l),this._removeGraphics3DGraphic(l,z),this._updateLayerVisibility()});
this._whenSymbolRemoved.forAll(m=>m(e.id))}if(a.length||d.length)this._graphicsWithoutSymbol.forEach(e=>d.push(e)),this._graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(a,b,c){const d=a.diff.defaultSymbol,e=a.diff.uniqueValueInfos;if(d||e){const k=e?e.added.map(l=>l.symbol).filter(O.isSome):[],m=e?e.removed.map(l=>l.symbol).filter(O.isSome):[];if(e)for(let l=0;l<
e.changed.length;l++)k.push(e.changed[l].newValue.symbol),m.push(e.changed[l].oldValue.symbol);d?(c.defaultSymbol&&m.push(c.defaultSymbol),b.defaultSymbol&&k.push(b.defaultSymbol)):c.defaultSymbol&&k.length&&m.push(b.defaultSymbol);this._applySymbolSetDiff(k,m,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1}_calculateUnchangedSymbolMapping(a,b,c){if("unique-value"!==b?.type||"unique-value"!==c?.type||null!=a&&"partial"!==a.type)return[];const d=k=>null!=k?k.id:null;
var e=a&&a.diff;a=e?.defaultSymbol;if(e=e&&e.uniqueValueInfos)e=e.unchanged.map(k=>({oldId:d(k.oldValue.symbol),newId:d(k.newValue.symbol)}));else{e=[];for(const k of c.uniqueValueInfos??[]){const m=d(k.symbol),l=b.uniqueValueInfos?.find(q=>q.value===k.value);l&&m!==d(l.symbol)&&e.push({oldId:m,newId:d(l.symbol)})}}!a&&c.defaultSymbol&&e.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return e}_updateSymbolMapping(a,b){const c=null!=b&&b?"string"===typeof b?b:b.id:null;if(null!=a&&a!==c){var d=
this._graphicsBySymbol.get(a);this._graphicsBySymbol.delete(a);void 0!==d&&this._graphicsBySymbol.set(c,d);d=this._symbols.get(a);void 0!==d&&(this._symbols.delete(a),this._symbols.set(c,d),null!=d&&(a="string"===typeof b?null:b,null!=a?d.symbol=a:d.symbol.id=c))}}_updateUnchangedSymbolMappings(a,b,c){a=this._calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:e}of a)this._updateSymbolMapping(d,e)}_applyRendererDiff(a,b,c){if(this._diffHasSymbolChange(a))return!1;if(b instanceof N&&c instanceof
N&&this._applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this._graphicsBySymbol)if(c=this._symbols.get(d),null!=c)switch(c.applyRendererDiff(a,b)){case Y.ApplyRendererDiffResult.RecreateSymbol:this._recreateSymbol(d);break;case Y.ApplyRendererDiffResult.RecreateGraphics:this._recreateGraphicsForSymbol(d)}return!0}opacityChange(){this.forEachGraphics3DSymbol((a,b)=>a.globalPropertyChanged("opacity",b));this._updateStageLayerVisibility()}_slicePlaneEnabledChange(a){a!==
this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.sliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(a){this.symbolCreationContext.physicalBasedRenderingEnabled=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",
c)||this._recreateSymbol(d)})}_skipHighSymbolLoDsChange(a){this.symbolCreationContext.skipHighSymbolLods=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("skipHighSymbolLods",c)||this._recreateSymbol(d)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=
da.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(a,b){const c=this.symbolCreationContext.clippingExtent,d=ha.create();Ba.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=E.fromRect(E.create(),d):this.symbolCreationContext.clippingExtent=null;return!E.equals(this.symbolCreationContext.clippingExtent,c)}modifyGraphics3DGraphicVisibilities(a){if(!this.destroyed){var b=!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this.owner.view.labeler?.setDirty(),
this.owner.view.deconflictor?.setDirty())}}forEachGraphics3DSymbol(a){for(const [b,c]of this._symbols){if(null==c)break;const d=this._graphicsBySymbol.get(b);a(c,d||Na,b)}}updateAllGraphicsVisibility(){null!=this._filterVisibility&&this._filterVisibility.reapply();this.modifyGraphics3DGraphicVisibilities(a=>{const b=this._updateUserVisibility(a);a=null!=this._scaleVisibility&&this._scaleVisibility.updateVisibility(a);return b||a})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(x.VisibilityGroup.GRAPHIC,
x.VisibilityFlag.USER,!1))}_validateRenderer(a){if(a=V.validateTo3D(a,{geometryType:this.layer?.geometryType})){const b=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;v.getLogger(this).warn(b,a.message)}}_cleanupSymbols(){if(!(0<this._graphicsWaitingForSymbol.size||this._suspendSymbolCleanup)){var a=!1;this._symbols.forEach((b,c)=>{if(!(null==b||0<b.referenced)){var d=this._graphicsBySymbol.get(c);d&&0!==d.size||(this._graphicsBySymbol.delete(c),
this._symbols.delete(c),this._unusedSymbolsCache.put(c,b,za.getSymbolMemorySize(b),ca.MinPriority),a=!0)}});a&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map(a=>({symbolId:a,graphics:[...this._graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),
graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:a=>{this._forcedUpdatePolicy=a}}}get performanceInfo(){return new ua.GraphicsCorePerformanceInfo(this.graphics3DGraphics.size,this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};f.Graphics3DCore.tmpVec=F.create();g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,
"computedExtent",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"currentRenderer",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_frameTaskHandle",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_dataUpdateQueue",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_updateQueue",void 0);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,
"_viewSpatialReference",null);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_initializeAbortController",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_elevationAlignment",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_scaleVisibility",void 0);g.__decorate([h.property()],
f.Graphics3DCore.prototype,"_filterVisibility",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_initializePromise",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_spatialIndex",void 0);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,"extentPadding",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_featureStore",void 0);g.__decorate([h.property()],
f.Graphics3DCore.prototype,"_deconflictor",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_labeler",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_objectStates",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_loadingSymbols",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_forcedUpdatePolicy",void 0);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,
"effectiveUpdatePolicy",null);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"owner",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"layer",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,
"getRenderingInfoWithoutRenderer",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"componentFactories",void 0);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"featureStore",null);g.__decorate([h.property()],f.Graphics3DCore.prototype,"initializePromise",null);g.__decorate([h.property()],f.Graphics3DCore.prototype,"scaleVisibility",null);g.__decorate([h.property()],
f.Graphics3DCore.prototype,"elevationAlignment",null);g.__decorate([h.property()],f.Graphics3DCore.prototype,"objectStates",null);g.__decorate([h.property()],f.Graphics3DCore.prototype,"filterVisibility",null);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,"updating",null);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,"dataUpdating",null);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,"running",null);g.__decorate([h.property({readOnly:!0})],
f.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);g.__decorate([h.property({readOnly:!0,dependsOn:[]})],f.Graphics3DCore.prototype,"updatingRemaining",null);g.__decorate([h.property({readOnly:!0})],f.Graphics3DCore.prototype,"displayFeatureLimit",null);g.__decorate([h.property({readOnly:!0,dependsOn:[]})],f.Graphics3DCore.prototype,"averageSymbolComplexity",null);g.__decorate([h.property({constructOnly:!0})],f.Graphics3DCore.prototype,"hasZ",void 0);g.__decorate([h.property({constructOnly:!0})],
f.Graphics3DCore.prototype,"hasM",void 0);g.__decorate([h.property()],f.Graphics3DCore.prototype,"_objectIdField",null);f.Graphics3DCore=L=g.__decorate([ea.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],f.Graphics3DCore);var p;(function(a){a[a.NEW=0]="NEW";a[a.LOADING=1]="LOADING";a[a.READY=2]="READY";a[a.REJECTED=3]="REJECTED"})(p||={});class Ma{constructor(){this.renderingInfo=this.add=null;this.state=p.NEW;this.remove=this.abortController=null}clear(){this.renderingInfo=this.add=null;
this.state=p.NEW;this.remove=this.abortController=null}}const y=F.create(),B=F.create(),Na=new Map;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});