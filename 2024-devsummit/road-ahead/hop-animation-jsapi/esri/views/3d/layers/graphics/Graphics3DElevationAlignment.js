// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ./ExtentSet ../../webgl-engine/lib/UpdatePolicy ../../../support/Scheduler".split(" "),function(c,e,p,q,l,f,v,w,x,r,t,u,k){function m(a){return null==a?k.TaskPriority.ELEVATION_ALIGNMENT:"relative-to-scene"===
a?k.TaskPriority.ELEVATION_ALIGNMENT_SCENE:k.TaskPriority.ELEVATION_ALIGNMENT}c.Graphics3DElevationAlignment=class extends p{constructor(a){super(a);this._dirtyExtents=new t.ExtentSet;this._globalDirty=!1;this._averageExtentUpdateSize=0;this._dirtyGraphicsSet=new Set;this._updateElevation=!1;this.graphicsCore=this.graphicsCoreOwner=null;this.events=new q}initialize(){const a=this.elevationProvider;this._task=this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(m(this.graphicsCore.layer.elevationInfo?.mode),
this);this.addHandles([a.on("elevation-change",b=>this._elevationChanged(b)),l.watch(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,l.watch(()=>m(this.graphicsCore.layer.elevationInfo?.mode),b=>this._task.priority=b)])}destroy(){this._dirtyGraphicsSet.clear();this.elevationProvider=this.queryGraphicUIDsInExtent=this.graphicsCore=this.graphicsCoreOwner=null}clear(){this._dirtyGraphicsSet.clear();this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?
this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0;this.notifyChange("updating")}get updating(){return this.running}get running(){return 0<this._dirtyGraphicsSet.size||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(a){this._globalDirty&&
(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,a.madeProgress());for(a.run(()=>this._dirtyExtents.merge(a));this.running&&!a.done;)this._updateDirtyGraphics(a),this._updateDirtyExtents(a);this.notifyChange("updating")}_updateDirtyGraphics(a){const b=this.graphicsCoreOwner.view.renderCoordsHelper,d=this.graphicsCore.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC;for(const h of this._dirtyGraphicsSet.keys()){const g=this.graphicsCore.getGraphics3DGraphicById(h);this._dirtyGraphicsSet.delete(h);
null!=g&&(g.alignWithElevation(this.elevationProvider,b,d),this.graphicsCoreOwner.view.deconflictor.setDirty(),a.madeProgress());if(a.done)break}}_updateDirtyExtents(a){for(;!this._dirtyExtents.empty&&!a.done;){const b=this._dirtyExtents.pop(),d=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:b,spatialReference:d});const h=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(b,d,g=>{const n=this.graphicsCore.getGraphics3DGraphicById(g);null!=n&&n.needsElevationUpdates()&&
this._dirtyGraphicsSet.add(g)});this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-h)+.9*this._averageExtentUpdateSize;a.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear();this._dirtyGraphicsSet.clear();this.graphicsCore.graphics3DGraphics.forEach((a,b)=>this._dirtyGraphicsSet.add(b))}_elevationChanged(a){if("scene"!==a.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var b=a.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const d=
this.graphicsCore.computedExtent;d&&b[2]>d.xmin&&b[0]<d.xmax&&b[3]>d.ymin&&b[1]<d.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",a)}else-Infinity===b[0]?this._globalDirty=!0:this._dirtyExtents.add(b),this.notifyChange("updating")}}};e.__decorate([f.property()],c.Graphics3DElevationAlignment.prototype,"graphicsCoreOwner",void 0);e.__decorate([f.property()],c.Graphics3DElevationAlignment.prototype,"graphicsCore",void 0);e.__decorate([f.property()],c.Graphics3DElevationAlignment.prototype,
"queryGraphicUIDsInExtent",void 0);e.__decorate([f.property()],c.Graphics3DElevationAlignment.prototype,"elevationProvider",void 0);e.__decorate([f.property({readOnly:!0})],c.Graphics3DElevationAlignment.prototype,"updating",null);e.__decorate([f.property({readOnly:!0})],c.Graphics3DElevationAlignment.prototype,"updatingRemaining",null);c.Graphics3DElevationAlignment=e.__decorate([r.subclass("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],c.Graphics3DElevationAlignment);Object.defineProperty(c,
Symbol.toStringTag,{value:"Module"})});