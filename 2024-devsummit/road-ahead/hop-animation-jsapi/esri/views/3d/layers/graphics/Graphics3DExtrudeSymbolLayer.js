// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/Error ../../../../core/lang ../../../../core/unitUtils ../../../../chunks/earcut ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ../../../../geometry/support/Indices ../../../../chunks/vec3 ../../../../layers/graphics/data/SnappingCandidate ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../support/renderInfoUtils/polygon ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/Normals ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ea,ab,Aa,U,Ba,Ca,Da,Ea,fa,V,z,G,Fa,P,Q,W,Ga,X,Ha,Ia,Y,Ja,Ka,ha,ia,La,Ma,Na,Oa,Pa,Qa,Z,aa,Ra,Sa,Ta,Ua,Va,L,ja){function ka(a,b,c,e,h,d){const f=W.getZeroIndexArray(b.length);b=[[L.VertexAttribute.POSITION,new Z.Attribute(e.positions,b,3,!0)],[L.VertexAttribute.NORMALCOMPRESSED,new Z.Attribute(e.normals,b,2,!0)],[L.VertexAttribute.COLOR,new Z.Attribute(h,f,4,!0)]];return new Sa.Geometry(a,b,e.elevation,Ra.ContentObjectType.Mesh,d,c)}function Wa(a,b,c,e,h,d,f,l,v,p,t,k,A){let H=0;var g=2*e.count,
m=e.index,u=e.count,C=c.length/3,q=g;z.copy(w,k);const r=0<t?1:-1;g=3*m;let n=0;m=3*n;let x=u;k=3*x;for(let D=0;D<u;++D)A&&(w[0]=a[g],w[1]=a[g+1],w[2]=a[g+2],z.normalize(w,w)),h[m]=a[g],h[m+1]=a[g+1],h[m+2]=a[g+2],d[m]=b[g],d[m+1]=b[g+1],d[m+2]=b[g+2],f[m]=-r*w[0],f[m+1]=-r*w[1],f[m+2]=-r*w[2],l[n]=0,h[k]=a[g]+t*w[0],h[k+1]=a[g+1]+t*w[1],h[k+2]=a[g+2]+t*w[2],d[k]=b[g],d[k+1]=b[g+1],d[k+2]=b[g+2],f[k]=r*w[0],f[k+1]=r*w[1],f[k+2]=r*w[2],l[x]=t,m+=3,k+=3,g+=3,n+=1,x+=1;m=g=0;k=3*q;a=0>t?la:ma;b=0>t?
ma:la;for(A=0;A<C;++A)p[m]=c[g+a[0]],p[m+1]=c[g+a[1]],p[m+2]=c[g+a[2]],v[k]=c[g+b[0]]+u,v[k+1]=c[g+b[1]]+u,v[k+2]=c[g+b[2]]+u,m+=3,k+=3,g+=3;c=2*e.count;g=0;na(h,d,l,f,H,e.pathLengths[0],e.count,c,v,g,t);c+=4*e.pathLengths[0];g+=2*e.pathLengths[0];H+=e.pathLengths[0];for(p=1;p<e.pathLengths.length;++p)na(h,d,l,f,H,e.pathLengths[p],e.count,c,v,g,t),c+=4*e.pathLengths[p],g+=2*e.pathLengths[p],H+=e.pathLengths[p]}function R(a,b,c,e,h,d,f){e[d]=e[f];f*=3;d*=3;a[d]=a[f];a[d+1]=a[f+1];a[d+2]=a[f+2];b[d]=
b[f];b[d+1]=b[f+1];b[d+2]=b[f+2];c[d]=h[0];c[d+1]=h[1];c[d+2]=h[2]}function na(a,b,c,e,h,d,f,l,v,p,t){let k=h,A=h+1,H=h+f,g=h+f+1,m=l,u=l+1,C=l+2*d;l=l+2*d+1;0>t&&(k=h+f+1,g=h);p*=3;for(let I=0;I<d;++I){I===d-1&&(0<t?(A=h,g=h+f):(A=h,k=h+f));var q=a,r=k,n=A,x=H,D=N;r*=3;n*=3;x*=3;z.set(ba,q[r++],q[r++],q[r++]);z.set(oa,q[n++],q[n++],q[n++]);z.set(pa,q[x++],q[x++],q[x++]);z.subtract(qa,oa,ba);z.subtract(ra,pa,ba);z.cross(D,ra,qa);z.normalize(D,D);R(a,b,e,c,N,m,k);R(a,b,e,c,N,u,A);R(a,b,e,c,N,C,H);
R(a,b,e,c,N,l,g);v[p++]=m;v[p++]=C;v[p++]=l;v[p++]=m;v[p++]=l;v[p++]=u;k++;A++;H++;g++;m+=2;u+=2;C+=2;l+=2}}const Xa=["polygon","extent"];class Ya extends Ka.Graphics3DSymbolLayer{constructor(a,b,c,e){super(a,b,c,e);this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){var a=ha.validateSymbolLayerSize(this._getSymbolSize());if(a)throw new Aa("graphics3dextrudesymbollayer:invalid-size",a);}var b=this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color);a=G.fromArray(b);
b=b[3];const c=1>b||this.needsDrivenTransparentPass;a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:b,transparent:c,cullFace:c?aa.CullFaceOptions.None:aa.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:Qa.NormalType.Compressed};this._materials[E.Main]=new ja.DefaultMaterial(a);this._materials[E.Bottom]=new ja.DefaultMaterial({...a,
cullFace:aa.CullFaceOptions.Back});this._context.stage.addMany(this._materials)}destroy(){super.destroy();this._context.stage.removeMany(this._materials);this._materials.length=0}createGraphics3DGraphic(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,Xa,this.symbolLayer.type))return null;const c=this._getVertexOpacityAndColor(a.renderingInfo,255),e=this.setGraphicElevationContext(b);return this._createAs3DShape(b,a.renderingInfo,c,e,b.uid)}layerOpacityChanged(a,b){const c=this._getCombinedOpacity(this.symbolLayer?.material?.color),
e=1>c||this.needsDrivenTransparentPass;this._materials[E.Main]?.setParameters({opacity:c,transparent:e});this._materials[E.Bottom]?.setParameters({opacity:c,transparent:e});const h=this._getLayerOpacity();a.forEach(d=>{d=b(d);null!=d&&d.layerOpacityChanged(h,this._context.isAsync)})}layerElevationInfoChanged(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,Y.needsElevationUpdates3D)}slicePlaneEnabledChanged(a,b){this._materials[E.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});
this._materials[E.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});a.forEach(c=>{c=b(c);null!=c&&c.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)});return!0}physicalBasedRenderingChanged(){const a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};this._materials[E.Main]?.setParameters(a);this._materials[E.Bottom]?.setParameters(a);return!0}_getExtrusionSize(a){a=a.size&&this._drivenProperties.size?Ha.getDriverAxisSizeValue(a.size,
2)??0:this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters}applyRendererDiff(a,b){return this._drivenPropertiesChanged(b)?ia.ApplyRendererDiffResult.RecreateSymbol:ia.ApplyRendererDiffResult.RecreateGraphics}async queryForSnapping(a,b,c,e){b=this._getExtrusionSize(c)*this._context.renderCoordsHelper.unitInMeters/Ba.getMetersPerVerticalUnitForSR(b);const {objectId:h,target:d}=a;c=U.clone(d);c.z=(c.z??0)+b;switch(a.type){case "edge":const {start:f,end:l}=a;a=U.clone(f);e=U.clone(l);
a.z=(a.z??0)+b;e.z=(e.z??0)+b;return[X.makeEdgeCandidate(h,c,Infinity,a,e)];case "vertex":return[X.makeVertexCandidate(h,c,Infinity),X.makeEdgeCandidate(h,d,Infinity,d,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(a,b,c,e,h){var d=La.geometryAsPolygon(a.geometry);if(null==d)return null;if(0===d.rings.length||!d.rings.some(n=>0<n.length))return this._logGeometryValidationWarnings(d.rings,"rings","ExtrudeSymbol3DLayer"),null;a=Pa.geometryToRenderInfo(d,this._context.elevationProvider,
this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(a,d.rings,"rings","ExtrudeSymbol3DLayer");var f=ha.computeCentroid(d);if(null==f)return null;var l=[];const v=[],p=P.create(),t=V.create(),k=G.create(),A=this._context.renderCoordsHelper.viewingMode===Ia.ViewingMode.Global;A||this._context.renderCoordsHelper.worldUpAtPosition(null,k);Fa.computeTranslationToOriginAndRotation(d.spatialReference,[f.x,f.y,0],t,this._context.renderCoordsHelper.spatialReference);d=V.create();fa.invert(d,
t);f=Ea.create();Da.normalFromMat4(f,d);const {polygons:H,mapPositions:g,position:m}=a;for(const n of H){f=n.count;if(this._context.clippingExtent&&(P.empty(p),P.expandWithBuffer(p,n.mapPositions),!P.intersectsClippingArea(p,this._context.clippingExtent)))continue;var u=Ca.earcut(n.mapPositions,n.holeIndices,3);if(0===u.length)continue;var C=u.length,q=6*f;f=W.newIndexArray(q+C);C=W.newIndexArray(C);var r=Q.newDoubleArray(3*q);const x=Q.newDoubleArray(3*q),D=Q.newDoubleArray(3*q);q=Q.newDoubleArray(q);
const I=this._getExtrusionSize(b);Wa(m,g,u,n,r,D,x,q,f,C,I,k,A);Ga.transformMat4(r,r,d);u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid});r=new Za(r,D,Ua.compressNormals(x),q);l.push(ka(this._materials[E.Main],f,f.length-C.length,r,c,u),ka(this._materials[E.Bottom],C,0,r,c,u));v.push(r.heights)}if(0===l.length)return null;b=new Va.Object3D({geometries:l,layerUid:this._context.layer.uid,graphicUid:h,isElevationSource:!0});b.transformation=t;
c=Ma.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});l=new Ja.Graphics3DObject3DGraphicLayer(this,b,l,null,null,(n,x,D,I,ca)=>{n=n.stageObject;const O=n.geometries,sa=O.length;x="absolute-height"!==x.mode;let ta=0;const ua=n.transformation,$a=fa.invertOrIdentity(V.create(),ua);for(let J=0;J<sa;J+=2){const S=O[J];if(!Ta.isGeometryWithMapPositions(S))continue;const B=S.getMutableAttribute(L.VertexAttribute.POSITION).data,va=v[J/2],K=new Oa.SamplePosition(S.mapPositions),wa=B.length/
3;let y=0,xa=!1,ya=0;for(let za=0;za<wa;za++){M[0]=B[y];M[1]=B[y+1];M[2]=B[y+2];I(K,T);x&&(ya+=T.sampledElevation);Na.debugFlags.TESTS_DISABLE_OPTIMIZATIONS?(z.set(F,K.array[K.offset],K.array[K.offset+1],T.z+va[y/3]),null!=D&&ca.toRenderCoords(F,D,F)):(z.set(F,B[y],B[y+1],B[y+2]),z.transformMat4(F,F,ua),ca.setAltitude(F,T.z+va[y/3]));z.transformMat4(F,F,$a);B[y]=F[0];B[y+1]=F[1];B[y+2]=F[2];const da=.01/ca.unitInMeters;if(Math.abs(M[0]-B[y])>=da||Math.abs(M[1]-B[y+1])>=da||Math.abs(M[2]-B[y+2])>=
da)xa=!0;K.offset+=3;y+=3}xa&&(S.invalidateBoundingInfo(),n.geometryVertexAttributeUpdated(O[J],L.VertexAttribute.POSITION),O[J+1].invalidateBoundingInfo(),n.geometryVertexAttributeUpdated(O[J+1],L.VertexAttribute.POSITION));ta+=ya/wa}return ta/sa},e,null!=c?{baseMaterial:this._materials[E.Main],edgeMaterials:[c],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null);l.alignedSampledElevation=a.sampledElevation;l.needsElevationUpdates=Y.needsElevationUpdates3D(e.mode);
return l}}const N=G.create(),ba=G.create(),oa=G.create(),pa=G.create(),qa=G.create(),ra=G.create(),M=G.create(),F=G.create(),w=G.create(),T=new Y.SampleElevationInfo,ma=[0,2,1],la=[0,1,2];var E;(function(a){a[a.Main=0]="Main";a[a.Bottom=1]="Bottom"})(E||={});class Za{constructor(a,b,c,e){this.positions=a;this.elevation=b;this.normals=c;this.heights=e}}ea.Graphics3DExtrudeSymbolLayer=Ya;Object.defineProperty(ea,Symbol.toStringTag,{value:"Module"})});