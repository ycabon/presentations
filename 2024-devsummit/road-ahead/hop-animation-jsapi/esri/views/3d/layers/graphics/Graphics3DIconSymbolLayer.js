// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../../Color ../../../../core/asyncUtils ../../../../core/Error ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/string ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/projection/projectPointToVector ../../../../geometry/support/aaBoundingBox ../../../../support/arcadeOnDemand ../../../../symbols/cim/CIMSymbolHelper ../../../../symbols/cim/OverrideHelper ../../../../symbols/cim/utils ../../../../symbols/support/cimSymbolUtils ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/Symbol3DAnchorPosition2D ../../../../symbols/support/utils ../../../2d/arcade/callExpressionWithFeature ./constants ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./placementUtils ./pointUtils ../support/FastSymbolUpdates ../../support/engineContent/sdfPrimitives ../../terrain/OverlayRenderer ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(N,H,O,A,B,P,u,p,q,Q,R,v,r,S,T,U,V,C,w,W,X,Y,Z,aa,ba,ca,da,m,ea,fa,ha,ia,D,E,F,x,y,ja,I,ka,J,K){function G(a){return null==a?!1:"cross"===a||"x"===a}const L=r.fromValues(0,0,1),M=y.defaultTexSize,n=y.defaultSymbolSizeRatio,la=[n/2,n/2,1-n/2,1-n/2];class z extends ha.Graphics3DSymbolLayer{getCachedSize(){return{size:this._getIconSize()}}constructor(a,b,c,d){super(a,b,c,d);this._cimSymbolMaterials=new Map;this._cimSymbolTextures=new Map;this._size=this._cimMaterialParametersInfo=null;this._symbolTextureRatio=
1;this._outlineSize=0;this._patchTask=null;this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(a){this._validateOrThrow();const b=this._prepareMaterialParameters();var c=this._getPrimitive();if(null!=c)this._prepareResourcesPrimitive(b,c);else{c=aa.getIconHref(this.symbolLayer);const d=R.dataComponents(c);d&&"application/json"===d.mediaType?await this._prepareResourcesCIM(b,JSON.parse(d.data),a):await this._prepareResourcesHref(b,c,a)}}_validateOrThrow(){if(!this._drivenProperties.size){var a=
ia.validateSymbolLayerSize(this._getIconSize());if(a)throw new B("graphics3diconsymbollayer:invalid-size",a);}}_getIconSize(){var a=this.symbolLayer;a=Math.round(null!=a.size?q.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a}_generateTextureCIM(a){var b=this._cimData;b&&b.symbol||this.logger.error("Can't create texture, CIM data is undefined");if(b.primitiveOverrides){b=P.clone(b);var c=b.primitiveOverrides;w.OverrideHelper.evaluateOverrides(c,a,this._arcadeInfo.geometryType,
null,null);w.OverrideHelper.applyOverrides(b.symbol,c)}c=Q.numericHash(JSON.stringify(b));var d=this._cimSymbolTextures.get(c);if(d)return d;d=this._context.sharedResources.cimSymbolRasterizer;const e=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;e&&w.OverrideHelper.applyDictionaryTextOverrides(b.symbol,a,e);a=null!=this._cimScaleFactorOrFunction?W.evaluateValueOrFunction(this._cimScaleFactorOrFunction,a):1;1!==a&&b.symbol&&X.scaleCIMSymbol(b.symbol,
a,!0);(a=C.CIMSymbolHelper.getEnvelope(b,null,d.resourceManager))&&a.width&&a.height?(b=d.rasterize({type:"cim",data:b},a.width,a.height,a.x+a.width/2,a.y+a.height/2,1,"esriGeometryPoint"),a=new Z.Symbol3DAnchorPosition2D({x:-a.x/a.width-.5,y:(a.height+a.y)/a.height-.5}),this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",a),d=new J.Texture(b,{width:b?.width??1,height:b?.height??1})):d=new J.Texture(new ImageData(1,1),{width:1,height:1});this._cimSymbolTextures.set(c,d);this._context.stage.add(d);
return d}_prepareMaterialParameters(){const a={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},b=this.symbol;if(b&&"point-3d"===b.type&&b.hasVisibleVerticalOffset()){const {screenLength:c,minWorldLength:d,maxWorldLength:e}=b.verticalOffset;a.verticalOffset={screenLength:q.pt2px(c),minWorldLength:d||0,maxWorldLength:null!=e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);
a.occlusionTest=!0;a.hasSlicePlane=this._context.slicePlaneEnabled;return a}_prepareResourcesPrimitive(a,b){var c=this._getOutlineSize();if(G(b)&&0===c)throw Error("Nothing to render");this._outlineSize=c;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;null!=this._context.sharedResources.textures&&(this._textureHandle=c=this._context.sharedResources.textures.fromData(`${b}-icon`,()=>y.createTexture(b)),a.textureId=c.texture.id);a.textureIsSignedDistanceField=
!0;a.sampleSignedDistanceFieldTexelCenter=y.requiresHalfTexelOffset(b);a.distanceFieldBoundingBox=la;c=this._getIconSize();this._size=[c,c];this._symbolTextureRatio=1/n;this._createMaterialAndAddToStage(a,this._context.stage)}async _prepareResourcesHref(a,b,c){this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=!1;const d=this._getIconSize(),e=d*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;
if(null!=this._context.sharedResources.textures){c=await A.result(this._context.sharedResources.textures.fromUrl(b,e,{signal:c}));if(!1===c.ok)throw p.throwIfAbortError(c.error),new B("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${b})`);this._textureHandle=c.value;b=c.value.texture;this._size=this._computeSizeFromTexture(b,d);a.textureId=b.id}this._createMaterialAndAddToStage(a,this._context.stage)}async _prepareResourcesCIM(a,b,c){this._cimData=b;
if(!this._context.sharedResources.cimSymbolRasterizer){var d=(await new Promise((g,f)=>N(["../../../../symbols/cim/CIMSymbolRasterizer"],g,f))).CIMSymbolRasterizer;p.throwIfAborted(c);this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new d(this._context.renderCoordsHelper.spatialReference))}var e=this._context.sharedResources.cimSymbolRasterizer;d=[];const h=b?.symbol;C.CIMSymbolHelper.fetchResources(h,e.resourceManager,d,c);C.CIMSymbolHelper.fetchFonts(h,
e.resourceManager,d);e=this._context.layer.fields?this._context.layer.fields.map(g=>g.toJSON()):[];this._arcadeInfo={spatialReference:this._context.renderCoordsHelper.spatialReference,fields:e,geometryType:"esriGeometryPoint"};b?.primitiveOverrides&&d.push(w.OverrideHelper.createRenderExpressions(b.primitiveOverrides,this._arcadeInfo));0<d.length&&(await Promise.all(d),p.throwIfAborted(c));if(this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression&&
(b=this._context.renderer,b.scaleExpression)){const g=await V.createRendererExpression(b.scaleExpression,this._context.layer.spatialReference,e);this._cimScaleFactorOrFunction=(f,k,l)=>{f=ba(g,f,{$view:l},"esriGeometryPoint",k);return null!==f?f:1}}p.throwIfAborted(c);this._cimMaterialParametersInfo=a;this._cimMaterialParametersInfo.color=this._getFillColor();this._cimMaterialParametersInfo.outlineColor=[0,0,0,0];this._cimMaterialParametersInfo.outlineSize=0;this._cimMaterialParametersInfo.textureIsSignedDistanceField=
!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Y.defaultPrimitive}_getOutlineSize(){var a=0;a=this.symbolLayer;if(null!=a.outline?.size)return Math.max(q.pt2px(a.outline.size),0);a=this._getPrimitive();a=G(a)?1.5:0;return Math.max(a,0)}_getOutlineColor(){const a=this._getLayerOpacity(),b=this.symbolLayer?.outline?.color;if(null!=b){const c=O.toUnitRGB(b);return[c[0],c[1],c[2],b.a*a]}return[0,
0,0,0]}_getFillColor(){if(G(this._getPrimitive()))return ca.transparentUnit;const a=null==this._getPrimitive();return this._getCombinedOpacityAndColor(this.symbolLayer?.material?.color,{hasIntrinsicColor:a})}_getAnchorPos(a,b){return"relative"===a?v.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in E.namedAnchorToHUDMaterialAnchorPos?E.namedAnchorToHUDMaterialAnchorPos[a]:E.namedAnchorToHUDMaterialAnchorPos.center}_createMaterialAndAddToStage(a,b){if(this._cimData){this._fastUpdates=null;let c=a.textureId?
this._cimSymbolMaterials.get(a.textureId):null;c||(c=new K.HUDMaterial(a),this._cimSymbolMaterials.set(a.textureId??0,c),b.add(c));return c}(this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()))&&(a={...a,...this._fastUpdates.materialParameters});this._materials[0]=new K.HUDMaterial(a);b.add(this._materials[0]);return this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(a=>{a.setParameters({verticalOffset:null,
screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy();this._patchTask=u.abortMaybe(this._patchTask);this._forEachMaterial(a=>this._context.stage.remove(a));this._materials.length=0;this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(a=>this._context.stage.remove(a));this._cimSymbolTextures.clear();this._textureHandle=u.releaseMaybe(this._textureHandle)}_getScaleFactor(a,b){if(this._drivenProperties.size&&
a.size){for(let c=0;3>c;c++){const d=a.size[c];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[c]=q.pt2px(d))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1}createGraphics3DGraphic(a){const b=a.graphic;if(!this._validateGeometry(b.geometry))return null;var c=[0,0];let d;if(this._cimData){if(!this._cimData.symbol)return null;var e=this._generateTextureCIM(b);d=this._createMaterialAndAddToStage({textureId:e.id,
...this._cimMaterialParametersInfo},this._context.stage);c=[e.parameters.width,e.parameters.height]}else c=this._size,d=this._materials[0];e=F.placePointOnGeometry(b.geometry);if(null==e)return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;var h=a.renderingInfo;const g=this._getVertexOpacityAndColor(h);let f=1;this._fastUpdates?.visualVariables.size||(f=this._getScaleFactor(h,c[0]>c[1]?c[0]:c[1]));f*=this._symbolTextureRatio;c=v.fromValues(c[0]*f,c[1]*f);h=
this.setGraphicElevationContext(b);this.ensureDrapedStatus("on-the-ground"===h.mode)&&this._setDrapingDependentMaterialParameters();return this.draped?this._createAsOverlay(b,e,d,g,c,a.layer.uid):this._createAs3DShape(b,e,d,g,c,h,b.uid)}layerOpacityChanged(){const a=this._getFillColor(),b=this._getOutlineColor();this._forEachMaterial(c=>{c.setParameters({color:a});c.setParameters({outlineColor:b})})}layerElevationInfoChanged(a,b,c){const d=this._elevationContext.mode;c=m.elevationModeChangeUpdateType(z.elevationModeChangeTypes,
c,d);if(c!==m.SymbolUpdateType.UPDATE)return c;const e=m.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)}slicePlaneEnabledChanged(){this.draped||this._forEachMaterial(a=>{a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(a,b){for(const c in a.diff)switch(c){case "visualVariables":if(x.updateFastSymbolUpdatesState(this._fastUpdates,
b,this._fastVisualVariableConvertOptions()))this._materials[0]?.setParameters(this._fastUpdates.materialParameters);else return D.ApplyRendererDiffResult.RecreateSymbol;break;default:return D.ApplyRendererDiffResult.RecreateSymbol}return D.ApplyRendererDiffResult.FastUpdate}prepareSymbolLayerPatch(a){this._patchTask?.abort();"partial"===a.diff.type&&this._preparePatchResource(a,a.diff.diff)}_preparePatchResource(a,b){if(b.resource&&"partial"===b.resource.type&&(b=b.resource.diff,"complete"===b?.href?.type)){var c=
b.href.newValue,{textures:d}=this._context.sharedResources;if(null!=c&&null!=d){var e=this._getIconSize(),h=e*this._context.graphicsCoreOwner.view.state.pixelRatio;a.symbolLayerStatePatches.push(()=>{this._patchTask=u.abortMaybe(this._patchTask);this._patchTask=A.createTask(g=>this._context.schedule(async(f,k)=>{f=await A.result(d.fromUrl(c,h,{signal:k}));p.throwIfAborted(k);(k=!f.ok)&&p.throwIfAbortError(f.error);this._textureHandle=u.releaseMaybe(this._textureHandle);this._patchTask=null;if(k)this._forEachMaterial(t=>
{t.visible=!1;t.setParameters({textureId:null})}),this.logger.error(new B("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${c})`));else{this._textureHandle=f.value;var l=f.value.texture;this._size=this._computeSizeFromTexture(l,e);this._forEachMaterial(t=>{t.setParameters({textureId:l.id});t.visible=!0})}},g))});delete b.href}}}_defaultElevationInfoNoZ(){return ma}_createAs3DShape(a,b,c,d,e,h,g){a=this.getFastUpdateAttrValues(a);const f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,
layerUid:this._context.layer.uid});d=I.createPointGeometry(c,L,null,d,e,na,null,a,f);g=F.createStageObject(this._context,b,d,h,g);if(null==g)return null;const k=new fa.Graphics3DObject3DGraphicLayer(this,g.object,[d],null,null,da.perObjectElevationAligner,h);k.alignedSampledElevation=g.sampledElevation;k.needsElevationUpdates=m.needsElevationUpdates2D(h.mode)||"absolute-height"===h.mode;k.getScreenSize=this._createScreenSizeGetter(e,a);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),
1,l);F.extendPointGraphicElevationContext(k,b,this._context.elevationProvider);return k}_createAsOverlay(a,b,c,d,e,h){c.renderPriority=this._renderPriority;const g=r.create();T.projectPointToVector(b,g,this._context.overlaySR);g[2]=ja.drapedZ;b=this._context.clippingExtent;if(null!=b&&!U.containsPoint(b,g))return null;b=this.getFastUpdateAttrValues(a);const f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a.uid,layerUid:this._context.layer.uid});d=I.createPointGeometry(c,L,g,
d,e,null,null,b,f);a=new ka.RenderGeometry(d,{layerUid:h,graphicUid:a.uid});const k=new ea.Graphics3DDrapedGraphicLayer(this,[a],null,this._context.drapeSourceRenderer);k.getScreenSize=this._createScreenSizeGetter(e,b);k.calculateRelativeScreenBounds=l=>c.calculateRelativeScreenBounds(k.getScreenSize(),1,l);return k}_createScreenSizeGetter(a,b){const c=this._outlineSize+2;if(this._fastUpdates&&b){const h=a[0]/this._symbolTextureRatio,g=a[1]/this._symbolTextureRatio;return(f=v.create())=>{const [k,
l]=x.evaluateModelTransformScale(oa,this._fastUpdates.materialParameters,b);f[0]=k*h+c;f[1]=l*g+c;return f}}const d=a[0]/this._symbolTextureRatio+c,e=a[1]/this._symbolTextureRatio+c;return(h=v.create())=>{h[0]=d;h[1]=e;return h}}_fastVisualVariableConvertOptions(){var a=Math.max(this._size[0],this._size[1]);const b=r.fromValues(a,a,a),c=q.px2pt(1);a*=c;a=r.fromValues(a,a,a);return new x.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},b,a,c)}_forEachMaterial(a){this._materials.forEach(a);
this._cimSymbolMaterials.forEach(a)}_computeSizeFromTexture({parameters:a},b){a=(a.width??1)/(a.height??1);return 1<a?[b,Math.round(b/a)]:[Math.round(b*a),b]}test(){return{...super.test(),material:this._materials[0]}}}z.PRIMITIVE_SIZE=[M*n,M*n];z.elevationModeChangeTypes={definedChanged:m.SymbolUpdateType.UPDATE,staysOnTheGround:m.SymbolUpdateType.NONE,onTheGroundChanged:m.SymbolUpdateType.RECREATE};const ma={mode:"relative-to-ground",offset:0},na=S.fromValues(0,0,0,1),oa=r.create();H.Graphics3DIconSymbolLayer=
z;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});