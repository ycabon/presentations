// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../Color ../../../../core/has ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/typedArrayUtil ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/projection/computeTranslationToOriginAndRotation ../../../../geometry/projection/projectPointToVector ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./defaultSymbolComplexity ./ElevationAligners ./elevationAlignmentUtils ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./Loadable ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./SymbolComplexity ./webStyleUtils ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/pbrUtils".split(" "),
function(P,N,Q,Y,R,Z,E,S,q,l,y,aa,ba,t,ca,F,T,da,G,ea,fa,B,H,ha,ia,ja,I,U,ka,la,x,J,z,ma,v,na,oa){class V{constructor(b,a,c,d,f,e,h,g,n,m,k,u){this.lodResources=b;this.lodRenderer=a;this.stageResources=c;this.originalMaterialParameters=d;this.resourceSize=f;this.isEsriSymbolResource=e;this.isWosr=h;this.resourceBoundingBox=g;this.symbolSize=n;this.extentPadding=m;this.physicalBasedRenderingEnabled=k;this.pivotOffset=u}}class pa extends fa.Graphics3DSymbolLayer{getCachedSize(){const [b,a,c]=null!=
this._resources?this._resources.symbolSize:[1,1,1];return{width:b,depth:a,height:c}}constructor(b,a,c,d){super(b,a,c,d);this._resources=null;this._optionalFields=[];this._instanceIndexToGraphicUid=new Map;this._hasLoadedPBRTextures=!1;this._disposeResourceHandles=[];this.skipHighSymbolLodsChanged=!1;this.ensureDrapedStatus(!1);this._hasLoadedPBRTextures=c.physicalBasedRenderingEnabled}async doLoad(b){if(!this._drivenProperties.size&&B.validateSymbolLayerSize(this.symbolLayer))throw Error();if(this._isPrimitive){var a=
this.symbolLayer.resource;a=a&&U.isValidPrimitive(a.primitive)?a.primitive:ca.defaultPrimitive;this._resources=await this._createResourcesForPrimitive(a,b)}else a=(await la.getResourceUrlFromSymbolStyle(this.symbol.styleOrigin))?.href??this.symbolLayer.resource.href,this._resources=await this._createResourcesForUrl(a,b);this.layerOpacityChanged();this.slicePlaneEnabledChanged();this.physicalBasedRenderingChanged();this.complexity=this.computeComplexity()}get extentPadding(){return null!=this._resources?
this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}_setMaterialTransparencyParameters(b,a=this.symbolLayer?.material?.color){a=this._getCombinedOpacity(a);const c=1>a||this.needsDrivenTransparentPass;b.transparent=c;b.opacity=a;b.cullFace=c?J.CullFaceOptions.None:J.CullFaceOptions.Back;return b}async _createResourcesForPrimitive(b,a){var c=
this.symbolLayer;const d=t.create(F.objectSymbolLayerPrimitiveBoundingBox(b)),f=l.fromArray(t.size(d)),e=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(f,c)),h=q.length(e);var g={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[...oa.defaultSchematicMRRFactors],ambient:l.ONES,diffuse:l.ONES,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const n=!!g.usePBR;
this._setMaterialTransparencyParameters(g);const m=this.symbol;if("point-3d"===m.type&&m.verticalOffset){const {screenLength:k,minWorldLength:u,maxWorldLength:p}=m.verticalOffset;g.verticalOffset={screenLength:R.pt2px(k),minWorldLength:u||0,maxWorldLength:null!=p?p:Infinity};g.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(g.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?g.externalColor=y.ONES:(c=null!=c.material?c.material.color:
null,c=null!=c?N.toUnitRGBA(c):y.ONES,g.externalColor=c);this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(d,e,f,null));g.isInstanced=!0;this._fastUpdates?(Object.assign(g,this._fastUpdates.materialParameters),this._optionalFields.push(z.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(g.hasInstancedColor=!0,this._optionalFields.push(z.VertexAttribute.COLOR));Q("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(z.VertexAttribute.OBJECTANDLAYERIDCOLOR);
g=new na.DefaultMaterial(g);g=U.primitiveLodResources(b,g);if(!g)throw Error(`Unknown object symbol primitive: ${b}`);b=v.materialsFromLodResources(g).map(k=>({opacity:1,transparent:k.parameters.transparent}));c=await this._createStageResources(g,n,a);a=await this._createLodRenderer(g,a);return new V(g,a,c,b,f,!1,!1,d,e,h,n,null)}async _createResourcesForUrl(b,a){var c={materialParameters:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,
cache:this._context.sharedResources.objectResourceCache};(this._fastUpdates=x.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)))?(Object.assign(c.materialParameters,this._fastUpdates.materialParameters),this._optionalFields.push(z.VertexAttribute.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(c.materialParameters.hasInstancedColor=!0,this._optionalFields.push(z.VertexAttribute.COLOR));Q("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(z.VertexAttribute.OBJECTANDLAYERIDCOLOR);
var d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const {screenLength:r,minWorldLength:K,maxWorldLength:C}=d.verticalOffset;c.materialParameters.verticalOffset={screenLength:R.pt2px(r),minWorldLength:K||0,maxWorldLength:null!=C?C:Infinity};c.materialParameters.castShadows=!1}d=this._context.physicalBasedRenderingEnabled;c.signal=a;c.usePBR=d;c.skipHighLods=this._context.skipHighSymbolLods;var f=await ja.fetch(b,c);b=f.isEsriSymbolResource;c=f.isWosr;const e=ia.makeLodResources(f.lods),h=
this._context,g=this._getExternalColorParameters(this.symbolLayer.material),n=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:!0}),m=this.needsDrivenTransparentPass;var k=v.materialsFromLodResources(e);const u=v.materialsFromLodResources(e).map(r=>({opacity:r.parameters.opacity||1,transparent:r.parameters.transparent}));k.forEach(r=>{const K=r.parameters;r.setParameters(g);const C=K.opacity*n;r.setParameters({opacity:C,transparent:1>C||m||K.transparent});h.screenSizePerspectiveEnabled&&
r.setParameters({screenSizePerspective:h.sharedResources.screenSizePerspectiveSettings})});f=f.referenceBoundingBox;const p=l.fromArray(t.size(f)),w=l.fromArray(e.levels[0].pivotOffset),D=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(p,this.symbolLayer)),qa=q.length(D),W=this._fastUpdates;x.updateFastSymbolUpdatesState(W,this._context.renderer,this._fastVisualVariableConvertOptions(f,D,p,w))&&k.forEach(r=>r.setParameters(W.materialParameters));k=await this._createStageResources(e,d,a);a=await this._createLodRenderer(e,
a);return new V(e,a,k,u,p,b,c,f,D,qa,d,w)}_addDisposeResource(b){this._disposeResourceHandles.push(b)}async _createStageResources(b,a,c){const d=this._context.stage,f=v.materialsFromLodResources(b);a!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();d.addMany(f);this._addDisposeResource(()=>d.removeMany(f));const e=v.texturesFromLodResources(b);d.addMany(e);this._addDisposeResource(()=>{e.forEach(g=>g.unload());d.removeMany(e)});await Promise.all(e.map(g=>this._context.stage.schedule(()=>
g.load(d.renderView.renderingContext),c)));Y.throwIfAborted(c);const h=v.geometriesFromLodResources(b);d.addMany(h);this._addDisposeResource(()=>d.removeMany(h));return{materials:f,textures:e,geometries:h}}async _createLodRenderer(b,a){const c=this._context.stage,d=this._fastUpdates,f=new ma.LodRenderer({symbol:b,optionalFields:this._optionalFields,metadata:{layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),
notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},shaderTransformation:d?{applyTransform:(e,h,g)=>{e.getFeatureAttribute(h,L);E.copy(g,x.evaluateModelTransform(d.materialParameters,L,g))},scaleFactor:(e,h,g)=>{h.getFeatureAttribute(g,L);x.evaluateModelTransformScale(e,d.materialParameters,L)}}:null},this._context.scheduler);f.slicePlaneEnabled=this._context.slicePlaneEnabled;this._addDisposeResource(()=>{c.removeRenderPlugin(f);
f.destroy()});await c.addRenderPlugin(f,a);return f}_getExternalColorParameters(b){const a={};this._drivenProperties.color?a.externalColor=y.ONES:null!=b?.color?a.externalColor=N.toUnitRGBA(b.color):(a.externalColor=y.ONES,a.colorMixMode="ignore");return a}destroy(){super.destroy();this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(b=>b());this._disposeResourceHandles.length=0;this._resources=null}createGraphics3DGraphic(b){const a=b.graphic;if(!this._validateGeometry(a.geometry))return null;
const c=I.placePointOnGeometry(a.geometry);if(null==c)return this.logger.warn(`unsupported geometry type for icon symbol: ${a.geometry.type}`),null;const d=this.setGraphicElevationContext(a);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid,b.layer.uid)}notifyDestroyGraphicLayer(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null!=this._resources){var b=this._drivenProperties.opacity,a=!this._isPrimitive,c=this._resources.stageResources.materials,
d=this._resources.originalMaterialParameters;for(let e=0;e<c.length;e++){const h=c[e];var f=d[e];const g=this._getCombinedOpacity(this.symbolLayer?.material?.color,{hasIntrinsicColor:a})*f.opacity;f=1>g||b||f.transparent;h.setParameters({opacity:g,transparent:f});this._isPrimitive&&h.setParameters({cullFace:f?J.CullFaceOptions.None:J.CullFaceOptions.Back})}}}layerElevationInfoChanged(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,G.needsElevationUpdates3D)}slicePlaneEnabledChanged(){if(null==
this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const b of this._resources.stageResources.materials)b.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const {stageResources:b,isWosr:a}=this._resources;for(const c of b.materials)this._isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!1});return!1===this._hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this._hasLoadedPBRTextures=!0,!1):!0}applyRendererDiff(b,a){if(null==this._resources)return H.ApplyRendererDiffResult.RecreateSymbol;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:f,symbolSize:e,resourceSize:h,pivotOffset:g}=this._resources;for(const n in b.diff)switch(n){case "visualVariables":if(x.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(f,
e,h,g))){for(const m of c)m.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return H.ApplyRendererDiffResult.RecreateSymbol;break;default:return H.ApplyRendererDiffResult.RecreateSymbol}return H.ApplyRendererDiffResult.FastUpdate}computeComplexity(){if(null==this._resources)return super.computeComplexity();var b=this._resources.lodResources;const a=T.estimateNumVerticesForLods(b.levels),c=f=>Array.from(f.attributes.values()).reduce((e,h)=>e+Z.estimateSize(h.data,
h.indices),0),d=v.geometriesFromLodResources(b).reduce((f,e)=>f+c(e),0);b=v.texturesFromLodResources(b).reduce((f,e)=>f+e.memoryEstimate,0)+d;b={...T.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer),resourceBytes:b};return new ka.SymbolComplexity({verticesPerFeature:a,memory:b})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(b,a,c,d,f,e){if(!this._hasLodRenderer()||null==this._resources)return null;b=this.getFastUpdateAttrValues(b);var h=this._context.clippingExtent;
ba.projectPointToVector(a,A,this._context.elevationProvider.spatialReference);if(null!=h&&!t.containsPoint(h,A))return null;h=this._requiresTerrainElevation(d);const g=this._computeGlobalTransform(a,d,O,M),n=this._computeLocalTransform(this._resources,this.symbolLayer,c,X),m=this._resources.lodRenderer.instanceData,k=m.addInstance();this._instanceIndexToGraphicUid.set(k,f);m.setLocalTransform(k,n,!1);m.setGlobalTransform(k,g);b&&m.setFeatureAttribute(k,b);null==this._fastUpdates&&this._hasPerInstanceColor()&&
m.setColor(k,B.mixinColorAndOpacity(c.color,c.opacity,255));null!=this._context.stage.renderView.objectAndLayerIdRenderHelper&&m.setObjectAndLayerIdColor(k,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:f,layerUid:e}));c=new ea.Graphics3DLodInstanceGraphicLayer(this,k,da.perLodInstanceElevationAligner,d);h&&(c.alignedSampledElevation=M.sampledElevation);c.needsElevationUpdates=G.needsElevationUpdates3D(d.mode);I.extendPointGraphicElevationContext(c,
a,this._context.elevationProvider);return c}_computeGlobalTransform(b,a,c,d){G.evaluateElevationInfoAtPoint(b,this._context.elevationProvider,a,this._context.renderCoordsHelper,d);A[0]=b.x;A[1]=b.y;A[2]=d.z;aa.computeTranslationToOriginAndRotation(b.spatialReference,A,c,this._context.renderCoordsHelper.spatialReference);return c}_computeLocalTransform(b,a,c,d){E.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,a,d);return d}_applyObjectScale(b,
a,c){this._fastUpdates?.requiresShaderTransformation||(b=B.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||E.scale(c,c,b))}prepareSymbolLayerPatch(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}}updateGeometry(b,a){if(null==this._resources)return!0;const c=a&&I.placePointOnGeometry(a);if(null==c)return!1;
a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;this._computeGlobalTransform(c,b.elevationContext,O,M);this._requiresTerrainElevation(b.elevationContext)&&(b.alignedSampledElevation=M.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,O,!0);I.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0}_preparePatchTransform(b,a){if((a.heading||a.tilt||a.roll||a.width||a.height||a.depth||a.anchor||a.anchorPosition)&&
null!=this._resources){var c=(p,w,D)=>(null!=p&&"complete"===p.type?p.newValue:w)??D,d=c(a.heading,this.symbolLayer.heading,0),f=c(a.tilt,this.symbolLayer.tilt,0),e=c(a.roll,this.symbolLayer.roll,0),h=c(a.width,this.symbolLayer.width,void 0),g=c(a.height,this.symbolLayer.height,void 0),n=c(a.depth,this.symbolLayer.depth,void 0),m=c(a.anchor,this.symbolLayer.anchor,void 0);c=c(a.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;
delete a.depth;delete a.anchor;delete a.anchorPosition;var k={heading:d,tilt:f,roll:e,anchor:m,anchorPosition:c},u=this._resources;this.loadStatus===ha.LoadStatus.LOADED&&b.symbolLayerStatePatches.push(()=>{u.symbolSize=l.fromArray(F.objectSymbolLayerSizeWithResourceSize(u.resourceSize,{width:h,height:g,depth:n,isPrimitive:this.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push((p,w)=>{w=this._computeLocalTransform(u,k,w,X);u.lodRenderer.instanceData.setLocalTransform(p.instanceIndex,w,
!0)})}}_preparePatchColor(b,a){if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var c=a.color.newValue,d=null!=c?N.toUnitRGBA(c):y.ONES;delete a.color;var f=this._resources;null!=f&&b.graphics3DGraphicPatches.push(e=>{this._hasPerInstanceColor()?(f.lodRenderer.instanceData.setColor(e.instanceIndex,d),e=this._setMaterialTransparencyParameters({},c)):e=this._setMaterialTransparencyParameters({externalColor:d},
c);for(const h of f.stageResources.materials)h.setParameters(e)})}}_requiresTerrainElevation(b){return"absolute-height"!==b.mode}_applyObjectRotation(b,a,c){if(!this._fastUpdates?.requiresShaderTransformation||!a)return B.computeObjectRotation(b.heading,b.tilt,b.roll,c)}_computeAnchor(b,a,c){const d=l.create();switch(c.anchor){case "center":q.copy(d,t.center(b));q.negate(d,d);break;case "top":a=t.center(b);q.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=t.center(b);q.set(d,-a[0],-a[1],-b[2]);break;
case "relative":a=t.center(b);b=t.size(b);c=(c=c.anchorPosition)?l.fromValues(c.x,c.y,c.z):l.ZEROS;q.multiply(d,b,c);q.add(d,d,a);q.negate(d,d);break;default:null!=a?q.negate(d,a):q.copy(d,l.ZEROS)}return d}_applyAnchor(b,a,c){this._fastUpdates?.requiresShaderTransformation||(b=this._computeAnchor(b.resourceBoundingBox,b.pivotOffset,a))&&E.translate(c,c,b)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(b,a,c,d){const f=
null!=b?l.fromArray(t.size(b)):l.ONES;b=null!=b?this._computeAnchor(b,d,this.symbolLayer):l.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=B.computeObjectScale(null!=a?a:void 0,a,c,d);const e=l.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new x.ConvertOptions({size:!0,color:!0,rotation:!0,opacity:!1},f,a??l.ONES,d,b,c,e)}}const A=l.create(),X=S.create(),O=S.create(),L=y.create(),M=new G.SampleElevationInfo;P.Graphics3DObjectSymbolLayer=
pa;Object.defineProperty(P,Symbol.toStringTag,{value:"Module"})});