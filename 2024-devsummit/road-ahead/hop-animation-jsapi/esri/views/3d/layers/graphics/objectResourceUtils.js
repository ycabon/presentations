// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/devEnvironmentUtils ../../../../core/libs/gl-matrix-2/math/mat3 ../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec2 ../../../../chunks/vec33 ../../../../chunks/vec43 ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ProcessedObjectResource ./wosrLoader ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../webgl-engine/materials/pbrUtils".split(" "),
function(L,aa,V,ba,ca,da,z,Q,R,M,C,N,S,ea,fa,ha,ia,ja,ka,T,G,la,W,X,H,D,ma,na,I,U,F,O){function Y(g){const c=g.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return c?{fileType:"gltf",url:c[1],specifiedLodIndex:null!=c[4]?Number(c[4]):null}:g.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:g,specifiedLodIndex:null}:{fileType:"unknown",url:g,specifiedLodIndex:null}}function Z(g,c,k,t){const A=g.model,x=[],f=new Map,u=new Map,a=A.lods.length,h=R.empty();A.lods.forEach((v,l)=>{const m=!0===t.skipHighLods&&
(1<a&&0===l||3<a&&1===l)||!1===t.skipHighLods&&null!=t.singleLodIndex&&l!==t.singleLodIndex;if(!m||0===l){var p=new la.ProcessedObjectResource(v.name,v.lodThreshold,[0,0,0]);v.parts.forEach(b=>{const d=m?new U.DefaultMaterial({}):oa(A,b,p,c,k,f,u);var B=null!=d?d:new U.DefaultMaterial({});const q=b.attributes.position.count,r=ka.convertPrimitiveToTriangles(b.indices||q,b.primitiveType);var n=M.newFloatArray(3*q);const {typedBuffer:w,typedBufferStride:E}=b.attributes.position;N.transformMat4(n,w,b.transform,
3,E);n=[[I.VertexAttribute.POSITION,new H.Attribute(n,r,3,!0)]];if(null!=b.attributes.normal){var e=M.newFloatArray(3*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.normal;V.normalFromMat4(P,b.transform);N.transformMat3(e,J,P,3,K);n.push([I.VertexAttribute.NORMAL,new H.Attribute(e,r,3,!0)])}if(null!=b.attributes.tangent){e=M.newFloatArray(4*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.tangent;V.normalFromMat4(P,b.transform);S.transformMat3(e,J,P,4,K);n.push([I.VertexAttribute.TANGENT,
new H.Attribute(e,r,4,!0)])}if(null!=b.attributes.texCoord0){e=M.newFloatArray(2*q);const {typedBuffer:J,typedBufferStride:K}=b.attributes.texCoord0;ea.normalizeIntegerBuffer(e,J,2,K);n.push([I.VertexAttribute.UV0,new H.Attribute(e,r,2,!0)])}null!=b.attributes.color&&(e=new Uint8Array(4*q),4===b.attributes.color.elementCount?b.attributes.color instanceof C.BufferViewVec4f?S.scale(e,b.attributes.color,255):b.attributes.color instanceof C.BufferViewVec4u8?ha.copy(e,b.attributes.color):b.attributes.color instanceof
C.BufferViewVec4u16&&S.scale(e,b.attributes.color,1/256):(e.fill(255),b.attributes.color instanceof C.BufferViewVec3f?N.scale(e,b.attributes.color,255,4):b.attributes.color instanceof C.BufferViewVec3u8?fa.copy(e,b.attributes.color.typedBuffer,4,b.attributes.color.typedBufferStride):b.attributes.color instanceof C.BufferViewVec3u16&&N.scale(e,b.attributes.color,1/256,4)),n.push([I.VertexAttribute.COLOR,new H.Attribute(e,r,4,!0)]));b={geometry:new ma.Geometry(B,n),vertexCount:q};const {geometry:y,
vertexCount:pa}=b;b=y.boundingInfo;null!=b&&0===l&&(R.expandWithVec3(h,b.bbMin),R.expandWithVec3(h,b.bbMax));null!=d&&(p.stageResources.geometries.push(y),p.numberOfVertices+=pa)});m||x.push(p)}});return{engineResources:x,referenceBoundingBox:h}}function oa(g,c,k,t,A,x,f){const u=c.material+(c.attributes.normal?"_normal":"")+(c.attributes.color?"_color":"")+(c.attributes.texCoord0?"_texCoord0":"")+(c.attributes.tangent?"_tangent":""),a=g.materials.get(c.material);var h=null!=c.attributes.texCoord0;
const v=null!=c.attributes.normal;if(null==a)return null;a:{switch(a.alphaMode){case "BLEND":var l=D.AlphaDiscardMode.Blend;break a;case "MASK":l=D.AlphaDiscardMode.Mask;break a;case "OPAQUE":case null:case void 0:l=D.AlphaDiscardMode.Opaque;break a}l=void 0}if(!x.has(u)){if(h){var m=(w,E=!1)=>{if(null!=w&&!f.has(w)){const e=g.textures.get(w);if(null!=e){const y=e.data;f.set(w,new na.Texture(T.isEncodedMeshTexture(y)?y.data:y,{...e.parameters,preMultiplyAlpha:T.isEncodedMeshTexture(y)?!1:E,encoding:T.isEncodedMeshTexture(y)&&
null!=y.encoding?y.encoding:void 0}))}}};m(a.textureColor,l!==D.AlphaDiscardMode.Opaque);m(a.textureNormal);m(a.textureOcclusion);m(a.textureEmissive);m(a.textureMetallicRoughness)}m=a.color[0]**(1/F.colorGamma);const p=a.color[1]**(1/F.colorGamma),b=a.color[2]**(1/F.colorGamma),d=a.emissiveFactor[0]**(1/F.colorGamma),B=a.emissiveFactor[1]**(1/F.colorGamma),q=a.emissiveFactor[2]**(1/F.colorGamma),r=null!=a.textureColor&&h?f.get(a.textureColor):null,n=O.useSchematicPBR({normalTexture:a.textureNormal,
metallicRoughnessTexture:a.textureMetallicRoughness,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,emissiveTexture:a.textureEmissive,emissiveFactor:a.emissiveFactor,occlusionTexture:a.textureOcclusion});x.set(u,new U.DefaultMaterial({...t,transparent:l===D.AlphaDiscardMode.Blend,customDepthTest:D.DepthTestFunction.Lequal,textureAlphaMode:l,textureAlphaCutoff:a.alphaCutoff,diffuse:[m,p,b],ambient:[m,p,b],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",
cullFace:a.doubleSided?D.CullFaceOptions.None:D.CullFaceOptions.Back,hasVertexColors:!!c.attributes.color,hasVertexTangents:!!c.attributes.tangent,normalType:v?X.NormalType.Attribute:X.NormalType.ScreenDerivative,castShadows:!0,textureId:null!=r?r.id:void 0,colorMixMode:a.colorMixMode,normalTextureId:null!=a.textureNormal&&h?f.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:null!=r&&!!r.parameters.preMultiplyAlpha,occlusionTextureId:null!=a.textureOcclusion&&h?f.get(a.textureOcclusion).id:
void 0,emissiveTextureId:null!=a.textureEmissive&&h?f.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=a.textureMetallicRoughness&&h?f.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[d,B,q],mrrFactors:n?[...O.defaultSchematicMRRFactors]:[a.metallicFactor,a.roughnessFactor,t.mrrFactors[2]],isSchematic:n,colorTextureTransformMatrix:G.getTransformMatrix(a.colorTextureTransform),normalTextureTransformMatrix:G.getTransformMatrix(a.normalTextureTransform),occlusionTextureTransformMatrix:G.getTransformMatrix(a.occlusionTextureTransform),
emissiveTextureTransformMatrix:G.getTransformMatrix(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:G.getTransformMatrix(a.metallicRoughnessTextureTransform),...A}))}c=x.get(u);k.stageResources.materials.push(c);h&&(h=p=>{null!=p&&k.stageResources.textures.push(f.get(p))},h(a.textureColor),h(a.textureNormal),h(a.textureOcclusion),h(a.textureEmissive),h(a.textureMetallicRoughness));return c}const P=ba.create();L.fetch=async function(g,c){g=Y(aa.adjustStaticAGOUrl(g));if("wosr"===
g.fileType){g=await (c.cache?c.cache.loadWOSR(g.url,c):W.load(g.url,c));const {engineResources:v,referenceBoundingBox:l}=W.processLoadResult(g,c);return{lods:v,referenceBoundingBox:l,isEsriSymbolResource:!1,isWosr:!0}}const k=await (c.cache?c.cache.loadGLTF(g.url,c,!!c.usePBR):ja.loadGLTF(new ia.DefaultLoadingContext(c.streamDataRequester),g.url,c,c.usePBR)),t=k.model.meta?.ESRI_proxyEllipsoid,A=k.meta.isEsriSymbolResource&&null!=t&&"EsriRealisticTreesStyle"===k.meta.ESRI_webstyle;if(A&&!k.customMeta.esriTreeRendering){k.customMeta.esriTreeRendering=
!0;a:for(let v=0;v<k.model.lods.length;++v){var x=k.model.lods[v];for(var f of x.parts){x=f.attributes.normal;if(null==x)break a;const l=f.attributes.position,m=l.count,p=Q.create(),b=Q.create(),d=Q.create(),B=new Uint8Array(4*m),q=new Float64Array(3*m),r=ca.invert(da.create(),f.transform);let n=0,w=0;for(let E=0;E<m;E++){l.getVec(E,b);x.getVec(E,p);z.transformMat4(b,b,f.transform);z.subtract(d,b,t.center);z.divide(d,d,t.radius);const e=d[2];var u=z.length(d);u=Math.min(.45+.55*u*u,1);z.divide(d,
d,t.radius);null!==r&&z.transformMat4(d,d,r);z.normalize(d,d);v+1!==k.model.lods.length&&1<k.model.lods.length&&(-1<e?z.lerp(d,d,p,.2):z.lerp(d,d,p,Math.min(-4*e-3.8,1)));q[n]=d[0];q[n+1]=d[1];q[n+2]=d[2];n+=3;B[w]=255*u;B[w+1]=255*u;B[w+2]=255*u;B[w+3]=255;w+=4}f.attributes.normal=new C.BufferViewVec3f(q);f.attributes.color=new C.BufferViewVec4u8(B)}}}f=!!c.usePBR;f=k.meta.isEsriSymbolResource?{usePBR:f,isSchematic:!1,treeRendering:A,mrrFactors:[...O.defaultEsriSymbologyMRRFactors]}:{usePBR:f,isSchematic:!1,
treeRendering:!1,mrrFactors:[...O.defaultAdvancedMRRFactors]};const {engineResources:a,referenceBoundingBox:h}=Z(k,f,{...c.materialParameters,treeRendering:A},c.skipHighLods&&null==g.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:g.specifiedLodIndex});return{lods:a,referenceBoundingBox:h,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1}};L.gltfToEngineResources=Z;L.parseUrl=Y;Object.defineProperty(L,Symbol.toStringTag,{value:"Module"})});