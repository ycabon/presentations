// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../geometry/projection/projectBoundingSphere ../../../../chunks/sphere ../../../../support/featureFlags ./I3SNode ./I3SUtil ./ValidatedNode ../../support/ElevationRange ../../support/orientedBoundingBox".split(" "),function(F,O,C,L,G,y,P,t,w,Q,R,H){function z(a,b){return 0>a?-1:0<b?a/b|0:0}function v(a,b){return 0>a?-a-1:0===b?a:a%b}function E(a,b,c){return-1===b?-(a+1):0===c?a:b*c+a}function M(a){if(a)for(let b=
0;b<a.length;b++)for(const c of S)if(c[0]===a[b].metricType)return{lodMetric:c[1],maxError:a[b].maxError};return{lodMetric:t.LodMetric.None,maxError:0}}function T(a){return Math.sqrt(4/Math.PI*a)}class I{constructor(a,b,c,d,e){this.childOffset=a;this.childCount=b;this.visibilityCache=c;this.ref=d;this.node=e;this.useAsHole=0;this.filterImpact=t.NodeFilterImpact.NotChecked;this.traversalState=null;this.parent=-1}}class J{constructor(a=[],b=[]){this.nodes=a;this.children=b;this.numNodesWithLoadedChildren=
this.lastTraversed=0}}class U{get _useNodePages(){return 0<this._pageSize}constructor(a,b,c,d,e,g,k,h,l,f,m,r,q,n,p,x){this.viewingMode=a;this._layer=b;this._streamDataController=d;this._clientNodeLoader=e;this._viewportQueries=g;this._logger=k;this.holeFilling=h;this._isLoaded=l;this._isReloading=f;this._isSelected=m;this._enable=r;this._needsUpdate=q;this._canRequest=n;this._computeVisibilityObb=p;this._computeNodeFiltering=x;this._dirty=!0;this._nodePages=new Map;this._clientNodePage=null;this._rootIndex=
this._pageSize=0;this._lodMetric=t.LodMetric.None;this._lodConversion=B=>B;this._isEditable=!1;this._urlPrefix="";this._loadingNodes=new Set;this._loadingPages=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._version=w.addWraparound(0,2);this._visibilityCacheVersion=w.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=
0;this._missingPagesAndNodes=new C({deallocator:null});this._prefetchNodes=new C({deallocator:null});this._updates=new V(this._missingPagesAndNodes);this._imModificationUncategorized=new C({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._newPages=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=!1;this._frameNumber=0;this._traverseDescendantsQueue=[0];this._traverseDescendantsNestingLevel=0;this._isEditable=P.i3sPatchingEnabled()&&
null!=b.associatedLayer?.infoFor3D;b.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${b.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(c)}_init(a){if("page"===a.type){var b=a.rootPage;this._urlPrefix=a.urlPrefix;this._pageSize=a.pageSize;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=t.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=t.LodMetric.MaxScreenThreshold,this._lodConversion=
T}if(this._isEditable){this._rootIndex=-1;var c=v(a.rootIndex,a.pageSize);c=b.nodes[c];c={nodes:[{index:this._rootIndex,children:[a.rootIndex],mesh:void 0,obb:c.obb,lodThreshold:c.lodThreshold}]};this._addPage(z(this._rootIndex,this._pageSize),c);this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=a.rootIndex;this._addPage(z(a.rootIndex,this._pageSize),b);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,b=new J,this._nodePages.set(0,b),this._isEditable?
(this._clientNodePage=new J,b={id:"-1",version:null,mbs:a.rootNode.mbs,obb:a.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:a.rootNode.mbs,obb:a.rootNode.obb}]},this._rootIndex=this._makeClientRefNode(new t.NodeBase(b.id,null),-1),(b=this._validateNode(b.id,b))&&this._addNode(b,this._rootIndex)):this._rootIndex=this._makeRefNode(new t.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,a.rootNode))&&this._addNode(a,
0))}addClientNodeToIndex(a,b){a=new t.NodeBase(a,b);a=this._makeClientRefNode(a,-1);this._linkChildToParentNode(-1,a);this.requestUpdate();return a}removeClientNodeFromIndex(a,b,c){this._destroyClientRefNode(a,b,c);this.requestUpdate()}_loadPage(a){this._loadingPages.add(a);this._streamDataController.request(this._urlPrefix+a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loadingPages.delete(a);L.isAbortError(b)||(this._failedPages.add(a),this._logger.error("#loadPage()",
this._layer,`Error when loading page ${a}`,b))})}_addQueuedPages(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);this._loadingPages.delete(b);a.madeProgress();this.needNodeElevationRange&&this._newPages.push(b)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(a){if(this.needNodeElevationRange)for(;0<this._newPages.length&&!a.done;)this._nodePages.get(this._newPages.shift())?.nodes.forEach(b=>{for(b=b.parent;null!=
b&&b!==this._rootIndex;){const c=this.getNode(b);c&&!Number.isNaN(c?.elevationRangeMin)&&(c.invalidateElevationRange(),this.invalidateBoundingVolumeCache(b));b=this.getParentIndex(b)}})}_addPage(a,b){const c=[],d=[];b=b.nodes.map((e,g)=>{const k=c.length,h=e.children?e.children.length:0;d.push(this._rootIndex);for(var l=0;l<h;l++)c.push(e.children[l]);const f=`${e.index}`;l=H.Obb.fromJSON(e.obb);const m=y.fromCenterAndRadius(l.center,l.radius);var r=e.mesh?.attribute;const q=e.mesh?.geometry,n=e.mesh?.material;
r={hasSharedResource:!1,isEmpty:null==q,attributes:null!=r?.resource?`${r.resource}`:void 0,geometry:null!=q?.resource?`${q.resource}`:void 0,texture:null!=n?.resource?`${n.resource}`:void 0,geometryDefinition:q?q.definition:-1,materialDefinition:n?n.definition:-1};e=new t.Node(f,E(g,a,this._pageSize),m,h,0,r,this._lastUpdate,this._lodMetric,this._lodConversion(e.lodThreshold),q?q.featureCount:null);e.serviceObbInIndexSR=l;e.visibilityObbInRenderSR=this._computeVisibilityObb(e);e.vertexCount=q?q.vertexCount:
0;return new I(k,h,w.addWraparound(this._visibilityCacheVersion,-2),null,e)});b=new J(b,c);-1===a?this._clientNodePage=b:this._nodePages.set(a,b)}_updateParentsAndLevel(){const a=[],b=(c,d,e)=>{var g=this._getPage(c);if(null!=g){const k=v(c,this._pageSize);g=g.nodes[k];g.parent=null!=d?d:-1;d=g.node;null!=d&&(d.level=e,a.push(c))}};for(b(this._rootIndex,null,0);a.length;){const c=a.pop(),d=this.getNode(c);if(null!=d)for(let e=0;e<d.childCount;e++){const g=this.getChildIndex(d.index,e);b(g,c,d.level+
1);this._maxLevel=Math.max(this._maxLevel,d.level+1)}}}_getPage(a){a=z(a,this._pageSize);return this._getPageFromPageIndex(a)}_getPageFromPageIndex(a){return 0>a?this._clientNodePage:this._nodePages.get(a)}_getNodeInternal(a){const b=this._getPage(a);if(null==b)return null;b.lastTraversed=this._frameNumber;return b.nodes[v(a,this._pageSize)]}_addNode(a,b){a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);const d=null!=c?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,a.children?
d+1:d);const {lodMetric:e,maxError:g}=M(a.lodSelection);c=this._getNodeInternal(b);b=new t.Node(a.id,b,a.mbs,c.childCount,d,a.resources,a.version,e,g,a.numFeatures);c.node=b;a.obb&&(b.serviceObbInIndexSR=H.Obb.fromJSON(a.obb));b.visibilityObbInRenderSR=this._computeVisibilityObb(b);c=c.ref;null!=c&&(null==c.serviceMbsInIndexSR&&(c.serviceMbsInIndexSR=a.mbs),b.serviceMbsInRenderSR=c.serviceMbsInRenderSR,b.serviceObbInRenderSR=c.serviceObbInRenderSR,c.visibilityObbInRenderSR=b.visibilityObbInRenderSR);
return b}_makeRefNode(a,b){const c=this._nodePages.get(0);if(-1>b)return this._makeClientRefNode(a,b);if(null==c)return-1;const d=c.nodes.length,e=new I(0,0,w.addWraparound(this._visibilityCacheVersion,-2),a,null);c.nodes.push(e);e.parent=b;a.invalidateServiceBVsInRenderSR();return d}_makeClientRefNode(a,b){const c=this._clientNodePage;if(null==c)return-1;if(0<=b)throw Error("I3SIndex::client side nodes can not be made children of service side nodes.");const d=-(c.nodes.length+1),e=new I(0,0,w.addWraparound(this._visibilityCacheVersion,
-2),a,null);c.nodes.push(e);e.parent=b;a.invalidateServiceBVsInRenderSR();return d}_linkChildToParentNode(a,b){const c=this._clientNodePage;if(!(null==c||0<=a)){var d=v(a,this._pageSize),e=v(b,this._pageSize);d=c.nodes[d];var g=d.childOffset;c.children.splice(d.childOffset+d.childCount,0,b);d.childCount+=1;null!=d.node&&(d.node.childCount+=1);for(const k of c.nodes)k.childOffset>g&&(k.childOffset+=1);c.nodes[e].parent=a;this._updateParentBoundingInformation(a)}}_destroyClientRefNode(a,b,c){const d=
this._clientNodePage;if(null!=d){var e=this.getParentIndex(a);if(null!=e){var g=new Set,k=new Map,h=B=>{var A=v(B,this._pageSize);A=d.nodes[A];if(0<A.childCount)for(var D=A.childOffset;D<A.childOffset+A.childCount;++D)h(d.children[D]);D=A.node?.id??A.ref?.id;if(null==D)throw Error("Node has no id");b(D,B);g.add(A)};h(a);a=d.nodes;var l=d.children,f=d.nodes.map(()=>-1),m=[],r=[];for(var q=0;q<a.length;++q){var n=a[q];if(!g.has(n)){var p=m.length,x=E(q,-1,this._pageSize);p=E(p,-1,this._pageSize);n.node&&
(n.node.index=p);f[q]=p;m.push(n);if(x!==p){n=n.node?.id??n.ref?.id;if(null==n)throw Error("Node has no id");c(n,x,p);k.set(x,p)}}}for(c=0;c<m.length;++c){k=E(c,-1,this._pageSize);q=m[c];x=r.length;for(n=q.childOffset;n<q.childOffset+q.childCount;++n)if(p=l[n],0<=p)r.push(p);else{p=v(p,this._pageSize);const B=a[p];g.has(B)||(r.push(f[p]),B.parent=k)}q.childOffset=x;q.childCount=r.length-x;q.node&&(q.node.childCount=q.childCount)}d.nodes=m;d.children=r;this._updateParentBoundingInformation(f[v(e,this._pageSize)])}}}_updateParentBoundingInformation(a){do{let d=
null;var b=this._clientNodeLoader.indexSR;const e=this._clientNodeLoader.renderSR,g=this._getNodeInternal(a);if(null==g)break;for(let k=0;k<g.childCount;k++){var c=this.getChildIndex(a,k);c=this._getNodeInternal(c);c=null!=c?c.ref||c.node:null;if(null!=c&&0<c.serviceMbsInIndexSR[3])if(null==d)d=y.copy(c.serviceMbsInIndexSR,W);else{const h=X,l=Y,f=Z;G.projectBoundingSphere(c.serviceMbsInIndexSR,b,h,e);G.projectBoundingSphere(d,b,l,e);y.union(h,l,f);G.projectBoundingSphere(f,e,d,b)}}b=g.ref||g.node;
if(null!=b){if(null!=d){let k;(k=b).serviceMbsInIndexSR??(k.serviceMbsInIndexSR=y.create());y.copy(d,b.serviceMbsInIndexSR)}else w.invalidateMbs(b.serviceMbsInIndexSR);b.invalidateServiceBVsInRenderSR();b.geometryObbInRenderSR=null}this.invalidateNodeVisibilityCacheInternal(g);a=this.getParentIndex(a)}while(null!=a)}populateChildren(a,b){var c=this._getNodeInternal(a);const d=this._getPage(a);c.childOffset=d.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const e=this._makeRefNode(b[c],
a);d.children.push(e)}}getNode(a){a=this._getNodeInternal(a);return null!=a?a.node:null}getIndexById(a){let b;this._forAllNodes((c,d)=>{null!=c.node&&c.node.id===a?b=d:null!=c.ref&&c.ref.id===a&&(b=d)});return b}getNodeById(a){a=this.getIndexById(a);return null!=a&&0<=a?this.getNode(a):null}getChildIndex(a,b){const c=this._getPage(a);if(null==c)return-1;a=c.nodes[v(a,this._pageSize)];return c.children[a.childOffset+b]}getParentIndex(a){const b=this._getPage(a);return null!=b&&a!==this._rootIndex?
b.nodes[v(a,this._pageSize)].parent:null}getParent(a){a=this.getParentIndex(a);return null!=a?this.getNode(a):null}isLeaf(a){a=this._getNodeInternal(a);return null!=a&&0===a.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes(a=>{null!=a.node&&(a.node.geometryObbInRenderSR=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=w.addWraparound(this._visibilityCacheVersion,2)}invalidateNodeVisibilityCache(a){a=
this._getNodeInternal(a);null!=a&&this.invalidateNodeVisibilityCacheInternal(a)}invalidateNodeVisibilityCacheInternal(a){a.visibilityCache=w.addWraparound(this._visibilityCacheVersion,-2)}invalidateBoundingVolumeCache(a){a=this._getNodeInternal(a);null!=a&&(a.node?.invalidateServiceBVsInRenderSR(),a.ref?.invalidateServiceBVsInRenderSR(),this.invalidateNodeVisibilityCacheInternal(a))}updateElevationChanged(a){const b=this._getNodeInternal(a);null!=b&&(this.needNodeElevationRange?(a=null!=b.node?b.node:
b.ref,null!=a&&a.invalidateElevationRange()):this.invalidateBoundingVolumeCache(a))}invalidateGeometryVisibility(a){if(a=this._getNodeInternal(a)?.node)a.geometryObbInRenderSR=null,a.invalidateServiceBVsInRenderSR()}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,a=>{a.visibilityObbInRenderSR=this._computeVisibilityObb(a);a.geometryObbInRenderSR=null;return!0})}_updateElevationRange(a){this._updateElevationRangeInternal(a,null)}_updateElevationRangeInternal(a,b){const c=
this._getNodeInternal(a);if(!c)return!1;const d=c?.node??c?.ref;if(!d)return!1;if(d.elevationRangeValid)return b?.expandElevationRange(d),!0;const e=new R.ElevationRange;var g=!1;for(let k=0;k<c.childCount;k++){const h=this.getChildIndex(a,k);this._updateElevationRangeInternal(h,e)||(g=!0)}(0===c.childCount||g)&&this._viewportQueries.expandElevationRange(d,!c.node?.resources.isEmpty,e);g=d.elevationRangeMax;if(d.elevationRangeMin===e.elevationRangeMin&&g===e.elevationRangeMax)return b?.expandElevationRange(d),
!0;c.node?.setElevationRange(e);c.ref?.setElevationRange(e);this.invalidateBoundingVolumeCache(a);b?.expandElevationRange(d);return!0}isNodeVisible(a){const b=this._getNodeInternal(a);if(null==b)return!0;var c=b.ref;if(null!=c&&!c.serviceMbsInIndexSR)return!0;if(!this.needNodeElevationRange&&(b.visibilityCache&-2)===this._visibilityCacheVersion)return 1===(b.visibilityCache&1);var d=b.node;const e=this._viewportQueries;if(d&&0<d.level&&(e.ensureElevationAgnosticBoundingVolume(d,this.viewingMode),
!e.isElevationAgnosticBoundingVolumeVisible(this.viewingMode,d.elevationAgnosticBoundingVolume)))return b.visibilityCache=this._visibilityCacheVersion+0,!1;this.needNodeElevationRange&&this._updateElevationRange(a);return(b.visibilityCache&-2)!==this._visibilityCacheVersion?(this._layerHasFilter&&this._computeNodeFiltering&&(null!=d||null!=c)&&b.filterImpact===t.NodeFilterImpact.NotChecked&&(a=null!=d?d.serviceMbsInIndexSR:null!=c?c.serviceMbsInIndexSR:null,b.filterImpact=null!=a?this._computeNodeFiltering(a):
t.NodeFilterImpact.Unmodified),a=null!=d&&b.filterImpact===t.NodeFilterImpact.Culled,c=!d||c&&!d.visibilityObbInRenderSR?c??null:d,d=!(null!=d&&d.imModificationImpact===t.NodeIMModificationImpact.Culled)&&(!c||e.isNodeVisible(c))&&!a,b.visibilityCache=this._visibilityCacheVersion+(d?1:0),d):1===(b.visibilityCache&1)}isGeometryVisible(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);return null==a?.node?.geometryObbInRenderSR||this.layerHasModifications&&a.node.imModificationImpact===
t.NodeIMModificationImpact.NotChecked?!0:this._viewportQueries.isGeometryVisible(a.node)}_traverseCoverage(a,b,c,d,e){a=this._getPage(a);if(null!=a&&0!==b.childCount){var g=b.childOffset+b.childCount,k=[];for(b=b.childOffset;b<g;++b){const h=a.children[b],l=this._getNodeInternal(h);null!=l?.node&&this.isGeometryVisible(h)&&k.push(l)}d/=k.length;for(const h of k)a=h.node.index,this._isLoaded(a)||this._isReloading(a)?(e.delta=Math.max(e.delta,c),e.coverage+=d):this._traverseCoverage(a,h,c+1,d,e)}}useNodeAsHole(a){if("off"===
this.holeFilling)return!1;const b=this._getNodeInternal(a);if(null==b)return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+(a?1:0);return a}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune();this._updates.update.prune()}requestUpdate(){this._dirty=!0;this._indexMissing=1;this._version=
w.addWraparound(this._version,2)}imModificationsChanged(a){this.layerHasModifications=a;this._forAllNodes(({node:b})=>{null!=b&&(b.imModificationImpact=t.NodeIMModificationImpact.NotChecked,b.visibilityObbInRenderSR=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()}layerFilterChanged(a){this._layerHasFilter=a;this._forAllNodes(b=>{null!=b&&(b.filterImpact=t.NodeFilterImpact.NotChecked,b=b.node,null!=b&&this.invalidateNodeVisibilityCache(b.index))});
this.invalidateVisibilityCache()}update(a,b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._invalidateElevationRangeForNewPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missingPagesAndNodes.clear();this._prefetchNodes.clear();this._updates.reset(a);u.clear();var d=!0,e=new K,g=new K,k=this._imModificationUncategorized;k.clear();var h=new Set,l=0;this.traverseVisible((f,m,r)=>{var q=z(f,this._pageSize);if(null==m)f=this._entryPriority(f),
Infinity===f&&(f=this._entryPriority(r)),u.set(q,Math.max(f,u.get(q)||0)),this._loadingPages.has(q)||this._failedPages.has(q)||(this._missingPagesAndNodes.push(q),++l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,f);else{var n=m.node;this._updateNodeFeatureEstimate(n,g);if(null==n)m=this._entryPriority(f),this._loadingNodes.has(f)||this._failedNodes.has(f)||(this._missingPagesAndNodes.push(f),u.set(f,m)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m);else{r=this._getPage(f);
if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(q=0;q<m.childCount;q++){const p=r.children[m.childOffset+q],x=this._getNodeInternal(p);null==x||x.node||this._loadingNodes.has(p)||this._failedNodes.has(p)||(u.set(p,this._entryPriority(p)),this._prefetchNodes.push(p))}n.failed||n.resources.isEmpty?d&&0<m.childCount&&this._isSelected(n)&&(d=!1):this._isLoaded(f)?(e.known+=n.memory,++e.knownNodes,this._isSelected(n)?0<m.childCount&&(d=!1):(e.unremoved+=n.memory,d=!1),this._needsUpdate(n)&&
(m=this._entryPriority(f),u.set(f,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.update.push(f))):(n.memory&&(e.known+=n.memory,++e.knownNodes),this._isSelected(n)?(0<m.childCount&&(d=!1),n.memory?(e.missing+=n.memory,e.known+=n.memory,++e.knownNodes):++e.missingNodes,a.includes(n.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(f)),this._updates.cancel=this._updates.cancel.filter(p=>p!==n.index)):!b.done&&this._enable(n)?b.madeProgress():
(m=this._entryPriority(f),u.set(f,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.add.push(f),this.layerHasModifications&&c&&null!=n&&n.imModificationImpact===t.NodeIMModificationImpact.NotChecked&&k.push(f))):this._isReloading(f)&&this._updates.remove.push(f))}}},h);this._frameNumber++;this._missingPagesAndNodes.sort((f,m)=>f-m);this._missingPagesAndNodes.filterInPlace((f,m)=>1>m||this._missingPagesAndNodes.data[m-1]!==f);this._missingPagesAndNodes.sort((f,m)=>u.get(f)-
u.get(m));0<this._missingPagesAndNodes.length&&(this._maxUnloadedPrio=u.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear());this._removeUnusedNodePages(h,l);h=this._updates.add;0<h.length&&this.layerHasModifications&&(0<k.length&&c?.(k),h.filterInPlace(f=>{var m=this._getNodeInternal(f);(m=null==m?.node||m.node.imModificationImpact!==t.NodeIMModificationImpact.Culled)||this.invalidateNodeVisibilityCache(f);return m}));this._unloadedMemoryEstimate=e.missing-e.unremoved;3<e.knownNodes&&
0<e.missingNodes&&(this._unloadedMemoryEstimate+=e.known/e.knownNodes*e.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(g);this._featureEstimate.leavesReached=d;this._updates.add.filterInPlace(f=>u.get(f)>=this._maxUnloadedPrio).sort((f,m)=>u.get(f)-u.get(m));this._updates.update.sort((f,m)=>u.get(f)-u.get(m));this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length;
this._dirty=0<this._indexMissing;u.clear()}}checkFeatureTarget(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let d=b,e=b,g=c,k=10;for(;k--;){const h=new K;this._updateFeatureEstimate(d,h);if(this._computeFeatureEstimate(h)<=a){if(d>=b||0<h.missingNodes||0===k)break;g=d;d=.5*(d+e)}else e=d,d=.5*(d+g)}this._version=w.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,d)}_removeUnusedNodePages(a,b){if(this._useNodePages){var c=a.size,
d=this._nodePages;b=d.size+this._loadingPages.size+b;if(b>N&&b>c){c=[];for(const [e,g]of d)0!==g.numNodesWithLoadedChildren||a.has(e)||c.push([g.lastTraversed,e]);c.sort((e,g)=>e[0]-g[0]).some(e=>{this._deleteNodePage(e[1]);return d.size<=N})}}}_updateFeatureEstimate(a,b){this._version=w.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,d)=>this._updateNodeFeatureEstimate(null!=d?d.node:void 0,b))}_updateNodeFeatureEstimate(a,b){null!=a&&!a.failed&&
null!=a.numFeatures&&this._isSelected(a)&&(null!=a.numFeatures?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes)}_computeFeatureEstimate(a){let b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){this._prefetchNodes.sort((a,b)=>u.get(a)-u.get(b));return this._load(this._prefetchNodes)}_load(a){if(0===a.length||!this._canRequest())return!1;
for(;0<a.length&&this._canRequest();){const b=a.pop();this._useNodePages?0<=b?this._loadPage(b):this._loadNode(b):this._loadNode(b)}return!0}get isLoading(){return 0<this._indexMissing}get isPrefetching(){return 0<this._prefetchNodes.length}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,
this._maxUnloadedPrio)}nodeTraversalState(a){if(null==a)return null;const b=a.index,c=this._getNodeInternal(b);if(!c)return null;let d=c?.traversalState;if(d&&(d.version&-2)===this._version)return d;const e=this._viewportQueries.getLodLevel(a),g=this._viewportQueries.hasLOD(a);let k=!0;g?(a=this.getParentIndex(b),null!=a?(a=this._getNodeInternal(a)?.traversalState,k=!!a&&e>a.lodLevel):k=0<e):k=0===a.childCount;if(d)return d.lodLevel=e,d.isChosen=k,d.version=this._version+1,d;d=new t.NodeTraversalState(g,
k,e,this._version+1);return c.traversalState=d}async _loadNode(a){this._loadingNodes.add(a);var b=this._getNodeInternal(a).ref;if(null==b)this._failedNodes.add(a);else{b=b.id;var c=this._urlPrefix+b,d=()=>{this._loadingNodes.delete(a);0===this._missingPagesAndNodes.length&&0===this._loadingNodes.size&&this.requestUpdate()},e=null;try{e=0<=a?await this._streamDataController.request(c,"json"):await this._clientNodeLoader.loadNodeJSON(b)}catch(g){d();L.isAbortError(g)||(this._logger.error("#loadNode()",
this._layer,"Error loading node: "+c),this._failedNodes.add(a));return}d();b=this._validateNode(b,e);null!=b&&(b.obb&&this.invalidateNodeVisibilityCache(a),b=this._addNode(b,a),this.nodeTraversalState(b))}}_validateNode(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${a}.`),null;
b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${a}"`);var c=b.geometryData;null==c||Array.isArray(c)&&0===c.length||Array.isArray(c)&&1===c.length&&"./geometries/0"===c[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${a}"`);c=b.attributeData;const d=this._layer.attributeStorageInfo;null==c||Array.isArray(c)&&!c.some((h,l)=>h.href!==
`./attributes/${d?.[l]?.key??`f_${l}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",this._layer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:void 0;const e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+
1:void 0;var g=h=>{if(null==h)return null;var l=f=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${a}: ${f}`);if("number"===typeof h.id)l(`id ${h.id} is a number instead of a string.`);else if("string"!==typeof h.id||!Array.isArray(h.mbs))return l("Missing or invalid id."),null;if(!Array.isArray(h.mbs))return l(`Invalid bounding volume on reference ${h.id}.`),null;h.href&&h.href!=="../"+h.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${a}"`);
l=new t.NodeBase(`${h.id}`,h.mbs);l.serviceObbInIndexSR=!this.ignoreServiceObb&&h.hasOwnProperty("obb")&&h.obb?H.Obb.fromJSON(h.obb):null;l.visibilityObbInRenderSR=this._computeVisibilityObb(l);return l};g=Array.isArray(b.children)?b.children.map(g).filter(h=>null!=h):null;const k=!0===b.isEmpty;return new Q.ValidatedNode(a,b.mbs,c,"string"===typeof b.version?b.version:null,{isEmpty:!(b.featureData?.length??!1)&&k,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:void 0,texture:b.textureData&&
0<b.textureData.length?a:void 0,geometry:null!=b.geometryData?a:void 0},g,Array.isArray(b.lodSelection)?b.lodSelection:null,e)}resetFailedNodes(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>{null!=a.node&&(a.node.failed=!1)})}_entryPriority(a){var b=this._getNodeInternal(a),c=this.getParentIndex(a);if(null==b||null==c&&null==b.node)return null==c?Infinity:this._entryPriority(c);let d=0;b.node&&null!=c&&(c=this._getNodeInternal(c).traversalState,null!=c&&(d=c.lodLevel));
for(c=this.progressiveLoadPenalty;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=null!=b.ref?this._viewportQueries.distToPOI(b.ref):null!=b.node?this._viewportQueries.distToPOI(b.node):0;return-b-d*(b+this.progressiveLoadPenalty)+c}traverseVisible(a,b){const c=this._getNodeInternal(this._rootIndex);null==c?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,null,c,a,b)}_traverseVisible(a,b,c,d,e){var g=z(a,this._pageSize);e&&e.add(g);if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&
d(a,c,b);else if(this.isNodeVisible(a)&&(d(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b?.nodeHasLOD||b.lodLevel!==this._maxLodLevel)))for(g=this._getPageFromPageIndex(g),b=0;b<c.childCount;b++){const h=g.children[c.childOffset+b];var k=this._getNodeInternal(h);k?this._traverseVisible(h,a,k,d,e):(e&&(k=z(h,this._pageSize),e.add(k)),d(h,null,a))}}traverse(a,b){b(a)&&this.traverseDescendants(a,b)}traverseDescendants(a,b){++this._traverseDescendantsNestingLevel;var c=a.index;a=this._pageSize;
var d=z(c,a),e=this._getPageFromPageIndex(d);if(null!=e){var g=this._frameNumber,k=this._clientNodePage,h=this._nodePages;e.lastTraversed=g;var l=v(c,a),f=e.nodes[l];({childCount:l}=f);if(0!==l){l=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];var m=0,r=0,{childOffset:q,childCount:n}=f;for({children:f}=e;l.length<r+n;)l.length+=l.length;for(var p=q;p<q+n;++p)l[r]=f[p],++r;if(0<=c&&0<a)for(k=d*a,c=e.nodes;m<r;){f=l[m];++m;if(k<=f&&f<k+a)d=e;else{p=f/a|0;d=h.get(p);if(void 0===
d)continue;d.lastTraversed=g;e=d;c=e.nodes;k=a*p}f=c[f-k];p=f.node;if(null!=p&&!1!==b(p)&&({childCount:p}=f,0!==p)){for(;l.length<r+p;)l.length+=l.length;d=d.children;({childOffset:f}=f);for(p=f+p;f<p;++f)l[r]=d[f],++r}}else for(;m<r;)if(c=l[m],++m,d=0>c?-1:0<a?c/a|0:0,e=0>d?k:h.get(d))if(e.lastTraversed=g,c=e.nodes[0>c?-c-1:0===a?c:c-d*a],(d=c.node)&&b(d)&&({childCount:d}=c,0!==d)){for(;l.length<r+d;)l.length+=l.length;e=e.children;({childOffset:c}=c);for(d=c+d;c<d;++c)l[r]=e[c],++r}--this._traverseDescendantsNestingLevel}}}updateChildrenLoaded(a,
b){for(a=this.getNode(a);null!=a;){var c=a.childrenLoaded;const d=c+b;a.childrenLoaded=d;c=0===c?1:0===d?-1:0;a=a.index;0!==c&&(this._getPage(a).numNodesWithLoadedChildren+=c);a=this.getParent(a)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const a=[],b=c=>{let d=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseDescendants(c,e=>{d+=b(e);return!1});c.childrenLoaded!==d&&a.push(c.index);return d};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+
a.join(","));return 0<a.length}updateElevationInfo(a,b){this.needNodeElevationRange=b&&!!a&&("relative-to-ground"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(a=>{a.node?.invalidateServiceBVsInRenderSR();a.ref?.invalidateServiceBVsInRenderSR();null!=a.node&&a.node.invalidateElevationRange();null!=a.ref&&a.ref.invalidateElevationRange()})}_forAllNodes(a){if(null!=this._clientNodePage){var b=
this._clientNodePage;for(var c=0;c<b.nodes.length;c++)a(b.nodes[c],-(c+1))}for(const [d,e]of this._nodePages)for(b=d*this._pageSize,c=0;c<e.nodes.length;c++)a(e.nodes[c],b+c)}clearCaches(){if(this._useNodePages){const a=this._nodePages,b=new Set;this.traverseVisible(c=>b.add(z(c,this._pageSize)));for(const [c,d]of a)if(0!==d.numNodesWithLoadedChildren||b.has(c))for(const e of d.nodes)e.traversalState=null;else this._deleteNodePage(c)}}_deleteNodePage(a){this._nodePages.delete(a)}get test(){return{addNode:(a,
b)=>this._addNode(a,b),getNodeInternal:a=>this._getNodeInternal(a),getPageIndex:a=>z(a,this._pageSize),getIndexWithinPage:a=>v(a,this._pageSize),getNodePage:a=>0>a?this._clientNodePage:this._nodePages.get(a),getChildIndices:a=>{const b=this._getNodeInternal(a);a=this._getPage(a);if(null==b||null==a)return[];const c=[];for(let d=b.childOffset;d<b.childOffset+b.childCount;++d)c.push(a.children[d]);return c},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const u=
new Map;class V{constructor(a){this.missing=a;this.update=new C({deallocator:null});this.add=new C({deallocator:null});this.remove=new C({deallocator:null});this.cancel=[]}reset(a){this.add.clear();this.update.clear();this.cancel=a}}const S=[["maxScreenThreshold",t.LodMetric.MaxScreenThreshold],["screenSpaceRelative",t.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",t.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",t.LodMetric.DistanceRangeFromDefaultCamera]];class K{constructor(){this.unremoved=
this.missingNodes=this.missing=this.knownNodes=this.known=0}}const W=y.create(),X=y.create(),Y=y.create(),Z=y.create(),N=O("esri-mobile")?100:300;F.I3SIndex=U;F.selectErrorMetric=M;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});