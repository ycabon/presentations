// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../request ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/asyncUtils ../../../../core/byteSizeEstimations ../../../../core/Collection ../../../../core/handleUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/ReactiveSet ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../intl/number ../../../../layers/support/featureQueryAll ../../../../rest/support/meshFeatureSet ../../../../support/featureFlags ../../../../support/requestUtils ../FeatureLayerView3D".split(" "),
function(k,m,G,H,I,v,w,x,J,y,z,A,B,C,n,P,K,L,D,E,r,M,N){k.I3SOverrides=class extends H{constructor(a){super(a);this._warnMaximumChangedObjectsExceeded=!1;this._maximumNumberOfEditOVerrides=5E4;this._original3DOFLDefinitionExpression=null;this._interactiveEditingSessions=new x;this.geometryOverrides=new x;this._clientGeometryCache=new Map;this._associatedLayerView=null;this._attributeChangedObjectIds=new B;this._geometryChangedObjectIds=new B;this._pendingFetchChangedObjectIds=null;this._pendingFetchAbortController=
new AbortController;this._featureIdLocks=new Map}initialize(){this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`);this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal);this._pendingFetchChangedObjectIds.finally(()=>{this._pendingFetchChangedObjectIds=this._pendingFetchAbortController=null});this.is3DOFL&&null!=this._associatedLayer&&(r.direct3DObjectFeatureLayerDisplayEnabled()?this._associatedLayer.load().then(a=>
{this.destroyed||(this._original3DOFLDefinitionExpression=a.definitionExpression,this.addHandles(C.watch(()=>this._definitionExpression,b=>a.definitionExpression=b,C.initial)),this._associatedLayerView=new N({layer:this._associatedLayer,view:this.view}))}):r.i3sPatchingEnabled())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&(r.direct3DObjectFeatureLayerDisplayEnabled()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):r.i3sPatchingEnabled());
this._set("layer",null);this._memCache=z.destroyMaybe(this._memCache);this._pendingFetchAbortController=z.abortMaybe(this._pendingFetchAbortController);this._pendingFetchChangedObjectIds=null;this._featureIdLocks.clear()}get is3DOFL(){return r.sceneLayerEditingEnabled()&&null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort((a,b)=>a-b):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return 0<
this._geometryChangedObjectIds.size}get _definitionExpression(){const a=this.sortedGeometryChangedObjectIds;return 0===a.length?"1 \x3d 0":`OBJECTID IN (${a.join(",")})`}get updating(){return this.is3DOFL?this._pendingFetchChangedObjectIds?!0:r.direct3DObjectFeatureLayerDisplayEnabled()?null==this._associatedLayerView||null!=this._associatedLayerView&&this._associatedLayerView.updating:!1:!1}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===
this._geometryChangedObjectIds.size}featureHasGeometryChanges(a){return this._geometryChangedObjectIds.has(a)}featureHasAttributeChanges(a){return this._attributeChangedObjectIds.has(a)}createInteractiveEditSession(a){this._attributeChangedObjectIds.add(a);const b=this._interactiveEditingSessions,c=new O(a,()=>{b.remove(c)});b.unshift(c);return c}async applyAttributeOverrides(a,b,c,d=[]){this._pendingFetchChangedObjectIds&&await A.whenOrAbort(this._pendingFetchChangedObjectIds,c);if(null!=b){var {attributeData:f,
loadedAttributes:g}=b;if(null!=g&&null!=f&&0!==this._attributeChangedObjectIds.size){b=new Set;for(var e of g)b.add(e.index);for(const l of d)b.has(l.index)||(g.push(l),f[l.name]=Array(a.length));d=await this._lockFeatureIds(a);try{e={attributeData:f,loadedAttributes:g};const l=this._getOverridesFromCache(a,e,this._attributeChangedObjectIds),{objectIds:h,fieldNames:q}=l;if(0!==h.length&&0!==q.length){var p=await this._queryAttributeOverridesFromAssociatedLayer(h,q,c);null!=p&&this._processOverridesFromAssociatedLayer(a,
p,q,e)}}finally{d.remove()}}}}updateGeometry(a,b){this._geometryChangedObjectIds.add(a);const c=this._clientGeometryCache.get(a);null!=c&&(this.geometryOverrides.remove(c),this._clientGeometryCache.delete(a));null!=b&&(b={oid:a,mesh:b},this.geometryOverrides.add(b),this._clientGeometryCache.set(a,b))}updateAttributeValue(a,b,c){this._attributeChangedObjectIds.add(a);this._cacheAttributeValue(a,b,c)}featureAdded(a){this.is3DOFL&&r.i3sPatchingEnabled()&&this._geometryChangedObjectIds.add(a);this._attributeChangedObjectIds.add(a)}_cacheAttributeValue(a,
b,c){this._memCache.put(this._getAttributeCacheKey(a,b),c,this._memCacheAttributeValueSize(c))}_getOverridesFromCache(a,{loadedAttributes:b,attributeData:c},d){const f=new Set,g=[];for(var e of b)g[e.index]=c[e.name];c=new Set;for(e=0;e<a.length;e++){const p=a[e];if(d.has(p))for(const l of b){const h=this._attributeFromCache(p,l.index);void 0!==h?g[l.index][e]=h:(f.add(p),c.add(l.name))}}return{objectIds:Array.from(f),fieldNames:Array.from(c)}}_attributeFromCache(a,b){const c=this._fromInteractiveEditingSession(a,
b);if(void 0!==c)return c;a=this._getAttributeCacheKey(a,b);return this._memCache.get(a)}_fromInteractiveEditingSession(a,b){if(null!=this._interactiveEditingSessions)for(const c of this._interactiveEditingSessions){if(c.objectId!==a)continue;const d=c.getAttribute(b);if(void 0!==d)return d}}_getAttributeCacheKey(a,b){return`${a}-${b}`}async _queryAttributeOverridesFromAssociatedLayer(a,b,c){if(0===a.length)return null;this._logWarningIfMaximumObjectsExceeded();const {associatedLayer:d}=this.layer;
if(null==d)return null;const f=d.createQuery(),{objectIdField:g}=d;b=[g,...b];f.where="1\x3d1";f.returnGeometry=!1;f.outFields=b;f.cacheHint=!0;a=await this._executeBatchQuery(d,a,f,c);c=[];for(const e of a)if(e.ok)for(const p of e.value.features)c.push(p);return c}async _queryGeometryOverridesFromAssociatedLayer(a,b){if(0===a.length||!this.is3DOFL||!r.i3sPatchingEnabled())return null;this._logWarningIfMaximumObjectsExceeded();var c=this.layer.associatedLayer;const {objectIdField:d,globalIdField:f}=
c;var g=[d,...(null!=f?[f]:[])],e=c.createQuery();e.where="1\x3d1";e.returnGeometry=!0;e.outFields=g;e.cacheHint=!0;e.returnZ=c.hasZ;e.returnM=c.hasM;g=await this._executeBatchQuery(c,a,e,b);a=c.infoFor3D;({spatialReference:c}=c);b=[];for(const p of g){if(!p.ok)continue;const {assetMaps:l,features:h,globalIdFieldName:q}=p.value;if(null!=l){g=E.assetMapFromAssetMapsJSON(a,l);for(const u of h){e=E.extractMesh(u,q,c,a,g);const t=u;null!=e?(t.geometry=e,b.push(t)):t.geometry=null}}}return b}_logWarningIfMaximumObjectsExceeded(){if(this._warnMaximumChangedObjectsExceeded){this._warnMaximumChangedObjectsExceeded=
!1;var a=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${L.formatNumber(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`,b=this.layer.portalItem;a=b&&b.loaded?a+` (${b.portal.url}/home/item.html?id=${b.id}#settings)`:a+` (${this.layer.parsedUrl.path})`;y.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,
`${a}.`)}}async _executeBatchQuery(a,b,c,d){if(0===b.length)return[];const f=D.getMaximumQuerySize(a);b=[...b].sort((g,e)=>g-e);b=I.splitIntoChunks(b,f).map(g=>{const e=c.clone();e.objectIds=g;return v.resultOrAbort(D.queryAllJSON(a,e,{signal:d}))});return Promise.all(b)}_processOverridesFromAssociatedLayer(a,b,c,{loadedAttributes:d,attributeData:f}){var g=this._associatedLayer;if(null!=g){g=g.objectIdField;var e=c.map(h=>{h in f||(f[h]=Array(a.length));return f[h]}),p=new Map(d.map(h=>[h.name,h.index]));
d=c.map(h=>p.get(h));var l=new Map(Array.from(a,(h,q)=>[h,q]));for(const h of b){b=h.attributes[g];for(let q=0;q<c.length;q++){const u=d[q],t=l.get(b),F=h.attributes[c[q]];e[q][t]=F;this._cacheAttributeValue(b,u,F)}}}}_memCacheAttributeValueSize(a){return"string"===typeof a?w.estimateStringByteSize(a):w.estimateNumberByteSize()}async _fetchChangedObjectIds(a){var b=this.layer;await b.load({signal:a});this._geometryChangedObjectIds.clear();this._attributeChangedObjectIds.clear();({associatedLayer:b}=
b);if(null!=b&&b.capabilities?.operations?.supportsChangeTracking){var c=this._getFetchChangedObjectIdsServerGen();if(null!=c){var d=b.layerId,f=this.is3DOFL;c={f:"json",returnIdsOnly:!0,layers:`[${d}]`,returnUpdates:!0,returnDeletes:f,returnInserts:f,layerServerGens:JSON.stringify([{id:d,serverGen:c}])};f&&(d=b.infoFor3D,c.fieldsToCompare=JSON.stringify({fields:[...Object.values(d.transformFieldRoles),d.sourceHashField]}));c=await v.result(G(`${b.url}/extractChanges`,{method:"post",query:c,timeout:1E4,
signal:a}));!c.ok&&M.isTimeoutError(c.error)&&(d=this.layer.title,y.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("extractChanges:timeout",d,`${d} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`));if(c.ok&&1===c.value.data?.edits?.length){d=c.value.data.edits[0];c=d?.objectIds;var g=c?.adds??[];const e=c?.updates??[],p=c?.deletes??[];c=[...g,...e,...p];f=f?
[...g,...(d?.fieldUpdates??e),...p]:[];d=Math.min(this._maximumNumberOfEditOVerrides,c.length);d<c.length&&(this._warnMaximumChangedObjectsExceeded=!0);c=c.sort((l,h)=>l-h);for(g=0;g<d;++g)this._attributeChangedObjectIds.add(c[g]);for(const l of f)this._geometryChangedObjectIds.add(l);if(this.is3DOFL&&r.i3sPatchingEnabled()&&0<this._geometryChangedObjectIds.size&&(a=await this._queryGeometryOverridesFromAssociatedLayer(Array.from(this._geometryChangedObjectIds),a),null!=a))for(const l of a)null!=
l.geometry&&this.updateGeometry(l.attributes[b.objectIdField],l.geometry)}}}}_getFetchChangedObjectIdsServerGen(){var a=this.layer;if(null!=a.serviceUpdateTimeStamp?.lastUpdate)return a.serviceUpdateTimeStamp.lastUpdate;a=a.associatedLayer;return null!=a?.serverGens?.minServerGen?a.serverGens.minServerGen:null}async _lockFeatureIds(a){const b=this._featureIdLocks;for(var c=!0;c;){const f=[];for(const g of a){const e=b.get(g);e&&f.push(e)}0===f.length?c=!1:await Promise.all(f)}const d=A.createResolver();
c=d.promise;for(const f of a)b.set(f,c);return J.makeHandle(()=>{for(const f of a)b.delete(f);d.resolve()})}get test(){const a=this;return{changedObjectIds:Array.from(this._attributeChangedObjectIds),pendingFetchChangedObjectIds:this._pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return a._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(b){a._maximumNumberOfEditOVerrides=b}}}};m.__decorate([n.property({constructOnly:!0})],k.I3SOverrides.prototype,"view",void 0);m.__decorate([n.property({constructOnly:!0})],
k.I3SOverrides.prototype,"layer",void 0);m.__decorate([n.property({readOnly:!0})],k.I3SOverrides.prototype,"is3DOFL",null);m.__decorate([n.property()],k.I3SOverrides.prototype,"_interactiveEditingSessions",void 0);m.__decorate([n.property({readOnly:!0})],k.I3SOverrides.prototype,"sortedGeometryChangedObjectIds",null);m.__decorate([n.property({readOnly:!0})],k.I3SOverrides.prototype,"geometryOverrides",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"_clientGeometryCache",void 0);m.__decorate([n.property()],
k.I3SOverrides.prototype,"_associatedLayer",null);m.__decorate([n.property()],k.I3SOverrides.prototype,"_associatedLayerView",void 0);m.__decorate([n.property({constructOnly:!0})],k.I3SOverrides.prototype,"memoryController",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"_attributeChangedObjectIds",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"_geometryChangedObjectIds",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"hasGeometryChanges",null);m.__decorate([n.property()],
k.I3SOverrides.prototype,"_pendingFetchChangedObjectIds",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"_pendingFetchAbortController",void 0);m.__decorate([n.property()],k.I3SOverrides.prototype,"_definitionExpression",null);m.__decorate([n.property()],k.I3SOverrides.prototype,"updating",null);m.__decorate([n.property()],k.I3SOverrides.prototype,"isEmpty",null);k.I3SOverrides=m.__decorate([K.subclass("esri.views.3d.layers.i3s.I3SOverrides")],k.I3SOverrides);class O{constructor(a,b){this.objectId=
a;this._remove=b;this._updates=new Map;this._isActive=!0}getAttribute(a){return this._updates.get(a)}setAttribute(a,b){this.isActive&&this._updates.set(a,b)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});