// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/spatialReferenceEllipsoidUtils ../../../../geometry/projection/projectBoundingSphere ../../../../geometry/projection/projectors ../../../../geometry/support/frustum ../../../../geometry/support/spatialReferenceUtils ../../../../chunks/sphere ../../../../layers/graphics/dehydratedPoint ../../../ViewingMode ../graphics/elevationAlignmentUtils ../graphics/ElevationContext ../graphics/featureExpressionInfoUtils ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),
function(f,h,t,F,G,y,H,I,u,J,k,K,z,A,L,B,n,l,v){class M{constructor(a,b,c,e,d,g,p,m,q={}){this._indexSR=a;this._renderCoordsHelper=b;this._clippingArea=d;this._elevationProvider=g;this._viewingMode=p;this._options=q;this._frustum=u.create();this._frustumMbs=F.create();this._useFrustumCulling=!1;this._poi=h.create();this._elevationContext=null;this.minDistance=Infinity;this.maxDistance=0;this.maxLodLevel=2;this._tmpObb=new v.Obb;this._tmp1=h.create();this._tmp2=h.create();this._tmp3=h.create();this._tmp0=
h.create();this._screenspaceErrorBias=q.screenspaceErrorBias||1;this._progressiveLoadFactor=q.progressiveLoadFactor||1;this.updateCamera(c,e);this._renderSR=b=this._renderCoordsHelper.spatialReference;this._renderSRSphericalPCPF=y.getSphericalPCPF(b);this._isGlobalMode=b===this._renderSRSphericalPCPF;this.updateElevationInfo(m);this._tmpPoint=K.makeDehydratedPoint(0,0,0,a);this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(b.isWebMercator||J.isPlateCarree(b));this._indexSREllipsoidRadius=G.getReferenceEllipsoid(this._indexSR).radius;
this._indexSRSphericalPCPF=y.getSphericalPCPF(a);this._projectorIndexSRToIndexSRSphericalPCPF=I.getProjector(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(a){null==a?this._elevationContext=null:(this._elevationContext=L.ElevationContext.fromElevationInfo(a),this._elevationContext.updateFeatureExpressionInfoContext(B.createContextWithoutExpressionSupport(B.extractExpressionInfo(a,!1))))}updateCamera(a,b){if(this._useFrustumCulling=b){u.fromMatrix(a.viewMatrix,a.projectionMatrix,this._frustum,
C);b=a.eye;const d=N;f.normalize(d,a.viewForward);var c=O;f.sub(c,C[4],b);var e=f.dot(c,c);c=f.dot(d,c);e=.5*e/c;c=this._frustumMbs;f.scaleAndAdd(c,b,d,e);c[3]=1+e}this._screenSizeFactor=1/(a.perScreenPixelRatio/2);this._camPos=a.eye;this.minDistance=Infinity;this.maxDistance=0}setPointOfInterest(a){this._poi=a}updateScreenSpaceErrorBias(a){const b=this._screenspaceErrorBias;this._screenspaceErrorBias=a;return b}updateClippingArea(a){this._clippingArea=a}expandElevationRange(a,b,c){null!=this._elevationContext&&
(a=a.serviceMbsInIndexSR)&&(this._elevationProvider.getSphereElevationBounds?(b=this._elevationProvider.getSphereElevationBounds(a,this._indexSR))&&c.expandElevationRange(b):((a=this._elevationProvider.getElevation(a[0],a[1],a[2],this._indexSR,"relative-to-scene"===this._elevationContext.mode?"scene":"ground"))&&c.expandElevationRangeValues(a,a),(b=b?null:this._elevationProvider.getRootElevationBounds?.())&&c.expandElevationRange(b)))}getServiceMbsInRenderSR(a){const b=a.serviceMbsInRenderSR;if(l.isValidMbs(b))return b;
a.serviceMbsInIndexSR&&t.copy(b,a.serviceMbsInIndexSR);const c=a.elevationRangeMin;if(this._elevationContext&&Number.isFinite(c)){let e=0,d=0;a=a.elevationRangeMax;switch(this._elevationContext.mode){case "relative-to-ground":e=this._elevationContext.geometryZWithOffset(b[2],this._renderCoordsHelper)+c-b[2];d=a-c;break;case "on-the-ground":e=c-b[2],d=a-c}b[2]+=e+.5*d;b[3]+=.5*d}else this._elevationContext&&1E5>b[3]&&(this._tmpPoint.x=b[0],this._tmpPoint.y=b[1],this._tmpPoint.z=b[2],b[2]=A.evaluateElevationAlignmentAtPoint(this._tmpPoint,
this._elevationProvider,this._elevationContext,this._renderCoordsHelper));H.projectBoundingSphere(b,this._indexSR,b,this._renderSR);return b}getAndUpdateVisibilityObbInRenderSR(a){if(a.visibilityObbInRenderSR)return a.visibilityObbInRenderSR;const b=a.serviceObbInIndexSR;var c=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:e}=a;if(null==b||!e||!l.isValidObb(b)||this._isECEFOBBInLocalMode&&(b.halfSizeX>c||b.halfSizeY>c||b.halfSizeZ>c))return null;c=a.serviceObbInRenderSR;if(null==c)c=new v.Obb;
else if(l.isValidObb(c))return c;var d=a.elevationRangeMin;a=a.elevationRangeMax;const g=e[3];let p=0;e=0;const m=b.centerZ,q=this._renderCoordsHelper,r=this._elevationContext;if(r&&Number.isFinite(d))switch(r.mode){case "relative-to-ground":p=r.geometryZWithOffset(m,q)+d-m;e=a-d;break;case "on-the-ground":p=d-m,e=a-d}else r&&1E5>g&&(d=this._tmpPoint,d.x=b.centerX,d.y=b.centerY,d.z=m,p=A.evaluateElevationAlignmentAtPoint(d,this._elevationProvider,r,q)-m);d=0<e?this._tmpObb:c;b.transform(d,this._indexSR,
this._renderSR,p,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF);0<e&&v.computeOffsetObb(d,0,e,this._viewingMode,c);return c}getNodeObbInRenderSRIndependentOfElevationOffset(a){const b=a.visibilityObbInRenderSR??a.serviceObbInRenderSR??null;if(l.isValidObb(b))return b;a=a.serviceObbInIndexSR;if(!a)return null;a.transform(D,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF);
return D}ensureElevationAgnosticBoundingVolume(a,b){-1===a.elevationAgnosticBoundingVolume[3]&&(b===z.ViewingMode.Global?this._updateElevationAgnosticBoundingVolumeGlobal(a):this._updateElevationAgnosticBoundingVolumeLocal(a))}_updateElevationAgnosticBoundingVolumeGlobal(a){const b=this.getNodeObbInRenderSRIndependentOfElevationOffset(a),c=a.elevationAgnosticBoundingVolume,e=w;var d=-1;if(b){b.getCenter(e);f.normalize(e,e);b.getCorners(x);for(var g of x){f.normalize(g,g);a=f.dot(g,e);if(0>=a){c[3]=
-1;return}d=Math.max(d,Math.sqrt(1-a*a))}}else if(d=a.serviceMbsInRenderSR,l.isValidMbs(d))g=f.copy(w,k.getCenter(d)),d=d[3],a=f.len(g),d=0===d?0:a<d?-1:d/a,f.normalize(g,g);else{c[3]=-1;return}t.copyVec3(c,e);c[3]=d+.001}_updateElevationAgnosticBoundingVolumeLocal(a){const b=a.elevationAgnosticBoundingVolume;var c=this.getNodeObbInRenderSRIndependentOfElevationOffset(a);if(c){a=c.getCenter(w);a[2]=0;t.copyVec3(b,a);a=0;const d=P;c.getCorners(x);for(var e of x)e[2]=0,c=f.sqrDist(d,e),a=Math.max(a,
c);b[3]=Math.sqrt(a)}else e=a.serviceMbsInRenderSR,l.isValidMbs(e)&&(c=f.copy(w,k.getCenter(e)),c[2]=0,t.copyVec3(b,c),b[3]=e[3])}isNodeVisible(a){const b=this.getServiceMbsInRenderSR(a);return this._isMBSinClippingArea(b)?this._useFrustumCulling?(a=this.getAndUpdateVisibilityObbInRenderSR(a))?a.isVisible(this._frustum):u.intersectsSphere(this._frustum,k.wrap(b)):!0:!1}isElevationAgnosticBoundingVolumeVisible(a,b){return this._useFrustumCulling&&-1!==b[3]?a===z.ViewingMode.Global?this._isConeVisibleInFrustum(b):
this._isCylinderVisibleInFrustum(b):!0}_isConeVisibleInFrustum(a){var b=this._frustumMbs,c=f.len(b);const e=b[3];var d=f.dot(a,b);const g=a[3];if(.9<g||c<=e)return!0;a=f.scale(E,a,d);if(f.dist(a,b)<e)return!0;b=d/c;if(0>=d)return-b<e;d=Math.sqrt(1-b*b);if(d<g)return!0;c=e/c;return d*Math.sqrt(1-c*c)-c*b<g}_isCylinderVisibleInFrustum(a){var b=this._frustumMbs;const c=b[3];b=f.copy(E,b);b[2]=0;const e=a[3];return f.dist(b,a)<=e+c}isGeometryVisible(a){return this._useFrustumCulling?a.geometryObbInRenderSR?.isVisible(this._frustum)??
this.isNodeVisible(a):!0}_isMBSinClippingArea(a){return null==this._clippingArea?!0:l.intersectBoundingRectWithMbs(this._clippingArea,a)!==l.MbsIntersectResult.OUTSIDE}_screenSpaceDiameterMbs(a,b){var c=this.getServiceMbsInRenderSR(a);a=Math.sqrt(f.squaredDistance(k.getCenter(c),this._camPos));c=a-c[3];this._updateMinMaxDistance(a);return 0>c?.5*Number.MAX_VALUE:b/c*this._screenSizeFactor}calcCameraDistance(a){return this.calcCameraDistanceToCenter(a)-this.getServiceMbsInRenderSR(a)[3]}calcCameraDistanceToCenter(a){a=
this.getServiceMbsInRenderSR(a);a=f.distance(k.getCenter(a),this._camPos);this._updateMinMaxDistance(a);return a}calcAngleDependentLoD(a){a=this.getServiceMbsInRenderSR(a);const b=a[3];a=(Math.abs(a[0]*(a[0]-this._camPos[0])+a[1]*(a[1]-this._camPos[1])+a[2]*(a[2]-this._camPos[2]))/f.length(k.getCenter(a))+b)/f.distance(k.getCenter(a),this._camPos);return Math.min(1,a)}hasLOD(a){return a.lodMetric!==n.LodMetric.None}_getDistancePlanarMode(a,b){var c=a[0]-b[0];const e=a[1]-b[1];a=a[2]-b[2];c=c*c+e*
e;b=b[3];if(c<=b*b)return Math.abs(a);b=Math.sqrt(c)-b;return Math.sqrt(a*a+b*b)}_getDistanceGlobeMode(a,b){var c=f.length(k.getCenter(b));const e=f.length(a)-c;f.scale(this._tmp0,a,f.dot(a,k.getCenter(b))/f.squaredLength(a));var d=f.squaredDistance(k.getCenter(b),this._tmp0),g=b[3];if(d<=g*g)return Math.abs(e);b=f.scale(this._tmp0,k.getCenter(b),1/c);c=f.scale(this._tmp1,b,c-g*g/2/c);d=f.subtract(this._tmp2,a,c);d=f.subtract(this._tmp2,d,f.scale(this._tmp3,b,f.dot(b,d)));c=f.add(this._tmp2,c,f.scale(this._tmp2,
d,g/f.length(d)));g=f.distance(a,c);2E5<=e&&(a=f.subtract(this._tmp1,a,c),a=f.dot(a,b)/f.length(a),.08>a&&(a=1E-4),g/=a);return g}_getDistance(a,b){return this._isGlobalMode?this._getDistanceGlobeMode(a,b):this._getDistancePlanarMode(a,b)}_updateMinMaxDistance(a){0<a?(this.minDistance=Math.min(this.minDistance,a),this.maxDistance=Math.max(this.maxDistance,a)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-a))}getLodLevel(a){if(a.lodMetric===n.LodMetric.None)return 0;if(0===a.childCount)return this.maxLodLevel;
if(this._useFrustumCulling&&1>this._progressiveLoadFactor){const b=this._screenspaceErrorBias;return this.evaluateLODmetric(a,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(a,b)?2:1:0}return this.evaluateLODmetric(a,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(a,b){switch(a.lodMetric){case n.LodMetric.ScreenSpaceRelative:const c=this.getServiceMbsInRenderSR(a),e=this._getDistance(this._camPos,c),d=2*e/this._screenSizeFactor;this._updateMinMaxDistance(e+
c[3]);return a.maxError*b<=d;case n.LodMetric.MaxScreenThreshold:return b=this._screenSpaceDiameterMbs(a,a.serviceMbsInIndexSR[3]*b),this._options.angleDependentLoD&&(b*=this.calcAngleDependentLoD(a)),b<a.maxError;case n.LodMetric.RemovedFeatureDiameter:return 10>this._screenSpaceDiameterMbs(a,a.maxError)*b;case n.LodMetric.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(a)>a.maxError*b}return!1}distToPOI(a){a=this.getServiceMbsInRenderSR(a);return f.distance(k.getCenter(a),this._poi)-
a[3]}distCameraToPOI(){return f.distance(this._camPos,this._poi)}}const N=h.create(),C=u.createPoints(),O=h.create(),E=h.create(),D=new v.Obb,w=h.create(),x=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create(),h.create()],P=h.create();return M});