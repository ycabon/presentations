// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/ByteSizeUnit","../../../../core/Error","../../../../core/promiseUtils"],function(k,n,p,m){function h(a){return new Promise((c,b)=>{a.oncomplete=()=>c();a.onerror=()=>b(a.error);a.onabort=()=>b(a.error)})}function f(a){return new Promise((c,b)=>{"done"===a.readyState?null!=a.error?b(a.error):c(a.result):(a.onsuccess=()=>c(a.result),a.onerror=()=>b(a.error))})}class q{constructor(a,c,b=14){this._version=b;this._quotaReductionPromise=this._db=null;this._miss=this._hit=
this._gcCounter=0;this._destroyed=!1;this.gcFrequency=50;this.maxByteSize=n.ByteSizeUnit.GIGABYTES;this.quotaReductionFactor=.2;this._dbName=a;this._storeName=c}init(){return Promise.resolve().then(()=>{const a=indexedDB.open(this._dbName,this._version);a.onupgradeneeded=c=>{var b=a.result;const d=a.transaction,e=b.objectStoreNames.contains(this._storeName)?d.objectStore(this._storeName):b.createObjectStore(this._storeName);b=b.objectStoreNames.contains("last_access")?d.objectStore("last_access"):
b.createObjectStore("last_access");b.indexNames.contains("date")||b.createIndex("date","date",{unique:!1});b.indexNames.contains("byteSize")||b.createIndex("byteSize","byteSize",{unique:!1});c.oldVersion<this._version&&(e.clear(),b.clear())};return f(a)}).then(a=>{this._destroyed?a.close():this._db=a})}destroy(){this._db&&(this._db.close(),this._db=null);this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(a,c){return null==this._db?Promise.reject(new p("indexedb:not-initialized",
"IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then(()=>this._put(a,c)).catch(b=>{if(b&&"QuotaExceededError"===b.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then(d=>this._removeLeastRecentlyAccessed(c.byteSize+Math.ceil(d*this.quotaReductionFactor))),this._quotaReductionPromise.then(()=>this._quotaReductionPromise=null,()=>this._quotaReductionPromise=null)),this._quotaReductionPromise.then(()=>
this._put(a,c));throw b;}).then(()=>{this._gcCounter--;0>this._gcCounter&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then(b=>this._removeLeastRecentlyAccessed(b-this.maxByteSize)))})}get(a,c){const b=this._db;if(null==b)return Promise.resolve(void 0);let d=null;return Promise.resolve().then(()=>{const e=b.transaction(this._storeName,"readonly");d=m.onAbort(c,()=>{e.abort()});const l=e.objectStore(this._storeName).get(a);return f(l)}).then(e=>{null==e?++this._miss:this._db&&
(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:e.byteSize},a));null!=d&&d.remove();return e}).catch(()=>{++this._miss;m.throwIfAborted(c);null!=d&&d.remove()})}remove(a){const c=this._db;return null==c?Promise.resolve():Promise.resolve().then(async()=>{const b=c.transaction([this._storeName,"last_access"],"readwrite");var d=b.objectStore(this._storeName),e=b.objectStore("last_access");d=d.delete(a);e=e.delete(a);await Promise.all([f(d),
f(e),h(b)])})}_put(a,c){var b=this._db;if(null==b)return Promise.resolve();b=b.transaction([this._storeName,"last_access"],"readwrite");var d=b.objectStore(this._storeName);const e=b.objectStore("last_access");d=d.put(c,a);a=e.put({date:Date.now(),byteSize:c.byteSize},a);return Promise.all([f(d),f(a),h(b)])}_removeLeastRecentlyAccessed(a){if(0>=a||!this._db)return Promise.resolve();const c=this._db.transaction([this._storeName,"last_access"],"readwrite"),b=c.objectStore(this._storeName),d=c.objectStore("last_access");
let e=0;const l=d.index("date").openCursor(null,"next");l.onsuccess=()=>{const g=l.result;null!=g&&(null!=g.value.byteSize&&(e+=g.value.byteSize),b.delete(g.primaryKey),d.delete(g.primaryKey),e<a&&g.continue())};return h(c)}_getCacheSize(){var a=this._db;if(null==a)return Promise.resolve(0);a=a.transaction("last_access");let c=0;const b=a.objectStore("last_access").index("byteSize").openKeyCursor();b.onsuccess=()=>{const d=b.result;if(d){var e=d.key;null!=e&&(c+=e);d.continue()}};return h(a).then(()=>
c)}}k.IDBCache=q;k.whenRequest=f;k.whenTransaction=h;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});