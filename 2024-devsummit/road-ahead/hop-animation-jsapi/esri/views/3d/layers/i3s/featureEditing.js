// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../../core/asyncUtils","../../../../core/lang","../../../../layers/support/featureQueryAll"],function(z,E,F,G){function A(a,b,c,e,d=null,g=!0){const f=[];a={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:null==c,fieldsIndex:a.fieldsIndex,objectIdField:a.objectIdField,globalIdField:a.globalIdField,featureOrIdentifierList:c};for(const p of b)if(null==p.error){b=p.objectId??-1;c=p.globalId;if(-1===b||g){var h=b;var n=c,k=a;const {gidToFeatureInfo:q,oidToFeatureInfo:l,
fieldsIndex:w,objectIdField:v,globalIdField:r,featureOrIdentifierList:u}=k;if(!k.featuresResolved&&null!=u){for(const t of u){const m={feature:null,oid:-1,gid:null};if("attributes"in t){m.feature=t;const y=t.attributes;if(null!=y)for(const B in y){if(-1!==m.oid&&null!=m.gid)break;const C=w.normalizeFieldName(B);C===v&&(m.oid=y[B]??-1);C===r&&(m.gid=y[B])}}else m.oid=t.objectId??-1,m.gid=t.globalId;null!=m.gid&&q.set(m.gid,m);-1!==m.oid&&l.set(m.oid,m)}k.featuresResolved=!0}h=(-1!==h?l.get(h):null)??
(null!=n?q.get(n):null)}else h=null;h=h??{feature:null,oid:b,gid:c};b={oid:-1===b?h.oid:b,gid:c??h.gid,feature:h.feature,result:p};f.push(b);-1===b.oid&&null!=b.gid&&null!=d&&(b.oid=d.get(b.gid)??-1);-1===b.oid&&null!=b.gid&&(c=e.get(b.gid),null==c&&(c=[],e.set(b.gid,c)),c.push(b))}return f}async function H(a,b){a=a.i3sOverrides.layer.associatedLayer;if(null!=a?.globalIdField){var c=a.createQuery(),{objectIdField:e,globalIdField:d}=a;c.where=Array.from(b.keys()).map(g=>`${d}='${g}'`).join(" OR ");
c.returnGeometry=!1;c.outFields=[e,d];c.cacheHint=!1;a=await E.resultOrAbort(G.queryAllJSON(a,c));if(a.ok){a=a.value.features;for(const g of a)if(c=g.attributes[d],a=g.attributes[e],null!=c&&null!=a&&-1!==a&&(c=b.get(c),null!=c))for(const f of c)f.oid=a}}}function I(a,b){const c=new Map;b=b.adds;if(!b||0===b.length||null==a.globalIdField)return c;for(const e of b)a=e.oid,b=e.feature,"mesh"===b?.geometry?.type&&c.set(a,b);return c}function J(a,b){const c=b.updates;if(!c||0===c.length)return new D;
const e=new D;b=new Map;for(let d=0;d<a.attributeStorageInfo.length;d++)b.set(a.attributeStorageInfo[d].name,d);a.forEachNode((d,g)=>{for(const p of c){if(null==p.feature)continue;const q=p.feature,l=p.oid,w=g.indexOf(l);for(const v in q.attributes){var f=a.fieldsIndex.normalizeFieldName(v);var h=e;var n=d.index,k=h.get(n);k?h=k:(k=new K,h.set(n,k),h=k);(n=null!=f&&h.get(f))?f=n:(n=[],h.set(f,n),f=n);f.push({featureIndex:w,featureId:l,value:q.attributes[v]})}}});return e}const L={setAttribute(){},
rollback(){},commit(){}};var x;(function(a){a[a.EDITING=0]="EDITING";a[a.ROLLED_BACK=1]="ROLLED_BACK";a[a.COMMITTED=2]="COMMITTED"})(x||={});const K=Map,D=Map;z.createInteractiveEditSession=function(a,b){const c=b.attributes[a.objectIdField];if(null==c)return L;var e=a.sessions.get(c);if(e)return e;const d=F.clone(b.attributes),g=new Set,f=a.i3sOverrides.createInteractiveEditSession(c),h=new Map;let n=x.EDITING;e={setAttribute(k,p){if(n===x.EDITING){var q=a.fieldsIndex.get(k);if(q){var l=a.attributeStorageInfo.findIndex(r=>
r.name===q.name);if(!(0>l)){if(!(k in d))throw Error(`Attribute "${k}" is not an attribute of the edited feature.`);f.setAttribute(l,p);var w=a.attributeStorageInfo[l],v=!1;g.add(k);a.forEachNode((r,u)=>{var t=h.get(r);null==t?(u=u.indexOf(c),h.set(r,u)):u=t;if(-1!==u&&(t=a.getAttributeData(r.index))){const m=t[w.name];m&&(m[u]=p,a.setAttributeData(r.index,t,b),v=!0)}});v&&a.clearMemCache()}}}},rollback(){if(n===x.EDITING){for(const k of g)this.setAttribute(k,d[k]);f.remove();n=x.ROLLED_BACK;a.sessions.delete(c)}},
commit(){n===x.EDITING&&(f.remove(),n=x.COMMITTED,a.sessions.delete(c))}};a.sessions.set(c,e);return e};z.normalizeEditResultsEvent=async function(a,b){const c=new Map,e=A(a,b.addedFeatures,b.edits?.addFeatures,c),d=A(a,b.updatedFeatures,b.edits?.updateFeatures,c);b=A(a,b.deletedFeatures,b.edits?.deleteFeatures,c,b.globalIdToObjectId,!1);0<c.size&&await H(a,c);return{adds:e.filter(g=>-1!==g.oid),updates:d.filter(g=>-1!==g.oid),deletes:b.filter(g=>-1!==g.oid)}};z.processAttributeEdits=function(a,b){var c=
J(a,b);b=I(a,b);if(0!==c.size||0!==b.size){var e=new Map;for(var d=0;d<a.attributeStorageInfo.length;d++)e.set(a.attributeStorageInfo[d].name,d);var g=!1;c.forEach((p,q)=>{const l=a.getAttributeData(q);let w=!1;p.forEach((v,r)=>{const u=null!=l?l[r]:null;r=e.get(r);for(const {featureIndex:t,value:m,featureId:y}of v)u&&(u[t]=m,g=w=!0),a.i3sOverrides.updateAttributeValue(y,r,m)});w&&a.setAttributeData(q,l,null)});g&&a.clearMemCache();var {fieldsIndex:f,i3sOverrides:h,objectIdField:n,globalIdField:k}=
a;c=h.layer.associatedLayer?.infoFor3D;c=new Set(c?[...Object.values(c.assetMapFieldRoles),...Object.values(c.transformFieldRoles)]:[]);for(const [p,q]of b){h.featureAdded(p);({attributes:b}=q);for(const l in b)l!==n&&l!==k&&c.has(l)||(d=f.normalizeFieldName(l),d=null!=d?e.get(d):null,null!=d&&h.updateAttributeValue(p,d,b[l]))}}};z.processGeometryEdits=function(a,b){const c=new Map;var e=b.adds,d=b.updates;b=b.deletes;if(0<e.length)for(var g of e){e=g.oid;const f=g.feature;"mesh"===f?.geometry?.type&&
c.set(e,f.geometry)}if(0<d.length)for(const f of d)d=f.oid,g=f.feature,"mesh"===g?.geometry?.type&&c.set(d,g.geometry);if(0<b.length)for(const f of b)c.set(f.oid,null);for(const [f,h]of c)a.i3sOverrides.updateGeometry(f,h)};Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});