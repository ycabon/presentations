// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Logger ../../../../core/MapUtils ../../../../core/promiseUtils ../../../../core/ReactiveMap ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../rest/support/QuantizationParameters ../../../../rest/support/Query ../../../ViewingMode ./featureReference ./FeatureTile ../../terrain/tileUtils ../../../support/Scheduler".split(" "),
function(h,l,K,v,C,w,L,M,N,m,W,X,O,u,r,P,D,Q,E,n,R,F){function y(a){return"dummy-tile-full-extent"===a.id}function S(a){let b=0;for(const c of a)c.features&&0<c.features.length&&c.alive&&(b=Math.max(b,c.descriptor.lij[0]));return b}function T(a){a.setFeatures([],0,null,void 0);a.featuresMissing=!1;return n.FetchStatus.DONE}function G(a){return null==a?new Set:new Set(a.map(b=>b.name))}function H(a,b){if(null==a||null==b)return G(b);const c=new Set;for(const {name:d}of b)a.has(d)&&c.add(d);return c}
function z(a,b){if(!b?.length)return a;a??=new Map;const c=()=>new Set;for(const {objectId:d,attribute:e}of b)C.getOrCreateMapValue(a,d,c).add(e);return a}h.FeatureTileFetcher3D=class extends K{set maximumNumberOfFeatures(a){a=a||Infinity;const b=this._get("maximumNumberOfFeatures");a===b||1>a||(this._set("maximumNumberOfFeatures",a),this._maximumFeaturesUpdated(b,a))}set memoryFactor(a){this.memoryFactor!==a&&(this._set("memoryFactor",a),this._setDirty())}set lodFactor(a){this.lodFactor!==a&&(this._set("lodFactor",
a),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&null!=this.context.query.queryFeatureCount}set useTileCount(a){this._useTileCount=a;this.notifyChange("useTileCount")}get updating(){return this._dirty||!!this._pendingEdits||this._isFetching||(this.tileDescriptors?.updating??!1)}get memoryForUnusedFeatures(){let a=0;this._featureTiles.forEach(b=>a+=b.estimatedUnusedSize);return a}get totalVertices(){let a=0;this._featureTiles.forEach(b=>a+=b.numVertices);return a}get totalFeatures(){let a=
0;this._featureTiles.forEach(b=>a+=b.numFeatures);return a}get hasAllFeatures(){if(this._paused||this.dataUpdating)return!1;for(const [,a]of this._featureTiles)if(!this.hasFullGeometries&&0!==a.emptyFeatureRatio||!a.hasAllFeatures)return!1;return!0}get hasFullGeometries(){return this._supportsResolution?!this.tileDescriptors.find(a=>null!=a.resolution)||!this.context.capabilities.supportsQuantization&&"polyline"!==this.context.geometryType:!0}set filterExtent(a){if(null!=a&&this.context.tilingScheme&&
!a.spatialReference.equals(this.context.tilingScheme.spatialReference))v.getLogger(this).error("#filterExtent\x3d","extent needs to be in the same spatial reference as the tiling scheme");else{var b=this._get("filterExtent");b===a||null!=b&&a&&b.equals(a)||(a=null!=a?a.clone():null,this._set("filterExtent",a),this._reclip(a,b))}}constructor(a){super(a);this.running=this.dataUpdating=this._useTileCount=!1;this.expectedFeatureDiff=this.updatingRemaining=this.updatingTotal=0;this.maximumNumberOfFeaturesExceeded=
!1;this._farRatio=this._fullRatio=1;this._changes={updates:{adds:[],removes:[]},adds:[],removes:[]};this._frameTask=F.ImmediateTask;this._dirty=!1;this._featureTiles=new L;this._displayingFeatureReferences=new Map;this._numDisplayingFeatureReferences=0;this._suspended=!0;this._pendingEdits=null;this._isFetching=this._applyEditsTilesUpdated=!1}initialize(){this.addHandles(M.on(()=>this.tileDescriptors,"change",()=>this._setDirty(),{sync:!0,onListenerAdd:()=>this._setDirty()}));this._objectIdField=
this.context.objectIdField;this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?E.MultiFeatureReference:E.SingleFeatureReference;const a=this.context.scheduler;null!=a&&(this._frameTask=a.registerTask(F.TaskPriority.FEATURE_TILE_FETCHER,this));this._setDirty()}destroy(){this._frameTask.remove();this._featureTiles.forEach(a=>{this._cancelFetchTile(a);this._removeTile(a)});this._featureTiles.clear();this._displayingFeatureReferences.clear();this._pendingEdits?.controller.abort();
this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach(a=>{this._cancelFetchTile(a);this._clearTile(a);this._resetFetchTile(a)});null!=this.context.memoryCache&&this.context.memoryCache.clear();this._setDirty()}refetch(){this._featureTiles.forEach(a=>{this._cancelFetchTile(a);this._resetFetchTile(a)});null!=this.context.memoryCache&&this.context.memoryCache.clear();this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),
this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}getMissingAttributesForFeature(a){for(const [,b]of this._featureTiles){const c=b.missingAttributes?.get(a);if(null!=c)return c}}_pause(){this._paused&&(this._featureTiles.forEach(a=>this._cancelFetchTile(a)),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let a=null;this._featureTiles.forEach(b=>{null!=b.displayingFeatures&&0!==b.displayingFeatures.length&&(null==a?a=
new Set(b.availableFields):a.forEach(c=>{b.availableFields.has(c)||a.delete(c)}))});return null!=a?a:new Set}applyEdits(a){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const b=this._pendingEdits;b.count++;const c=b.edits.then(()=>a.result.catch(d=>{if(w.isAbortError(d))throw d;return null}).then(d=>{if(!d)return d;this._applyEditsDeleteFeatures(d.deletedFeatures);return this._applyEditsAddUpdateFeatures(d.addedFeatures,d.updatedFeatures,
b.controller.signal).then(()=>d)}).then(d=>{0===--b.count&&(this._pendingEdits===b&&(this._pendingEdits=null),null!=this.context.memoryCache&&this.context.memoryCache.clear(),this._applyEditsTilesUpdated=!1,this._unpause());return d}));b.edits=c;this._updated();return c}_applyEditsDeleteFeatures(a){if(0!==a.length){var b=this.context.globalIdField,c=b&&this.availableFields.has(b),d=new Set,e=this._objectIdField;a.forEach(({objectId:f,globalId:g})=>{(!f||0>f)&&b&&g&&(c||v.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${b} to be included the layer's outFields for updates to be reflected in the view`),
f=this._objectIdFromGlobalId(g,e,b));null!=f&&0<=f&&d.add(f)});this._featureTiles.forEach(f=>{if(f.features){var g=f.features.filter(p=>!d.has(r.getObjectId(p,this._objectIdField)));g.length!==f.features.length&&(this._applyEditsTileUpdated(),f.setFeatures(g,0,f.availableFields,f.missingAttributes),this._invalidateCounts())}})}}_objectIdFromGlobalId(a,b,c){if(null==a)return null;const d=this.features.find(e=>e.attributes?.[c]===a);return d?r.getObjectId(d,b):null}async _applyEditsAddUpdateFeatures(a,
b,c){const {objectIdField:d,globalIdField:e}=this.context,f=e&&this.availableFields.has(e),g=new Set,p=new Set;for(const k of a)a=k.objectId,null!=a&&g.add(a);for(const {objectId:k,globalId:t}of b)b=k,(null==b||0>b)&&e&&(f||v.getLogger(this).errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected in the view`),b=this._objectIdFromGlobalId(t,d,e)),null!=b&&0<=b&&(g.add(b),p.add(b));if(0!==g.size){var q=
[];this._featureTiles.forEach(k=>{(k=this._applyEditsAddUpdateTile(k,g,p,c))&&q.push(k)});this._updated();await Promise.allSettled(q)}}async _applyEditsAddUpdateTile(a,b,c,d){if(a.features){var e=this._createQuery(a);e.resultType=void 0;e.cacheHint=!1;e.objectIds=Array.from(b);b=await this._queryFeatures(e,d);d=null;0<c.size&&(e=a.features.filter(f=>!c.has(r.getObjectId(f,this._objectIdField))),e.length!==a.features.length&&(d=e));if(0<b.features.length){d||=a.features.slice();for(const f of b.features)d.push(f)}d&&
(a.hasPreciseFeatureCount&&(a.numFeatures=Math.max(a.numFeatures,d.length)),this._applyEditsTileUpdated(),a.setFeatures(d,0,H(a.availableFields,b.fields),z(a.missingAttributes,b.missingAttributes)),this._invalidateCounts())}}_applyEditsTileUpdated(){this._applyEditsTilesUpdated||(this._applyEditsTilesUpdated=!0,this._updated())}_queryFeatures(a,b){return this.context.query.queryFeaturesDehydrated(a,{signal:b,timeout:6E5})}_setDirty(){this._dirty=!0;this._updated()}runTask(a){const b=this._frameTask.processQueue(a);
if(!this._dirty||!this.initialized)return b;this._dirty=!1;const c=this._getListOfTiles();this._markTilesNotAlive(c);if(a.run(()=>this._addTiles(c,a))&&a.run(()=>this._filterExtentTiles(c,a))&&a.run(()=>this._removeTiles(c,a))&&!a.done){var d=this._sortTiles(c);a.run(()=>this._showTiles(d,a))&&a.run(()=>this._fetchTiles(d,a))&&a.run(()=>this._updateMemoryEstimates(d,a))||this._setDirty();this._updated();this.updating||this._updateMaximumNumberOfFeaturesExceeded()}else this._setDirty()}_markTilesNotAlive(a){for(const b of a)b.alive=
!1}_addTiles(a,b){if(this._suspended||!this.tileDescriptors)return!1;this.tileDescriptors.forEach(c=>{const d=this._featureTiles.get(c.id);d?d.alive=!0:b.done||(a.push(this._addTile(c)),b.madeProgress())});return b.hasProgressed}_filterExtentTiles(a,b){for(const c of a){if(b.done)break;c.alive&&(c.filtered=!c.intersects(this.filterExtent),c.filtered&&(this._clearTile(c),b.madeProgress()))}return b.hasProgressed}_removeTiles(a,b){for(let c=a.length-1;0<=c&&!b.done;c--){const d=a[c];d.alive||(this._removeTile(d),
c!==a.length-1&&(a[c]=a[a.length-1]),a.pop(),b.madeProgress())}return b.hasProgressed}_sortTiles(a){a.sort((b,c)=>(b.descriptor.loadPriority??0)-(c.descriptor.loadPriority??0));return a}_showTiles(a,b){const c=this._updateRatio(a),d=e=>{const f=1>this._fullRatio?c(e)*this._farRatio:1;e.reduceFeatures(f,this.memoryFactor,this._objectIdField)&&this._setDirty();return this._showTile(e)};for(const e of a)if(!b.run(()=>d(e))){this._setDirty();break}return b.hasProgressed}_fetchTiles(a,b){if(this._paused)return!1;
var c=!1;for(const e of a)if(e.needsFetching){var d=null!=this.context.memoryCache?this.context.memoryCache.pop(e.id):null;if(null!=d)e.cache=d,this._setDirty(),this._scheduleUpdated(),b.madeProgress();else if(this._needsNumFeatures(e)&&(c=new AbortController,d=this._fetchTileCount(e,c.signal),this._handleRequest(e,d,c,()=>e.numFeatures=n.failedFeatureCount),c=!0,b.madeProgress()),b.done)return!0}if(c)return b.hasProgressed;for(const e of a)if(e.needsFetching&&(a=new AbortController,c=this._fetchTile(e,
a.signal),this._handleRequest(e,c,a,f=>{e.setFeatures([],0,null,void 0);this._invalidateCounts();e.featuresMissing=!1;e.fetchFailed=!0;this.context.logFetchError(v.getLogger(this),f)}),b.madeProgress()))return!0;return b.hasProgressed}_updateMemoryEstimates(a,b){a.some(c=>b.run(()=>c.updateMemoryEstimates())?!1:(this._setDirty(),!0));return b.hasProgressed}_reclip(a,b){if(this.initialized){var c=[];this._featureTiles.forEach(d=>{null!=d.displayingFeatures&&0!==d.displayingFeatures.length&&(d.intersectionIncludingBorrowed(b,
I),d.intersectionIncludingBorrowed(a,J),u.equals(I,J)||c.push(d))});this._refreshDisplayingFeatures(c);this._updated()}}_refreshDisplayingFeatures(a){const b=new Set,c=this._changes.updates;for(const d of a)if(null!=d.displayingFeatures)for(const e of d.displayingFeatures)a=r.getObjectId(e,this._objectIdField),b.has(a)||(b.add(a),a=this._displayingFeatureReferences.get(a).feature,c.removes.push(a),c.adds.push(a));this._applyChanges()}_updated(){let a=0;this._paused||this._featureTiles.forEach(b=>
b.isFetching?++a:0);this._isFetching=0<a;this._set("running",this._dirty);0<a||this._applyEditsTilesUpdated?this._set("dataUpdating",!0):this._dirty||this._set("dataUpdating",!1);if(this.updating){let b=0,c=0,d=0,e=0,f=0;const g=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(k=>{++c;if(k.isFetching&&k.hasPreciseFeatureCount){const t=this._maximumFeaturesForTile(k)*(1-k.emptyFeatureRatio);f+=t-(null!=k.displayingFeatures?k.displayingFeatures.length*
g:0)}k.needsFetching?++e:0<k.numFeatures&&(++d,b+=k.numFeatures)});e+=a;let p=0,q=0;b?(q=b,p=Math.min(e*b/d,b)):(q=c,p=e);f=Math.min(this.maximumNumberOfFeatures-this.features.length,f);this._set("updatingTotal",q);this._set("updatingRemaining",p);this._set("expectedFeatureDiff",f)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const a=C.someMap(this._featureTiles,
b=>b.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",a)}_updateRatio(a){const b=S(a),c=f=>1/(1<<Math.max(0,b-f.descriptor.lij[0]));let d=0,e=0;for(const f of a)a=f.numFeatures,d+=a,e+=a*c(f);this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/d);this._farRatio=this.maximumNumberOfFeatures/e;this._scheduleUpdated();return c}_maximumFeaturesUpdated(a,b){a!==b&&(b>a&&this._featureTiles.forEach(c=>{if(c.featuresMissing){var d=this._maximumFeaturesForTile(c);c.features&&
(c.features.length>=d||c.fetchStatus===n.FetchStatus.FULL)||(this._cancelFetchTile(c),this._resetFetchTile(c))}}),this._setDirty())}_addTile(a){a=new n.FeatureTile(a);this._featureTiles.set(a.id,a);this._resetFetchTile(a);this._referenceDisplayingFeaturesFromRelatedTiles(a);return a}_referenceDisplayingFeaturesFromRelatedTiles(a){const b=a.descriptor.resolution;this._featureTiles.forEach(c=>{if(!(null==c.displayingFeatures||a===c||a.descriptor.lij&&c.descriptor.lij&&!R.tilesAreRelated(a.descriptor.lij,
c.descriptor.lij))){null==a.displayingFeatures&&(a.displayingFeatures=[]);a.descriptor.extent&&c.descriptor.extent&&(null==a.extentIncludingBorrowedFeatures&&(a.extentIncludingBorrowedFeatures=u.clone(a.descriptor.extent)),u.expand(a.extentIncludingBorrowedFeatures,c.descriptor.extent,a.extentIncludingBorrowedFeatures));for(const d of c.displayingFeatures)a.displayingFeatures.push(d),c=this._displayingFeatureReferences.get(r.getObjectId(d,this._objectIdField)),c.ref(c.feature,b),this._numDisplayingFeatureReferences++}});
a.featureLimit=null!=a.displayingFeatures?a.displayingFeatures.length:0}_removeTile(a){this._clearTile(a);this._featureTiles.delete(a.id)}_resetFetchTile(a){a.filtered=!a.intersects(this.filterExtent);a.filtered?a.needsFetching&&(a.fetchStatus=n.FetchStatus.DONE):a.fetchStatus=n.FetchStatus.FETCH_NEEDED}_cancelFetchTile(a){const b=a.requestController;null!=b&&(a.requestController=null,a.resetFetching(),b.abort())}async _fetchTileCount(a,b){a.numFeatures=await this._fetchCount(a,b);this._updateRatio(this._getListOfTiles());
return a.fetchStatus===n.FetchStatus.REFETCHING?n.FetchStatus.REFETCH_NEEDED:n.FetchStatus.FETCH_NEEDED}async _fetchTile(a,b){a.fetchFailed=!1;var c=this._maximumFeaturesForTile(a);if(0>=c)return a.hasPreciseFeatureCount&&0===a.numFeatures||(a.fetchFailed=!0),T(a);const d=this._getMaxRecordCount(a);var e=Math.ceil(c/d);if(y(a)||!this.context.capabilities.supportsMaxRecordCountFactor||a.numFeatures<=c&&e>D.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(a,b);e=this._createQuery(a);e.maxRecordCountFactor=
Math.ceil(c/d);a.isRefetching&&a.features&&0<a.features.length&&(e.maxRecordCountFactor=Math.max(Math.ceil(a.features.length/(1-a.emptyFeatureRatio)/d)+1,e.maxRecordCountFactor));const {features:f,exceededTransferLimit:g,fields:p,missingAttributes:q}=await this._queryFeatures(e,b);c=g?e.maxRecordCountFactor>=D.MAX_MAX_RECORD_COUNT_FACTOR?n.FetchStatus.FULL:n.FetchStatus.DONE:n.FetchStatus.FULL;await this._frameTask.schedule(()=>{a.featuresMissing=a.hasPreciseFeatureCount&&f.length<a.numFeatures||
!!g;const k=this._removeEmptyFeatures(f);a.setFeatures(f,k,G(p),z(void 0,q))},b);w.throwIfAborted(b);this._invalidateCounts();return c}async _fetchCount(a,b){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(a),{signal:b})}async _fetchPagedTile(a,b){let c=0,d=0,e,f=0,g=this._maximumFeaturesForTile(a)-f;const p=this._getMaxRecordCount(a);let q=null,k;for(;;){const t=this._createQuery(a),A=this._setPagingParameters(t,c,g,p),{features:x,exceededTransferLimit:B,fields:U,missingAttributes:V}=
await this._queryFeatures(t,b);await this._frameTask.schedule(()=>{A&&(c+=t.num);f+=x.length;d+=this._removeEmptyFeatures(x);a.featuresMissing=A&&a.hasPreciseFeatureCount&&c<a.numFeatures||!!B;e=e?e.concat(x):x;q=H(q,U);k=z(k,V);a.setFeatures(e,d,q,k)},b);w.throwIfAborted(b);this._invalidateCounts();this._setDirty();g=this._maximumFeaturesForTile(a)-f;if(!A||!B||0>=g)return B?n.FetchStatus.DONE:n.FetchStatus.FULL}}_createFeatureCountQuery(a){a=this._createQuery(a);this.context.capabilities.supportsCacheHint&&
(a.resultType=void 0,a.cacheHint=!0);return a}_createQuery(a){const b=this.context.createQuery(),c=a.descriptor.extent;c&&(b.geometry=u.toExtent(c,this.context.tilingScheme.spatialReference));this._setResolutionParams(b,a);this._useTileQuery(a)?b.resultType="tile":this.context.capabilities.supportsCacheHint&&(b.cacheHint=!0);return b}_setPagingParameters(a,b,c,d){if(!this.context.capabilities.supportsPagination)return!1;a.start=b;0<c&&this.context.capabilities.supportsMaxRecordCountFactor?(a.maxRecordCountFactor=
Math.ceil(c/d),a.num=Math.min(a.maxRecordCountFactor*d,c)):a.num=Math.min(d);return!0}_getEffectiveTileResolution(a){if(null==a.descriptor.resolution)return null;const b=this.context.viewingMode===Q.ViewingMode.Global?this.context.tilingScheme.resolutionAtLevel(3):Infinity;return Math.min(a.descriptor.resolution,b)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(a,b){this._supportsResolution&&
(b=this._getEffectiveTileResolution(b),null!=b&&(this.context.capabilities.supportsQuantization?a.quantizationParameters=new P({mode:"view",originPosition:"upper-left",tolerance:b,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(a.maxAllowableOffset=b)))}_removeEmptyFeatures(a){const b=a.length;for(let c=0;c<a.length;)r.hasVertices(a[c].geometry)?++c:(a[c]=a[a.length-1],--a.length);return b-a.length}_needsNumFeatures(a){return this.useTileCount&&a.needsFeatureCount&&!y(a)}_getMaxRecordCount(a){const {tileMaxRecordCount:b,
maxRecordCount:c}=this.context;return this._useTileQuery(a)&&null!=b&&0<b&&this.context.capabilities.supportsResultType?b:null!=c&&0<c?c:2E3}_useTileQuery(a){return y(a)&&this.context.capabilities.supportsCacheHint?!1:this.context.capabilities.supportsResultType}_handleRequest(a,b,c,d){a.fetchStatus=a.needsRefetching?n.FetchStatus.REFETCHING:n.FetchStatus.FETCHING;a.requestController=c;let e=!1;b.then(f=>{a.requestController=null;a.fetchStatus=f}).catch(f=>{a.requestController===c&&(a.requestController=
null,a.fetchStatus=n.FetchStatus.DONE);w.isAbortError(f)?e=!0:d(f)}).then(()=>{e||this._setDirty();this._scheduleUpdated()})}_scheduleUpdated(){this.hasHandles("scheduleUpdated")||this.addHandles(N.schedule(()=>{this.removeHandles("scheduleUpdated");this._updated()}),"scheduleUpdated")}_showTile(a){if(null!=a.displayingFeatures&&!a.needsDisplayUpdate)return!1;var b=a.features;if(0===a.featureLimit||!b)return b=null!=a.displayingFeatures&&0<a.displayingFeatures.length,this._hideTileFeatures(a),a.displayingFeatures=
[],b;const c=a.descriptor.resolution,d=this._changes.updates,e=this._changes.adds,f=Math.min(a.featureLimit,b.length);a.featureLimit=f;for(let p=0;p<f;++p){var g=b[p];const q=r.getObjectId(g,this._objectIdField),k=this._displayingFeatureReferences.get(q);k?(g=k.ref(g,c),g.oldVersion!==g.newVersion&&(g.oldVersion&&d.removes.push(g.oldVersion),g.newVersion&&d.adds.push(g.newVersion))):(this._displayingFeatureReferences.set(q,new this.FeatureReferenceClass(g,c)),e.push(g));this._numDisplayingFeatureReferences++}this._hideTileFeatures(a);
this._applyChanges();a.displayingFeatures=b.slice(0,f);return!0}_hideTile(a){this._cancelFetchTile(a);this._hideTileFeatures(a)}_hideTileFeatures(a){if(null!=a.displayingFeatures){var b=this._changes.updates,c=this._changes.removes;for(const e of a.displayingFeatures){const f=r.getObjectId(e,this._objectIdField);var d=this._displayingFeatureReferences.get(f);d&&((d=d.unref(a.descriptor.resolution),this._numDisplayingFeatureReferences--,d)?d.oldVersion!==d.newVersion&&(null==d.newVersion?(this._displayingFeatureReferences.delete(f),
d.oldVersion&&c.push(d.oldVersion)):(b.adds.push(d.newVersion),d.oldVersion&&b.removes.push(d.oldVersion))):console.error("Hiding unreferenced feature"))}this._applyChanges();a.displayingFeatures=null}}_applyChanges(){var a=this._changes.updates;0<a.removes.length&&(this.features.removeMany(a.removes),a.removes.length=0);0<a.adds.length&&(this.features.addMany(a.adds),a.adds.length=0);a=this._changes.adds;const b=this._changes.removes,c=Math.min(a.length,b.length);let d=0;for(;d<c;){const e=Math.min(d+
200,c);this.features.addMany(a.slice(d,e));this.features.removeMany(b.slice(d,e));d=e}a.length>c&&this.features.addMany(0===d?a:a.slice(d));b.length>c&&this.features.removeMany(0===d?b:b.slice(d));a.length=0;b.length=0}_clearTile(a){this._hideTile(a);a.features&&null!=this.context.memoryCache&&this.context.memoryCache.put(a.id,a.cache,16+a.estimatedSize);a.setFeatures(null,0,null,void 0);this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices");this.notifyChange("totalFeatures");
this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((a,b)=>a+(b.features?b.features.length:0),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce((a,b)=>a+(b.needsFetching||b.isFetching?1:0),0)}_maximumFeaturesForTile(a){const b=a.hasPreciseFeatureCount?a.numFeatures:Infinity;return Math.min(Math.ceil((a.hasPreciseFeatureCount?b:this.maximumNumberOfFeatures)*
(1>this._fullRatio?this._farRatio:1)/(1-a.emptyFeatureRatio)),b)}get test(){return{process:a=>this.runTask(a),getFeatureTileById:a=>this._featureTiles.get(a),forEachFeatureTile:a=>this._featureTiles.forEach(a)}}};l.__decorate([m.property({constructOnly:!0})],h.FeatureTileFetcher3D.prototype,"features",void 0);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0);l.__decorate([m.property({value:Infinity})],h.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",
null);l.__decorate([m.property({value:1})],h.FeatureTileFetcher3D.prototype,"memoryFactor",null);l.__decorate([m.property({value:1})],h.FeatureTileFetcher3D.prototype,"lodFactor",null);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"useTileCount",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"dataUpdating",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,
"running",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"updatingTotal",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,
"maximumNumberOfFeaturesExceeded",void 0);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"totalVertices",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"totalFeatures",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"hasAllFeatures",null);l.__decorate([m.property({readOnly:!0})],h.FeatureTileFetcher3D.prototype,"hasFullGeometries",null);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"filterExtent",
null);l.__decorate([m.property({constructOnly:!0})],h.FeatureTileFetcher3D.prototype,"context",void 0);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"_dirty",void 0);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"_pendingEdits",void 0);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"_applyEditsTilesUpdated",void 0);l.__decorate([m.property()],h.FeatureTileFetcher3D.prototype,"_isFetching",void 0);h.FeatureTileFetcher3D=l.__decorate([O.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],
h.FeatureTileFetcher3D);const I=u.create(),J=u.create();h.contextCapabilitiesFromLayer=function(a){const b=a.capabilities.query;a:switch(a.geometryType){case "polyline":a=!0;break a;case "polygon":a=a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization;break a;default:a=!1}return{supportsMultipleResolutions:a,supportsPagination:!(!b||!b.supportsPagination),supportsResultType:!(!b||!b.supportsResultType),supportsCacheHint:!(!b||!b.supportsCacheHint),supportsQuantization:!(!b||
!b.supportsQuantization),supportsQuantizationEditMode:!(!b||!b.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!b||!b.supportsMaxRecordCountFactor),supportsFormatPBF:!(!b||!b.supportsFormatPBF)}};Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});