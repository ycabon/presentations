// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/screenUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/triangle ../../../ViewingMode ./FeatureTileDescriptor3D ./FeatureTileVisibility3D ../../webgl-engine/lib/Camera".split(" "),function(z,p,q,h,k,G,v,H,I,A,w,J){function r(a,e,d,b){const c=v.signedDistance(b,e);b=v.signedDistance(b,d);const f=
Math.abs(b-c);q.scale(a,e,Math.abs(b)/f);q.scaleAndAdd(a,a,d,Math.abs(c)/f)}class K{constructor(a){this._camera=new J.Camera;this._focusOnMap=[0,0];this._screenRect=k.create();this._tileSize=a.tileSize;this._renderCoordsHelper=a.renderCoordsHelper;this._tilingScheme=a.tilingScheme;this._visibility=new w.FeatureTileVisibility3D(a.renderCoordsHelper)}begin(a,e,d){this._camera.copyFrom(a);this._surfaceElevation=d;this._focusOnMap[0]=e.x;this._focusOnMap[1]=e.y;k.fromValues(0,0,a.fullWidth,a.fullHeight,
this._screenRect);this._visibility.begin(this._camera,d)}end(){this._visibility.end()}updateTile(a){a.measures.visibility=this._visibility.calculate(a);a.measures.distance=k.distance(a.extent,this._focusOnMap);a.measures.visibility!==A.Visibility.INVISIBLE&&this._updateScreenMeasure(a)}_updateScreenMeasure(a){const e=a.measures.screenRect;k.empty(e);let d=0;var b=a.lij,c=b[0];const f=c+2,g=b[1]<<2,L=b[2]<<2;var x=this._tileSizeWithBias(a);x*=x;var l=this._camera;const {frustum:M,viewport:t}=l;if(this._renderCoordsHelper.viewingMode===
I.ViewingMode.Local||c>w.globalTileLevelThreshold){c=B;this._tilingScheme.getExtent(b[0],b[1],b[2],c);const C=n,y=N;b=k.empty();for(let m=0;4>m;++m)this._toRenderCoords(c,D[m][0],D[m][1],y[m]),l.projectToScreen(y[m],C[m]),k.expandPointInPlace(b,C[m]);l=w.isConvexHullOutsideOfFrustum(M,y,4);c=b[0]>t[2]||b[1]>t[3]||b[2]<t[0]||b[3]<t[1];if(l||c){a.measures.shouldSplit=!1;return}}for(l=0;4>l;l++)for(c=0;4>c;c++)if(d+=this._computeScreenArea(f,g+l,L+c,e),d>x){a.measures.shouldSplit=!0;return}a.measures.shouldSplit=
!1}_tileSizeWithBias(a){return a.measures.visibility===A.Visibility.VISIBLE_WHEN_EXTENDED?5*this._tileSize:this._tileSize}_computeScreenArea(a,e,d,b){this._tilingScheme.ensureMaxLod(a);const c=B;this._tilingScheme.getExtent(a,e,d,c);a=O;this._toRenderCoords(c,0,3,a[0]);this._toRenderCoords(c,2,3,a[1]);this._toRenderCoords(c,2,1,a[2]);this._toRenderCoords(c,0,1,a[3]);return this._computeTriangleScreenArea([a[0],a[1],a[2]],b)+this._computeTriangleScreenArea([a[2],a[1],a[3]],b)}_computeTriangleScreenArea(a,
e){const d=this._camera.frustum[G.PlaneIndex.NEAR];var b=0,c=-1,f=-1;for(var g=0;3>g;++g)0<v.signedDistance(d,a[g])?(b++,-1===c&&(c=g)):-1===f&&(f=g);return 0===b?this._computeTriangleScreenAreaInside(a,e):1===b?(f=E,b=(c+1)%3,g=(c+2)%3,q.copy(f[0],a[b]),q.copy(f[1],a[g]),r(f[2],a[g],a[c],d),g=this._computeTriangleScreenAreaInside(f,e),r(f[1],a[b],a[c],d),a=this._computeTriangleScreenAreaInside(f,e),g+a):2===b?(c=E,b=f,q.copy(c[0],a[b]),g=(f+2)%3,r(c[1],a[b],a[(f+1)%3],d),r(c[2],a[b],a[g],d),this._computeTriangleScreenAreaInside(c,
e)):0}_computeTriangleScreenAreaInside(a,e){for(let d=0;3>d;d++)this._camera.projectToRenderScreen(a[d],F),this._camera.renderToScreen(F,n[d]),k.expand(e,n[d],e);return H.areaPoints2d(n[0],n[1],n[2])}_toRenderCoords(a,e,d,b){u[0]=a[e];u[1]=a[d];u[2]=this._surfaceElevation;this._renderCoordsHelper.toRenderCoords(u,this._tilingScheme.spatialReference,b);return b}}const n=[p.createScreenPointArray(),p.createScreenPointArray(),p.createScreenPointArray(),p.createScreenPointArray()],B=k.create(),u=h.create(),
O=[h.create(),h.create(),h.create(),h.create()],F=p.createRenderScreenPointArray3(),E=[h.create(),h.create(),h.create()],N=[h.create(),h.create(),h.create(),h.create()],D=[[0,3],[2,3],[2,1],[0,1]];z.FeatureTileMeasurements3D=K;Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});