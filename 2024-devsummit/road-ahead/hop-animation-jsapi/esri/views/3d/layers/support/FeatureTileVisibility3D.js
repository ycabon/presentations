// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/mathUtils ../../../../core/ObjectPool ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/projection/projectBuffer ../../../../geometry/projection/projectVec3Array ../../../../geometry/support/frustum ../../../../geometry/support/plane ../../../../geometry/support/ray ../../../ViewingMode ./FeatureTileDescriptor3D ../../state/Frustum ../../support/FrustumExtentIntersection".split(" "),
function(C,Q,R,e,g,G,S,T,m,v,U,E,t,z,V){function w(a,b,d){e.cross(a,b,d);e.normalize(a,a);return a}function H(a,b,d){e.sub(a,b,d);e.normalize(a,a);return a}function A(a,b){e.scale(a,a,b/e.len(a));return a}function F(a,b,d){for(const l of W){a:{var c=a[l];var f=b,h=d;for(let k=0;k<h;++k)if(0>v.signedDistance(c,f[k])){c=!1;break a}c=!0}if(c)return!0}return!1}function X(a,b){for(const d of b)if(1E-5>e.dot(d,a))return!1;return!0}function Y(a,b,d,c){var f=Z;w(f,a,b);a=aa;b=Infinity;let h=-Infinity;for(var l of d)d=
e.dot(f,l),b=Math.min(b,d),h=Math.max(h,d);a[0]=b;a[1]=h;a:{l=a[0];d=a[1];a=Infinity;b=-Infinity;for(const k of c)if(c=e.dot(f,k),a=Math.min(a,c),b=Math.max(b,c),a<=d&&b>=l){f=!1;break a}f=!0}return f}class ba{constructor(a){this._renderCoordsHelper=a;this._surfaceElevation=0;this._cache=new Map;this._frustumBoundingSphereCenter=g.create();this._frustumBoundingSphereRadius=0;this._frustum=new z.Frustum(a);this._extendedFrustum=new z.Frustum(a);this._intersector=new V.FrustumExtentIntersection({renderCoordsHelper:a});
this._renderCoordsHelper=a}begin(a,b){this._surfaceElevation=b;this._aboveGround=this._renderCoordsHelper.getAltitude(a.eye)>b;this._frustum.update(a);this._shortenFrustumFarPlane(this._frustum);this._updateExtendedFrustum(a);this._updateFrustumBoundingSphere()}end(){this._cache.clear()}calculate(a){const b=this._renderCoordsHelper.viewingMode===E.ViewingMode.Global&&2<=a.lij[0]&&6>a.lij[0],d=this._getOrCalculateSingleTileVisibility(a,!b);return d!==t.Visibility.INVISIBLE&&b?this._calculateAggregatedChildrenVisibility(a):
d}_shortenFrustumFarPlane(a){var b=z.Frustum.nearFarLineIndices;const d=a.mutablePoints;for(const c of b){const [f,h]=c;b=d[f];e.subtract(r,d[h],b);e.scale(r,r,.95);e.add(d[h],b,r)}a.updatePoints(d)}_calculateAggregatedChildrenVisibility(a){let b=t.Visibility.INVISIBLE;var d=this._cache.get(a.id);if(null!=d)return d;d=I.acquire();a.getChildren(d);for(const c of d){const f=this.calculate(c);if(f!==t.Visibility.INVISIBLE&&(b=f,f===t.Visibility.VISIBLE_ON_SURFACE))break}I.release(d);this._cache.set(a.id,
b);return b}_getOrCalculateSingleTileVisibility(a,b){var d=this._cache.get(a.id);if(null!=d)return d;d=this._calculateSingleTileVisibility(a);b&&this._cache.set(a.id,d);return d}_calculateSingleTileVisibility(a){if(!this._aboveGround&&this._renderCoordsHelper.viewingMode===E.ViewingMode.Global&&12>a.lij[0]){if(this._calculateSingleTileVisibilitySided(a,!1)===t.Visibility.INVISIBLE)return this._calculateSingleTileVisibilitySided(a,!0)}else return this._calculateSingleTileVisibilitySided(a,this._aboveGround)}_isTileVisibleInFrustum(a){return this._renderCoordsHelper.viewingMode===
E.ViewingMode.Local?this._isTileVisibleInFrustumLocal(a):this._isTileVisibleInFrustumGlobal(a)}_updateFrustumBoundingSphere(){var a=this._frustum;const b=a.origin,d=ca;e.normalize(d,a.direction);var c=da;e.sub(c,a.points[4],b);a=e.dot(c,c);c=e.dot(d,c);c=.5*a/c;e.scaleAndAdd(this._frustumBoundingSphereCenter,b,d,c);this._frustumBoundingSphereRadius=1+c}_isTileVisibleInFrustumLocal(a){var b=a.tilingScheme.spatialReference,d=a.extent,c=this._renderCoordsHelper.spatialReference;a=ea;a[0]=d[0];a[1]=d[1];
a[2]=0;a[3]=d[2];a[4]=d[3];a[5]=0;if(!S.projectBuffer(a,b,0,a,c,0,2))return!1;b=J;e.set(b[0],a[0],a[1],0);e.set(b[1],a[3],a[1],0);e.set(b[2],a[3],a[4],0);e.set(b[3],a[0],a[4],0);var f=K;e.set(f,.5*(a[0]+a[3]),.5*(a[1]+a[4]),.5*(a[2]+a[5]));a=L;e.set(a,0,0,1);var h=.5*e.dist(b[0],b[2]);d=this._frustum;c=this._frustumBoundingSphereRadius;const l=this._frustumBoundingSphereCenter;var k=fa;e.sub(k,l,f);k=e.dot(a,k);const n=ha;e.scaleAndAdd(n,f,a,k);if(e.dist(n,l)>h+c)return!1;f=ia;h=k+c;c=k-c;for(k=0;4>
k;++k)e.scaleAndAdd(f[k],b[k],a,h),e.scaleAndAdd(f[k+4],b[k],a,c);return!F(d.planes,f,8)}_isTileVisibleInFrustumGlobal(a){var b=a.tilingScheme.spatialReference,d=a.extent,c=this._renderCoordsHelper.spatialReference;if(3>a.lij[0])return!0;const f=J;var h=.5*(d[0]+d[2]),l=0<f[0][2],k=0>f[3][2],n=l||k,p=d[l?1:3];e.set(f[0],d[0],d[1],0);e.set(f[1],d[2],d[1],0);e.set(f[2],d[2],d[3],0);e.set(f[3],d[0],d[3],0);e.set(f[4],h,p,0);if(!T.projectVec3Array(f,b,0,f,c,0,n?5:4))return!1;d=G.getReferenceEllipsoid(c).radius;
n&&(h=g.fromValues(0,0,1),c=ja,w(c,h,f[0]),n=ka,w(n,h,f[1]),l?(l=M,k=f[4],p=N,w(p,k,h),w(l,p,k),h=f[0],e.cross(h,c,l),A(h,d),c=f[1],e.cross(c,n,l),A(c,d)):k&&(l=M,k=f[4],p=N,w(p,k,h),w(l,k,p),h=f[3],e.cross(h,l,c),A(h,d),c=f[2],e.cross(c,l,n),A(c,d)));h=K;n=la;e.sub(n,f[3],f[0]);e.normalize(n,n);c=ma;e.add(c,f[0],f[3]);e.scale(c,c,.5);k=-e.dot(c,n);c=na;p=oa;e.add(c,f[0],f[1]);e.scale(c,c,.5);e.add(p,f[2],f[3]);e.scale(p,p,.5);l=pa;e.sub(l,p,c);e.normalize(l,l);n=-(k+e.dot(n,c))/e.dot(n,l);e.scaleAndAdd(h,
c,l,n);A(h,d);e.scale(L,h,1/d);l=qa;c=this._frustumBoundingSphereRadius;p=this._frustumBoundingSphereCenter;const B=this._frustum;n=B.planes;if(f.some(y=>B.intersectsPoint(y))||B.intersectsPoint(h))return!0;var u=ra;e.normalize(u,h);h=sa;e.sub(h,p,l);k=e.dot(h,u);if(k<-c)return!1;h=ta;e.normalize(h,f[0]);h=e.dot(h,u);if(0>=h)return!0;var x=ua;e.scale(x,u,k);p=e.dist(x,p);b=b.isWGS84;u=a.lij;a=b&&u[2]===2**u[0]-1;x=(b=b&&0===u[2])?va:a?wa:xa;a=b?ya:a?za:Aa;b=B.points;u=Ba;for(var q of x){x=Ca;const y=
Da,D=f[q],Ea=l;H(x,f[(q+1)%4],D);H(y,Ea,D);w(u,y,x);if(X(u,b))return!1}q=null;if(k<2*c){q=2.5*c;if(p>h*q+c)return!1;c=Fa;q/=h;for(h=0;4>h;++h)e.scale(c[h],f[h],q/d);e.set(c[4],0,0,0);q=c}else{q=(k+c)/h;c=(k-c)/h;h=Ga;for(l=0;4>l;++l)k=f[l],e.scale(h[l+4],k,c/d),e.scale(h[l],k,q/d);q=h}if(F(n,q,q.length))return!1;d=B.lines;n=Ha;c=Ia;for(const y of a){e.normalize(n,f[y]);for(const D of d)if(e.normalize(c,D.direction),Y(c,n,q,b))return!1}return!0}_calculateSingleTileVisibilitySided(a,b){return this._isTileVisibleInFrustum(a)?
(this._intersector.update(a.extent,a.tilingScheme.spatialReference,this._surfaceElevation,b),a=G.getReferenceEllipsoid(a.tilingScheme.spatialReference).radius,this._intersector.isVisibleInFrustum(this._frustum,a,!0)?t.Visibility.VISIBLE_ON_SURFACE:t.Visibility.VISIBLE_WHEN_EXTENDED):t.Visibility.INVISIBLE}_updateExtendedFrustum(a){this._extendedFrustum.update(a);this._shortenFrustumFarPlane(this._extendedFrustum);var b=this._renderCoordsHelper.worldUpAtPosition(a.eye,r);this._aboveGround||e.negate(b,
b);if(this._hasExtendedFrustum=Q.acosClamped(-e.dot(b,a.viewForward))>a.fovY/2){a=this._extendedFrustumParameters();b=this._extendedFrustum.mutablePoints;for(let d=0;4>d;d++){const c=a.pointIndices[d],f=b[c],h=this._renderCoordsHelper.getAltitude(f);if(a.needsAltitudeAdjustment(h)){this._renderCoordsHelper.worldUpAtPosition(f,r);switch(c){case m.PointIndex.FAR_BOTTOM_LEFT:case m.PointIndex.FAR_TOP_LEFT:case m.PointIndex.NEAR_BOTTOM_LEFT:case m.PointIndex.NEAR_TOP_LEFT:v.projectVector(this._extendedFrustum.planes[m.PlaneIndex.LEFT],
r,r);break;case m.PointIndex.FAR_BOTTOM_RIGHT:case m.PointIndex.FAR_TOP_RIGHT:case m.PointIndex.NEAR_BOTTOM_RIGHT:case m.PointIndex.NEAR_TOP_RIGHT:v.projectVector(this._extendedFrustum.planes[m.PlaneIndex.RIGHT],r,r)}e.scale(r,r,a.direction);this._renderCoordsHelper.intersectInfiniteManifold(U.wrap(f,r),a.zWithMargin,f)}}this._extendedFrustum.updatePoints(b);v.fromPoints(b[m.PointIndex.NEAR_BOTTOM_LEFT],b[m.PointIndex.NEAR_BOTTOM_RIGHT],b[m.PointIndex.NEAR_TOP_RIGHT],O);v.fromPoints(b[m.PointIndex.NEAR_BOTTOM_RIGHT],
b[m.PointIndex.NEAR_TOP_RIGHT],b[m.PointIndex.NEAR_TOP_LEFT],P);0>e.dot(v.getNormal(O),v.getNormal(P))&&(a=this._extendedFrustum.mutablePoints,this._aboveGround?[a[m.PointIndex.NEAR_BOTTOM_LEFT],a[m.PointIndex.NEAR_BOTTOM_RIGHT]]=[a[m.PointIndex.NEAR_BOTTOM_RIGHT],a[m.PointIndex.NEAR_BOTTOM_LEFT]]:[a[m.PointIndex.NEAR_TOP_LEFT],a[m.PointIndex.NEAR_TOP_RIGHT]]=[a[m.PointIndex.NEAR_TOP_RIGHT],a[m.PointIndex.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(a))}}_extendedFrustumParameters(){return this._aboveGround?
this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const a=this._surfaceElevation-1;return{zWithMargin:a,pointIndices:z.Frustum.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment(b){return b>a}}}_extendedFrustumParametersBelowSurface(){const a=this._surfaceElevation+1;return{zWithMargin:a,pointIndices:z.Frustum.planePointIndices.top,direction:1,needsAltitudeAdjustment(b){return b<a}}}}const r=g.create(),O=
v.create(),P=v.create(),I=new R(Array,a=>{4!==a.length&&(a[0]=new t.FeatureTileDescriptor3D,a[1]=new t.FeatureTileDescriptor3D,a[2]=new t.FeatureTileDescriptor3D,a[3]=new t.FeatureTileDescriptor3D)},a=>{a[0].release();a[1].release();a[2].release();a[3].release()}),W=[m.PlaneIndex.LEFT,m.PlaneIndex.RIGHT,m.PlaneIndex.BOTTOM,m.PlaneIndex.TOP,m.PlaneIndex.FAR],ia=[g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create()],ea=[0,0,0,0,0,0],J=[g.create(),g.create(),g.create(),
g.create(),g.create()],K=g.create(),L=g.create(),M=g.create(),ja=g.create(),ka=g.create(),N=g.create(),ra=g.create(),ua=g.create(),ta=g.create(),ca=g.create(),da=g.create(),ha=g.create(),fa=g.create(),qa=g.fromValues(0,0,0),sa=g.create(),Ga=[g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create(),g.create()],Fa=[g.create(),g.create(),g.create(),g.create(),g.create()],la=g.create(),ma=g.create(),na=g.create(),oa=g.create(),pa=g.create(),Ca=g.create(),Da=g.create(),Ha=g.create(),
Ia=g.create(),Z=g.create(),xa=[0,1,2,3],Aa=[0,1,2,3],wa=[0,1,3],za=[0,1,3],va=[1,2,3],ya=[1,2,3],Ba=g.create(),aa=[0,0];C.FeatureTileVisibility3D=ba;C.globalTileLevelThreshold=3;C.isConvexHullOutsideOfFrustum=F;Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});