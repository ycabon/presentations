// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/compilerUtils ../../../../core/mathUtils ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/ray ../../../../chunks/sphere ../../../../geometry/support/vector ../../../../geometry/support/vectorStacks ../../camera/constraintUtils ../../camera/constraintUtils/ConstraintOptions ../../camera/constraintUtils/ConstraintTypes ../../camera/constraintUtils/InteractionType ../../camera/constraintUtils/TiltMode ../Constraints ./InteractiveController ../utils/navigationUtils ../utils/viewUtils ../../support/cameraUtils ../../support/cameraUtilsInternal ../../webgl-engine/lib/Camera ../../../navigation/gamepadAndKeyboardUtils".split(" "),
function(v,C,M,q,F,aa,ba,N,n,G,e,H,I,J,D,O,l,w,P,r,x,Q,z,R,y,K,S,T,L,t){v.GamepadKeyboardController=class extends R.InteractiveController{constructor(a){super(a);this._filteredSurfaceElevation=0;this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0};this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0];this._tmpCamera=new L.Camera;this._headingStart=0;this._constraintOptions=new P.ConstraintOptions(r.ConstraintTypes.ALL,x.InteractionType.NONE,0,new L.Camera,null,Q.TiltMode.LOOK_AROUND)}handleEventGamepad(a){const b=
t.extractTransformation(a,this.view.navigation.gamepad,this._transformation);("end"===a.action||t.isZeroTransformation(b))&&this.finishController()}activateDirection(a){this._keysButtonState[a]=1;t.extractTransformationKeyboard(this._keysButtonState,this._transformation)}deactivateDirection(a){this._keysButtonState[a]=0;a=t.extractTransformationKeyboard(this._keysButtonState,this._transformation);t.isZeroTransformation(a)&&this.finishController()}onControllerStart(a){this._filteredSurfaceElevation=
this.view.pointsOfInterest.cameraOnSurface.location.z;this._headingStart=this.view.camera.heading;super.onControllerStart(a)}_updateFilteredSurfaceElevation(a){this._filteredSurfaceElevation+=(this.view.pointsOfInterest.cameraOnSurface.location.z-this._filteredSurfaceElevation)*a}stepController(a,b){this._updateStartHeading();this._updateFilteredSurfaceElevation(a);this.currentCamera.copyViewFrom(b);this._updateCameraCenter();this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera);
this._calculateControlTransformation(a,this.currentCamera,u);this._applyDisabledMovementTypes(u);this._applyPan(u.pan);this._applyRotate(u.rotate);this._applyZoom(u.zoom);this._applyAscend(u.ascend);this._constraintOptions.interactionType=x.InteractionType.NONE;this._constraintOptions.selection=r.ConstraintTypes.COLLISION;w.applyAll(this.view,this.currentCamera,this._constraintOptions);super.stepController(a,b)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(a){if(a.enabled){var b=
this.currentCamera;e.subtract(m,b.center,b.eye);e.transformMat4(m,m,a.matrix);b.center=e.add(m,m,b.eye);b.up=e.transformMat4(m,b.up,a.matrix);this._constraintOptions.interactionType=x.InteractionType.LOOK_AROUND;this._constraintOptions.selection=r.ConstraintTypes.ALL_EXCEPT_COLLISION;w.applyAll(this.view,b,this._constraintOptions)}}_applyPan(a,b=this.currentCamera){a.enabled&&(b.eye=e.transformMat4(m,b.eye,a.matrix),b.center=e.transformMat4(m,b.center,a.matrix),this.view.state.isGlobal&&(b.up=e.transformMat4(m,
b.up,a.matrix)),this._constraintOptions.interactionType=x.InteractionType.PAN,this._constraintOptions.selection=r.ConstraintTypes.ALL,w.applyAll(this.view,b,this._constraintOptions))}_applyZoom(a){if(a){var b=this.currentCamera.viewForward;this.currentCamera.eye=e.add(m,this.currentCamera.eye,e.scale(l.sv3d.get(),b,a));e.copy(A,b);e.negate(A,A);this._constraintOptions.interactionDirection=A;this._constraintOptions.interactionType=x.InteractionType.ZOOM;this._constraintOptions.selection=r.ConstraintTypes.ALL_EXCEPT_COLLISION;
w.applyAll(this.view,this.currentCamera,this._constraintOptions);this._constraintOptions.interactionDirection=null}}_applyAscend(a){if(a){var b=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,l.sv3d.get());this._constraintOptions.interactionDirection=e.copy(A,b);this.view.state.isGlobal?(b=e.length(this.currentCamera.eye),a=(b+a)/b,this.currentCamera.eye=e.scale(m,this.currentCamera.eye,a),this.currentCamera.center=e.scale(m,this.currentCamera.center,a)):(a=e.scale(l.sv3d.get(),
b,a),this.currentCamera.eye=e.add(m,this.currentCamera.eye,a),this.currentCamera.center=e.add(m,this.currentCamera.center,a));this._updateCameraCenter();this._constraintOptions.interactionType=x.InteractionType.ASCEND;this._constraintOptions.selection=r.ConstraintTypes.COLLISION;w.applyAll(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter();this._constraintOptions.selection=r.ConstraintTypes.ALL_EXCEPT_COLLISION;w.applyAll(this.view,this.currentCamera,this._constraintOptions);
this._constraintOptions.interactionDirection=null}}_calculateControlTransformation(a,b,c){c.zoom=0;c.ascend=0;c.pan.enabled=!1;n.identity(c.pan.matrix);c.rotate.enabled=!1;n.identity(c.rotate.matrix);a=this._computeVelocities(a);this.view.state.isLocal?this._calculateControlTransformationLocal(a,b,c):this._calculateControlTransformationGlobal(a,b,c)}_updateCameraCenter(){this.currentCamera.center=this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(this.currentCamera.ray,this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,
m)}_calculateControlTransformationLocal(a,b,c){const {viewRight:f,viewForward:k}=b,d=this._transformation;var h=this.view.navigation.gamepad,g=e.set(l.sv3d.get(),k[0],k[1],0);e.normalize(g,g);var p=d.translation[0]*a.pan;0!==p&&(p=e.scale(l.sv3d.get(),f,p),n.translate(c.pan.matrix,c.pan.matrix,p),c.pan.enabled=!0);switch(h.mode){case "pan":h=-d.translation[1]*a.pan;0!==h&&(g=e.scale(l.sv3d.get(),g,h),n.translate(c.pan.matrix,c.pan.matrix,g),c.pan.enabled=!0);c.zoom=d.zoom*a.zoom;break;case "zoom":c.zoom=
(-d.translation[1]+d.zoom)*a.zoom;break;default:M.neverReached(h.mode)}c.ascend=d.translation[2]*a.ascend;g=-d.heading*a.rotate;0!==g&&(n.rotate(c.rotate.matrix,c.rotate.matrix,g,this.view.renderCoordsHelper.worldUpAtPosition(b.eye,l.sv3d.get())),c.rotate.enabled=!0);a=d.tilt*a.rotate;b=K.viewAngle(this.view.renderCoordsHelper,b.center,b.eye);if(b=q.clamp(b+a,z.TiltRange.min,z.TiltRange.max)-b)n.rotate(c.rotate.matrix,c.rotate.matrix,b,f),c.rotate.enabled=!0}_calculateControlTransformationGlobal(a,
b,c){const {eye:f,viewRight:k}=b,d=this._transformation;var h=this.view.navigation.gamepad,g=e.cross(l.sv3d.get(),k,f);e.normalize(g,g);e.negate(g,g);y.panMotionToRotationMatrix(this.startCamera,b,d,a,this.view.camera.heading,this._headingStart,this.view.camera.tilt,c,h);this._tmpCamera.copyFrom(this.currentCamera);this._applyPan(u.pan,this._tmpCamera);h=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.ascend=d.translation[2]*a.ascend;g=-d.heading*a.rotate;0!==g&&(n.rotate(c.rotate.matrix,
c.rotate.matrix,g,this._tmpCamera.eye),c.rotate.enabled=!0);b=this._clampTiltDeltaGlobalToValidRange(d.tilt*a.rotate,b.ray,h);0!==b&&(n.rotate(c.rotate.matrix,c.rotate.matrix,b,this._tmpCamera.viewRight),c.rotate.enabled=!0);c.zoom+=d.zoom*a.zoom}_clampTiltDeltaGlobalToValidRange(a,b,c){const f=I.getReferenceEllipsoid(this.view.spatialReference),k=y.onSurfaceTiltToEyeTiltGlobal(z.TiltRange.min,b.origin,c,f);var d=0;let h=0;d=l.sv3d.get();this.view.renderCoordsHelper.intersectManifold(b,c,d)?(d=K.viewAngle(this.view.renderCoordsHelper,
d,b.origin),d=y.onSurfaceTiltToEyeTiltGlobal(d,b.origin,c,f),h=y.onSurfaceTiltToEyeTiltGlobal(z.TiltRange.max,b.origin,c,f)):(D.closestPointOnSilhouette(D.fromRadius(D.tmpSphere,c+f.radius),b,d),d=Math.PI+O.angle(b.direction,d),d=y.offSurfaceTiltToEyeTiltGlobal(d,b.origin,c,f),h=y.offSurfaceTiltToEyeTiltGlobal(z.TiltRange.max,b.origin,c,f));return q.clamp(d+a,k,h)-d}_getPointAbsoluteSurfaceElevation(a,b,c){const {renderCoordsHelper:f}=this.view,k=f.getAltitude(a);b+=Math.abs(k-b);f.setAltitude(c,
b,a);return b}_clampedDistanceToSurface(a,b){const {renderCoordsHelper:c}=this.view,{camera:f}=this.view.state;var {direction:k}=S.headingTiltToDirectionUp(this.view,b,0,80,U);k=c.intersectManifoldClosestSilhouette(J.wrap(b,k),a,l.sv3d.get());k=e.distance(b,k);a=c.intersectManifoldClosestSilhouette(J.wrap(b,e.direction(l.sv3d.get(),b,f.center)),a,l.sv3d.get());b=e.distance(b,a);return Math.min(k,b)}_computeHeadingRotateRadius(a){const {renderCoordsHelper:b,state:c}=this.view,{camera:f,isGlobal:k}=
c;var d=b.intersectManifoldClosestSilhouette(f.ray,this._filteredSurfaceElevation,l.sv3d.get());if(k){const h=e.subtract(l.sv3d.get(),a,d);d=e.length(h);e.scale(h,h,1/d);a=e.normalize(l.sv3d.get(),a);a=q.acosClamped(e.dot(a,h));return d*Math.sin(Math.min(V,a))}a=e.copy(l.sv3d.get(),a);b.setAltitude(a,this._filteredSurfaceElevation);return e.distance(d,a)}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:5}_computeVelocities(a){var b=this._filteredSurfaceElevation,c=b+
I.getReferenceEllipsoid(this.view.spatialReference).radius;const {camera:f,isGlobal:k}=this.view.state;var d=l.sv3d.get();const h=this._getPointAbsoluteSurfaceElevation(f.eye,b,d);var g=this._clampedDistanceToSurface(b,d);const p=f.width/2,E=.75*f.width,W=.75*f.width;var B=g*Math.tan(.5*f.fovX)/p;c=B/c;d=B/this._computeHeadingRotateRadius(d);B=(k?c:B)*E*a;b=h-b;b=Math.max(this._minimumAscendVelocity()*a,2**(E*a/p)*b-b);g=2**(E*a/p)*g-g;a*=q.clamp(d*W,X,Y);return{pan:B,ascend:b,zoom:g,rotate:a}}_applyDisabledMovementTypes(a){null==
this.disableMovements||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(a.zoom=this.disableMovements.zoom?0:a.zoom,a.ascend=this.disableMovements.ascend?0:a.ascend,a.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&n.identity(a.pan.matrix),a.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&n.identity(a.rotate.matrix))}static activatesFor(a,b){a=t.extractTransformation(b,a.navigation.gamepad,Z);return!("end"===
b.action||t.isZeroTransformation(a))}};C.__decorate([F.property({constructOnly:!0})],v.GamepadKeyboardController.prototype,"gamepadDevice",void 0);C.__decorate([F.property({constructOnly:!0})],v.GamepadKeyboardController.prototype,"disableMovements",void 0);v.GamepadKeyboardController=C.__decorate([N.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],v.GamepadKeyboardController);const Z={translation:[0,0,0],heading:0,tilt:0,zoom:0},V=q.deg2rad(80),X=q.deg2rad(30),Y=q.deg2rad(80),
u={zoom:0,ascend:0,pan:{enabled:!1,matrix:G.create()},rotate:{enabled:!1,matrix:G.create()}},m=H.create(),A=H.create(),U=T.createDirectionUp();Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});