// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/mathUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../core/libs/gl-matrix-2/math/vec2 ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../camera/constraintUtils ../../camera/constraintUtils/ConstraintOptions ../../camera/constraintUtils/ConstraintTypes ../../camera/constraintUtils/InteractionType ../../camera/constraintUtils/TiltMode ../../layers/VoxelWasm ../Constraints ./InteractiveController ../utils/navigationUtils".split(" "),
function(c,t,u,B,C,K,L,M,D,v,E,F,w,d,k,G,H,I,p,q,x,y,z,J,g){c.PivotPoint=void 0;(function(a){a[a.CENTER=0]="CENTER";a[a.EYE=1]="EYE"})(c.PivotPoint||(c.PivotPoint={}));c.RotateController=class extends J.InteractiveController{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(a){super(a);this.pivot=c.PivotPoint.CENTER;this._rotScale=0;this._lastPoint=w.create();this._tmpWorldUp=k.create();this._tmpViewDir=k.create();this._tmpRotCurPoint=w.create();this._tmpTransf=E.create();
this._tmpAxis=k.create();this._tmpPivotPoint=k.create();this._pivotPos=k.create();this._constraintOptions=new I.ConstraintOptions(p.ConstraintTypes.ALL,q.InteractionType.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===c.PivotPoint.CENTER?3:1.5}begin(a){if(this.active){switch(this.pivot){case c.PivotPoint.EYE:d.copy(this._pivotPos,this.startCamera.eye);this._constraintOptions.interactionType=q.InteractionType.LOOK_AROUND;this._constraintOptions.tiltMode=x.TiltMode.LOOK_AROUND;this._constraintOptions.selection=
p.ConstraintTypes.NONE;break;case c.PivotPoint.CENTER:const e=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?g.contentIntersectorOptions:{});e||d.copy(this._pivotPos,this.startCamera.center);this._constrainPivotPoint(a,e);this.startCamera.center=this._pivotPos;this._constraintOptions.interactionType=q.InteractionType.TUMBLE;this._constraintOptions.tiltMode=x.TiltMode.TUMBLE;this._constraintOptions.selection=p.ConstraintTypes.ALL&
~p.ConstraintTypes.DISTANCE}g.normalizeCoordinate(this.startCamera,a,this._lastPoint)}}_constrainPivotPoint(a,e){const b=this.startCamera,h=k.create();d.subtract(h,this._pivotPos,b.eye);const m=d.length(h);var f=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(b.eye,A);f=Math.max(Math.min(g.rotatePivotDistanceModifier,1/Math.abs(d.dot(A,b.viewForward)))*f,g.rotatePivotMinDistanceModifier);e&&(f=Math.min(m,f));var n=G.getReferenceEllipsoid(this.view.spatialReference),
l=B.createScreenPointArray(b.width/b.pixelRatio*.5,b.height/b.pixelRatio*.5);n=g.decideNavigationMode(this.startCamera,l,n);l=this.view._stage.renderView.getMinimalDepthForArea(y.getVoxelWasm(this.view),b.fullWidth/b.pixelRatio*.5,b.fullHeight/b.pixelRatio*.5,b,2.5*g.rotateScreenPixelArea,g.rotateScreenPixelArea);a=this.view._stage.renderView.getMinimalDepthForArea(y.getVoxelWasm(this.view),a[0],a[1],b,g.rotateScreenPixelArea);if(null!=l||null!=a)l=l??a??0,a=null==a||n===g.NavigationMode.Horizontal?
l:a,f=l>a?a:l,f=e?Math.min(f,m):f;d.normalize(h,h);d.copy(this._pivotPos,d.add(this._tmpPivotPoint,b.eye,d.scale(this._tmpPivotPoint,h,f)))}update(a){if(this.active){switch(this.pivot){case c.PivotPoint.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,a,this.currentCamera.center,this._pivotPos);break;case c.PivotPoint.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,a,this.currentCamera.eye,this._pivotPos)}H.applyAll(this.view,
this.currentCamera,this._constraintOptions);this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(a,e,b,h){this.view.renderCoordsHelper.worldUpAtPosition(h,this._tmpWorldUp);g.normalizeCoordinate(a,e,this._tmpRotCurPoint);e=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale;let m=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;d.subtract(this._tmpViewDir,b,h);b=d.length(this._tmpViewDir);b=u.acosClamped(d.dot(this._tmpViewDir,this._tmpWorldUp)/b);if(this.pivot===
c.PivotPoint.EYE){const f=.5*Math.PI-b,n=.495*Math.PI;e=f-Math.max(-n,Math.min(n,f+-.5*e))}e=u.clamp(e+b,z.TiltRange.min,z.TiltRange.max)-b;d.cross(this._tmpAxis,a.up,this._tmpViewDir);this.pivot===c.PivotPoint.CENTER&&(m=-m);v.fromRotation(this._tmpTransf,m,this._tmpWorldUp);v.rotate(this._tmpTransf,this._tmpTransf,e,this._tmpAxis);d.transformMat4(this._tmpViewDir,this._tmpViewDir,this._tmpTransf);a.up=d.transformMat4(r,a.up,this._tmpTransf);d.add(r,h,this._tmpViewDir);F.copy(this._lastPoint,this._tmpRotCurPoint);
return r}};t.__decorate([C.property()],c.RotateController.prototype,"pivot",void 0);c.RotateController=t.__decorate([D.subclass("esri.views.3d.state.controllers.RotateController")],c.RotateController);const r=k.create(),A=k.create();Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});