// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/PooledArray ../../../../core/screenUtils ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/ray ../../../../geometry/support/vectorStacks ../../../ViewingMode ../../support/hitTest ../../support/geometryUtils/ray ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/intersectorUtils".split(" "),function(B,J,x,y,K,u,L,t,
M,D,E,w,n,C){function F(a){z&&z.viewingMode===a||(z=w.newIntersector(a));return z}class N{constructor(a,b,c){this.viewingMode=a;this._forEachLayer=b;this._view=c;this._externalIntersectionHandlers=new J;this._tolerance=w.defaultTolerance;this._tmpRay=L.create();this._tmpRegion=u.create();this._validateHUDIntersector=w.newIntersector(this.viewingMode);this._validateHUDIntersector.options.hud=!1}intersectScreen(a,b,c){return this.intersectRay(this._getPickRay(a,this._tmpRay),F(this.viewingMode),b,c)}intersectScreenFreePointFallback(a,
b,c){return this.intersectRayFreePointFallback(this._getPickRay(a,this._tmpRay),b,c)}intersectRayFreePointFallback(a,b,c){return this.intersectRay(a,F(this.viewingMode),b,c)||this._intersectRayFreePointLocal(a,b)}intersectRay(a,b,c,f){b.options.selectionMode=!1;b.options.store=n.StoreResults.MIN;this.computeIntersection(a,b,f);return b.results.min?b.results.min.getIntersectionPoint(c):!1}getCenterRayWithSubpixelOffset(a,b,c=.5,f=.5){a.getRenderCenter(v,c,f);v[0]+=.0466;v[1]-=.0123;return E.fromRenderAtEye(a,
v,b)}intersectIntersectorScreen(a,b,c){this.computeIntersection(this._getPickRay(a,this._tmpRay),b,c)}intersectToolIntersectorScreen(a,b,c){a=this._getPickRay(a,this._tmpRay);this.intersectToolIntersectorRay(a,b,c)}intersectToolIntersectorRay(a,b,c){b.options.selectionMode=!0;this.computeIntersection(a,b,c);const f=b.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||C.isValidIntersectorResult(f)&&f.intersector!==n.IntersectorType.TERRAIN||(b.options.selectionMode=!1,this.computeIntersection(a,
b,c))}setTolerance(a=w.defaultTolerance){this._tolerance=a}addIntersectionHandler(a){this._externalIntersectionHandlers.push(a);this._externalIntersectionHandlers.sort((b,c)=>b.type===n.IntersectorType.TERRAIN?1:c.type===n.IntersectorType.TERRAIN?-1:0)}removeIntersectionHandler(a){null!=this._externalIntersectionHandlers.removeUnordered(a)&&this._externalIntersectionHandlers.sort((b,c)=>b.type===n.IntersectorType.TERRAIN?1:c.type===n.IntersectorType.TERRAIN?-1:0)}_getPickRay(a,b){return E.fromScreen(this._view.state.camera,
a,b)}_intersectRayFreePointLocal(a,b){if(this.viewingMode!==M.ViewingMode.Local||null==a)return!1;y.add(b,a.origin,y.normalize(t.sv3d.get(),a.direction));return!1}intersectElevationFromScreen(a,b,c=0,f=null){return this._intersectElevation(this._getPickRay(a,this._tmpRay),b,c,f)}_intersectElevation(a,b,c=0,f=null){if(null==a)return null;var e=null!=b?b.mode:"absolute-height",l=b?.offset??0,g="on-the-ground"!==e?l+c:0;b=g/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===e)return this._view.renderCoordsHelper.intersectInfiniteManifold(a,
g,A)?(c=D.computeMapPointFromVec3d(this._view,A),c.z??(c.z=0),c.z-=l,c):null;l=this._view.state.camera;const m=x.castRenderScreenPointArray3(t.sv3d.get());l.projectToRenderScreen(a.origin,m);g=new G(null,this._forEachLayer);const q=this._view.slicePlane,p=null!=q?C.sliceFilterPredicate(q):null,h=w.newIntersector(this.viewingMode);h.options.store=n.StoreResults.MIN;h.options.verticalOffset=b;b=a.origin;a=y.add(t.sv3d.get(),b,a.direction);h.reset(b,a,l);h.point=m;const k=f?"type"in f&&"graphics"===
f.type?d=>d.layerUid!==f.uid:d=>d.graphicUid!==f.uid:null;switch(e){case "relative-to-scene":h.intersect(g.layers,m,this._tolerance,null,d=>(!k||k(d))&&!!d.lastValidElevationBB);this._externalIntersectionHandlers.forAll(d=>{d.type!==n.IntersectorType.I3S&&d.type!==n.IntersectorType.TERRAIN&&d.type!==n.IntersectorType.TILES3D||d.intersect(h,d.slicePlaneEnabled?p:null,h.rayBegin,h.rayEnd,m)});break;case "on-the-ground":case "relative-to-ground":this._externalIntersectionHandlers.forAll(d=>{d.isGround&&
d.intersect(h,d.slicePlaneEnabled?p:null,h.rayBegin,h.rayEnd,m)})}return h.results.min.getIntersectionPoint(A)?(e=D.computeMapPointFromVec3d(this._view,A),e.z=c,e):null}computeIntersection(a,b,c,f){if(null!=a){var e=this._view.state.camera,l=x.castRenderScreenPointArray3(t.sv3d.get());e.projectToRenderScreen(a.origin,l);var g=new G(c,this._forEachLayer);b.options.selectOpaqueTerrainOnly=!c||!("include"in c||"exclude"in c);var m=a.origin,q=y.add(t.sv3d.get(),a.origin,a.direction);b.reset(m,q,e);b.intersect(g.layers,
l,this._tolerance);a=this._view.slicePlane;var p=null!=a?C.sliceFilterPredicate(a):null;b.intersect(g.sliceableLayers,l,this._tolerance,p);var h=c&&(c.requiresGroundFeedback||c.enableDraped);this._externalIntersectionHandlers.forAll(k=>{var d=k.layerUid;const r=Array.isArray(d);d=r?d:[d];r&&(b.options.filteredLayerUids=[]);let H=!1;for(const I of d)g.filterLayerUid(I)?H=!0:r&&b.options.filteredLayerUids.push(I);b.options.isFiltered=!H;(k.isGround&&h||!b.options.isFiltered)&&k.intersect(b,k.slicePlaneEnabled?
p:null,m,q,l,f)});a=t.sv3d.get();e=this._view.basemapTerrain;if(c&&c.enableDraped&&null!=e.spatialReference&&b.results.ground.getIntersectionPoint(a)){c=e.overlayManager.renderer;const k=this._view.renderCoordsHelper.spatialReference,d=t.sv3d.get();this._view.renderCoordsHelper.fromRenderCoords(a,d,e.spatialReference);d[2]=this._view.elevationProvider?.getElevation(a[0],a[1],a[2],k,"ground")??0;c.intersect(b,d,b.results.ground,r=>g.filterRenderGeometry(r))}b.sortResults();this._processHUDResults(b)}}_processHUDResults(a){var b=
a.results.hud;u.copy(this._tmpRegion,u.negativeInfinity);const c=this._view.state.camera,f=[],e=this._tmpRegion;var l=k=>{const d=new O(k);c.projectToRenderScreen(k.target.center,d.screenPoint);d.screenPoint[0]=Math.floor(d.screenPoint[0]);d.screenPoint[1]=Math.floor(d.screenPoint[1]);f.push(d);u.expandPointInPlace(e,d.screenPoint)};a.sortResults(b.all);null!=b.min.dist&&l(b.min);for(var g of b.all)b.min.target.object!==g.target.object&&b.max.target.object!==g.target.object&&l(g);null!=b.max.dist&&
b.max.target.object!==b.min.target.object&&l(b.max);if(f.length){e[0]===e[2]&&(e[2]+=1);e[1]===e[3]&&(e[3]+=1);b=c.fullWidth;l=c.fullHeight;var m=Math.max(0,e[0]-1),q=Math.max(0,e[1]-1);g=Math.min(u.width(e)+2,b-m);var p=Math.min(u.height(e)+2,l-q);if(!(0>=g||0>=p)){var h=new Uint8Array(g*p*4);this._view._stage.renderer.readHUDVisibility(m,q,g,p,h);m=!0;q=null==a.results.max.dist;p=0;for(const k of f)for(const d of P){const r=4*(Math.min(k.screenPoint[0]+d[0],b)-e[0]+(Math.min(k.screenPoint[1]+d[1],
l)-e[1])*g);if(!(0>r||r>=h.length)&&h[r]){m&&(a.results.min.copy(k.result),m=!1);q&&a.results.max.copy(k.result);a.options.store===n.StoreResults.ALL&&a.results.all.splice(p++,0,k.result);break}}}}}}const P=(()=>{const a=[];for(let b=-1;1>=b;b++)for(let c=-1;1>=c;c++)a.push([c+1,b+1]);return a})();class O{constructor(a){this.result=a;this.screenPoint=x.createRenderScreenPointArray3()}}let z;class G{constructor(a,b){this.layers=[];this.sliceableLayers=[];this.include=a?.include;this.exclude=a?.exclude;
b(c=>{c.pickable&&this.filterLayerUid(c.apiLayerUid)&&(c.sliceable?this.sliceableLayers:this.layers).push(c)})}filterLayerUid(a){const {include:b,exclude:c}=this;return null==a?null==b&&null==c:(null==b||b.has(a))&&(null==c||!c.has(a))}filterRenderGeometry(a){return this.filterLayerUid(a.layerUid)}}const A=K.create(),v=x.createRenderScreenPointArray3();B.SceneIntersectionHelper=N;B.isIntersectionHandler=function(a){return"object"===typeof a&&"intersect"in a};Object.defineProperty(B,Symbol.toStringTag,
{value:"Module"})});