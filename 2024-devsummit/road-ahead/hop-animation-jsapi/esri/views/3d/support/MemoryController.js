// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Logger ../../../core/MemCache ../../../core/scheduling ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ./MemoryManagedView".split(" "),function(k,c,n,p,m,q,d,u,v,r,t){let b=class extends n{constructor(a){super(a);this._quality=1;this._usedMemory=0;this._updating=!1;this._downscaleMemoryUsed=this._stableQuality=0;this._canFastRecover=
!1;this._memoryPredicted=0;this._cacheStorage=new m.MemCacheStorage;this._warnMemoryUsage=null;this._numQualityChanges=0;this._maxMemory=750;this._additionalCacheMemory=0;this.addHandles(q.addFrameTask({prepare:()=>this._updateMemory()}))}destroy(){this._cacheStorage.destroy()}get maxMemory(){return this._maxMemory}set maxMemory(a){null==a||0>=a||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<a&&this._updateQuality(1),this._maxMemory=a)}get additionalCacheMemory(){return this._additionalCacheMemory}set additionalCacheMemory(a){null!=
a&&(this._additionalCacheMemory=a)}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}get usedCacheMemory(){return this._cacheStorage.size}newCache(a,e){return new m.MemCache(a,this._cacheStorage,e)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(!(0>=this._memoryPredicted)||this._updating){var a=this._layersUpdating();if(.6>this._memoryPredicted&&this._canFastRecover)this._stableQuality=
this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._updateQuality(1);else if(a){if(1.1<this._memoryPredicted||1<this._usedMemory)0<this._stableQuality?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):.1<this._quality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)}else this._downscaleMemoryUsed=0,1<this._usedMemory?(this._stableQuality=0,this._canFastRecover=!1,a=this._updateQuality(this._quality/
1.3),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(.75>this._usedMemory&&1>this._quality?(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.05)):1>this._quality&&(this._canFastRecover=!0));this._updating=a}}_updateQuality(a){a=Math.min(Math.max(a,.1),1);if(a===this._quality)return!1;this._quality=a;++this._numQualityChanges;return!0}_layersUpdating(){return this.view.allLayerViews.some(a=>!!a.updating)}_updateMemory(){if(this.view){this.view._stage?.renderer?.tick();
var a=this.view._stage?.renderer?.usedMemory,e=(this.view.basemapTerrain?.usedMemory??0)+(a?a.fbos+a.edges+a.plugins:0),l=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(f=>{if(t.isMemoryManagedView(f)){const h=f.ignoresMemoryFactor?this._quality:1;e+=f.usedMemory*h;l+=f.unloadedMemory*h}});var g=null==this._warnMemoryUsage||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage);a=1048576*this.maxMemory;if(e>a&&g){this._warnMemoryUsage=e;g=h=>(h/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+
" MB";const f=Math.round(100*this._quality);p.getLogger(this).warn(`Memory Limit exceeded! Limit: ${g(a)} Current: ${g(e)} Projected: ${g(e+l)} Quality: ${f}%`)}this._usedMemory=e/a;this._memoryPredicted=(e+l)/a;this._cacheStorage.maxSize=Math.max(0,a-e+1048576*this.additionalCacheMemory)}}get test(){const a=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=a._numQualityChanges;a._numQualityChanges=0;return e},disableMemCache:()=>a.disableMemCache()}}};c.__decorate([d.property({constructOnly:!0})],
b.prototype,"view",void 0);c.__decorate([d.property()],b.prototype,"maxMemory",null);c.__decorate([d.property()],b.prototype,"additionalCacheMemory",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"memoryFactor",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"updating",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"usedMemory",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"usedCacheMemory",null);c.__decorate([d.property()],b.prototype,"_quality",void 0);
c.__decorate([d.property()],b.prototype,"_usedMemory",void 0);c.__decorate([d.property()],b.prototype,"_updating",void 0);c.__decorate([d.property()],b.prototype,"_stableQuality",void 0);c.__decorate([d.property()],b.prototype,"_maxMemory",void 0);c.__decorate([d.property()],b.prototype,"_additionalCacheMemory",void 0);b=c.__decorate([r.subclass("esri.views.3d.support.MemoryController")],b);k.minQuality=.1;k.newMemoryController=function(a){return new b({view:a})};Object.defineProperty(k,Symbol.toStringTag,
{value:"Module"})});