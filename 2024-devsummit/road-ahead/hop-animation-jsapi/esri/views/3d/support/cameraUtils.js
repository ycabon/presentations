// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../core/Cyclical ../../../core/Logger ../../../core/mathUtils ../../../core/promiseUtils ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/ellipsoidUtils ../../../geometry/Point ../../../geometry/projection ../../../geometry/SpatialReference ../../../geometry/projection/projectPointToVector ../../../geometry/projection/projectVectorToPoint ../../../geometry/projection/projectVectorToVector ../../ViewingMode ../camera/intersectionUtils ../../../chunks/cameraUtilsPlanar ../../../chunks/cameraUtilsSpherical ./earthUtils ./ElevationProvider ../../support/spatialReferenceSupport".split(" "),
function(k,z,H,ba,x,n,t,q,ca,m,A,B,C,u,D,E,da,I,J,ea,K,fa){function r(a){return a.spatialReference??B.WGS84}function p(a){return"global"===a.viewingMode?J.cameraUtilsSpherical:I.cameraUtilsPlanar}function L(a,b,c){const d=a.state.camera,e=d.width/2/d.pixelRatio;a.renderCoordsHelper.viewingMode===E.ViewingMode.Global&&null!=c&&(b*=Math.cos(x.deg2rad(c)));b/=a.renderCoordsHelper.unitInMeters;return e/(96*39.37/b)/Math.tan(d.fovX/2)}function M(a,b,c){const d=a.state.camera;b=96*39.37/(d.width/2/d.pixelRatio/
(b*Math.tan(d.fovX/2)));a.renderCoordsHelper.viewingMode===E.ViewingMode.Global&&null!=c&&(b/=Math.cos(x.deg2rad(c)));return b*a.renderCoordsHelper.unitInMeters}async function N(a,b,c,d,e,f){b=await F(a,d.heading,d.tilt,b,c,e,f);n.throwIfAborted(f);return O(a,b,d.fov,f)}function P(a,b,c,d,e){return p(a).directionToHeadingTilt(b,c,d,e)}function Q(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,y,a.spatialReference)&&a.elevationProvider&&(K.getElevationAtPoint(a.elevationProvider,
y)??0)>y[2]-1)}async function ha(a,b,c){if(Q(a,b))return!0;const {elevationProvider:d,spatialReference:e,renderCoordsHelper:f}=a;if(null==d||!f.fromRenderCoords(b,y,e))return!1;const [g,h,l]=y;a=await d.queryElevation(g,h,l,e,"ground",c)??0;n.throwIfAborted(c);return a>l-1}async function ia(a,b,c){const d=q.create();if(null==b)return t.copy(d,a.state.camera.center);if(b instanceof m){const {renderSpatialReference:e,basemapTerrain:f,elevationProvider:g}=a,h=b.spatialReference;await C.projectPointToVectorAsync(b,
d,e,0,{signal:c});n.throwIfAborted(c);null==b.z&&null!=f&&null!=g&&(b=await g.queryElevation(b.x,b.y,b.z??0,h,"ground",c),n.throwIfAborted(c),null!=b&&a.renderCoordsHelper.setAltitude(d,b));return d}return t.copy(d,b)}function ja(a,b){const c=q.create();if(null==b)return t.copy(c,a.state.camera.center);if(b instanceof m){if(!C.projectPointToVector(b,c,a.renderSpatialReference))return null;const {basemapTerrain:d,elevationProvider:e}=a;null==b.z&&null!=d&&null!=e&&(b=K.getElevationAtPoint(e,b),null!=
b&&a.renderCoordsHelper.setAltitude(c,b));return c}return t.copy(c,b)}function G(a,b,c,d,e,f){const g=d instanceof m?d:null;d=ja(a,d);return R(a,b,c,g,d,e,f)}async function F(a,b,c,d,e,f,g){const h=d instanceof m?d:null;d=await ia(a,d,g);n.throwIfAborted(g);return S(a,b,c,h,d,e,f,g)}function R(a,b,c,d,e,f,g){if(null==e||!d&&(d=new m({spatialReference:r(a)}),!u.projectVectorToPoint(e,a.renderSpatialReference,d)))return null;const h=T(a,b,c,e,f,g);if(U(a,c,g)&&Q(a,h.eye)){const {tilt:l,mode:v}=V(a,
c,e,f);return R(a,b,l,d,e,f,v)}return{...h,center:q.clone(e)}}async function S(a,b,c,d,e,f,g,h){d||(d=new m({spatialReference:r(a)}),await u.projectVectorToPointAsync(e,a.renderSpatialReference,d,{signal:h})||(d=null));n.throwIfAborted(h);const l=T(a,b,c,e,f,g);if(U(a,c,g)&&await ha(a,l.eye,h)){n.throwIfAborted(h);const {tilt:v,mode:ka}=V(a,c,e,f);return S(a,b,v,d,e,f,ka,h)}return{...l,center:q.clone(e)}}function T(a,b,c,d,e,f){e=Math.max(e,a.state.constraints.minimumPoiDistance);var g=c;c=e;var h=
0;if(f=f===k.OrientationMode.ADJUST){{const v=a.pointsOfInterest.centerOnSurfaceFrequent.distance;if(8<Math.log(c/v)/Math.LN2)f=!0;else{h=a.renderSpatialReference;var l=r(a);f=new m({spatialReference:l});u.projectVectorToPoint(d,h,f)?(l=new m({spatialReference:l}),u.projectVectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,h,l)?(h=Math.tan(.5*a.state.camera.fov)*v,f=5<l.distance(f)/h):f=!1):f=!1}}}f?(b=0,g=p(a).eyeTiltToLookAtTilt(g,d,c),a.state.constraints.tilt?(f=a.state.constraints.tilt(c),
f.max=Math.min(f.max,.5*Math.PI),h=Math.min(g,f.min*(1-.7)+.7*f.max)):h=g):h=p(a).eyeTiltToLookAtTilt(g,d,c);g=h=a.state.constraints.clampTilt(c,h);c=g=p(a).lookAtTiltToEyeTilt(g,d,c);a=p(a).eyeForCenterWithHeadingTilt;return a(d,e,b,c)}function U(a,b,c){const d=a.map.ground.navigationConstraint;return c===k.OrientationMode.ADJUST&&"global"===a.viewingMode&&0<b&&(null==d||"stay-above"===d.type)}function V(a,b,c,d){{let f=p(a).eyeTiltToLookAtTilt(b,c,d);if(a.state.constraints.tilt){var e=a.state.constraints.tilt(d);
f=Math.min(f,.5*Math.PI);e=e.min*(1-.7)+.7*f}else e=f}a=p(a).lookAtTiltToEyeTilt(e,c,d);return{tilt:a,mode:1>b-a?k.OrientationMode.LOCKED:k.OrientationMode.ADJUST}}function W(a,b){const {state:c,spatialReference:d}=a;a=b.spatialReference;return c.isGlobal&&fa.isSpatialReferenceSupported(a,E.ViewingMode.Global)||c.isLocal&&d.equals(a)}function X(a,b){let c;if(a.state.isGlobal){const f=new m(b.xmin,b.ymin,b.spatialReference),g=new m(b.xmax,b.ymax,b.spatialReference),h=b.spatialReference.isGeographic?
la:ma;var d=new m({x:h.center(f.x,g.x),y:(g.y+f.y)/2,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:b.spatialReference});const l=ca.getReferenceEllipsoid(b.spatialReference);var e=ea.getGreatCircleSpanAt(d,f,g);c=e.lon;e=e.lat;h.diff(f.x,g.x)>h.range/2&&(c+=l.halfCircumference);c=Math.min(c,l.halfCircumference);e=Math.min(e,l.halfCircumference)}else d=a.renderSpatialReference??b.spatialReference,d.equals(b.spatialReference)||(b=A.project(b,d)),c=b.xmax-b.xmin,e=b.ymax-b.ymin,
d=new m({x:b.xmin+.5*c,y:b.ymin+.5*e,z:null!=b.zmax&&null!=b.zmin?(b.zmax+b.zmin)/2:void 0,spatialReference:d});a=a.state.camera;return{center:d,distance:Math.max(1/Math.tan(a.fovX/2)*c*.5,1/Math.tan(a.fovY/2)*e*.5,1/Math.tan(a.fov/2)*(null!=b.zmax&&null!=b.zmin?b.zmax-b.zmin:0)*.5)/1}}function Y(a,b,c,d){if(null==b)return null;const e=a.renderSpatialReference;a=new m({spatialReference:r(a)});if(!u.projectVectorToPoint(b.eye,e,a))return null;d??=new z;d.position=a;d.heading=b.heading;d.tilt=b.tilt;
d.fov=c;return d}async function O(a,b,c,d){const e=a.renderSpatialReference;a=new m({spatialReference:r(a)});await u.projectVectorToPointAsync(b.eye,e,a,{signal:d});n.throwIfAborted(d);return new z(a,b.heading,b.tilt,c)}const Z=()=>ba.getLogger("esri.views.3d.support.cameraUtils"),aa=q.create(),na={heading:0,tilt:0},y=q.create(),ma=new H.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),la=new H.Cyclical(-180,180);k.OrientationMode=void 0;(function(a){a[a.LOCKED=0]="LOCKED";a[a.ADJUST=1]="ADJUST"})(k.OrientationMode||
(k.OrientationMode={}));const w=q.create();k.computeScale=function(a,b){D.projectVectorToVector(b.center,a.renderSpatialReference,aa,B.WGS84);return M(a,b.distance,aa[1])};k.directionToHeadingTilt=P;k.distanceToScale=M;k.externalToInternal=function(a,b){if(null==b)return null;var c=a.renderSpatialReference;const d=p(a).headingTiltToDirectionUp,e=q.create();if(!C.projectPointToVector(b.position,e,c))return null;c=d(e,b.heading,b.tilt);t.scale(c.direction,c.direction,a.state.camera.distance);t.add(c.direction,
c.direction,e);a=da.cameraOnContentAlongViewDirection(a,e,c.direction,c.up);a.fov=x.deg2rad(b.fov);a.row=b.layout.row;a.rows=b.layout.rows;a.column=b.layout.column;a.columns=b.layout.columns;return a};k.fromCenterDistanceAsync=N;k.fromCenterDistanceSync=function(a,b,c,d,e,f){b=G(a,d.heading,d.tilt,b,c,e);return Y(a,b,d.fov,f)};k.fromCenterScale=async function(a,b,c,d,e,f){c=L(a,c,b.latitude);return N(a,b,c,d,e,f)};k.fromExtentAsync=async function(a,b,c,d,e,f){b=W(a,b)?b:await A.projectWithZConversion(b,
a.spatialReference,{signal:f});n.throwIfAborted(f);const {center:g,distance:h}=X(a,b);c=await F(a,c,d,g,h,e,f);n.throwIfAborted(f);return O(a,c,a.camera.fov,f)};k.fromExtentSync=function(a,b,c,d,e,f){let g;try{g=W(a,b)?b:A.project(b,a.spatialReference)}catch(v){return null}const {center:h,distance:l}=X(a,g);b=G(a,c,d,h,l,e);return null==b?null:Y(a,b,a.camera.fov,f)};k.getObserverForPointAtDistanceAsync=F;k.getObserverForPointAtDistanceSync=G;k.getViewSR=r;k.headingTiltToDirectionUp=function(a,b,c,
d,e){return p(a).headingTiltToDirectionUp(b,c,d,e)};k.internalToExternal=function(a,b,c){const d=a.renderSpatialReference,e=P(a,b.eye,b.viewForward,b.up,na);a=r(a);D.projectVectorToVector(b.eye,d,w,a)||(a=B.WGS84,D.projectVectorToVector(b.eye,d,w,a));null==c?c=new z(new m(w,a),e.heading,e.tilt,x.rad2deg(b.fov)):(c.position.x=w[0],c.position.y=w[1],c.position.z=w[2],c.position.spatialReference=a,c.heading=e.heading,c.tilt=e.tilt,c.fov=x.rad2deg(b.fov));c.layout.row=b.row;c.layout.rows=b.rows;c.layout.column=
b.column;c.layout.columns=b.columns;return c};k.scaleToDistance=L;k.scaleToZoom=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.levelAtScale(b);Z().error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};k.toExtent=function(a,b,c){var d=a.renderSpatialReference;const e=new m({spatialReference:r(a)});if(!u.projectVectorToPoint(c,d,e))return null;const f=Math.tan(b.fovX/2);d=Math.tan(b.fovY/2);b=t.dist(b.eye,c);c=2*b*f;d*=2*b;return"global"===a.viewingMode?J.toExtent(a,
e,c,d):I.toExtent(a,e,c,d)};k.zoomToScale=function(a,b){if(a=a.basemapTerrain?.tilingScheme)return a.scaleAtLevel(b);Z().error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});