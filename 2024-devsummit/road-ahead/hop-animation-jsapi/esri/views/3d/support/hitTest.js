// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../geometry ../../../Graphic ../../../core/iteratorUtils ../../../core/screenUtils ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../geometry/projection/projectVectorToVector ../../../layers/LayerConstants ../../../layers/support/layerUtils ./debugFlags ./ElevationProvider ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/intersectorUtilsConversions ../webgl-engine/lib/verticalOffsetUtils ../../../geometry/SpatialReference ../../../geometry/Point".split(" "),
function(l,Q,H,I,A,J,B,K,C,L,M,D,r,N,t,x,E,O){function p(a,b,c){return b.getIntersectionPoint(m)?(c=F(a,m,c),b.intersector===r.IntersectorType.TERRAIN&&a.basemapTerrain&&(c.z=M.getElevationAtPoint(a.basemapTerrain,c)??0),c):null}function u(a){var b=a.sourceLayer,c=a.layer;if(b=b&&"objectIdField"in b?b:c&&"objectIdField"in c?c:b)if(c=b.objectIdField??K.fallbackObjectIDAttribute,c=a.attributes?.[c])return`o-${b.id}-${c}`;return`u-${a.uid}`}function G(a,b){b=u(b);return null==a||(null==a.include||a.include.has(b))&&
(null==a.exclude||!a.exclude.has(b))}function F(a,b,c){let d=a.spatialReference||E.WGS84;B.projectVectorToVector(b,a.renderSpatialReference,m,d)?b=m:(d=E.WGS84,B.projectVectorToVector(b,a.renderSpatialReference,m,d)&&(b=m));c?(c.x=b[0],c.y=b[1],c.z=b[2],c.spatialReference=d):c=new O(b,d);return c}function y(a,b){const c=z(a,b.include,v.INCLUDE);a=z(a,b.exclude,v.EXCLUDE);return{include:c.layerUids,exclude:a.layerUids,graphics:{include:c.graphicUids,exclude:a.graphicUids}}}function z(a,b,c,d={layerUids:void 0,
graphicUids:void 0}){if(!b)return d;if(b instanceof H){var e=u(b);d.graphicUids||(d.graphicUids=new Set);d.graphicUids.add(e);c===v.INCLUDE&&(null!=a.graphicsView&&b.layer===a?q(d,a.graphicsView.processor.layer.id):b.layer&&q(d,b.layer.uid))}else if(I.isIterable(b))for(e of b)e===a.graphics&&null!=a.graphicsView?q(d,a.graphicsView.processor.layer.id):e===a.map.ground?q(d,x.terrainId):z(a,e,c,d);else"uid"in b&&q(d,b.uid);return d}function q(a,b){a.layerUids||(a.layerUids=new Set);a.layerUids.add(b)}
const m=J.create();var v;(function(a){a[a.INCLUDE=0]="INCLUDE";a[a.EXCLUDE=1]="EXCLUDE"})(v||={});l.computeMapPointFromVec3d=F;l.externalToInternalIntersectOptions=y;l.getGraphicFilterUid=u;l.hitTest=async function(a,b,c,d){d=c?y(a,c):d;var e=A.createScreenPointArray(b.x,b.y);d.requiresGroundFeedback=!0;d.enableDraped=!0;c=D.newIntersector(a.state.viewingMode);c.options.selectionMode=!0;c.options.store=r.StoreResults.ALL;a.sceneIntersectionHelper.intersectIntersectorScreen(e,c,d);e=c.results.all;
var h=d.graphics;d=[];let g=null;for(let w=0;w<e.length;w++){var k=e[w],f=t.toOwner(k,a);if(null!=f&&(f===a.map.ground||"type"in f&&C.isIntegratedMeshLayer(f.type)))break;f=t.toHit(k,a);if(null!=f){if("graphic"===f.type){null==g&&w!==e.length-1&&(g=new Set);if(null!=g){var n=u(f.graphic);if(g.has(n))continue;g.add(n)}if(!G(h,f.graphic))continue}n=p(a,k);k=k.distanceInRenderSpace;if("media"===f.type){const P=f.element.toSource(n);d.push({...f,mapPoint:n,distance:k,sourcePoint:P})}else d.push({...f,
mapPoint:n,distance:k})}}e=c.results.ground;h=t.toOwner(e,a);h=null!=h&&"type"in h&&C.isIntegratedMeshLayer(h.type)?h:null;a={screenPoint:b,results:d,ground:{mapPoint:p(a,e),distance:N.isValidIntersectorResult(e)?e.distanceInRenderSpace:0,layer:h}};L.debugFlags.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(a.intersector=c);return a};l.intersectResultToMapPoint=p;l.toMap=function(a,b,c,d){d=c?y(a,c):d;const e=null!=d.graphics&&(null!=d.graphics.include||null!=d.graphics.exclude);b=A.screenPointObjectToArray(b);
d.enableDraped=d.include&&!d.include.has(x.terrainId)||d.exclude&&d.exclude.has(x.terrainId);const h=a.sceneIntersectionHelper,g=D.newIntersector(a.state.viewingMode);g.options.selectionMode=!0;g.options.store=e?r.StoreResults.ALL:r.StoreResults.MIN;g.options.hud=!c?.excludeHud;h.intersectIntersectorScreen(b,g,d);if(e){for(const k of g.results.all)if(c=t.toHit(k,a),null==c||"graphic"!==c.type||G(d.graphics,c.graphic))return p(a,k);return null}return p(a,g.results.min)};Object.defineProperty(l,Symbol.toStringTag,
{value:"Module"})});