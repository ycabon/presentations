// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/Point ../../../../geometry/projection/projectBoundingRect ../../../../geometry/support/aaBoundingRect ../debugFlags ../PropertiesPool ./PointOfInterest ../../../support/Yield".split(" "),
function(e,f,l,m,g,F,G,H,q,d,k,r,t,u,v,w,x,y,z){const A=Array;e.CenterOnSurface=class extends y.PointOfInterest{constructor(a){super(a);this._propertiesPool=new x.PropertiesPool({location:t,renderLocation:A},this);this.distance=this._latestSurfaceAltitude=this._currentSurfaceAltitude=0;this.renderLocation=k.create();this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this);this.runTask()}destroy(){this._frameWorker=m.removeMaybe(this._frameWorker);this._propertiesPool=
m.destroyMaybe(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const a=this._propertiesPool.get("location");a.spatialReference=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this.renderLocation,a);return a}updateRenderLocation(){this.updating=!0;this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter();
this._updateRenderLocation();this.updating=!1;return z.Yield}_updateRenderLocation(){const a=B;let b=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,a);var c=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!b&&c&&(b=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,a))&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude);c=C;b&&this._latestSurfaceAltitudeChangesDistanceSignificantly(a,c)&&(d.copy(a,c),this._currentSurfaceAltitude=this._latestSurfaceAltitude);
b?this.distance=d.distance(this._camera.eye,a):(d.scale(a,this._camera.viewForward,this._get("distance")),d.add(a,a,this._camera.eye));d.exactEquals(this._get("renderLocation"),a)||this._set("renderLocation",d.copy(this._propertiesPool.get("renderLocation"),a))}_calculateSurfaceIntersection(a,b){var c=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(c.ray,a,b))return!1;if(this.state.isGlobal){const n=r.getReferenceEllipsoid(this.renderCoordsHelper.spatialReference).radius;a=n+a;
const p=d.squaredLength(c.eye),D=p<a*a,E=d.distance(c.eye,b);D&&E>n/4&&(d.scale(b,c.viewForward,a-Math.sqrt(p)),d.add(b,b,c.eye))}else c=this.surface?.ready?this.surface.extent:null,null!=c&&u.projectBoundingRect(c,this.surface?.spatialReference,h,this.renderCoordsHelper.spatialReference)&&(b[0]=l.clamp(b[0],h[0],h[2]),b[1]=l.clamp(b[1],h[1],h[3]));return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(a,b){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==a)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,
b)){if(w.debugFlags.TESTS_DISABLE_OPTIMIZATIONS)return!0;const c=this._camera.eye;a=d.distance(c,a);b=d.distance(c,b);if(.05<Math.abs(b-a)/a)return!0}return!1}};f.__decorate([g.property({constructOnly:!0})],e.CenterOnSurface.prototype,"scheduler",void 0);f.__decorate([g.property({constructOnly:!0})],e.CenterOnSurface.prototype,"task",void 0);f.__decorate([g.property()],e.CenterOnSurface.prototype,"distance",void 0);f.__decorate([g.property({constructOnly:!0})],e.CenterOnSurface.prototype,"estimateSurfaceAltitudeAtCenter",
void 0);f.__decorate([g.property({readOnly:!0})],e.CenterOnSurface.prototype,"location",null);f.__decorate([g.property({readOnly:!0})],e.CenterOnSurface.prototype,"renderLocation",void 0);f.__decorate([g.property()],e.CenterOnSurface.prototype,"updating",void 0);e.CenterOnSurface=f.__decorate([q.subclass("esri.views.3d.support.CenterOnSurface")],e.CenterOnSurface);const B=k.create(),C=k.create(),h=v.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});