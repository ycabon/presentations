// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(b,d,z,e,f,P,Q,R,A,p,u,v,B,m,C,D,E,r,F,G,H,I,w,J,K,q){b.PointsOfInterest=class extends z{constructor(a){super(a);this.renderPointOfView=u.create();this._pois=[];this._debugCenters=new Map;this._tmpRay=v.create();this._centerRayDirty=!0;this._surfaceAltitudeAtCenter=0;this._surfaceAltitudeAtCenterDirty=!0;this._contentAltitudeAtCenter=0;this._contentAltitudeAtCenterDirty=!0;this._propertiesPool=new C.PropertiesPool({renderPointOfView:L},this)}initialize(){const {state:a,basemapTerrain:c,renderCoordsHelper:g,
map:t}=this.view;this._surfaceIntersector=w.newIntersector(a.viewingMode);this._surfaceIntersector.options.backfacesTerrain=a.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=J.StoreResults.MIN;this._contentIntersector=w.newIntersector(a.viewingMode);var h=()=>this._estimateSurfaceAltitudeAtCenter();const x=this.view.resourceController.scheduler,y=this.view.basemapTerrain?.elevationQueryCache,n={state:a,scheduler:x,surface:c,renderCoordsHelper:g};
this._set("centerOnSurfaceInfrequent",new r.CenterOnSurface({...n,task:q.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnSurfaceFrequent",new r.CenterOnSurface({...n,task:q.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:h}));this._set("centerOnContent",new r.CenterOnSurface({...n,task:q.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",
new E.CameraOnSurface({...n,cache:y,task:q.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:t}));this._set("surfaceGeometryUpdates",new I.SurfaceGeometryUpdates({...n,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new F.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:g}));this._set("surfaceOrigin",new H.StableSurfaceCenter({cache:y,view:this.view}));this._set("focus",new G.Focus({state:a,
scheduler:x,surface:c,renderCoordsHelper:g,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(k,M)=>this._estimateSurfaceIntersectionAtRenderPoint(k,this.view.state.contentCamera,M)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);h=this.view.graphics;this._debugCenters.set(this.centerOnContent,new m.PointGraphics(h,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,
new m.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new m.PointGraphics(h,"red","CenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new m.PointGraphics(h,"blue","CameraOnSurface"));this._debugCenters.set(this.focus,new m.PointGraphics(h,"green","Focus"));this.addHandles([e.watch(()=>a.contentCamera,k=>this._cameraChanged(k),e.sync),e.watch(()=>c.extent,()=>this._updateCenterPointsOfInterest()),e.when(()=>!c.updating,()=>this._updateCenterPointsOfInterest(),
e.sync),e.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),e.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),e.when(()=>B.debugFlags.SHOW_POI,k=>this._setDebug(k),e.initial)]);this._cameraChanged(this.view.state.contentCamera);for(const k of this._pois)k.runTask()}destroy(){this._setDebug(!1);this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&
!this._pois.some(a=>a.updating))}get _centerRay(){this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1);return this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this._centerRay;if(null==a)return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,
this._contentIntersector,l,N)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(l):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this._centerRay;if(null==a)return this._surfaceAltitudeAtCenter;const c=a.origin,g=p.add(l,a.origin,
a.direction);this._surfaceIntersector.resetWithRay(a,this.view.state.contentCamera);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,c,g);this._surfaceIntersector.results.min.getIntersectionPoint(l)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(l));return this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(a,c,g){a=D.fromRenderAtEye(c,a,O);if(null==a)return null;const t=a.origin,h=p.add(l,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,
c);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,h);return this._surfaceIntersector.results.min.getIntersectionPoint(g)?g:null}_cameraChanged(a){this._updateCenterPointsOfInterest();a=a.eye;p.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",p.copy(this._propertiesPool.get("renderPointOfView"),a))}_updateCenterPointsOfInterest(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=
!0;this.centerOnContent.updateRenderLocation()}_setDebug(a){if(a)for(const c of this._pois)this.addHandles(e.watch(()=>c.renderLocation,g=>this._debugCenters.get(c)?.show(g,c.renderCoordsHelper.spatialReference),e.initial),"debug");else this._debugCenters.forEach(c=>c.hide()),this.removeHandles("debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};d.__decorate([f.property()],b.PointsOfInterest.prototype,
"centerOnContent",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"focus",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,
"surfaceOrigin",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0);d.__decorate([f.property({constructOnly:!0})],b.PointsOfInterest.prototype,"view",void 0);d.__decorate([f.property()],b.PointsOfInterest.prototype,"updating",null);b.PointsOfInterest=d.__decorate([A.subclass("esri.views.3d.support.PointsOfInterest")],b.PointsOfInterest);const L=Array,l=u.create(),
O=v.create(),N={exclude:new Set([K.terrainId])};Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});