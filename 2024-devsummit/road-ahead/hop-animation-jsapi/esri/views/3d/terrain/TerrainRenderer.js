// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../Color ../../../core/has ../../../core/maybe ../../../core/MemCachePool ../../../core/ObjectPool ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/buffer/BufferView ../../ViewingMode ./interfaces ./LayerClass ./OverlayContent ./OverlayRenderer ./PatchRenderData ./RenderOrder ./TerrainAttributesCache ./terrainUtils ./TileRenderer ./TileUpdate ./tileUtils ../webgl-engine/collections/Component/ComponentIntersectionData ../webgl-engine/core/shaderLibrary/ShaderOutput ../../../chunks/Terrain.glsl ../webgl-engine/core/shaderLibrary/terrain/TileBlendInput ../webgl-engine/effects/RenderPlugin ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Intersector ../webgl-engine/lib/IntersectorInterfaces ../webgl-engine/lib/Material ../webgl-engine/lib/RenderSlot ../webgl-engine/lib/screenSizePerspectiveUtils ../webgl-engine/lib/VertexAttribute ../webgl-engine/lib/verticalOffsetUtils ../webgl-engine/materials/DrawParameters ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/TerrainTechnique ../webgl-engine/shaders/TerrainTechniqueConfiguration ../../webgl/enums".split(" "),
function(e,q,fa,ha,T,ia,ja,U,t,Ia,Ja,ka,la,H,x,ma,V,na,oa,L,pa,C,W,qa,X,ra,sa,ta,I,M,Y,g,ua,J,N,va,O,wa,xa,K,Z,y,ya,za,aa,ba,ca,Aa,Ba,P){const Q=V.create();e.TransparencyMode=void 0;(function(a){a[a.Opaque=0]="Opaque";a[a.Semitransparent=1]="Semitransparent";a[a.TransparentWithDraped=2]="TransparentWithDraped";a[a.Empty=3]="Empty"})(e.TransparencyMode||(e.TransparencyMode={}));e.TerrainRenderer=class extends N.SyncPrepareRenderPlugin{get _isGlobal(){return this._stage.viewingMode===oa.ViewingMode.Global}get _techniques(){return this._context.techniqueRepository}get _rctx(){return this._context.renderContext.rctx}constructor(a,
b,d,c,k){super({});this._overlayRenderer=a;this._stage=b;this._allTiles=d;this._ellipsoidRadius=c;this.type=K.IntersectorType.TERRAIN;this.isGround=!0;this._tileSize=256;this._techniqueConfiguration=new Ba.TerrainTechniqueConfiguration;this._passParameters=new ua.TerrainPassParameters;this._drawParameters=new ba.DrawParameters;this._renderDataPool=new ja(qa.PatchRenderData);this._visiblePatchesByOrigin=new Map;this._allPatchesByOrigin=new Map;this._patchSortingDirty=this._patchesByOriginDirty=!0;
this._tileIterator=new M.IteratorPreorder;this._transparencyState=e.TransparencyMode.Opaque;this._castShadows=!1;this._tileRenderer=this._emptyTex=null;this._stencilEnabledLayerExtents=[];this._numOriginsRendered=this._numTilesCulled=this._numTilesRendered=0;this.renderOccludedFlags=Z.RenderOccludedFlag.Occlude;this.produces=new Map([[y.RenderSlot.OPAQUE_TERRAIN,()=>this._produces()],[y.RenderSlot.TRANSPARENT_TERRAIN,()=>this._produces()],[y.RenderSlot.OCCLUDED_TERRAIN,()=>this._produces()]]);this._tileTextureCache=
new ia.MemCachePool((n,f)=>k.newCache(n,f),"TileTexture");this.tileGeometryCache=new ra.TerrainAttributesCache(k)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this);this.addHandles(U.watch(()=>this._overlayRenderer.rendersOccludedDraped,a=>{this.renderOccludedFlags=a?W.overlayRenderOccludedFlag:Z.RenderOccludedFlag.Occlude;this.setNeedsRender()},U.sync))}destroy(){this._stage.removeRenderPlugin(this);this._tileTextureCache.destroy();this.tileGeometryCache.destroy()}_produces(){return this.visible&&
!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?N.ConsumesDepth:N.ConsumesNone}set renderingDisabled(a){this._set("renderingDisabled",!!a);this.setDirty()}set visible(a){this._set("visible",!!a);this.setDirty()}set transparency(a){this._transparencyState!==a&&(this._techniqueConfiguration.invisible=a===e.TransparencyMode.TransparentWithDraped||a===e.TransparencyMode.Empty,this._transparencyState=a,this.setNeedsRender())}get transparency(){return this._transparencyState}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(a){this._techniqueConfiguration.tileBorders!==
a&&(this._techniqueConfiguration.tileBorders=a,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(a){this._techniqueConfiguration.visualizeNormals!==a&&(this._techniqueConfiguration.visualizeNormals=a,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(a){this._techniqueConfiguration.backfaceCullingEnabled!==
a&&(this._techniqueConfiguration.backfaceCullingEnabled=a,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(a){this._set("renderOrder",a);this._setSortingDirty()}get layerUid(){return aa.terrainId}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(a){this._techniqueConfiguration.hasSlicePlane!==a&&(this._techniqueConfiguration.hasSlicePlane=a,this.setNeedsRender())}set textureFadingEnabled(a){this._techniqueConfiguration.textureFadingEnabled!==
a&&(this._techniqueConfiguration.textureFadingEnabled=a,this.setNeedsRender())}set pbrMode(a){this._techniqueConfiguration.pbrMode!==a&&(this._techniqueConfiguration.pbrMode=a,this.setNeedsRender())}setDebugScreenSizePerspective(a){this._techniqueConfiguration.screenSizePerspective!==a&&(this._techniqueConfiguration.screenSizePerspective=a,this.setNeedsRender())}setRootTiles(a){this._rootTiles=a;this.setDirty()}setStencilEnabledLayerExtents(a){this._stencilEnabledLayerExtents=a;this._setSortingDirty()}setTileSize(a){this._tileSize=
a;null!=this._tileRenderer&&(this._tileRenderer.tileSize=a);this.setDirty()}_prepareTileForLoading(a){a.renderData||(a.renderData=this._renderDataPool.acquire(),a.renderData.init(a,this._getLocalOriginOfTile(a)))}loadTile(a){this._prepareTileForLoading(a);this.updateTileGeometryState(a);this.updateTileTexture(a,I.TileUpdate.TEXTURE_FADING)}updateTileTexture(a,b){null!=this._tileRenderer&&(this._tileRenderer.updateTileTexture(a,b===I.TileUpdate.TEXTURE_FADING?L.TextureUpdate.FADING:L.TextureUpdate.UNFADED),
this.setNeedsRender(),a.resetPendingUpdate(b))}updateTileGeometryState(a){for(const b of a.layerInfo[pa.LayerClass.ELEVATION])b.pendingUpdates&=~I.TileUpdate.GEOMETRY;a.resetPendingUpdate(I.TileUpdate.GEOMETRY);(a=a.renderData.updateGeometryState())&&this.setDirty();return a}updateGeometryIfNeeded(a){a.isLoaded&&a.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(a){const b=a.renderData;b&&(b.releaseGeometry(),this._renderDataPool.release(b),b.clear(),a.renderData=null,a.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(a){const b=
Math.max(0,7*Math.floor((a.level-3)/7));if(this._isGlobal&&0===b)return x.ZEROS;for(;a.parent&&a.level>b;)a=a.parent;return a.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(a){this._get("wireframe")!==a&&(this._set("wireframe",a),this.setNeedsRender())}setDirty(a=O.RenderRequestType.UPDATE){this._patchesByOriginDirty=!0;this._context.requestRender(a)}_setSortingDirty(a=O.RenderRequestType.UPDATE){this._patchSortingDirty=
!0;this._context.requestRender(a)}setNeedsRender(a=O.RenderRequestType.UPDATE){this._context.requestRender(a)}initializeRenderContext(a){this._context=a;this._tileRenderer=new ta.TileRenderer(this._rctx,this._tileSize,this._techniques,this._tileTextureCache);this.updateTileBackground();this._emptyTex=wa.createEmptyTexture(this._rctx)}uninitializeRenderContext(){this._emptyTex=T.disposeMaybe(this._emptyTex);this._tileRenderer=T.disposeMaybe(this._tileRenderer)}intersect(a,b,d,c){if(!(!this._rootTiles||
a.options.selectOpaqueTerrainOnly&&a.options.selectionMode&&this.transparency!==e.TransparencyMode.Opaque)){var k=Ca,n=Da;H.subtract(k,c,d);H.set(n,1/k[0],1/k[1],1/k[2]);var f=a.results.min,h=a.results.max,u=a.results.ground,v=a.options.store===K.StoreResults.MIN,D=!!a.results.ground.target,r=aa.getVerticalOffsetTerrain(a.verticalOffset),B=a.tolerance,E,R=v&&null!=f.dist?f.dist:Infinity,Ha=z=>{var A=z.renderData;if(A?.vao){var l=A.geometry;V.set(Q,l.boundingBox);var p=A.localOrigin;null!=r&&(r.localOrigin=
p,r.applyToAabb(Q));F[0]=d[0]-p[0];F[1]=d[1]-p[1];F[2]=d[2]-p[2];if(ca.intersectAabbInvDirBefore(Q,F,n,B,R)){var G=(m,w,Ea)=>{m.set(this.type,z,w,Ea,la.IDENTITY);R=v&&null!=f.dist?f.dist:Infinity};A=(m,w)=>{null!=w&&0<=m&&(a.options.backfacesTerrain||0>H.dot(w,k))&&(a.options.invisibleTerrain||!a.options.selectionMode||null==b||b(d,c,m))&&((null==u.dist||m<u.dist)&&G(u,m,w),a.options.isFiltered||(a.options.store===K.StoreResults.ALL&&(null==E?(E=xa.newIntersectorResult(a.ray),G(E,m,w),a.results.all.push(E)):
m<E.dist&&G(E,m,w)),(null==f.dist||m<f.dist)&&G(f,m,w),a.options.store!==K.StoreResults.MIN&&(null==h.dist||m>h.dist)&&G(h,m,w)))};var S=Fa;H.subtract(S,c,p);var {indices:da,indexCount:Ga}=l;l=l.vertexAttributes;p=l.getField(za.VertexAttribute.POSITION,na.BufferViewVec3f);l=new va.Vertices(p.typedBuffer,3,l.stride/4);p=Ga/3;if(!r&&p>Y.componentMinimalSizeForIntersectionData){const m=z.renderData;null==m.intersectionData&&(m.intersectionData=new Y.ComponentIntersectionData(da,0,p,l));m.intersectionData.intersectRay(F,
S,A)}else ca.intersectTriangles(F,S,0,p,da,l,null,r,A)}}},ea=this._rootTiles;null!=ea&&(()=>{const z=this._tileIterator;z.reset(ea);const A=a.options.invisibleTerrain;for(let l=z.next();l;l=z.next())!(l.visible||A&&l.intersectsClippingArea)||null==r&&!l.intersectsRay(d,k,B,R)||D&&this._useStencilForTile(l)?z.skipSubtree():Ha(l)})()}}processScaleRangeQueries(a,b){if(!b.done)for(this._updatePatchGroups();a.updating&&!b.done;){a.prepare();for(const d of this._visiblePatchesByOrigin.values())for(const c of d)null!=
c.renderData?.textureReference&&a.queriesForTile(c);a.process();b.madeProgress()}}prepareTechnique(a){const b=ha("enable-feature:terrain-shadows")&&a.bindParameters.shadowMap.enabled;b!==this._castShadows&&(this._castShadows=b,this._patchesByOriginDirty=!0);if(a.bindParameters.slot===y.RenderSlot.OCCLUDED_TERRAIN){if(0===(a.renderOccludedMask&W.overlayRenderOccludedFlag))return null}else if(a.bindParameters.slot!==(this.transparency===e.TransparencyMode.Opaque?y.RenderSlot.OPAQUE_TERRAIN:y.RenderSlot.TRANSPARENT_TERRAIN))return null;
if(this.transparency===e.TransparencyMode.Empty)return null;switch(a.output){case g.ShaderOutput.Color:return this._techniqueConfiguration.hasScreenSpaceReflections=null!=a.bindParameters.ssr.lastFrameColor,this._techniqueConfiguration.hasCloudsReflections=null!=a.bindParameters.cloudsFade.data,this._techniqueConfiguration.receiveShadows=a.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=null!=a.bindParameters.ssao,this._techniqueConfiguration.overlayMode=this._overlayRenderer.mode,
this._updateTechnique(g.ShaderOutput.Color,a.bindParameters.slot===y.RenderSlot.OCCLUDED_TERRAIN);case g.ShaderOutput.Shadow:case g.ShaderOutput.ShadowExcludeHighlight:if(this._castShadows)return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Shadow,!1);break;case g.ShaderOutput.LinearDepth:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.LinearDepth,
!1);case g.ShaderOutput.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Normal,!1);case g.ShaderOutput.ObjectAndLayerIdColor:return this._updateTechnique(g.ShaderOutput.ObjectAndLayerIdColor,!1);case g.ShaderOutput.Highlight:if(this._overlayRenderer.hasHighlights)return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(g.ShaderOutput.Highlight,
!1)}return null}renderNode(a,b){this._updatePatchGroups();b.useStencil=!1;switch(a.output){case g.ShaderOutput.Color:this._renderMaterialPass(a,b,a.bindParameters.slot===y.RenderSlot.OCCLUDED_TERRAIN?C.OverlayContent.Occluded:C.OverlayContent.Color);break;case g.ShaderOutput.LinearDepth:case g.ShaderOutput.Normal:this._renderAuxiliaryPass(a,b,C.OverlayContent.Color,this._visiblePatchesByOrigin);break;case g.ShaderOutput.Highlight:this._renderAuxiliaryPass(a,b,C.OverlayContent.Highlight,this._visiblePatchesByOrigin);
break;case g.ShaderOutput.Shadow:case g.ShaderOutput.ShadowExcludeHighlight:this._renderAuxiliaryPass(a,b,null,this._allPatchesByOrigin);break;case g.ShaderOutput.ObjectAndLayerIdColor:this._renderAuxiliaryPass(a,b,C.OverlayContent.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(a){if(null!=this._tileRenderer){var b=this._tileRenderer;if(null!=a){a=fa.toUnitRGBA(a);var d=x.fromValues(a[0]||0,a[1]||0,a[2]||0)}b.setBackground(d);this._allTiles.forAll(c=>b.updateTileTexture(c,
L.TextureUpdate.FADING));this._techniqueConfiguration.tileBlendInput=b.backgroundIsGrid?J.TileBlendInput.GridComposite:null!=b.backgroundColor?J.TileBlendInput.ColorComposite:J.TileBlendInput.LayerOnly;this.setNeedsRender()}}_updatePatchGroups(){this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0);if(this._patchSortingDirty&&this.renderOrder!==X.RenderOrder.NONE){const a=Array.from(this._visiblePatchesByOrigin.values()),b=this._stencilEnabledLayerExtents;
for(const d of a)M.sortTiles(this.renderOrder,d,b);a.sort((d,c)=>M.compareTiles(d[0],c[0],this.renderOrder));this._visiblePatchesByOrigin=new Map(a.map(d=>[d[0].renderData.localOrigin,d]));this._patchSortingDirty=!1}}_rebuildPatchGroups(){const a=this._rootTiles;if(null!=a){a[0]?.surface.checkAllTilesWaterproofness();this._visiblePatchesByOrigin.clear();this._allPatchesByOrigin.clear();for(const b of a)this._rebuildPatchGroupsForRootTile(b)}}_rebuildPatchGroupsForRootTile(a){const b=this._tileIterator;
for(b.resetOne(a);!b.done;){a=b.next();var d=a.renderData;if(d){d=d.localOrigin;if(this._castShadows){var c=this._allPatchesByOrigin.get(d);c||(c=[],this._allPatchesByOrigin.set(d,c));c.push(a)}a.visible?(c=this._visiblePatchesByOrigin.get(d),c||(c=[],this._visiblePatchesByOrigin.set(d,c)),c.push(a),b.skipSubtree()):(this._numTilesCulled++,b.skipSubtree())}else this._numTilesCulled++}}_useStencilForTile(a){for(const b of this._stencilEnabledLayerExtents)if(a.intersectsExtent(b))return!0;return!1}_renderAuxiliaryPass(a,
b,d,c){const k=a.rctx;this._passParameters.overlayContent=d;k.bindTechnique(b,a.bindParameters,this._passParameters);const n=0<this._stencilEnabledLayerExtents.length;c.forEach(f=>{this._drawParameters.origin=f[0].renderData.localOrigin;b.program.bindDraw(this._drawParameters,a.bindParameters,this._passParameters);for(let h=0;h<f.length;h++)this._renderPatch(a,b,f[h],P.PrimitiveType.TRIANGLES,n,d)});a.rctx.bindVAO(null)}_renderMaterialPass(a,b,d){var {rctx:c}=a;this._passParameters.overlayContent=
d;c.bindTechnique(b,a.bindParameters,this._passParameters);this._numOriginsRendered=this._numTilesCulled=this._numTilesRendered=0;var k=a.bindParameters.camera;c=b.program;this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest&&ya.getSettings(this._stage.viewingMode,this._ellipsoidRadius).update({distance:this.pointsOfInterest.centerOnSurfaceFrequent.distance,fovY:k.fovY});k=0<this._stencilEnabledLayerExtents.length;const n=d===C.OverlayContent.Occluded;n&&(c.bindTexture("tex",
this._emptyTex),c.setUniform3fv("textureOpacities",x.ZEROS),c.setUniform4fv("texOffsetAndScale",ma.ZEROS));var f=null!=this._tileRenderer?.backgroundColor?this._tileRenderer.backgroundColor:x.ZEROS;this._techniqueConfiguration.tileBlendInput===J.TileBlendInput.ColorComposite&&c.setUniform3fv("backgroundColor",f);f=this.wireframe?P.PrimitiveType.LINES:P.PrimitiveType.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&c.bindTexture("texNext",this._emptyTex);var h=this._visiblePatchesByOrigin;
for(const u of h.values()){b.program.bindDraw(new ba.DrawParameters(u[0].renderData.localOrigin),a.bindParameters,this._passParameters);this._numOriginsRendered++;for(const v of u){h=v.renderData;const D=h.textureReference;if(null!=D){if(!n){c.setUniform4fv("texOffsetAndScale",D.offsetAndScale);c.bindTexture("tex",D.texture.texture);const r=h.textureFadeFactor,B=1>r?h.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&null!=B&&1>r?(c.setUniform1f("fadeFactor",r),c.setUniform4fv("nextTexOffsetAndScale",
B.offsetAndScale),c.setUniform3fv("nextTexOpacities",B.opacities),c.bindTexture("texNext",B.texture.texture)):c.setUniform1f("fadeFactor",1);h.textureIsFading&&this.setNeedsRender();c.setUniform3fv("textureOpacities",D.opacities)}this._renderPatch(a,b,v,f,k,d);v.renderOrder=this._numTilesRendered;this._numTilesRendered++}}}a.rctx.bindVAO(null)}_renderPatch(a,b,d,c,k,n){const f=d.renderData,h=f.vao,u=h?.indexBuffer;if(h&&null!=u){var v=b.program;null==n||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(v,
f.overlay);k&&(b.useStencil=this._useStencilForTile(d),a.rctx.setPipelineState(b.getPipeline()));b=f.geometry.indexCount;a.rctx.bindVAO(h);v.assertCompatibleVertexAttributeLocations(h);a.rctx.drawElements(c,b,u.indexType,0)}else sa.enableTerrainInternalChecks&&console.error("Rendered tile with no indices: ",d.lij," : ",f)}_bindOverlayPatchData(a,b){a.setUniform4fv("overlayTexOffset",b.offsets);a.setUniform4fv("overlayTexScale",b.scales)}_updateTechnique(a,b){this._techniqueConfiguration.output=a;
this._techniqueConfiguration.renderOccluded=b;return this._shaderTechnique=this._techniques.releaseAndAcquire(Aa.TerrainTechnique,this._techniqueConfiguration,this._shaderTechnique)}get test(){return{tileRenderer:this._tileRenderer}}};q.__decorate([t.property({readOnly:!0})],e.TerrainRenderer.prototype,"_isGlobal",null);q.__decorate([t.property()],e.TerrainRenderer.prototype,"renderOccludedFlags",void 0);q.__decorate([t.property({value:!1})],e.TerrainRenderer.prototype,"renderingDisabled",null);q.__decorate([t.property({value:!0})],
e.TerrainRenderer.prototype,"visible",null);q.__decorate([t.property()],e.TerrainRenderer.prototype,"renderPatchBorders",null);q.__decorate([t.property()],e.TerrainRenderer.prototype,"visualizeNormals",null);q.__decorate([t.property()],e.TerrainRenderer.prototype,"cullBackFaces",null);q.__decorate([t.property({value:X.RenderOrder.FRONT_TO_BACK})],e.TerrainRenderer.prototype,"renderOrder",null);q.__decorate([t.property()],e.TerrainRenderer.prototype,"wireframe",null);e.TerrainRenderer=q.__decorate([ka.subclass("esri.views.3d.terrain.TerrainRenderer")],
e.TerrainRenderer);const Ca=x.create(),Da=x.create(),F=x.create(),Fa=x.create();Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});