// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","./interfaces","./TerrainConst","./terrainUtils","./tileUtils"],function(n,p,x,y,z){class q{get updating(){return!!this._tileRequested}init(a,d,e,b){this.tile=a;this._layerIdx=d;this._layerClass=e;this._suspended=b;this._tileLayerInfo=a.getLayerInfo(d,e);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),
this._tileRequested=null);this._tileLayerInfo=this.tile=null}setSuspension(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const a=this._findAncestorWithData();this._setUpsampleTile(a);return this._requestNext()}dataArrived(a,d){this._setUpsampleTile(a,d);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass,
p.TextureUpdate.FADING,d):this._requestNext()}dataMissing(){this._tileRequested=null;this._tileLayerInfo.data=null;this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()}_requestNext(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}null!=a?a.requestLayerData(this._layerIdx,this._layerClass,
this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested}_findNextDownload(){const a=this._layerIdx,d=this._layerClass;var e=this.tile.surface.layerViewByIndex(a,d),b=y.getLayerWithExtentRange(e);const {minLevel:r,maxLevel:A}=e.dataLevelRange,g=this._desiredMinLevelDelta,B=this._progressiveLevelModulo+g,C=this._scaleRangeEnabled?z.fallsWithinLayer:()=>!0;let c=this.tile;const h=c.level;let f;const k=this._tileLayerInfo.upsampleInfo,t=null!=k?k.tile.level:-1,D=null!=k?t-h>=g:!1,
E=b?.tilemapCache;for(e="vector-tile-3d"===e.type?e.schemaHelper:null;c&&C(c,b,!1)&&c.level>=r;){const l=c.level,u=h-l,m=c.layerInfo[d][a];if(m.data&&u>=g){(!D||l>t)&&this._setUpsampleTile(c);m.dataInvalidated&&(f=c);break}const v=e?.getLevelRowColumn(c.lij)??c.lij;if("unavailable"!==E?.getAvailability(v[0],v[1],c.lij[2])&&l<=A&&!m.data&&!m.dataMissing){if(!f||c.level===r||0===l%x.progressiveLoadingModulo||h-f.level<g)f=c;if(u>=B)break}c=c.parent}null!=f&&h-f.level<g&&(k?f=null:(b=this._findAncestorWithData(),
null!=b&&(this._setUpsampleTile(b),f=b.layerInfo[d][a].dataInvalidated?b:null)));return f}_findAncestorWithData(){const a=this.tile.elevationLevel,d=this._desiredMinLevelDelta;let e;for(let b=this.tile;b;b=b.parent)if(b.hasLayerData(this._layerIdx,this._layerClass)){if(a-b.level>=d)return b;e=b}return e}_setUpsampleTile(a,d){this._tileLayerInfo.setUpsampleInfo(this.tile,a);this.tile.updateRenderData(this._layerClass,p.TextureUpdate.FADING,d)}get test(){return{findNextDownload:()=>this._findNextDownload(),
tileLayerInfo:this._tileLayerInfo}}}class F extends q{get _desiredMinLevelDelta(){throw w;}get _progressiveLevelModulo(){throw w;}dispose(){}}const w=Error("Abstract method called on TileAgent"),G=new F;n.TileAgent=q;n.tileAgentDone=G;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});