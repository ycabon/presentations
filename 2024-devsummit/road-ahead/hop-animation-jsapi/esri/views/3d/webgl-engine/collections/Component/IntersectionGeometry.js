// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../../../geometry/support/FloatArray ../../../../../geometry/support/Indices ../../../../ViewingMode ./ComponentIntersectionData ../../lib/Attribute ../../lib/ComponentUtils ../../materials/internal/MaterialUtil".split(" "),
function(N,O,c,B,X,Y,Z,P,Q,R,aa,S,K){class ba{constructor(l,a,m){this.viewingMode=l;this.positionData=a;this._components=m;this._planetCenter=B.create();this._planetNorth=B.create();this._componentIndicesForBsp=null;this._componentBspNodes=[];this._aabb=[0,0,0,0,0,0];this._indices=a.indices?P.compactIndices(a.indices):P.getContinuousIndexArray(a.positions.length/3);this._positions=a.positions;this._componentIntersectionData=Array(m.count)}destroy(){this._indices=this._positions=null;this._componentIntersectionData.length=
0;this._perComponentAabbs=null}getComponentAabb(l,a){const m=this._ensureComponentAabbs();for(let b=0;6>b;b++)a[b]=m[6*l+b];return a}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs());return this._perComponentAabbs}getComponentPositions(l,a){a.indices=this._indices;a.data=this._positions;a.stride=3;a.startIndex=this._components.offsets[l];a.endIndex=this._components.offsets[l+1]}intersect(l,
a,m,b,A,C,w,t){var {position:d}=w;const u=c.sub(ca,l,d),q=c.sub(da,a,d);l=N.invert(ea,w.rotationScale);c.transformMat3(u,u,l);c.transformMat3(q,q,l);const g=N.transpose(fa,l),y=new aa.Vertices(this._positions,3),D=this._indices,E=this._components.offsets,h=K.computeInvDir(u,q,ha);this.viewingMode===Q.ViewingMode.Global&&(a=this._planetCenter,c.negate(a,d),c.transformMat3(a,a,l),d=this._planetNorth,c.set(d,0,0,1),c.transformMat3(d,d,l),c.normalize(d,d));const k=c.copy(ia,u),x=c.copy(ja,q);d=c.sub(ka,
q,u);c.normalize(d,d);this._intersectComponents(e=>{var p=this.getComponentAabb(e,la);if(null!=A){var r=A[e];null==b||t?(u[2]=k[2]-r,q[2]=x[2]-r):b.componentOffset=r}null==b||t||b.applyToAabb(p);if(K.intersectAabbInvDir(p,u,h,m)){p=E[e]/3;r=E[e+1]/3;var f=(n,v,z)=>C(e,n,c.transformMat3(v,v,g),z);(null==b||t)&&r-p>R.componentMinimalSizeForIntersectionData?(null==this._componentIntersectionData[e]&&(this._componentIntersectionData[e]=new R.ComponentIntersectionData(this._indices,p,r,y)),this._componentIntersectionData[e].intersectRay(u,
q,f)):K.intersectTriangles(u,q,p,r,D,y,void 0,b,f)}},t,u,q)}_intersectComponents(l,a,m,b){const A=this._components.pickability,C=this._components.visibility;if(7>this._components.visibility.componentCount)C.forEachComponent(d=>{S.getVisibility(A,d)&&l(d);return!0});else{0===this._componentBspNodes.length&&this._generateComponentBspRoot();var w=this._componentIndicesForBsp,t=(d,u)=>{for(let q=d;q<u;++q)d=w[q],S.getVisibility(A,d)&&C.isVisible(d)&&l(d)};if(a)for(a=0;0<=a;)if(a=this._componentBspNodes[a],
b=a.plane,!b||-1===a.child0&&-1===a.child1){t(a.minComponentIndexIndex,a.maxComponentIndexIndex);break}else if(t(a.minMidComponentIndexIndex,a.maxMidComponentIndexIndex),b=c.dot(b,m)-b[3],0>b){if(-1===a.child0){t(a.minComponentIndexIndex,a.minMidComponentIndexIndex);break}a=a.child0}else if(0<b){if(-1===a.child1){t(a.maxMidComponentIndexIndex,a.maxComponentIndexIndex);break}a=a.child1}else break;else{const d=ma;c.sub(d,b,m);c.normalize(d,d);const u=this._componentBspNodes,q=g=>{g=u[g];var y=g.plane;
if(!y||-1===g.child0&&-1===g.child1)t(g.minComponentIndexIndex,g.maxComponentIndexIndex);else{const D=c.dot(y,m)-y[3];y=c.dot(y,d);g.minComponentIndexIndex<g.minMidComponentIndexIndex&&(0>=D||0>y)&&(-1!==g.child0?q(g.child0):t(g.minComponentIndexIndex,g.minMidComponentIndexIndex));t(g.minMidComponentIndexIndex,g.maxMidComponentIndexIndex);g.maxMidComponentIndexIndex<g.maxComponentIndexIndex&&(0<=D||0<y)&&(-1!==g.child1?q(g.child1):t(g.maxMidComponentIndexIndex,g.maxComponentIndexIndex))}};q(0)}}}_generateComponentBspRoot(){const l=
this._components.count,a=new Uint16Array(l);this._componentIndicesForBsp=a;for(var m=0;m<l;++m)a[m]=m;const b=this._ensureComponentAabbs(),A=this._planetCenter,C=this._planetNorth;m=na;c.negate(m,A);c.normalize(m,m);c.cross(oa,C,m);var w=this._aabb;m=w[2];const t=[];let d=0;const u=this._componentBspNodes;u.length=0;const q=(h,k)=>{h*=6;var x=b[h],e=b[h+1],p=b[h+2];const r=b[h+3],f=b[h+4],n=b[h+5];h=c.set(T,.5*(x+r),.5*(e+f),.5*(p+n));x=.5*(r-x);e=.5*(f-e);p=.5*(n-p);p=Math.sqrt(x*x+e*e+p*p);e=k[3];
k=c.dot(k,h)-e;return Math.abs(k)>p?Math.sign(k):0},g=(h,k,x)=>{let e=Infinity,p=Infinity,r=Infinity,f=-Infinity,n=-Infinity,v=-Infinity;for(;k<x;++k){const z=6*a[k];e=Math.min(e,b[z]);f=Math.max(f,b[z+3]);p=Math.min(p,b[z+1]);n=Math.max(n,b[z+4]);r=Math.min(r,b[z+2]);v=Math.max(v,b[z+5])}h[0]=e;h[1]=p;h[2]=r;h[3]=f;h[4]=n;h[5]=v},y=this.viewingMode===Q.ViewingMode.Local;let D=!1;y||(w=c.set(T,.5*(w[0]+w[3]),.5*(w[1]+w[4]),.5*(w[2]+w[5])),w=c.dist(A,w),D=m>.5*w);const E=(h,k,x,e,p)=>{const r=u.length;
if(D||10<=x||5>k-h)var f=new U(h,k,k,k,null);else{g(G,h,k);var n=G[0],v=G[1],z=G[2];const L=G[3],M=G[4],V=L-n,W=M-v;f=X.create();if(y)V>=W?(c.set(f,1,0,0),f[3]=-.5*(n+L)):(c.set(f,0,1,0),f[3]=-.5*(v+M));else{const F=pa,H=qa;c.set(F,.5*(n+L),.5*(v+M),z);c.sub(F,F,A);c.normalize(F,F);c.cross(H,F,C);c.normalize(H,H);V>=W?c.copy(f,H):(c.cross(f,H,F),c.normalize(f,f));f[3]=c.dot(f,A)}let I,J;v=h;for(n=k;v<n;)z=a[v],0>q(z,f)?++v:(--n,a[v]=a[n],a[n]=z);I=v;for(n=k;v<n;)z=a[n-1],0<q(z,f)?--n:(a[n-1]=a[v],
a[v]=z,++v);J=n;f=new U(h,I,J,k,f);I>=h+5&&t.push(()=>E(h,I,x+1,r,!0));k>=J+5&&t.push(()=>E(J,k,x+1,r,!1))}u.push(f);-1!==e&&(e=u[e],p?e.child0=r:e.child1=r)};for(t.push(()=>E(0,l,0,-1,!1));d<t.length;)(0,t[d])(),++d}_computePerComponentAabbs(){const l=this._components.count,a=Z.newFloatArray(6*l),m=this._indices,b=this._positions,A=this._components.offsets;let C=0,w=Infinity,t=Infinity,d=Infinity,u=-Infinity,q=-Infinity,g=-Infinity;for(let E=0;E<l;E++){var y=A[E];const h=A[E+1];let k=Infinity,x=
Infinity,e=Infinity,p=-Infinity,r=-Infinity,f=-Infinity;for(;y<h;y++){var D=3*m[y];const n=b[D],v=b[D+1];D=b[D+2];k=Math.min(k,n);x=Math.min(x,v);e=Math.min(e,D);p=Math.max(p,n);r=Math.max(r,v);f=Math.max(f,D)}a[C++]=k;a[C++]=x;a[C++]=e;a[C++]=p;a[C++]=r;a[C++]=f;w=Math.min(w,k);t=Math.min(t,x);d=Math.min(d,e);u=Math.max(u,p);q=Math.max(q,r);g=Math.max(g,f)}this._aabb[0]=w;this._aabb[1]=t;this._aabb[2]=d;this._aabb[3]=u;this._aabb[4]=q;this._aabb[5]=g;return a}get positions(){return this._positions}get indices(){return this._indices}get aabb(){this._ensureComponentAabbs();
return this._aabb}}class U{constructor(l,a,m,b,A){this.minComponentIndexIndex=l;this.minMidComponentIndexIndex=a;this.maxMidComponentIndexIndex=m;this.maxComponentIndexIndex=b;this.plane=A;this.child1=this.child0=-1}}const ha=B.create(),la=Y.create(),G=[0,0,0,0,0,0],ca=B.create(),da=B.create(),ea=O.create(),fa=O.create(),ia=B.create(),ja=B.create(),ka=B.create(),pa=B.create(),qa=B.create(),na=B.create(),oa=B.create(),T=B.create(),ma=B.create();return ba});