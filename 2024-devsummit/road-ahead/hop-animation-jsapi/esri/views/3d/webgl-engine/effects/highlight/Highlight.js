// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/colorUtils ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../webgl/ManagedFBO ../RenderPlugin ./HighlightApplyTechnique ./HighlightBlurTechnique ./HighlightDefaults ./HighlightDownsampleTechnique ./HighlightPassParameters ../../lib/DefaultVertexAttributeLocations ../../lib/DefaultVertexBufferLayouts ../../lib/RenderSlot ../../lib/VertexArrayObject ../../../../../chunks/HighlightBlur.glsl ../../../../../chunks/HighlightDownsample.glsl ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/Util".split(" "),
function(p,t,z,D,q,n,A,P,Q,E,u,v,B,F,G,w,H,I,J,K,L,M,N,m,O,x,y){p.Highlight=class extends B.SyncRenderPlugin{constructor(g){super(g);this._context=null;this._passParameters=new I.HighlightPassParameters;this._downsampleDrawParameters=new m.HighlightDownsampleDrawParameters;this._blurDrawParameters=new N.HighlightBlurDrawParameters;this._blurColorFormat=D("mac")?v.ColorFormat.RGBA:v.ColorFormat.RGBA4;this._grid={coverage:null,vao:null,verticalCellCount:0,horizontalCellCount:0,viewportWidth:0,viewportHeight:0};
this.produces=new Map([[L.RenderSlot.HIGHLIGHT,()=>!0]])}consumes(){return B.ConsumesHighlight}initializeRenderContext(g){this._context=g;null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(G.HighlightBlurTechnique));null==this._downsampleTechnique&&(this._downsampleTechnique=this._context.techniqueRepository.acquire(H.HighlightDownsampleTechnique));null==this._applyTechnique&&(this._applyTechnique=this._context.techniqueRepository.acquire(F.HighlightApplyTechnique));
this.addHandles([n.watch(()=>this.view.highlightOptions.color,f=>{this._passParameters.color=z.unitRGBAFromColor(f??w.defaultColor);this.view.highlightOptions.haloColor||(this._passParameters.haloColor=this._passParameters.color);this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.haloColor,f=>{this._passParameters.haloColor=null!=f?z.unitRGBAFromColor(f):this._passParameters.color;this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.haloOpacity,
f=>{this._passParameters.haloOpacity=f??w.defaultHaloOpacity;this._passParameters.haloOpacityOccluded=.25*this._passParameters.haloOpacity;this._context.requestRender()},n.syncAndInitial),n.watch(()=>this.view.highlightOptions.fillOpacity,f=>{this._passParameters.fillOpacity=f??w.defaultFillOpacity;this._passParameters.fillOpacityOccluded=.25*this._passParameters.fillOpacity;this._context.requestRender()},n.syncAndInitial)])}uninitializeRenderContext(){this._context=null}dispose(){this._blurTechnique=
q.releaseMaybe(this._blurTechnique);this._downsampleTechnique=q.releaseMaybe(this._downsampleTechnique);this._applyTechnique=q.releaseMaybe(this._applyTechnique);this._grid.coverage=q.releaseMaybe(this._grid.coverage);this._grid.vao=q.disposeMaybe(this._grid.vao)}renderNode(g,f,e,d){var b=e?.get("highlight")?.getTexture();if(this._context&&b)if(this._blurTechnique.compiled&&this._downsampleTechnique.compiled&&this._applyTechnique.compiled){f=g.bindParameters.camera;var l=f.pixelRatio;e=Math.ceil(f.fullWidth/
l);l=Math.ceil(f.fullHeight/l);var c=this._context.fbos,a=c.rctx;this._gridUpdateResources(b);this._gridComputeCoverage(b,g.bindParameters);this._passParameters.highlightTexture=b;this._passParameters.coverageTexture=this._grid.coverage?.getTexture();var {width:h,height:k}=b.descriptor;u.set(this._passParameters.coverageRounding,h/(Math.ceil(h/m.gridCellPixelSize)*m.gridCellPixelSize),k/(Math.ceil(k/m.gridCellPixelSize)*m.gridCellPixelSize));var r=this._grid.vao;a.bindVAO(r);var C=c.acquire(e,l,"highlight blur",
this._blurColorFormat);a.setClearColor(0,0,0,0);a.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT);a.setViewport(0,0,e,l);this._blurDrawParameters.blurInputTexture=b;u.set(this._blurDrawParameters.blurSize,1/e,0);b=a.bindTechnique(this._blurTechnique,g.bindParameters,this._passParameters,this._blurDrawParameters);a.drawArrays(this._blurTechnique.primitiveType,0,y.vertexCount(r,"geometry"));e=c.acquire(e,l,"highlight blur",this._blurColorFormat);a.setClearColor(0,0,0,0);a.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT);
this._blurDrawParameters.blurInputTexture=C.getTexture();u.set(this._blurDrawParameters.blurSize,0,1/l);b.bindDraw(this._blurDrawParameters,g.bindParameters,this._passParameters);a.drawArrays(this._blurTechnique.primitiveType,0,y.vertexCount(r,"geometry"));a.bindFramebuffer(d?.fbo);a.setViewport4fv(f.fullViewport);this._passParameters.blurTexture=e.getTexture();a.bindTechnique(this._applyTechnique,g.bindParameters,this._passParameters);a.drawArrays(this._applyTechnique.primitiveType,0,y.vertexCount(r,
"geometry"));C.release();e.release()}else this._context.requestRender()}_gridUpdateResources(g){if(this._context){var f=this._context.fbos.rctx,e=this._grid,d=Math.ceil(g.descriptor.height/m.gridCellPixelSize),b=Math.ceil(g.descriptor.width/m.gridCellPixelSize);if(!e.vao||e.verticalCellCount!==d||e.horizontalCellCount!==b){e.verticalCellCount=d;e.horizontalCellCount=b;g=d+1;var l=b+1;d=1/d;b=1/b;var c=new Float32Array(24*g*l),a=0;for(let h=0;h<g;h++)for(let k=0;k<l;k++)c[a++]=(k-.5)*b*2-1,c[a++]=
(h-.5)*d*2-1,c[a++]=k*b,c[a++]=h*d,c[a++]=(k+.5)*b*2-1,c[a++]=(h-.5)*d*2-1,c[a++]=k*b,c[a++]=h*d,c[a++]=(k-.5)*b*2-1,c[a++]=(h+.5)*d*2-1,c[a++]=k*b,c[a++]=h*d,c[a++]=(k-.5)*b*2-1,c[a++]=(h+.5)*d*2-1,c[a++]=k*b,c[a++]=h*d,c[a++]=(k+.5)*b*2-1,c[a++]=(h-.5)*d*2-1,c[a++]=k*b,c[a++]=h*d,c[a++]=(k+.5)*b*2-1,c[a++]=(h+.5)*d*2-1,c[a++]=k*b,c[a++]=h*d;e.vao?.dispose();e.vao=new M.VertexArrayObject(f,J.Default3D,{geometry:K.Pos2Tex},{geometry:O.BufferObject.createVertex(f,x.Usage.STATIC_DRAW,c)})}}}_gridComputeCoverage(g,
f){if(this._context){var e=this._context.fbos.rctx,d=this._grid,b=g.descriptor,l=Math.ceil(b.width/m.gridCellPixelSize);b=Math.ceil(b.height/m.gridCellPixelSize);this._downsampleDrawParameters.input=g;d.coverage?.release();d.coverage=this._context.fbos.acquire(l,b,"highlight coverage",v.ColorFormat.RG);e.bindTechnique(this._downsampleTechnique,f,this._passParameters,this._downsampleDrawParameters);e.setViewport(0,0,l,b);e.screen.draw()}}get test(){return{coverage:this._grid.coverage}}};t.__decorate([A.property()],
p.Highlight.prototype,"_context",void 0);t.__decorate([A.property()],p.Highlight.prototype,"view",void 0);p.Highlight=t.__decorate([E.subclass("esri.views.3d.webgl-engine.effects.highlight.Highlight")],p.Highlight);Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});