// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/colorUtils ../../../../../core/mathUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../ViewingMode ../RenderPlugin ./HighlightDefaults ./ShadowHighlightTechnique ../../lib/RenderSlot".split(" "),
function(c,e,q,g,d,h,x,y,z,r,k,t,u,m,l,n,v){c.ShadowHighlight=class extends m.SyncRenderPlugin{constructor(a){super(a);this._maxOpacity=1;this._passParameters=new n.ShadowHighlightPassParameters;this._shadowDifference=.2;this._context=null;this.produces=new Map([[v.RenderSlot.SHADOW_HIGHLIGHT,()=>this._isVisible]])}consumes(){return m.ConsumesHighlight}initializeRenderContext(a){this._context=a;this.addHandles([d.watch(()=>this.view.highlightOptions.shadowOpacity,b=>{this._passParameters.shadowOpacity=
b??l.defaultShadowOpacity;this._updateOccludedShadowOpacity();this._updateMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowDifference,b=>{this._shadowDifference=b??l.defaultShadowDifference;this._updateOccludedShadowOpacity();this._updateMaxOpacity()},d.syncAndInitial),d.watch(()=>this.view.highlightOptions.shadowColor,b=>{this._passParameters.shadowColor=q.unitRGBAFromColor(b??l.defaultShadowColor);this._updateMaxOpacity()},d.syncAndInitial)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=
this._passParameters.shadowOpacity*(1-this._shadowDifference)}_updateMaxOpacity(){this._maxOpacity=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity)*this._passParameters.shadowColor[3]}uninitializeRenderContext(){this._context=null}enable(){this._context&&null==this._technique&&(this._technique=this._context.techniqueRepository.acquire(n.ShadowHighlightTechnique))}renderNode(a,b,f,w){f=f?.get("highlight")?.getTexture();this._context&&f&&this._isVisible&&(this._technique?.compiled?
(b=a.bindParameters,b.shadowMap.enabled&&b.linearDepth&&(this._passParameters.highlight=f,this._passParameters.origin=b.camera.center,a=a.rctx,a.bindFramebuffer(w?.fbo),a.bindTechnique(this._technique,b,this._passParameters),a.screen.draw())):this._context.requestRender())}updateParameters(a,b){this._passParameters.opacityElevation=1-g.smoothstep(4E4,5E4,a.relativeElevation);a=this.viewingMode===u.ViewingMode.Global?k.normalize(p,a.center):k.set(p,0,0,1);b=k.dot(a,b);this._passParameters.dayNightTerminator=
g.smoothstep(0,1,g.clamp(30*b,0,1));this._isVisible&&this.enable()}get _isVisible(){const {opacityElevation:a,dayNightTerminator:b}=this._passParameters;return.001953125<=this._maxOpacity*a*b}};e.__decorate([h.property()],c.ShadowHighlight.prototype,"_context",void 0);e.__decorate([h.property()],c.ShadowHighlight.prototype,"view",void 0);e.__decorate([h.property()],c.ShadowHighlight.prototype,"viewingMode",void 0);c.ShadowHighlight=e.__decorate([r.subclass("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],
c.ShadowHighlight);const p=t.create();Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});