// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../support/requestImageUtils ../../../webgl/ManagedFBO ../RenderPlugin ./SMAABlendWeightsTechnique ./SMAABlurTechnique ./SMAAEdgeDetectTechnique ./SMAAPassParameters ../../lib/RenderFeature ../../lib/RenderSlot ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(v,f,h,l,m,n,k,G,H,I,w,p,x,q,y,z,A,B,C,D,g,E,F){function r(a,b,c,d){const e=new F.TextureDescriptor;e.pixelFormat=c;e.wrapMode=g.TextureWrapMode.CLAMP_TO_EDGE;e.width=d.width;e.height=d.height;e.samplingMode=b;return new E.Texture(a,e,d)}f.SMAA=class extends q.SyncRenderPlugin{constructor(a){super(a);this._searchTexture=this._areaTexture=this._context=null;this._isEnabled=!1;this._smaaParameters=new B.SMAAPassParameters;this.produces=new Map([[D.RenderSlot.ANTIALIASING,()=>this._isEnabled&&
null!=this._context]])}consumes(){return q.ConsumesCompositeColor}get updating(){return null!=this._abortController}initializeRenderContext(a){this._context=a;this.addHandles([n.watch(()=>this.view.qualitySettings.antialiasingEnabled,()=>this.renderFeatureChanged(),n.syncAndInitial)])}renderFeatureChanged(){this.view.qualitySettings.antialiasingEnabled||this._context?.isFeatureEnabled(C.RenderFeature.Antialiasing)?this.enable():this.disable()}uninitializeRenderContext(){this.disable();this._context=
null}async enable(){if(!this._isEnabled&&this._context&&!this._abortController)if(this._edgeTechnique??(this._edgeTechnique=this._context.techniqueRepository.acquire(A.SMAAEdgeDetectTechnique)),this._blendTechnique??(this._blendTechnique=this._context.techniqueRepository.acquire(y.SMAABlendWeightsTechnique)),this._blurTechnique??(this._blurTechnique=this._context.techniqueRepository.acquire(z.SMAABlurTechnique)),this._areaTexture&&this._searchTexture)this._isEnabled=!0;else{this._abortController=
new AbortController;var a=this._abortController.signal;try{const b=await new Promise((c,d)=>v(["./SMAAData"],c,d));await this._loadTextures(this._context,b,a);this._context?.requestRender()}catch{}this._abortController=null}}async _loadTextures(a,b,c){m.throwIfAborted(c);if(!a)throw m.createAbortError();const [d,e]=await Promise.allSettled([p.requestImage(b.areaTexture,{signal:c}),p.requestImage(b.searchTexure,{signal:c})]);m.throwIfAborted(c);"fulfilled"===d.status&&"fulfilled"===e.status&&(this._areaTexture=
r(a.fbos.rctx,g.TextureSamplingMode.LINEAR,g.PixelFormat.RGB,d.value),this._searchTexture=r(a.fbos.rctx,g.TextureSamplingMode.NEAREST,g.PixelFormat.LUMINANCE,e.value),this._isEnabled=!0)}_disposeTextures(){this._areaTexture=l.disposeMaybe(this._areaTexture);this._searchTexture=l.disposeMaybe(this._searchTexture)}disable(){this._abortController=l.abortMaybe(this._abortController);this._isEnabled=!1}destroy(){this.disable();this._disposeTextures()}renderNode(a,b,c,d){b=c?.get("composite-color")?.getTexture();
if(!(this._isEnabled&&this._context&&c&&b))return d;if(!(this._edgeTechnique?.compiled&&this._blendTechnique?.compiled&&this._blurTechnique?.compiled))return this._context.requestRender(),d;c=b.descriptor.width;const e=b.descriptor.height,t=this._context.fbos;a=a.rctx;a.setViewport(0,0,c,e);const u=t.acquire(c,e,"smaa edges",x.ColorFormat.RG);a.setClearColor(0,0,0,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.color=b;a.bindTechnique(this._edgeTechnique,null,this._smaaParameters);
a.screen.draw();b=t.acquire(c,e,"smaa blend");a.setClearColor(0,0,1,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.inputTexture=u.getTexture();this._smaaParameters.areaTexture=this._areaTexture;this._smaaParameters.searchTexture=this._searchTexture;a.bindTechnique(this._blendTechnique,null,this._smaaParameters);a.screen.draw();a.bindFramebuffer(d?.fbo);u.release();a.setClearColor(0,1,0,1);a.clear(g.ClearBufferBit.COLOR_BUFFER_BIT);this._smaaParameters.inputTexture=b.getTexture();
a.bindTechnique(this._blurTechnique,null,this._smaaParameters);a.screen.draw();b.release();return d}};h.__decorate([k.property()],f.SMAA.prototype,"view",void 0);h.__decorate([k.property()],f.SMAA.prototype,"_context",void 0);h.__decorate([k.property()],f.SMAA.prototype,"_abortController",void 0);h.__decorate([k.property({readOnly:!0})],f.SMAA.prototype,"updating",null);f.SMAA=h.__decorate([w.subclass("esri.views.3d.webgl-engine.effects.smaa.SMAA")],f.SMAA);Object.defineProperty(f,Symbol.toStringTag,
{value:"Module"})});