// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/time ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/vec2 ../../../webgl/ManagedFBO ../RenderPlugin ./SSAOBlurTechnique ./SSAONoiseData ./SSAOParameters ./SSAOTechnique ../../lib/RenderFeature ../../lib/RenderSlot ../../../../../chunks/SSAO.glsl ../../../../webgl/enums ../../../../webgl/Texture ../../../../webgl/TextureDescriptor".split(" "),
function(g,n,y,r,z,t,J,K,L,A,u,p,q,B,C,v,D,E,F,G,h,H,I){g.SSAO=class extends q.SyncRenderPlugin{constructor(c){super(c);this._context=null;this._passParameters=new v.SSAOPassParameters;this._drawParameters=new v.BlurDrawParameters;this.produces=new Map([[F.RenderSlot.SSAO,()=>this._produces()]])}_produces(){return null!=this._enableTime&&null!=this._context}consumes(){return this._produces()?q.ConsumesDepthNormal:q.ConsumesNone}initializeRenderContext(c){this._context=c;this.addHandles([r.watch(()=>
this.view.qualitySettings.ambientOcclusion||this._context?.isFeatureEnabled(E.RenderFeature.SSAO),b=>b?this._enable():this._disable(),r.syncAndInitial)])}uninitializeRenderContext(){this._disable();this._context=null}_disable(){this._passParameters.noiseTexture=y.disposeMaybe(this._passParameters.noiseTexture);this._enableTime=null}destroy(){this._disable()}_enable(){if(null==this._enableTime&&this._context){var c=Uint8Array.from(atob(C.noiseData),a=>a.charCodeAt(0)),b=new I.TextureDescriptor;b.wrapMode=
h.TextureWrapMode.CLAMP_TO_EDGE;b.pixelFormat=h.PixelFormat.RGB;b.wrapMode=h.TextureWrapMode.REPEAT;b.hasMipmap=!0;b.width=32;b.height=32;this._passParameters.noiseTexture=new H.Texture(this._context.renderContext.rctx,b,c);null==this._ssaoTechnique&&(this._ssaoTechnique=this._context.techniqueRepository.acquire(D.SSAOTechnique));null==this._blurTechnique&&(this._blurTechnique=this._context.techniqueRepository.acquire(B.SSAOBlurTechnique));this._enableTime=z.Milliseconds(0);this._context?.requestRender()}}renderNode(c,
b,a){b=c.bindParameters;a=a?.get("normals");var d=a?.getTexture(),e=a?.getTexture(h.DepthStencilAttachment);if(null!=this._enableTime&&null!=this._context&&d&&e){if(this._ssaoTechnique.compiled&&this._blurTechnique.compiled){0===this._enableTime&&(this._enableTime=c.time);a=c.rctx;var k=b.camera,f=this.view.qualitySettings.fadeDuration;c=0<f?Math.min(f,c.time-this._enableTime)/f:1;this._passParameters.normalTexture=d;this._passParameters.depthTexture=e;this._passParameters.projScale=1/k.computeScreenPixelSizeAtDist(1);
this._passParameters.intensity=2/G.getRadius(k)**6*c;d=k.fullViewport[2];e=k.fullViewport[3];f=Math.round(d/2);var m=Math.round(e/2),l=this._context.fbos,w=l.acquire(d,e,"ssao input",p.ColorFormat.RG);a.setViewport(0,0,d,e);a.bindTechnique(this._ssaoTechnique,b,this._passParameters,this._drawParameters);a.screen.draw();var x=l.acquire(f,m,"ssao blur",p.ColorFormat.RED);this._drawParameters.colorTexture=w.getTexture();u.set(this._drawParameters.blurSize,0,2/e);a.bindTechnique(this._blurTechnique,b,
this._passParameters,this._drawParameters);a.setViewport(0,0,f,m);a.screen.draw();w.release();l=l.acquire(f,m,"ssao",p.ColorFormat.RED);a.setViewport(0,0,d,e);a.setClearColor(1,1,1,0);a.clear(h.ClearBufferBit.COLOR_BUFFER_BIT);this._drawParameters.colorTexture=x.getTexture();u.set(this._drawParameters.blurSize,2/d,0);a.bindTechnique(this._blurTechnique,b,this._passParameters,this._drawParameters);a.setViewport(0,0,f,m);a.screen.draw();a.setViewport4fv(k.fullViewport);x.release();1>c&&this._context.requestRender();
return l}this._enableTime=c.time;this._context.requestRender()}}};n.__decorate([t.property({constructOnly:!0})],g.SSAO.prototype,"view",void 0);n.__decorate([t.property()],g.SSAO.prototype,"_context",void 0);g.SSAO=n.__decorate([A.subclass("esri.views.3d.webgl-engine.effects.ssao.SSAO")],g.SSAO);g.blurSizePixels=2;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});