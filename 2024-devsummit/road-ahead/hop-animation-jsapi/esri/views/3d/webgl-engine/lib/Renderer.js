// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/arrayUtils ../../../../core/colorUtils ../../../../core/has ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/signal ../../../../core/accessorSupport/decorators/property ../../../../core/Logger ../../../../core/accessorSupport/interfaces ../../../../core/accessorSupport/tracking/Flags ../../../../core/Warning ../../../../core/Error ../../../../core/libs/gl-matrix-2/math/mat4 ../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../chunks/boundedPlane ../../support/debugFlags ../../terrain/TerrainRenderer ../../webgl/ManagedFBO ../core/FBOCache ../core/renderPasses/RenderPassManager ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/hud/HUDRenderStyle ../effects/RenderNodes ../effects/RenderPlugin ../effects/RenderPluginManager ../effects/blit/Blit ../effects/highlight/Highlight ../effects/highlight/ShadowHighlight ../effects/smaa/SMAA ../effects/ssao/SSAO ./AnimationTimeStep ./basicInterfaces ./BoundingInfo ./depthRange ./depthRangeUtils ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderFeature ./RenderSlot ./ShadowAccumulator ./ShadowMap ./SliceHelper ./TransparencyPassType ./edgeRendering/EdgeView ./edgeRendering/interfaces ../materials/renderers/MergedRenderer ../shaders/CompositingTechniqueConfiguration ../statistics/RendererPerformanceInfo ../../../support/RenderState ../../../webgl/enums".split(" "),
function(y,J,Y,Z,O,t,aa,B,P,K,Ba,Ca,Da,Ea,Fa,F,G,ba,S,ca,da,Q,u,ea,fa,k,z,ha,ia,ja,ka,la,ma,na,oa,pa,A,qa,T,ra,r,sa,U,C,D,c,ta,R,ua,v,va,L,wa,E,m,xa,x){function ya(a){return b=>a.immediate.schedule(b)}class H{constructor(a,b,e,d,g,p,h,n){this._stage=a;this._techniqueRepository=d;this._rctx=g;this._compositingHelper=p;this._magnifierHelper=h;this._requestRender=n;this._needsTransparentPass=!1;this._pluginsHas={hudElements:!1,water:!1};this._hasOverlayWater=!1;this.renderOverlay=f=>{};this._isRendering=
!1;this._backgroundColor=S.fromValues(0,0,0,1);this._sliceHelper=new ua;this._state=P.signal(xa.RenderState.IDLE);this._highQualityTransparencyEnabled=!0;this._terrainTransparency=Q.TransparencyMode.Opaque;this._hasAnimations=this._ssrEnabled=!1;this._animationTimestep=new pa.AnimationTimeStep;this._reprojectionMatrixVersion=P.signal(0);this._renderHiddenTransparentEdges=()=>{};this._pluginInput=new Map;this._releaseGeometryLinearDepth=f=>{f?.release()};this._geometryLinearDepthFormat=u.DepthFormat.DEPTH16_BUFFER;
this._debugLinearDepth=!1;this.fboCache=new ea.FBOCache(g);this._renderStateFeatures=P.signal(D.setupFeatureDefaults(!O("disable-feature:high-quality-idle"),a.view.qualityProfile));this._offscreen=new sa.OffscreenRendering(this.fboCache,this._compositingHelper);this.performanceInfo=new m.RendererPerformanceInfo(this._rctx);this._shadowMap=new R.ShadowMap(this.fboCache,a.viewingMode);this._highlight=new la.Highlight({view:a.view});this._shadowHighlight=new ma.ShadowHighlight({view:a.view,viewingMode:a.viewingMode});
this._shadowAccumulator=new ta.ShadowAccumulator(this.fboCache,d,a,f=>{const l=this.shadowsEnabled;this._shadowMap.enabled=!0;this._prepare(f.camera,f.contentCamera);this._plugins.prepareRender();this._shadowMap.enabled=l},(f,l,q)=>{f.shadowMap.start(f.camera,l,q,!0,this._stage.view.qualitySettings.maximumPixelRatio);this._renderShadowCascades(k.ShaderOutput.Shadow,f.shadowMap);f.shadowMap.finish();f.camera.setGLViewport(this._rctx);this._prepare(f.camera,f.contentCamera)},n);this._ssao=new oa.SSAO({view:this._stage.view});
this._renderContext=new U.RenderContext(this._rctx,this._offscreen,this._shadowMap,this._sliceHelper);this._nodes=new ha.RenderNodes(this._renderContext);this._plugins=new ja.RenderPluginManager({renderContext:this._renderContext,techniqueRepository:d,textureRepository:e,materialRepository:b,requestRender:n,controller:a,fbos:this.fboCache,isFeatureEnabled:f=>this.isFeatureEnabled(f)});this.renderPassManager=new fa.RenderPassManager;this._plugins.add(this.renderPassManager);this._smaa=new na.SMAA({view:this._stage.view});
this._plugins.add(this._smaa);this._blit=new ka.Blit({opacity:1,alphaMode:E.AlphaMode.None});this._plugins.add(this._blit);this._plugins.add(this._ssao);this._plugins.add(this._highlight);this._plugins.add(this._shadowHighlight);this._handles=[B.watch(()=>this._stage.view.state.camera,()=>n(),B.syncAndInitial),B.watch(()=>da.debugFlags.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,f=>{this._renderHiddenTransparentEdges=f?()=>this._renderEdges(L.Transparency.TRANSPARENT):()=>{};n()},B.initial),B.watch(()=>this._stage.view.environment.background?.color,
f=>{f=f?Z.unitRGBAFromColor(f):S.ZEROS;ba.set(this._backgroundColor,f[0]*f[3],f[1]*f[3],f[2]*f[3],f[3]);n()},B.syncAndInitial)]}destroy(){this._handles.forEach(a=>a.remove());this._gpuTimerHandle=t.removeMaybe(this._gpuTimerHandle);this._nodes.destroy();this._offscreen.dispose();this._shadowMap.dispose();this._highlight.dispose();this._shadowAccumulator.dispose();this._edgeView=t.destroyMaybe(this._edgeView);this.renderPassManager.dispose();this._releaseFBOs();this._disposeOffscreenBuffers();this.fboCache.destroy();
this._plugins.destroy();qa.BoundingInfo.prune()}get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeatures(a=null,b=!O("disable-feature:high-quality-idle")){this._renderStateFeatures.value=D.setupFeatureDefaults(b,a);this._plugins.renderFeatureChanged();this._requestRender()}isFeatureEnabled(a,b=this._state.value){return this._renderStateFeatures.value.get(b,a)??!1}setFeatureEnabled(a,b,e){this._renderStateFeatures.mutate(d=>d.set(b,a,e));this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||
this.isFeatureEnabled(D.RenderFeature.HighQualityTransparency)}get hasReflections(){return(this._pluginsHas.water||this._hasOverlayWater)&&(this._ssrEnabled||this.isFeatureEnabled(D.RenderFeature.WaterReflection))}get hasDecorations(){return this._plugins.hasDecorations}get hasHighlights(){return this._plugins.produces(c.RenderSlot.OPAQUE_MATERIAL,k.ShaderOutput.Highlight)||this._plugins.produces(c.RenderSlot.TRANSPARENT_MATERIAL,k.ShaderOutput.Highlight)||this._plugins.produces(c.RenderSlot.DRAPED_MATERIAL,
k.ShaderOutput.Highlight)}get _magnifierEnabled(){return this._bindParameters.decorations===A.Decorations.ON&&this._magnifierHelper.enabled}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(D.RenderFeature.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=t.releaseMaybe(this._bindParameters.ssr.lastFrameColor);this._bindParameters.multipassTerrain.linearDepth=t.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth);
this._bindParameters.multipassGeometry.linearDepth=t.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}_disposeOffscreenBuffers(){this._offscreen.dispose();this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers();this._bindParameters.linearDepth=t.releaseMaybe(this._bindParameters.linearDepth);this._bindParameters.hudVisibility=t.releaseMaybe(this._bindParameters.hudVisibility)}get updating(){return this._smaa.updating||null!=this._edgeView&&this._edgeView.updating||
this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}ensureEdgeView(){null==this._edgeView&&(this._edgeView=new va.EdgeView({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:ya(this._stage.view.resourceController)}),this._handles.push(B.watch(()=>this._edgeView?.updating,()=>this._requestRender(),B.sync)),this._requestRender());
return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return 0<=this._reprojectionMatrixVersion.value&&F.equals(this._bindParameters.ssr.reprojectionMatrix,G.IDENTITY)}set _reprojectionMatrix(a){Y.update(this._bindParameters.ssr.reprojectionMatrix,a)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(a){const {_shadowMap:b,_bindParameters:e}=this;void 0!==a.qualitySettings?.reflections&&this._ssrEnabled!==a.qualitySettings.reflections&&
(this._ssrEnabled=a.qualitySettings.reflections,this._requestRender());void 0!==a.shadowMap&&this._shadowMap.enabled!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this._requestRender());void 0!==a.shadowMapMaxCascades&&b.maxCascades!==a.shadowMapMaxCascades&&(b.maxCascades=a.shadowMapMaxCascades,this._requestRender());if(null!=a.environment){null!=a.environment.weather&&(this._bindParameters.weather=a.environment.weather,this._bindParameters.weatherVisible=!!a.weatherVisible);const d="virtual"!==
a.environment.lighting.type;e.enableFillLights!==d&&(e.enableFillLights=d,this._requestRender())}void 0!==a.highQualityTransparency&&this._highQualityTransparencyEnabled!==a.highQualityTransparency&&(this._highQualityTransparencyEnabled=a.highQualityTransparency,this._requestRender());void 0!==a.hasOverlayWater&&this._hasOverlayWater!==a.hasOverlayWater&&(this._hasOverlayWater=a.hasOverlayWater,this._requestRender());void 0!==a.slicePlane&&this._sliceHelper.plane!==a.slicePlane&&(this._sliceHelper.plane=
a.slicePlane,this._requestRender());void 0!==a.terrainTransparency&&this._terrainTransparency!==a.terrainTransparency&&(this._terrainTransparency=a.terrainTransparency,this._requestRender());void 0!==a.shadowCastOptions&&this._shadowAccumulator.setOptions(a.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get plugins(){return this._plugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(a,
b){this._isRendering&&console.warn("Renderer.modify called while rendering");const {adds:e,removes:d,updates:g}=a;if(0!==e.length||0!==d.length||0!==g.length){var p=!1;C.splitRenderGeometryChangeSetByMaterial(a).forEach((h,n)=>{if(!b.done){var f=this._plugins.getMaterialRenderer(n);null==f&&0<h.adds.length&&(n=new wa.MergedRenderer({material:n}),n.initializeRenderContext(this._plugins._context),f=n,this._plugins.add(f));f&&(f.modify(h),0===f.numGeometries&&(p=!0));h.removes.forEach(l=>a.removes.removeUnordered(l));
h.adds.forEach(l=>a.adds.removeUnordered(l));h.updates.forEach(l=>a.updates.removeUnordered(l));b.madeProgress()}});p&&this._plugins.removeEmptyMaterialRenderers();this._updateHasFlags();this._requestRender()}}_updateHasFlags(){const a=this._pluginsHas;a.hudElements=this._plugins.produces(c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH)||this._plugins.produces(c.RenderSlot.HUD_MATERIAL)||this._plugins.produces(c.RenderSlot.LABEL_MATERIAL);a.water=this._plugins.produces(c.RenderSlot.DRAPED_WATER,k.ShaderOutput.Normal);
this._bindParameters.hasOccludees=this._plugins.hasOccludees}updateAnimation(a){const b=this._hasAnimations;this._hasAnimations=this._plugins.updateAnimation(a)||this._hasAnimations;this._hasAnimations!==b&&(this._gpuTimerHandle=b?t.removeMaybe(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo());return this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(a,
b,e=C.RendererTarget.Default,d=A.Decorations.ON){this._isRendering=!0;this.performanceInfo.startFrame();this.fboCache.frameStart();this._disposeBindBuffers();var g=this._offscreen;const {camera:p,contentCamera:h,mode:n,alignPixelEnabled:f}=a;this._state.value=n;this._bindParameters.overlay=this.renderOverlay(b);this.performanceInfo.advance(m.PerformanceCategory.OVERLAY);this._renderContext.time=b;this._bindParameters.transparencyPassType=v.TransparencyPassType.NONE;this._bindParameters.alignPixelEnabled=
f;this._bindParameters.decorations=d;this._bindParameters.mainColor=this._bindParameters.mainDepth=null;a=ca.create(this._sliceHelper.plane);d===A.Decorations.OFF&&(this._sliceHelper.plane=null);p.setGLViewport(this._rctx);d=g.initializeFrame(p,this._backgroundColor,e);this.hasReflections?this._bindParameters.ssr.lastFrameColor=d:d?.release();this._prepare(p,h);this._plugins.prepareRender();this.performanceInfo.advance(m.PerformanceCategory.PREPARE);var l=this._computeDepthRange(p);this._renderShadowMap(p,
this._bindParameters.lighting.mainLight.direction,l);this.performanceInfo.advance(m.PerformanceCategory.SHADOW_MAP);this._ensureBindParameters(p,h);var q=this._plugins.produces(c.RenderSlot.OPAQUE_TERRAIN)&&(this._terrainTransparency===Q.TransparencyMode.Semitransparent||this._terrainTransparency===Q.TransparencyMode.TransparentWithDraped);d=this._highQualityTransparency&&q;this._prepareShaders(d,this._needsTransparentPass);this._pluginInput.set("normals",this._renderNormals());this.performanceInfo.advance(m.PerformanceCategory.NORMALS);
this._renderSSAO();this.performanceInfo.advance(m.PerformanceCategory.SSAO);this._renderLinearDepth();this.performanceInfo.advance(m.PerformanceCategory.LINEAR_DEPTH);this._renderShadowAccumulation(l,p,h);this.performanceInfo.advance(m.PerformanceCategory.ACCUMULATED_SHADOWS);this._ensureBindParametersSSR(b);this._renderContext.output=k.ShaderOutput.Color;g.bindFbo();this._bindParameters.mainColor=g.colorTexture;this._bindParameters.mainDepth=g.depthTexture;this._renderOpaqueGeometry();this._offscreen.updateColor(M=>
this._invokeRenderNodes(M),"opaque-color");this._plugins.render(c.RenderSlot.ENVIRONMENT_OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE);this.fboCache.debugCallback&&this.fboCache.debugCallback("opaque-color",this._offscreen.color.fbo);this._renderTerrainLinearDepth(d);this._setMultipassTerrain(d);this._renderEdges(L.Transparency.OPAQUE);this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES);g.bindFbo();this._plugins.render(c.RenderSlot.VOXEL);this.performanceInfo.advance(m.PerformanceCategory.VOXEL);
this._renderHiddenTransparentEdges();this._needsTransparentPass&&(this._oitEnabled?this._renderOITPass(N.Geometry):this._renderTransparentMaterial());this._offscreen.updateColor(M=>this._invokeRenderNodes(M),"transparent-color");this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT);l=this._renderGeometryLinearDepth(d);this._renderHUDVisibility(l);d||this._plugins.render(c.RenderSlot.LINE_CALLOUTS);this.performanceInfo.advance(m.PerformanceCategory.HUD_VISIBILITY);b=e===C.RendererTarget.ObjectAndLayerID?
this._renderObjectAndLayerIdColor():null;this.performanceInfo.advance(m.PerformanceCategory.OBJECT_AND_LAYER_ID_COLOR);this._renderEdges(L.Transparency.TRANSPARENT,l);this._releaseGeometryLinearDepth(l);this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES);(q=q?this._renderTransparentTerrain():null)&&this._bindParameters.hudVisibility&&(d?this._renderLineCallouts(z.HUDRenderStyle.Occluded):g.compositeToHUDVisibility(this._bindParameters,q.getTexture()),this._renderHUD(z.HUDRenderStyle.Occluded,
g.color),this.performanceInfo.advance(m.PerformanceCategory.HUD_OCCLUDED));this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_TERRAIN);this._setTerrainCulling(!1);q&&(g.compositeToFramebuffer(this._bindParameters,q.getTexture(),E.AlphaMode.PremultipliedAlpha,1),q.release(),d&&(this._renderEdges(L.Transparency.OPAQUE),this.performanceInfo.advance(m.PerformanceCategory.OPAQUE_EDGES),this._needsTransparentPass&&(this._oitEnabled?this._renderOITPass(N.Geometry):this._renderTransparentMaterial()),
this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT),this._renderEdges(L.Transparency.TRANSPARENT),this.performanceInfo.advance(m.PerformanceCategory.TRANSPARENT_EDGES)));this._bindParameters.ssao=t.releaseMaybe(this._bindParameters.ssao);d&&this._renderLineCallouts(z.HUDRenderStyle.NotOccluded);this._setMultipassEnabled(!1);this._shadowAccumulator.render(this._bindParameters);g.bindFbo();this._plugins.render(c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._plugins.render(c.RenderSlot.ENVIRONMENT_TRANSPARENT);
this.performanceInfo.advance(m.PerformanceCategory.ENVIRONMENT);this._renderLaserlines();this.performanceInfo.advance(m.PerformanceCategory.LASER_LINES);this._renderOccluded();this.performanceInfo.advance(m.PerformanceCategory.OCCLUDED);(g=this._renderHighlightPrepass())&&this._renderShadowHighlights(g,this._bindParameters);d=this._magnifierEnabled&&e===C.RendererTarget.Default?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"magnifier"):null;q=e!==C.RendererTarget.Default?this.fboCache.acquire(this._offscreen.width,
this._offscreen.height,"screenshot"):null;l=this._renderComposite(d??q,g)??q;this.performanceInfo.advance(m.PerformanceCategory.ANTIALIASING);this._renderHUD(z.HUDRenderStyle.NotOccluded,l);this.performanceInfo.advance(m.PerformanceCategory.HUD);g&&(this._renderHighlights(l,g,this._bindParameters),g=t.releaseMaybe(g));this.performanceInfo.advance(m.PerformanceCategory.HIGHLIGHTS);this._magnifierEnabled&&this._magnifierHelper.render(this._rctx,this._bindParameters);l!==q&&(this._rctx.bindFramebuffer(q?.fbo),
this._compositingHelper.composite(this._bindParameters,d?.getTexture(),E.AlphaMode.None));e===C.RendererTarget.Default&&d?.release();if(this.onPostRender)this.onPostRender();this._releaseFBOs();this._offscreen.releaseBuffers();this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera);this._sliceHelper.plane=a;this._isRendering=!1;this.fboCache.frameEnd();this.performanceInfo.finishFrame();e!==C.RendererTarget.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers());return{screen:q,
oid:b}}_prepareShaders(a,b){this._renderContext.output=k.ShaderOutput.Color;this._prepareOpaqueGeometry();this._setMultipassTerrain(a);this._plugins.prepare(c.RenderSlot.TRANSPARENT_TERRAIN);this._setMultipassTerrain(!1);a||this._plugins.prepare(c.RenderSlot.LINE_CALLOUTS);b&&this._prepareTransparencySlots();this._plugins.prepare(c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL);this._plugins.prepare(c.RenderSlot.ENVIRONMENT_TRANSPARENT);this._plugins.prepare(c.RenderSlot.LASERLINES);this._rctx.gl.flush()}_renderObjectAndLayerIdColor(){if(O("enable-feature:objectAndLayerId-rendering")){var a=
this._renderContext.output,b=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oid");b.acquireDepth(u.DepthFormat.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(b.fbo);this.fboCache.rctx.clearFramebuffer([0,0,0,0],!0,!0);this._renderAllGeometry(k.ShaderOutput.ObjectAndLayerIdColor);this._rctx.bindFramebuffer(b.fbo);this.fboCache.rctx.clearFramebuffer(void 0,!0,!0);this._bindParameters.hudRenderStyle=z.HUDRenderStyle.NotOccluded;this._plugins.render(c.RenderSlot.HUD_MATERIAL);
this._renderContext.output=a;return b}}finish(a){this._hasAnimations||this._animationTimestep.clear();var b=this.performanceInfo.gpuSamplingEnabled;if((a=a===A.RenderRequestType.BACKGROUND)||b){const e=a?this.performanceInfo.elapsedTime:0;b=b?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();this._animationTimestep.frame(Math.max(e,b),a)}}readDepthPixels(a,b,e){var d=this._bindParameters.linearDepth?.fbo;d?.colorTexture?d.readPixels(b[0],b[1],b[2],b[3],x.PixelFormat.RGBA,x.PixelType.UNSIGNED_BYTE,
e):(d=this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"depth").acquireDepth(u.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(d.fbo),this._ensureBindParameters(a,a),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(x.ClearBufferBit.COLOR_BUFFER_BIT|x.ClearBufferBit.DEPTH_BUFFER_BIT|x.ClearBufferBit.STENCIL_BUFFER_BIT),this._renderAllGeometry(k.ShaderOutput.LinearDepth),d.fbo.readPixels(b[0],b[1],b[2],b[3],x.PixelFormat.RGBA,
x.PixelType.UNSIGNED_BYTE,e),d.release())}readHUDVisibility(a,b,e,d,g){this._bindParameters.hudVisibility?.fbo.readPixels(a,b,e,d,x.PixelFormat.RGBA,x.PixelType.UNSIGNED_BYTE,g)}readAccumulatedShadow(a){return this._shadowAccumulator.readAccumulatedShadow(a[0],a[1])}_setMultipassTerrain(a){this._setMultipassEnabled(a);this._setTerrainCulling(a)}_setMultipassEnabled(a){this._bindParameters.multipassEnabled=a}_setTerrainCulling(a){this._bindParameters.multipassTerrain.cullAboveGround=a}_renderEdges(a,
b){const e=this._edgeView;if(e?.shouldRender()){const {width:d,height:g,depth:p}=this._offscreen,h=this.fboCache.acquire(d,g,"edges");this._offscreen.renderToTargets(()=>e.render(this._bindParameters,a),h,b??p,V);this._offscreen.compositeToFramebuffer(this._bindParameters,h.getTexture(),E.AlphaMode.Alpha,1);h.release()}}_renderShadowMap(a,b,e){const d=this._shadowMap;d.enabled&&(d.start(a,b,e,this.isFeatureEnabled(D.RenderFeature.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),
this._shadowHighlight.updateParameters(a,b),this._needsShadowHighlight?(this._renderShadowCascades(k.ShaderOutput.ShadowHighlight,this._shadowMap),d.moveSnapshot(R.SnapshotSlot.Highlight),this._renderShadowCascades(k.ShaderOutput.ShadowExcludeHighlight,this._shadowMap),d.copySnapshot(R.SnapshotSlot.ExcludeHighlight),this._renderShadowCascades(k.ShaderOutput.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(k.ShaderOutput.Shadow),d.finish(),a.setGLViewport(this._rctx))}_renderShadowCascades(a,
b=this._shadowMap){for(const e of b.cascades)e.camera.setGLViewport(this._rctx),this._prepare(e.camera,e.camera),this._renderAllGeometry(a)}get _needsLinearDepth(){return this._plugins.consumes(k.ShaderOutput.LinearDepth)||!!this._nodes.require("linear-depth")||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast||this._debugLinearDepth}_renderLinearDepth(){this._needsLinearDepth?(this._bindParameters.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.linearDepth,
"linear-depth",()=>this._renderAllGeometry(k.ShaderOutput.LinearDepth),[0,0,0,0],u.ColorFormat.RGBA,u.DepthFormat.DEPTH_STENCIL_TEXTURE),this._bindParameters.linearDepth.detachDepth()):this._bindParameters.linearDepth=t.releaseMaybe(this._bindParameters.linearDepth)}_renderTerrainLinearDepth(a){a?(a=this._renderContext.output,this._renderContext.output=k.ShaderOutput.LinearDepth,this._bindParameters.multipassTerrain.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassTerrain.linearDepth,
"terrain depth",()=>this._renderTransparentTerrain(),[-1E10,-1E10,-1E10,1]),this._bindParameters.multipassTerrain.linearDepth.detachDepth(),this._renderContext.output=a):this._bindParameters.multipassTerrain.linearDepth=t.releaseMaybe(this._bindParameters.multipassTerrain.linearDepth)}_renderGeometryLinearDepth(a){if(a)return a=this._renderContext.output,this._bindParameters.multipassGeometry.linearDepth=this._offscreen.renderToCachedFBO(this._bindParameters.multipassGeometry.linearDepth,"geometry depth",
()=>this._renderOpaqueGeometryAndTransparentMaterial(k.ShaderOutput.LinearDepth),[1,1,1,1],u.ColorFormat.RGBA,this._geometryLinearDepthFormat),this._renderContext.output=a,a=this._bindParameters.multipassGeometry.linearDepth.depth,a?.retain(),this._bindParameters.multipassGeometry.linearDepth.detachDepth(),a;this._bindParameters.multipassGeometry.linearDepth=t.releaseMaybe(this._bindParameters.multipassGeometry.linearDepth)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(a){if(!this._needsDepthRange)return T.zero;
const b=ra.depthRangeFromScene(a,this._plugins.plugins,this._stage.layers);T.union(b,this._plugins.queryDepthRange(a));b.near=Math.max(a.near,b.near);b.far=Math.min(a.far,b.far);return b}_renderNormals(){let a=(this._plugins.produces(c.RenderSlot.SSAO)?1:0)+this._nodes.require("normals");if(0!==a){for(var b=this._offscreen.renderToCachedFBO(null,"normals",()=>this._renderGeometryForSSAO(k.ShaderOutput.Normal),[0,0,0,0],u.ColorFormat.RGBA,u.DepthFormat.DEPTH_STENCIL_TEXTURE);0<--a;)b.retain();return b}}_renderSSAO(){const a=
this._pluginInput.get("normals");this._plugins.produces(c.RenderSlot.SSAO)&&a&&(this._bindParameters.ssao=this._plugins.render(c.RenderSlot.SSAO,this._pluginInput),a.detachDepth(),a.release()&&this._pluginInput.delete("normals"))}_renderAllGeometry(a){this._renderContext.output=a;this._plugins.prepare(c.RenderSlot.TRANSPARENT_TERRAIN);this._renderOpaqueGeometryAndTransparentMaterial(a);this._renderTransparentTerrain()}_renderOpaqueGeometryAndTransparentMaterial(a){this._renderContext.output=a;this._plugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);
this._plugins.prepare(c.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH);this._renderOpaqueGeometry();this._renderTransparentMaterial()}_renderGeometryForSSAO(a){this._renderContext.output=a;this._plugins.render(c.RenderSlot.INTEGRATED_MESH);this._plugins.render(c.RenderSlot.OPAQUE_TERRAIN);this._plugins.render(c.RenderSlot.OPAQUE_MATERIAL);this._plugins.render(c.RenderSlot.TRANSPARENT_MATERIAL);this._renderTransparentTerrain()}_prepareOpaqueGeometry(){this._plugins.prepare(c.RenderSlot.INTEGRATED_MESH);this._plugins.prepare(c.RenderSlot.OPAQUE_TERRAIN);
this._plugins.prepare(c.RenderSlot.OPAQUE_MATERIAL);this._plugins.prepare(c.RenderSlot.OPAQUE_NO_SSAO_DEPTH);this._plugins.prepare(c.RenderSlot.ENVIRONMENT_OPAQUE)}_renderOpaqueGeometry(){this._plugins.render(c.RenderSlot.INTEGRATED_MESH);this._plugins.render(c.RenderSlot.OPAQUE_TERRAIN);this._plugins.render(c.RenderSlot.OPAQUE_MATERIAL);this._plugins.render(c.RenderSlot.OPAQUE_NO_SSAO_DEPTH)}_renderTransparentMaterial(){this._plugins.render(c.RenderSlot.TRANSPARENT_MATERIAL);this._plugins.render(c.RenderSlot.TRANSPARENT_NO_SSAO_DEPTH)}_renderTransparentTerrain(){if(this._plugins.produces(c.RenderSlot.TRANSPARENT_TERRAIN)){var a=
()=>this._plugins.render(c.RenderSlot.TRANSPARENT_TERRAIN,null);if(this._renderContext.output!==k.ShaderOutput.Color)a();else{var {width:b,height:e,depth:d}=this._offscreen,g=this.fboCache.acquire(b,e,"transparent terrain");this._offscreen.renderToTargets(a,g,d,[0,0,0,0]);return g}}}_renderHUDVisibility(a){this._plugins.produces(c.RenderSlot.OCCLUSION_PIXELS)?(this._bindParameters.hudVisibility=this._offscreen.renderHUDVisibility(this._bindParameters.hudVisibility,()=>this._plugins.render(c.RenderSlot.OCCLUSION_PIXELS),
a),this._offscreen.bindFbo()):this._bindParameters.hudVisibility=t.releaseMaybe(this._bindParameters.hudVisibility)}_renderLineCallouts(a){this._bindParameters.hudRenderStyle=a;if(a===z.HUDRenderStyle.Occluded){const {width:b,height:e,color:d}=this._offscreen;a=this.fboCache.acquireDepth(u.DepthFormat.DEPTH16_BUFFER,b,e,"line callouts");this._offscreen.renderToTargets(()=>{this._plugins.render(c.RenderSlot.LINE_CALLOUTS)},d,a,void 0,!0,!0);a.release()}else this._plugins.render(c.RenderSlot.LINE_CALLOUTS)}_renderLaserlines(){this._plugins.render(c.RenderSlot.LASERLINES);
if(this._plugins.produces(c.RenderSlot.LASERLINES_CONTRAST_CONTROL)){const a=this._offscreen,{width:b,height:e,depth:d}=a,g=this.fboCache.acquire(b,e,"laser lines");a.renderToTargets(()=>this._plugins.render(c.RenderSlot.LASERLINES_CONTRAST_CONTROL),g,d,V);a.compositeToFramebuffer(this._bindParameters,g.getTexture(),E.AlphaMode.PremultipliedAlpha,1);g.release()}}_renderHUD(a,b){if(this._pluginsHas.hudElements)if(this._oitEnabled){const e=this._renderOITPass(N.HUD,a);this._rctx.bindFramebuffer(b?.fbo);
this._compositingHelper.composite(this._bindParameters,e.getTexture(),E.AlphaMode.PremultipliedAlpha);e.release()}else if(a===z.HUDRenderStyle.Occluded){const {width:e,height:d,color:g}=this._offscreen;b=this.fboCache.acquireDepth(u.DepthFormat.DEPTH16_BUFFER,e,d,"hud");this._offscreen.renderToTargets(()=>this._renderHUDElements(a),g,b,void 0,!0,!0);b.release()}else this._rctx.bindFramebuffer(null),b?.acquireDepth(u.DepthFormat.DEPTH16_BUFFER),this._rctx.bindFramebuffer(b?.fbo),this._renderHUDElements(a),
b?.detachDepth()}_renderHUDElements(a){this._bindParameters.hudRenderStyle=a;this._plugins.prepare(c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._plugins.prepare(c.RenderSlot.HUD_MATERIAL);this._plugins.prepare(c.RenderSlot.LABEL_MATERIAL);this._plugins.render(c.RenderSlot.LINE_CALLOUTS_HUD_DEPTH);this._plugins.render(c.RenderSlot.HUD_MATERIAL);this._plugins.render(c.RenderSlot.LABEL_MATERIAL)}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._plugins.produces(c.RenderSlot.SHADOW_HIGHLIGHT)&&
this._plugins.produces(c.RenderSlot.OPAQUE_MATERIAL,k.ShaderOutput.ShadowHighlight)}_renderHighlightPrepass(){if(this.hasHighlights){var a=this._offscreen.renderToCachedFBO(null,"highlight",()=>{this._renderAllGeometry(k.ShaderOutput.Highlight);this._rctx.clearSafe(x.ClearBufferBit.DEPTH_BUFFER_BIT);this._renderHUDElements(z.HUDRenderStyle.Both)},[0,0,0,0],u.ColorFormat.RGBA4,u.DepthFormat.DEPTH_STENCIL_TEXTURE);a.detachDepth();return a}}_renderShadowHighlights(a,b){this.hasHighlights&&b.decorations!==
A.Decorations.OFF&&this._needsShadowHighlight&&this._offscreen.updateColor(e=>{this._pluginInput.set("highlight",a);this._plugins.render(c.RenderSlot.SHADOW_HIGHLIGHT,this._pluginInput,e);return e},"transparent-color")}_renderHighlights(a,b,e){this.hasHighlights&&e.decorations!==A.Decorations.OFF&&(this._pluginInput.set("highlight",b),this._plugins.produces(c.RenderSlot.HIGHLIGHT)&&this._plugins.render(c.RenderSlot.HIGHLIGHT,this._pluginInput,a))}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_renderShadowAccumulation(a,
b,e){this._needsShadowCast&&this._bindParameters.linearDepth?.getTexture()&&this._shadowAccumulator.renderAccumulation(this._bindParameters.linearDepth,a,b,e)}_prepareTransparencySlots(){this._renderContext.output=k.ShaderOutput.Alpha;this._bindParameters.transparencyPassType=v.TransparencyPassType.Alpha;this._plugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._renderContext.output=k.ShaderOutput.Color;this._bindParameters.transparencyPassType=v.TransparencyPassType.Color;this._plugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);
this._bindParameters.transparencyPassType=v.TransparencyPassType.FrontFace;this._plugins.prepare(c.RenderSlot.TRANSPARENT_MATERIAL);this._bindParameters.transparencyPassType=v.TransparencyPassType.NONE}_renderOITPass(a,b=z.HUDRenderStyle.Both){var e=a===N.HUD;a=e?this.fboCache.acquire(this._offscreen.width,this._offscreen.height,"oit hud composite"):null;const d=e?()=>this._renderHUDElements(b):()=>this._renderTransparentMaterial(),g=this._renderContext.output;this._renderContext.output=k.ShaderOutput.Alpha;
this._bindParameters.transparencyPassType=v.TransparencyPassType.Alpha;const p=this._offscreen.renderOITPass(d,v.TransparencyPassType.Alpha,e);this._renderContext.output=k.ShaderOutput.Color;this._bindParameters.transparencyPassType=v.TransparencyPassType.Color;const h=this._offscreen.renderOITPass(d,v.TransparencyPassType.Color,e);this._bindParameters.transparencyPassType=v.TransparencyPassType.FrontFace;e=this._offscreen.renderOITPass(d,v.TransparencyPassType.FrontFace,e);this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,
h,p,e,a);a?.detachDepth();e.release();h.release();p.release();this._bindParameters.transparencyPassType=v.TransparencyPassType.NONE;this._renderContext.output=g;return a}_renderOccluded(){let a=0;w.clear();this._plugins.plugins.forAll(h=>{h.materialReference&&h.queryRenderOccludedState(r.RenderOccludedFlag.OccludeAndTransparentStencil)&&(a|=r.RenderOccludedFlag.OccludeAndTransparentStencil,w.push(h))});const b=this._offscreen,e=(h,n,f,l,q)=>{if(0!==(a&n)){var {width:M,height:za,depth:Aa}=b;n=this.fboCache.acquire(M,
za,"tmp color");b.renderToTargets(f,n,Aa,[0,0,0,0],l,q);b.compositeToFramebuffer(this._bindParameters,n.getTexture(),E.AlphaMode.PremultipliedAlpha,h);n.release()}},d=(h,n)=>{this._bindParameters.slot=h;n.forAll(f=>{if(ia.isPrepareRenderPlugin(f)){const l=f.prepareTechnique(this._renderContext);l&&f.renderNode(this._renderContext,l)}})};0!==w.length&&(d(c.RenderSlot.OCCLUDER_MATERIAL,w),e(.5,r.RenderOccludedFlag.OccludeAndTransparentStencil,()=>d(c.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,w),!1,!1));
w.clear();this._plugins.plugins.forAll(h=>{if(h.materialReference){var n=h.queryRenderOccludedState(r.RenderOccludedFlag.OccludeAndTransparent),f=h.queryRenderOccludedState(r.RenderOccludedFlag.Transparent),l=h.queryRenderOccludedState(r.RenderOccludedFlag.Opaque);if(n||f||l)a|=n?r.RenderOccludedFlag.OccludeAndTransparent:f?r.RenderOccludedFlag.Transparent:r.RenderOccludedFlag.Opaque,w.push(h)}});const g=this._plugins.renderOccludedFlags;if(a|=g){var p=h=>{this._renderContext.renderOccludedMask=h;
g>r.RenderOccludedFlag.Occlude&&this._plugins.render(c.RenderSlot.OCCLUDED_TERRAIN);d(c.RenderSlot.OPAQUE_MATERIAL,w);d(c.RenderSlot.TRANSPARENT_MATERIAL,w);d(c.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,w);this._renderContext.renderOccludedMask=U.defaultRenderOccludedMask};this._renderContext.output=k.ShaderOutput.Color;e(.5,r.RenderOccludedFlag.OccludeAndTransparent,()=>p(r.RenderOccludedFlag.OccludeAndTransparent),!0,A.StencilBits.OutlineVisualElementMask);e(.5,r.RenderOccludedFlag.Transparent,
()=>p(r.RenderOccludedFlag.Transparent),!0,A.StencilBits.OutlineVisualElementMask);e(1,r.RenderOccludedFlag.Opaque,()=>p(r.RenderOccludedFlag.Opaque),!0,A.StencilBits.OutlineVisualElementMask);w.clear()}}_invokeRenderNodes(a){this._updatePluginInput();const b=this._nodes.render(a,this._pluginInput);this._releaseAfterRenderNode("normals",a.name);return b}_renderComposite(a,b){this._offscreen.updateColor(d=>{this._pluginInput.set("highlight",b);this._updatePluginInput();d=this._nodes.render(d,this._pluginInput);
this._pluginInput.set(d.name,d);this._pluginInput.delete("highlight");this._releaseAfterRenderNode("normals","composite-color");return d},"composite-color");const e=this._plugins.produces(c.RenderSlot.ANTIALIASING);return this._plugins.render(e?c.RenderSlot.ANTIALIASING:c.RenderSlot.BLIT,this._pluginInput,a)}_releaseAfterRenderNode(a,b){const e=this._pluginInput.get(a);if(e)for(b=this._nodes.require(e.name,b);b--;)e.release()&&this._pluginInput.delete(a)}_updatePluginInput(){this._pluginInput.set("linear-depth",
this._bindParameters.linearDepth)}_prepare(a,b){this._needsTransparentPass=this._plugins.produces(c.RenderSlot.TRANSPARENT_MATERIAL,k.ShaderOutput.Color);this._bindParameters.camera=a;this._bindParameters.contentCamera=b}_ensureBindParameters(a,b){this._bindParameters.camera=a;this._bindParameters.contentCamera=b}_ensureBindParametersSSR(a){if(this._bindParameters.ssr.lastFrameColor){null==this._ssrEnableTime&&(this._ssrEnableTime=a);this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?
this._reprojectionMatrix=G.IDENTITY:(F.invert(W,this._bindParameters.camera.viewMatrix),F.invert(X,this._bindParameters.camera.projectionMatrix),F.multiply(I,W,X),F.multiply(I,this._renderContext.lastFrameCamera.viewMatrix,I),F.multiply(I,this._renderContext.lastFrameCamera.projectionMatrix,I),this._reprojectionMatrix=I);const b=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=0<b?Math.min(b,a-this._ssrEnableTime)/b:1;1>this._bindParameters.ssr.fadeFactor&&this._requestRender()}else this._reprojectionMatrix=
G.IDENTITY,this._ssrEnableTime=null}addRenderNode(a){this._nodes.add(a);this._requestRender()}removeRenderNode(a){this._nodes.remove(a);this._requestRender()}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}get test(){return{offscreen:this._offscreen,shadowMap:this._shadowMap,highlight:this._highlight,lighting:this._bindParameters.lighting,renderPlugins:this._plugins,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,
resetRenderStateFeatures:()=>{this._renderStateFeatures.value=D.setupFeatureDefaults();this._plugins.renderFeatureChanged();this._requestRender()},getFramebufferTexture:a=>{switch(a){case y.FramebufferId.Color:return this._offscreen.colorTexture;case y.FramebufferId.LinearDepth:return this._bindParameters.linearDepth?.getTexture();case y.FramebufferId.ShadowMap:return this._shadowMap.depthTexture;case y.FramebufferId.HudVisibility:return this._bindParameters.hudVisibility?.getTexture()}},debugLinearDepth:a=>
{this._debugLinearDepth=a;this._requestRender()}}}}J.__decorate([K.property({readOnly:!0})],H.prototype,"fullResolutionAtmosphere",null);J.__decorate([K.property()],H.prototype,"_smaa",void 0);J.__decorate([K.property()],H.prototype,"_blit",void 0);J.__decorate([K.property()],H.prototype,"_edgeView",void 0);J.__decorate([K.property()],H.prototype,"updating",null);var N;(function(a){a[a.Geometry=0]="Geometry";a[a.HUD=1]="HUD"})(N||={});y.FramebufferId=void 0;(function(a){a[a.Color=0]="Color";a[a.LinearDepth=
1]="LinearDepth";a[a.ShadowMap=2]="ShadowMap";a[a.HudVisibility=3]="HudVisibility"})(y.FramebufferId||(y.FramebufferId={}));const V=[0,0,0,0],w=new aa,X=G.create(),W=G.create(),I=G.create();y.Renderer=H;Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});