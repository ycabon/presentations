// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../core/libs/gl-matrix-2/factories/vec2f64 ../../../../chunks/sphere ../../terrain/Intersector ../core/shaderLibrary/ShaderOutput ./ChangeSet ./Intersector ./IntersectorInterfaces ./Material ./ModelDirtyTypes ./rendererUtils ./RenderSlot ../materials/renderers/MergedRenderer".split(" "),
function(g,h,w,q,l,J,K,L,x,y,z,A,r,B,C,n,D,m,E,t,F){function G(a,b,d,e,c,f,k){const u=new A.OverlayTarget(f,k,b);b=v=>{v.set(n.IntersectorType.OVERLAY,u,a.dist,a.normal,a.transformation,d,e)};(null==c.results.min.drapedLayerOrder||d>=c.results.min.drapedLayerOrder)&&(null==c.results.min.dist||c.results.ground.dist<=c.results.min.dist)&&b(c.results.min);c.options.store!==n.StoreResults.MIN&&(null==c.results.max.drapedLayerOrder||d<c.results.max.drapedLayerOrder)&&(null==c.results.max.dist||c.results.ground.dist>
c.results.max.dist)&&b(c.results.max);c.options.store===n.StoreResults.ALL&&(f=C.newIntersectorResult(c.ray),b(f),c.results.all.push(f))}g.SortedRenderGeometryRenderer=class extends w{constructor(a){super(a);this._pending=new H;this._changes=new B.ChangeSet;this._materialRenderers=new q;this._sortedMaterialRenderers=new q;this._geometries=new Map;this._hasWater=this._hasHighlights=!1}destroy(){this._changes.prune();this._materialRenderers.forAll(a=>a.destroy());this._materialRenderers.clear();this._sortedMaterialRenderers.clear();
this._geometries.clear();this._pending.clear()}get updating(){return!this._pending.empty||0<this._changes.updates.length}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return this._materialRenderers.some(a=>0!==a.numGeometries&&!a.queryRenderOccludedState(D.RenderOccludedFlag.Occlude))}get isEmpty(){return!this.updating&&
0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(a){return null==a?0:this._materialRenderers.find(b=>b.materialReference===a)?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();let a=!1;E.splitRenderGeometryChangeSetByMaterial(this._changes).forEach((b,d)=>{var e=this._materialRenderers.find(c=>c.materialReference===d);!e&&0<b.adds.length&&(e=new F.MergedRenderer({material:d}),e.initializeRenderContext(this.rendererContext.pluginContext,
this._materialRepository),this._materialRenderers.push(e),a=!0);e&&(e.modify(b),0===e.numGeometries&&(this._materialRenderers.removeUnordered(e),e.destroy(),a=!0))});this._changes.clear();a&&this._updateSortedMaterialRenderers();this._hasHighlights=this._materialRenderers.some(b=>(b=b.produces.get(t.RenderSlot.DRAPED_MATERIAL))?b(r.ShaderOutput.Highlight):!1);this._hasWater=this._materialRenderers.some(b=>(b=b.produces.get(t.RenderSlot.DRAPED_WATER))?b(r.ShaderOutput.Normal):!1);this.notifyChange("updating");
return!0}addGeometries(a,b){if(0!==a.length){var d=this._validateRenderGeometries(a);for(var e of d)this._geometries.set(e.id,e);e=this._pending.empty;for(const c of d)this._pending.adds.add(c);e&&this.notifyChange("updating");b===m.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(a)}}removeGeometries(a,b){const d=this._pending.empty,e=this._pending.adds;for(const c of a)e.has(c)?(this._pending.removed.add(c),e.delete(c)):this._pending.removed.has(c)||this._pending.removes.add(c),this._geometries.delete(c.id);
d&&!this._pending.empty&&this.notifyChange("updating");b===m.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(a)}modifyGeometries(a,b){const d=0===this._changes.updates.length;for(const e of a){const c=this._changes.updates.pushNew();c.renderGeometry=this._validateRenderGeometry(e);c.updateType=b}d&&0<this._changes.updates.length&&this.notifyChange("updating");switch(b){case m.DirtyState.TRANSFORMATION:case m.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(a);case m.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(a)}}updateAnimation(a){let b=
!1;this._sortedMaterialRenderers.forAll(d=>b=!!d.updateAnimation&&d.updateAnimation(a)||b);return b}shouldRender(a){return this._sortedMaterialRenderers.some(b=>b.prepareTechnique(a))}render(a){this._sortedMaterialRenderers.forAll(b=>{const d=b.prepareTechnique(a);null!=d&&b.renderNode(a,d)})}intersect(a,b,d,e,c){this._geometries.forEach(f=>{if(!e||e(f)){this._intersectRenderGeometry(f,d,b,0,a,c);var k=this.rendererContext.longitudeCyclical;k&&(f.boundingSphere[0]-f.boundingSphere[3]<k.min&&this._intersectRenderGeometry(f,
d,b,k.range,a,c),f.boundingSphere[0]+f.boundingSphere[3]>k.max&&this._intersectRenderGeometry(f,d,b,-k.range,a,c));c++}});return c}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();this._materialRenderers.forAll((a,b)=>{a.drapedPriority=b;this._sortedMaterialRenderers.push(a)});this._sortedMaterialRenderers.sort((a,b)=>b.materialReference?.renderPriority===a.materialReference?.renderPriority?a.drapedPriority-b.drapedPriority:(b.materialReference?.renderPriority||0)-(a.materialReference?.renderPriority||
0))}_processAddsRemoves(){this._changes.adds.clear();this._changes.removes.clear();this._changes.adds.pushArray(Array.from(this._pending.adds));this._changes.removes.pushArray(Array.from(this._pending.removes));for(let a=0;a<this._changes.updates.length;)this._pending.has(this._changes.updates.data[a].renderGeometry)?this._changes.updates.removeUnorderedIndex(a):a++;this._pending.clear()}_intersectRenderGeometry(a,b,d,e,c,f){if(a.visible){var k=0;e+=a.transformation[12];k=a.transformation[13];p[0]=
d[0]-e;p[1]=d[1]-k;a.screenToWorldRatio=this.rendererContext.screenToWorldRatio;a.material.intersectDraped(a,null,c,p,(u,v,I)=>{G(b,I,f,a.material.renderPriority,c,a.layerUid,a.graphicUid)},b)}}_notifyGraphicGeometryChanged(a){if(null!=this.drapeSource.notifyGraphicGeometryChanged)for(const d of a)if(a=d.graphicUid,null!=a&&a!==b){this.drapeSource.notifyGraphicGeometryChanged(a);var b=a}}_notifyGraphicVisibilityChanged(a){if(null!=this.drapeSource.notifyGraphicVisibilityChanged)for(const d of a)if(a=
d.graphicUid,null!=a&&a!==b){this.drapeSource.notifyGraphicVisibilityChanged(a);var b=a}}_validateRenderGeometries(a){for(const b of a)this._validateRenderGeometry(b);return a}_validateRenderGeometry(a){null==a.localOrigin&&(a.localOrigin=this._localOriginFactory.getOrigin(z.getCenter(a.boundingSphere)));return a}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0);h.__decorate([l.property()],
g.SortedRenderGeometryRenderer.prototype,"updating",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"rctx",null);h.__decorate([l.property({constructOnly:!0})],g.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_materialRepository",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null);h.__decorate([l.property({readOnly:!0})],g.SortedRenderGeometryRenderer.prototype,
"isEmpty",null);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_materialRenderers",void 0);h.__decorate([l.property()],g.SortedRenderGeometryRenderer.prototype,"_geometries",void 0);g.SortedRenderGeometryRenderer=h.__decorate([x.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],g.SortedRenderGeometryRenderer);class H{constructor(){this.adds=new Set;this.removes=new Set;this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&
0===this.removed.size}has(a){return this.adds.has(a)||this.removes.has(a)||this.removed.has(a)}clear(){this.adds.clear();this.removes.clear();this.removed.clear()}}const p=y.create();Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});