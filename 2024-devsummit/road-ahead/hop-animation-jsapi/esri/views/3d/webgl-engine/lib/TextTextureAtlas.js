// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/maybe ../../../../core/uid ../../../../core/accessorSupport/decorators/property ../../../../core/has ../../../../core/Logger ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec42 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ./ContentObjectType ./testUtils ./textureUtils ./VertexAttribute ../../../support/Scheduler ../../../support/Yield ../../../webgl/enums ../../../webgl/Texture ../../../webgl/TextureDescriptor".split(" "),
function(g,m,w,x,n,y,r,K,L,M,z,A,t,B,C,p,h,D,E,u,F,G){function q(a,b){a.geometries[0].setAttributeData(h.VertexAttribute.UV0,b.uv);a.geometryVertexAttributeUpdated(a.geometries[0],h.VertexAttribute.UV0,!0)}g.TextTextureAtlas=class extends w{constructor(a){super(a);this.type=B.ContentObjectType.Texture;this.id=y.generateUID();this.events=new x;this._glTexture=null;this._atlas=new H(256,256);this._needsRepack=!1;this._canRepack=!0;this._elementsToRender=new Map;this._elements=new Map;this._stageObjects=
new Map;this.updating=!1}initialize(){this._canvas=document.createElement("canvas");this._canvas.setAttribute("id","textAtlasCanvas");this._canvas.setAttribute("style","display:none");this._ctx=this._canvas.getContext("2d");this._stage=this.view._stage;this._stage.add(this);this._updateCanvasElementSize(this._atlas);this._reset()}unload(){this._glTexture=n.disposeMaybe(this._glTexture);this.updating=!1;this.events.emit("unloaded")}get glTexture(){return this._glTexture}static get maxSize(){l=C.textTextureAtlas.stableRendering?
2:0;return[4094-l,4094-l-2]}load(a){if(this._glTexture)return this._glTexture;const b=new G.TextureDescriptor;b.wrapMode=u.TextureWrapMode.CLAMP_TO_EDGE;b.samplingMode=u.TextureSamplingMode.LINEAR_MIPMAP_LINEAR;b.hasMipmap=!0;b.preMultiplyAlpha=!0;b.maxAnisotropy=a.parameters.maxMaxAnisotropy;this._glTexture=new F.Texture(a,b,this._canvas);this._frameWorker=this.view.resourceController.scheduler.registerTask(D.TaskPriority.TEXT_TEXTURE_ATLAS,this);this.setDirty();return this._glTexture}dispose(){this._elements.clear();
this._elementsToRender.clear();this._frameWorker=n.removeMaybe(this._frameWorker);this._glTexture&&(this._stage.remove(this),this._glTexture=n.disposeMaybe(this._glTexture));this._canvas.width=0;this._canvas.height=0;this._ctx=this._canvas=null}_updateCanvasElementSize(a){this._canvas.setAttribute("width",a.width.toString());this._canvas.setAttribute("height",a.height.toString())}_resizeAtlas(a,b){const {width:c,height:e}=this._atlas;if(c!==a||e!==b)this._atlas.width=a,this._atlas.height=b,this._glTexture?.resize(a,
b),this._glTexture?.updateData(0,0,0,c,e,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(d=>{this._stageObjects.get(d.textRenderer.key)?.forEach(f=>q(f,d))}),this._reset()}_reset(){this._elementsToRender.clear();this._atlas.reset();this._needsRepack=!0;this.setDirty()}_addAtlasElement(a,b,c,e){const d=this._atlas;if(d.width<c||d.height<e)return!1;let f=d.cursors.get(e);if(!f){if(d.height<d.nextY+e)return!1;f=[new v(d.nextY)];d.cursors.set(e,f);d.nextY+=e}let k=f.find(I=>
d.width>=I.x+c);if(null==k){if(d.height<d.nextY+e)return!1;k=new v(d.nextY);d.nextY+=e;f.push(k)}a.setNewPosition(k);this._elements.set(b,a);this._elementsToRender.set(b,a);k.x+=c;return!0}_ensureStageObjects(a){var b=this._stageObjects.get(a);if(b)return b;b=new Set;this._stageObjects.set(a,b);return b}_addStageObject(a,b){this._ensureStageObjects(a).add(b)}_removeStageObject(a,b){this._stageObjects.get(a)?.delete(b)&&(b.geometries[0].setAttributeData(h.VertexAttribute.SIZE,[0,0]),b.geometryVertexAttributeUpdated(b.geometries[0],
h.VertexAttribute.SIZE),this._elementsToRender.delete(a))}_processAddition(a){const b=a.textRenderer.key;if(this._needsRepack)this._elements.set(b,a);else{var c=this._atlas,e=a.textRenderer.renderedWidth+2,d=a.textRenderer.renderedHeight+2+2;this._addAtlasElement(a,b,e,d)||(this._canRepack?this._reset():c.width<e?(e=Math.min(p.applyTextureResizeModulo(Math.max(e,1.5*c.width)),4096),this._resizeAtlas(e,c.height)):(e=Math.min(p.applyTextureResizeModulo(Math.max(c.nextY+d,1.5*c.height)),4096),e>c.height?
this._resizeAtlas(c.width,e):4096>c.width&&(e=Math.min(p.applyTextureResizeModulo(1.5*c.width),4096),this._resizeAtlas(e,c.height))),this._elements.set(b,a))}}_renderElement(a){const b=a.commitNewPosition();this._ctx.clearRect(b[0]-2,b[1]-2,a.textRenderer.renderedWidth+4,a.textRenderer.renderedHeight+4);a.textRenderer.render(this._ctx,b[0],b[1]);this._stageObjects.get(a.textRenderer.key)?.forEach(c=>q(c,a))}get running(){return this.updating}runTask(a){if(null==this._glTexture)return E.Yield;for(;this._needsRepack&&
(this._canRepack||4096>this._atlas.height&&4096>this._atlas.height);){this._canRepack=this._needsRepack=!1;const b=this._elements;this._elements=new Map;b.forEach(c=>this._processAddition(c));a.madeProgress()}if(0<this._elementsToRender.size){for(const [b,c]of this._elementsToRender){if(a.done)break;this._renderElement(c);this._elementsToRender.delete(b);a.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=0<this._elementsToRender.size}addTextTexture(a,b){var c=a.key;this._addStageObject(c,
b);c=this._elements.get(c);null==c&&(c=new J(this._atlas,a),this._processAddition(c),this.setDirty());b.geometries[0].setAttributeData(h.VertexAttribute.SIZE,[c.textRenderer.displayWidth,c.textRenderer.displayHeight]);b.geometryVertexAttributeUpdated(b.geometries[0],h.VertexAttribute.SIZE);q(b,c)}removeTextTexture(a,b){a=a.key;this._elements.get(a)&&(this._removeStageObject(a,b),(b=this._stageObjects.get(a))&&0!==b.size||this._elements.delete(a),0===b?.size&&this._stageObjects.delete(a),this._canRepack=
!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){const {_elements:a,_stageObjects:b,_atlas:c}=this,e=this;return{elements:a,stageObjects:b,atlas:c,resizeAtlas:(d,f)=>e._resizeAtlas(d,f),run:d=>e.runTask(d)}}};m.__decorate([r.property({constructOnly:!0})],g.TextTextureAtlas.prototype,"view",void 0);m.__decorate([r.property({type:Boolean})],g.TextTextureAtlas.prototype,"updating",void 0);g.TextTextureAtlas=m.__decorate([z.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],g.TextTextureAtlas);
class J{constructor(a,b){this._atlas=a;this.textRenderer=b;this._uv=t.create();this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return t.ZEROS;const {renderedWidth:a,renderedHeight:b}=this.textRenderer;return A.set(this._uv,this._xOffset/this._atlas.width,(this._yOffset+b)/this._atlas.height,(this._xOffset+a)/this._atlas.width,this._yOffset/this._atlas.height)}setNewPosition(a){this._newPosition[0]=a.x;this._newPosition[1]=a.y}commitNewPosition(){this._xOffset=this._newPosition[0];
this._yOffset=this._newPosition[1];return this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class H{constructor(a,b){this.width=a;this.height=b;this.cursors=new Map;this.nextY=0}reset(){this.cursors.clear();this.nextY=l}}class v{constructor(a){this.y=a;this.x=l}}let l=0;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});