// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f32 ../../../../../chunks/vec32 ../../../support/debugFlags ../../core/util/TwoVectorPosition ./EdgeShaderParameters ./EdgeShaderTechnique ./EdgeShaderTechniqueConfiguration ./interfaces ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/enums".split(" "),function(g,q,h,m,r,t,u,v,w,x,y,c,l,z){const A={type:"uber",
hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},B={solid:l.EdgeUtilMode.SOLID,sketch:l.EdgeUtilMode.SKETCH,uber:l.EdgeUtilMode.MIXED};class n{constructor(b,a,d){this._rctx=b;this._shaderTechniqueRepository=a;this._configuration=new y.EdgeShaderTechniqueConfiguration;this.refCount=0;this._renderables=new Set;this._sortedRenderables={[c.Transparency.TRANSPARENT]:{[c.Transparency.TRANSPARENT]:new h,[c.Transparency.OPAQUE]:new h},[c.Transparency.OPAQUE]:{[c.Transparency.TRANSPARENT]:new h,
[c.Transparency.OPAQUE]:new h}};this._renderablesDirty=!1;this._drawParameters=new w.EdgeDrawParameters;this._settings={...A,...d};this.key=n.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);this.writerSettings={variants:this._settings.strokesTexture.variants,reducedPrecision:u.debugFlags.TESTS_DISABLE_OPTIMIZATIONS};this._configuration.legacy=this._settings.legacy;this._configuration.mode=B[this._settings.type];this._configuration.silhouette=!1;this._configuration.antialiasing=
!!this._rctx.capabilities.blendMinMax;this._configuration.hasSlicePlane=this._settings.hasSlicePlane;this._configuration.doublePrecisionRequiresObfuscation=b.driverTest.doublePrecisionRequiresObfuscation.result;this._configuration.spherical=d.spherical}dispose(){this._technique=q.releaseMaybe(this._technique)}addRenderable(b){this._renderables.add(b);this._renderablesDirty=!0}removeRenderable(b){this._renderables.delete(b);this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(b,
a){this._renderablesDirty&&this._sortRenderables();a=this._sortedRenderables[a];a[c.Transparency.TRANSPARENT].forAll(b);a[c.Transparency.OPAQUE].forAll(b)}updateTechnique(b,a){this._configuration.multipassEnabled=!!b.multipassEnabled;this._configuration.cullAboveGround=!!b.multipassTerrain.cullAboveGround;this._configuration.silhouette=a;return this._technique=this._shaderTechniqueRepository.releaseAndAcquire(x.EdgeShaderTechnique,this._configuration,this._technique)}bindRegularEdges(b,a){this._lastOriginId=
null;return this._rctx.bindTechnique(this.updateTechnique(a,!1),a,b)}bindSilhouetteEdges(b,a){this._lastOriginId=null;return this._rctx.bindTechnique(this.updateTechnique(a,!0),a,b)}renderRegularEdges(b,a,d,e,f){this._render(b,a,a.regular.vao,d,e,f)}renderSilhouetteEdges(b,a,d,e,f){this._render(b,a,a.silhouette.vao,d,e,f)}_render(b,a,d,e,f,k){0<k&&(this._bindDraw(b,a,e,f),this._rctx.bindVAO(d),this._rctx.drawArraysInstanced(z.PrimitiveType.TRIANGLE_FAN,0,4,k))}_bindDraw(b,a,d,e){this._drawParameters.componentDataTexture=
a.components.buffer.textureBuffer.texture;this._drawParameters.strokesTexture=this._settings.strokesTexture;if("origin"in a.transform)this._lastOriginId!==a.transform.origin.origin.id&&(b.setUniformMatrix4fv("localView",a.transform.origin.viewMatrix),this._lastOriginId=a.transform.origin.origin.id),b.setUniformMatrix4fv("model",a.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=a.transform.origin.origin.vec3;else{const f=new v.TwoVectorPosition(a.transform.position),k=m.transpose(p,
m.invert(p,a.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=f.low;this._drawParameters.transformWorldFromModelTH=f.high;this._drawParameters.transformWorldFromModelRS=a.transform.rotationScale;this._drawParameters.transformNormalGlobalFromModel=k;a=e.camera.viewInverseTransposeMatrix;t.set(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11])}b.bindDraw(this._drawParameters,e,d)}_sortRenderables(){this._renderablesDirty=!1;this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.TRANSPARENT].clear();
this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.OPAQUE].clear();this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.TRANSPARENT].clear();this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.OPAQUE].clear();this._renderables.forEach(a=>{a.objectTransparency!==c.Transparency.INVISIBLE&&a.edgeTransparency!==c.Transparency.INVISIBLE&&this._sortedRenderables[a.objectTransparency][a.edgeTransparency].push(a)});const b=(a,d)=>"origin"in a.transform?"origin"in d.transform?
a.transform.origin.origin.id<d.transform.origin.origin.id?-1:a.transform.origin.origin.id>d.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.TRANSPARENT].sort(b);this._sortedRenderables[c.Transparency.TRANSPARENT][c.Transparency.OPAQUE].sort(b);this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.TRANSPARENT].sort(b);this._sortedRenderables[c.Transparency.OPAQUE][c.Transparency.OPAQUE].sort(b)}static getKey(b,a,d){return`edges-t:${b}:${a}:${d}`}}
const p=r.create();g.EdgeRenderer=n;g.extensionLengthOffset=128;g.lineWidthFractionFactor=8;Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});