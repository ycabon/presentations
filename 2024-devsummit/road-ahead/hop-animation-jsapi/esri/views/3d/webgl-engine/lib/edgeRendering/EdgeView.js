// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat3 ../../../../../core/libs/gl-matrix-2/factories/mat3f64 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../core/support/UpdatingHandles ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../Attribute ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(p,t,X,L,Y,M,H,u,za,Z,I,aa,J,x,C,ba,N,ca,da,ea,fa,ha,ia,ja,ka,la,ma,K,y,O,P,w,na,oa,Q,pa,v,qa,z,R,S){function T(a){null!=a&&(a.vao.vertexBuffers.instances.dispose(),a.vao.disposeVAOOnly(),a.vao=null)}function ra(a){let b=null,c=null;for(let d=0;d<a.geometries.length;d++){const e=a.geometries[d];if(e.material.supportsEdges){if(!b)b=e.transformation;else if(!L.equals(b,e.transformation))return!1;if(!c&&null!=e.localOrigin)c=e;else if(null!=c?.localOrigin&&null!=e.localOrigin&&c.localOrigin.id!==
e.localOrigin.id)return!1}}return!0}function D(a,b,c){b*=c;c=L.binaryIndexOf(a,b,!0);return-1===c?b<a[0]?a.length:0:a.length-c}p.EdgeView=class extends X{constructor(a){super(a);this._updatingHandles=new ba.UpdatingHandles;this._perObjectData=new Map;this._perObjectDataEvictionCache=new Set;this._renderers=new Map;this._gpuMemoryUsage=0;this._workerAbort=new AbortController;this._tmpModelPosition=C.create();this._localOrigins=new ka.LocalOriginManager(new ia.GridLocalOriginFactory(a.renderSR))}initialize(){this._worker=
new oa.EdgeWorkerHandle(this.schedule);this._componentColorManager=new qa.BufferManager(this.rctx,3);const a=y.VertexLayout.createBuffer(4);for(let b=0;4>b;b++)a.sideness.set(b,0,0===b||3===b?0:1),a.sideness.set(b,1,0===b||1===b?0:1);this._verticesBufferObject=R.BufferObject.createVertex(this.rctx,S.Usage.STATIC_DRAW,a.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(a=>this._discardObjectEntry(a)),this._perObjectData.clear(),this._strokesTexture=H.disposeMaybe(this._strokesTexture),
this._componentColorManager=H.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=H.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",sa))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return 0<this._renderers.size}async addComponentObject(a,b,c,d,e,f){if(this.hasObject(a))return this.getObjectMemoryUsage(a);
let g;const h=new U(new Promise(k=>g=k),a.obb.center,a.obb.radius);this._perObjectData.set(a,h);a=await this._updatingHandles.addPromise(this._addComponentGeometry(a.transform,h,b,c,d,e,f));this.setNeedsRender();g();return a}async addOrUpdateObject3D(a,b,c,d){if(this.destroyed)Y.getLogger(this).warn("Attempt to add an object to a destroyed instance");else{var e=this._perObjectData.get(a);0<e?.renderables.length&&this._perObjectDataEvictionCache.add(e);var f,g=a.boundingVolumeWorldSpace.bounds;g=new U(new Promise(k=>
f=k),N.getCenter(g),N.getRadius(g));this._perObjectData.set(a,g);var h=[];if(c.mergeGeometries&&1<a.geometries.length&&ra(a))h.push(this._addObjectMergedGeometries(a,g,b,c,d));else for(let k=0;k<a.geometries.length;k++){const l=a.geometries[k];l.material.supportsEdges&&h.push(this._addGeometry(a,g,l,b[0],c,d))}await this._updatingHandles.addPromise(Promise.all(h));this._perObjectDataEvictionCache.delete(g);this._discardObjectEntry(e);this.setNeedsRender();f()}}fastUpdateObject3DEdgesTransform(a){if(this.destroyed)return!1;
var b=this._perObjectData.get(a);if(!b)return!1;var {geometries:c}=a;({renderables:b}=b);if(0===c.length||0===b.length)return!0;if(1<b.length)return!1;[b]=b;var d=b.transform;if(!(d instanceof E))return!1;[c]=c;if(c.localOrigin!==d.origin.origin)return!1;d=J.create();a=this._computeModelTransformWithLocalOrigin(a,c,d);b.transform=new E(d,a);this.setNeedsRender();return!0}_discardObjectEntry(a){a&&(a.renderables.length&&(a.renderables.forEach(b=>this._removeRenderable(b)),this.setNeedsRender()),a.loaded=
null)}hasObject(a){return this._perObjectData.has(a)}async updateAllComponentOpacities(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));if(null!=a){var c=b instanceof Array?d=>b[d]:()=>b;a.renderables.forEach(d=>{const e=d.components.meta.length;for(let f=0;f<e;f++){const g=c(f),h=d.components.meta[f],k=h.index;h.material.opacity=g;d.components.buffer.textureBuffer.setDataElement(k,1,3,255*g)}this._updateTransparency(d)});this.setNeedsRender()}}async getObjectMemoryUsage(a){a=
await this._getObjectEntry(a);return null!=a?a.renderables.reduce((b,c)=>b+c.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(a,b,c,d){const e=a instanceof la.Object3D,f=!!c.hasSlicePlane,g=v.determineRendererType(b),h=w.EdgeRenderer.getKey(g,f,e);a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(k=>{if(h!==k.rendererKey){var l=this._renderers.get(k.rendererKey);const m=this._acquireRenderer(g,f,e);l.removeRenderable(k);--l.refCount;
k.rendererKey=h;m.addRenderable(k)}for(l=0;l<b.length;l++)k.components.meta[l].material=b[l];d&&this._updateComponentBuffer(k.components);this._updateTransparency(k)}),this.setNeedsRender())}async updateAllVerticalOffsets(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(c=>{const d=c.components.meta;for(let e=0;e<d.length;e++)c.components.meta[e].verticalOffset=b?.[e]??0;this._updateComponentBuffer(c.components)}),this.setNeedsRender())}async updateObjectVisibility(a,
b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));null!=a&&(a.renderables.forEach(c=>c.visible=b),this.setNeedsRender())}removeObject(a){const b=this._perObjectData.get(a);b&&(this._perObjectData.delete(a),this._discardObjectEntry(b))}async _getObjectEntry(a){a=this._perObjectData.get(a);if(!a)throw Error("no object");await a.loaded;return null==a.loaded?null:a}render(a,b){if(null!=this._componentColorManager){this._localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,
d=C.create(),e=new fa.TwoVectorPosition,f=0,g=0;this._renderers.forEach(k=>{if(0===k.refCount)this._renderers.delete(k.key),k.dispose();else{var l=!0,m=!0;k.forEachRenderable(n=>{n.visible&&(f+=n.statistics.averageEdgeLength,g++,l&&n.regular&&(k.updateTechnique(a,!1),l=!1),m&&n.silhouette&&(k.updateTechnique(a,!0),m=!1))},b)}});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==g){var h=new na.EdgePassParameters(40*f/g,b);x.set(d,c[3],c[7],c[11]);e.set(d);
x.copy(h.transformWorldFromViewTH,e.high);x.copy(h.transformWorldFromViewTL,e.low);I.fromMat4(h.transformViewFromCameraRelativeRS,a.camera.viewMatrix);I.transpose(V,h.transformViewFromCameraRelativeRS);I.invert(h.transformNormalViewFromGlobal,V);h.transformProjFromView=a.camera.projectionMatrix;this._updateObjectCameraDistances(a);this._renderers.forEach(k=>{this._renderRegularEdges(k,a,h);this._renderSilhouetteEdges(k,a,h)})}}}_updateTransparency(a){const b=v.determineEdgeTransparency(a.components.meta),
c=v.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=c,this._renderers.get(a.rendererKey).setRenderablesDirty()}_computeModelTransformWithLocalOrigin(a,b,c){a.getCombinedShaderTransformation(b,c);a=null!=b.localOrigin?this._localOrigins.register(b.localOrigin):this._localOrigins.acquire(x.set(this._tmpModelPosition,c[12],c[13],c[14]));b.localOrigin=a.origin;ja.applyToModelMatrix(a.origin.vec3,c);return a}_updateComponentBuffer(a){const {meta:b,
buffer:c}=a;a=new Uint8Array(4);for(let e=0;e<b.length;e++){var d=b[e].material;const f=b[e].index,g=M.clamp(Math.round(d.size*w.lineWidthFractionFactor),0,255),h=M.clamp(d.extensionLength,-w.extensionLengthOffset,255-w.extensionLengthOffset)+w.extensionLengthOffset,k="solid"===d.type?P.EdgeType.SOLID:P.EdgeType.SKETCH,l=255*d.opacity;d=d.color;c.textureBuffer.setData(f,0,255*d[0],255*d[1],255*d[2],255*d[3]);c.textureBuffer.setData(f,1,g,h,k,l);ea.encodeElevationOffset(b[e].verticalOffset,a);c.textureBuffer.setData(f,
2,a[0],a[1],a[2],a[3])}}_createComponentBuffers(a){if(null==this._componentColorManager)return null;const b=[],c=this._componentColorManager.getBuffer(a.length);for(let d=0;d<a.length;d++){const e=a[d],f=c.acquireIndex();b.push({index:f,verticalOffset:0,material:e})}a=new ta(c,b);this._updateComponentBuffer(a);return a}_extractEdges(a,b,c,d,e,f=e.length){return this._worker.process({data:b,indices:e,indicesLength:f,writerSettings:a,skipDeduplicate:c},this._workerAbort.signal,d)}_createRenderable(a,
b,c,d,e){var f=h=>null!=this._verticesBufferObject?new ua(new ma.VertexArrayObject(this.rctx,y.EdgeShaderAttributeLocations,{vertices:y.glVertexLayout,instances:h===z.EdgeSilhouette.REGULAR?O.RegularEdgeBufferWriter.glLayout:O.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:R.BufferObject.createVertex(this.rctx,S.Usage.STATIC_DRAW,h===z.EdgeSilhouette.REGULAR?a.regular.instancesData.buffer:a.silhouette.instancesData.buffer)}),h===z.EdgeSilhouette.REGULAR?a.regular.lodInfo:
a.silhouette.lodInfo):null;const g=0<a.regular.lodInfo.lengths.length?f(z.EdgeSilhouette.REGULAR):null;f=0<a.silhouette.lodInfo.lengths.length?f(z.EdgeSilhouette.SILHOUETTE):null;return new F(g,f,{gpuMemoryUsage:(g?.vao.usedMemory??0)+(f?.vao.usedMemory??0),externalMemoryUsage:e,averageEdgeLength:a.averageEdgeLength},c,v.determineEdgeTransparency(b.meta),v.determineObjectTransparency(b.meta),b,d)}async _addGeometry(a,b,c,d,e,f){if(!(0>=c.edgeIndicesLength)){var g=c.attributes.get(K.VertexAttribute.POSITION),
h=J.create();a=this._computeModelTransformWithLocalOrigin(a,c,h);g=new W(g,h,a);return this._addPositionData(b,g,c.edgeIndicesLength,d,e,f)}}async _addPositionData(a,b,c,d,e,f=!1){if(null!=a.loaded){var g=this._createComponentBuffers([d]);if(null!=g){d=this._acquireRenderer(d.type,!!e.hasSlicePlane,!0);var {modelTransform:h,origin:k}=b;e=b.position.indices;b=b.position;var l=b.data.length/b.size,m=y.EdgeInputBufferLayout.createBuffer(l);for(let n=0;n<l;n++)m.position.set(n,0,b.data[n*b.size]),m.position.set(n,
1,b.data[n*b.size+1]),m.position.set(n,2,b.data[n*b.size+2]);v.fillComponenBufferIndices(g.meta,[0,m.componentIndex.count],m.componentIndex);c=await this._updatingHandles.addPromise(this._extractEdges(d.writerSettings,m,!1,f,e,c));null!=a.loaded&&(g=this._createRenderable(c,g,new E(h,k),d.key,!1),a.renderables.push(g),d.addRenderable(g),this._gpuMemoryUsage+=g.statistics.gpuMemoryUsage)}}}async _addComponentGeometry(a,b,c,d,e,f,g){if(null==b.loaded)return 0;const h=this._createComponentBuffers(f);
if(null==h)return 0;f=v.determineRendererType(f);g=this._acquireRenderer(f,g.hasSlicePlane||!1,!1);f=y.EdgeInputBufferLayout.createBuffer(c.length/3);ca.copy(f.position.typedBuffer,c,f.position.typedBufferStride,3);v.fillComponenBufferIndices(h.meta,e,f.componentIndex,d);c=await this._updatingHandles.addPromise(this._extractEdges(g.writerSettings,f,!0,!1,d));if(null==b.loaded)return 0;a=this._createRenderable(c,h,a,g.key,!0);b.renderables.push(a);g.addRenderable(a);return a.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(a,
b,c,d,e){const f=new Map;let g=0,h=null,k=0;var l=a.geometries.filter(r=>{if(0>=r.edgeIndicesLength||!r.material.supportsEdges)return!1;!h&&r.localOrigin&&(h=r);const q=r.attributes.get(K.VertexAttribute.POSITION);k+=q.data.length/q.size;g+=r.edgeIndicesLength;return!0});if(0!==l.length){var m=65536<=k?Uint32Array:Uint16Array,n=g?new m(g):null,A=[],va=0;l.forEach(r=>{var q=r.attributes.get(K.VertexAttribute.POSITION);const wa=q.indices;let G=f.get(q.data);if(null==G){G=A.length/3;for(let B=0;B<q.data.length;B+=
q.size)A.push(q.data[B]),A.push(q.data[B+1]),A.push(q.data[B+2]);f.set(q.data,G)}for(q=0;q<r.edgeIndicesLength;q++)n[va++]=G+wa[q]});m=h||a.geometries[0];l=J.create();m=this._computeModelTransformWithLocalOrigin(a,m,l);for(let r=0;r<a.geometries.length;r++)a.geometries[r].localOrigin=m.origin;a=new W(new ha.Attribute(A,n,3),l,m);await this._updatingHandles.addPromise(this._addPositionData(b,a,n.length,c[0],d,e))}}_acquireRenderer(a,b,c){const d=w.EdgeRenderer.getKey(a,b,c);let e=this._renderers.get(d);
null==this._strokesTexture&&(this._strokesTexture=pa.generateStrokesTexture(this.rctx));e||(e=new w.EdgeRenderer(this.rctx,this.techniqueRepository,{type:a,hasSlicePlane:b,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===da.ViewingMode.Global}),this._renderers.set(d,e));++e.refCount;return e}_removeRenderable(a){T(a.regular);T(a.silhouette);const b=this._renderers.get(a.rendererKey);if(b){b.removeRenderable(a);--b.refCount;"origin"in a.transform&&this._localOrigins.release(a.transform.origin);
this._gpuMemoryUsage-=a.statistics.externalMemoryUsage?0:a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}}_updateObjectCameraDistances(a){const b=a.camera.eye,c=a.camera.viewForward,d=C.create();a=e=>{x.sub(d,e.center,b);const f=x.dot(d,c),g=e.radius,h=f<-g?Infinity:f<g?0:f-g;e.renderables.forEach(k=>k.distanceToCamera=h)};this._perObjectData.forEach(a);this._perObjectDataEvictionCache.forEach(a)}_renderRegularEdges(a,b,c){const d=a.bindRegularEdges(c,
b),e=b.camera.perScreenPixelRatio;a.forEachRenderable(f=>{if(null!=f.regular&&f.visible){var g=D(f.regular.lod.lengths,f.distanceToCamera,e);a.renderRegularEdges(d,f,c,b,g)}},c.transparency)}_renderSilhouetteEdges(a,b,c){const d=a.bindSilhouetteEdges(c,b),e=b.camera.perScreenPixelRatio;a.forEachRenderable(f=>{if(null!=f.silhouette&&f.visible){var g=D(f.silhouette.lod.lengths,f.distanceToCamera,e);a.renderSilhouetteEdges(d,f,c,b,g)}},c.transparency)}get test(){return{hasRenderedPrimitives:a=>{let b=
!1;const c=a.perScreenPixelRatio,d=(e,f)=>e.forEachRenderable(g=>{g.visible&&!b&&(null!=g.regular&&(b=0<D(g.regular.lod.lengths,g.distanceToCamera,c)),b||null==g.silhouette||(b=0<D(g.silhouette.lod.lengths,g.distanceToCamera,c)))},f);this._renderers.forEach(e=>{b||(d(e,Q.Transparency.OPAQUE),d(e,Q.Transparency.TRANSPARENT))});return b},getObjectData:a=>this._perObjectData.get(a)}}};t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"rctx",void 0);t.__decorate([u.property({constructOnly:!0})],
p.EdgeView.prototype,"renderSR",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"viewingMode",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"techniqueRepository",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"setNeedsRender",void 0);t.__decorate([u.property({constructOnly:!0})],p.EdgeView.prototype,"schedule",void 0);t.__decorate([u.property({readOnly:!0})],p.EdgeView.prototype,"_updatingHandles",void 0);t.__decorate([u.property({readOnly:!0})],
p.EdgeView.prototype,"updating",null);p.EdgeView=t.__decorate([Z.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],p.EdgeView);class U{constructor(a,b,c){this.radius=c;this.renderables=[];this.loaded=a;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)});this.center=C.clone(b)}}class ta{constructor(a,b){this.buffer=a;this.meta=b}}class ua{constructor(a,b){this.vao=a;this.lod=b}}class E{constructor(a,b){this.modelMatrix=a;this.origin=b}}class F{constructor(a,b,c,d,e,f,g,h){this.regular=
a;this.silhouette=b;this.statistics=c;this.transform=d;this.edgeTransparency=e;this.objectTransparency=f;this.components=g;this.rendererKey=h;this.distanceToCamera=0;this.visible=!0}}class xa extends F{}class ya extends F{}class W{constructor(a,b,c){this.position=a;this.modelTransform=b;this.origin=c}}const V=aa.create(),sa=()=>Promise.reject();p.LegacyTransform=E;p.RegularRenderable=xa;p.Renderable=F;p.SilhouetteRenderable=ya;Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});