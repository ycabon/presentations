// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../../../chunks/vec32 ../../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../support/debugFlags ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ../../core/shaderLibrary/ShaderOutput ../../effects/RenderPlugin ../Camera ../DefaultVertexAttributeLocations ../IntersectorInterfaces ../Octree ../RenderSlot ../Util ../VertexAttribute ./InstanceData ./InstanceOctree ./LevelSelector ./LodLevel ./RenderInstanceData ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../shaders/DefaultMaterialTechnique ../../../../support/Scheduler ../../../../webgl/Util".split(" "),
function(q,r,R,S,E,u,ka,la,T,U,w,C,A,F,V,W,x,X,Y,G,Z,H,D,B,y,m,aa,ba,ca,I,da,ea,fa,J,K){function L(a,b,c){const e=a.allocateHead();a=a.view;ea.encodeDoubleVec3(b.modelOrigin,c,a.modelOriginHi,a.modelOriginLo,e);a.model.copyFrom(e,b.model,c);a.modelNormal.copyFrom(e,b.modelNormal,c);b.color&&a.color&&a.color.copyFrom(e,b.color,c);b.objectAndLayerIdColor&&a.objectAndLayerIdColor&&a.objectAndLayerIdColor.copyFrom(e,b.objectAndLayerIdColor,c);b.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(e,
b.featureAttribute,c)}function ha(a){let b=W.newLayout().vec3f(y.VertexAttribute.INSTANCEMODELORIGINHI).vec3f(y.VertexAttribute.INSTANCEMODELORIGINLO).mat3f(y.VertexAttribute.INSTANCEMODEL).mat3f(y.VertexAttribute.INSTANCEMODELNORMAL);null!=a&&a.includes("featureAttribute")&&(b=b.vec4f(y.VertexAttribute.INSTANCEFEATUREATTRIBUTE));null!=a&&a.includes("color")&&(b=b.vec4u8(y.VertexAttribute.INSTANCECOLOR));null!=a&&a.includes("objectAndLayerIdColor")&&(b=b.vec4u8(y.VertexAttribute.INSTANCEOBJECTANDLAYERIDCOLOR));
return b}const ia=a=>{const b=a.baseBoundingSphere.radius;a=a.levels.map(c=>c.minScreenSpaceRadius);return new ba.LevelSelector(b,a)};q.LodRenderer=class extends X.ASyncPreparesRenderPlugin{constructor(a,b){super(a);this.type=Z.IntersectorType.LOD;this.isGround=!1;this._levels=[];this._defaultRenderInstanceData=[[]];this._highlightRenderInstanceData=[[]];this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]];this._cycleStartIndex=this._instanceIndex=
0;this._slicePlane=!1;this._camera=new Y.Camera;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=!1;this.produces=new Map([[D.RenderSlot.OPAQUE_MATERIAL,c=>this._produces(c)],[D.RenderSlot.TRANSPARENT_MATERIAL,c=>this._hasTransparentLevels()?this._produces(c):!1]]);this._instanceData=new m.InstanceData({shaderTransformation:a.shaderTransformation},a.optionalFields);this.addHandles(b.registerTask(J.TaskPriority.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=ha(this.optionalFields);
this._glInstanceBufferLayout=V.glLayout(this._instanceBufferLayout,1);this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:a})=>{this._requestUpdateCycle();this.metadata.notifyGraphicGeometryChanged(a)}),this._instanceData.events.on("instance-visibility-changed",({index:a})=>{this._requestUpdateCycle(!0);this.metadata.notifyGraphicVisibilityChanged(a)}),this._instanceData.events.on("instance-highlight-changed",
()=>this._requestUpdateCycle(!0))])}get _enableLevelSelection(){return 1<this.symbol.levels.length}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(a){this._slicePlane=a}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get usedMemory(){return this._allRenderInstanceData.reduce((a,
b)=>b.reduce((c,e)=>c+e.usedMemory,a),0)}get renderStats(){const a=this._instanceData.size,b=[];this._levels.forEach((c,e)=>{e=this._allRenderInstanceData[0][e].size+this._allRenderInstanceData[1][e].size;c=c.triangleCount;b.push({renderedInstances:e,renderedTriangles:e*c,trianglesPerInstance:c})});return{totalInstances:a,renderedInstances:b.reduce((c,e)=>c+e.renderedInstances,0),renderedTriangles:b.reduce((c,e)=>c+e.renderedTriangles,0),levels:b}}async initializeRenderContext(a,b){this._context=
a;const c=a.renderContext.rctx,e=await Promise.allSettled(this.symbol.levels.map(g=>{this._defaultRenderInstanceData[0].push(new I.RenderInstanceData(c,this._instanceBufferLayout));this._highlightRenderInstanceData[0].push(new I.RenderInstanceData(c,this._instanceBufferLayout));return ca.LodLevel.create(a,g,b)})),f=e.map(g=>"fulfilled"===g.status?g.value:null).filter(R.isSome);if(E.isAborted(b)||f.length!==e.length){f.forEach(g=>g.destroy());E.throwIfAborted(b);for(const g of e)if("rejected"===g.status)throw g.reason;
}this._levels=f;this._levelSelector=ia(this)}uninitializeRenderContext(){this._invalidateOctree();this._levels.forEach(a=>a.destroy());this._defaultRenderInstanceData[0].forEach(a=>a.destroy());this._highlightRenderInstanceData[0].forEach(a=>a.destroy())}_hasTransparentLevels(){return this._levels.some(a=>a.components.some(b=>(b=b.material.produces.get(D.RenderSlot.TRANSPARENT_MATERIAL))&&b(x.ShaderOutput.Color)))}hasHighlights(){return this._highlightRenderInstanceData[0].some(a=>0<a.size)}_produces(a){return a!==
x.ShaderOutput.Highlight&&a!==x.ShaderOutput.ShadowHighlight||this.hasHighlights()}prepareRender(a){if(!F.debugFlags.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const b=a.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(a.bindParameters.contentCamera);b||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(J.noBudget),this._needFullCycle=!1)}}prepareTechniques(a){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(a.output))return null;
const b=this._getInstanceDatas(a.output);if(!b)return null;const c=[];b.forEach(e=>this.levels.forEach((f,g)=>{f.components.forEach(l=>c.push(this._beginComponent(a,e[g],l)))}));return c}renderNode(a,b){const c=this._getInstanceDatas(a.output);if(c&&null!=b){var e=0;a.rctx.bindVAO();c.forEach(f=>this.levels.forEach((g,l)=>{g.components.forEach(k=>this._renderComponent(a,b[e++],f[l],k,l))}))}}_getInstanceDatas(a){const b=a!==x.ShaderOutput.Highlight&&a!==x.ShaderOutput.ShadowHighlight;a=a!==x.ShaderOutput.ShadowExcludeHighlight;
return b&&a?this._allRenderInstanceData:b?this._defaultRenderInstanceData:a?this._highlightRenderInstanceData:null}intersect(a,b,c,e){if(this.baseMaterial.isVisible()&&null!=this._octree){var f=C.create();w.subtract(f,e,c);var g=l=>{this._instanceData.getCombinedModelTransform(l,M);a.transform.set(M);w.transformMat4(N,c,a.transform.inverse);w.transformMat4(O,e,a.transform.inverse);const k=this._instanceData.getState(l),d=this._instanceData.getLodLevel(l),z=this._levels.length;B.assert(0!==(k&m.StateFlags.ACTIVE),
"invalid instance state");B.assert(0<=d&&d<z,"invaid lod level");this._levels[d].intersect(a,b,N,O,l,this.metadata,z)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(g):this._octree.forEachAlongRay(c,f,g)}}notifyShaderTransformationChanged(){this._invalidateOctree();this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const a=this._instanceData,b=a.view?.state;if(!b)return null;this._octreeCached=new aa.InstanceOctree(a,this.baseBoundingSphere);for(let c=0;c<a.capacity;++c)b.get(c)&
m.StateFlags.ACTIVE&&this._octreeCached.addInstance(c)}return this._octreeCached}_invalidateOctree(){this._octreeCached=S.destroyMaybe(this._octreeCached)}queryDepthRange(a){if(null==this._octree)return{near:Infinity,far:-Infinity};var b=a.viewForward,c=this._octree.findClosest(b,H.DepthOrder.FRONT_TO_BACK,a.frustum);const e=this._octree.findClosest(b,H.DepthOrder.BACK_TO_FRONT,a.frustum);if(null==c||null==e)return{near:Infinity,far:-Infinity};const f=a.eye,g=this._instanceData.view;g.boundingSphere.getVec(c,
t);w.subtract(t,t,f);c=w.dot(t,b)-t[3];g.boundingSphere.getVec(e,t);w.subtract(t,t,f);b=w.dot(t,b)+t[3];return{near:Math.max(a.near,c),far:Math.min(a.far,b)}}_requestUpdateCycle(a=!1){this._updateCyclesWithStaticCamera=-1;this._cycleStartIndex=this._instanceIndex;a&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++;this._allRenderInstanceData.forEach(a=>a.forEach(b=>b.startUpdateCycle()))}get running(){return 0<this._instanceData.size&&
1>this._updateCyclesWithStaticCamera}runTask(a){const {_enableLevelSelection:b,_camera:c,_levelSelector:e}=this;this._allRenderInstanceData.forEach(v=>v.forEach(p=>p.beginUpdate()));const f=this._instanceData,g=f.view;let l=f.size;const k=f.capacity;let d=this._instanceIndex;const z=Math.ceil(k/500);for(let v=0;v<l&&!a.done;++v){d===this._cycleStartIndex&&this._startUpdateCycle();const p=g.state.get(d);var h=0;if(p&m.StateFlags.ALLOCATED){var n=g.lodLevel.get(d);p&m.StateFlags.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][n].freeTail();
p&m.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][n].freeTail();p&m.StateFlags.REMOVE?f.freeInstance(d):p&m.StateFlags.VISIBLE?(n=0,b&&(g.modelOrigin.getVec(d,P),n=e.selectLevel(P,f.getCombinedMedianScaleFactor(d),c)),h=p&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),0<=n&&(p&m.StateFlags.HIGHLIGHT?(L(this._highlightRenderInstanceData[0][n],g,d),h|=m.StateFlags.HIGHLIGHT_ACTIVE):(L(this._defaultRenderInstanceData[0][n],g,d),h|=m.StateFlags.DEFAULT_ACTIVE)),g.state.set(d,
h),g.lodLevel.set(d,n)):(h=p&~(m.StateFlags.ACTIVE|m.StateFlags.TRANSFORM_CHANGED),g.state.set(d,h));null!=this._octreeCached&&(n=!!(p&m.StateFlags.ACTIVE),h=!!(h&m.StateFlags.ACTIVE),!n&&h?this._octreeCached.addInstance(d):n&&!h?this._octreeCached.removeInstance(d):n&&h&&p&m.StateFlags.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(d),this._octreeCached.addInstance(d)));d=d+1===k?0:d+1;0===d%z&&a.madeProgress()}else d=d+1===k?0:d+1,l++}this._instanceIndex=d;this._allRenderInstanceData.forEach(v=>
v.forEach(p=>p.endUpdate()));this._context.requestRender()}_beginComponent(a,b,c){if(0===b.size)return null;b=c.glMaterials.load(a.rctx,a.bindParameters.slot,a.output);return null!=b?b.beginSlot(a.bindParameters):null}_renderComponent(a,b,c,e,f){if(b){var {bindParameters:g,rctx:l}=a;l.runAppleAmdDriverHelper();var k=l.bindTechnique(b,g,e.material.parameters,ja);l.bindVAO(e.vao);b.ensureAttributeLocations(e.vao);F.debugFlags.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&a.output===x.ShaderOutput.Color&&
(k.setUniform4fv("externalColor",Q[Math.min(f,Q.length-1)]),k.setUniform1i("colorMixMode",da.colorMixModes.replace));a=c.capacity;f=c.headIndex;k=c.tailIndex;var d=c.firstIndex,z=this._glInstanceBufferLayout,h=(n,v)=>{K.bindVertexBufferLayout(l,G.Default3D,c.buffer,z,n);l.drawArraysInstanced(b.primitiveType,0,e.vertexCount,v-n);K.unbindVertexBufferLayout(l,G.Default3D,c.buffer,z)};e.material.parameters.transparent&&null!=d?f>k?(B.assert(d>=k&&d<=f,"invalid firstIndex"),h(d,f),h(k,d)):f<k&&(d<=f?(B.assert(0<=
d&&d<=f,"invalid firstIndex"),h(d,f),h(k,a),h(0,d)):(B.assert(d>=k&&d<=a,"invalid firstIndex"),h(d,a),h(0,f),h(k,d))):f>k?h(k,f):f<k&&(h(0,f),h(k,a));l.bindVAO(null)}}};r.__decorate([u.property({constructOnly:!0})],q.LodRenderer.prototype,"symbol",void 0);r.__decorate([u.property({constructOnly:!0})],q.LodRenderer.prototype,"optionalFields",void 0);r.__decorate([u.property({constructOnly:!0})],q.LodRenderer.prototype,"metadata",void 0);r.__decorate([u.property({constructOnly:!0})],q.LodRenderer.prototype,
"shaderTransformation",void 0);r.__decorate([u.property()],q.LodRenderer.prototype,"_instanceData",void 0);r.__decorate([u.property()],q.LodRenderer.prototype,"_cycleStartIndex",void 0);r.__decorate([u.property({readOnly:!0})],q.LodRenderer.prototype,"_enableLevelSelection",null);r.__decorate([u.property()],q.LodRenderer.prototype,"_updateCyclesWithStaticCamera",void 0);r.__decorate([u.property({readOnly:!0})],q.LodRenderer.prototype,"running",null);q.LodRenderer=r.__decorate([T.subclass("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],
q.LodRenderer);const P=C.create(),t=A.create(),M=U.create(),N=C.create(),O=C.create(),Q=[A.fromValues(1,0,1,1),A.fromValues(0,0,1,1),A.fromValues(0,1,0,1),A.fromValues(1,1,0,1),A.fromValues(1,0,0,1)],ja=new fa.DefaultMaterialDrawParameters;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});