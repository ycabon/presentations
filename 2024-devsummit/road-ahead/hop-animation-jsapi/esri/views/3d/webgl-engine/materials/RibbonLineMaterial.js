// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/math/vec2 ../../../../chunks/vec32 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../core/libs/gl-matrix-2/factories/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariablePassParameters ../shaders/LineMarkerTechniqueConfiguration ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechniqueConfiguration".split(" "),
function(Z,W,pa,aa,Q,qa,h,z,ra,X,K,t,sa,w,ta,L,I,ua,k,va,wa,xa,ha,ia){function J(a,b,c,d,l){for(let g=0;g<l;g++)c[d++]=a[b++];return d}var C;(function(a){a[a.LEFT_JOIN_START=-2]="LEFT_JOIN_START";a[a.LEFT_JOIN_END=-1]="LEFT_JOIN_END";a[a.LEFT_CAP_START=-4]="LEFT_CAP_START";a[a.LEFT_CAP_END=-5]="LEFT_CAP_END";a[a.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";a[a.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";a[a.RIGHT_CAP_START=4]="RIGHT_CAP_START";a[a.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(C||={});class ya extends L.Material{constructor(a){super(a,
new ja);this._configuration=new ia.RibbonLineTechniqueConfiguration;this.produces=new Map([[I.RenderSlot.OPAQUE_MATERIAL,b=>b===w.ShaderOutput.Highlight||b===w.ShaderOutput.ObjectAndLayerIdColor||(b===w.ShaderOutput.Color||b===w.ShaderOutput.Alpha)&&this.parameters.renderOccluded===L.RenderOccludedFlag.OccludeAndTransparentStencil],[I.RenderSlot.OPAQUE_NO_SSAO_DEPTH,b=>b===w.ShaderOutput.LinearDepth],[I.RenderSlot.OCCLUDER_MATERIAL,b=>w.isColorAlphaHighlightOIDOrDepth(b)&&this.parameters.renderOccluded===
L.RenderOccludedFlag.OccludeAndTransparentStencil],[I.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL,b=>w.isColorAlphaHighlightOIDOrDepth(b)&&this.parameters.renderOccluded===L.RenderOccludedFlag.OccludeAndTransparentStencil],[I.RenderSlot.TRANSPARENT_MATERIAL,b=>(b===w.ShaderOutput.Color||b===w.ShaderOutput.Alpha)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==L.RenderOccludedFlag.OccludeAndTransparentStencil],[I.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,b=>(b===w.ShaderOutput.Color||
b===w.ShaderOutput.Alpha)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==L.RenderOccludedFlag.OccludeAndTransparentStencil],[I.RenderSlot.DRAPED_MATERIAL,b=>w.is2DGeometryOutput(b)]]);this._vertexAttributeLocations=ha.vertexAttributeLocations}getConfiguration(a,b){this._configuration.output=a;this._configuration.draped=b.slot===I.RenderSlot.DRAPED_MATERIAL;a=null!=this.parameters.stipplePattern&&a!==w.ShaderOutput.Highlight;this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=
a&&null!=this.parameters.stippleOffColor;this._configuration.stipplePreferContinuous=a&&this.parameters.stipplePreferContinuous;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.roundJoins="round"===this.parameters.join;this._configuration.capType=this.parameters.cap;a=this._configuration;if(null!=this.parameters.markerParameters){var c=this.parameters.markerParameters;c=c.anchor===wa.LineMarkerAnchor.Tip&&
c.hideOnShortSegments&&"begin-end"===c.placement&&c.worldSpace}else c=!1;a.applyMarkerOffset=c;this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset;this._configuration.writeDepth=this.parameters.writeDepth;this._configuration.vvSize=!!this.parameters.vvSize;this._configuration.vvColor=!!this.parameters.vvColor;this._configuration.vvOpacity=!!this.parameters.vvOpacity;this._configuration.innerColorEnabled=0<this.parameters.innerWidth&&null!=this.parameters.innerColor;this._configuration.falloffEnabled=
0<this.parameters.falloff;this._configuration.occluder=this.parameters.renderOccluded===L.RenderOccludedFlag.OccludeAndTransparentStencil;this._configuration.transparencyPassType=b.transparencyPassType;this._configuration.multipassEnabled=b.multipassEnabled;this._configuration.cullAboveGround=b.multipassTerrain.cullAboveGround;this._configuration.wireframe=this.parameters.wireframe;return this._configuration}intersectDraped(a,b,c,d,l,g){if(c.options.selectionMode){b=a.attributes.get(k.VertexAttribute.POSITION).data;
c=a.attributes.get(k.VertexAttribute.SIZE);var e=this.parameters.width;this.parameters.vvSize?(c=a.attributes.get(k.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],e*=aa.clamp(this.parameters.vvSize.offset[0]+c*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])):c&&(e*=c.data[0]);c=d[0];d=d[1];a=(e/2+4)*a.screenToWorldRatio;e=Number.MAX_VALUE;var f=0;for(let A=0;A<b.length-5;A+=3){var n=b[A],v=b[A+1],p=c-n,u=d-v;n=b[A+3]-n;v=b[A+4]-v;const S=aa.clamp((n*
p+v*u)/(n*n+v*v),0,1);p=n*S-p;u=v*S-u;u=p*p+u*u;u<e&&(e=u,f=A/3)}e<a*a&&l(g.dist,g.normal,f,!1)}}intersect(a,b,c,d,l,g){if(c.options.selectionMode&&a.visible)if(ua.isTranslationMatrix(b)){var e=a.attributes;d=e.get(k.VertexAttribute.POSITION).data;a=this.parameters.width;this.parameters.vvSize?(l=e.get(k.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],a*=aa.clamp(this.parameters.vvSize.offset[0]+l*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])):
e.has(k.VertexAttribute.SIZE)&&(a*=e.get(k.VertexAttribute.SIZE).data[0]);var f=c.camera,n=za;qa.copy(n,c.point);l=a*f.pixelRatio/2+4*f.pixelRatio;h.set(T[0],n[0]-l,n[1]+l,0);h.set(T[1],n[0]+l,n[1]+l,0);h.set(T[2],n[0]+l,n[1]-l,0);h.set(T[3],n[0]-l,n[1]-l,0);for(a=0;4>a;a++)if(!f.unprojectFromRenderScreen(T[a],G[a]))return;t.fromPoints(f.eye,G[0],G[1],ba);t.fromPoints(f.eye,G[1],G[2],ca);t.fromPoints(f.eye,G[2],G[3],da);t.fromPoints(f.eye,G[3],G[0],ea);var v=Number.MAX_VALUE;a=0;e=this.parameters.isClosed&&
2<e.get(k.VertexAttribute.POSITION).indices.length?d.length-2:d.length-5;for(let u=0;u<e;u+=3){x[0]=d[u]+b[12];x[1]=d[u+1]+b[13];x[2]=d[u+2]+b[14];var p=(u+3)%d.length;y[0]=d[p]+b[12];y[1]=d[p+1]+b[13];y[2]=d[p+2]+b[14];if(!(0>t.signedDistance(ba,x)&&0>t.signedDistance(ba,y)||0>t.signedDistance(ca,x)&&0>t.signedDistance(ca,y)||0>t.signedDistance(da,x)&&0>t.signedDistance(da,y)||0>t.signedDistance(ea,x)&&0>t.signedDistance(ea,y))){f.projectToRenderScreen(x,M);f.projectToRenderScreen(y,N);if(0>M[2]&&
0<N[2])h.subtract(E,x,y),p=f.frustum,p=-t.signedDistance(p[X.PlaneIndex.NEAR],x)/h.dot(E,t.getNormal(p[X.PlaneIndex.NEAR])),h.scale(E,E,p),h.add(x,x,E),f.projectToRenderScreen(x,M);else if(0<M[2]&&0>N[2])h.subtract(E,y,x),p=f.frustum,p=-t.signedDistance(p[X.PlaneIndex.NEAR],y)/h.dot(E,t.getNormal(p[X.PlaneIndex.NEAR])),h.scale(E,E,p),h.add(y,y,E),f.projectToRenderScreen(y,N);else if(0>M[2]&&0>N[2])continue;M[2]=0;N[2]=0;p=K.distance2(K.fromPoints(M,N,ka),n);p<v&&(v=p,h.copy(la,x),h.copy(ma,y),a=u/
3)}}b=c.rayBegin;c=c.rayEnd;v<l*l&&(d=Number.MAX_VALUE,K.closestLineSegmentPoint(K.fromPoints(la,ma,ka),K.fromPoints(b,c,Aa),O)&&(h.subtract(O,O,b),d=h.length(O),h.scale(O,O,1/d),d/=h.distance(b,c)),g(d,O,a,!1))}else pa.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix")}get _layout(){const a=sa.newLayout().vec3f(k.VertexAttribute.POSITION).vec3f(k.VertexAttribute.PREVPOSITION).vec3f(k.VertexAttribute.NEXTPOSITION).f32(k.VertexAttribute.SUBDIVISIONFACTOR).vec2f(k.VertexAttribute.UV0);
this.parameters.vvSize?a.f32(k.VertexAttribute.SIZEFEATUREATTRIBUTE):a.f32(k.VertexAttribute.SIZE);this.parameters.vvColor?a.f32(k.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(k.VertexAttribute.COLOR);this.parameters.vvOpacity&&a.f32(k.VertexAttribute.OPACITYFEATUREATTRIBUTE);W("enable-feature:objectAndLayerId-rendering")&&a.vec4u8(k.VertexAttribute.OBJECTANDLAYERIDCOLOR);return a}createBufferWriter(){return new Ba(this._layout,this.parameters)}createGLMaterial(a){return new Ca(a)}validateParameters(a){"miter"!==
a.join&&(a.miterLimit=0);null!=a.markerParameters&&(a.markerScale=a.markerParameters.width/a.width)}}class Ca extends ta{constructor(){super(...arguments);this._stipplePattern=null}dispose(){super.dispose();this._stippleTextureRepository.release(this._stipplePattern);this._stipplePattern=null}_updateOccludeeState(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})}beginSlot(a){this._output!==w.ShaderOutput.Color&&this._output!==w.ShaderOutput.Alpha||
this._updateOccludeeState(a);const b=this._material.parameters.stipplePattern;this._stipplePattern!==b&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(b,this._stipplePattern)}),this._stipplePattern=b);return this.ensureTechnique(ha.RibbonLineTechnique,a)}}class ja extends va.VisualVariablePassParameters{constructor(){super(...arguments);this.width=0;this.color=ra.ONES;this.join="miter";this.cap=ia.CapType.BUTT;this.miterLimit=5;this.writeDepth=!0;this.hasPolygonOffset=
!1;this.stippleTexture=null;this.stipplePreferContinuous=!0;this.markerParameters=null;this.markerScale=1;this.isClosed=this.vvFastUpdate=this.hasSlicePlane=!1;this.innerWidth=this.falloff=0;this.wireframe=this.hasOccludees=!1}}class Ba{constructor(a,b){this.vertexBufferLayout=a;this._parameters=b;this.numJoinSubdivisions=0;a=b.stipplePattern?1:0;switch(this._parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=a;break;case "round":this.numJoinSubdivisions=xa.ribbonlineNumRoundJoinSubdivisions+
a}}_isClosed(a){return this._parameters.isClosed?2<a.attributes.get(k.VertexAttribute.POSITION).indices.length:!1}allocate(a){return this.vertexBufferLayout.createBuffer(a)}elementCount(a){var b=a.attributes.get(k.VertexAttribute.POSITION).indices.length/2+1;a=this._isClosed(a);b=(a?2:4)+((a?b:b-1)-(a?0:1))*(2*this.numJoinSubdivisions+4);b+=2;this._parameters.wireframe&&(b=2+4*(b-2));return b}write(a,b,c,d,l){b=Da;const g=Ea,e=Fa,f=c.attributes.get(k.VertexAttribute.POSITION);var n=f.indices;const v=
f.data.length/3,p=c.attributes.get(k.VertexAttribute.DISTANCETOSTART)?.data;n&&n.length!==2*(v-1)&&console.warn("RibbonLineMaterial does not support indices");const u=c.attributes.get(k.VertexAttribute.SIZEFEATUREATTRIBUTE)?.data[0]??c.attributes.get(k.VertexAttribute.SIZE)?.data[0]??1;let A=[1,1,1,1],S=0;const na=this.vertexBufferLayout.fields.has(k.VertexAttribute.COLORFEATUREATTRIBUTE);na?S=c.attributes.get(k.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:c.attributes.has(k.VertexAttribute.COLOR)&&
(A=c.attributes.get(k.VertexAttribute.COLOR).data);const U=W("enable-feature:objectAndLayerId-rendering")?c.objectAndLayerIdColor:null,oa=this.vertexBufferLayout.fields.has(k.VertexAttribute.OPACITYFEATUREATTRIBUTE),Ga=oa?c.attributes.get(k.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]:0,q=new Float32Array(d.buffer),Y=W("enable-feature:objectAndLayerId-rendering")?new Uint8Array(d.buffer):null;n=this.vertexBufferLayout.stride/4;let m=l*n;l=m;let B=0;const fa=p?(r,F,H)=>B=p[H]:(r,F,H)=>B+=h.distance(r,
F),Ha=W("enable-feature:objectAndLayerId-rendering"),D=(r,F,H,Ia,Ja,Ka,La)=>{q[m++]=F[0];q[m++]=F[1];q[m++]=F[2];q[m++]=r[0];q[m++]=r[1];q[m++]=r[2];q[m++]=H[0];q[m++]=H[1];q[m++]=H[2];q[m++]=Ia;q[m++]=La;q[m++]=Ja;q[m++]=u;na?q[m++]=S:(r=Math.min(4*Ka,A.length-4),q[m++]=A[r],q[m++]=A[r+1],q[m++]=A[r+2],q[m++]=A[r+3]);oa&&(q[m++]=Ga);Ha&&(null!=U&&(Y[4*m]=U[0],Y[4*m+1]=U[1],Y[4*m+2]=U[2],Y[4*m+3]=U[3]),m++)};m+=n;h.set(g,f.data[0],f.data[1],f.data[2]);a&&h.transformMat4(g,g,a);if(c=this._isClosed(c)){var P=
f.data.length-3;h.set(b,f.data[P],f.data[P+1],f.data[P+2]);a&&h.transformMat4(b,b,a)}else h.set(e,f.data[3],f.data[4],f.data[5]),a&&h.transformMat4(e,e,a),D(g,g,e,1,C.LEFT_CAP_START,0,0),D(g,g,e,1,C.RIGHT_CAP_START,0,0),h.copy(b,g),h.copy(g,e);P=c?0:1;const V=c?v:v-1;for(let r=P;r<V;r++){var R=(r+1)%v*3;h.set(e,f.data[R],f.data[R+1],f.data[R+2]);a&&h.transformMat4(e,e,a);fa(b,g,r);D(b,g,e,0,C.LEFT_JOIN_END,r,B);D(b,g,e,0,C.RIGHT_JOIN_END,r,B);R=this.numJoinSubdivisions;for(let F=0;F<R;++F){const H=
(F+1)/(R+1);D(b,g,e,H,C.LEFT_JOIN_END,r,B);D(b,g,e,H,C.RIGHT_JOIN_END,r,B)}D(b,g,e,1,C.LEFT_JOIN_START,r,B);D(b,g,e,1,C.RIGHT_JOIN_START,r,B);h.copy(b,g);h.copy(g,e)}c?(h.set(e,f.data[3],f.data[4],f.data[5]),a&&h.transformMat4(e,e,a),B=fa(b,g,V),D(b,g,e,0,C.LEFT_JOIN_END,P,B),D(b,g,e,0,C.RIGHT_JOIN_END,P,B)):(B=fa(b,g,V),D(b,g,g,0,C.LEFT_CAP_END,V,B),D(b,g,g,0,C.RIGHT_CAP_END,V,B));J(q,l+n,q,l,n);m=J(q,m-n,q,m,n);this._parameters.wireframe&&this._addWireframeVertices(d,l,m,n)}_addWireframeVertices(a,
b,c,d){const l=new Float32Array(a.buffer,c*Float32Array.BYTES_PER_ELEMENT);a=new Float32Array(a.buffer,b*Float32Array.BYTES_PER_ELEMENT,c-b);b=0;for(c=0;c<a.length-1;c+=2*d)b=J(a,c,l,b,d),b=J(a,c+2*d,l,b,d),b=J(a,c+1*d,l,b,d),b=J(a,c+2*d,l,b,d),b=J(a,c+1*d,l,b,d),b=J(a,c+3*d,l,b,d)}}const x=z.create(),y=z.create(),E=z.create(),O=z.create(),za=z.create(),M=Q.createRenderScreenPointArray3(),N=Q.createRenderScreenPointArray3(),la=z.create(),ma=z.create(),ka=K.create(),Aa=K.create(),Da=z.create(),Ea=
z.create(),Fa=z.create(),T=[Q.createRenderScreenPointArray3(),Q.createRenderScreenPointArray3(),Q.createRenderScreenPointArray3(),Q.createRenderScreenPointArray3()],G=[z.create(),z.create(),z.create(),z.create()],ba=t.create(),ca=t.create(),da=t.create(),ea=t.create();Z.Parameters=ja;Z.RibbonLineMaterial=ya;Object.defineProperty(Z,Symbol.toStringTag,{value:"Module"})});