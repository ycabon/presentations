// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/MapUtils ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/NestedMap ../../../../../core/PooledArray ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/libs/gl-matrix-2/math/mat4 ../../../../../core/libs/gl-matrix-2/factories/mat4f64 ../../../support/buffer/glUtil ../../core/shaderLibrary/ShaderOutput ../../effects/RenderPlugin ../../lib/GLMaterials ../../lib/ModelDirtyTypes ../../lib/RenderSlot ../../lib/Util ../DrawParameters ./BufferRange ./Instance ./PerBufferData ./PerOriginData ./VaoCache".split(" "),
function(y,J,D,R,S,K,T,U,V,fa,ha,W,E,F,X,w,Y,Z,z,L,A,aa,G,M,N,ba,ca){function da(a,b){let d;if(!a.some(e=>{if(e.numElements<b)return!1;d=e;return!0}))return null;const c=d.from;d.from+=b;d.from>=d.to&&a.removeUnordered(d);return c}function B(a){H.length<a&&(H=new Float32Array(a));return H}function O(a){a*=4;return 1024>=a?1024:262144>a?S.nextHighestPowerOfTwo(a):Math.max(Math.min(262144*Math.ceil(1.5*a/262144),16777216),a)}y.MergedRenderer=class extends Y.SyncPrepareRenderPlugin{constructor(a){super(a);
this._bufferWriter=this._glMaterials=this._vaoCache=null;this._dataByOrigin=new Map;this._hasOccludees=this._hasHighlights=!1;this._produces=new Map;this.drapedPriority=0}destroy(){this._glMaterials=K.disposeMaybe(this._glMaterials);this._dataByOrigin.forEach(a=>a.dispose());this._dataByOrigin.clear();this._vaoCache=K.disposeMaybe(this._vaoCache)}initialize(){this.material.produces.forEach((a,b)=>{this._produces.set(b,d=>0===this._dataByOrigin.size||d===w.ShaderOutput.Highlight&&!this._hasHighlights?
!1:a(d))})}get produces(){return this._produces}initializeRenderContext(a,b){const {rctx:d}=a.renderContext;this._glMaterials=new Z.GLMaterials(this.material,b??a.materialRepository);this._bufferWriter=this.material.createBufferWriter();this._vaoCache=new ca.VaoCache(d,this.material.vertexAttributeLocations,X.glLayout(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(a){return this.material.queryRenderOccludedState(a)}get materialReference(){return this.material}get numGeometries(){let a=
0;this._dataByOrigin.forEach(b=>a+=b.buffers.reduce((d,c)=>d+=c.instances.size,0));return a}get usedMemory(){let a=0;this._dataByOrigin.forEach(b=>a+=b.buffers.reduce((d,c)=>d+c.vao.usedMemory,0));return a}forEachGeometry(a){this._dataByOrigin.forEach(b=>b.buffers.forEach(d=>d.instances.forEach(c=>a(c.geometry))))}modify(a){this._updateGeometries(a.updates);this._addAndRemoveGeometries(a.adds,a.removes);this._updateDrawCommands()}_updateGeometries(a){const b=this._bufferWriter;if(null!==b){var d=
b.vertexBufferLayout.stride/4;for(const e of a){a=e.renderGeometry;const h=this._dataByOrigin.get(a.localOrigin.id)?.findBuffer(a.id);if(null==h)break;const k=h.instances.get(a.id);if(e.updateType&(z.DirtyState.GEOMETRY|z.DirtyState.TRANSFORMATION)){var c=b.elementCount(k.geometry.geometry)*d;c=B(c);const f=b.vertexBufferLayout.createView(c.buffer);this._writeGeometry(a,f,0);h.vao.vertexBuffers.geometry.setSubData(c,k.from*d,0,k.numElements*d)}e.updateType&(z.DirtyState.HIGHLIGHT|z.DirtyState.OCCLUDEE|
z.DirtyState.VISIBILITY)&&(h.drawCommandsDirty=!0)}}}_computeDeltas(a,b){const d=new T.NestedMap;for(var c of a){a=c.localOrigin;if(null==a)continue;let e=d.get(a.id,null);null==e&&(e=new P(a.vec3),d.set(a.id,null,e));e.changes.push(c)}for(const e of b)b=e.localOrigin,null!=b&&(c=this._dataByOrigin.get(b.id)?.findBuffer(e.id),null!=c&&(a=d.get(b.id,c),null==a&&(a=new P(b.vec3),d.set(b.id,c,a)),a.changes.push(e)));return d}_addAndRemoveGeometries(a,b){if(null!==this._bufferWriter&&null!==this._vaoCache){var {_bufferWriter:d,
_dataByOrigin:c}=this,e=d.vertexBufferLayout.stride/4,h=this._computeDeltas(a,b);h.forEach((k,f)=>{const n=k.get(null),l=null!=n?n.changes:[];h.delete(f,null);let g=c.get(f);k.forEach((p,m)=>{h.delete(f,m);if(null==m)A.assert(!1,"No VAO for removed geometries");else if(m.instances.size===p.changes.length)this._vaoCache.deleteVao(m.vao),D.removeUnordered(g.buffers,m),0===g.buffers.length&&0===l.length&&c.delete(f);else{var r=m.numElements,t=m.vao.byteSize/4,q=l.reduce((x,I)=>x+d.elementCount(I.geometry),
0),v=p.changes.reduce((x,I)=>x+d.elementCount(I.geometry),0);r=Math.min((r+q-v)*e,4194304);q=r>t;65536<r&&r<t/2?(p.changes.forEach(({id:x})=>m.deleteInstance(x)),m.instances.forEach(({geometry:x})=>l.push(x)),this._vaoCache.deleteVao(m.vao),D.removeUnordered(g.buffers,m)):q?this._applyAndRebuild(m,l,p):this._applyRemoves(m,p)}});if(0<l.length)for(null==g&&(g=new ba.PerOriginData(n.origin),c.set(f,g)),g.buffers.forEach(p=>this._applyAdds(p,l));0<l.length;)g.buffers.push(this._applyAndRebuild(new N.PerBufferData,
l,null))})}}_updateDrawCommands(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(a=>{a.buffers.forEach(b=>{b.drawCommandsDirty&&(b.hasHiddenInstances=!1,b.hasHighlights=!1,b.hasOccludees=!1,R.someMap(b.instances,d=>{b.updateDrawState(d);return b.hasHiddenInstances&&b.hasHighlights&&b.hasOccludees}),b.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride));this._hasHighlights=this._hasHighlights||b.hasHighlights;this._hasOccludees=this._hasOccludees||b.hasOccludees})})}_applyAndRebuild(a,
b,d){if(null!=d)for(var c of d.changes)a.deleteInstance(c.id);const e=this._bufferWriter;d=e.vertexBufferLayout.stride;c=d/4;var h=Math.floor(4194304/c);let k=a.numElements;for(;0<b.length;){const g=b.pop();var f=e.elementCount(g.geometry);if(k+f>h&&0<k){b.push(g);break}k+=f;f=new M.Instance(g,0,0);A.assert(null==a.instances.get(g.id));a.addInstance(g.id,f)}b=k*c;h=B(b);const n=e.vertexBufferLayout.createView(h.buffer);let l=0;a.hasHiddenInstances=!1;a.hasHighlights=!1;a.hasOccludees=!1;a.instances.forEach((g,
p)=>{this._writeGeometry(g.geometry,n,l);const m=l;l+=e.elementCount(g.geometry.geometry);a.updateInstance(p,m,l);a.updateDrawState(g)});this._vaoCache.deleteVao(a.vao);a.vao=this._vaoCache.newVao(O(b));a.vao.vertexBuffers.geometry.setSubData(h,0,0,l*c);a.holes.clear();b=a.holes.pushNew();b.from=l;b.to=Math.floor(a.vao.byteSize/d);a.updateDrawCommands(d);return a}_applyRemoves(a,b){if(0!==b.changes.length&&null!==this._bufferWriter){for(var d of b.changes){var c=d.id;if(b=a.instances.get(c)){a.deleteInstance(c);
if(c=u.back()){if(c.to===b.from){c.to=b.to;continue}if(c.from===b.to){c.from=b.from;continue}}c=u.pushNew();c.from=b.from;c.to=b.to}}G.mergeAdjacentRanges(u);var e=this._bufferWriter.vertexBufferLayout.stride/4;d=u.reduce((f,n)=>Math.max(f,n.numElements),0)*e;var h=B(d);h.fill(0,0,d);var k=a.vao.vertexBuffers.geometry;u.forAll(f=>k.setSubData(h,f.from*e,0,f.numElements*e));a.holes.pushArray(u.data,u.length);u.forAll((f,n)=>u.data[n]=null);u.clear();a.drawCommandsDirty=!0}}_applyAdds(a,b){if(0!==b.length&&
null!==this._bufferWriter)if(N.hasVao(a)){var d=this._bufferWriter,c=d.vertexBufferLayout.stride/4,e=a.numElements,h=b.reduce((t,q)=>t+d.elementCount(q.geometry),0);e=Math.min((e+h)*c,4194304);h=4*e;if(a.vao.byteSize<O(4128768)&&h>a.vao.byteSize)this._applyAndRebuild(a,b,null);else{G.mergeAdjacentRanges(a.holes);var k=[];for(var f of b)h=d.elementCount(f.geometry),h=da(a.holes,h),k.push(h);var n=a.vao.vertexBuffers.geometry,l=0,g=0,p=0,m=B(e),r=d.vertexBufferLayout.createView(m.buffer);b.forEach((t,
q)=>{q=k[q];if(null!=q){if(p!==q){var v=p-g;0<v&&n.setSubData(m,g*c,0,v*c);g=q;l=0}v=d.elementCount(t.geometry);this._writeGeometry(t,r,l);l+=v;p=q+v;q=new M.Instance(t,q,q+v);A.assert(null==a.instances.get(t.id));a.addInstance(t.id,q);a.drawCommandsDirty=!0}});f=p-g;0<f&&n.setSubData(m,g*c,0,f*c);D.filterInPlace(b,(t,q)=>null==k[q])}}else this._applyAndRebuild(a,b,null)}_writeGeometry(a,b,d){if(null!==this._bufferWriter){var c=a.localOrigin.vec3;A.setMatrixTranslation3(Q,-c[0],-c[1],-c[2]);c=E.multiply(ea,
Q,a.transformation);E.invert(C,c);E.transpose(C,C);this._bufferWriter.write(c,C,a.geometry,b,d)}}updateAnimation(a){return this.material.update(a)}prepareTechnique(a){if(!this.material.shouldRender(a))return null;const {output:b,bindParameters:d}=a;var c=this.material.produces.get(d.slot);if(!c||!c(b)||(c=b===w.ShaderOutput.Highlight||b===w.ShaderOutput.ShadowHighlight)&&!this._hasHighlights)return null;const e=b===w.ShaderOutput.ShadowExcludeHighlight,h=!(c||e);for(const f of this._dataByOrigin.values())for(const n of f.buffers){if(c&&
!n.hasHighlights)continue;var k=(c?n.drawCommandsHighlight:e&&n.needsMultipleCommands()?n.drawCommandsShadowHighlightRest:n.drawCommandsDefault)||null;const l=h&&n.drawCommandsOccludees||null;if(k?.length||l?.length)if(k=this._glMaterials.load(a.rctx,d.slot,b),k=null!=k?k.beginSlot(d):null,null!=k)return k}return null}renderNode(a,b){const {output:d,bindParameters:c}=a,e=d===w.ShaderOutput.Highlight||d===w.ShaderOutput.ShadowHighlight,h=d===w.ShaderOutput.ShadowExcludeHighlight,k=!(e||h),f=a.rctx,
n=a.bindParameters.slot===L.RenderSlot.OCCLUDER_MATERIAL;a=a.bindParameters.slot===L.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL;f.runAppleAmdDriverHelper();f.bindTechnique(b,c,this.material.parameters);for(const l of this._dataByOrigin.values())for(const g of l.buffers){if(e&&!g.hasHighlights)continue;const p=(e?g.drawCommandsHighlight:h&&g.needsMultipleCommands()?g.drawCommandsShadowHighlightRest:g.drawCommandsDefault)||null,m=k&&g.drawCommandsOccludees||null;if(p?.length||m?.length)b.program.bindDraw(new aa.DrawParameters(l.origin),
c,this.material.parameters),b.ensureAttributeLocations(g.vao),f.bindVAO(g.vao),p?.length&&(f.setPipelineState(b.getPipeline(!1,n,a)),p.forAll(r=>f.drawArrays(b.primitiveType,r.first,r.count))),m?.length&&(f.setPipelineState(b.getPipeline(!0,n,a)),m.forAll(r=>f.drawArrays(b.primitiveType,r.first,r.count)))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};J.__decorate([V.property({constructOnly:!0})],y.MergedRenderer.prototype,"material",void 0);
y.MergedRenderer=J.__decorate([W.subclass("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],y.MergedRenderer);class P{constructor(a){this.origin=a;this.changes=[]}}const Q=F.create(),ea=F.create(),C=F.create(),u=new U({allocator:a=>a||new G.BufferRange,deallocator:null});let H=new Float32Array(65536);Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});