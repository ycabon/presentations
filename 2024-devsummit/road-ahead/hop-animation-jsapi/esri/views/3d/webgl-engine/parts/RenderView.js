// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/RandomLCG ../../../../core/accessorSupport/decorators/subclass ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/basicInterfaces ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Material ../lib/ObjectAndLayerIdRenderHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/markerTextureRepository ../materials/stippleTextureRepository ../materials/internal/WaterTextureRepository ./contextCache ./requireUtils ./ScreenshotManager ./testUtils ../../../support/RenderState ../../../webgl/contextUtils".split(" "),
function(f,g,z,A,t,u,n,p,B,v,k,V,C,D,E,m,F,G,H,I,J,K,L,w,M,N,O,P,Q,R,x,S,T,U){f.RenderView=class extends z{constructor(a){super({});this.events=new A;this.waterTextures=new P.WaterTextureRepository;this._magnifierHelper=new I.MagnifierHelper;this.objectAndLayerIdRenderHelper=t("enable-feature:objectAndLayerId-rendering")?new K.ObjectAndLayerIdRenderHelper:null;this._idleSuspend=this._needsRender=this._needsUpdate=!0;this._needsWaterReflectionUpdate=!1;this._lastAnimationUpdate=0;this._container=a.container;
this._viewingMode=a.viewingMode;this._initializeContext(a);this.addHandles([p.watch(()=>this.waterTextures?.updating,()=>this.requestRender(),p.initial),p.watch(()=>a.view.qualityProfile,c=>this.renderer?.updateRenderFeatures(c),p.syncAndInitial),this._magnifierHelper.events.on("request-render",()=>this.requestRender())]);const {memoryController:d}=a.view.resourceController;this.stippleTextures=O.createStippleTextureRepository(this._rctx,d);this.markerTextures=N.createMarkerTextureRepository(this._rctx,
d);this._shaderTechniques=new E.ShaderTechniqueRepository({rctx:this._rctx,viewingMode:a.viewingMode,stippleTextureRepository:this.stippleTextures,waterTextureRepository:this.waterTextures,markerTextureRepository:this.markerTextures});this._textures=new M.TextureRepository(a,this._shaderTechniques,this._rctx);this.addHandles(this._textures.events.on("changed",c=>this.requestRender(c)));this._materialRepository=new H.GLMaterialRepository(this._textures,this._shaderTechniques,()=>this.requestRender(),
()=>this.requestRender());this._compositingHelper=new F(this._rctx,this._shaderTechniques);this.renderer=new L.Renderer(a,this._materialRepository,this._textures,this._shaderTechniques,this._rctx,this._compositingHelper,this._magnifierHelper,c=>this.requestRender(c));this._screenshotManager=new x.ScreenshotManager(this._rctx,{renderScene:(c,e,b,h)=>this.renderer.render(c,e,b,h),requestRenderScene:c=>this.requestRender(c),prepareOverlay:()=>a.options.screenshot.prepareOverlay(),renderOverlay:(c,e,
b)=>a.options.screenshot.renderOverlay(c,e,b)},c=>this.events.emit("force-camera-for-screenshot",c));this._registerFrameTask(a)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=n.removeMaybe(this._frameTask);this._shaderTechniques=n.destroyMaybe(this._shaderTechniques);this._componentObjects=n.destroyMaybe(this._componentObjects);this._screenshotManager=n.destroyMaybe(this._screenshotManager);this.renderer.destroy();
this._textures=n.destroyMaybe(this._textures);this._magnifierHelper.destroy();this.waterTextures.destroy();this.markerTextures.destroy();this.stippleTextures.destroy();this._container=this._canvas=null;this._rctx=n.destroyMaybe(this._rctx)}requestRender(a=m.RenderRequestType.UPDATE){this._needsRender=!0;a===m.RenderRequestType.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating||
this._magnifierHelper.updating}get textureRepository(){return this._textures}get compositingHelper(){return this._compositingHelper}set magnifier(a){this._magnifierHelper.magnifier=a}setIdleSuspend(a){this._idleSuspend!==a&&(this._idleSuspend=a,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(a){return this._screenshotManager.takeScreenshot(a).then(d=>d[0])}takeScreenshotWithOID(a){a.objectAndLayerIdColor=
!0;return this._screenshotManager.takeScreenshot(a)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(a,d,c,e,b,h=b){h=e.constrainWindowSize(d,c,b*e.pixelRatio,h*e.pixelRatio);const l=this._ensureDepthBuffer(h);this.renderer.readDepthPixels(e,h,l);b=Number.MAX_VALUE;for(let r=0;r<h[2]*h[3];r++){const q=G.textureToDepth(4*r,l,e.nearFar);b>q&&q!==e.nearFar[0]&&q!==e.nearFar[1]&&(b=q)}a&&(a=a.pickDepth(d*e.pixelRatio,c*e.pixelRatio,e),null!=a&&b>a&&a!==e.nearFar[0]&&a!==e.nearFar[1]&&
(b=a));return b===Number.MAX_VALUE?void 0:b}_ensureDepthBuffer(a){a=4*a[2]*a[3];if(null==this._tmpDepthBuffer||this._tmpDepthBuffer.byteLength<a)this._tmpDepthBuffer=new Uint8Array(a);return this._tmpDepthBuffer}async reloadShaders(){R.removeLoadedShaderModules();await this._shaderTechniques.reloadAll();this.requestRender()}_registerFrameTask(a){const d=a.view.state;let c=!1,e=m.RenderRequestType.BACKGROUND,b=!1;this._frameTask=B.addFrameTask({preRender:({time:h})=>{c=this.updating;e=this._needsUpdate?
m.RenderRequestType.UPDATE:m.RenderRequestType.BACKGROUND;a.commitSyncLayers();var l=v.Milliseconds(h-this._lastAnimationUpdate);if(l>this.renderer.animationTimestep||null!=d.forcedAnimationTime||c||this._needsRender)l=v.Milliseconds(l/this.renderer.animationTimeDilation),l=new J.UpdateParameters(d.camera,l,d.forcedAnimationTime),this.renderer.updateAnimation(l)&&this.requestRender(m.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=h},render:({time:h})=>{if((this._needsRender||!this._idleSuspend||
!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<d.camera.fullWidth&&0<d.camera.fullHeight){const l=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this.renderer.render(d,h);b=!0;l&&this.renderer.hasReflections&&(this.requestRender(m.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:h})=>{const l=new x.ScreenshotContext(d,this.renderer.hasSlicePlane||this._magnifierHelper.enabled||
this.renderer.hasDecorations||this.renderer.hasHighlights,this.renderer.fboCache);this._textures.update();this._screenshotManager.update(l,h)},finish:()=>{b&&(this.renderer.finish(d.mode===T.RenderState.IDLE?e:m.RenderRequestType.UPDATE),b=!1)}})}_initializeContext(a){const d=a.options;this._canvas=d.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const c=U.createContext(this._canvas,{alpha:d.alpha||
!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:d.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:d.preserveDrawingBuffer??!1});null==c?u.getLogger(this).error("A WebGL2 context could not be created."):(this._rctx=this._newRenderingContext(c,a),this._loadShaderOnlyExtensions(),!d.alpha&&this._rctx.contextAttributes.alpha&&u.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=t("safari")&&
(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))}_newRenderingContext(a,d){const c={disabledExtensions:d.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:d.options.debugWebGLExtensions||{},maxAnisotropy:8},e=(b,h)=>d.view.resourceController.memoryController.newCache(b,h);if(S.contextCache.enabled){let b=y.get(a);if(b)return b.configure(c),b.newCache=e,b.ref(),b;b=new w.RenderingContext(a,c,e);y.set(a,b);b.ref();return b}return new w.RenderingContext(a,
c,e)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(a){return null!=this.objectAndLayerIdRenderHelper?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(a):null}get componentObjectCollection(){null==this._componentObjects&&(this._componentObjects=new D.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode));return this._componentObjects}set componentObjectCollection(a){this._componentObjects=a}};g.__decorate([k.property({type:Boolean,
readOnly:!0})],f.RenderView.prototype,"updating",null);g.__decorate([k.property()],f.RenderView.prototype,"_rctx",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_container",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_canvas",void 0);g.__decorate([k.property()],f.RenderView.prototype,"stippleTextures",void 0);g.__decorate([k.property()],f.RenderView.prototype,"markerTextures",void 0);g.__decorate([k.property()],f.RenderView.prototype,"waterTextures",void 0);g.__decorate([k.property()],
f.RenderView.prototype,"_magnifierHelper",void 0);g.__decorate([k.property({readOnly:!0})],f.RenderView.prototype,"objectAndLayerIdRenderHelper",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_textures",void 0);g.__decorate([k.property({readOnly:!0})],f.RenderView.prototype,"renderer",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_screenshotManager",void 0);g.__decorate([k.property()],f.RenderView.prototype,"componentObjectCollection",null);g.__decorate([k.property()],f.RenderView.prototype,
"_componentObjects",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_needsUpdate",void 0);g.__decorate([k.property()],f.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);f.RenderView=g.__decorate([C.subclass("esri.views.3d.webgl-engine.parts.RenderView")],f.RenderView);const y=Q.getContextCache();Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});