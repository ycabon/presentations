// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../chunks/tslib.es6 ../core/arrayUtils ../core/Collection ../core/Evented ../core/MapUtils ../core/maybe ../core/ReactiveMap ../core/reactiveUtils ../core/SetUtils ../core/accessorSupport/decorators/property ../core/has ../core/Logger ../core/accessorSupport/decorators/subclass ../rest/support/Query".split(" "),function(l,n,r,k,x,t,y,u,z,m,C,D,A,v){k=class extends k.EventedAccessor{constructor(a){super(a);this._selectionMap=new y;this._trashCan=[];this._layerEditHandles=new r;this.showHighlight=
!0}initialize(){this.addHandles([u.watch(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),u.on(()=>this.sources,"change",b=>{const c=this._selectionMap;for(const d of b.removed)c.delete(d);this._refreshListeners();this._refreshVisualization()},{onListenerAdd:()=>this._refreshListeners()})]);const a=new r;this.view.when().then(()=>{this.view.map.allLayers.flatten(b=>"layers"in b?b.layers:"sublayers"in b&&b.sublayers?b.sublayers:null).forEach(b=>{void 0!==b.createQuery&&void 0!==
b.on&&a.add(b)});this._set("sources",a)})}destroy(){this._layerEditHandles.drain(t.removeMaybe)}get selections(){return Array.from(this._selectionMap.entries()).map(a=>{const [b,c]=a;return{layer:b,selection:[...c.selection]}})}get count(){let a=0;for(const b of this._selectionMap.values())a+=b.selection.length;return a}get hasSelection(){return 0<this.count}get sources(){return this._get("sources")}set sources(a){this._set("sources",a)}async getSelectedFeatures(a,b={},c="layerView"){const {view:d,
selections:f}=this,g=(void 0!==a?f.filter(e=>a.includes(e.layer)):f).filter(e=>0<e.selection.length).map(async e=>{var h=d.map.findLayerByUid(e.layer.uid);if(void 0===h)return null;if("layer"===c)return w(e.layer,e.selection,b);h=await d.whenLayerView(h);return w(h,e.selection,b)});return(await Promise.all(g)).filter(e=>null!==e)}updateSelection(a){var b=new Map;for(const [e,h]of this._selectionMap)b.set(e,[...h.selection]);var c=!1,d=a.current.concat(a.added);for(var f of d){var g=f.sourceLayer;
d=f.getObjectId();this.sources.includes(g)&&void 0!==g.createQuery&&void 0!==g.on&&null!==d&&(g=x.getOrCreateMapValue(b,g,()=>[]),g.includes(d)||(g.push(d),c=!0))}for(const e of a.removed)f=e.sourceLayer,a=e.getObjectId(),this.sources.includes(f)&&null!==a&&(f=b.get(f),a=f?.indexOf(a),void 0!==a&&0<=a&&(f?.splice(a,1),c=!0));if(c){const {_selectionMap:e,_trashCan:h}=this;c=[];for(const [p,q]of b)b=e.get(p),void 0!==b&&h.push(b),e.set(p,{selection:q}),c.push({layer:p,selection:q,...n.difference(void 0!==
b?b.selection:[],q)});this._onSelectionChange(c)}}setSelection(a,b){this._setSelection(a,b)}getSelection(a){return this._selectionMap.get(a)?.selection}appendToSelection(a,b){var c=this._selectionMap.get(a);c=void 0!==c?[...c.selection]:[];for(const d of b)c.includes(d)||c.push(d);this._setSelection(a,c)}removeFromSelection(a,b){const c=this._selectionMap.get(a);if(c){var d=[];for(const f of c.selection)b.includes(f)||d.push(f);this._setSelection(a,d)}}toggleInSelection(a,b){var c=this._selectionMap.get(a);
c&&0!==c.selection.length?(c=new Set(c.selection),b=new Set(b),b=z.symmetricDifference(c,b),this._setSelection(a,Array.from(b))):this._setSelection(a,b)}clear(){var a=this._selectionMap.values();this._trashCan.push(...a);a=[];for(const [b,c]of this._selectionMap.entries())a.push({layer:b,added:[],removed:[...c.selection],selection:[]});this._selectionMap.clear();this._onSelectionChange(a)}_onSelectionChange(a){this._refreshVisualization();this.emit("selection-change",{view:this.view,changes:a})}_refreshVisualization(){if(null!=
this.view&&null!=this.sources){for(;0<this._trashCan.length;)this._trashCan.pop()?.highlightHandle?.remove();var {sources:a,view:b,_selectionMap:c,showHighlight:d}=this;for(const f of a){const g=c.get(f),e=b.map.findLayerByUid(f.uid);void 0!==e&&b.whenLayerView(e).then(h=>{g?.highlightHandle?.remove();void 0!==g&&d&&"highlight"in h&&"function"===typeof h.highlight&&0<g.selection.length&&(g.highlightHandle=h.highlight(g.selection,"selection"))})}}}_refreshListeners(){this._layerEditHandles.drain(t.removeMaybe);
for(const a of this.sources)if(void 0!==a.createQuery&&void 0!==a.on){const b=a.on("edits",c=>{this._handleEditChanges(c,a)});this._layerEditHandles.push(b)}}_handleEditChanges(a,b){void 0!==a.deletedFeatures&&0<a.deletedFeatures.length&&this._selectionMap.has(b)&&(a=a.deletedFeatures.filter(c=>null==c.error).map(c=>c.objectId).filter(n.isSome),this.removeFromSelection(b,a))}_setSelection(a,b){if(!this.sources.includes(a))throw Error(`Cannot set selection on layer ${a.title} because it is not in 'sources'`);
const c=this._selectionMap.get(a);void 0!==c&&B(c,{selection:b})||(void 0!==c&&this._trashCan.push(c),this._selectionMap.set(a,{selection:[...b]}),a={layer:a,selection:[...b],...n.difference(void 0!==c?c.selection:[],b)},this._onSelectionChange([a]))}};l.__decorate([m.property({readOnly:!0,nonNullable:!0})],k.prototype,"selections",null);l.__decorate([m.property({readOnly:!0,nonNullable:!0})],k.prototype,"count",null);l.__decorate([m.property({constructOnly:!0,nonNullable:!0})],k.prototype,"view",
void 0);l.__decorate([m.property({readOnly:!0,nonNullable:!0})],k.prototype,"hasSelection",null);l.__decorate([m.property()],k.prototype,"showHighlight",void 0);l.__decorate([m.property()],k.prototype,"sources",null);k=l.__decorate([A.subclass("esri.views.SelectionManager")],k);const B=(a,b)=>{if(null!=a||null!=b){if(null!=a&&null==b||null==a&&null!=b)return!1;if(null!=a&&null!=b&&null!=a.selection&&null!=b.selection){a=[...a.selection];b=[...b.selection];if(a.length!==b.length)return!1;a.sort();
b.sort();for(let c=0;c<a.length;c++)if(a[c]!==b[c])return!1}}return!0},w=async(a,b,c={})=>void 0===a.layer?void 0===a?null:await a.queryFeatures(new v({...c,objectIds:b})).then(d=>({data:d,layer:a})):void 0===a?null:await a.queryFeatures(new v({...c,objectIds:b})).then(d=>({data:d,layer:a.layer}));return k});