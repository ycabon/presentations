// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../Graphic ../../core/Evented ../../core/handleUtils ../../core/maybe ../../core/memoize ../../core/quantityUtils ../../core/reactiveUtils ../../core/unitUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/graphics/dehydratedFeatureComparison ../../support/elevationInfoUtils ./support/createUtils ./support/helpMessageUtils ./support/surfaceCoordinateSystems ../interactive/InteractiveToolBase ../interactive/keybindings ../interactive/sketch/SketchOptions ../interactive/tooltip/constraintUtils ../interactive/tooltip/DrawTooltipInfos ../interactive/tooltip/Tooltip ../support/angularMeasurementUtils ../support/automaticAreaMeasurementUtils ../support/automaticLengthMeasurementUtils ../../core/accessorSupport/trackingUtils".split(" "),
function(d,f,N,O,A,C,G,q,H,P,g,Y,Z,aa,Q,R,S,I,v,D,T,U,V,J,B,x,W,X,K,z,L){class M{constructor(){this.rectangle=this.circle=this.cursorEdge=this.outline=this.full=this.cursorVertex=this.committedVertices=null}}d.DrawGraphicTool=class extends O.EventedMixin(U.InteractiveToolBase){constructor(a){super(a);this._createOperationGeometry=this._graphic=null;this.defaultZ=0;this.geometryType=this.directionOptions=null;this.hasZ=!0;this.snappingManager=this.mode=this.geometryToPlace=null;this.snapToScene=!1;
this.sketchOptions=new J;this._getPointConstraint=G.memoize(B.getPointConstraint);this._getPolylineOrPolygonConstraint=G.memoize(B.getPolylineOrPolygonConstraint)}initialize(){this.internalGraphicsLayer=new R({listMode:"hide",internal:!0});this.view.map.layers.add(this.internalGraphicsLayer);const a=this.drawOperation=this.makeDrawOperation(),{sketchOptions:b}=this,c=this.view.type;this.tooltipInfos={point:new x.DrawPointTooltipInfo({sketchOptions:b,viewType:c}),polyline:new x.DrawPolylineTooltipInfo({sketchOptions:b,
viewType:c}),polygon:new x.DrawPolygonTooltipInfo({sketchOptions:b,viewType:c}),mesh:new x.DrawMeshTooltipInfo({sketchOptions:b,viewType:c}),rectangle:new x.DrawRectangleTooltipInfo({sketchOptions:b}),circle:new x.DrawCircleTooltipInfo({sketchOptions:b})};this.tooltip=new W.Tooltip({view:this.view});this._initializeConstraints();this.addHandles([a.on("vertex-add",e=>this.onVertexAdd(e)),a.on("vertex-remove",e=>this.onVertexRemove(e)),a.on("vertex-update",e=>this.onVertexUpdate(e)),a.on("cursor-update",
e=>this.onCursorUpdate(e)),a.on("cursor-remove",()=>this._updateGraphic()),a.on("complete",e=>this.onComplete(e)),H.watch(()=>this.cursor,e=>a.cursor=e,H.syncAndInitial),L.autorun(()=>this._updateTooltipInfo()),L.autorun(()=>{a.constraintZ=this._constraintZ})]);this.finishToolCreation()}destroy(){this.drawOperation=C.destroyMaybe(this.drawOperation);this.tooltip=C.destroyMaybe(this.tooltip);this._destroyAllVisualizations();this.view.map.remove(this.internalGraphicsLayer);this.internalGraphicsLayer=
C.destroyMaybe(this.internalGraphicsLayer);this._set("view",null)}get _defaultElevation(){return q.createLength(this.defaultZ,"meters")}get _inputModeAvailable(){const {inputEnabled:a,visibleElements:b}=this.sketchOptions.tooltips;return a&&!0===this.activeTooltipInfo?.editableFields.some(c=>!0===b[c.name])}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(a){this._set("centered",a);this._updateGraphic()}get cursor(){return this._get("cursor")}set cursor(a){this._set("cursor",
a)}set enabled(a){this.drawOperation.interactive=a;this._set("enabled",a)}set forceUniformSize(a){this._set("forceUniformSize",a);this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(a){this._set("graphicSymbol",a);null!=this._graphic&&(this._graphic.symbol=a)}get updating(){return this.drawOperation?.updating??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(a){if(!this.destroyed)if("key-down"===a.type&&a.key===V.tooltipKeys.enterInputMode&&this._inputModeAvailable)this.tooltip.enterInputMode(),
a.stopPropagation();else this.drawOperation.onInputEvent(a)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo();0===this.drawOperation.numCommittedVertices&&this._initializeConstraints()}_destroyAllVisualizations(){this.removeHandles(t.outline);this.removeHandles(t.regularVertices);this.removeHandles(t.activeVertex);this.removeHandles(t.activeEdge);this.removeHandles(E)}_createOrUpdateGraphic(a){if(null!=this._graphic)return this.updateGraphicGeometry(a),this._graphic;const b=
new N({...this.graphicProperties,symbol:this.graphicSymbol});this._graphic=b;this.updateGraphicGeometry(a);this.internalGraphicsLayer.add(b);this.addHandles(this.initializeGraphic(b));this.notifyChange("graphic");this.addHandles(A.makeHandle(()=>{this.internalGraphicsLayer.remove(b);this._graphic===b&&(this._graphic=null)}),E);return b}updateGraphicGeometry(a){this._graphic.geometry=a}_getCreateOperationGeometry(a={operationComplete:!1}){if(null!=this.drawOperation){var {coordinateHelper:b,view:c,
visualizationCursorVertex:e,lastVertex:h,committedVertices:m,geometryIncludingUncommittedVertices:p,numCommittedVertices:n}=this.drawOperation;if(0<n||null!=e){var l=a.operationComplete?m:p,r=l.length,u=null!=e?b.pointToArray(e):null,w=c.spatialReference,y="3d"===c.type&&"global"===c.viewingMode,k=new M;k.committedVertices=m;k.cursorVertex=u;var {geometryType:F}=this;switch(F){case "point":case "mesh":k.full=b.arrayToPoint(l[0]);break;case "multipoint":k.full=0<r?v.createMultipoint(l,w):null;break;
case "polyline":case "polygon":0<r&&(k.full="polygon"===F?v.createPolygon([l],w,y,!0):v.createPolyline([l],w,y),k.cursorEdge=null!=u&&h&&!S.pointEquals(e,h)?v.createPolyline([[u,b.pointToArray(h)]],w,y):null,k.outline=1<r?k.full:null);break;case "circle":case "rectangle":k.committedVertices=k.cursorVertex=null;if(!r)break;u=T.createViewAlignedCoordinateSystem(c,l[0]);w=l[0];y=u.makeMapPoint(w[0]+48*c.resolution,w[1]);"circle"===F?1===r&&a.operationComplete?k.circle=v.createCircle([w,y],u,!0):2===
r&&(this.forceUniformSize?k.circle=v.createCircle(l,u,this.centered):k.rectangle=v.createEllipse(l,u,this.centered)):1===r&&a.operationComplete?k.rectangle=v.createSquare([w,y],u,!0):2===r&&(k.rectangle=this.forceUniformSize?v.createSquare(l,u,this.centered):v.createRectangle(l,u,this.centered));k.full=null!=k.circle?k.circle.geometry:k.rectangle?.geometry;k.outline="polygon"===k.full?.type?k.full:null;break;default:return null}return k}}}initializeGraphic(a){return A.makeHandle()}onComplete(a){if(this.drawOperation){this._updateGraphic();
var b=null;if(this.drawOperation.isCompleted){const c=this._getCreateOperationGeometry({operationComplete:!0});null!=c&&(b=this._createOrUpdateGraphic(c.full))}this._createOperationGeometry=null;this.emit("complete",{graphic:b,...a})}}onCursorUpdate(a){this._updateGraphic();this.emit("cursor-update",a)}onDeactivate(){const {drawOperation:a}=this;a&&(a.isCompleted||a.cancel())}onOutlineChanged(a){return A.makeHandle()}onCursorEdgeChanged(a){return A.makeHandle()}onVertexAdd(a){this._updateGraphic();
this._unlockConstraintsOnVertexAddOrRemove();this._lockElevationOnVertexAdd(a.vertices.at(0)?.coordinates);this.emit("vertex-add",a)}onVertexRemove(a){this._updateGraphic();this._unlockConstraintsOnVertexAddOrRemove();this.emit("vertex-remove",a)}onVertexUpdate(a){this._updateGraphic();this.emit("vertex-update",a)}_updateGraphic(){const a=this._getCreateOperationGeometry();this._createOperationGeometry=a;null==a?this._destroyAllVisualizations():(null!=a.cursorEdge?this.addHandles(this.onCursorEdgeChanged(a.cursorEdge),
t.activeEdge):this.removeHandles(t.activeEdge),null!=a.outline?this.addHandles(this.onOutlineChanged(a.outline),t.outline):this.removeHandles(t.outline),null!=a.committedVertices?this.addHandles(this.onRegularVerticesChanged(a.committedVertices),t.regularVertices):this.removeHandles(t.regularVertices),null!=a.cursorVertex?this.addHandles(this.onActiveVertexChanged(a.cursorVertex),t.activeVertex):this.removeHandles(t.activeVertex),null!=a.full?this._createOrUpdateGraphic(a.full):this.removeHandles(E))}get activeTooltipInfo(){const {drawOperation:a,
graphic:b,view:c}=this;if(!a)return null;const e=this.tooltipInfos,h=b?.geometry?.type;switch(this.geometryType){case "point":return"2d"===c.type&&0===this.defaultZ?null:"point"===h?e.point:null;case "polyline":return"polyline"===h?e.polyline:null;case "polygon":return"polygon"===h?e.polygon:null;case "rectangle":return"polygon"===h?e.rectangle:null;case "circle":return"polygon"===h?e.circle:null;case "mesh":return"mesh"===h?e.mesh:null;default:return null}}_updateTooltipInfo(){const {activeTooltipInfo:a,
tooltip:b,sketchOptions:c}=this;switch(a?.type){case "draw-point":this._updateDrawPointTooltipInfo(a);break;case "draw-polyline":this._updateDrawPolylineTooltipInfo(a);break;case "draw-polygon":this._updateDrawPolygonTooltipInfo(a);break;case "draw-rectangle":this._updateDrawRectangleTooltipInfo(a);break;case "draw-circle":this._updateDrawCircleTooltipInfo(a);break;case "draw-mesh":this.updateDrawMeshTooltipInfo(a)}b.view=this.view;b.info=c.tooltips.effectiveEnabled?a:null}_updateDrawPointTooltipInfo(a){const {drawOperation:b,
graphic:c,view:e,sketchOptions:h}=this,{coordinateHelper:m,cursorVertex:p}=b;a.sketchOptions=h;a.viewType=e.type;a.helpMessage=D.getDrawHelpMessage("point",c?.geometry);this.updateElevation(a.elevation);if(p){var n=B.getConstraintContext(p,e,m.spatialReference,this._constraintElevationInfo,m.hasZ(),h.values.effectiveDirectionMode);b.constraintInfo={context:n,constraint:this._getPointConstraint(a.elevation.committed,n)}}else b.constraintInfo=void 0}_updateDrawPolylineTooltipInfo(a){var b=this._createOperationGeometry;
b=null!=b?b.full:null;if("polyline"===b?.type){this._updatePolylineOrPolygonCommon(a);var c=z.autoLength2D(b);a.totalLength.actual=c??q.zeroMeters;a.sketchOptions=this.sketchOptions;a.viewType=this.view.type;a.helpMessage=D.getDrawHelpMessage("polyline",b)}}_updateDrawPolygonTooltipInfo(a){var b=this._createOperationGeometry;b=null!=b?b.full:null;if("polygon"===b?.type){this._updatePolylineOrPolygonCommon(a);var c=K.autoArea2D(b);a.area.actual=c??q.zeroSquareMeters;a.sketchOptions=this.sketchOptions;
a.viewType=this.view.type;a.helpMessage=D.getDrawHelpMessage("polygon",b)}}_updatePolylineOrPolygonCommon(a){const {view:b,drawOperation:c,sketchOptions:e}=this,{coordinateHelper:h,cursorVertex:m,lastVertex:p,secondToLastVertex:n}=c;var l=e.values.effectiveDirectionMode,r=p&&m?z.autoDistanceBetweenPoints2D(p,m):null;a.distance.actual=r??q.zeroMeters;a.distance.readOnly=null==p;a.direction.actual=null;a.direction.readOnly=!0;p&&m&&("absolute"===l||n)&&(r=X.directionForVertices(n,p,m,l),a.direction.actual=
r??q.zeroDegreesGeographic,a.direction.readOnly=!1);this.updateElevation(a.elevation);(r=m??p)?(l=B.getConstraintContext(r,b,h.spatialReference,this._constraintElevationInfo,h.hasZ(),l),c.constraintInfo={context:l,constraint:this._getPolylineOrPolygonConstraint(p,n,a.distance.committed,a.direction.committed,a.elevation.committed,l)}):c.constraintInfo=void 0}updateDrawMeshTooltipInfo(a){}_updateDrawRectangleTooltipInfo(a){a.sketchOptions=this.sketchOptions;a.xSize=this._xSize??q.zeroMeters;a.ySize=
this._ySize??q.zeroMeters;a.area=this._fullGeometryArea??q.zeroSquareMeters}_updateDrawCircleTooltipInfo(a){const {forceUniformSize:b}=this;a.sketchOptions=this.sketchOptions;a.radius=b?this._circleRadius??q.zeroMeters:null;a.xSize=b?null:this._xSize??q.zeroMeters;a.ySize=b?null:this._ySize??q.zeroMeters;a.area=this._fullGeometryArea??q.zeroSquareMeters}get _circleRadius(){const a=this._createOperationGeometry;return null!=a?.circle?.center&&null!=a.circle.edge?z.autoDistanceBetweenPoints2D(a.circle.center,
a.circle.edge):null}get _xSize(){const a=this._createOperationGeometry?.rectangle?.midpoints;return null!=a?z.autoDistanceBetweenPoints2D(a.left,a.right):null}get _ySize(){const a=this._createOperationGeometry?.rectangle?.midpoints;return null!=a?z.autoDistanceBetweenPoints2D(a.top,a.bottom):null}get _fullGeometryArea(){const a=this._createOperationGeometry?.full;return"polygon"!==a?.type?null:K.autoArea2D(a)}updateElevation(a){a.actual=this._tooltipActualElevation;a.visible="3d"===this.view.type&&
this.hasZ;a.readOnly=!1}get _tooltipActualElevation(){var {drawOperation:a}=this;a=a?.cursorVertex??a?.lastVertex;if(null==a)return this._defaultElevation;const {x:b,y:c,z:e}=a;return this._getConvertedVertexElevation(b,c,e,this._constraintElevationInfo)??this._defaultElevation}get _constraintElevationInfo(){return this.drawOperation?.elevationInfo??I.absoluteHeightElevationInfo}get _constraintZ(){const {geometryType:a}=this;switch(a){case "point":case "mesh":case "polyline":case "polygon":return this.tooltipInfos[a].elevation.committed?.value}}_initializeConstraints(){const {directionOptions:a,
drawOperation:b,geometryType:c,tooltipInfos:e,sketchOptions:h}=this,m=n=>{const l=b.elevationInfo?.mode;n=e[n].elevation;"relative-to-ground"===l||"relative-to-scene"===l?n.lock(q.zeroMeters):n.unlock()},p=n=>{a&&(n=e[n].direction,n.committed=a.angle,n.unlockOnVertexPlacement=!1,h.values.directionMode=a.mode)};switch(c){case "polygon":case "polyline":m(c);p(c);break;case "point":case "mesh":m(c)}}_lockElevationOnVertexAdd(a){const {activeTooltipInfo:b,drawOperation:c,view:e}=this,h=this._constraintElevationInfo;
if("2d"!==e.type&&a&&"absolute-height"===h.mode&&1===c?.numCommittedVertices&&b&&("draw-polyline"===b.type||"draw-polygon"===b.type)&&!b.elevation.locked){var [m,p,n]=a;a=this._getConvertedVertexElevation(m,p,n,h);null!=a&&b.elevation.lock(a)}}_unlockConstraintsOnVertexAddOrRemove(){this.activeTooltipInfo?.allFields.forEach(a=>{a.unlockOnVertexPlacement&&a.unlock()})}_getConvertedVertexElevation(a,b,c,e){const {view:h,drawOperation:m}=this;if("3d"===h.type&&m){var {spatialReference:p}=m.coordinateHelper;
c??=0;a=(I.getConvertedElevationFromXYZ(h,a,b,c,p,m.elevationInfo,e)??0)*P.getMetersPerVerticalUnitForSR(p);return q.createLength(a,"meters")}}};f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_createOperationGeometry",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_defaultElevation",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_inputModeAvailable",null);f.__decorate([g.property({value:!0})],d.DrawGraphicTool.prototype,"centered",null);f.__decorate([g.property()],
d.DrawGraphicTool.prototype,"cursor",null);f.__decorate([g.property({nonNullable:!0})],d.DrawGraphicTool.prototype,"defaultZ",void 0);f.__decorate([g.property({constructOnly:!0})],d.DrawGraphicTool.prototype,"directionOptions",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"drawOperation",void 0);f.__decorate([g.property({value:!0})],d.DrawGraphicTool.prototype,"enabled",null);f.__decorate([g.property({value:!0})],d.DrawGraphicTool.prototype,"forceUniformSize",null);f.__decorate([g.property({constructOnly:!0})],
d.DrawGraphicTool.prototype,"geometryType",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"graphic",null);f.__decorate([g.property({constructOnly:!0})],d.DrawGraphicTool.prototype,"graphicProperties",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"graphicSymbol",null);f.__decorate([g.property({constructOnly:!0})],d.DrawGraphicTool.prototype,"hasZ",void 0);f.__decorate([g.property({constructOnly:!0})],d.DrawGraphicTool.prototype,"geometryToPlace",void 0);f.__decorate([g.property({constructOnly:!0})],
d.DrawGraphicTool.prototype,"mode",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"snappingManager",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"snapToScene",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"tooltip",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"tooltipInfos",void 0);f.__decorate([g.property({constructOnly:!0,type:J})],d.DrawGraphicTool.prototype,"sketchOptions",void 0);f.__decorate([g.property({readOnly:!0})],
d.DrawGraphicTool.prototype,"updating",null);f.__decorate([g.property({constructOnly:!0,nonNullable:!0})],d.DrawGraphicTool.prototype,"view",void 0);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"activeTooltipInfo",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_circleRadius",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_xSize",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_ySize",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,
"_fullGeometryArea",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_tooltipActualElevation",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_constraintElevationInfo",null);f.__decorate([g.property()],d.DrawGraphicTool.prototype,"_constraintZ",null);d.DrawGraphicTool=f.__decorate([Q.subclass("esri.views.draw.DrawGraphicTool")],d.DrawGraphicTool);const E=Symbol("create-operation-graphic"),t={outline:Symbol("outline-visual"),regularVertices:Symbol("regular-vertices-visual"),
activeVertex:Symbol("active-vertex-visual"),activeEdge:Symbol("active-edge-visual")};d.CreateOperationGeometry=M;d.geometryTypeToDrawOperationGeometryType=function(a){switch(a){case "point":case "polyline":case "polygon":case "multipoint":return a;case "circle":case "rectangle":return"segment";case "mesh":return"point"}};Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});