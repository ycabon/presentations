// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/scheduling","./GamepadInputDevice","./GamepadState"],function(h,l,m,f){class n{constructor(a,c){this._element=a;this._input=c;this._hasEventListeners=!1;this._onConnectGamepad=b=>{this._connectGamepad(b.gamepad)};this._onDisconnectGamepad=b=>{b=b.gamepad;const d=b.index,e=this._inputDevices[d];e&&(this._emitGamepadEvent(b,f.extractState(e),!1),this._inputDevices.splice(d,1),this._latestUpdate.splice(d,1),this._input.gamepad.devices.remove(e),this.ensurePollingState())};
this._frameTask=null;this._latestUpdate=[];this._inputDevices=[];this._callback=null;a=window.isSecureContext;if(this.supported="getGamepads"in window.navigator&&a)this._forEachGamepad(b=>this._connectGamepad(b)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState()}destroy(){this.hasEventListeners=!1;this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),
window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(a){this._hasEventListeners!==a&&(this._hasEventListeners=a,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&0<this._inputDevices.length&&this._hasEventListeners}set onEvent(a){this._callback=a}_connectGamepad(a){const c=new m(a);"unknown"!==c.deviceType&&(this._inputDevices[a.index]=c,this._input.gamepad.devices.add(c));this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?
this._startPolling():this._stopPolling()}_startPolling(){null==this._frameTask&&(this._frameTask=l.addFrameTask({update:()=>this._readGamepadState()}))}_stopPolling(){null!=this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=[])}_readGamepadState(){const a=document.hasFocus(),c=this._element.contains(document.activeElement),b="document"===this._input.gamepad.enabledFocusMode&&!a||"view"===this._input.gamepad.enabledFocusMode&&!c;this._forEachGamepad(d=>{var e=this._inputDevices[d.index];
if(e){var g=this._latestUpdate[d.index];e=f.extractState(e);var k=b||f.stateIdle(e);g&&(g.timestamp===d.timestamp||!g.active&&k||f.stateEqual(g.state,e))||this._emitGamepadEvent(d,e,!k)}})}_forEachGamepad(a){const c=window.navigator.getGamepads();for(let b=0;b<c.length;b++){const d=c[b];this._validate(d)&&a(d)}}_emitGamepadEvent(a,c,b){var d=this._latestUpdate[a.index];if((d=d&&d.active)||b)this._latestUpdate[a.index]={timestamp:a.timestamp,state:c,active:b},this._callback&&this._callback({device:this._inputDevices[a.index],
state:c,action:!d&&b?"start":d&&b?"update":"end"})}_validate(a){if(!a||!a.connected)return!1;for(let c=0;c<a.axes.length;c++)if(isNaN(a.axes[c]))return!1;return!0}}h.GamepadSource=n;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});