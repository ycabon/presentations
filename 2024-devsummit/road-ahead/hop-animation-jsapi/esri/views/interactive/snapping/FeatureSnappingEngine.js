// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/handleUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/Logger ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../core/libs/gl-matrix-2/math/vec2 ../../../chunks/vec32 ../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../core/libs/gl-matrix-2/math/common ../../../core/support/UpdatingHandles ../../../support/elevationInfoUtils ../sketch/constraints ../sketch/normalizedPoint ./FeatureSnappingSourceInfo ./SnappingDomain ./snappingUtils ./candidates/DrapedEdgeSnappingCandidate ./candidates/EdgeSnappingCandidate ./candidates/FeatureSnappingCandidate ./candidates/RightAngleSnappingCandidate ../support/viewUtils".split(" "),
function(q,k,n,G,H,t,I,x,r,T,U,V,J,u,y,z,K,L,A,M,l,B,N,C,O,P,Q,D,E){function R({constraint:{start:a,end:c}}){const b=y.squaredDistance(a,c);a=u.squaredDistance(l.asVec2(a),l.asVec2(c));return b<K.getEpsilon()||1E-4>a/b}function v(a,c,b,d,g,f,{spatialReference:e}){c=y.copy(S,c);c[0]+=b;c[1]+=d;c[2]+=g;return(b=E.vectorToScreenPoint(c,e,A.absoluteHeightElevationInfo,f))?C.screenDistance(b,a):Infinity}k.FeatureSnappingEngine=class extends G{get updating(){return this._snappingSources.some(a=>null==a||
a.valid&&a.snappingSource.updating)||this._updatingHandles.updating}constructor(a){super(a);this.options=null;this._domain=N.SnappingDomain.FEATURE;this._updatingHandles=new L.UpdatingHandles;this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const a=I.mapCollectionAsync(()=>this.options?.featureSources,(c,b)=>this._createSourceInfo(c,
b));this._snappingSources=a;this.addHandles(H.destroyHandle(a))}destroy(){this._set("options",null);this._updatingHandles.destroy()}async fetchCandidates(a,c,b,d){if(!(c&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const g=[];c=this._computeScreenSizeDistanceParameters(a,b);for(const e of this._snappingSources){if(null==e||!e.valid||!e.snappingSource.layerSource.enabled||e.layerView?.suspended)continue;const h=e.getFetchCandidatesParameters(a,b,c);for(var f of h)g.push(e.snappingSource.fetchCandidates(f,
d).then(m=>m.filter(w=>!this._candidateIsExcluded(e.snappingSource,w,b.excludeFeature))))}f=(await t.allSettledValues(g)).flat();this._addRightAngleCandidates(f,a,c,b);t.throwIfAborted(d);C.sortCandidatesInPlace(a,f);return f}_addRightAngleCandidates(a,c,b,d){var g=null!=d.vertexHandle?d.vertexHandle.rightEdge?.rightVertex?.pos:null!=d.editGeometryOperations&&"polygon"===d.editGeometryOperations.data.type?d.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,f=null!=d.vertexHandle?
d.vertexHandle.leftEdge?.leftVertex?.pos:null!=d.editGeometryOperations?d.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:e}=this;g=l.fromAnyMapPoint(g,e,d);d=l.fromAnyMapPoint(f,e,d);f=a.length;for(e=0;e<f;e++)this._addRightAngleCandidate(a[e],d,c,b,a),this._addRightAngleCandidate(a[e],g,c,b,a)}_addRightAngleCandidate(a,c,b,d,g){var f;(f=null==c)||(f=!((a instanceof P.EdgeSnappingCandidate||a instanceof O.DrapedEdgeSnappingCandidate)&&!R(a)));if(!f){f=a.constraint.closestTo(c);
var e=(f[0]-b[0])/d.x;b=(f[1]-b[1])/d.y;var {start:h,end:m}=a.constraint;1>=e*e+b*b&&(a=new D.RightAngleSnappingCandidate({targetPoint:f,otherVertex:c,otherVertexType:D.OtherVertexType.NEXT,previousVertex:u.squaredDistance(l.asVec2(f),l.asVec2(h))>u.squaredDistance(l.asVec2(f),l.asVec2(m))?h:m,constraint:new M.VerticalHalfPlaneConstraint(c,f),objectId:a.objectId,isDraped:a.isDraped}),g.push(a))}}_computeScreenSizeDistanceParameters(a,c){let b=null!=this.options?this.options.distance*("touch"===c.pointer?
this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:b,y:b,z:b,distance:b}:"2d"===this.view.type?(b*=this.view.resolution,{x:b,y:b,z:b,distance:b}):this._computeScreenSizeDistanceParameters3D(a,b,this.view,c)}_computeScreenSizeDistanceParameters3D(a,c,b,d){var {spatialReference:g}=d;b.renderCoordsHelper.toRenderCoords(a,g,F);const f=b.state.camera.computeScreenPixelSizeAt(F);var e=f*b.renderCoordsHelper.unitInMeters,h=e/x.getMetersPerUnitForSR(g);const m=e/x.getMetersPerVerticalUnitForSR(g);
e=c*h;const w=c*m,p=E.vectorToScreenPoint(a,g,A.absoluteHeightElevationInfo,b);g=p?v(p,a,h,0,0,b,d):0;h=p?v(p,a,0,h,0,b,d):0;a=p?v(p,a,0,0,m,b,d):0;return{x:0===g?0:e/g,y:0===h?0:e/h,z:0===a?0:w/a,distance:f*c}}_candidateIsExcluded(a,c,b){if(null==b)return!1;c=this._getCandidateObjectId(c);if(null==c)return!1;a=a.layerSource.layer;return"graphics"===a.type?b.uid===c:b.sourceLayer===a&&b.attributes&&"objectIdField"in a?b.attributes[a.objectIdField]===c:!1}_getCandidateObjectId(a){return a instanceof
Q.FeatureSnappingCandidate?a.objectId:null}async _createSourceInfo(a,c){const b=a.layer;b.loaded||(await b.load(),t.throwIfAborted(c));const {view:d}=this;a=await this._createFeatureSnappingSourceType(a);t.throwIfAborted(c);return null==a?new B.FeatureSnappingSourceInfo({}):new B.FeatureSnappingSourceInfo({snappingSource:a,view:d,layer:b})}async _createFeatureSnappingSourceType(a){switch(a.layer.type){case "feature":case "geojson":case "csv":case "oriented-imagery":case "subtype-group":case "wfs":return this._createFeatureSnappingSourceFeatureLayer(a);
case "graphics":return this._createFeatureSnappingSourceGraphicsLayer(a);case "map-notes":return this._createFeatureSnappingSourceMapNotesLayer(a);case "scene":case "building-scene":return this._createFeatureSnappingSourceSceneLayer(a)}return null}async _createFeatureSnappingSourceSceneLayer(a){const {view:c}=this;return null==c||"3d"!==c.type?null:new ((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:a,view:c})}async _createFeatureSnappingSourceFeatureLayer(a){switch(a.layer.source?.type){case "feature-layer":case "oriented-imagery":return new ((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,
view:this.view,layerSource:a});case "memory":case "csv":case "geojson":case "wfs":if("mesh"!==a.layer.geometryType)return new ((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:a,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(a){return new ((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[a.layer],spatialReference:this.spatialReference,view:this.view,layerSource:a})}async _createFeatureSnappingSourceMapNotesLayer(a){return new ((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>
a.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:a})}async _getSourceModule(a){var c=this._sourceModules[a];if(null==c.loader){c=this._loadSourceModule(a);this._sourceModules[a]={module:null,loader:c};const b=await c;this._sourceModules[a]={module:b,loader:c};return b}return null==c.module?c.loader:c.module}_loadSourceModule(a){const c=this._updatingHandles;switch(a){case "featureService":return c.addPromise(new Promise((b,d)=>q(["./featureSources/FeatureServiceSnappingSource"],
b,d)));case "featureCollection":return c.addPromise(new Promise((b,d)=>q(["./featureSources/FeatureCollectionSnappingSource"],b,d)));case "graphics":return c.addPromise(new Promise((b,d)=>q(["./featureSources/GraphicsSnappingSource"],b,d)));case "notes":return c.addPromise(new Promise((b,d)=>q(["./featureSources/GraphicsSnappingSource"],b,d)));case "scene":return c.addPromise(new Promise((b,d)=>q(["./featureSources/SceneLayerSnappingSource"],b,d)))}}get test(){return{snappingSources:this._snappingSources}}};
n.__decorate([r.property({constructOnly:!0})],k.FeatureSnappingEngine.prototype,"spatialReference",void 0);n.__decorate([r.property({constructOnly:!0})],k.FeatureSnappingEngine.prototype,"view",void 0);n.__decorate([r.property()],k.FeatureSnappingEngine.prototype,"options",void 0);n.__decorate([r.property({readOnly:!0})],k.FeatureSnappingEngine.prototype,"updating",null);n.__decorate([r.property()],k.FeatureSnappingEngine.prototype,"_snappingSources",void 0);k.FeatureSnappingEngine=n.__decorate([J.subclass("esri.views.interactive.snapping.FeatureSnappingEngine")],
k.FeatureSnappingEngine);const F=z.create(),S=z.create();Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});