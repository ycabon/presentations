// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Logger ../../../core/reactiveUtils ../../../core/sql ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../layers/support/FeatureFilter ../../../layers/support/floorFilterUtils ../../../layers/support/layerUtils ./snappingUtils".split(" "),function(d,e,x,y,l,u,h,C,D,z,m,A,n,v){function p(a,b){return null==a?new m({where:b}):
a.where?new m({where:u.sqlAnd(a.where,b)}):new m({where:b})}d.FeatureSnappingSourceInfo=class extends x{get layerView(){return this.view?.allLayerViews?.find(a=>a.layer===this.layer)}get valid(){return this._valid}get subtypeFilter(){const {layer:a}=this;if(!n.isSubtypeGroupLayer(a)||!a.subtypes?.length)return{mode:"not-in-use",filter:null};const b=a.fieldsIndex.get(a.subtypeField)?.name??a.subtypeField,c=a.sublayers.filter(f=>f.visible).map(f=>f.subtypeCode);return c.length?c.length===a.subtypes.length?
{mode:"all-visible",filter:null}:1===c.length?{mode:"in-use",filter:`${b} = ${c.getItemAt(0)}`}:{mode:"in-use",filter:`${b} IN (${c.join(", ")})`}:{mode:"none-visible",filter:null}}get floorFilter(){const {view:a,layer:b}=this;return a&&b?A.getFloorFilterClause({view:a,layer:b}):null}constructor(a){super(a);this.rulesTable=null;this._valid=!1}initialize(){if(this.snappingSource&&this.layer){var {layer:a,snappingSource:b}=this;"refresh"in a&&this.addHandles(a.on("refresh",()=>b.refresh()));this.loadRules();
this.addHandles([l.watch(()=>b.updating,c=>b.layerSource.updating=c,l.syncAndInitial),l.watch(()=>b.availability,c=>b.layerSource.availability=c,l.syncAndInitial)])}}getFetchCandidatesParameters(a,b,c){if(!this.valid)return[];const {layer:f,layerView:q,floorFilter:w,rulesTable:r,subtypeFilter:k}=this;a={distance:c,mode:this.view?.type??"2d",point:a,coordinateHelper:b.coordinateHelper,...this._types,filter:q&&"filter"in q?q.filter:null};w&&(a.filter=p(a.filter,w));if("not-in-use"!==k.mode&&"all-visible"!==
k.mode){if("none-visible"===k.mode)return[];a.filter?a.filter.where=u.sqlAnd(a.filter.where,k.mode):a.filter=new m({where:k.filter})}c=b.feature;const t=c?.sourceLayer;if(r&&c&&v.isUtilityNetworkWebMap(this.view?.map)&&n.isFeatureLayer(f)&&f.layerId&&n.isFeatureLayer(t)&&this.view.map.utilityNetworks?.find(B=>B.isUtilityLayer(t))){if("loaded"!==r.loadStatus)return[];b=[];var g=f.layerId;g=r.getFeatureSQL(t,c)?.[g];if(!g)return[];c=g.anyVertex;(g=g.endVertex)&&c&&g===c&&(g="");g&&b.push({...a,returnEdge:!1,
vertexMode:"ends",filter:p(a.filter,g)});c&&b.push({...a,returnEdge:!1,vertexMode:"all",filter:p(a.filter,c)});return b}return[a]}async loadRules(){const {layer:a,view:b}=this;if(a&&b&&v.isUtilityNetworkWebMap(b?.map)&&n.isFeatureLayer(a)){const c=b.map.utilityNetworks?.find(f=>f.isUtilityLayer(a));if(c)try{this.rulesTable=await c.getRulesTable(),await this.rulesTable?.load()}catch(f){y.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",
a.title);return}}this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};e.__decorate([h.property({constructOnly:!0})],d.FeatureSnappingSourceInfo.prototype,"layer",void 0);e.__decorate([h.property({constructOnly:!0})],d.FeatureSnappingSourceInfo.prototype,"snappingSource",void 0);e.__decorate([h.property({constructOnly:!0})],d.FeatureSnappingSourceInfo.prototype,"view",void 0);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,
"layerView",null);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,"rulesTable",void 0);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,"valid",null);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,"subtypeFilter",null);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,"floorFilter",null);e.__decorate([h.property()],d.FeatureSnappingSourceInfo.prototype,"_valid",void 0);d.FeatureSnappingSourceInfo=e.__decorate([z.subclass("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],
d.FeatureSnappingSourceInfo);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});