// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/byteSizeEstimations ../../../../../core/ByteSizeUnit ../../../../../core/SetUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/has ../../../../../core/Logger ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ../../../../../geometry/support/aaBoundingRect ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/BoundsStore ../../../../../layers/support/TileInfo ../../../../../layers/support/TileKey ../../../../../rest/query/operations/query ./FeatureServiceTileCache".split(" "),
function(k,n,y,u,z,p,q,J,K,L,A,l,B,C,v,D,E,F){function G(a){return a.reduce((b,c)=>{var d=c.geometry;if(null==d)d=0;else{var e=u.estimateFixedArraySize(d.lengths,4);d=32+u.estimateFixedArraySize(d.coords,8)+e}c=32+d+u.estimateAttributesObjectSize(c.attributes);return b+c},0)}k.FeatureServiceTileStore=class extends y{constructor(a){super(a);this.extent=this.tileInfo=null;this.maximumByteSize=10*z.ByteSizeUnit.MEGABYTES;this._tileBounds=new C.BoundsStore;this._tiles=new F.FeatureServiceTileCache;this._refCounts=
new Map;this._tileFeatureCounts=new Map;this._tmpBoundingRect=l.create()}add(a,b){for(var c of b)this._referenceFeature(c.objectId);b=this.featureStore.upsertMany(b);c=b.map(d=>new Set(Object.keys(d.attributes))).reduce((d,e)=>p.intersection(d,e),new Set(Object.keys(b[0]?.attributes??[])));this._addTileStorage(a,new Set(b.map(d=>d.objectId)),G(b),c);this._tiles.applyByteSizeLimit(this.maximumByteSize,d=>this._removeTileStorage(d))}getAttributesForTile(a){return a?this._tiles.get(a)?.attributeKeys:
null}destroy(){this.clear();this._tileFeatureCounts.clear()}clear(){this.featureStore.clear();this._tileBounds.clear();this._tiles.clear();this._refCounts.clear()}refresh(){this.clear();this._tileFeatureCounts.clear()}processEdits(a,b,c){this._processEditsDelete(a.deletedFeatures.concat(a.updatedFeatures));return this._processEditsRefetch(a.addedFeatures.concat(a.updatedFeatures),b,c)}_addTileStorage(a,b,c,d){const e=a.id;this._tiles.set(e,new H(a,b,c,d));this._tileBounds.set(e,a.extent);this._tileFeatureCounts.set(e,
b.size)}_remove({id:a}){(a=this._tiles.get(a))&&this._removeTileStorage(a)}_removeTileStorage(a){const b=[];for(const c of a.objectIds)this._unreferenceFeature(c)===m.REMOVED&&b.push(c);this.featureStore.removeManyById(b);a=a.data.id;this._tiles.delete(a);this._tileBounds.delete(a)}_processEditsDelete(a){this.featureStore.removeManyById(a);for(const [,b]of this._tiles){for(const c of a)b.objectIds.delete(c);this._tileFeatureCounts.set(b.data.id,b.objectIds.size)}for(const b of a)this._refCounts.delete(b)}async _processEditsRefetch(a,
b,c){a=(await b(a,c)).features;const {hasZ:d,hasM:e}=this.featureStore;for(const f of a)a=B.getBoundsOptimizedGeometry(this._tmpBoundingRect,f.geometry,d,e),null!=a&&this._tileBounds.forEachInBounds(a,g=>{g=this._tiles.get(g);this.featureStore.add(f);const h=f.objectId;g.objectIds.has(h)||(g.objectIds.add(h),this._referenceFeature(h),this._tileFeatureCounts.set(g.data.id,g.objectIds.size))})}process(a,b=()=>!0,c){if(null==this.tileInfo||!a.extent||null!=this.extent&&!l.intersects(l.fromExtent(this.extent,
this._tmpBoundingRect),a.extent))return new r(a);var d=this.getAttributesForTile(a.id);if(p.isSubsetOf(c,d))return new r(a);d=this._createTileTree(a,this.tileInfo);this._simplify(d,b,null,0,1);return this._collectMissingTiles(a,d,this.tileInfo,c)}get debugInfo(){return Array.from(this._tiles.values()).map(({data:a})=>({data:a,featureCount:this._tileFeatureCounts.get(a.id)||0}))}getFeatureCount(a){return this._tileFeatureCounts.get(a.id)??0}async fetchCount(a,b,c,d){const e=this._tileFeatureCounts.get(a.id);
if(null!=e)return e;b=await E.executeQueryForCount(b,c,d);this._tileFeatureCounts.set(a.id,b.data.count);return b.data.count}_createTileTree(a,b){const c=new w(a.level,a.row,a.col);b.updateTileInfo(c,v.ExtrapolateOptions.POWER_OF_TWO);this._tileBounds.forEachInBounds(a.extent,d=>{(d=this._tiles.get(d)?.data)&&this._tilesAreRelated(a,d)&&this._populateChildren(c,d,b,this._tileFeatureCounts.get(d.id)||0)});return c}_tilesAreRelated(a,b){if(!a||!b)return!1;if(a.level===b.level)return a.row===b.row&&
a.col===b.col;const c=a.level<b.level,d=c?a:b;a=c?b:a;b=1<<a.level-d.level;return Math.floor(a.row/b)===d.row&&Math.floor(a.col/b)===d.col}_populateChildren(a,b,c,d){var e=b.level-a.level-1;if(0>e)a.isLeaf=!0;else{var f=b.row>>e,g=b.col>>e;e=(f-(a.row<<1)<<1)+(g-(a.col<<1));var h=a.children[e];null!=h?this._populateChildren(h,b,c,d):(f=new w(a.level+1,f,g),c.updateTileInfo(f,v.ExtrapolateOptions.POWER_OF_TWO),a.children[e]=f,this._populateChildren(f,b,c,d))}}_simplify(a,b,c,d,e){const f=e*e;if(a.isLeaf)return b(this.getFeatureCount(a),
e)?0:(this._remove(a),null!=c&&(c.children[d]=null),f);e/=2;const g=e*e;let h=0;for(let t=0;t<a.children.length;t++){const x=a.children[t];h+=null!=x?this._simplify(x,b,a,t,e):g}0===h?this._mergeChildren(a):.18751>1-h/f&&(this._purge(a),null!=c&&(c.children[d]=null),h=f);return h}_mergeChildren(a){const b=new Set;let c=0,d;this._forEachLeaf(a,e=>{const f=this._tiles.get(e.id);if(f){d=d?p.intersection(d,f.attributeKeys):new Set(f.attributeKeys);c+=f.byteSize;for(const g of f.objectIds)b.has(g)||(b.add(g),
this._referenceFeature(g));this._remove(e)}});this._addTileStorage(a,b,c,d??new Set);a.isLeaf=!0;a.children[0]=a.children[1]=a.children[2]=a.children[3]=null;this._tileFeatureCounts.set(a.id,b.size)}_forEachLeaf(a,b){for(const c of a.children)null!=c&&(c.isLeaf?b(c):this._forEachLeaf(c,b))}_purge(a){if(null!=a)if(a.isLeaf)this._remove(a);else for(let b=0;b<a.children.length;b++)this._purge(a.children[b]),a.children[b]=null}_collectMissingTiles(a,b,c,d){a=new I(c,a,this.extent);this._collectMissingTilesRecurse(b,
a,1,d);return a.info}_collectMissingTilesRecurse(a,b,c,d){var e=this.getAttributesForTile(a.id);(e=e&&!p.isSubsetOf(d,e))&&b.addMissing(a.level,a.row,a.col,c);if(!a.isLeaf)if(a.hasChildren)for(c/=2,e=0;e<a.children.length;e++){const f=a.children[e];null==f?b.addMissing(a.level+1,(a.row<<1)+((e&2)>>1),(a.col<<1)+(e&1),c):this._collectMissingTilesRecurse(f,b,c,d)}else e||b.addMissing(a.level,a.row,a.col,c)}_referenceFeature(a){const b=(this._refCounts.get(a)||0)+1;this._refCounts.set(a,b);return 1===
b?m.ADDED:m.UNCHANGED}_unreferenceFeature(a){const b=(this._refCounts.get(a)||0)-1;if(0===b)return this._refCounts.delete(a),m.REMOVED;0<b&&this._refCounts.set(a,b);return m.UNCHANGED}get test(){return{tiles:Array.from(this._tiles.values()).map(a=>`${a.data.id}:[${Array.from(a.objectIds)}]`),featureReferences:Array.from(this._refCounts.keys()).map(a=>`${a}:${this._refCounts.get(a)}`)}}};n.__decorate([q.property({constructOnly:!0})],k.FeatureServiceTileStore.prototype,"featureStore",void 0);n.__decorate([q.property()],
k.FeatureServiceTileStore.prototype,"tileInfo",void 0);n.__decorate([q.property()],k.FeatureServiceTileStore.prototype,"extent",void 0);n.__decorate([q.property()],k.FeatureServiceTileStore.prototype,"maximumByteSize",void 0);k.FeatureServiceTileStore=n.__decorate([A.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore")],k.FeatureServiceTileStore);class H{constructor(a,b,c,d){this.data=a;this.objectIds=b;this.byteSize=c;this.attributeKeys=d}}class w{constructor(a,
b,c){this.level=a;this.row=b;this.col=c;this.isLeaf=!1;this.extent=null;this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(null!=this.children[0]||null!=this.children[1]||null!=this.children[2]||null!=this.children[3])}}class r{constructor(a,b=[]){this.missingTiles=b;this.coveredArea=this.fullArea=0;this.coveredArea=this.fullArea=l.area(a.extent)}prepend(a){this.missingTiles=a.missingTiles.concat(this.missingTiles);this.coveredArea+=a.coveredArea;this.fullArea+=a.fullArea}}
class I{constructor(a,b,c){this._tileInfo=a;this._extent=null;this.info=new r(b);null!=c&&(this._extent=l.fromExtent(c))}addMissing(a,b,c,d){a=new D.TileKey(null,a,b,c);this._tileInfo.updateTileInfo(a,v.ExtrapolateOptions.POWER_OF_TWO);null==a.extent||null!=this._extent&&!l.intersects(this._extent,a.extent)||(this.info.missingTiles.push({data:a,resolution:d}),this.info.coveredArea-=l.area(a.extent))}}var m;(function(a){a[a.ADDED=0]="ADDED";a[a.REMOVED=1]="REMOVED";a[a.UNCHANGED=2]="UNCHANGED"})(m||=
{});k.ProcessResult=r;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});