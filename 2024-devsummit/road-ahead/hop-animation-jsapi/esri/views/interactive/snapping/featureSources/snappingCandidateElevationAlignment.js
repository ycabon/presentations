// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/has ../../../../core/LRUCache ../../../../core/MapUtils ../../../../core/promiseUtils ../../../../core/unitUtils ../../../../symbols/support/unitConversionUtils".split(" "),function(m,A,q,r,t,u,v){function n(a,{x:b,y:d,z:c,spatialReference:e}){return`${a}-${b}-${d}-${c??0}}-wkid:${e?.wkid}`}function w(){return[]}class x{async alignCandidates(a,b,d){return a}notifyElevationSourceChange(){}}class y{constructor(a,b){this._elevationInfo=a;this._alignPointsInFeatures=b;
this._alignmentsCache=new q.LRUCache(1024);this._cacheVersion=0}async alignCandidates(a,b,d){const c=this._elevationInfo;return null==c||"absolute-height"!==c.mode||c.featureExpressionInfo?this._alignComputedElevationCandidates(a,b,d):(this._alignAbsoluteElevationCandidates(a,b,c),a)}notifyElevationSourceChange(){this._alignmentsCache.clear();this._cacheVersion++}_alignAbsoluteElevationCandidates(a,b,d){const {offset:c,unit:e}=d;if(null!=c){b=u.getMetersPerVerticalUnitForSR(b);d=v.getMetersPerUnit(e??
"meters");b=d/b*c;for(const f of a)switch(f.type){case "edge":f.start.z+=b;f.end.z+=b;continue;case "vertex":f.target.z+=b}}}async _alignComputedElevationCandidates(a,b,d){var c=new Map;for(const h of a)r.getOrCreateMapValue(c,h.objectId,w).push(h);const [e,f,g]=this._prepareQuery(c,b);c=await this._alignPointsInFeatures(e,d);t.throwIfAborted(d);if(g!==this._cacheVersion)return this._alignComputedElevationCandidates(a,b,d);this._applyCacheAndResponse(e,c,f);const {drapedObjectIds:k,failedObjectIds:l}=
c;b=[];for(const h of a)({objectId:a}=h),k.has(a)&&"edge"===h.type&&(h.draped=!0),l.has(a)||b.push(h);return b}_prepareQuery(a,b){const d=[],c=[];for(const [e,f]of a){a=[];for(const g of f)this._addToQueriesOrCachedResult(e,g.target,a,c),"edge"===g.type&&(this._addToQueriesOrCachedResult(e,g.start,a,c),this._addToQueriesOrCachedResult(e,g.end,a,c));0!==a.length&&d.push({objectId:e,points:a})}return[{spatialReference:b.toJSON(),pointsInFeatures:d},c,this._cacheVersion]}_addToQueriesOrCachedResult(a,
b,d,c){a=n(a,b);a=this._alignmentsCache.get(a);null!=a?c.push(new z(b,a)):d.push(b)}_applyCacheAndResponse(a,{elevations:b,drapedObjectIds:d,failedObjectIds:c},e){for(var f of e)f.apply();e=0;f=this._alignmentsCache;for(const {objectId:g,points:k}of a.pointsInFeatures)if(c.has(g))e+=k.length;else{a=!d.has(g);for(const l of k){const h=n(g,l),p=b[e++];l.z=p;a&&f.put(h,p,1)}}}}class z{constructor(a,b){this.point=a;this.z=b}apply(){this.point.z=this.z}}m.getSnappingCandidateElevationAligner=function(a=
!1,b){if(a){const {elevationInfo:d,alignPointsInFeatures:c}=b;return new y(d,c)}return new x};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});