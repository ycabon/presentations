// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/FeatureEffect ../../layers/support/FeatureFilter ../../layers/support/fieldUtils ../../layers/support/floorFilterUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(m,u,v,w,q,n,G,H,A,B,C,D,e,x,y,E,r){return g=>{g=class extends g{constructor(...a){super(...a);this._updatingRequiredFieldsPromise=null;this.dataUpdating=!1;this.layer=this.timeExtent=this.filter=null;this.requiredFields=[];this.view=null}initialize(){this.addHandles([q.watch(()=>{const a=this.layer;return[a&&"elevationInfo"in a?a.elevationInfo?.featureExpressionInfo:null,a&&"displayField"in a?a.displayField:null,a&&"timeInfo"in a&&a.timeInfo,a&&"renderer"in a&&a.renderer,a&&"labelingInfo"in
a&&a.labelingInfo,a&&"floorInfo"in a&&a.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),q.syncAndInitial),q.on(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),q.on(()=>{const a=this.layer;return a&&"sublayers"in a?a.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const {layer:a,layer:{fieldsIndex:b},requiredFields:c}=this;return"outFields"in a&&a.outFields?e.fixFields(b,
[...e.unpackFieldNames(b,a.outFields),...c]):e.fixFields(b,c)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(a){this._override("featureEffect",a)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(a){v.getLogger(this).error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(a){throw Error("missing implementation");}createQuery(){var a=
{outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=null!=this.filter?this.filter.createQuery(a):new y(a);if("feature"===this.layer.type){const b=x.getFloorFilterClause(this);null!=b&&(a.where=a.where?`(${a.where}) AND (${b})`:b)}null!=this.timeExtent&&(a.timeExtent=null!=a.timeExtent?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a}createAggregateQuery(){return new y({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(a,
b){throw Error("missing implementation");}queryObjectIds(a,b){throw Error("missing implementation");}queryFeatureCount(a,b){throw Error("missing implementation");}queryExtent(a,b){throw Error("missing implementation");}async fetchPopupFeaturesFromGraphics(a,b){this._validateFetchPopupFeatures(a,b);return this._fetchPopupFeatures(a,b)}_loadArcadeModules(a){return a.expressionInfos?.length||Array.isArray(a.content)&&a.content.some(b=>"expression"===b.type)?E.loadArcade():Promise.resolve()}_handleRequiredFieldsChange(){const a=
this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(this.layer&&this.view){var a="3d"===this.view.type,{layer:b,layer:{fieldsIndex:c,objectIdField:l}}=this,f="renderer"in b&&b.renderer,k="orderBy"in b&&b.orderBy,h="featureReduction"in b?b.featureReduction:null,d=new Set;f=await Promise.allSettled([f?f.collectRequiredFields(d,c):null,e.collectLabelingFields(d,
b),a&&"elevationInfo"in b?e.collectElevationFields(d,b):null,null!=this.filter?e.collectFilterFields(d,b,this.filter):null,a||null==this.featureEffect?null:e.collectFilterFields(d,b,this.featureEffect.filter),!a&&h?e.collectFeatureReductionFields(d,b,h):null,!a&&k?e.collectOrderByInfos(d,b,k):null]);"timeInfo"in b&&b.timeInfo&&this.timeExtent&&e.collectFields(d,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]);"feature"===b.type&&(b.floorInfo&&e.collectFields(d,b.fieldsIndex,[b.floorInfo.floorField]),
a&&null!=b.infoFor3D&&(null==b.globalIdField&&v.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),e.collectFields(d,b.fieldsIndex,[b.globalIdField])));"subtype-group"===b.type&&(e.collectField(d,c,b.subtypeField),k=b.sublayers.map(p=>Promise.all([p.renderer?.collectRequiredFields(d,c),e.collectLabelingFields(d,p)])),await Promise.allSettled(k));"catalog-footprint"===b.type&&e.collectFields(d,c,[b.parent.itemSourceField,b.parent.itemTypeField]);for(const p of f)"rejected"===p.status&&
v.getLogger(this).error(p.reason);e.collectField(d,c,l);a&&"displayField"in b&&b.displayField&&e.collectField(d,c,b.displayField);a=Array.from(d).sort();this._set("requiredFields",a)}}_validateFetchPopupFeatures(a,b){if(null!=b)for(const c of a){a=c.origin&&"layer"in c.origin?c.origin.layer:c.layer;if("popupEnabled"in a&&!a.popupEnabled)throw new u("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(c.isAggregate){const l="featureReduction"in a?a.featureReduction:null;if(!(l&&
"popupTemplate"in l&&l.popupEnabled&&l.popupTemplate))throw new u("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});}else if("popupTemplate"in a&&!r.getFetchPopupTemplate(a,b))throw new u("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a});}}_popupFeatureHasRequiredFields(a,b){return e.featureHasFields(b,a)}async _fetchPopupFeatures(a,b){const c=Array(a.length),l=new Map,f=await this._createPopupQuery(a.map(h=>h.origin?.layer??h.layer),b);
for(let h=0;h<a.length;h++){const d=a[h];if(d.isAggregate){c[h]=d;continue}var k=d.origin?.layer??d.layer;if(!(k&&"popupEnabled"in k))continue;const p=e.unpackFieldNames(this.layer.fieldsIndex,f.outFields);k=r.getFetchPopupTemplate(k,b);if(null==k)continue;const t=await this._loadArcadeModules(k);w.throwIfAborted(b);t&&t.arcadeUtils.hasGeometryOperations(k)||!this._popupFeatureHasRequiredFields(d,p)?l.set(d.getObjectId(),{graphic:d,index:h}):c[h]=d}if("stream"===this.layer.type||0===l.size)return c.filter(Boolean);
f.objectIds=Array.from(l.keys());try{const h=await this.layer.queryFeatures(f,b);for(const d of h.features){const {graphic:{geometry:p,origin:t},index:F}=l.get(d.getObjectId());let z;(z=d).geometry||(z.geometry=p);d.origin=t;c[F]=d}}catch{}return c.filter(Boolean)}async _createPopupQuery(a,b){const c=this.layer.createQuery(),l=new Set;var f=!1;a=a??[this.layer];for(const k of a)if("popupEnabled"in k&&(a=r.getFetchPopupTemplate(k,b),null!=a)){f=await this._loadArcadeModules(a);w.throwIfAborted(b);
f=f&&f.arcadeUtils.hasGeometryOperations(a);f=!("point"!==this.layer.geometryType&&!f);a=await r.getRequiredFields(this.layer,a);w.throwIfAborted(b);for(const h of a)l.add(h)}c.returnGeometry=f;c.returnZ=f;c.returnM=f;c.outFields=Array.from(l);c.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(b=x.getFloorFilterClause(this),null!=b&&(c.where=c.where?`(${c.where}) AND (${b})`:b));return c}canResume(){return!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty?
!1:!0}getTest(){return{createPopupQuery:a=>this._createPopupQuery(void 0,a)}}get test(){return this.getTest()}};m.__decorate([n.property()],g.prototype,"_updatingRequiredFieldsPromise",void 0);m.__decorate([n.property({readOnly:!0})],g.prototype,"availableFields",null);m.__decorate([n.property({readOnly:!0})],g.prototype,"dataUpdating",void 0);m.__decorate([n.property({type:C})],g.prototype,"featureEffect",null);m.__decorate([n.property({type:D})],g.prototype,"filter",void 0);m.__decorate([n.property(B.combinedViewLayerTimeExtentProperty)],
g.prototype,"timeExtent",void 0);m.__decorate([n.property()],g.prototype,"layer",void 0);m.__decorate([n.property({type:Number})],g.prototype,"maximumNumberOfFeatures",null);m.__decorate([n.property({readOnly:!0,type:Boolean})],g.prototype,"maximumNumberOfFeaturesExceeded",null);m.__decorate([n.property({readOnly:!0})],g.prototype,"requiredFields",void 0);m.__decorate([n.property()],g.prototype,"suspended",void 0);m.__decorate([n.property()],g.prototype,"view",void 0);return g=m.__decorate([A.subclass("esri.views.layers.FeatureLayerView")],
g)}});