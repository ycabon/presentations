// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/handleUtils ../../../core/has ../../../core/MapUtils ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/Logger ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/scaleUtils ../../../layers/support/fieldUtils ../../../layers/support/floorFilterUtils ../../../renderers/support/clickToleranceUtils ../../../rest/identify ../../../rest/support/IdentifyParameters ../../../support/arcadeOnDemand ../../../symbols/SimpleMarkerSymbol ./popupUtils".split(" "),
function(D,n,p,E,F,x,G,y,u,H,I,v,J,K,q,W,L,M,N,O,P,z,Q,R,S,A,B){function C(a,b,d){const g=[];if(!a)return g;const f=e=>{var c=0===e.minScale||b<=e.minScale;const h=0===e.maxScale||b>=e.maxScale;e.visible&&c&&h&&(e.sublayers?e.sublayers.forEach(f):e.popupEnabled&&(c=B.getFetchPopupTemplate(e,{...d,defaultPopupTemplateEnabled:!1}),null!=c&&g.unshift({sublayer:e,popupTemplate:c})))};a.map(f);return g}function T(a){return a.expressionInfos?.length||Array.isArray(a.content)&&a.content.some(b=>"expression"===
b.type)?S.loadArcade():Promise.resolve()}async function U(a,b){if(a.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(b.map(({sublayer:d})=>d.load().then(()=>d.capabilities.operations.supportsQuery)))}catch{return!1}}async function V(a,b,d){const g=a.renderer;g&&"defaultSymbol"in g&&!g.defaultSymbol&&(b=g.valueExpression?await Promise.all(b.map(f=>g.getSymbolAsync(f,d).then(e=>e?f:null))).then(f=>f.filter(e=>null!=e)):b.filter(f=>null!=g.getSymbol(f)));return b}let w=null;
n.MapServiceLayerViewHelper=class extends F{constructor(a){super(a);this._featuresResolutions=new WeakMap;this.highlightGraphicUpdated=this.highlightGraphics=null;this.updateHighlightedFeatures=v.debounce(async b=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(b).catch(()=>{}))})}initialize(){const a=b=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(b).catch(()=>{}));this.updateHighlightedFeatures(this._highlightGeometriesResolution)};
this.addHandles([J.on(()=>this.highlightGraphics,"change",b=>a(b.added),{onListenerAdd:b=>a(b)})])}async fetchPopupFeaturesAtLocation(a,b){const {layerView:{layer:d,view:{scale:g}}}=this;if(!a)throw new y("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:d});const f=C(d.sublayers,g,b);if(!f.length)return[];const e=await U(d,f);if(!((d.capabilities?.operations?.supportsIdentify??!0)&&10.5<=d.version||e))throw new y("fetchPopupFeatures:not-supported","query operation is disabled for this service",
{layer:d});return e?this._fetchPopupFeaturesUsingQueries(a,f,b):this._fetchPopupFeaturesUsingIdentify(a,f,b)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(a){const b=this.highlightGraphics;if(!b)return u.makeHandle();let d=null;a instanceof E?d=[a]:G.isCollection(a)&&0<a.length?d=a.toArray():Array.isArray(a)&&0<a.length&&(d=a);d=d?.filter(x.isSome);if(!d?.length)return u.makeHandle();for(const g of d)a=g.sourceLayer,null!=a&&"geometryType"in a&&"point"===a.geometryType&&(g.visible=
!1);b.addMany(d);return u.makeHandle(()=>b.removeMany(d??[]))}async _updateHighlightedFeaturesSymbols(a){const {layerView:{view:b},highlightGraphics:d,highlightGraphicUpdated:g}=this;if(d&&g)for(const f of a){const e=f.sourceLayer&&"renderer"in f.sourceLayer&&f.sourceLayer.renderer;f.sourceLayer&&"geometryType"in f.sourceLayer&&"point"===f.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(f).then(async c=>{c||=new A;let h=null;const k="visualVariables"in e?e.visualVariables?.find(l=>
"size"===l.type):void 0;k&&(w||(w=(await new Promise((l,m)=>D(["../../../renderers/visualVariables/support/visualVariableUtils"],l,m))).getSize),h=w(k,f,{view:b.type,scale:b.scale,shape:"simple-marker"===c.type?c.style:null}));h||="width"in c&&"height"in c&&null!=c.width&&null!=c.height?Math.max(c.width,c.height):"size"in c?c.size:16;d.includes(f)&&(f.symbol=new A({style:"square",size:h,xoffset:"xoffset"in c?c.xoffset:0,yoffset:"yoffset"in c?c.yoffset:0}),g(f,"symbol"),f.visible=!0)})}}async _updateHighlightedFeaturesGeometries(a){const {layerView:{layer:b,
view:d},highlightGraphics:g,highlightGraphicUpdated:f}=this;this._highlightGeometriesResolution=a;if(f&&g?.length&&b.capabilities.operations.supportsQuery){var e=this._getTargetResolution(a);a=new Map;for(var c of g)(!this._featuresResolutions.has(c)||this._featuresResolutions.get(c)>e)&&I.getOrCreateMapValue(a,c.sourceLayer,()=>new Map).set(c.getObjectId(),c);c=Array.from(a,([h,k])=>{const l=h.createQuery();l.objectIds=[...k.keys()];l.outFields=[h.objectIdField];l.returnGeometry=!0;l.maxAllowableOffset=
e;l.outSpatialReference=d.spatialReference;return h.queryFeatures(l)});c=await Promise.all(c);if(!this.destroyed)for(const {features:h}of c)for(const k of h)(c=a.get(k.sourceLayer).get(k.getObjectId()))&&g.includes(c)&&(c.geometry=k.geometry,f(c,"geometry"),this._featuresResolutions.set(c,e))}}_getTargetResolution(a){const b=a*K.getMetersPerUnitForSR(this.layerView.view.spatialReference),d=b/16;return 10>=d?0:a/b*d}async _fetchPopupFeaturesUsingIdentify(a,b,d){a=await this._createIdentifyParameters(a,
b,d);if(null==a)return[];({results:d}=await Q.identify(this.layerView.layer.parsedUrl,a,d));return d.map(g=>g.feature)}async _createIdentifyParameters(a,b,d){const {floors:g,layer:f,timeExtent:e,view:{spatialReference:c,scale:h}}=this.layerView;if(!b.length)return null;await Promise.all(b.map(({sublayer:r})=>r.load(d).catch(()=>{})));b=Math.min(H("mapservice-popup-identify-max-tolerance"),f.allSublayers.reduce((r,t)=>t.renderer?z.calculateTolerance({renderer:t.renderer,pointerType:d?.pointerType}):
r,2));var k=this.createFetchPopupFeaturesQueryGeometry(a,b);const l=N.getResolutionForScale(h,c),m=Math.round(k.width/l);k=new M({xmin:k.center.x-l*m,ymin:k.center.y-l*m,xmax:k.center.x+l*m,ymax:k.center.y+l*m,spatialReference:k.spatialReference});return new R({floors:g,gdbVersion:"gdbVersion"in f?f.gdbVersion:void 0,geometry:a,height:m,layerOption:"popup",mapExtent:k,returnGeometry:!0,spatialReference:c,sublayers:f.sublayers,timeExtent:e,tolerance:b,width:m})}async _fetchPopupFeaturesUsingQueries(a,
b,d){const {layerView:{floors:g,timeExtent:f}}=this;b=b.map(async({sublayer:e,popupTemplate:c})=>{await e.load(d).catch(()=>{});if(e.capabilities&&!e.capabilities.operations.supportsQuery)return[];var h=e.createQuery(),k=z.calculateTolerance({renderer:e.renderer,pointerType:d?.pointerType}),l=this.createFetchPopupFeaturesQueryGeometry(a,k),m=new Set;const [r]=await Promise.all([B.getRequiredFields(e,c),e.renderer?.collectRequiredFields(m,e.fieldsIndex)]);v.throwIfAborted(d);O.collectFields(m,e.fieldsIndex,
r);m=Array.from(m).sort();h.geometry=l;h.outFields=m;h.timeExtent=f;g&&(m=g.clone(),m=P.getLayerFloorFilterClause(m,e),null!=m&&(h.where=h.where?`(${h.where}) AND (${m})`:m));k=this._getTargetResolution(l.width/k);l=await T(c);v.throwIfAborted(d);c="point"===e.geometryType||l&&l.arcadeUtils.hasGeometryOperations(c);c||(h.maxAllowableOffset=k);({features:h}=await e.queryFeatures(h,d));c=c?0:k;h=await V(e,h,d);for(const t of h)this._featuresResolutions.set(t,c);return h});return(await Promise.allSettled(b)).reduce((e,
c)=>"fulfilled"===c.status?[...e,...c.value]:e,[]).filter(x.isSome)}};p.__decorate([q.property({constructOnly:!0})],n.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",void 0);p.__decorate([q.property({constructOnly:!0})],n.MapServiceLayerViewHelper.prototype,"layerView",void 0);p.__decorate([q.property({constructOnly:!0})],n.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0);p.__decorate([q.property({constructOnly:!0})],n.MapServiceLayerViewHelper.prototype,
"highlightGraphicUpdated",void 0);p.__decorate([q.property({constructOnly:!0})],n.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0);n.MapServiceLayerViewHelper=p.__decorate([L.subclass("esri.views.layers.support.MapService")],n.MapServiceLayerViewHelper);n.collectPopupProviders=C;n.isMapServiceLayerView=function(a,b){return"tile"===b.type||"map-image"===b.type};Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});