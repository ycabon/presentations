// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../core/Handles ../../core/has ../../core/Logger ../../core/maybe ../../core/PerformanceSampler ../../core/PooledArray ../../core/promiseUtils ../../core/reactiveUtils ../../core/signal ../../core/time ../../layers/support/PromiseQueue ./debugFlags ./RenderState ./Yield".split(" "),function(e,E,M,F,G,p,q,r,t,z,g,H,I,h,J){function u(c){return v.has(c)?v.get(c):"number"===typeof c?c:1}e.TaskPriority=void 0;(function(c){c.RESOURCE_CONTROLLER_IMMEDIATE="immediate";c.RESOURCE_CONTROLLER=
"schedule";c.SLIDE="slide";c.STREAM_DATA_LOADER="stream loader";c.ELEVATION_QUERY="elevation query";c.TERRAIN_SURFACE="terrain";c.SURFACE_GEOMETRY_UPDATES="surface geometry updates";c.LOD_RENDERER="LoD renderer";c.GRAPHICS_CORE="Graphics3D";c.I3S_CONTROLLER="I3S";c.POINT_CLOUD_LAYER="point cloud";c.FEATURE_TILE_FETCHER="feature fetcher";c.OVERLAY="overlay";c.STAGE="stage";c.GRAPHICS_DECONFLICTOR="graphics deconflictor";c.FILTER_VISIBILITY="Graphics3D filter visibility";c.SCALE_VISIBILITY="Graphics3D scale visibility";
c.FRUSTUM_VISIBILITY="Graphics3D frustum visibility";c.POINT_OF_INTEREST_FREQUENT="POI frequent";c.POINT_OF_INTEREST_INFREQUENT="POI infrequent";c.LABELER="labeler";c.FEATURE_QUERY_ENGINE="feature query";c.FEATURE_TILE_TREE="feature tile tree";c.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree";c.ELEVATION_ALIGNMENT="elevation alignment";c.ELEVATION_ALIGNMENT_SCENE="elevation alignment scene";c.TEXT_TEXTURE_ATLAS="text texture atlas";c.TEXTURE_UNLOAD="texture unload";c.LINE_OF_SIGHT_TOOL="line of sight tool";
c.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool";c.ELEVATION_PROFILE="elevation profile";c.SNAPPING="snapping";c.SHADOW_ACCUMULATOR="shadow accumulator";c.CLOUDS_GENERATOR="clouds generator";c[c.NONE=0]="NONE";c[c.TEST_PRIO=1]="TEST_PRIO"})(e.TaskPriority||(e.TaskPriority={}));const v=new Map([[e.TaskPriority.RESOURCE_CONTROLLER_IMMEDIATE,0],[e.TaskPriority.RESOURCE_CONTROLLER,4],[e.TaskPriority.SLIDE,0],[e.TaskPriority.STREAM_DATA_LOADER,0],[e.TaskPriority.ELEVATION_QUERY,0],[e.TaskPriority.TERRAIN_SURFACE,
1],[e.TaskPriority.SURFACE_GEOMETRY_UPDATES,1],[e.TaskPriority.LOD_RENDERER,2],[e.TaskPriority.GRAPHICS_CORE,2],[e.TaskPriority.I3S_CONTROLLER,2],[e.TaskPriority.POINT_CLOUD_LAYER,2],[e.TaskPriority.FEATURE_TILE_FETCHER,2],[e.TaskPriority.OVERLAY,4],[e.TaskPriority.STAGE,4],[e.TaskPriority.GRAPHICS_DECONFLICTOR,4],[e.TaskPriority.FILTER_VISIBILITY,4],[e.TaskPriority.SCALE_VISIBILITY,4],[e.TaskPriority.FRUSTUM_VISIBILITY,4],[e.TaskPriority.CLOUDS_GENERATOR,4],[e.TaskPriority.POINT_OF_INTEREST_FREQUENT,
6],[e.TaskPriority.POINT_OF_INTEREST_INFREQUENT,30],[e.TaskPriority.LABELER,8],[e.TaskPriority.FEATURE_QUERY_ENGINE,8],[e.TaskPriority.FEATURE_TILE_TREE,16],[e.TaskPriority.FEATURE_TILE_TREE_ACTIVE,0],[e.TaskPriority.ELEVATION_ALIGNMENT,12],[e.TaskPriority.ELEVATION_ALIGNMENT_SCENE,14],[e.TaskPriority.TEXT_TEXTURE_ATLAS,12],[e.TaskPriority.TEXTURE_UNLOAD,12],[e.TaskPriority.LINE_OF_SIGHT_TOOL,16],[e.TaskPriority.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[e.TaskPriority.SNAPPING,0],[e.TaskPriority.SHADOW_ACCUMULATOR,
30]]),A=g.Milliseconds(6.5),B=g.Milliseconds(1),K=g.Milliseconds(30),C=g.Milliseconds(1E3/30),D=g.Milliseconds(100);var w;(function(c){class m{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(a=>a.needsUpdate)}constructor(){this._updating=z.signal(!0);this._microTaskQueued=!1;this._frameNumber=0;this.performanceInfo={total:new p("total"),tasks:new Map};this._frameTaskTimes=new Map;this._budget=new k;this._state=h.RenderState.INTERACTING;this._tasks=
new q;this._runQueue=new q;this._load=0;this._idleStateCallbacks=new q;this._debug=this._forceTask=this._idleUpdatesStartFired=!1;this._debugHandle=t.watch(()=>I.SCHEDULER_LOG_SLOW_TASKS,b=>this._debug=b,t.initial);for(const b of Object.keys(e.TaskPriority))this.performanceInfo.tasks.set(e.TaskPriority[b],new p(e.TaskPriority[b]));const a=this;this._test={FRAME_SAFETY_BUDGET:A,INTERACTING_BUDGET:C,IDLE_BUDGET:D,get availableBudget(){return a._budget.budget},usedBudget:0,getBudget:()=>a._budget,setBudget:b=>
a._budget=b,updateTask:b=>this._updateTask(b),getState:b=>this._getState(b),getRuntime:b=>this._getRuntime(b),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(a=>a.remove());this._tasks.clear();G.removeMaybe(this._debugHandle);this._microTaskQueued=!1;this._updatingChanged()}taskRunningChanged(a){this._updatingChanged();a&&0<this._budget.remaining&&!this._microTaskQueued&&(this._microTaskQueued=!0,
queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,0<this._budget.remaining&&this._schedule()&&this.frame())}))}registerTask(a,b){b=new l(this,a,b);this._tasks.push(b);this._updatingChanged();this.performanceInfo.tasks.has(a)||this.performanceInfo.tasks.set(a,new p(a));return b}registerIdleStateCallbacks(a,b){const d={idleBegin:a,idleEnd:b};this._idleStateCallbacks.push(d);this.state===h.RenderState.IDLE&&this._idleUpdatesStartFired&&d.idleBegin();const f=this;return{remove:()=>
this._removeIdleStateCallbacks(d),set idleBegin(n){f._idleUpdatesStartFired&&(d.idleEnd(),f._state===h.RenderState.IDLE&&n());d.idleBegin=n},set idleEnd(n){d.idleEnd=n}}}get load(){return this._load}set state(a){this._state!==a&&(this._state=a,this.state!==h.RenderState.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(b=>b.idleEnd())))}get state(){return this._state}updateBudget(a){this._test.usedBudget=0;++this._frameNumber;let b=A,d=a.frameDuration,
f=B;switch(this.state){case h.RenderState.IDLE:b=g.Milliseconds(0);d=g.Milliseconds(Math.max(D,a.frameDuration));f=K;break;case h.RenderState.INTERACTING:d=g.Milliseconds(Math.max(C,a.frameDuration))}d=g.Milliseconds(d-a.elapsedFrameTime-b);if(this.state!==h.RenderState.IDLE&&d<B&&!this._forceTask)return this._forceTask=!0,!1;d=g.Milliseconds(Math.max(d,f));this._budget.reset(d,this.state);this._updateLoad();return this._schedule()}frame(){this._microTaskQueued=this._forceTask=!1;switch(this.state){case h.RenderState.IDLE:this._idleUpdatesStartFired||
(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(a=>a.idleBegin()));this._runIdle();break;case h.RenderState.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(g.Milliseconds(0),this._state);this._budget.madeProgress()}_removeIdleStateCallbacks(a){this._idleUpdatesStartFired&&a.idleEnd();this._idleStateCallbacks.removeUnordered(a)}removeTask(a){this._tasks.removeUnordered(a);this._runQueue.removeUnordered(a);
this._updatingChanged()}_updateTask(a){this._tasks.forAll(b=>{b.name===a&&b.setPriority(a)})}_getState(a){if(this._runQueue.some(d=>d.name===a))return e.TaskState.SCHEDULED;let b=e.TaskState.IDLE;this._tasks.forAll(d=>{d.name===a&&d.needsUpdate&&(1>=d.schedulePriority?b=e.TaskState.READY:b!==e.TaskState.READY&&(b=e.TaskState.WAITING))});return b}_getRuntime(a){let b=0;this._tasks.forAll(d=>{d.name===a&&(b+=d.runtime)});return b}_resetRuntimes(){this._tasks.forAll(a=>a.runtime=0)}_getRunning(){const a=
new Map;this._tasks.forAll(d=>{d.needsUpdate&&a.set(d.name,(a.get(d.name)||0)+1)});if(0===a.size)return null;let b="";a.forEach((d,f)=>{b=1<d?b+` ${d}x ${f}`:b+` ${f}`});return b}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const a=this._tasks.reduce((b,d)=>d.needsUpdate?++b:b,0);this._load=.9*this._load+a*(1-.9)}_schedule(){this._runQueue.filterInPlace(a=>{if(a.needsUpdate)return!0;a.schedulePriority=a.basePriority;return!1});for(this._tasks.forAll(a=>
{0===a.basePriority&&a.needsUpdate&&!this._runQueue.includes(a)&&a.blockFrame!==this._frameNumber&&this._runQueue.unshift(a)});0===this._runQueue.length;){let a=!1;this._tasks.forAll(b=>{if(b.needsUpdate&&0!==b.schedulePriority&&0!==b.basePriority&&b.blockFrame!==this._frameNumber)switch(a=!0,b.schedulePriority){case 1:b.schedulePriority=0;this._runQueue.push(b);break;default:--b.schedulePriority}});if(!a)return this._updatingChanged(),!1}this._updatingChanged();return!0}_run(){const a=this._budget.now();
this._startFrameTaskTimes();do for(;0<this._runQueue.length;){var b=this._budget.now();const d=this._runQueue.pop();this._budget.resetProgress();try{d.task.runTask(this._budget)===J.Yield&&(d.blockFrame=this._frameNumber)}catch(f){F.getLogger("esri.views.support.Scheduler").error(`Exception in task "${d.name}"`,f),d.blockFrame=this._frameNumber}!this._budget.hasProgressed&&d.blockFrame!==this._frameNumber&&d.needsUpdate&&(d.blockFrame=this._frameNumber);d.schedulePriority=d.basePriority;b=this._budget.now()-
b;d.runtime+=b;this._frameTaskTimes.set(d.priority,this._frameTaskTimes.get(d.priority)+b);this._debug&&b>2*this._budget.budget&&console.log("Task",d.name,"used",b,"of max",this._budget.budget,"ms");if(0>=this._budget.remaining){this._updatingChanged();this._recordFrameTaskTimes(this._budget.now()-a);return}}while(this._schedule());this._updatingChanged();this._recordFrameTaskTimes(this._budget.now()-a)}_startFrameTaskTimes(){for(const a of Object.keys(e.TaskPriority))this._frameTaskTimes.set(e.TaskPriority[a],
0)}_recordFrameTaskTimes(a){this._frameTaskTimes.forEach((b,d)=>this.performanceInfo.tasks.get(d).record(b));this.performanceInfo.total.record(a)}get test(){return this._test}}c.Scheduler=m;class l{get task(){return this._task.value}get updating(){return this._queue.running}constructor(a,b,d){this._scheduler=a;this.name=b;this.runtime=this.blockFrame=0;this._queue=new H.PromiseQueue;this._handles=new E;this.schedulePriority=this._basePriority=u(b);this._task=z.signal(null!=d?d:this._queue);this._handles.add(t.when(()=>
this.task.running,f=>a.taskRunningChanged(f)))}remove(){this.processQueue(x);this._scheduler.removeTask(this);this.schedule=y.schedule;this.reschedule=y.reschedule;this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(a){if(this.name!==a){this.name=a;a=u(a);if(0===this._basePriority||0!==this.schedulePriority)this.schedulePriority=a;this._basePriority=a}}get priority(){return this.name}set priority(a){this.setPriority(a)}get needsUpdate(){return this.updating||this.task.running}schedule(a,
b,d){return this._queue.push(a,b,d)}reschedule(a,b,d){return this._queue.unshift(a,b,d)}processQueue(a){return this._queue.runTask(a)}}class k{constructor(){this._begin="undefined"!==typeof performance?performance.now():0;this._budget=0;this._state=h.RenderState.IDLE;this._progressed=this._done=!1;this._enabled=!0}run(a){if(this.done)return!1;!0===a()&&this.madeProgress();return!0}get done(){return this._done}get budget(){return this._budget}madeProgress(){this._progressed=!0;return this._done=this.elapsed>=
this._budget&&this._enabled}get state(){return this._state}get enabled(){return this._enabled}set enabled(a){this._enabled=a}reset(a,b){this._begin=this.now();this._budget=a;this._state=b;this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return performance.now()-this._begin}resetProgress(){this._done=this._progressed=!1}get hasProgressed(){return this._progressed}}c.Budget=k})(w||={});e.TaskState=void 0;(function(c){c.SCHEDULED=
"s";c.READY="r";c.WAITING="w";c.IDLE="i"})(e.TaskState||(e.TaskState={}));const x=(()=>{const c=new w.Budget;c.enabled=!1;return c})();class L{remove(){}processQueue(){}schedule(c,m,l){try{if(r.isAborted(m)){const k=r.createAbortError();return l?Promise.resolve(l(k)):Promise.reject(k)}return r.when(c(x))}catch(k){return Promise.reject(k)}}reschedule(c,m,l){return this.schedule(c,m,l)}}const y=new L;e.ImmediateTask=y;e.getTaskPriority=u;e.newScheduler=function(){return new w.Scheduler};e.noBudget=
x;e.taskPriorities=v;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});