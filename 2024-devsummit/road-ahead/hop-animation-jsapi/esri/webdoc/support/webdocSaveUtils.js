// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../core/Error ../../core/MultiOriginJSONSupport ../../core/reactiveUtils ../../core/urlUtils ../../core/accessorSupport/originUtils ../../geometry/SpatialReference ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../../layers/support/arcgisLayerUrl ../../layers/support/layerUtils ../../portal/Portal ../../portal/PortalItem ../../portal/support/jsonContext ../../portal/support/portalItemUtils ../../rest/geometryService/project ../../rest/support/ProjectParameters ../../support/basemapUtils ./resourceUtils ./saveAPIKeyUtils ./saveUtils".split(" "),
function(E,m,k,F,n,r,G,H,I,J,K,p,L,M,t,f,N,O,q,u,v,l){function P(b,a){if(!a.portalItem)throw new k(`${b.name}:portal-item-not-set`,"Portal item to save to has not been set on the WebMap");v.validateSaveAPIKey(a.portalItem);w(b,a.portalItem)}function w(b,a){if(a.type!==b.itemType)throw new k(`${b.name}:portal-item-wrong-type`,`Portal item needs to have type "${b.itemType}"`);}function Q(b,a){a=a.allLayers.filter(c=>"unsupported"===c.type&&"KnowledgeGraphLayer"===c.resourceInfo?.layerType);if(a.length)throw new k(`${b.name}:save-as-invalid-configuration`,
`Failed to save a copy of ${b.name} to prevent persisting invalid configuration. See 'details.layers'`,{layers:a.toArray()});}async function x(b,a){if(!a.basemap?.baseLayers.length)throw new k(`${b.name}:save`,"Map does not have a valid basemap with a base layer.");let c=null;await n.whenOnce(()=>{const d=q.findSpatialReference(a.initialViewProperties,a.basemap);c=d.spatialReference;return!d.updating});if(!I.equals(c,a.initialViewProperties.spatialReference))throw new k(`${b.name}:save`,"The spatial reference of the basemap is not compatible with the one from the map.",
{expected:a.initialViewProperties.spatialReference,actual:c});}function R(b,a){a=M.from(a);a.id&&(a=a.clone(),a.id=null);a.type||(a.type=b.itemType);a.portal||(a.portal=L.getDefault());v.validateSaveAPIKey(a);w(b,a);return a}function y(b){const a=[];b.basemap&&a.push(b.basemap.load());b.ground&&a.push(b.ground.load());return Promise.allSettled(a).then(()=>{})}async function z(b,a){a.extent=await S(b.portalItem,b.initialViewProperties.viewpoint.targetGeometry);await T(b,a)}async function U(b,a){f.removeTypeKeyword(a,
"CollectorDisabled");f.removeTypeKeyword(a,"FieldMapsDisabled");f.removeTypeKeyword(a,f.typeKeyword.METADATA);f.removeTypeKeyword(a,"OfflineDisabled");f.removeTypeKeyword(a,"Offline Map Areas");f.removeTypeKeyword(a,"Workforce Dispatcher");f.removeTypeKeyword(a,"Workforce Project");f.removeTypeKeyword(a,"Workforce Worker");await z(b,a)}async function T(b,a){f.addTypeKeyword(a,V);await W(b);X(b,a);Y(b,a);Z(b,a);aa(b,a);ba(b,a);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter((c,d,e)=>e.indexOf(c)===
d))}function W(b){b=b.allLayers.concat(b.allTables).map(a=>a.load()).toArray();return Promise.allSettled(b).then(()=>{})}function A(b){return b.allLayers.concat(b.allTables).some(a=>a.loaded&&p.isLayerWithFeatureLayerSource(a)&&a.capabilities.operations.supportsEditing&&a.editingEnabled&&("subtype-group"!==a.type||a.sublayers.some(c=>c.editingEnabled)))}function ca(b){return b.allLayers.concat(b.allTables).filter(a=>"group"!==a.type).every(a=>{var c;if(c=a.loaded)(c=p.isLayerWithFeatureLayerSource(a)&&
a.capabilities.operations.supportsSync)||(c=(p.isFeatureCollectionLayer(a)||"map-notes"===a.type||"route"===a.type)&&!a.portalItem),c=c||("tile"===a.type||"vector-tile"===a.type)&&(a.capabilities.operations.supportsExportTiles||da(a)||q.isDeveloperBasemapLayer(a))&&a.spatialReference.equals(b.initialViewProperties.spatialReference);return c})}function X(b,a){f.hasTypeKeyword(a,"CollectorDisabled")||f.hasTypeKeyword(a,"Workforce Project")||f.hasTypeKeyword(a,"Workforce Worker")||f.hasTypeKeyword(a,
"Workforce Dispatcher")||!A(b)?f.removeTypeKeyword(a,"Collector"):f.addTypeKeyword(a,"Collector")}function Y(b,a){A(b)?f.addTypeKeyword(a,"Data Editing"):f.removeTypeKeyword(a,"Data Editing")}function Z(b,a){!f.hasTypeKeyword(a,"OfflineDisabled")&&ca(b)?f.addTypeKeyword(a,"Offline"):f.removeTypeKeyword(a,"Offline")}function aa(b,a){q.hasDeveloperBasemapLayer(b.basemap)?f.addTypeKeyword(a,B):f.removeTypeKeyword(a,B)}function ba(b,a){b.utilityNetworks?.length?f.addTypeKeyword(a,"UtilityNetwork"):f.removeTypeKeyword(a,
"UtilityNetwork")}async function S(b,a){a=a.clone().normalize();let c;if(1<a.length)for(const d of a)c?d.width>c.width&&(c=d):c=d;else c=a[0];return ea(b,c)}async function ea(b,a){var c=a.spatialReference;if(c.isWGS84)return a.clone();if(c.isWebMercator)return J.webMercatorToGeographic(a);({getGeometryServiceURL:c}=await new Promise((d,e)=>E(["../../portal/support/geometryServiceUtils"],d,e)));b=await c(b);c=new O;c.geometries=[a];c.outSpatialReference=H.WGS84;return(await N.project(b,c))[0]}function da(b){return"tile"===
b.type?K.isServerOrServicesAGOLUrl(b.url)&&fa.some(a=>b.url?.toLowerCase().includes("/"+a+"/")):!1}async function ha(b,a,c,d,e){await c.update({data:d});C(b,a,c,d,e)}async function ia(b,a,c,d,e,h){var g=a.portalItem;g={item:g,authenticated:!(!g?.id||!g.portal.user)};const D=c.portal;await D.signIn();const {copyAllowed:ja,itemReloaded:ka}=await la(g,D);g.authenticated||(g.authenticated=ka);if(!ja)throw new k(`${b.name}:save-as-copy-not-allowed`,"Owner of this map does not allow others to save a copy");
h=await ma(c,g,d,h);a.portalItem=c;C(b,a,c,d,e);return h}async function la(b,a){const {item:c,authenticated:d}=b;if(c?.id&&c.typeKeywords?.includes("useOnly")){if(c.portal.portalHostname!==a.portalHostname)return{copyAllowed:!1,itemReloaded:!1};d||await c.reload();return{copyAllowed:"admin"===c.itemControl||"update"===c.itemControl,itemReloaded:!0}}return{copyAllowed:!0,itemReloaded:!1}}async function ma(b,a,c,d){var e=b.portal;({item:a}=a);const {folder:h,copyAllResources:g}=d;d=!1;g&&a?.id&&r.hasSameCanonicalPortal(a.portal.url,
e.url)&&2023<=parseInt(a.portal.currentVersion,10)&&({total:d}=await a.fetchResources(),d=!!d);d?(e=await a.copy({copyResources:"all",folder:h}),b.id=e.id,b.portal=e.portal,e=b.toJSON(),await b.load(),b.read(e),await b.update({data:c})):await e.user?.addItem({item:b,folder:h,data:c});return d}function C(b,a,c,d,e){F.MultiOriginJSONSupport.prototype.read.call(a,{version:d.version,authoringApp:d.authoringApp,authoringAppVersion:d.authoringAppVersion},{origin:b.origin,ignoreDefaults:!0,url:c.itemUrl?
r.urlToObject(c.itemUrl):void 0});G.updateOrigins(e);a.resourceInfo=d}const fa="NatGeo_World_Map Ocean_Basemap USA_Topo_Maps World_Imagery World_Street_Map World_Terrain_Base World_Topo_Map World_Hillshade Canvas/World_Light_Gray_Base Canvas/World_Light_Gray_Reference Canvas/World_Dark_Gray_Base Canvas/World_Dark_Gray_Reference Ocean/World_Ocean_Base Ocean/World_Ocean_Reference Reference/World_Boundaries_and_Places Reference/World_Reference_Overlay Reference/World_Transportation".split(" ").map(b=>
b.toLowerCase()),V=f.typeKeyword.JSAPI,B=f.typeKeyword.DEVELOPER_BASEMAP;m.save=async function(b,a,c){c??={};P(b,a);await n.whenOnce(()=>!a.updatingFromView);await a.load();await y(a);await l.beforeSave(a);await x(b,a);const d=a.portalItem,e=t.createForItemWrite(d,"web-map",!0),h=a.write({},e);await Promise.all(e.resources.pendingOperations);l.evaluateWriteErrors(e,{errorName:`${b.name}:save`},c);await z(a,d);await ha(b,a,d,h,e);await Promise.all([a.updateItemThumbnail(),u.saveResources(a.resourceReferences,
e)]);return d};m.saveAs=async function(b,a,c,d){d??={};c=R(b,c);await n.whenOnce(()=>!a.updatingFromView);await a.load();Q(b,a);await y(a);await l.beforeSave(a);await x(b,a);const e=t.createForItemWrite(c,"web-map",!0),h=a.write({},e);await Promise.all(e.resources.pendingOperations);l.evaluateWriteErrors(e,{errorName:`${b.name}:save`},d);await U(a,c);const g=a.getThumbnailState();await ia(b,a,c,h,e,d)&&(a.resourceReferences.portalItem=c);a.restoreThumbnailFromState(g);await Promise.all([a.updateItemThumbnail(),
u.saveResources(a.resourceReferences,e)]);return c};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});