// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/Collection ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../geometry/Extent ../../geometry/SpatialReference ../../geometry/support/contains ../../geometry/support/webMercatorUtils ../../views/3d/layers/Lyr3DWasm".split(" "),function(p,l,y,t,q,r,F,G,H,z,A,B,C,u,D){function v(a,c){return a&&
"copyright"in a&&(!c||"function"===typeof a.originOf&&"user"===a.originOf("copyright"))}function E(a,c){return a.length!==c.length||a.some((d,b)=>d.text!==c[b].text)}function n(a,c,d){d&&c&&(a.find(b=>b.layerView===c&&b.text===d)||a.push({text:d,layerView:c}))}const k=[];l=class extends l{constructor(a){super(a);this._clear=()=>{this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.removeHandles("suspension");this.notifyChange("state")};this._pendingAttributions=new Set;this._fetchedAttributionData=
new Map;this.items=new t;this.view=null;this._allLayerViewsChange=c=>{this.removeHandles("suspension");const d=this.view?.allLayerViews;d&&this.addHandles(d.map(b=>q.watch(()=>[b.suspended,b.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension");c?.removed&&c.removed.forEach(b=>{this._pendingAttributions.delete(b);this._fetchedAttributionData.delete(b)});this._updateAttributionItems()};this.addHandles([q.on(()=>this.view?.allLayerViews,"change",c=>this._allLayerViewsChange(c),
{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),q.when(()=>!0===this.view?.stationary,()=>this._updateAttributionItems())])}destroy(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()}get state(){return this.view?.ready?0<this._pendingAttributions.size?"loading":"ready":"disabled"}_updateAttributionItems(){const a=this.view;var c=a?.allLayerViews;k.length=0;if(a&&c){c.forEach(b=>{if(!b.suspended&&b.layer?.attributionVisible){var e=
b.layer;if(v(e,"user"))n(k,b,e.copyright);else if(e.hasAttributionData)if(this._fetchedAttributionData.has(b)){var h=this._fetchedAttributionData.get(b);h?n(k,b,this._getDynamicAttribution(h,a,e)):v(e)&&n(k,b,e.copyright)}else this._fetchAttributionData(b);else(h="portalItem"in e?e.portalItem?.accessInformation:void 0)?n(k,b,h):n(k,b,e.copyright)}});c=c.find(b=>"integrated-mesh-3dtiles"===b.layer?.type);if(this.view&&c){var d=D.getLyr3DWasm(this.view);if(d){d=d.getAttributionText();for(let b=0;b<
d.length;++b)n(k,c,d[b])}}E(this.items,k)&&(this.items.removeAll(),this.items.addMany(k));k.length=0;this.notifyChange("state")}else this._clear()}async _fetchAttributionData(a){if(!this._pendingAttributions.has(a)){this._pendingAttributions.add(a);var c=await y.result(a.layer.fetchAttributionData());this._pendingAttributions.has(a)&&(c=c.ok?this._createContributionIndex(c.value,"bing-maps"===a.layer.type):null,this._pendingAttributions.delete(a),this._fetchedAttributionData.set(a,c));this._updateAttributionItems()}}_createContributionIndex(a,
c){a=a.contributors;const d={};if(!a)return d;for(let m=0;m<a.length;m++){const f=a[m];var b=f.coverageAreas;if(!b)return;for(const g of b){var e=g.bbox,h=g.zoomMin-(c&&g.zoomMin?1:0);b=g.zoomMax-(c&&g.zoomMax?1:0);e=new A({xmin:e[1],ymin:e[0],xmax:e[3],ymax:e[2],spatialReference:B.WGS84});for(e={extent:u.geographicToWebMercator(e),attribution:f.attribution||"",score:null!=g.score?g.score:100,id:m};h<=b;h++){let w,x;(w=d)[x=h]??(w[x]=[]);d[h].push(e)}}}d.maxKey=Math.max.apply(null,Object.keys(d));
return d}_getDynamicAttribution(a,c,d){const {extent:b,scale:e}=c;d=d.tileInfo?.scaleToZoom(e)??0;d=Math.min(a.maxKey??0,Math.round(d));if(!b||null==d||-1>=d)return"";a=a[d];const h=u.project(b.center.clone().normalize(),c.spatialReference),m=new Set;return a?a.filter(f=>{const g=f.id;(f=!m.has(g)&&h&&f.extent&&C.extentContainsPoint(f.extent,h))&&m.add(g);return f}).sort((f,g)=>g.score-f.score||f.objectId-g.objectId).map(f=>f.attribution).join(", "):""}};p.__decorate([r.property({readOnly:!0,type:t})],
l.prototype,"items",void 0);p.__decorate([r.property({readOnly:!0})],l.prototype,"state",null);p.__decorate([r.property()],l.prototype,"view",void 0);return l=p.__decorate([z.subclass("esri.widgets.Attribution.AttributionViewModel")],l)});