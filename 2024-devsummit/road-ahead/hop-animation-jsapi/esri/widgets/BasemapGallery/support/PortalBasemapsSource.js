// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../Basemap ../../../core/Collection ../../../core/Error ../../../core/Loadable ../../../core/Logger ../../../core/Promise ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/RandomLCG ../../../core/accessorSupport/decorators/subclass ../../../portal/Portal ./LocalBasemapsSource".split(" "),function(c,b,l,m,n,p,q,r,g,d,w,x,t,h,u){const k=l.ofType(b);b=class extends n.LoadableMixin(q.EsriPromiseMixin(u)){constructor(a){super(a);
this._lastPortalBasemapFetchController=null;this.basemaps=new k;this.filterFunction=null;this.portal=h.getDefault();this.viewType=this.updateBasemapsCallback=this.query=null}initialize(){this.addHandles([g.watch(()=>[this.filterFunction,this.loadStatus,this.portal?.basemapGalleryGroupQuery,this.portal?.basemapGalleryGroupQuery3D,this.portal?.user,this.query,this.updateBasemapsCallback],()=>this.refresh(),g.initial)])}destroy(){this.portal=this.filterFunction=null;this.basemaps.forEach(a=>a.destroy())}get state(){return"not-loaded"===
this.loadStatus?"not-loaded":"loading"===this.loadStatus||this._lastPortalBasemapFetchController?"loading":"ready"}load(a){this.addResolvingPromise(this.portal.load(a));return Promise.resolve(this)}async refresh(){if("loaded"===this.loadStatus){this._lastPortalBasemapFetchController&&(this._lastPortalBasemapFetchController.abort(),this._lastPortalBasemapFetchController=null);var a=this.portal,e=new AbortController;this._lastPortalBasemapFetchController=e;this.notifyChange("state");try{const f=await a.fetchBasemaps(this._toQueryString(this.query),
{signal:e.signal,include3d:"3d"===this.viewType?!0:void 0});await this._updateBasemaps(f)}catch(f){if(r.isAbortError(f))throw f;p.getLogger(this).warn(new m("basemap-source:fetch-basemaps-error","Could not fetch basemaps from portal.",{error:f}));await this._updateBasemaps()}this._lastPortalBasemapFetchController=null;this.notifyChange("state")}}_toQueryString(a){return a&&"string"!==typeof a?Object.keys(a).map(e=>`${e}:${a[e]}`).join(" AND "):a}async _updateBasemaps(a=[]){a=await this._filterBasemaps(a);
a=this.updateBasemapsCallback?await this.updateBasemapsCallback(a):a;this.basemaps.removeAll();this.basemaps.addMany(a)}async _filterBasemaps(a){if(!this.filterFunction)return a;const e=a.map(this.filterFunction),f=await Promise.all(e);return a.filter((y,v)=>f[v])}};c.__decorate([d.property({readOnly:!0,type:k})],b.prototype,"basemaps",void 0);c.__decorate([d.property()],b.prototype,"filterFunction",void 0);c.__decorate([d.property({type:h})],b.prototype,"portal",void 0);c.__decorate([d.property()],
b.prototype,"query",void 0);c.__decorate([d.property({readOnly:!0})],b.prototype,"state",null);c.__decorate([d.property()],b.prototype,"updateBasemapsCallback",void 0);c.__decorate([d.property()],b.prototype,"viewType",void 0);return b=c.__decorate([t.subclass("esri.widgets.BasemapGallery.support.PortalBasemapsSource")],b)});