// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/Accessor ../../core/handleUtils ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/scheduling ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../views/SceneView ../../views/3d/environment/SunLighting ../../views/3d/environment/VirtualLighting ../../views/3d/support/earthUtils ./support/daylightUtils ./support/SliderWithDropdownViewModel ../support/DatePickerViewModel ../support/timeWidgetUtils".split(" "),
function(e,c,w,x,r,h,y,l,f,D,E,z,A,t,B,C,k,u,v,p){function n(a){l.isValidDate(a.date)||(x.getLogger("esri.widgets.Daylight.DaylightViewModel").warn("Invalid date. Reverting to the current date/time."),a.date=new Date);return a.date}c=class extends c{constructor(a){super(a);this.view=null;this.datePickerViewModel=new v;this.timeSliderViewModel=new u.SliderWithDropdownViewModel({min:0,max:1439,values:[0],labelFormatFunction:p.formatSliderLabel,inputFormatFunction:p.formatSliderLabel});this.lightingUpdateInterval=
200;this._oldLighting=null;this.playSpeedMultiplier=1;this._sunset=this._sunrise=this._lastTime=null;this._cachedLightingDateUTC=new Date(0);this._cachedDisplayUTCOffset=0;this._firstInteraction=!0;this._lastLightingUpdate=0;this._lightingUpdateHandle=null}initialize(){this.addHandles([h.when(()=>this.view,a=>a.when(()=>this._updateLighting()),h.initial),h.watch(()=>{const a=this._lighting;return"sun"===a?.type?n(a):null},a=>this._scheduleLightingUpdate(a)),h.on(()=>this._lighting,"timezone-will-change",
a=>this._timezoneWillChange(a),{onListenerAdd:()=>this._timezoneWillChange(null)}),h.watch(()=>!0===this.view?.stationary,()=>{(this.dayPlaying||this.yearPlaying)&&this._updateSunriseAndSunset()},h.initial),h.watch(()=>{const a=this.timeSliderViewModel;return{vm:a,state:a.state,sliderPosition:this.timeSliderPosition}},({vm:a,state:b,sliderPosition:d})=>{"ready"===b&&a.setValue(0,d)}),h.watch(()=>this.timeSliderViewModel?.utcOffset,a=>{null!=a&&(this.utcOffset=a)}),h.watch(()=>({utcOffset:this.utcOffset,
sliderViewModel:this.timeSliderViewModel}),({utcOffset:a,sliderViewModel:b})=>{b&&(b.utcOffset=a)},h.syncAndInitial),h.watch(()=>this.timeSliderViewModel.timezonePickerOpen,()=>this.stopPlaying()),h.watch(()=>this.timeSliderViewModel.values,a=>this._setTimeSliderPosition(a?.[0]??0,{forceLightingUpdate:!1})),h.watch(()=>this.datePickerViewModel.value,a=>{this.dayPlaying=!1;this.localDate=a}),h.watch(()=>this.localDate,a=>{this.datePickerViewModel.value.valueOf()!==a.getTime()&&this.datePickerViewModel.set("value",
a)})])}destroy(){this._cancelLightingUpdate();this.view=null}get isSupported(){return null==this.view||"3d"===this.view.type}get utcOffset(){return this._cachedDisplayUTCOffset}set utcOffset(a){a!==this.utcOffset&&null!=this._lighting&&"virtual"!==this._lighting.type&&(this._lighting.displayUTCOffset=a,this._updateLighting())}get localDate(){return l.truncateLocalTime(this._lightingDateDisplay)}set localDate(a){l.isValidDate(a)&&a.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=l.resetUTCDate(this._lightingDateDisplay,
a))}get timeSliderPosition(){return k.dateTimeToSliderPos(this._lightingDateDisplay)}set timeSliderPosition(a){this._setTimeSliderPosition(a,{forceLightingUpdate:!0})}_setTimeSliderPosition(a,b){Math.abs(a-this.timeSliderPosition)<=1/60||(this.stopPlaying(),this._enableDirectShadowsIfFirstInteraction(),b.forceLightingUpdate&&(this._cancelLightingUpdate(),this._updateLighting()),this._lightingDateDisplay=k.sliderPosToDateTime(this._lightingDateDisplay,a))}_timezoneFromCamera(a,b){if(null==b||!a.cameraTrackingEnabled)return 0;
a=C.positionToTimezoneInfo([b.longitude,b.latitude]);return null==a?0:Math.round(a.hours+a.minutes/60+a.seconds/3600)}get directShadowsEnabled(){return this._lighting?.directShadowsEnabled??!1}set directShadowsEnabled(a){const b=this._lighting;b&&(b.directShadowsEnabled=a)}get sunLightingEnabled(){return"sun"===this._lightingType}set sunLightingEnabled(a){const b=this._environment;if(a!==this._get("sunLightingEnabled")&&null!=b){var d=b.lighting,g=this._oldLighting;this._oldLighting=d;d={directShadowsEnabled:d.directShadowsEnabled,
cameraTrackingEnabled:d.cameraTrackingEnabled};g=null!=g&&g.type===(a?"sun":"virtual")?g:a?new t:new B;g.set(d);b.lighting=g;a||(this.stopPlaying(),this.timeSliderViewModel.timezonePickerOpen=!1)}}set playingState(a){this.playingState!==a&&(this._set("playingState",a),"none"!==a&&this.sunLightingEnabled&&(this._updateSunriseAndSunset(),this._lastTime=Date.now(),this._play(),this._enableDirectShadowsIfFirstInteraction()))}get dayPlaying(){return"day"===this.playingState}set dayPlaying(a){a?this.playingState=
"day":this.dayPlaying&&(this.playingState="none")}get yearPlaying(){return"year"===this.playingState}set yearPlaying(a){a?this.playingState="year":this.yearPlaying&&(this.playingState="none")}get currentSeason(){return k.getSeasonFromDate(this.localDate,this._currentHemisphere)}set currentSeason(a){this.stopPlaying();a=k.getNorthernHemisphereSeason(a,this._currentHemisphere);this.localDate=k.getSeasonDate(this.localDate,a,k.Hemisphere.NORTHERN)}get _currentHemisphere(){const a=this.view?.camera?.position?.latitude;
return null==a||0<=a?k.Hemisphere.NORTHERN:k.Hemisphere.SOUTHERN}get _environment(){return this.view?.environment}get _lighting(){return this._environment?.lighting}get _lightingType(){return this._lighting?.type}get _lightingDateDisplay(){return l.offsetDate(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset,"hours")}set _lightingDateDisplay(a){const b=this._lighting;if(null!=b&&this.sunLightingEnabled&&"virtual"!==b.type&&l.isValidDate(a)){var d=n(b);a=l.offsetDate(a,-this._cachedDisplayUTCOffset,
"hours");a.getTime()!==d.getTime()&&(b.date=a,this._updateLighting())}}stopPlaying(){this.playingState="none"}toggleDayPlaying(){this.dayPlaying=!this.dayPlaying}toggleYearPlaying(){this.yearPlaying=!this.yearPlaying}toggleSunLightingEnabled(){this.stopPlaying();this.sunLightingEnabled=!this.sunLightingEnabled}toggleDirectShadowsEnabled(){this.stopPlaying();this.directShadowsEnabled=!this.directShadowsEnabled}_enableDirectShadowsIfFirstInteraction(){this._firstInteraction&&(this._firstInteraction=
!1,this.directShadowsEnabled=!0)}_updateLighting(a){this._lastLightingUpdate=Date.now();var {view:b}=this;const d=this._lighting;if(null!=b&&null!=d&&"virtual"!==d.type){a??=n(d);var g=d.displayUTCOffset;b=null!==g?g:this._timezoneFromCamera(d,b.camera?.position);this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime()));this._cachedDisplayUTCOffset!==b&&(this._cachedDisplayUTCOffset=b)}}_timezoneWillChange(a){const b=this._lighting;if(null!=b&&"virtual"!==
b.type&&b.cameraTrackingEnabled){if(a)a=a.timezoneOffset;else{if(null!=b.displayUTCOffset)return;a=t.calculateTimezoneOffset(b.positionTimezoneInfo)}b.displayUTCOffset=a;this._scheduleLightingUpdate()}}_scheduleLightingUpdate(a){if(a&&(this._lightingUpdateHandle=r.removeMaybe(this._lightingUpdateHandle),!l.isValidDate(a)))return;if(!this._lightingUpdateHandle){var b=Date.now()-this._lastLightingUpdate;b=this.lightingUpdateInterval-b;var d=null,g=()=>{this._updateLighting(a);this._lightingUpdateHandle===
d&&(this._lightingUpdateHandle=null)};if(0>=b)this._lightingUpdateHandle=d=y.schedule(g);else{const m=setTimeout(g,b);this._lightingUpdateHandle=d=w.makeHandle(()=>clearTimeout(m))}}}_cancelLightingUpdate(){this._lightingUpdateHandle=r.removeMaybe(this._lightingUpdateHandle)}_play(){const a=this._lighting;if(null!=a&&this.sunLightingEnabled&&"virtual"!==a.type){var b=n(a);if(this.dayPlaying||this.yearPlaying){var d=Date.now()-(this._lastTime??0);if(this.dayPlaying){if(this._lastTime=Date.now(),d*=
k.calculatePlaySpeed(this._sunrise,this._sunset,b)*this.playSpeedMultiplier/100,0<d){let m=new Date(b.getTime()+d);var g=a.displayUTCOffset??0;const q=((m.getUTCHours()+g)%24+24)%24;g=((b.getUTCHours()+g)%24+24)%24;q<g&&(m=new Date(b.getTime()+d-864E5));a.date=m}}else 1E3<d&&(this._lastTime=Date.now(),d=(b.getUTCMonth()+1)%12,b=new Date(b.getTime()),b.setUTCMonth(d),a.date=b);requestAnimationFrame(()=>this._play())}}}_updateSunriseAndSunset(){var a=this._lighting;if(null!=a&&"virtual"!==a.type&&this.sunLightingEnabled){var b=
this.view?.camera?.position;if(null!=b){var {latitude:d,longitude:g}=b,{date:m,displayUTCOffset:q}=a;if(a=p.getSunriseAndSunsetTimes(m,d,g,q??0))this._sunrise=new Date(a.sunrise),this._sunset=new Date(a.sunset)}}}};e.__decorate([f.property({type:A})],c.prototype,"view",void 0);e.__decorate([f.property({type:v,nonNullable:!0})],c.prototype,"datePickerViewModel",void 0);e.__decorate([f.property({type:u.SliderWithDropdownViewModel,nonNullable:!0})],c.prototype,"timeSliderViewModel",void 0);e.__decorate([f.property()],
c.prototype,"isSupported",null);e.__decorate([f.property()],c.prototype,"lightingUpdateInterval",void 0);e.__decorate([f.property()],c.prototype,"utcOffset",null);e.__decorate([f.property()],c.prototype,"localDate",null);e.__decorate([f.property()],c.prototype,"timeSliderPosition",null);e.__decorate([f.property()],c.prototype,"directShadowsEnabled",null);e.__decorate([f.property()],c.prototype,"sunLightingEnabled",null);e.__decorate([f.property({type:["none","day","year"],value:"none"})],c.prototype,
"playingState",null);e.__decorate([f.property()],c.prototype,"dayPlaying",null);e.__decorate([f.property()],c.prototype,"yearPlaying",null);e.__decorate([f.property()],c.prototype,"playSpeedMultiplier",void 0);e.__decorate([f.property()],c.prototype,"currentSeason",null);e.__decorate([f.property()],c.prototype,"_lastTime",void 0);e.__decorate([f.property()],c.prototype,"_sunrise",void 0);e.__decorate([f.property()],c.prototype,"_sunset",void 0);e.__decorate([f.property()],c.prototype,"_cachedLightingDateUTC",
void 0);e.__decorate([f.property()],c.prototype,"_cachedDisplayUTCOffset",void 0);e.__decorate([f.property()],c.prototype,"_firstInteraction",void 0);e.__decorate([f.property()],c.prototype,"_currentHemisphere",null);e.__decorate([f.property()],c.prototype,"_environment",null);e.__decorate([f.property()],c.prototype,"_lighting",null);e.__decorate([f.property()],c.prototype,"_lightingType",null);e.__decorate([f.property()],c.prototype,"_lightingDateDisplay",null);return c=e.__decorate([z.subclass("esri.widgets.Daylight.DaylightViewModel")],
c)});