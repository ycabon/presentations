// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require ../../chunks/tslib.es6 ../../Graphic ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/uuid ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./modelUploadUtils ./Workflow ./workflowUtils ../FeatureForm/FeatureFormViewModel ../Sketch/SketchViewModel".split(" "),
function(I,r,J,G,v,A,K,x,H,w,n,X,L,M,z,N,O,P,B,Q,q,R,S){function T(a,c){let b=null;const e=()=>{null!=b&&(a.snappingOptions.featureSources.remove(b),b=A.destroyMaybe(b))};return v.handlesGroup([x.watch(()=>{const g=c.creationInfo?.layer,f=a.snappingOptions.featureSources.find(h=>h.layer===g);return{hasFeatureLayerSource:!!f,enabled:f?.enabled??!1}},({hasFeatureLayerSource:g,enabled:f})=>{if(g)null==b&&(b=new O({layer:a.layer}),a.snappingOptions.featureSources.add(b)),b.enabled=f;else return e()},
x.syncAndInitial),v.makeHandle(e)])}function U(a,c,b,e){const g=[];c.forEach((f,h)=>{if(!f.error){const l=a[h];h=e.get(l)||[];l.attributes[b.objectIdField]=f.objectId;h.forEach(({form:m})=>g.push({feature:l,attachment:m}))}});return g}function V(a,c,b){const e=[],g=c.globalIdField;a.forEach((f,h)=>{let l;(l=a[h].attributes)[g]??(l[g]=H.generateBracedUUID());(b?.get(f)||[]).forEach(({file:m})=>e.push({feature:f,attachment:{globalId:H.generateBracedUUID(),data:m}}))});return e.length?{addFeatures:a,
addAttachments:e}:{addFeatures:a}}var C;const F=Symbol(),y=Symbol(),D=Symbol();n=C=class extends Q{constructor(a){super(a);this.type="create-features";this.createFeatureState="create-new";this.isNested=!1;this._getDrawMeshHelpMessage=void 0;this._featureFormHandle=null;this._visualVariableAttributes={rotation:null,size:null};this._featureFormViewModel=new R;this._sketchViewModel=null;this._attachmentFileInfos=new Map;this._highlightHandles=new Map;this._preventDefaultActionOnCancel=!1;this._lastActiveGraphics=
[];this._isActive=!0;this._updateGraphicDebounced=K.debounce((c,b,e)=>q.updateGraphicSymbolWhenRequired(c,b,e))}initialize(){this.isNested&&(this._isActive=!1);this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(0<this.numPendingFeatures)return!0;const {creationInfo:a,upload:c}=this.data;var b=this._sketchViewModel;const {activeComponent:e}=b;b=b.createGraphic?.geometry?.type;return!("polyline"!==
b&&"polygon"!==b&&"multipoint"!==b||"draw-2d"!==e?.type&&"draw-3d"!==e?.type)&&0<e.drawOperation.committedVertices.length||c&&("pending"===c.state||"success"===c.state)||a?.geometryToPlace?!0:!1}get helpMessage(){const {creationInfo:a,viewModel:c}=this.data;if("creating-features"===this.stepId&&a){var b=a.layer.geometryType,e=this._sketchViewModel.createGraphic;return"mesh"===b?(this._getDrawMeshHelpMessage||(new Promise((g,f)=>I(["../../views/draw/support/helpMessageUtils3d"],g,f))).then(g=>{this._getDrawMeshHelpMessage=
g.getDrawMeshHelpMessage}),{view:b}=c,"3d"===b?.type?this._getDrawMeshHelpMessage?.(e,b):void 0):N.getDrawHelpMessage(b,e?.geometry)}}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editableItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){var {creationInfo:a}=
this.data;if(!a)return!1;({layer:a}=a);const c=a.capabilities?.operations.supportsAdd,b=z.getEffectiveLayerCapabilities(a)?.operations.supportsAdd;return z.getEffectiveEditingEnabled(a)&&!a.editingEnabled||!!b&&!c}get shouldShowAttachments(){const {data:a}=this;return a.creationInfo&&a.viewModel?q.shouldShowAttachmentsForCreateFeaturesWorkflow(a):!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){return{addAttachment:(a,
c)=>{this._attachmentFileInfos.set(a,c)},sketchViewModel:this._sketchViewModel}}async enter(){this._isActive=!0;"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1;this.removeHandles([D])}async updatePendingFeature(a,c){this._preventDefaultActionOnCancel=!0;this._sketchViewModel.cancel();G.remove(this._lastActiveGraphics,a);return this._startUpdating(a,c)}async start(){await super.start();return z.isTable(this.data.creationInfo?.layer)?null:{enter:async()=>
{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(a){const {addAttachmentsCallback:c,applyEditsCallback:b,isNested:e,creationInfo:g,parent:f,startAt:h,viewModel:l}=a,m=new C({data:new P.CreateFeaturesWorkflowData({creationInfo:g,parent:f,viewModel:l}),isNested:e,onCommit:async d=>{var {creationInfo:k}=d;if(k){d=d.pendingFeatures.toArray();({layer:k}=k);var t=m._attachmentFileInfos;if(k.capabilities?.editing.supportsGlobalId&&"globalIdField"in k)d=V(d,k,t),await b(k,d,{globalIdUsed:!0});
else{var p=await b(k,{addFeatures:d});0<t.size&&await c(k,U(d,p?.addFeatureResults??[],k,t))}}}});m._set("steps",this._createWorkflowSteps(m,h));return m}_fadeExistingFeatures(a){if("effect"in a){const b=a.effect;a.effect="saturate(0.6) opacity(0.8)";return v.makeHandle(()=>a.effect=b)}const c=a.opacity;a.opacity=.7;return v.makeHandle(()=>a.opacity=c)}_highlight(a){const c=this.data.viewModel.view;"3d"===c?.type&&this._highlightHandles.set(a,c.highlight(a))}_removeHighlight(a){A.removeMaybe(this._highlightHandles.get(a));
this._highlightHandles.delete(a)}async _startCreating(a){this.removeHandles(y);const {creationInfo:c}=this.data;c&&(this.createFeatureState="create-new",a=await q.startCreatingNewFeature(this._sketchViewModel,c,a),this.addHandles(a,y))}async _startUpdating(a,c){var {pendingFeatures:b}=this;b.includes(a)||b.add(a);const {_featureFormViewModel:e,_sketchViewModel:g}=this,{creationInfo:f,viewModel:h}=this.data,{attachmentsViewModel:l,editableItems:m,layerInfos:d,view:k}=h;if(k&&f){var t=f.layer;b=q.findLayerInfo(d,
t)?.formTemplate;var p=k.spatialReference;this.data.editableItem=m.find(u=>u.layer===t);e.set({arcadeEditType:"INSERT",feature:a,formTemplate:b,spatialReference:p,map:k.map});"add"!==l.mode&&"edit"!==l.mode||h.activeWorkflow?.previous();l.graphic=a;l.fileInfos.removeAll();l.mode="view";(this._attachmentFileInfos.get(a)||[]).forEach(({file:u,form:E})=>l.addFile(u,E));this._removeHighlight(a);await q.updateGraphicSymbolWhenRequired(a,c,"2d"===k.type?k.scale:null);this.removeHandles(y);A.removeMaybe(this._featureFormHandle);
"2d"===k.type&&(b=x.watch(()=>k.scale,u=>this._updateGraphicDebounced(a,c,u)),this.addHandles(b,y));this._featureFormHandle=v.handlesGroup([e.on("value-change",async()=>{a.attributes=e.getValues();await q.updateGraphicSymbolWhenRequired(a,c,"2d"===k.type?k.scale:null)}),g.on(["update","undo","redo"],u=>{("undo"===u.type||"redo"===u.type||"update"===u.type&&null!=u.toolEventInfo&&q.isTerminalUpdateEventType(u.toolEventInfo.type))&&e.notifyFeatureGeometryChanged()})]);this.createFeatureState="update-pending";
this._visualVariableAttributes=q.getVisualVariableAttributes(a);if(!z.isTable(t))return q.startUpdatingFeature({graphic:a,sketchViewModel:g,sourceLayer:t,visualVariables:this._visualVariableAttributes,webStyleCache:c})}}static _createWorkflowSteps(a,c="awaiting-feature-creation-info"){const {data:b}=a;c=q.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],c,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",
async setUp(){const {creationInfo:e,viewModel:g}=b,{view:f}=g;f&&(B.isModelUpload(e)?a.addHandles(await B.handleModelUpload({view:f,data:b,next:()=>a.next(),cancel:()=>g.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(b.parent&&e&&(a.addHandles(g.lockFeatureTemplatesViewModel(),this.id),g.featureTemplatesViewModel.layers=[e.layer]),a.addHandles(g.featureTemplatesViewModel.on("select",({item:h})=>{h&&(b.creationInfo={...b.creationInfo,layer:h.layer,template:h.template},a.next())}),this.id)))},async tearDown(){a.removeHandles([this.id,
y])}}),"creating-features":()=>({id:"creating-features",async setUp(){a._isActive&&await a._setUpCreatingFeaturesStep()},async tearDown(e){const {viewModel:g}=b;e.canceled&&(a.removeHandles([D,F,y]),g.attachmentsViewModel.fileInfos.removeAll(),a._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=b.viewModel,{graphic:g,fileInfos:f}=e;a._attachmentFileInfos.set(g,f.toArray());e.mode=
"view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const {attachmentsViewModel:e}=b.viewModel,{graphic:g,fileInfos:f}=e;a._attachmentFileInfos.set(g,f.toArray());e.mode="view"}})});return q.avoidFeatureTemplateSelectionWithOnlyOneItem(b,c)}static _configureSketchViewModel(a,c){const {data:b}=a,{creationInfo:e,viewModel:g}=b,{view:f}=g,h=a._sketchViewModel;let l=null;const m=[];if(!f)return v.makeHandle();"2d"===f.type&&e&&m.push(a._fadeExistingFeatures(e.layer));
m.push(h.on("create",async d=>{if("cancel"===d.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(1>a._lastActiveGraphics.length)return a._startCreating(c);d=a._lastActiveGraphics.pop();return a._startUpdating(d,c)}if("complete"===d.state&&d.graphic)return a._startUpdating(d.graphic,c)}),h.on("update",async d=>{var {attachmentsViewModel:k}=g;const {_featureFormViewModel:t}=a;var p=d.graphics[0];if("complete"===d.state){p!==l&&(a._lastActiveGraphics.push(p),a._highlight(p));
l=null;if(a.numPendingFeatures===e?.maxFeatures)return d=a._lastActiveGraphics.pop(),a._startUpdating(d,c);"add"!==k.mode&&"edit"!==k.mode||g.activeWorkflow?.previous();if(d.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}a.addHandles([q.showProgressCursor(f),f.on("click",W=>W.preventDefault())],F);await x.whenOnce(()=>!t.updating);a.removeHandles(F);a._startCreating(c)}"start"===d.state&&a._removeHighlight(p);k=a._visualVariableAttributes;await q.visualVariableInteractiveUpdate(f,
p,d,k,c);d=p.attributes;const {rotation:u,size:E}=k;null!=u&&({field:p}=u,t.setValue(p,d[p]));null!=E&&({field:p}=E,t.setValue(p,d[p]))}),h.on("delete",async d=>{d=d.graphics[0];a.pendingFeatures.remove(d);G.remove(a._lastActiveGraphics,d);l=d}),f.on("immediate-click",async d=>{!B.isModelUpload(e)&&({results:d}=await f.hitTest(d,{include:h.layer}),d=d.find(k=>"graphic"===k.type&&k.graphic.sourceLayer===e?.layer))&&(d=d.graphic,"transform"!==h.activeTool&&"reshape"!==h.activeTool||h.updateGraphics.at(0)===
d||await a.updatePendingFeature(d,c))}),v.makeHandle(()=>{a._preventDefaultActionOnCancel=!0;h.cancel()}),T(h,b));return v.handlesGroup(m)}_initializeSketchViewModel(){const {creationInfo:a,viewModel:c}=this.data,{labelOptions:b,snappingOptions:e,tooltipOptions:g,valueOptions:f,view:h}=c,l=new M({elevationInfo:a?.layer.elevationInfo,internal:!0,listMode:"hide"}),m=new S({labelOptions:b,layer:l,snappingOptions:e,tooltipOptions:g,valueOptions:f,updateOnGraphicClick:!1,view:h});this._sketchViewModel=
m;this.addHandles([x.watch(()=>[c.labelOptions,c.snappingOptions,c.tooltipOptions],([d,k,t])=>m.set({labelOptions:d,snappingOptions:k,tooltipOptions:t}))]);h?.map.add(l);this.addHandles(v.makeHandle(()=>{h?.destroyed||h?.map.remove(l);l.destroy()}))}async _setUpCreatingFeaturesStep(){if(!this.hasHandles(D)){var {creationInfo:a,viewModel:c}=this.data,{attachmentsViewModel:b,view:e}=c;if(e){var g=this._sketchViewModel,f=new Map,h=[];this._lastActiveGraphics=[];this._featureFormHandle=A.removeMaybe(this._featureFormHandle);
this._visualVariableAttributes={rotation:null,size:null};q.prepareAttachmentsForCreateFeaturesWorkflow(b);h.push(x.watch(()=>b.mode,d=>{switch(d){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}}));var l=q.showProgressCursor(e);h.push(l);var m=z.isTable(a?.layer);try{if(m){const d=a?.initialFeature??new J({attributes:{...a?.template?.prototype.attributes,...a?.attributeOverrides},sourceLayer:a?.layer});await this._startUpdating(d,f)}else h.push(C._configureSketchViewModel(this,
f)),a?.initialFeature?(g.layer.add(a.initialFeature),await this._startUpdating(a.initialFeature,f)):await this._startCreating(f)}finally{l.remove()}f=v.makeHandle(()=>this.pendingFeatures.drain(d=>g.layer.remove(d)));l=x.watch(()=>e?.timeZone,d=>this._featureFormViewModel.timeZone=d,x.initial);m=v.makeHandle(()=>{B.isModelUpload(a)&&c.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&h.push(this._featureFormHandle);this.addHandles(h,this._handleKeys.beforeCommit);this.addHandles([v.makeHandle(()=>
b.fileInfos.removeAll()),v.handlesGroup(h),m,f,l],D)}}}};r.__decorate([w.property({constructOnly:!0})],n.prototype,"isNested",void 0);r.__decorate([w.property()],n.prototype,"featureFormViewModel",null);r.__decorate([w.property()],n.prototype,"hasPendingEdits",null);r.__decorate([w.property()],n.prototype,"_getDrawMeshHelpMessage",void 0);r.__decorate([w.property()],n.prototype,"helpMessage",null);r.__decorate([w.property()],n.prototype,"layer",null);r.__decorate([w.property()],n.prototype,"parent",
null);r.__decorate([w.property()],n.prototype,"parentLayer",null);r.__decorate([w.property()],n.prototype,"keyboardCancellationEnabled",null);r.__decorate([w.property()],n.prototype,"reliesOnOwnerAdminPrivileges",null);r.__decorate([w.property()],n.prototype,"shouldShowAttachments",null);r.__decorate([w.property()],n.prototype,"shouldAllowAttachmentEditing",null);r.__decorate([w.property()],n.prototype,"sketchViewModel",null);return n=C=r.__decorate([L.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],
n)});