// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Collection ../../core/deprecate ../../core/Error ../../core/Evented ../../core/handleUtils ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../core/support/UpdatingHandles ../../layers/GraphicsLayer ../../layers/support/editableLayers ../../layers/support/layerUtils ../../portal/support/urlUtils ../Attachments/AttachmentsViewModel ./CreateFeaturesWorkflow ./UpdateWorkflow ./workflowUtils ../FeatureForm/featureFormUtils ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(g,A,w,B,t,e,C,x,v,y,l,h,S,T,D,E,F,G,u,H,I,J,K,L,M,N,O,P){function r(a,c,b){x.getLogger("esri.widgets.Editor.EditorViewModel").error(new t(a,c,b))}function Q(a,c){return a?.find(b=>b.layer===c)}const z=["create-features","update"];e=class extends e.EventedAccessor{constructor(a){super(a);this._editableItems=new w;this._sketchEventListenerHandle=null;this._sketchGraphicsLayer=new F({listMode:"hide",internal:!0});this._updateEditableItemsTask=null;this._updatingHandles=new E.UpdatingHandles;
this._featureTemplatesViewModelLocked=!1;this.activeWorkflow=null;this._activityQueue=[];this.failures=[];this.hideTemplatesForInactiveLayers=!1;this.attachmentsViewModel=new I({capabilities:{editing:!0}});this.featureTemplatesViewModel=new N({disabledItemFunction:({layer:c})=>this._itemIsSuspended(c)});this.ownSketchViewModel=new O({layer:this._sketchGraphicsLayer});this.spinnerViewModel=new P;this.pageStack=[];this.showDiscardEditsPrompt=()=>Promise.resolve(!0);this._candidateCommitted=!1;this.back=
async()=>{this.canGoBack&&(this.activeWorkflow?.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))};this.saveWorkflow=async()=>{const {featureFormViewModel:c}=this;if(c){c.submit();if(!c.submittable)return;const b=c.getValues();if(0<c.validateContingencyConstraints(b,{includeIncompleteViolations:!0}).length)return}await this.activeWorkflow?.save()};this.selectFeature=(c,b=!1)=>{const d=this.activeWorkflow;this._candidateCommitted||
"update"!==d?.type||(d.data.rootFeature=c,b&&(d.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([l.watch(()=>{const a=this.view?.map?.editableLayers.filter(({parent:b,visible:d})=>b&&"visible"in b?d&&b.visible:d),c=this.view?.allLayerViews?.filter(b=>!!a?.includes(b.layer)&&!b.suspended);return[a,c,this.layerInfos,this.allowedWorkflows,this.hideTemplatesForInactiveLayers]},()=>this._updateEditableItems(),l.syncAndInitial),l.on(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),
l.on(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),l.on(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit");this._set("activeWorkflow",null)}),l.when(()=>this.view?.map,a=>a.add(this._sketchGraphicsLayer),l.initial),l.watch(()=>this._editableItems.toArray(),()=>{const {activeWorkflow:a}=this;this.syncFeatureTemplates();if(a){var {stepId:c}=a;"create-features"===a.type?"awaiting-feature-creation-info"!==c||this.canCreate||this._cancelWorkflow():"update"===a.type&&
("awaiting-feature-to-update"===c&&!this.canUpdate||"awaiting-update-feature-candidate"===c&&!a.data.candidates.some(b=>this._editableItems.find(d=>d.layer===b.layer)?.supports.includes("update")))&&this._cancelWorkflow()}}),l.watch(()=>this.page,(a,c)=>{c=[...this.pageStack];if(-1===c.indexOf(a))c.push(a);else for(;c.length&&c.at(-1)!==a;)c.pop();this.pageStack=c},l.syncAndInitial),l.when(()=>"awaiting-update-feature-candidate"===this.state,()=>this._candidateCommitted=!1),l.on(()=>this.featureTemplatesViewModel,
"select",async({item:a,oldItem:c})=>{var {activeWorkflow:b}=this;if(b){if("update"===b.type&&"awaiting-feature-creation-info"===b.activeWorkflow?.stepId)return;try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{this.featureTemplatesViewModel.select(c,{emit:!1});return}}if(a){b={layer:a.layer,template:a.template};if(a.supportsUpload)return this.featureTemplatesViewModel.select(c,{emit:!1}),this.startCreateFeaturesWorkflow(b);this.startCreateFeaturesWorkflowAtFeatureCreation(b)}}),l.on(()=>
this.view,"key-down",a=>{"Escape"===a.key&&this.activeWorkflow?.keyboardCancellationEnabled&&(a.stopPropagation(),this.back())}),l.on(()=>this.sketchViewModel,["create","delete","update"],a=>{const {activeWorkflow:c}=this,b="update"===c?.type,d=`sketch-${a.type}`;this.emit(d,{type:d,detail:a,layer:b?c.activeWorkflow?.layer:c?.layer,parentLayer:b?c?.activeWorkflow?.parentLayer:void 0})},l.sync)])}destroy(){this._cancelWorkflow({warnIfNoWorkflow:!1}).then(()=>{this.view?.map?.remove(this._sketchGraphicsLayer);
this.view=null});this._updateEditableItemsTask=v.abortMaybe(this._updateEditableItemsTask);this._updatingHandles.destroy();this._sketchEventListenerHandle=v.removeMaybe(this._sketchEventListenerHandle)}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(a){a&&0!==a.length||(a=[...z]);this._set("allowedWorkflows",a)}get canCreate(){return this._editableItems.some(a=>a.supports.includes("create")&&!a.suspended)}get canUpdate(){return this._editableItems.some(({attachmentsOnUpdateEnabled:a,
layer:c,supports:b,suspended:d})=>{a=!d&&(b.includes("update")||b.includes("delete")||a);b=c.parent;b=!(b&&"visible"in b)||!!b.visible;return c.visible&&b&&a})}get editableItems(){return this._editableItems}get featureFormViewModel(){const {activeWorkflow:a}=this;return"update"===a?.type?a.activeFeatureFormViewModel:"create-features"===a?.type?a.featureFormViewModel:null}get labelOptions(){return this.ownSketchViewModel.labelOptions}set labelOptions(a){this.ownSketchViewModel.labelOptions=a}set layerInfos(a){a?.some(c=>
"allowAttachments"in c)&&B.deprecated(x.getLogger("esri.widgets.Editor.EditorViewModel"),"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"});this._set("layerInfos",a)}get sketchOptions(){return this.ownSketchViewModel.sketchOptions}get sketchViewModel(){const {activeWorkflow:a}=this;return"update"===a?.type?a.activeSketchViewModel:"create-features"===a?.type?a.sketchViewModel:this.ownSketchViewModel}get snappingOptions(){return this.ownSketchViewModel.snappingOptions}set snappingOptions(a){this.ownSketchViewModel.snappingOptions=
a}get state(){if(!this.view?.ready)return"disabled";var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?.stepId?"update"===a.type&&a.activeWorkflow?.stepId?a.activeWorkflow.stepId:a.stepId:"ready"}get syncing(){return 0<this._activityQueue.length}get updating(){return this._updatingHandles.updating||!0===this.activeWorkflow?.updating}get tooltipOptions(){return this.ownSketchViewModel.tooltipOptions}set tooltipOptions(a){this.ownSketchViewModel.tooltipOptions=
a}get valueOptions(){return this.ownSketchViewModel.valueOptions}set valueOptions(a){this.ownSketchViewModel.valueOptions=a}set view(a){this.ownSketchViewModel.view=a;this.spinnerViewModel.view=a;this._set("view",a)}get page(){const {activeWorkflow:a,state:c}=this;if("update"===a?.type&&"awaiting-feature-to-update"===a.stepId)return"ready";if("create-features"===a?.type&&0===a.numPendingFeatures){const b=a.data.upload;if(b)return"default"===b.state?"ready":"creating-features-upload-details"}return c??
"disabled"}get featureFormDisabled(){const {activeWorkflow:a}=this;return"update"===a?.type&&!1===a.activeEditableItem?.attributeUpdatesEnabled}get canGoBack(){return null!=this.activeWorkflow&&!this.syncing}get shouldShowDeleteButton(){const {activeWorkflow:a}=this;return!!a&&"update"===a.type&&!!a.activeEditableItem?.supports.includes("delete")}get hasPendingEdits(){return this.activeWorkflow?.hasPendingEdits??!1}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateFeaturesWorkflowAtFeatureCreation(a){return this.startCreateFeaturesWorkflow(a,
"creating-features")}async startCreateFeaturesWorkflow(a,c="awaiting-feature-creation-info"){await l.whenOnce(()=>!this.updating);if(!this.canCreate)throw new t("editing:unsupported-workflow","Creating features is unsupported or disabled.");const b=this._createUpdatingResolver();await this._cancelWorkflow();a=this._createCreateFeaturesWorkflow(a,c);this._set("activeWorkflow",a);await a.start();b.resolve()}async startCreateFeaturesWorkflowAtFeatureEdit(a){await l.whenOnce(()=>!this.updating);const c=
this._createUpdatingResolver();({initialFeature:a}=a);var b=a.sourceLayer;b=b?this.findEditableItemForLayer(b):void 0;if(!this.canCreate||!b)throw new t("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();a=this._createCreateFeaturesWorkflow({initialFeature:a,layer:b.layer,maxFeatures:1},"creating-features");this._set("activeWorkflow",a);await a.start();c.resolve()}async startUpdateWorkflowAtFeatureSelection(){await l.whenOnce(()=>!this.updating);
if(this.canUpdate){var a=this._createUpdatingResolver();await this._cancelWorkflow();var c=this._createUpdateWorkflow();this._set("activeWorkflow",c);await c.start();a.resolve()}else r("editing:unsupported-workflow","Update workflow is unsupported or disabled.")}async startUpdateWorkflowAtMultipleFeatureSelection(a){await l.whenOnce(()=>!this.updating);if(this.canUpdate){var c=this._createUpdatingResolver();await this._cancelWorkflow();var b=this._createUpdateWorkflow("awaiting-update-feature-candidate");
b.data.candidates=a;this._set("activeWorkflow",b);await b.start();c.resolve()}else r("editing:unsupported-workflow","Update workflow is unsupported or disabled.")}async startUpdateWorkflowAtFeatureEdit(a){await l.whenOnce(()=>!this.updating);if(this.canUpdate){var c=this._createUpdatingResolver();await this._cancelWorkflow();var b=this._createUpdateWorkflow("editing-existing-feature");b.data.rootFeature=a;this._set("activeWorkflow",b);await b.start();c.resolve()}else r("editing:unsupported-workflow",
"Update workflow is unsupported or disabled.")}async deleteFeatureFromWorkflow(){const {activeWorkflow:a}=this;a&&"update"===a.type?await a.deleteActiveFeature():r("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(a){return this._cancelWorkflow({warnIfNoWorkflow:!0,...a})}findEditableItemForLayer(a){const c="subtype-sublayer"===a.type?a.parent:a;return this._editableItems.find(b=>b.layer===c)}itemHasInvalidFormTemplate(a){return a?this.findEditableItemForLayer(a.layer)?.hasInvalidFormTemplate??
!1:!1}itemHasUnsupportedFields(a){return a?this.findEditableItemForLayer(a.layer)?.hasUnsupportedFields??!1:!1}syncFeatureTemplates(){if(!this._featureTemplatesViewModelLocked){var a=[];for(const {layer:c,supports:b}of this._editableItems)c.loaded&&b.includes("create")&&!u.isTable(c)&&a.push(c);this.featureTemplatesViewModel.layers=a}}async toggleUpdateWorkflow(){!this.canUpdate||this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&"awaiting-feature-to-update"===this.state?
await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection())}lockFeatureTemplatesViewModel(){this._featureTemplatesViewModelLocked=!0;return C.makeHandle(()=>{this._featureTemplatesViewModelLocked=!1;this.syncFeatureTemplates()})}async _updateEditableItems(){v.abortMaybe(this._updateEditableItemsTask);const a=A.createTask(async c=>{const b=this.view?.allLayerViews;var d=this.view?.map,f=d?.editableLayers.toArray()??[];d=d?.allTables.toArray().filter(u.isFeatureLayer)??
[];await Promise.allSettled(d.map(k=>k.load()));d=d.filter(k=>G.isEditableLayer(k));var n=[...f.reverse(),...d.reverse()].filter(k=>"mesh"===k.geometryType?"3d"===this.view?.type:!0);if(b&&f){f=[];d=[];for(const k of n){var m=b.find(p=>p.layer===k);n=m?f:d;m=!!m?.suspended;if(!m||!this.hideTemplatesForInactiveLayers)if("subtype-group"===k.type){await k.loadAll();y.throwIfAborted(c);for(let p=k.sublayers.length-1;0<=p;--p)n.push(this._makeEditableItemForLayer(k.sublayers.at(p),m))}else n.push(this._makeEditableItemForLayer(k,
m))}c.aborted||(c=this._editableItems,this._editableItems=new w(f.concat(d)),c.destroy())}});this._updatingHandles.addPromise(a.promise);this._updateEditableItemsTask=a}async _cancelWorkflow(a){const c=this.activeWorkflow;c?a&&!1===a.force?(await c.cancel(a),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),await c.cancel(a)):a?.warnIfNoWorkflow&&r("editing:no-active-workflow","There is no active workflow to cancel.")}_createCreateFeaturesWorkflow(a,
c){return J.create({viewModel:this,creationInfo:a,startAt:c,applyEditsCallback:(b,d,f)=>this._applyEdits(b,d,f),addAttachmentsCallback:(b,d)=>this._addAttachments(b,d)})}_createUpdateWorkflow(a){return K.create({viewModel:this,startAt:a,applyEditsCallback:(c,b,d)=>this._applyEdits(c,b,d),addAttachmentsCallback:(c,b)=>this._addAttachments(c,b)})}_addAttachments(a,c){c=c.map(b=>this._addAttachment(a,b.feature,b.attachment))??[];return Promise.all(c)}async _addAttachment(a,c,b){let d=null;if(!("addAttachment"in
a)||null==a.capabilities?.attachment)throw new t("editor:attachments-not-supported","Adding attachments is not supported for this layer type");await this._queueOperation(async()=>d=await a.addAttachment?.(c,b).catch(f=>{throw f?.error||f;})??null);return d}async _applyEdits(a,c,b){let d=null;const f=a.url?await u.getOwningPortalUrl(a.url):null,n={returnServiceEditsOption:f&&H.parseKnownArcGISOnlineDomain(f)||RegExp("/hosted/","i").test(a.url)?void 0:"original-and-current-features",...b};await this._queueOperation(async()=>
{const {view:m}=this;if(!m)return null;const k=await L.whenEditorLayerView(m,a).catch(()=>null);d=await a.applyEdits(c,n);k&&await l.whenOnce(()=>!k.updating);return d});return d}_queueOperation(a){this._activityQueue.push(a);this.notifyChange("syncing");const c=(b,d)=>{b=d.indexOf(b);-1<b&&d.splice(b,1)};return a().then(b=>{if(null!=b&&"error"in b&&null!=b.error)throw b.error;if(null!=b&&"addFeatureResults"in b){const {addFeatureResults:d,deleteFeatureResults:f,updateFeatureResults:n}=b,m=d.find(k=>
!!k.error)||n.find(k=>!!k.error)||f.find(k=>!!k.error);if(m)throw m.error;}return b}).catch(b=>{r("editing:operation-error","An error occurred.",{error:b});const d={error:b,retry:()=>{c(d,this.failures);return this._queueOperation(a)},cancel:()=>{c(d,this.failures)}};this._set("failures",[...this.failures,d])}).then(()=>{c(a,this._activityQueue);this.notifyChange("syncing")})}_createUpdatingResolver(){const a=y.createResolver();this._updatingHandles.addPromise(a.promise);return a}_makeEditableItemForLayer(a,
c=!0){const b=u.getEffectiveLayerCapabilities(a);var d=b?.operations;const f=Q(this.layerInfos,a),n=M.formTemplateHasInvalidFields(a),m=n||c;var {allowedWorkflows:k}=this;const p=k.includes("create-features");var q=k.includes("update");k=q&&!!d?.supportsUpdate&&(!f||!1!==f.enabled&&!1!==f.updateEnabled);const R=!m&&q&&!!d?.supportsDelete&&(!f||!1!==f.enabled&&!1!==f.deleteEnabled);q=[];p&&d?.supportsAdd&&(!f||!1!==f.enabled&&!1!==f.addEnabled)&&q.push("create");k&&q.push("update");R&&q.push("delete");
d=!!b?.data?.supportsAttachment&&(!f||!1!==f.allowAttachments);return{layer:a,supports:q,suspended:c,attributeUpdatesEnabled:k&&!m&&(!f||!1!==f.attributeUpdatesEnabled),geometryUpdatesEnabled:k&&!m&&!!b?.editing?.supportsGeometryUpdate&&(!f||!1!==f.geometryUpdatesEnabled),hasAttachments:d,attachmentsOnCreateEnabled:d&&p&&(!f||!1!==f.attachmentsOnCreateEnabled),attachmentsOnUpdateEnabled:!m&&d&&(!f||!1!==f.attachmentsOnUpdateEnabled),hasInvalidFormTemplate:n,hasUnsupportedFields:!1}}_itemIsSuspended(a){return this.findEditableItemForLayer(a)?.suspended??
!1}};g.__decorate([h.property()],e.prototype,"_editableItems",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"activeWorkflow",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"_activityQueue",void 0);g.__decorate([h.property({value:[...z]})],e.prototype,"allowedWorkflows",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"canCreate",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"canUpdate",null);g.__decorate([h.property()],e.prototype,"editableItems",
null);g.__decorate([h.property({readOnly:!0})],e.prototype,"failures",void 0);g.__decorate([h.property()],e.prototype,"hideTemplatesForInactiveLayers",void 0);g.__decorate([h.property()],e.prototype,"attachmentsViewModel",void 0);g.__decorate([h.property()],e.prototype,"featureFormViewModel",null);g.__decorate([h.property()],e.prototype,"featureTemplatesViewModel",void 0);g.__decorate([h.property()],e.prototype,"labelOptions",null);g.__decorate([h.property()],e.prototype,"layerInfos",null);g.__decorate([h.property()],
e.prototype,"ownSketchViewModel",void 0);g.__decorate([h.property()],e.prototype,"sketchOptions",null);g.__decorate([h.property()],e.prototype,"sketchViewModel",null);g.__decorate([h.property()],e.prototype,"snappingOptions",null);g.__decorate([h.property()],e.prototype,"spinnerViewModel",void 0);g.__decorate([h.property()],e.prototype,"state",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"syncing",null);g.__decorate([h.property()],e.prototype,"updating",null);g.__decorate([h.property()],
e.prototype,"tooltipOptions",null);g.__decorate([h.property()],e.prototype,"valueOptions",null);g.__decorate([h.property()],e.prototype,"view",null);g.__decorate([h.property()],e.prototype,"pageStack",void 0);g.__decorate([h.property()],e.prototype,"showDiscardEditsPrompt",void 0);g.__decorate([h.property()],e.prototype,"_candidateCommitted",void 0);g.__decorate([h.property()],e.prototype,"page",null);g.__decorate([h.property()],e.prototype,"featureFormDisabled",null);g.__decorate([h.property()],
e.prototype,"canGoBack",null);g.__decorate([h.property()],e.prototype,"shouldShowDeleteButton",null);g.__decorate([h.property()],e.prototype,"hasPendingEdits",null);return e=g.__decorate([D.subclass("esri.widgets.Editor.EditorViewModel")],e)});