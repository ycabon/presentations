// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../core/Error ../../core/handleUtils ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../support/featureFlags ../../views/draw/support/HighlightHelper ./UpdateRecordWorkflowData ./Workflow ./workflowUtils ../FeatureForm/FeatureFormViewModel".split(" "),function(e,h,t,l,u,p,k,
B,C,D,v,q,r,w,x,y,z,A){var m;const n={exit:Symbol()};e.UpdateRecordWorkflow=m=class extends y{constructor(a){super(a);this.fullFeature=this._highlightHelper=null;this.type="update-table-record"}initialize(){const {data:a}=this;var {edits:b}=a;const {view:d}=a.viewModel;b=b.feature;const c=new AbortController;this.addHandles(l.abortHandle(c));this._updatingHandles.addPromise(z.fetchFullFeature(b,a.viewModel.view.spatialReference,c.signal).then(f=>{u.isAborted(c)||(this._onFullFeatureLoaded(f),this._initializeFeatureFormViewModel())},
f=>this.cancel({force:!0,error:new t("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:f}})})));d&&(this._highlightHelper=new w({view:d}),this.addHandles(l.makeHandle(()=>this._highlightHelper?.removeAll())))}get editableItem(){return this.data.editableItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editableItem.layer}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editableItem.layer}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get reliesOnOwnerAdminPrivileges(){const {layer:a}=
this.editableItem,b=a.capabilities?.operations.supportsUpdate,d=q.getEffectiveLayerCapabilities(a)?.operations.supportsUpdate;return q.getEffectiveEditingEnabled(a)&&!a.editingEnabled||!!d&&!b}async deleteAndCommit(){this.data.edits.stageDelete();return this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(a){this.removeHandles(n.exit)}async start(){await super.start();return null}_configureAttachmentsViewModel(){const {data:a,fullFeature:b}=this,{attachmentsCapabilities:d,viewModel:c}=
a,{attachmentsViewModel:f}=c;f.set({capabilities:d,graphic:b,filesEnabled:!1,mode:"view"});this.addHandles([l.makeHandle(()=>f.fileInfos.removeAll()),p.watch(()=>f.mode,g=>{switch(g){case "add":this.go("adding-attachment");break;case "edit":this.go("editing-attachment")}})],n.exit)}_initializeFeatureFormViewModel(){const {edits:a,formTemplate:b,viewModel:{view:d}}=this.data,c=this._featureFormViewModel=new A({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:b,highlightHelper:this._highlightHelper,
map:d?.map,spatialReference:d.spatialReference,timeZone:d?.timeZone});c.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:g=>c.relationshipId=g.relationshipId};const {initialFeature:f}=a;f&&c.overrideInitialFeature(f);this.addHandles([c.on("value-change",()=>{a.updateAttributes(c.getValues());this.fullFeature.attributes=a.feature.attributes}),p.watch(()=>d?.timeZone,g=>c.timeZone=g)])}_onFullFeatureLoaded(a){this.fullFeature=a;const {edits:b}=this.data;b.updateAttributes(a.attributes);
b.trackChanges()}static async create(a){a=new m({data:await x.create(a),onCommit:this._onCommitFactory(a.applyEdits)});a._set("steps",this._createWorkflowSteps(a));return a}static _createWorkflowSteps(a){const {attachmentsViewModel:b}=a.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){b.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){b.mode="view"}}]}};e.UpdateRecordWorkflow._onCommitFactory=
a=>async b=>{({edits:b}=b);const {feature:d}=b;if(d){var c=d.sourceLayer,f=d.clone();if(!b.attributesModified||b.stagedForDelete){var g=c.objectIdField;f.attributes={[g]:d.getAttribute(g)};r.sceneLayerEditingEnabled()&&r.i3sPatchingEnabled()&&"scene"===c.type&&null!=c.infoFor3D&&(g=c.associatedLayer?.globalIdField,null!=g&&f.setAttribute(g,d.getAttribute(g)))}if(!b.geometryModified||b.stagedForDelete)f.geometry=null;await a(c,{[b.stagedForDelete?"deleteFeatures":"updateFeatures"]:[f]})}};h.__decorate([k.property()],
e.UpdateRecordWorkflow.prototype,"editableItem",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"featureFormViewModel",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"fullFeature",void 0);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"hasPendingEdits",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"layer",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"parent",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,
"parentLayer",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"shouldShowAttachments",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"shouldAllowAttachmentEditing",null);h.__decorate([k.property()],e.UpdateRecordWorkflow.prototype,"reliesOnOwnerAdminPrivileges",null);e.UpdateRecordWorkflow=m=h.__decorate([v.subclass("esri.widgets.Editor.UpdateRecordWorkflow")],e.UpdateRecordWorkflow);e.handleKeys=n;Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});