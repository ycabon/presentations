// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../Graphic ../../core/arrayUtils ../../core/asyncUtils ../../core/has ../../core/handleUtils ../../core/lang ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/lengthUtils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../support/featureFlags ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/3d/layers/graphics/GraphicState ../../views/support/drapedUtils ../../views/support/hitTestSelectUtils ../support/templateUtils".split(" "),
function(J,n,W,X,Y,K,w,Z,u,v,D,aa,A,ba,ca,L,M,N,da,E,O,ea,F,fa){function P(a){const b=a.sourceLayer;var c;if(!(c=!b||"feature"!==b.type)){a:switch(b.renderer?.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":case "pie-chart":c=!0;break a;default:c=!1}c=!c}if(c)return{rotation:null,size:null};let d=c=null;var e=b.renderer.getVisualVariablesForType("rotation").filter(g=>(!g.axis||"heading"===g.axis)&&g.field&&!g.valueExpression&&null!=M.getRotationAngle(g,
a));1===e.length&&(c=ha(e[0],b));e=b.renderer.getVisualVariablesForType("size").filter(g=>g.field&&!g.useSymbolValue&&!g.valueExpression&&L.getTransformationType(g)===L.TransformationType.RealWorldSize&&null!=M.getSize(g,a));1===e.length&&(d=ia(e[0],b));return{rotation:c,size:d}}function ha(a,b){const c="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,d=a.field,e=(b=b.fields&&b.fields.filter(f=>f.name===d))&&1===b.length?b[0].type:"double";var g=0,k=0;return{field:d,fieldType:e,
getDefault:()=>Promise.resolve(0),getValue:f=>{k=g-c*f;return G((k+360)%360,e)},initValue:f=>{g=null!=f?f:k;k=0},isUpdatingInteractively:!1,rotationType:a.rotationType??"geographic"}}function ja(a,b){switch(b){case "width":return a[0];case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}async function ka(a,b,c){if(null==b)return 0;({symbol:b}=da.to3D(b));if(null==b||"web-style"===b.type||"cim"===b.type)return 0;b=b.symbolLayers.at(0);if(!b)return 0;switch(b.type){case "icon":return{computeIconLayerResourceSize:c}=
await new Promise((e,g)=>J(["../../symbols/support/symbolLayerUtils"],e,g)),b.size||Math.min(t.icon,(await c(b,t.icon))[0])||t.icon;case "text":return b.size||t.text;case "line":return b.size||t.line;case "object":const {computeObjectLayerResourceSize:d}=await new Promise((e,g)=>J(["../../symbols/support/symbolLayerUtils"],e,g));a=await d(b,a.scale/t.viewScaleSizeFactor);return ja(a,c);case "path":return(null!=b.width?b.width:b.height)||a.scale/t.viewScaleSizeFactor;case "extrude":return b.size||
a.scale/t.viewScaleSizeFactor;case "fill":case "water":return 0;default:return 0}}function ia(a,b){const c=a.field,d=a.axis,e=(b=b.fields&&b.fields.filter(h=>h.name===c))&&1===b.length?b[0].type:"double";var g=0,k=0;const f=ca.meterIn[a.valueUnit]??1;let l;l="area"===a.valueRepresentation?h=>(h*f/2)**2*Math.PI:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?h=>h*f/2:h=>h*f;return{field:c,fieldType:e,getDefault:async(h,m)=>G(l(await ka(m,h,d)),e),getValue:(h,m)=>{g||=m.pixelSizeAt(m.center);
k=g*h;return G(k,e)},initValue:h=>{g=null!=h?h:k;k=0},isUpdatingInteractively:!1,displayUnit:Q(a.valueUnit),axis:a.axis}}function G(a,b){switch(b){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}async function x(a,b,c){b=await E.getDisplayedSymbol(a,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:b,scale:c});null!=aa.diff(a.symbol,b)&&(a.symbol=b)}function la(a){if(!a)throw Error("no geometry type");return"multipatch"===
a?"mesh":a}async function R(a,b,c,d,e){b=new W({sourceLayer:b,attributes:c});const {rotation:g,size:k}=P(b);let f=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d,scale:e}),l=!1;for(const h of[k,g])null!=h&&null==c[h.field]&&(c[h.field]=await h.getDefault(f,a.view),l=!0);l&&(f=await E.getDisplayedSymbol(b,{useSourceLayer:!0,webStyleCache:d,scale:e}));switch(f?.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=f;break;case "simple-line":case "line-3d":a.polylineSymbol=f;break;
case "simple-marker":case "picture-marker":case "point-3d":case "cim":a.pointSymbol=f;break;case "mesh-3d":a.meshSymbol=f}S(a.tooltipOptions,k,g)}function S(a,b,c){a.visualVariables=null!=b||null!=c?{size:null!=b?{unit:b.displayUnit,axis:b.axis,valueType:b.fieldType}:null,rotation:null!=c?{valueType:c.fieldType,rotationType:c.rotationType??"geographic"}:null}:null}async function ma(a,b,c,d){if(0===a.length)return[];const {updatable:e,graphicsByLayer:g}=await c.async(async()=>{var {results:k}=await u.whenOrAbort(F.hitTestSelectSimilarDistance(b,
c),d);const f=new Map;F.filterGraphicHits(k).forEach(({graphic:l})=>{var h=l.layer;var m=f.get(h);m?h=m:(m=[],f.set(h,m),h=m);return h.push(l)});k=a.filter(({supports:l,layer:h})=>l.includes("update")&&f.has(h));0!==k.length&&c.stopPropagation();return{updatable:k,graphicsByLayer:f}});return u.whenOrAbort(Promise.allSettled(e.map(async({layer:k})=>{var f=g.get(k);const l=T(k);if(f.every(p=>A.featureHasFields(l,p)))return f;const h=[];for(var m of f)h.push(m.getObjectId()),f=Object.keys(m.attributes),
X.addMany(l,f);m=k.createQuery();m.returnGeometry=!1;m.objectIds=h;m.outFields=A.fixFields(k.fieldsIndex,l);return k.queryFeatures(m,{signal:d}).then(({features:p})=>p)})),d)}async function na(a,b,c,d){if(0===a.length)return[];const {mapPoint:e}=c;if(null==e)return[];let g=null;const k=await c.async(async()=>{var {results:f}=await u.whenOrAbort(b.hitTest(c),d);if(0===f.length)return[];const l=new Set;g=F.filterGraphicHits(f);g.forEach(({graphic:h})=>h&&l.add(h.layer));f=a.items.filter(({layer:h,supports:m,
attachmentsOnUpdateEnabled:p})=>l.has(h)&&(m.includes("update")||m.includes("delete")||p));0<f.length&&c.stopPropagation();return f});return u.whenOrAbort(Promise.allSettled(k.map(async({layer:f})=>{const l=f.createQuery();l.returnGeometry=!1;l.outFields=T(f);const h="renderer"in f?ba.calculateTolerance({renderer:f.renderer,pointerType:c.pointerType}):0;l.geometry=ea.createQueryGeometry(e,h,b);l.outSpatialReference=b.spatialReference;const {features:m}=await f.queryFeatures(l,{signal:d});g?.forEach(({graphic:p})=>
{p.layer!==f||m.some(y=>y.getObjectId()===p.getObjectId())||m.push(p)});return m})),d)}function T(a){return A.fixFields(a.fieldsIndex,[a.objectIdField,A.getDisplayFieldName({displayField:"displayField"in a?a.displayField:null,fields:a.fields})])}async function H(a){const {graphic:b,sketchViewModel:c,sourceLayer:d,visualVariables:e,webStyleCache:g}=a;let k=!1;const {rotation:f,size:l}=e;[f,l].forEach(async h=>{if(null!=h){var m=b.getAttribute(h.field);null!=m?h.initValue(m):(m=await h.getDefault(b.symbol,
c.view),h.initValue(m),b.setAttribute(h.field,m),k=!0)}});k&&await x(b,g,"2d"===c.view?.type?c.view.scale:null);a={multipleSelectionEnabled:!1};"point"===d.geometryType&&(a.enableRotation=null!=f,a.enableScaling=null!=l);S(c.tooltipOptions,l,f);c.layer.elevationInfo=d.elevationInfo;return c.update(b,a)}async function U(a,b,c,d,e){if(null!=b.geometry&&"point"===b.geometry?.type){var g=d.rotation;var k=c.toolEventInfo;k=null==k||"rotate-start"!==k.type&&"rotate"!==k.type&&"rotate-stop"!==k.type?null:
k;if(null!=g&&null!=k)if("rotate-stop"===k.type)g.isUpdatingInteractively=!1,g.initValue();else{g.isUpdatingInteractively=!0;const {field:f,getValue:l}=g;b.setAttribute(f,l(k.angle,a))}d=d.size;c=c.toolEventInfo;c=null==c||"scale-start"!==c.type&&"scale"!==c.type&&"scale-stop"!==c.type?null:c;if(null!=d&&null!=c)if("scale-stop"===c.type)d.isUpdatingInteractively=!1,d.initValue();else{d.isUpdatingInteractively=!0;const {field:f,getValue:l}=d;b.setAttribute(f,l(c.xScale,a))}await x(b,e,"2d"===a.type?
a.scale:null)}}function oa(a,b,c){if("3d"===a.type){const d=new O.GraphicState({graphic:b});return w.handlesGroup([a.trackGraphicState(d),v.watch(()=>d.displaying,c)])}return v.watch(()=>b.visible,c)}async function V(a,b){if("3d"===a.type){const c=new O.GraphicState({graphic:b});a=a.trackGraphicState(c);await v.whenOnce(()=>c.displaying);a.remove()}else await v.whenOnce(()=>b.visible)}function Q(a){switch(a){case "unknown":case "decimal-degrees":return null;default:return a}}function I(a){const b=
a.geometry;if("mesh"===b?.type){const c=a.cloneShallow();c.attributes=Z.clone(a.attributes);c.geometry=b.cloneShallow();c.geometry.transform=b.transform?.clone()??null;return c}return a.clone()}const t={icon:D.px2pt(24),text:D.px2pt(12),line:D.px2pt(1),viewScaleSizeFactor:100},B=(a,b)=>a.whenLayerView("subtype-sublayer"===b.type?b.parent:b);K=Symbol();n.UsesSketchViewModelSymbol=K;n.avoidFeatureTemplateSelectionWithOnlyOneItem=function(a,b){a.viewModel.syncFeatureTemplates();a=a.creationInfo;if("awaiting-feature-creation-info"===
b[0].id&&a){const c=a.layer,d=fa.getAllTemplatesForLayer(c);1===d.length&&"scene"!==c.type&&(a.template=d[0],b.shift())}return b};n.canCreateInteractiveEditSession=function(a){return"createInteractiveEditSession"in a};n.cloneGraphicExceptMesh=I;n.createWorkflowSteps=function(a,b,c){let d=!1;return a.filter(e=>d?!0:d=e===b).map(e=>c[e]())};n.fetchCandidates=async function(a,b,c,d){switch(b.type){case "3d":return ma(a,b,c,d);case "2d":return na(a,b,c,d)}};n.fetchFullFeature=async function(a,b,c){const {sourceLayer:d}=
a,e=d.createQuery();e.objectIds=[a.getAttribute(d.objectIdField)];e.outFields=["*"];e.outSpatialReference=b;e.returnM=d.capabilities.data.supportsM;e.returnZ=d.capabilities.data.supportsZ;N.sceneLayerEditingEnabled()&&N.i3sPatchingEnabled()&&"scene"===d.type&&null!=d.infoFor3D&&(e.returnGeometry=!0,e.formatOf3DObjects="3D_glb");a=await d.queryFeatures(e,{signal:c});u.throwIfAborted(c);return a.features[0]};n.findLayerInfo=function(a,b){return a?.find(c=>c.layer===b)};n.getVisualVariableAttributes=
P;n.isCreateFeaturesWorkflow=function(a){return null!=a&&"create-features"===a.type};n.isTerminalUpdateEventType=a=>/-stop/.test(a)||/vertex-/.test(a);n.prepareAttachmentsForCreateFeaturesWorkflow=function(a){a.filesEnabled=!0;a.mode="view";a.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}};n.setUpGeometryUpdate=async function({feature:a,featureClone:b,visualVariableAttributes:c,sketchViewModel:d,view:e,onUpdate:g,webStyleCache:k}){await x(b,k,"2d"===e.type?e.scale:null);let f=null;
if("2d"===d?.view?.type){const q=u.debounce(r=>x(b,k,r));f=v.watch(()=>d?.view?.scale,r=>q(r))}const l=b.sourceLayer;var h=B(e,l);await H({graphic:b,sketchViewModel:d,sourceLayer:l,visualVariables:c,webStyleCache:k});let m=null;h.then(q=>m=q).catch(()=>{});const p=c.size,y=c.rotation;h=v.watch(()=>a.attributes,async q=>{let r=!1;for(const z in q){const C=q[z];C!==b.getAttribute(z)&&(b.setAttribute(z,C),null==p||p.isUpdatingInteractively||p.field!==z||p.initValue(C),null==y||y.isUpdatingInteractively||
y.field!==z||y.initValue(C),null==m||m.requiredFields.includes(z))&&(r=!0)}r&&await x(b,k,"2d"===e.type?e.scale:null)});const pa=d.on("update",async q=>{const r=q.graphics[0];if("complete"===q.state)return H({graphic:r,sketchViewModel:d,sourceLayer:l,visualVariables:c,webStyleCache:k});await U(e,r,q,c,k);g(I(r),q)}),qa=d.on(["undo","redo"],async q=>{g(I(q.graphics[0]),q)});return w.handlesGroup([qa,pa,w.makeHandle(()=>d.cancel()),h,f])};n.shouldShowAttachmentsForCreateFeaturesWorkflow=function(a){const {creationInfo:b,
viewModel:c}=a;if(!b)return!1;const {layer:d}=b;if(a=c.editableItems.find(g=>g.layer===d))return a.attachmentsOnCreateEnabled;a=d.capabilities?.data;const e=c.layerInfos?.find(g=>g.layer===d);return!(!(a&&"supportsAttachment"in a&&a.supportsAttachment)||e&&(!1===e.allowAttachments||!1===e.attachmentsOnUpdateEnabled))};n.showProgressCursor=function(a){const b=a.cursor;a.cursor="progress";return w.makeHandle(()=>a.cursor=b)};n.sizeDefaults=t;n.sizeVariableUnitToLengthUnit=Q;n.startCreatingNewFeature=
async function(a,b,c){const d=b.layer,e={...b.template?.prototype.attributes,...b.attributeOverrides};let g=null;const {view:k}=a,f="2d"===k?.type;await R(a,d,e,c,f?k.scale:null);if(f){const m=u.debounce(p=>R(a,d,e,c,p));g=v.watch(()=>k.scale,p=>m(p))}const {data:l,editing:h}=d.capabilities;a.layer.elevationInfo=d.elevationInfo;await a.create(la(d.geometryType),{graphicProperties:{attributes:e,sourceLayer:d},hasZ:l.supportsZ,defaultZ:(f?h.zDefault:null)??a.defaultCreateOptions.defaultZ,geometryToPlace:b.geometryToPlace??
void 0});return g??w.makeHandle()};n.startUpdatingFeature=H;n.swapForEditingSession=async function(a,b,c){function d(l){f?.abort();f=Y.createTask(async h=>{const m=await B(e,g);u.throwIfAborted(h);m.setVisibility?.(k,l)})}const e=a.view;a.layer.add(c);const g=b.sourceLayer,k=b.getAttribute(b.layer.objectIdField);let f=null;await V(e,c);d(!1);return w.handlesGroup([oa(e,c,l=>d(!l)),w.makeHandle(async()=>{d(!0);try{const l=await B(e,g);await v.whenOnce(()=>!l.updating)}finally{a.layer.remove(c)}})])};
n.updateGraphicSymbolWhenRequired=x;n.visualVariableInteractiveUpdate=U;n.whenEditorLayerView=B;n.whenGraphicDisplayed=V;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});