// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../smartMapping/support/utils ../../../support/arcadeOnDemand ../../../time/timeZoneUtils".split(" "),function(g,z,p,q,m,n,P,r,Q,R){function A(a){return a?B.test(a):!1}function S(a,b){if(A(b)&&a){var c=b.replace(B,"").toLowerCase();return a.find(({name:d})=>d.toLowerCase()===c)}}function t(a,b){return(b=u(b,a))?b.name:a}function u(a,
b){return a&&"function"===typeof a.getField&&b?a.getField(b)??null:null}function C({formattedAttributes:a,template:b,fieldInfoMap:c}){return`${p.replace(p.replace(b,d=>`{${c.get(d.toLowerCase())?.fieldName||d}}`),a).replaceAll(T,"")}`.trim()}function U(a,b,c=!1){const d=b[a];"string"===typeof d&&(c=(c?encodeURIComponent(d):d).replaceAll(V,"%27"),b[a]=c)}function W(a,b=!1){const c={...a};Object.keys(c).forEach(d=>U(d,c,b));return c}function D(a,b){return a.replaceAll(X,(c,d,e)=>(c=u(b,e))?`{${c.name}}`:
d)}function Y(a,b,c){return(a=D(a,c))?a.replaceAll(Z,(d,e,f)=>{e=`${e||f}`.trim();return p.replace(d,W(b,e&&"{"!==e[0]||!1))}):a}function E(a){return null!=a&&"object"===typeof a&&"fieldsIndex"in a&&"geometryType"in a&&"getField"in a&&"load"in a&&"loaded"in a&&"objectIdField"in a&&"spatialReference"in a&&"type"in a&&("feature"===a.type||"scene"===a.type)&&"when"in a}function F(a){return null!=a&&"object"===typeof a&&"createQuery"in a&&"queryFeatureCount"in a&&"queryObjectIds"in a&&"queryRelatedFeatures"in
a&&"queryRelatedFeaturesCount"in a&&"relationships"in a}function v(a){return E(a)&&F(a)}function G(a,b){const {fieldInfos:c,fieldName:d,preventPlacesFormatting:e,layer:f,timeZone:k}=b;b=H(c,d);var h=u(f,d);if(b&&!n.isRasterPixelValueField(d)){h=h?.type;const l=b.format?.dateFormat;if("date"===h||"date-only"===h||"time-only"===h||"timestamp-offset"===h||l)return r.formatAnyDate(a,{format:l,fieldType:h,timeZoneOptions:{layerTimeZone:f&&"preferredTimeZone"in f?f.preferredTimeZone:null,viewTimeZone:k,
datesInUnknownTimezone:f&&"datesInUnknownTimezone"in f?!!f.datesInUnknownTimezone:!1}})}b=b?.format;if("string"===typeof a&&n.isRasterPixelValueField(d)&&b)return a=a.trim(),/\d{2}-\d{2}/.test(a)?a:a.includes(",")?w(a,",",", ",b):a.includes(";")?w(a,";","; ",b):a.includes(" ")?w(a," "," ",b):m.formatNumber(Number(a),m.convertNumberFormatToIntlOptions(b));"string"!==typeof a||!b||null!=b.dateFormat||null==b.places&&null==b.digitSeparator||(h=Number(a),isNaN(h)||(a=h));return"string"===typeof a||null==
a||null==b?x(a):e?m.formatNumber(a,{...m.convertNumberFormatToIntlOptions(b),minimumFractionDigits:0,maximumFractionDigits:20}):m.formatNumber(a,m.convertNumberFormatToIntlOptions(b))}function w(a,b,c,d){return a.trim().split(b).map(e=>m.formatNumber(Number(e),m.convertNumberFormatToIntlOptions(d))).join(c)}function H(a,b){if(a?.length&&b)return a.find(c=>c.fieldName?.toLowerCase()===b.toLowerCase())}function aa({fieldName:a,graphic:b,layer:c}){if(y(a)||!c||"function"!==typeof c.getFeatureType)return null;
const {typeIdField:d}=c;return d&&a===d?(a=c.getFeatureType(b))?a.name:null:null}function ba({fieldName:a,value:b,graphic:c,layer:d}){return y(a)||!d||"function"!==typeof d.getFieldDomain?null:(a=c&&d.getFieldDomain(a,{feature:c}))&&"coded-value"===a.type?a.getName(b):null}function x(a){return"string"===typeof a?a.replaceAll(ca,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function I(a){const {value:b,fieldName:c,fieldInfos:d,fieldInfoMap:e,layer:f,graphic:k,timeZone:h}=a;return null==b?"":(a=ba({fieldName:c,
value:b,graphic:k,layer:f}))||(a=aa({fieldName:c,graphic:k,layer:f}))?a:e.get(c.toLowerCase())?G(b,{fieldInfos:d||Array.from(e.values()),fieldName:c,layer:f,timeZone:h}):(a=f?.fieldsIndex?.get(c))&&(r.isAnyDateField(a)||n.isTimeOnlyField(a))?r.formatAnyDate(b,{fieldType:a.type,timeZoneOptions:{layerTimeZone:f&&"preferredTimeZone"in f?f.preferredTimeZone:null,viewTimeZone:h,datesInUnknownTimezone:f&&"datesInUnknownTimezone"in f?!!f.datesInUnknownTimezone:!1}}):x(b)}async function J(a,b){const {layer:c,
graphic:d,outFields:e,objectIds:f,returnGeometry:k,spatialReference:h}=a;a=f[0];if("number"!==typeof a&&"string"!==typeof a)return b={layer:c,graphic:d,objectId:a,requiredFields:e},z.getLogger("esri.widgets.Feature.support.featureUtils").warn("Could not query required fields for the specified feature. The feature's ID is invalid.",b),null;if(!P.getEffectiveLayerCapabilities(c)?.operations?.supportsQuery)return b={layer:c,graphic:d,requiredFields:e,returnGeometry:k},z.getLogger("esri.widgets.Feature.support.featureUtils").warn("The specified layer cannot be queried. The following fields will not be available.",
b),null;a=c.createQuery();a.objectIds=f;a.outFields=e?.length?e:[c.objectIdField];a.returnGeometry=!!k;a.returnZ=!!k;a.returnM=!!k;a.outSpatialReference=h;return(await c.queryFeatures(a,b)).features[0]}async function da(a){if(!a.expressionInfos?.length)return!1;var b=await Q.loadArcade();({arcadeUtils:{hasGeometryFunctions:b}}=b);return b(a)}function y(a=""){return a?a.includes("relationships/"):!1}function K({attributes:a,graphic:b,relatedInfo:c,fieldInfos:d,fieldInfoMap:e,layer:f,timeZone:k}){a&&
b&&c&&Object.keys(b.attributes).forEach(h=>{var l=(l={layerId:c.relation.id.toString(),fieldName:h},`${"relationships/"}${l.layerId}/${l.fieldName}`);a[l]=I({fieldName:l,fieldInfos:d,fieldInfoMap:e,layer:f,value:b.attributes[h],graphic:b,timeZone:k})})}function ea({attributes:a,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e,timeZone:f}){a&&b&&(b.relatedFeatures?.forEach(k=>K({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e,timeZone:f})),b.relatedStatsFeatures?.forEach(k=>
K({attributes:a,graphic:k,relatedInfo:b,fieldInfoMap:c,fieldInfos:d,layer:e,timeZone:f})))}function L(a,b,{relatedTableId:c}){const d="scene"===b.type&&b.associatedLayer?b.associatedLayer.url:b.url;return a.filter(v).find(e=>e!==b&&e.url===d&&e.layerId===c)}const T=/href=(""|'')/gi,X=/(\{([^\{\r\n]+)\})/g,V=/'/g,B=/^\s*expression\//i,ca=/(\n)/gi,fa=/[\u00A0-\u9999<>&]/gim,Z=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,ha=/^(?:mailto:|tel:)/,M=q.convertDateFormatToIntlOptions("short-date-short-time"),N=
a=>{if(!a)return!1;a=a.toUpperCase();return a.includes("CURRENT_TIMESTAMP")||a.includes("CURRENT_DATE")||a.includes("CURRENT_TIME")},O=({layer:a,method:b,query:c,definitionExpression:d})=>{a.capabilities?.query?.supportsCacheHint&&"attachments"!==b&&(a=null!=c.where?c.where:null,b=null!=c.geometry?c.geometry:null,N(d)||N(a)||"extent"===b?.type||"tile"===c.resultType||(c.cacheHint=!0))};g.applyTextFormattingHTML=x;g.createFieldInfoMap=function(a,b){const c=new Map;if(!a)return c;a.forEach(d=>{const e=
t(d.fieldName,b);d.fieldName=e;c.set(e.toLowerCase(),d)});return c};g.findRelatedLayer=function(a,b,c){return a&&b&&c?L(a.allLayers,b,c)||L(a.allTables,b,c):null};g.fixTokens=D;g.formatAttributes=function({fieldInfos:a,attributes:b,layer:c,graphic:d,fieldInfoMap:e,relatedInfos:f,timeZone:k}){const h={};f?.forEach(l=>ea({attributes:h,relatedInfo:l,fieldInfoMap:e,fieldInfos:a,layer:c,timeZone:k}));b&&Object.keys(b).forEach(l=>{h[l]=I({fieldName:l,fieldInfos:a,fieldInfoMap:e,layer:c,value:b[l],graphic:d,
timeZone:k})});return h};g.formatEditInfo=function(a,b,c,d){const {creatorField:e,creationDateField:f,editorField:k,editDateField:h}=a;if(b){a=R.getTimeZoneFormattingOptions(d&&"preferredTimeZone"in d?d.preferredTimeZone:null,d&&"datesInUnknownTimezone"in d?!!d.datesInUnknownTimezone:!1,c,M,"date");a={...M,...a};c=b[h];if("number"===typeof c)return b=b[k],{type:"edit",date:q.formatDate(c,a),user:b};c=b[f];return"number"===typeof c?(b=b[e],{type:"create",date:q.formatDate(c,a),user:b}):null}};g.formatValueToFieldInfo=
G;g.getAllFieldInfos=function(a){const b=[];if(!a)return b;const {fieldInfos:c,content:d}=a;c&&b.push(...c);if(!d||!Array.isArray(d))return b;d.forEach(e=>{"fields"===e.type&&(e=e?.fieldInfos)&&b.push(...e)});return b};g.getFieldInfo=H;g.getFieldInfoLabel=function(a,b){return(b=S(b,a?.fieldName))?b.title||null:a?a.label||a.fieldName:null};g.getFixedFieldName=t;g.getFixedFieldNames=function(a,b){return a&&a.map(c=>t(c,b))};g.getHighlightKeyForFeature=function(a){const b=a.getObjectId();return null!=
b?`oid:${b}`:`uid:${a.uid}`};g.getSourceLayer=function(a){if(null!=a)return(a.sourceLayer||a.layer)??void 0};g.graphicCallback=async function(a,b){return"function"===typeof a?a(b):a};g.htmlEntities=function(a){return a.replaceAll(fa,b=>`&#${b.charCodeAt(0)};`)};g.isExpressionField=A;g.isFeatureSupportedLayer=E;g.isGraphicForRelatableFeatureSupportedLayer=function(a){return!!a&&"object"===typeof a&&"sourceLayer"in a&&v(a.sourceLayer)};g.isRelatableFeatureSupportedLayer=v;g.isRelatableLayer=F;g.isRelatedField=
y;g.preLayerQueryCallback=({query:a,layer:b,method:c})=>{O({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression}`})};g.preRequestCallback=({queryPayload:a,layer:b,method:c})=>{O({layer:b,method:c,query:a,definitionExpression:`${b.definitionExpression} ${b.serviceDefinitionExpression}`})};g.querySourceLayer=J;g.queryUpdatedFeature=async function({graphic:a,popupTemplate:b,layer:c,spatialReference:d},e){if(c&&b&&("function"===typeof c.load&&await c.load(e),
a.attributes)){var f=a.attributes[c.objectIdField];if(null!=f){f=[f];var k=await b.getRequiredFields(c.fieldsIndex),h=n.featureHasFields(k,a);k=h?[]:k;b=b.returnGeometry||await da(b);if(!h||b)if(c=await J({layer:c,graphic:a,outFields:k,objectIds:f,returnGeometry:b,spatialReference:d},e))c.geometry&&(a.geometry=c.geometry),c.attributes&&(a.attributes={...a.attributes,...c.attributes})}}};g.shouldOpenInNewTab=function(a=""){if(a)return!ha.test(a.trim().toLowerCase())};g.substituteAttributes=C;g.substituteFieldsInLinksAndAttributes=
function({attributes:a,globalAttributes:b,layer:c,text:d,expressionAttributes:e,fieldInfoMap:f}){return d?C({formattedAttributes:b,template:Y(d,{...b,...e,...a},c),fieldInfoMap:f}):""};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});