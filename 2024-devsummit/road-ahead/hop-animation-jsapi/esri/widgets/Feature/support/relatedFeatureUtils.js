// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../request ../../../core/arrayUtils ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../core/has ../../../layers/support/source/DataLayerSource ../../../rest/query/executeQueryJSON ../../../config ../../../kernel ../../../core/urlUtils ../../../core/unitUtils ../../../geometry/ellipsoidUtils ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/aaBoundingBox ../../../core/mathUtils ../../../geometry/Extent ../../../geometry/Geometry ../../../geometry/Multipoint ../../../geometry/Point ../../../geometry/Polygon ../../../geometry/Polyline ../../../geometry/support/normalizeUtilsCommon ../../../geometry/SpatialReference ../../../geometry/support/Ellipsoid ../../../geometry ../../../core/pbf ../../../rest/support/FeatureSet ../../../rest/support/Query ../../../rest/query/support/AttachmentInfo ../../../rest/support/AttachmentQuery ../../../rest/support/RelationshipQuery ../../../rest/support/TopFeaturesQuery ../../../rest/support/StatisticDefinition ./featureUtils".split(" "),
function(g,A,t,u,v,k,B,O,P,n,Q,R,S,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea,fa,ha,ia,ja,ka,p,la,ma,C,na,D,E){function F(a,b){if(!b.relationships)return null;let c=null;({relationships:b}=b);b.some(d=>d.id===parseInt(a,10)?(c=d,!0):!1);return c}function w({originRelationship:a,relationships:b,layerId:c}){return b.find(({relatedTableId:d,id:e})=>`${d}`===c&&e===a?.id)??null}function G(a,b){b=b.toLowerCase();for(const c in a)if(c.toLowerCase()===b)return a[c];return null}function H(a,b,c,d){const e=new C;e.outFields=
["*"];e.relationshipId="number"===typeof b.id?b.id:parseInt(b.id,10);e.objectIds=[a.attributes[c.objectIdField]];return c.queryRelatedFeatures?.(e,d)??Promise.resolve({})}function I(a,b,c){let d=0;const e=[];for(;d<b.length;)e.push(`${a} IN (${b.slice(d,c+d)})`),d+=c;return e.join(" OR ")}function x(a){return a?t.unique(a):void 0}function y(a){return a?t.unique(a,(b,c)=>JSON.stringify(b.toJSON())===JSON.stringify(c.toJSON())):void 0}async function J(a,b,c,d){var e=c.layerId.toString();const {layerInfo:f,
relation:h,relatedFields:l,outStatistics:K,url:q,sourceSpatialReference:r}=b;b=x(l);const m=y(K);if(!f||!h)return null;e=w({originRelationship:h,relationships:f.relationships,layerId:e});if(e?.relationshipTableId&&e.keyFieldInRelationshipTable){c=(await H(a,e,c,d))[a.attributes[c.objectIdField]];if(!c)return null;const M=c.features.map(L=>L.attributes[f.objectIdField]);if(m?.length&&f.supportsStatistics)return d=new p,d.where=I(f.objectIdField,M,1E3),d.outFields=b,d.outStatistics=m,d.sourceSpatialReference=
r,d={features:Promise.resolve(c),statsFeatures:n.executeQueryJSON(q,d)},k.eachAlways(d)}return(c=e?.keyField)?(e=B.isNumericField(N(f.fields,c)),a=G(a.attributes,h.keyField),c=e?`${c}=${a}`:`${c}='${a}'`,a=n.executeQueryJSON(q,new p({where:c,outFields:b,sourceSpatialReference:r}),d),d=m?.length&&f.supportsStatistics?n.executeQueryJSON(q,new p({where:c,outFields:b,outStatistics:m,sourceSpatialReference:r}),d):null,b={features:a},d&&(b.statsFeatures=d),k.eachAlways(b)):null}function N(a,b){if(null!=
a){b=b.toLowerCase();for(const c of a)if(c&&c.name.toLowerCase()===b)return c}return null}const z=new Map;g.createRelatedInfo=function(a,b){if(a=F(a,b))return{url:`${b.url}/${a.relatedTableId}`,sourceSpatialReference:b.spatialReference,relation:a,relatedFields:[],outStatistics:[]}};g.getDestinationRelation=w;g.getRelatedFieldInfo=function(a){if(!E.isRelatedField(a))return null;const [b,c]=a.split("/").slice(1);return{layerId:b,fieldName:c}};g.getUniqueOutFields=x;g.getUniqueOutStatistics=y;g.queryLayerInfos=
function({relatedInfos:a,layer:b},c){const d={};a.forEach((e,f)=>{({relation:e}=e);if(!e)throw f=new u("relation-required","A relation is required on a layer to retrieve related records."),v.getLogger("esri.widgets.Feature.support.relatedFeatureUtils").error(f),f;({relatedTableId:e}=e);if("number"!==typeof e)throw f=new u("A related table ID is required on a layer to retrieve related records."),v.getLogger("esri.widgets.Feature.support.relatedFeatureUtils").error(f),f;e=`${b.url}/${e}`;const h=z.get(e),
l=h??A(e,{query:{f:"json"},signal:(void 0)?.signal});h||z.set(e,l);d[f]=l});return k.whenOrAbort(k.eachAlways(d),c)};g.queryRelatedFeatures=function({graphic:a,relatedInfos:b,layer:c},d){const e={};b.forEach((f,h)=>{f.layerInfo&&(e[h]=J(a,f,c,d))});return k.eachAlways(e)};g.setRelatedFeatures=function(a,b){if(b&&a){var {features:c,statsFeatures:d}=a;a=c?.value;b.relatedFeatures=a?a.features:[];a=d?.value;b.relatedStatsFeatures=a?a.features:[]}};g.updateRelatedInfo=function({relatedInfo:a,fieldName:b,
fieldInfo:c}){a.relatedFields?.push(b);c.statisticType&&(b=new D({statisticType:c.statisticType,onStatisticField:b,outStatisticFieldName:b}),a.outStatistics?.push(b))};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});