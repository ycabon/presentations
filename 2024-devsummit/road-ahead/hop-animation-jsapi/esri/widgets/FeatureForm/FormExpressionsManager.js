// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/tslib.es6 ../../core/Accessor ../../core/MapUtils ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass".split(" "),function(k,m,w,r,t,p,y,z,A,x){k.FormExpressionsManager=class extends w{constructor(a){super(a);this._fieldReferencesLookup=new Map;this._fieldsAffectedLookup=new Map;this.preserveFieldValuesWhenHidden=!0;this._latestFieldValues={...a.feature.attributes}}initialize(){this._dependencyGraph=
this._buildDependencyGraph()}destroy(){this.resetExecutors()}get _baseContext(){const {editType:a,layer:b,map:e,originalFeature:d,spatialReference:h,timeZone:c}=this.arcadeContextInfo,l="feature"===b?.type?b:"scene"===b?.type&&null!=b.associatedLayer?b.associatedLayer:void 0;return[{$originalfeature:d,$editcontext:{editType:a},$layer:l,$featureset:l,$datastore:b?.url,$map:e},{rawOutput:!0,spatialReference:h??void 0,timeZone:c}]}set feature(a){this._latestFieldValues={...a?.attributes};this._set("feature",
a)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(a){return this._evaluate(a)}evaluateInvalidated(a){const {_fieldReferencesLookup:b,_latestFieldValues:e,feature:d}=this,h=new Set;for(const c of a)if(e[c]=d.getAttribute(c),b.has(c))for(const l of b.get(c))h.add(l);return this._evaluate([...h])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY"))return this._evaluate([...this._fieldReferencesLookup.get("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY")])}resetExecutors(){for(const a of this.executors)a.reset()}_buildDependencyGraph(){const {_fieldReferencesLookup:a,
_fieldsAffectedLookup:b,executors:e,preserveFieldValuesWhenHidden:d}=this,h=new Map(this.fieldInputs.map(f=>[f.name,f])),c=!1===d,l=new Map(e.map(f=>[f,[]]));for(const f of e){for(const g of f.fieldsUsed){r.getOrCreateMapValue(a,g,()=>new Set).add(f);const n=h.get(g);[n?.valueExpressionExecutor,n?.editableExpressionExecutor,c?n?.group?.visibilityExpressionExecutor:null,c?n?.visibilityExpressionExecutor:null].filter(q=>null!=q&&q!==f).forEach(q=>{l.get(q).push(f);r.getOrCreateMapValue(b,q,()=>new Set).add(n)})}f.geometryUsed&&
r.getOrCreateMapValue(a,"#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",()=>new Set).add(f)}return l}async _evaluate(a){const b=new Map,{_dependencyGraph:e,_fieldsAffectedLookup:d,_latestFieldValues:h}=this;for(const c of a)u(c,b,e);for(const [c,{resolver:l,dependencyPromises:f}]of b)Promise.all(f).then(async()=>{const [g,n]=this._makeContext(h);return c.executeAsync(g,n)}).then(()=>{if(d.has(c))for(const g of d.get(c))this._latestFieldValues[g.name]=g.value;l.resolve()},g=>{!g||t.isAbortError(g)||v(g)||
c.markStale();l.reject(g)});a=(await Promise.allSettled(Array.from(b.values(),({resolver:c})=>c.promise))).filter(c=>"rejected"===c.status&&!(t.isAbortError(c.reason)||v(c.reason)));if(0<a.length)throw new AggregateError(a,"One or more expression executions failed");}_makeContext(a){const [b,e]=this._baseContext,d=this.feature.clone();d.attributes=a;return[{...b,$feature:d},e]}};m.__decorate([p.property()],k.FormExpressionsManager.prototype,"_baseContext",null);m.__decorate([p.property()],k.FormExpressionsManager.prototype,
"feature",null);m.__decorate([p.property({constructOnly:!0})],k.FormExpressionsManager.prototype,"preserveFieldValuesWhenHidden",void 0);m.__decorate([p.property()],k.FormExpressionsManager.prototype,"executors",void 0);m.__decorate([p.property()],k.FormExpressionsManager.prototype,"fieldInputs",void 0);m.__decorate([p.property()],k.FormExpressionsManager.prototype,"arcadeContextInfo",void 0);k.FormExpressionsManager=m.__decorate([x.subclass("esri.widgets.FeatureForm.FormExpressionsManager")],k.FormExpressionsManager);
const u=(a,b,e)=>{if(!b.has(a)){var d=t.createResolver();b.set(a,{resolver:d,dependencyPromises:[]});a.abort();a=e.get(a);for(const h of a)u(h,b,e),b.get(h).dependencyPromises.push(d.promise)}},v=a=>a&&"object"===typeof a&&"message"in a&&"Cancelled"===a.message;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});