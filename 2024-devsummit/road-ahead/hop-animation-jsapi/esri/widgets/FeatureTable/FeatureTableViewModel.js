// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/Handles ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/Logger ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../layers/support/fieldUtils ../../time/timeZoneUtils ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Column ./Grid/Grid ./Grid/GridViewModel ./Grid/GroupColumn ./support/FeatureStore ../support/widgetUtils ../support/decorators/messageBundle ../../intl/locale ../../intl/date ../../intl/messages".split(" "),
function(e,C,d,n,D,x,l,f,Z,aa,ba,E,F,y,G,H,z,I,J,K,L,A,ca,B,M,N,r){d=class extends K{constructor(a){super(a);this._debounceRefresh=x.debounce(()=>this._refresh());this._highlights=new D;this.activeFilters=new n;this.attachmentsEnabled=!1;this.autoRefreshEnabled=!0;this.cellClassNameGenerator=(b,c)=>b.path||"";this.columns=new n;this.dataProvider=async(b,c)=>{const {store:g}=this,k=this._sortOrdersToLayerOrderByFields(b.sortOrders);c&&(g?(g.set({orderByFields:k}),"loaded"!==g.state&&"loading"!==g.state&&
await g.load(),c&&c(await g.fetchItems(b))):c&&c([]))};this.editingEnabled=!1;this.grid=null;this.highlightEnabled=!0;this.itemIdPath="objectId";this.messagesURIUtils=this.messagesCommon=null;this.returnGeometryEnabled=this.relatedRecordsEnabled=!1;this.view=this.timeZone=this.tableTemplate=this.store=null;this._onLayerRefresh=this._onLayerRefresh.bind(this);this._set("store",new A);this._set("grid",new J({itemIdPath:this.itemIdPath,viewModel:this}))}initialize(){const a=async()=>{this.messages=await r.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");
this.messagesCommon=await r.fetchMessageBundle("esri/t9n/common");this.messagesURIUtils=await r.fetchMessageBundle("esri/widgets/support/t9n/uriUtils")};a();this.addHandles([M.onLocaleChange(()=>{a();this._generateColumns()}),l.on(()=>this.highlightIds,"change",b=>this._onHighlightIdsChange(b),{onListenerAdd:()=>{this.highlightIds.forEach(b=>this._highlight(b))},onListenerRemove:()=>{this.highlightIds.forEach(b=>this._removeHighlight(b))}}),l.watch(()=>this.attachmentsEnabled,b=>{this.store.attachmentsEnabled=
b;this.layer?.loaded&&this._generateColumns()}),l.watch(()=>this.layerView,b=>{this._highlights.removeAll();b&&this.highlightEnabled&&this.highlightIds?.forEach(c=>this._highlight(c))}),l.watch(()=>this.highlightEnabled,b=>{this._highlights.removeAll();b&&this.highlightIds?.forEach(c=>this._highlight(c))}),l.watch(()=>this.relatedRecordsEnabled,b=>this.store.relatedRecordsEnabled=b),l.watch(()=>this.returnGeometryEnabled,b=>this.store.returnGeometry=b),l.watch(()=>this.layer?.loaded,b=>b&&this._onLayerLoad()),
l.watch(()=>this.store.state,b=>{"loaded"===b&&this.grid?.scrollToTop()}),l.watch(()=>[this.messages,this.tableTemplate],()=>this.layer?.loaded&&this._generateColumns()),l.watch(()=>[this.timeZone,this.view?.timeZone],()=>{this.columns.forEach(b=>{if("field"in b&&b.field){const {timeZone:c,timeZoneName:g}=this._getTimeZoneInfoForFieldColumn(b.field);b.set({timeZone:c,timeZoneName:g})}});this.grid?.onColumnChange()}),l.watch(()=>this.editingEnabled,b=>{this.columns.forEach(c=>{"editingEnabled"in c&&
(c.editingEnabled=b)});this.grid?.onColumnChange()}),l.watch(()=>this.layer?.definitionExpression,(b,c)=>(b||c)&&"loaded"===this.store.state&&this.reset()),l.watch(()=>this.layer&&"timeExtent"in this.layer&&this.layer.timeExtent,(b,c)=>(b||c)&&!this.timeExtent&&"loaded"===this.store.state&&this.reset()),l.on(()=>this.layer,"refresh",b=>this._onLayerRefresh(b))])}destroy(){this._resetColumns();this._highlights.removeAll();this._highlights.destroy();this.grid?.destroy();this.columns?.destroy();this.view=
this.layer=null}get _defaultHiddenFields(){return F.getLowerCaseDefaultHiddenFields(this.layer)}get activeSortOrders(){return this.grid?.sortOrders?this.grid.sortOrders.map(({path:a,direction:b})=>({fieldName:a,direction:b})).filter(a=>a.fieldName&&a.direction):[]}set filterGeometry(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);this._set("filterGeometry",a);(this.store.filterGeometry=a)&&this.activeFilters.add({type:"geometry",
geometry:a})}}get hiddenFields(){return this._get("hiddenFields")??new n}set hiddenFields(a){Array.isArray(a)?this._set("hiddenFields",new n(a)):this._set("hiddenFields",a)}get highlightOnRowSelectEnabled(){return this.highlightEnabled}set highlightOnRowSelectEnabled(a){this.highlightEnabled=a}set layer(a){this._set("layer",a);this.grid?.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}get layerView(){return this.view?.allLayerViews.find(a=>
a.layer===this.layer)||null}set messages(a){this.grid?.set("messages",a);this._set("messages",a)}get state(){const {store:a}=this;return a&&"disabled"!==a.state?"loading"===a.state?"loading":"loaded"===a.state?"loaded":"ready":"disabled"}set timeExtent(a){this._set("timeExtent",a);this.store.timeExtent=a}clearHighlights(){this._highlights.removeAll()}clearSelection(){this.grid?.clearSelection()}async deleteSelection(){var a=this.highlightIds.toArray();a?.length&&({deleteFeatureResults:a}=await this.store.deleteRowsByObjectId(a),
a=a.filter(b=>!b.error).map(b=>b.objectId),a.length&&(this.deselectRows(a),await this.refresh()))}deselectRows(a){a=this._getStoreItemsFromSelectionParams(a);this.grid?.deselectRows(a)}filterBySelection(){const a=this.highlightIds.toArray();a.length&&(this.clearSelectionFilter(),this.store.objectIds=a,this.activeFilters.add({type:"selection",objectIds:a}))}getObjectIdIndex(a){return this.store?.getObjectIdIndex(a)}getValue(a,b){return this.store.getItemByObjectId(a)?.feature?.attributes[b]}get highlightIds(){return this._get("highlightIds")||
new n}set highlightIds(a){Array.isArray(a)?this._set("highlightIds",new n(a)):this._set("highlightIds",a)}async refresh(){return x.ignoreAbortErrors(this._debounceRefresh())}reset(){this.grid?.reset()}selectRows(a){a=this._getStoreItemsFromSelectionParams(a);return this.grid?.selectRows(a)}scrollToIndex(a){this.grid?.scrollToIndex(a)}clearSelectionFilter(){this.store.objectIds=null;const a=this.activeFilters.find(b=>"selection"===b.type);a&&this.activeFilters.remove(a)}async zoomToSelection(){const {layer:a,
view:b}=this;var c=this.highlightIds.toArray();if(a&&b&&c.length){var g=a.createQuery();g.objectIds=c;g.returnGeometry=!0;c=await a.queryFeatures(g);try{await b.goTo(c.features)}catch(k){"AbortError"!==k.name&&console.error(k)}}}async _refresh(){await this.store.refreshLayerInfo();const a=this.highlightIds.toArray();a.length&&(await this.store.verifyFeaturesByObjectId(a)).forEach((b,c)=>{b||this.deselectRows(a[c])});this.grid?.refreshPageCache()}_onLayerLoad(){const a=this.layer.capabilities?.query.maxRecordCount;
a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()}_onLayerRefresh(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()}_generateColumns(){this._resetColumns();const a=[],b=this.tableTemplate?.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):this._generateDefaultFieldColumns();a.push(...b);a.length&&this.attachmentsEnabled&&a.push(this._generateAttachmentsColumn());this.columns.addMany([...a])}_generateColumnsFromTemplates(a){const {editingEnabled:b,
grid:c,layer:g,messages:k,messagesCommon:t,messagesURIUtils:u,store:p,tableTemplate:v}=this,w=g?.fields??[],O=h=>{const m="fieldName"in h&&h.fieldName?.toLowerCase();return w.find(q=>m===q.name?.toLowerCase())};return a.map(h=>({template:h,field:O(h)})).filter(({template:h,field:m})=>null!=m||"group"===h.type&&"columnTemplates"in h||"column"===h.type).map(({template:h,field:m})=>{if("fieldName"in h){var q=!1===h.visible||!0!==h.visible&&this._isFieldHidden(m?.name);const {direction:P,formatFunction:Q,
initialSortPriority:R,invalid:S,menuConfig:T,sortable:U,textAlign:V}=h,W=v?.expressionInfos||null,{timeZone:X,timeZoneName:Y}=this._getTimeZoneInfoForFieldColumn(m);return new z({sortable:!1!==U,direction:P,editingEnabled:b,expressionInfos:W,field:m,formatFunction:Q,grid:c,hidden:q,initialSortPriority:R,invalid:S,layer:g,messages:k,messagesCommon:t,messagesURIUtils:u,menuConfig:T,store:p,template:h,textAlign:V,timeZone:X,timeZoneName:Y})}return"group"===h.type&&"columnTemplates"in h?(m=this._generateColumnsFromTemplates(h.columnTemplates),
q=!1===h.visible||!0!==h.visible&&this._isFieldHidden(h.label),{label:h}=h,new L({header:h,columns:m,hidden:q})):new I({...h,timeZone:this.timeZone})})}_generateDefaultFieldColumns(){const {editingEnabled:a,grid:b,layer:c,messages:g,messagesCommon:k,messagesURIUtils:t,store:u}=this;return(this.layer?.fields??[]).map(p=>{const {timeZone:v,timeZoneName:w}=this._getTimeZoneInfoForFieldColumn(p);return new z({editingEnabled:a,field:p,grid:b,hidden:this._isFieldHidden(p.name),layer:c,store:u,messages:g,
messagesCommon:k,messagesURIUtils:t,timeZone:v,timeZoneName:w})})}_getTimeZoneInfoForFieldColumn(a){const {timeZone:b,view:c}=this;return!a||"date"!==a?.type&&"timestamp-offset"!==a?.type?{timeZone:void 0,timeZoneName:void 0}:y.getTimeZoneFormattingOptions("preferredTimeZone"in this.layer?this.layer.preferredTimeZone:null,"datesInUnknownTimezone"in this.layer&&this.layer.datesInUnknownTimezone,b??c?.timeZone??y.system,N.convertDateFormatToIntlOptions("short-time"),a.type)}_generateAttachmentsColumn(){return new H({header:this.messages?.attachments??
"Attachments"})}_sortOrdersToLayerOrderByFields(a){return a?.length?a.filter((b,c,g)=>g.map(k=>k.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,path:c})=>c+" "+b?.toUpperCase()):[]}_isFieldHidden(a){const b=a?.toLowerCase();return(this.hiddenFields??this._defaultHiddenFields).some(c=>c.toLowerCase()===b)}_highlight(a){this.layerView&&G.highlightsSupported(this.layerView)&&this._highlights.add(this.layerView.highlight(a),a)}_removeHighlight(a){this._highlights.remove(a)}_getStoreItemsFromSelectionParams(a){const b=
[];a=a instanceof Array?a:[a];a.forEach(c=>{let g=c instanceof C?c:null;c=g?g.getObjectId():c;if("number"===typeof c||"string"===typeof c){if(!g){const k=this.store.getItemByObjectId(c);k&&(g=k.feature)}b.push({objectId:c,feature:g})}});return b}_onHighlightIdsChange(a){const {highlightEnabled:b}=this,{added:c,removed:g}=a;b&&(c.forEach(k=>this._highlight(k)),g.forEach(k=>this._removeHighlight(k)))}_resetColumns(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()}};e.__decorate([f.property()],
d.prototype,"_defaultHiddenFields",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"activeFilters",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"activeSortOrders",null);e.__decorate([f.property()],d.prototype,"attachmentsEnabled",void 0);e.__decorate([f.property()],d.prototype,"autoRefreshEnabled",void 0);e.__decorate([f.property()],d.prototype,"cellClassNameGenerator",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"columns",void 0);e.__decorate([f.property()],
d.prototype,"dataProvider",void 0);e.__decorate([f.property()],d.prototype,"editingEnabled",void 0);e.__decorate([f.property()],d.prototype,"filterGeometry",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"grid",void 0);e.__decorate([f.property()],d.prototype,"hiddenFields",null);e.__decorate([f.property()],d.prototype,"highlightEnabled",void 0);e.__decorate([f.property()],d.prototype,"highlightOnRowSelectEnabled",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"itemIdPath",
void 0);e.__decorate([f.property()],d.prototype,"layer",null);e.__decorate([f.property()],d.prototype,"layerView",null);e.__decorate([f.property()],d.prototype,"messages",null);e.__decorate([f.property(),B.messageBundle("esri/t9n/common")],d.prototype,"messagesCommon",void 0);e.__decorate([f.property(),B.messageBundle("esri/widgets/support/t9n/uriUtils")],d.prototype,"messagesURIUtils",void 0);e.__decorate([f.property()],d.prototype,"relatedRecordsEnabled",void 0);e.__decorate([f.property()],d.prototype,
"returnGeometryEnabled",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"state",null);e.__decorate([f.property({readOnly:!0,type:A})],d.prototype,"store",void 0);e.__decorate([f.property()],d.prototype,"tableTemplate",void 0);e.__decorate([f.property()],d.prototype,"timeExtent",null);e.__decorate([f.property()],d.prototype,"timeZone",void 0);e.__decorate([f.property()],d.prototype,"view",void 0);e.__decorate([f.property()],d.prototype,"highlightIds",null);return d=e.__decorate([E.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],
d)});