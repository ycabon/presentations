// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/decorators/property ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../layers/support/layerUtils ../../../rest/support/AttachmentQuery".split(" "),function(h,x,f,n,r,l,y,z,k,E,A,q,B){function t(a,b,c){z.getLogger("esri.widgets.FeatureTable.support.FeatureStore").error(new l(a,
b,c))}f=class extends f{constructor(a){super(a);this._loading=this._loadError=this._loaded=!1;this._editOperationQueue=[];this._queryOperationQueue=[];this._objectIdCache=new r;this._hasStaleCache=!1;this.count=0;this.failures=new r;this.itemCache=new r;this.relatedRecordsEnabled=!1}destroy(){this.layer=null;this.itemCache?.destroy();this.failures?.destroy();this._set("itemCache",null)}set attachmentsEnabled(a){this._reset();this._set("attachmentsEnabled",a);this.notifyChange("state")}set filterGeometry(a){this._reset();
this._set("filterGeometry",a);this.notifyChange("state")}set layer(a){this._reset();this._set("layer",a);this.notifyChange("state")}set objectIds(a){this._reset();this._set("objectIds",a||null);this.notifyChange("state")}get orderByFields(){return this._get("orderByFields")||[]}set orderByFields(a){n.equals(a,this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}get querying(){return 0<this._queryOperationQueue.length}set returnGeometry(a){this._reset();
this._set("returnGeometry",a);this.notifyChange("state")}get state(){const {layer:a,_loaded:b,_loadError:c,_loading:d}=this;return c?"error":!a||a.loadError?"disabled":d?"loading":"loaded"===a.loadStatus&&b?"loaded":"ready"}get syncing(){return 0<this._editOperationQueue.length}set timeExtent(a){this._reset();this._set("timeExtent",a);this.notifyChange("state")}get where(){return this._get("where")||null}set where(a){this._reset();this._set("where",a);this.notifyChange("state")}async load(){this._reset();
const {layer:a}=this;if(a){this._loading=!0;this.notifyChange("state");try{await a.when(),await this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(b){throw this._reset(),this._loadError=!0,this.notifyChange("state"),t("store:load-error","An error occurred.",{error:b}),b;}}}async refreshLayerInfo(){return this._syncLayerInfo()}async addItems(a){}async fetchItems(a){const {page:b,pageSize:c}=a;a=b*c;const d=a+c,{layer:e,state:g}=this;if(!e||"loaded"!==g)return[];
this.notifyChange("querying");a=await this._query({start:a,num:d,page:b,pageSize:c});this.notifyChange("state");return a}async verifyFeaturesByObjectId(a){const {layer:b,state:c}=this;if(!b||"loaded"!==c)return[];const {features:d}=await this._verifyFeaturesByObjectId(a);return a.map(e=>d.some(g=>g?.getObjectId()===e))}async query(a){const {layer:b,state:c}=this;if(!b||"loaded"!==c)return[];this.notifyChange("querying");a=await this._query(a);this.notifyChange("state");return a}async removeItemAt(a){}async reset(){this._reset()}async updateItem(a){return this._update(a).then(()=>
{})}async deleteRowsByObjectId(a){const {layer:b}=this,{operations:c}=q.getEffectiveLayerCapabilities(b);if(!(c.supportsDelete&&"applyEdits"in b))throw new l("store:delete-error","Delete is not supported.");const d=a.map(e=>this.getItemByObjectId(e)?.feature).filter(n.isSome);return this._queueEditOperation(()=>b.applyEdits({deleteFeatures:d}))}getLocalItemByKey(a){return this.getItemByObjectId(a)}getItemByObjectId(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.find(d=>d.feature?.attributes[c]===
a)}getLocalItemAt(a){return this.itemCache.at(a)}at(a){return Promise.resolve(this.itemCache.at(a))}getObjectIdIndex(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.findIndex(d=>d.feature?.attributes[c]===a)}_reset(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIdCache.removeAll();this.notifyChange("querying");this.notifyChange("syncing");
this.notifyChange("state")}_getIdsFromFeatures(a){return a.map(b=>b.attributes[this.layer.objectIdField])}_toFeatureData(a,b){const {layer:{objectIdField:c}}=this;return a.map(d=>{var {attributes:e}=d;e=e[c];return{objectId:e,feature:d,attachments:b?b[e]:null,relatedRecords:null}})}async _update(a){const {layer:b}=this,{operations:c}=q.getEffectiveLayerCapabilities(b);if(!(c.supportsUpdate&&"applyEdits"in b))throw new l("store:update-error","Update is not supported.");const {index:d,name:e,value:g}=
a;a=await this.at(d);if(!a?.feature)throw new l("store:update-error","Feature with provided 'objectId' not found.");const {feature:p}=a,m=y.clone(p.attributes);m[e]=g;a=new x({attributes:m});const D=b.applyEdits({updateFeatures:[a]}).then(u=>{const {updateFeatureResults:v}=u,w=v.find(C=>!!C.error);if(w)throw w.error;v.length&&(p.attributes=m);return u});return this._queueEditOperation(()=>D)}async _query(a){const {refresh:b}=a;if(!0===b)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>
this._queryFeatureData(a));this._hasStaleCache&&(await this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(a)}async _queryFeatureData(a){return this._queueQueryOperation(async()=>{const {features:b}=await this._queryFeatures(a);var c=this._getIdsFromFeatures(b);c=await this._queryAttachments(c);return this._toFeatureData(b,c)||[]})}async _syncLayerInfo(){await this._updateCount();await this._updateIds()}async _updateCount(){await this._queryCount().then(a=>this._set("count",a))}async _updateIds(){this.layer?.capabilities?.query?.supportsPagination||
(this._objectIdCache.removeAll(),await this._queryForObjectIds().then(a=>this._objectIdCache.addMany(a)))}_queryCount(){const {filterGeometry:a,layer:b}=this,c=b.capabilities?.query?.supportsCacheHint,d=b.createQuery();d.geometry=a;d.returnGeometry=!1;d.where=this._getWhere();d.timeExtent=this._getTimeExtent();d.objectIds=this.objectIds;c&&(d.cacheHint=!0);return b.queryFeatureCount(d)}_queryForObjectIds(){const {filterGeometry:a,layer:b,orderByFields:c}=this;var d=b.capabilities?.query;const e=d?.supportsCacheHint;
d=d?.supportsOrderBy;const g=b.createQuery();g.geometry=a;g.outFields=[b.objectIdField];g.returnGeometry=!1;g.where=this._getWhere();g.timeExtent=this._getTimeExtent();g.objectIds=this.objectIds;d&&(g.orderByFields=c);e&&(g.cacheHint=!0);return b.queryObjectIds(g)}async _queryFeatures(a){const {layer:b}=this;if(!q.getEffectiveLayerCapabilities(b)?.operations.supportsQuery)throw new l("store:query-error","Layer does not support query operation.");const {filterGeometry:c,orderByFields:d,returnGeometry:e}=
this,g=this.layer?.capabilities?.query,{start:p,pageSize:m}=a;a=b.createQuery();a.returnGeometry=e;g?.supportsPagination?(a.start=p,a.num=m,a.where=this._getWhere(),a.timeExtent=this._getTimeExtent(),a.objectIds=this.objectIds):a.objectIds=this.objectIds||this._getObjectIdsForPage(p,m??0);g?.supportsOrderBy&&(a.orderByFields=d);c&&(a.geometry=c);g?.supportsCacheHint&&(a.cacheHint=!0);return b.queryFeatures(a)}async _verifyFeaturesByObjectId(a){const {layer:b}=this;if(!q.getEffectiveLayerCapabilities(b)?.operations.supportsQuery)throw new l("store:query-error",
"Layer does not support query operation.");const {orderByFields:c}=this,d=this.layer?.capabilities?.query,e=b.createQuery();e.where=this._getWhere();e.timeExtent=this._getTimeExtent();e.returnGeometry=!1;e.objectIds=a;e.outFields=[b.objectIdField];d?.supportsOrderBy&&(e.orderByFields=c);d?.supportsCacheHint&&(e.cacheHint=!0);return b.queryFeatures(e)}_getObjectIdsForPage(a,b){const c=this._objectIdCache.toArray();return c.length>=a+b?c.slice(a,a+b):c.slice(a)}_queryAttachments(a){const {attachmentsEnabled:b,
layer:c}=this,{capabilities:d}=c;return b&&d?.data.supportsAttachment&&d?.operations?.supportsQueryAttachments&&"queryAttachments"in c?c.queryAttachments(new B({objectIds:a,where:this._getWhere()})):Promise.resolve(null)}_syncLocalCache(a){a.forEach(b=>{if(b.feature){var c=b.feature.getObjectId();null!=c&&(c=this.getObjectIdIndex(c),-1===c?this.itemCache.add(b):this.itemCache.splice(c,1,b))}})}_queueQueryOperation(a){this._queryOperationQueue.push(a);this.notifyChange("querying");return a().then(b=>
this._queryOperationQueue.includes(a)?(this._syncLocalCache(b),b):[]).catch(b=>{t("store:query-error","An error occurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);return[]}).then(b=>{n.remove(this._queryOperationQueue,a);this.notifyChange("querying");return b})}_queueEditOperation(a){this._editOperationQueue.push(a);this.notifyChange("syncing");return a().then(b=>{n.remove(this._editOperationQueue,
a);this.notifyChange("syncing");return b}).catch(b=>{t("store:edit-error","An error occurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueEditOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);n.remove(this._editOperationQueue,a);this.notifyChange("syncing");throw b;})}_getWhere(){return this.where||this.layer?.definitionExpression||"1\x3d1"}_getTimeExtent(){const a=this.layer;return this.timeExtent||a&&"timeExtent"in a&&a.timeExtent||null}};h.__decorate([k.property()],
f.prototype,"attachmentsEnabled",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"count",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"failures",void 0);h.__decorate([k.property()],f.prototype,"filterGeometry",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"itemCache",void 0);h.__decorate([k.property({value:null})],f.prototype,"layer",null);h.__decorate([k.property({value:null})],f.prototype,"objectIds",null);h.__decorate([k.property()],f.prototype,"orderByFields",
null);h.__decorate([k.property({readOnly:!0})],f.prototype,"querying",null);h.__decorate([k.property()],f.prototype,"relatedRecordsEnabled",void 0);h.__decorate([k.property({value:!1})],f.prototype,"returnGeometry",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"state",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"syncing",null);h.__decorate([k.property()],f.prototype,"timeExtent",null);h.__decorate([k.property()],f.prototype,"where",null);return f=h.__decorate([A.subclass("esri.widgets.FeatureTable.support.FeatureStore")],
f)});