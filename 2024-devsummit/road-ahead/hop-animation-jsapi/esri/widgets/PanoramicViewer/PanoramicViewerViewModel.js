// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("../../chunks/tslib.es6 ../../Camera ../../geometry ../../Ground ../../Map ../../request ../../core/Collection ../../core/Evented ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/has ../../core/RandomLCG ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../views/SceneView ../Zoom ./constants ./PanoramicZoomConditions ./PanoramicZoomViewModel ./utils ../../geometry/SpatialReference".split(" "),function(d,
n,a,p,q,r,t,u,v,w,f,e,E,F,x,y,z,A,B,h,C,k,D){a=class extends u.EventedAccessor{constructor(b){super(b);this._targetPosition=this._startPosition=null;this._graphics=new y;this._loadController=this._imageGraphic=null;this._map=new q({ground:new p({opacity:0,navigationConstraint:null}),layers:new t([this._graphics])});this._zoomViewModel=null;this.autoLoad=!0;this.maxHFOV=150;this.minHFOV=50;this.pitch=90;this.state="ready";this.yaw=0;this._addNavigationHandles=()=>{this.imageRenderer.basemapTerrain.suspended=
!0;this.imageRenderer.constraints.tilt.max=180;this.removeHandles("navigation");this.addHandles([this.imageRenderer.on("mouse-wheel",this._handleWheel),this.imageRenderer.on("double-click",this._handleDoubleClick),this.imageRenderer.on("drag",this._handleDrag),this.imageRenderer.on("key-down",c=>{"+ - Shift _ \x3d ArrowUp ArrowDown ArrowRight ArrowLeft".split(" ").includes(c.key)&&c.stopPropagation()})],"navigation")};this._addHFOVHandles=()=>{this.removeHandles("fov-constraint");this.addHandles(f.watch(()=>
[this.maxHFOV,this.minHFOV],()=>{this._zoomViewModel&&(this._zoomViewModel.panoramicZoomConditions=new h({view:this.imageRenderer,maxFOV:this.maxHFOV,minFOV:this.minHFOV}))},f.syncAndInitial),"fov-constraint")};this._addZoomHandles=()=>{this._zoomViewModel=new C({view:this.imageRenderer,panoramicZoomConditions:new h({maxFOV:this.maxHFOV,minFOV:this.minHFOV})});const c=new A({viewModel:this._zoomViewModel});this.imageRenderer.ui.add(c,"top-left");this._addHFOVHandles()};this._cancelLoadWithController=
()=>{this._loadController?.abort();this._loadController=null};this._handleDoubleClick=c=>{c.stopPropagation();c.native.ctrlKey?this._zoomOut():this._zoomIn()};this._handleDrag=c=>{c.stopPropagation();const {action:g,x:l,y:m}=c;switch(g){case "start":this._startPosition=this._targetPosition={x:l,y:m};break;case "update":this._targetPosition={x:l,y:m},this._updateCameraHeadingAndTilt()}};this._handleWheel=c=>{const g=c.deltaX??c.native.deltaX;c.stopPropagation();0<g||0<c.deltaY?this._zoomOut():this._zoomIn()};
this._loadWithController=()=>{this._cancelLoadWithController();this._loadController=new AbortController;this.loadImage(this._loadController)};this._zoomIn=()=>this._zoomViewModel?.zoomIn();this._zoomOut=()=>this._zoomViewModel?.zoomOut();this._imageRenderer=new z({map:this._map,viewingMode:"local",camera:{position:B.defaultImageSphereCenter},environment:{atmosphereEnabled:!1,starsEnabled:!1,lighting:{type:"virtual"}},popupEnabled:!1,spatialReference:D.WebMercator,ui:{components:["attribution"]}})}initialize(){this.addHandles([f.watch(()=>
this.panorama,()=>{this.state="initialized";this.panorama&&this.autoLoad&&this._loadWithController()},f.syncAndInitial),f.watch(()=>this.fov,()=>{this._reloadCamera()},f.syncAndInitial),f.watch(()=>this.yaw,b=>{this.camera.heading=b;this._reloadCamera()},f.syncAndInitial),f.watch(()=>this.pitch,b=>{this.camera.tilt=b;this._reloadCamera()},f.syncAndInitial),f.when(()=>this.imageRenderer.ready,()=>{this._addNavigationHandles();this._addZoomHandles()},f.syncAndInitial)],"default")}get camera(){return this.imageRenderer.camera}set camera(b){b&&
(this.imageRenderer.camera=b.clone())}get fov(){return this.camera.fov??100}set fov(b){Number.isFinite(b)&&this._zoomViewModel?.zoomTo(b)}set panorama(b){this._set("panorama",b??null)}get imageRenderer(){return this._imageRenderer}async _loadImageInternal(b){this._removeImageSphere();if(this.panorama)try{const {data:c}=await r(this.panorama,{responseType:"image",...b});this._updateImageSphere(c)}catch(c){this.state="image-load-error",v.getLogger(this).error("#loadImage()",`error occurred while loading panorama ${this.panorama}`,
c)}}_reloadCamera(){this.camera=this.camera.clone()}_removeImageSphere(){this._imageGraphic&&(this._graphics.remove(this._imageGraphic),this._imageGraphic=w.destroyMaybe(this._imageGraphic))}_updateCameraHeadingAndTilt(){this._startPosition&&this._targetPosition&&(this.yaw=(this.camera.heading+(this._startPosition.x-this._targetPosition.x)/this.imageRenderer.width*this.camera.fov+360)%360,this.pitch=Math.min(179.5,Math.max(.5,this.camera.tilt-(this._startPosition.y-this._targetPosition.y)/this.imageRenderer.height*
this.imageRenderer.camera.fov)),this._startPosition=this._targetPosition)}_updateImageSphere(b){this._imageGraphic=k.meshToGraphic(k.createImageSphere(b));this._graphics.add(this._imageGraphic);this.state="image-loaded"}async loadImage(b){this.state="image-loading";this._loadImageInternal(b);return this}};d.__decorate([e.property()],a.prototype,"_graphics",void 0);d.__decorate([e.property()],a.prototype,"_imageGraphic",void 0);d.__decorate([e.property()],a.prototype,"_imageRenderer",void 0);d.__decorate([e.property()],
a.prototype,"_loadController",void 0);d.__decorate([e.property()],a.prototype,"_map",void 0);d.__decorate([e.property()],a.prototype,"_zoomViewModel",void 0);d.__decorate([e.property({type:Boolean})],a.prototype,"autoLoad",void 0);d.__decorate([e.property({type:n})],a.prototype,"camera",null);d.__decorate([e.property({type:Number})],a.prototype,"fov",null);d.__decorate([e.property({type:Number})],a.prototype,"maxHFOV",void 0);d.__decorate([e.property({type:Number})],a.prototype,"minHFOV",void 0);
d.__decorate([e.property()],a.prototype,"panorama",null);d.__decorate([e.property({type:Number})],a.prototype,"pitch",void 0);d.__decorate([e.property({readOnly:!0})],a.prototype,"imageRenderer",null);d.__decorate([e.property()],a.prototype,"state",void 0);d.__decorate([e.property({type:Number})],a.prototype,"yaw",void 0);return a=d.__decorate([x.subclass("esri.widgets.PanoramicViewer.PanoramicViewerViewModel")],a)});