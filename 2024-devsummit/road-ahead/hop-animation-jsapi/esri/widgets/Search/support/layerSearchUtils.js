// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("exports ../../../intl ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/unitUtils ../../../geometry/Polygon ../../../geometry/support/geometryUtils ../../../rest/support/FullTextSearch ../../../intl/substitute ../../../intl/date".split(" "),function(D,ha,w,O,P,Q,R,S,H,T,U,V){function I(a,c){const {filter:b,withinViewEnabled:h}=a;a=c?.extent;return b?.geometry??(h&&a?a:void 0)}async function J(a){a&&await a.load()}function K(a,c){return(a=a?.indexes)&&
c?.length?a.filter(b=>"FullText"===b.indexType).some(b=>{const h=b.fields?.split(",").map(g=>g.trim().toLowerCase())||[];return c.every(g=>h.includes(g.toLowerCase()))}):!1}function F({text:a,searchFields:c}){return a.trim().split(" ").filter(b=>!!b.trim()).map(b=>new T({onFields:c,searchTerm:b,searchType:"prefix"}))}function L(a){return a?.fieldsIndex?.fields?.find(c=>"string"===c.type)?.name??""}function E(a,c){return a&&c?.length?c.every(b=>!!a.getField(b)):!1}function W({codedValues:a},c,b){return Q.mappedFind(a??
[],h=>{var g=h.name;g=b?g:g.toLowerCase();return(b?c:c.toLowerCase())===g?h.code.toString():null})??null}function B(a,c){return(c=c?.where)?`(${a}) AND (${c})`:a}function X({currentTerm:a,field:c,filter:b,exactMatch:h,url:g,type:m}){var d=c?.type;c=c?.name;if("string"===d||"date"===d||"global-id"===d){if(d=g=Y.test(g??""))a:{for(d=0;d<a.length;d++)if(255<a.charCodeAt(d)){d=!0;break a}d=!1}d=d?"N":"";if(h&&"search"===m)return B(`${c} = ${d}'${a}'`,b);if(g)return B(`${c} LIKE ${d}${`'${a}%'`}`,b);h=
`LOWER(${c})`;a=a.toLowerCase();return B(`${h} LIKE ${d}${`'${a}%'`}`,b)}return"oid"===d||"small-integer"===d||"integer"===d||"single"===d||"double"===d?(a=Number(a),isNaN(a)?null:B(`${c} = ${a}`,b)):B(`${c} = ${a}`,b)}function M({searchTerm:a,layer:c,searchFields:b,filter:h,exactMatch:g,query:m,type:d}){const {definitionExpression:q,url:l}=c;let k="";!m.fullText&&a&&b&&b.forEach(e=>{var t=c.getField(e);e=((e="function"===typeof c.getFieldDomain&&c.getFieldDomain(e))&&"coded-value"===e.type?W(e,a,
g):null)||a||null;null!==e&&(t=X({currentTerm:e,field:t,filter:h,exactMatch:g,url:l,type:d}))&&(k+=k?` OR (${t})`:`(${t})`)});return q&&k?`(${q}) AND (${k})`:q||k}function Z(a,c){let b=null;({codedValues:a}=a);a&&a.length&&a.some(h=>h.code===c?(b=h.name,!0):!1);return b}function aa(a,c){return a[c]??a[Object.keys(a).find(b=>b.toLowerCase()===c.toLowerCase())]}function N(a,c,b){const h=a.sourceLayer,{attributes:g}=a;a="function"===typeof h.getFieldDomain&&h.getFieldDomain(b);return c?U.substitute(c,
g):b&&g?(c=h.getField(b),b=aa(g,b),null==b?"":a&&"coded-value"===a.type?Z(a,b)??"":"date"===c?.type?V.formatDate(new Date(b)):"number"===typeof b?b.toString():"string"!==typeof b?"":b.trim()):""}function ba(a,c,b,h){return a.features.map(g=>{var m=g.sourceLayer,{attributes:d}=g;({objectIdField:m}=m);d=m?d[m]:null;return{text:N(g,c.suggestionTemplate,h),key:d,sourceIndex:b}})}function ca(a,c,b,h,g,m,d){return a.features.map(q=>{var l=m;const k=q.clone(),e=q.sourceLayer;var t=e?.objectIdField;t=t?q.attributes[t]:
null;const x=N(q,b.searchTemplate,g);null!=l&&null!=e&&null!=e.minScale&&null!=e.maxScale&&(e.minScale&&e.minScale<l?l=e.minScale:e.maxScale&&e.maxScale>l&&(l=e.maxScale));l=k.geometry?H.createExtentFromGeometry(k.geometry,c??void 0,l??void 0):void 0;l="number"===typeof d&&l?H.scaleExtent(O.clone(l),c??void 0,d):l;q=q.clone();null!=l&&(q.geometry=S.fromExtent(l));return{extent:l,target:q,feature:k,key:t,name:x,sourceIndex:h}})}const Y=/https?:\/\/services.*\.arcgis\.com/i,da=/(?:\{([^}]+)\})/g,y=
()=>P.getLogger("esri.widgets.Search.support.layerSearchUtils");D.createFullTextSearchInfos=F;D.getResults=function(a,c){const {exactMatch:b=!1,location:h,maxResults:g,spatialReference:m,source:d,sourceIndex:q,suggestResult:l,view:k}=a,{layer:e,filter:t,zoomScale:x}=d,z=k?.scale,v=I(d,k),u=c?.signal;return J(e).then(()=>{const f=e.popupTemplate;return f?f.getRequiredFields(e.fieldsIndex):null}).then(f=>{const {objectIdField:n,returnZ:G}=e,A=d.displayField||d.layer.displayField||L(d.layer);if(!e.getField(A))throw y().error("invalid-field: displayField is invalid."),
new w("getResults():invalid-field","displayField is invalid.");f=f&&f.length?f:[A];var p=d.outFields||f;f=p&&p.includes("*");p.includes(n)||f||p.push(n);e.floorInfo?.floorField&&p.push(e.floorInfo.floorField);if(!f&&!E(e,p))throw y().error("invalid-field: outField is invalid."),new w("getResults():invalid-field","outField is invalid.");f=e.createQuery();var {orderByFields:r}=d;r&&(f.orderByFields=r);m&&(f.outSpatialReference=m,r=1/R.getMetersPerUnitForSR(m))&&(f.maxAllowableOffset=r);r="mesh"===e.geometryType||
"multipatch"===e.geometryType;f.returnZ=e.capabilities?.data?.supportsZ&&!r&&!1!==G;f.returnGeometry=!0;f.multipatchOption=r?"xyFootprint":null;p&&(f.outFields=p);if(h)f.geometry=h;else if(l.key)f.objectIds=[l.key];else{p=d.searchFields||[A];if(!E(e,p))throw y().error("invalid-field: search field is invalid."),new w("getResults():invalid-field","search field is invalid.");(e?.capabilities?.query?.supportsPagination??!1)&&(f.num=g);v&&(f.geometry=v);if(!l.text?.trim())return[];r=l.text;const {prefix:C=
"",suffix:ea=""}=d,fa=`${C}${r}${ea}`.replaceAll("'","''");(e?.capabilities?.query?.supportsFullTextSearch??!1)&&K(e,p)&&!b&&r&&(f.fullText=F({text:r,searchFields:p}));p=M({searchTerm:fa,layer:e,searchFields:p,filter:t,exactMatch:b,query:f,type:"search"});f.where=p;if(!f.fullText&&!f.where)return[]}return e.queryFeatures(f,{signal:u}).then(C=>ca(C,k,d,q,A,z,x))})};D.getSuggestions=function(a,c){const {source:b,spatialReference:h,view:g,suggestTerm:m,maxSuggestions:d,sourceIndex:q,exactMatch:l}=a,
{layer:k,filter:e}=b,t=c?.signal,x=I(b,g);return J(k).then(()=>{if(!(k?.capabilities?.query?.supportsPagination??!1))return[];const z=b.displayField||b.layer.displayField||L(b.layer);var v=b.searchFields||[z];const u=[];b.suggestionTemplate?b.suggestionTemplate.replaceAll(da,(r,C)=>{u.push(C);return r}):u.push(z);var f=u&&u.includes("*");u.includes(k.objectIdField)||f||u.push(k.objectIdField);var n=!!k.getField(z);f=f||E(k,u);const G=E(k,v);if(!n)throw y().error("invalid-field: displayField is invalid."),
new w("getSuggestions():invalid-field","displayField is invalid.");if(!f)throw y().error("invalid-field: outField is invalid."),new w("getSuggestions():invalid-field","outField is invalid.");if(!G)throw y().error("invalid-field: search field is invalid."),new w("getSuggestions():invalid-field","search field is invalid.");n=k.createQuery();({orderByFields:f}=b);f&&(n.orderByFields=f);n.outSpatialReference=h;n.returnGeometry=!1;n.num=d;n.outFields=u;x&&(n.geometry=x);if(!m.trim())return[];const {prefix:A=
"",suffix:p=""}=b;f=`${A}${m}${p}`.replaceAll("'","''");(k?.capabilities?.query?.supportsFullTextSearch??!1)&&K(k,v)&&!l&&m&&(n.fullText=F({text:m,searchFields:v}));v=M({searchTerm:f,layer:k,searchFields:v,filter:e,exactMatch:l,query:n,type:"suggest"});n.where=v;return n.fullText||n.where?k.queryFeatures(n,{signal:t}).then(r=>ba(r,b,q,z)):[]})};Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});