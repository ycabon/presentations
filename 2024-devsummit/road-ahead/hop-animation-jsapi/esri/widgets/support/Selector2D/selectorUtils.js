// All material copyright Esri, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.29/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/promiseUtils ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../renderers/support/clickToleranceUtils ../../../views/support/drapedUtils ../../../views/support/layerViewUtils".split(" "),function(A,h,k,B,l,C,D,E){async function t(){return new Promise((b,a)=>A(["../../../geometry/geometryEngineJSON"],b,a))}async function u(){return t().then(({contains:b,intersects:a,overlaps:e,simplify:d})=>({contains:b,intersects:a,overlaps:e,simplify:d}))}
function F(b){const a=[],e=[],d=[];b.forEach(c=>{l.isFeatureLayer(c)?a.push(c):(l.isKnowledgeGraphLayer(c)||l.isLinkChartLayer(c))&&c.layers?.length?a.push(...c.layers.toArray()):l.isMapNotesLayer(c)&&c.sublayers?.length?d.push(...c.sublayers.toArray()):l.isGraphicsLayer(c)?d.push(c):E.isSelectableLayerView2D(c)&&e.push(c)});return{layers:a,layerViews:e,graphicsLayers:d}}function v(b,a){const e=b.includes(a),d=a.getObjectId(),c=null!=d;b=b.some(f=>{const g=a.layer===f.layer,m=c&&f.getObjectId()===
d;f=a.uid===f.uid;return g&&(m||f)});return!e&&!b}async function w(b){const {layerViews:a,selector:e,signal:d,view:c}=b;return k.whenOrAbort(Promise.allSettled(a.map(async f=>{const g=f.createQuery(),{geometry:m}=n(e,f.layer,c);g.outFields=["*"];g.geometry=m;g.returnGeometry=!0;g.outSpatialReference=c.spatialReference;return f.queryFeatures(g,{signal:d}).then(({features:p})=>p)})),d)}async function x(b){const {layers:a,selector:e,signal:d,view:c}=b;return k.whenOrAbort(Promise.allSettled(a.map(async f=>
f.queryFeatures(G(f.createQuery(),e,f,c),{signal:d}).then(({features:g})=>g))),d)}function n(b,a,e){const d=B.getDisplayFieldName({displayField:"displayField"in a?a.displayField:null,fields:a.fields}),c=[a.objectIdField];null!=d&&a.fieldsIndex.has(d)&&c.push(d);a="renderer"in a?C.calculateTolerance({renderer:a.renderer}):0;return{geometry:"point"===b.type?D.createQueryGeometry(b,a,e):b,outFields:c}}function G(b,a,e,d){const {outFields:c,geometry:f}=n(a,e,d);b.outFields=c;b.geometry=f;b.returnGeometry=
!0;b.outSpatialReference=d.spatialReference;return b}async function y(b){const {selector:a,candidates:e,view:d}=b;if(!e?.length||!a)return[];const {spatialReference:c}=d,f=await u();return e.filter(g=>f.intersects(c,a,g.geometry))}const H=async(b,a,e)=>{a=a.flatMap(d=>d.graphics.toArray())??[];return y({candidates:a,selector:b,view:e})},I=async(b,a,e,d)=>(b=await k.ignoreAbortErrors(x({selector:b,signal:d,layers:a,view:e})))?b.filter(c=>"fulfilled"===c.status).flatMap(c=>c.value):[],J=async(b,a,e,
d)=>(b=await k.ignoreAbortErrors(w({selector:b,signal:d,layerViews:a,view:e})))?b.filter(c=>"fulfilled"===c.status).flatMap(c=>c.value):[];h.getGeometryEngineOperations=u;h.getQueryOptionsFromLayer=n;h.getSelectionFromFeatureLayerViews=w;h.getSelectionFromFeatureLayers=x;h.getSelectionFromGeometry=async function(b){const {currentSelection:a,selector:e,signal:d,sources:c,view:f}=b;if(!c?.length)return{added:[],removed:[]};const {layers:g,layerViews:m,graphicsLayers:p}=F(c),q=(await k.whenOrAbort(Promise.all([I(e,
g,f,d),J(e,m,f,d),H(e,p,f)]),d)).flat();if(!a)return{added:q,removed:[]};b=q.filter(r=>v(a.toArray(),r));const z=a.filter(r=>v(q,r)).toArray();a.removeMany(z);a.addMany(b);return{added:b,removed:z}};h.getSelectionFromGeometryEngine=y;h.importGeometryEngine=t;Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});